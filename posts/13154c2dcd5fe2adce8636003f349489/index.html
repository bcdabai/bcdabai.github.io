<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Android】Handler机制详解 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Android】Handler机制详解" />
<meta property="og:description" content="【Android】Handler机制详解 本文是在 Carson带你学Android 作者的异步通信 专栏中Handler的基础上学习整理的kotlin版本，并且Android源码部分也更新至最新。 1.使用Handler消息传递机制的原因 2.相关概念 概念定义作用备注Main Thread应用程序初次启动时会自动开启主线程处理与UI相关的操作与子线程的通信媒介为Handler子线程手动开启的线程执行耗时操作，如加载数据，网络请求以及IO操作与主线程的通信媒介为HandlerMessage线程间通信的基本数据单元存储通信信息/Message Queue数据结构存储Handler发送的Message/Handler线程之间Message的处理者添加Message到Message Queue；处理Looper分发的Message/LooperMessage Queue与Handler之间的通信媒介循环取出Message Queue中的Message并分发给对应的Handler一个线程只能拥有一个Looper；但一个Looper可以与多个线程的Handler绑定；因此提供了线程间通信的能力 3.工作流程 4.使用方式 1.使用 Handler.sendMessage() /** * 方式1：新建Handler子类 */ // 步骤1：自定义Handler子类 &amp; 复写handleMessage（）方法 class mHandler : Handler() { // 通过复写handlerMessage() 从而确定更新UI的操作 override fun handleMessage(msg: Message) { ...// 需执行的UI操作 } } // 步骤2：在主线程中创建Handler实例 private val mhandler = mHandler() // 步骤3：创建所需的消息对象 val msg = Message.obtain() // 实例化消息对象 msg.what = 1 // 消息标识 msg.obj = &#34;tmp&#34; // 消息内容 // 步骤4：在工作线程中 通过Handler发送消息到消息队列中 // 可通过sendMessage() / post() // 多线程可采用AsyncTask、继承Thread类、实现Runnable mHandler." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/13154c2dcd5fe2adce8636003f349489/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-27T22:18:59+08:00" />
<meta property="article:modified_time" content="2022-12-27T22:18:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Android】Handler机制详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="AndroidHandler_0"></a>【Android】Handler机制详解</h2> 
<h3><a id="_CarsonAndroidhttpsblogcsdnnetcarson_hotypeblog__HandlerkotlinAndroid_1"></a>本文是在 <a href="https://blog.csdn.net/carson_ho?type=blog">Carson带你学Android</a> 作者的异步通信 专栏中Handler的基础上学习整理的kotlin版本，并且Android源码部分也更新至最新。</h3> 
<h3><a id="1Handler_4"></a>1.使用Handler消息传递机制的原因</h3> 
<p><img src="https://images2.imgbox.com/8e/08/LJyrJJbV_o.jpg" alt="[外链图片转存中...(img-17wGmBth-1666010210163)]"></p> 
<h3><a id="2_9"></a>2.相关概念</h3> 
<table><thead><tr><th align="center">概念</th><th align="center">定义</th><th align="center">作用</th><th align="center">备注</th></tr></thead><tbody><tr><td align="center">Main Thread</td><td align="center">应用程序初次启动时会自动开启主线程</td><td align="center">处理与UI相关的操作</td><td align="center">与子线程的通信媒介为Handler</td></tr><tr><td align="center">子线程</td><td align="center">手动开启的线程</td><td align="center">执行耗时操作，如加载数据，网络请求以及IO操作</td><td align="center">与主线程的通信媒介为Handler</td></tr><tr><td align="center">Message</td><td align="center">线程间通信的基本数据单元</td><td align="center">存储通信信息</td><td align="center">/</td></tr><tr><td align="center">Message Queue</td><td align="center">数据结构</td><td align="center">存储Handler发送的Message</td><td align="center">/</td></tr><tr><td align="center">Handler</td><td align="center">线程之间Message的处理者</td><td align="center">添加Message到Message Queue；处理Looper分发的Message</td><td align="center">/</td></tr><tr><td align="center">Looper</td><td align="center">Message Queue与Handler之间的通信媒介</td><td align="center">循环取出Message Queue中的Message并分发给对应的Handler</td><td align="center">一个线程只能拥有一个Looper；但一个Looper可以与多个线程的Handler绑定；因此提供了线程间通信的能力</td></tr></tbody></table> 
<h3><a id="3_20"></a>3.工作流程</h3> 
<p><img src="https://images2.imgbox.com/a6/da/lnifpHcJ_o.png" alt="示意图"></p> 
<p><img src="https://images2.imgbox.com/e9/45/SlYYMK2C_o.png" alt="示意图"></p> 
<h3><a id="4_26"></a>4.使用方式</h3> 
<h4><a id="1_HandlersendMessage_28"></a>1.使用 Handler.sendMessage()</h4> 
<pre><code class="prism language-kotlin"><span class="token comment">/** 
 * 方式1：新建Handler子类
 */</span>
<span class="token comment">// 步骤1：自定义Handler子类 &amp; 复写handleMessage（）方法</span>
<span class="token keyword">class</span> mHandler <span class="token operator">:</span> <span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 通过复写handlerMessage() 从而确定更新UI的操作</span>
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> Message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">..</span><span class="token punctuation">.</span><span class="token comment">// 需执行的UI操作</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 步骤2：在主线程中创建Handler实例</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> mhandler <span class="token operator">=</span> <span class="token function">mHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 步骤3：创建所需的消息对象</span>
<span class="token keyword">val</span> msg <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 实例化消息对象</span>
msg<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// 消息标识</span>
msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"tmp"</span></span> <span class="token comment">// 消息内容</span>

<span class="token comment">// 步骤4：在工作线程中 通过Handler发送消息到消息队列中</span>
<span class="token comment">// 可通过sendMessage() / post()</span>
<span class="token comment">// 多线程可采用AsyncTask、继承Thread类、实现Runnable</span>
mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

<span class="token comment">// 步骤5：开启工作线程（同时启动了Handler）</span>


<span class="token comment">/** 
 * 方式2：匿名内部类
 */</span>
<span class="token comment">// 步骤1：在主线程中 通过匿名类 创建Handler类对象</span>
<span class="token keyword">val</span> mhandler <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> <span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 通过复写handlerMessage()从而确定更新UI的操作</span>
  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> Message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">..</span><span class="token punctuation">.</span><span class="token comment">// 需执行的UI操作</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 步骤2：创建消息对象</span>
  
<span class="token comment">// 步骤3：在工作线程中 通过Handler发送消息到消息队列中</span>

<span class="token comment">// 步骤4：开启工作线程（同时启动了Handler）</span>
</code></pre> 
<h4><a id="2Handlerpost_76"></a>2.使用Handler.post()</h4> 
<pre><code class="prism language-kotlin"><span class="token comment">// 步骤1：在主线程中创建Handler实例</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> mhandler <span class="token operator">=</span> <span class="token function">mHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 步骤2：在工作线程中 发送消息到消息队列中 &amp; 指定操作UI内容</span>
<span class="token comment">// 传入Runnable对象</span>
mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">{<!-- --></span>
  <span class="token operator">..</span><span class="token punctuation">.</span><span class="token comment">// 需执行的UI操作</span>
<span class="token punctuation">}</span>

<span class="token comment">// 步骤3：开启工作线程（同时启动了Handler）</span>
</code></pre> 
<h3><a id="5_91"></a>5.注意点</h3> 
<p>Thread, Looper 以及 Handler 之间的对应关系如下：</p> 
<ul><li>1个 Thread 只能绑定 1个 Looper ，但可以有多个 Handler</li><li>1个 Looper 可绑定多个 Handler</li><li>1个 Handler 只能绑定1个 Looper</li></ul> 
<p><img src="https://images2.imgbox.com/af/05/sXelksoF_o.jpg" alt="[外链图片转存中...(img-t6aujji5-1666010210165)]"></p> 
<h3><a id="6_102"></a>6.源码分析</h3> 
<h4><a id="1_HandlersendMessage_104"></a>1.使用 Handler.sendMessage()</h4> 
<h5><a id="1Handler_106"></a>步骤1：在主线程中通过匿名内部类创建Handler类对象</h5> 
<pre><code class="prism language-java"><span class="token comment">/** 
 * 具体使用
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Handler</span> mhandler <span class="token operator">=</span> <span class="token keyword">new</span>  <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 通过复写handlerMessage()指定待执行的UI更新操作</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">// 待执行的UI操作</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/** 
 * 源码分析：Handler的构造方法
 * 作用：初始化Handler对象 &amp; 绑定线程
 * 注：
 *   a. Handler需绑定 线程才能使用；绑定后，Handler的消息处理会在绑定的线程中执行
 *   b. 绑定方式 = 先指定Looper对象，从而绑定了 Looper对象所绑定的线程（因为Looper对象本已绑定了对应线程）
 *   c. 即：指定了Handler对象的 Looper对象 = 绑定到了Looper对象所在的线程
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// -&gt;&gt;分析1</span>
<span class="token punctuation">}</span>
<span class="token comment">/** 
 * 分析1：this(null, false) = Handler（null，false）
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">Callback</span> callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> async<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 1. 指定Looper对象</span>
    mLooper <span class="token operator">=</span> <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mLooper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
        <span class="token string">"Can't create handler inside thread that has not called Looper.prepare()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token comment">// Looper.myLooper()作用：获取当前线程的Looper对象；若线程无Looper对象则抛出异常</span>
  <span class="token comment">// 即 ：若线程中无创建Looper对象，则也无法创建Handler对象</span>
  <span class="token comment">// 故 若需在子线程中创建Handler对象，则需先创建Looper对象</span>
  <span class="token comment">// 注：可通过Loop.getMainLooper()可以获得当前进程的主线程的Looper对象</span>

  <span class="token comment">// 2. 绑定消息队列对象（MessageQueue）</span>
  mQueue <span class="token operator">=</span> mLooper<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>
  <span class="token comment">// 获取该Looper对象中保存的消息队列对象（MessageQueue）</span>
  <span class="token comment">// 至此，保证了handler对象 关联上 Looper对象中MessageQueue</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当创建Handler对象时，通过构造方法自动关联当前线程的Looper对象以及对应的消息队列对象(MessageQueue)，从而自动绑定了创建Handler对象操作的线程</p> 
<p>但是在上述使用步骤中，并无创建Looper对象以及对应的消息队列对象(MessageQueue)这一步</p> 
<h6><a id="11LooperMessageQueue_159"></a>步骤1前的隐式操作1：创建循环器对象(Looper)以及消息队列对象(MessageQueue)</h6> 
<pre><code class="prism language-java"><span class="token comment">/** 
 * 源码分析1：Looper.prepare()
 * 作用：为当前线程（子线程） 创建1个循环器对象（Looper），同时也生成了1个消息队列对象（MessageQueue）
 * 注：需在子线程中手动调用该方法
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 1. 判断sThreadLocal是否为null，否则抛出异常</span>
  <span class="token comment">//即 Looper.prepare()方法不能被调用两次 = 1个线程中只能对应1个Looper实例</span>
  <span class="token comment">// 注：sThreadLocal = 1个ThreadLocal对象，用于存储线程的变量</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Only one Looper may be created per thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 2. 若为初次Looper.prepare()，则创建Looper对象 &amp; 存放在ThreadLocal变量中</span>
  <span class="token comment">// 注：Looper对象是存放在Thread线程里的</span>
  <span class="token comment">// 源码分析Looper的构造方法-&gt;&gt;分析a</span>
  sThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 
 * 分析a：Looper的构造方法
 **/</span>
<span class="token keyword">private</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 1. 创建1个消息队列对象（MessageQueue）</span>
  <span class="token comment">// 即 当创建1个Looper实例时，会自动创建一个与之配对的消息队列对象（MessageQueue）</span>
  mQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 
 * 源码分析2：Looper.prepareMainLooper()
 * 作用：为 主线程（UI线程） 创建1个循环器对象（Looper），同时也生成了1个消息队列对象（MessageQueue）
 * 注：该方法在主线程（UI线程）创建时自动调用，即 主线程的Looper对象自动生成，不需手动生成
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainLooper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"The main Looper has already been prepared."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sMainLooper <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 在Android应用进程启动时，会默认创建1个主线程（ActivityThread）</span>
<span class="token comment">// 创建时，会自动调用ActivityThread的1个静态的main()方法 = 应用程序的入口</span>
<span class="token comment">// main（）内则会调用Looper.prepareMainLooper()为主线程生成1个Looper对象</span>

<span class="token comment">/** 
 * 源码分析：main()
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 1. 为主线程创建1个Looper对象，同时生成1个消息队列对象（MessageQueue）</span>
  <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 2. 创建主线程</span>
  <span class="token class-name">ActivityThread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 3.获取Handler</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainThreadHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    sMainThreadHandler <span class="token operator">=</span> thread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 4. 开启消息循环</span>
  <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Main thread loop unexpectedly exited"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建主线程时，会自动调用ActivityThread的1个静态的main()；而main()内则会调用Looper.prepareMainLooper()为主线程生成1 个Looper对象，同时也会生成其对应的MessageQueue对象，即主线程的Looper对象自动生成，不需手动生成；而子线程的Looper对象则需手动通过Looper.prepare()创建。(在子线程若不手动创建Looper对象 则无法生成Handler对象)</p> 
<p>生成Looper以及MessageQueue对象后，则会进入消息循环：Looper.loop()。</p> 
<h6><a id="12_239"></a>步骤1前的隐式操作2：消息循环</h6> 
<pre><code class="prism language-java"><span class="token comment">/** 
 * 源码分析： Looper.loop()
 * 作用：消息循环，即从消息队列中获取消息、分发消息到Handler
 * 特别注意：
 *       a. 主线程的消息循环不允许退出，即无限循环
 *       b. 子线程的消息循环允许退出：调用消息队列MessageQueue的quit（）
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 1. 获取当前Looper的消息队列</span>
  <span class="token comment">// myLooper()作用：返回sThreadLocal存储的Looper实例；若me为null 则抛出异常</span>
  <span class="token comment">// 因此loop()执行前必须执行prepare()来创建1个Looper实例</span>
  <span class="token keyword">final</span> <span class="token class-name">Looper</span> me <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>me <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"No Looper; Looper.prepare() wasn't called on this thread."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>me<span class="token punctuation">.</span>mInLoop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Loop again would have the queued messages be executed"</span>
           <span class="token operator">+</span> <span class="token string">" before this one completed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  me<span class="token punctuation">.</span>mInLoop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 2. 消息循环</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">loopOnce</span><span class="token punctuation">(</span>me<span class="token punctuation">,</span> ident<span class="token punctuation">,</span> thresholdOverride<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 1. 获取当前Looper的消息队列</span>
  <span class="token keyword">final</span> <span class="token class-name">Looper</span> me <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>me <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"No Looper; Looper.prepare() wasn't called on this thread."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// myLooper()作用：返回sThreadLocal存储的Looper实例；若me为null 则抛出异常</span>
  <span class="token comment">// 即loop（）执行前必须执行prepare（），从而创建1个Looper实例</span>

  <span class="token keyword">final</span> <span class="token class-name">MessageQueue</span> queue <span class="token operator">=</span> me<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>
  <span class="token comment">// 获取Looper实例中的消息队列对象（MessageQueue）</span>

  <span class="token comment">// 2. 消息循环（通过for循环）</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 2.1 从消息队列中取出消息</span>
    <span class="token class-name">Message</span> msg <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// next()：取出消息队列里的消息</span>
    <span class="token comment">// 若取出的消息为空，则线程阻塞</span>
    <span class="token comment">// -&gt;&gt; 分析1 </span>

    <span class="token comment">// 2.2 派发消息到对应的Handler</span>
    msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 把消息Message派发给消息对象msg的target属性</span>
    <span class="token comment">// target属性实际是1个handler对象</span>
    <span class="token comment">// -&gt;&gt;分析2</span>

    <span class="token comment">// 3. 释放消息占据的资源</span>
    msg<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">loopOnce</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Looper</span> me<span class="token punctuation">,</span>
                                <span class="token keyword">final</span> <span class="token keyword">long</span> ident<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> thresholdOverride<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 从消息队列中获取消息</span>
  <span class="token comment">// -&gt;&gt;分析1</span>
  <span class="token class-name">Message</span> msg <span class="token operator">=</span> me<span class="token punctuation">.</span>mQueue<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 没有消息表示消息队列正在退出</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 确保observer在处理事务时不会改变</span>
  <span class="token keyword">final</span> <span class="token class-name">Observer</span> observer <span class="token operator">=</span> sObserver<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 派发消息到对应的Handler</span>
    <span class="token comment">// -&gt;&gt;分析2</span>
    msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span> 
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 3.释放资源</span>
  msg<span class="token punctuation">.</span><span class="token function">recycleUnchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 
 * 分析1：queue.next()
 * 定义：MessageQueue中的方法
 * 作用：从消息队列中移出并返回该消息
 */</span>
<span class="token class-name">Message</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 如果消息循环已经退出并被释放，则在此处返回。如果App试图在不支持的退出后重新启动循环程序，这种情况就会发生。</span>
  <span class="token keyword">final</span> <span class="token keyword">long</span> ptr <span class="token operator">=</span> mPtr<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 该参数用于确定消息队列中是否还有消息，从而决定消息队列应处于出队消息状态 or 等待状态</span>
  <span class="token keyword">int</span> nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextPollTimeoutMillis <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">flushPendingCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// native层方法，若是nextPollTimeoutMillis为-1，此时消息队列处于等待状态　</span>
    <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> nextPollTimeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Message</span> prevMsg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token class-name">Message</span> msg <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 按照时间顺序取出下一个消息</span>
        <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
          prevMsg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
          msg <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> msg<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 下一条消息还没有准备好。设置一个超时以在它准备好时唤醒</span>
          nextPollTimeoutMillis <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>when <span class="token operator">-</span> now<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 取出了消息</span>
          mBlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>prevMsg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            prevMsg<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            mMessages <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          msg<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG</span><span class="token punctuation">)</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Returning message: "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
          msg<span class="token punctuation">.</span><span class="token function">markInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 没有更多消息，下次循环时消息队列将处于等待状态</span>
        nextPollTimeoutMillis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 已经处理了所有挂起的消息，就处理退出消息。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mQuitting<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 在调用空闲处理程序时，可能已经传递了一条新消息，因此不必等待，可以返回并再次查看挂起的消息。</span>
    nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 
 * 分析2：dispatchMessage(msg)
 * 定义：Handler中的方法
 * 作用：派发消息到对应的Handler实例 &amp; 根据传入的msg作出对应的操作
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispatchMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

  <span class="token comment">// 1. 若msg.callback属性不为空，则代表使用了post（Runnable r）发送消息</span>
  <span class="token comment">// 则执行handleCallback(msg)，即回调Runnable对象里复写的run（）</span>
  <span class="token comment">// 放在“post（Runnable r）”方式时分析</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>callback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">handleCallback</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 2. 若msg.callback属性为空，则代表使用了sendMessage（Message msg）发送消息</span>
    <span class="token comment">// 则执行handleMessage(msg)，即回调复写的handleMessage(msg) -&gt;&gt; 分析3</span>
    <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 
 * 分析3：handleMessage(msg)
 * 注：该方法 = 空方法，在创建Handler实例时复写 = 自定义消息处理方式
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// 创建Handler实例时复写</span>
<span class="token punctuation">}</span> 
</code></pre> 
<ul><li>消息循环的操作 = 消息出队 + 分发给对应的Handler实例</li><li>分发给对应的Handler的过程：根据出队消息的归属者通过dispatchMessage(msg)进行分发，最终回调复写的handleMessage(Message msg)，从而实现 消息处理 的操作</li><li>在进行消息分发时(dispatchMessage(msg))，会进行1次发送方式的判断： 
  <ul><li>若msg.callback属性不为空，则代表使用了post(Runnable r)发送消息，则直接回调Runnable对象里复写的run()</li><li>若msg.callback属性为空，则代表使用了sendMessage(Message msg)发送消息，则回调复写的handleMessage(msg)</li></ul> </li></ul> 
<h5><a id="2_432"></a>步骤2：创建消息对象</h5> 
<pre><code class="prism language-java"><span class="token comment">/** 
 * 具体使用
 */</span>
<span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 实例化消息对象</span>
msg<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 消息标识</span>
msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token string">"tmp"</span><span class="token punctuation">;</span> <span class="token comment">// 消息内容</span>

<span class="token comment">/** 
 * 源码分析：Message.obtain()
 * 作用：创建消息对象
 * 注：创建Message对象可用关键字new 或 Message.obtain()
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Message</span> <span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// Message内部维护了1个Message池，用于Message消息对象的复用。使用obtain()可以直接从池内获取</span>
  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sPoolSync<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sPool <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Message</span> m <span class="token operator">=</span> sPool<span class="token punctuation">;</span>
      sPool <span class="token operator">=</span> m<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
      m<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      m<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 清除在使用的标志</span>
      sPoolSize<span class="token operator">--</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> m<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 使用obtain()”创建“消息对象，可以避免每次都使用new重新分配内存</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 若池内无消息对象可复用，使用关键字new创建</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="3_465"></a>步骤3：在工作线程中发送消息到消息队列中</h5> 
<pre><code class="prism language-java"><span class="token comment">/** 
 * 具体使用
 */</span>

mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** 
 * 源码分析：mHandler.sendMessage(msg)
 * 定义：Handler的方法
 * 作用：将消息 发送 到消息队列中（Message -&gt;&gt; MessageQueue）
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// -&gt;&gt;分析1</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 
 * 分析1：sendMessageDelayed(msg, 0)
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">long</span> delayMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>delayMillis <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    delayMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> delayMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// -&gt;&gt; 分析2</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 
 * 分析2：sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis)
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">long</span> uptimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 1. 获取对应的消息队列对象（MessageQueue）</span>
  <span class="token class-name">MessageQueue</span> queue <span class="token operator">=</span> mQueue<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">RuntimeException</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">" sendMessageAtTime() called with no mQueue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token string">"Looper"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 2. 调用了enqueueMessage方法 -&gt;&gt;分析3</span>
  <span class="token keyword">return</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> uptimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 
 * 分析3：enqueueMessage(queue, msg, uptimeMillis)
 **/</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageQueue</span> queue<span class="token punctuation">,</span> <span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">long</span> uptimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 1. 将msg.target赋值为this</span>
  <span class="token comment">// 即 把当前的Handler实例对象作为msg的target属性</span>
  msg<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// 上面说的Looper的loop()中消息循环时，会从消息队列中取出每个消息msg，然后执行msg.target.dispatchMessage(msg)去处理消息</span>
  <span class="token comment">// 实际上则是将该消息派发给对应的Handler实例        </span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// 2. 调用消息队列的enqueueMessage（）</span>
  <span class="token comment">// 即：Handler发送的消息，最终是保存到消息队列-&gt;&gt;分析4</span>
  <span class="token keyword">return</span> queue<span class="token punctuation">.</span><span class="token function">enqueueMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> uptimeMillis）<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** 
 * 分析4：queue.enqueueMessage(msg, uptimeMillis）
 * 定义：MessageQueue的方法
 * 作用：将消息根据时间放入到消息队列中（Message -&gt;&gt; MessageQueue）
 * 采用单链表实现：提高插入消息、删除消息的效率
 */</span>

<span class="token keyword">boolean</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">,</span> <span class="token keyword">long</span> when<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Message must have a target."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">isInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>msg <span class="token operator">+</span> <span class="token string">" This message is already in use."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mQuitting<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">IllegalStateException</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
        msg<span class="token punctuation">.</span>target <span class="token operator">+</span> <span class="token string">" sending message to a Handler on a dead thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      msg<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    msg<span class="token punctuation">.</span><span class="token function">markInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>when <span class="token operator">=</span> when<span class="token punctuation">;</span>
    <span class="token class-name">Message</span> p <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> needWake<span class="token punctuation">;</span>

    <span class="token comment">// 判断消息队列里有无消息</span>
    <span class="token comment">// a. 若无，则将当前插入的消息 作为队头 &amp; 若此时消息队列处于等待状态，则唤醒</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> when <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
      mMessages <span class="token operator">=</span> msg<span class="token punctuation">;</span>
      needWake <span class="token operator">=</span> mBlocked<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      needWake <span class="token operator">=</span> mBlocked <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>target <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Message</span> prev<span class="token punctuation">;</span>

      <span class="token comment">// b. 判断消息队列里有消息，则根据 消息（Message）创建的时间 插入到队列中</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
        p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          needWake <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span> 
      prev<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 之后，随着Looper对象的无限消息循环</span>
<span class="token comment">// 不断从消息队列中取出Handler发送的消息 &amp; 分发到对应Handler</span>
<span class="token comment">// 最终回调Handler.handleMessage()处理消息</span>
</code></pre> 
<h4><a id="2_Handlerpost_590"></a>方式2：使用 Handler.post()</h4> 
<h5><a id="1Handler_592"></a>步骤1：在主线程中创建Handler实例</h5> 
<pre><code class="prism language-java"><span class="token comment">/** 
 * 具体使用
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Handler</span> mhandler <span class="token operator">=</span> <span class="token keyword">new</span>  <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>；
<span class="token comment">// 与方式1的使用不同：此处无复写Handler.handleMessage()</span>
 
<span class="token comment">/** 
 * 源码分析：Handler的构造方法
 * 作用：
 *     a. 在此之前，主线程创建时隐式创建Looper对象、MessageQueue对象
 *     b. 初始化Handler对象、绑定线程 &amp; 进入消息循环
 * 此处的源码类似方式1
 */</span>
</code></pre> 
<h5><a id="2__610"></a>步骤2：在工作线程中 发送消息到消息队列中</h5> 
<pre><code class="prism language-java"><span class="token comment">/** 
 * 具体使用
 * 需传入Runnable对象、复写run()从而指定UI操作
 */</span>
mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">/** 
 * 源码分析：Handler.post(Runnable r)
 * 定义：Handler中的方法
 * 作用：定义UI操作、将Runnable对象封装成消息对象 &amp; 发送 到消息队列中（Message -&gt;&gt; MessageQueue）
 * 注：
 *    a. 相比sendMessage()，post()最大的不同在于，更新的UI操作可直接在重写的run()中定义
 *    b. 实际上，Runnable并无创建新线程，而是发送 消息 到消息队列中
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span>  <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span><span class="token function">getPostMessage</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// getPostMessage(r)-&gt;&gt;分析1</span>
  <span class="token comment">// sendMessageDelayed()-&gt;&gt;分析2</span>

<span class="token punctuation">}</span>
<span class="token comment">/** 
 * 分析1：getPostMessage(r)
 * 作用：将传入的Runable对象封装成1个消息对象
 **/</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Message</span> <span class="token function">getPostMessage</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 1. 创建1个消息对象（Message）</span>
  <span class="token class-name">Message</span> m <span class="token operator">=</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2. 将 Runable对象 赋值给message的callback属性</span>
  m<span class="token punctuation">.</span>callback <span class="token operator">=</span> r<span class="token punctuation">;</span>
  <span class="token comment">// 3. 返回该消息对象</span>
  <span class="token keyword">return</span> m<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 从分析2开始，源码 与 sendMessage(Message msg)发送方式相同</span>
</code></pre> 
<h5><a id="12_653"></a>步骤1前的隐式操作2：消息循环</h5> 
<pre><code class="prism language-java"><span class="token comment">/** 
 * 源码分析： Looper.loop()
 * 作用：消息循环，即从消息队列中获取消息、分发消息到Handler
 * 特别注意：
 *       a. 主线程的消息循环不允许退出，即无限循环
 *       b. 子线程的消息循环允许退出：调用消息队列MessageQueue的quit()
 */</span>
</code></pre> 
<h4><a id="3_665"></a>3.两种方式的异同</h4> 
<p>方式2 <code>Handler.post()</code>的工作流程：与方式1<code>Handler.sendMessage()</code>类似，区别在于：</p> 
<ul><li>不需外部创建消息对象，而是内部根据传入的<code>Runnable</code>对象封装消息对象</li><li>回调的消息处理方法是：复写<code>Runnable</code>对象的<code>run()</code></li></ul> 
<h3><a id="7_672"></a>7.内存泄漏</h3> 
<h4><a id="1_674"></a>1.泄漏原因</h4> 
<p><img src="https://images2.imgbox.com/50/4e/aEdBpiqT_o.png" alt="示意图"></p> 
<ul><li>当Handler消息队列还有未处理的消息 / 正在处理消息时，存在引用关系： “未被处理 / 正处理的消息 -&gt; Handler实例 -&gt; 外部类”</li><li>这将使得外部类无法被GC回收，从而造成内存泄露</li></ul> 
<h4><a id="2_681"></a>2.解决方案</h4> 
<h5><a id="1_683"></a>1.静态内部类</h5> 
<ul><li>原理：静态内部类不默认持有外部类的引用，从而使得 “未被处理 / 正处理的消息 -&gt; Handler实例 -&gt; 外部类” 的引用关系不存在。</li><li>具体方案：将Handler的子类设置成静态内部类。此外，还可使用WeakReference弱引用持有外部类，保证外部类能被回收。因为：弱引用的对象拥有短暂的生命周期，在垃圾回收器线程扫描时，一旦发现了具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存</li></ul> 
<h5><a id="2Handler_688"></a>2.当外部类结束生命周期时，清空Handler内消息队列</h5> 
<ul><li> <p>原理：不仅使得 “未被处理 / 正处理的消息 -&gt; Handler实例 -&gt; 外部类” 的引用关系不复存在，同时使得 Handler的生命周期(即消息存在的时期)与外部类的生命周期同步</p> </li><li> <p>具体方案：当外部类(此处以Activity为例)结束生命周期时(此时系统会调用onDestroy())，清除 Handler消息队列里的所有消息(调用removeCallbacksAndMessages(null))</p> </li><li> <p>具体代码</p> </li></ul> 
<pre><code class="prism language-kotlin"><span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 外部类生命周期结束时，同时清空消息队列 &amp; 结束Handler生命周期</span>
  mHandler<span class="token punctuation">.</span><span class="token function">removeCallbacksAndMessages</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="8Demo_704"></a>8.Demo</h3> 
<p>具体代码如下：</p> 
<ul><li>Handler</li></ul> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">MyHandler</span><span class="token punctuation">(</span>binding<span class="token operator">:</span> ActivityMainBinding<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> context<span class="token operator">:</span> Context
    <span class="token keyword">private</span> <span class="token keyword">var</span> linear<span class="token operator">:</span> LinearLayout

    <span class="token keyword">init</span> <span class="token punctuation">{<!-- --></span>
        context <span class="token operator">=</span> binding<span class="token punctuation">.</span>root<span class="token punctuation">.</span>context
        linear <span class="token operator">=</span> binding<span class="token punctuation">.</span>linear
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> Message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            MainActivity<span class="token punctuation">.</span>MESSAGE_ADD_NODE <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">val</span> button <span class="token operator">=</span> msg<span class="token punctuation">.</span>obj <span class="token keyword">as</span> Button
                linear<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>button<span class="token punctuation">,</span> LinearLayout<span class="token punctuation">.</span><span class="token function">LayoutParams</span><span class="token punctuation">(</span>LinearLayout<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>WRAP_CONTENT
                    <span class="token punctuation">,</span> LinearLayout<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>WRAP_CONTENT<span class="token punctuation">)</span><span class="token punctuation">)</span>
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">button<span class="token punctuation">.</span>id</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> button has been added to the page"</span></span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            MainActivity<span class="token punctuation">.</span>MESSAGE_DELETE_NODE <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">val</span> button <span class="token operator">=</span> msg<span class="token punctuation">.</span>obj <span class="token keyword">as</span> Button
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">button<span class="token punctuation">.</span>id</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> button has been deleted from the page"</span></span>
                    <span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                linear<span class="token punctuation">.</span><span class="token function">removeView</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            MainActivity<span class="token punctuation">.</span>MESSAGE_CLEAR_NODE <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                linear<span class="token punctuation">.</span><span class="token function">removeAllViews</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"All button has been deleted from the page"</span></span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>MainActivity</li></ul> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> OnClickListener <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> <span class="token keyword">val</span> MESSAGE_ADD_NODE <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">const</span> <span class="token keyword">val</span> MESSAGE_DELETE_NODE <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">const</span> <span class="token keyword">val</span> MESSAGE_CLEAR_NODE <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> map <span class="token operator">=</span> ConcurrentHashMap<span class="token operator">&lt;</span>Int<span class="token punctuation">,</span> Button<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> list <span class="token operator">=</span> mutableListOf<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> binding<span class="token operator">:</span> ActivityMainBinding
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> linear<span class="token operator">:</span> LinearLayout
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mHandler<span class="token operator">:</span> MyHandler

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        binding <span class="token operator">=</span> ActivityMainBinding<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>layoutInflater<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
        mHandler <span class="token operator">=</span> <span class="token function">MyHandler</span><span class="token punctuation">(</span>binding<span class="token punctuation">)</span>
        linear <span class="token operator">=</span> binding<span class="token punctuation">.</span>linear

        binding<span class="token punctuation">.</span>addNode<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        binding<span class="token punctuation">.</span>deleteNode<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        binding<span class="token punctuation">.</span>clearNode<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>

        <span class="token keyword">val</span> handler <span class="token operator">=</span> <span class="token function">MyHandler</span><span class="token punctuation">(</span>binding<span class="token punctuation">)</span>
        handler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">{<!-- --></span>linear<span class="token punctuation">.</span><span class="token function">removeAllViews</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"All button has been deleted from the page"</span></span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onClick</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Thread <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> msg <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">when</span> <span class="token punctuation">(</span>view<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>addNode <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    msg<span class="token punctuation">.</span>what <span class="token operator">=</span> MESSAGE_ADD_NODE
                    <span class="token keyword">val</span> button <span class="token operator">=</span> <span class="token function">Button</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>root<span class="token punctuation">.</span>context<span class="token punctuation">)</span>
                    <span class="token keyword">val</span> id <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">999999</span><span class="token punctuation">)</span>
                    button<span class="token punctuation">.</span>id <span class="token operator">=</span> id
                    button<span class="token punctuation">.</span>text <span class="token operator">=</span> id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    button<span class="token punctuation">.</span>alpha <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">nextFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    map<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> button
                    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
                    msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> button
                <span class="token punctuation">}</span>
                R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>deleteNode <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        msg<span class="token punctuation">.</span>what <span class="token operator">=</span> MESSAGE_DELETE_NODE
                        <span class="token keyword">val</span> index <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
                        <span class="token keyword">val</span> button <span class="token operator">=</span> map<span class="token punctuation">[</span>list<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">]</span>
                        map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>list<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        list<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
                        msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> button
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span><span class="token label symbol">@Thread</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>clearNode <span class="token operator">-&gt;</span> msg<span class="token punctuation">.</span>what <span class="token operator">=</span> MESSAGE_CLEAR_NODE
            <span class="token punctuation">}</span>
            mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        mHandler<span class="token punctuation">.</span><span class="token function">removeCallbacksAndMessages</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>Activity_main.xml</li></ul> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span>
                <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/addNode<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>layout_marginStart</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20dp<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>textAllCaps</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@string/add_node<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span>
                <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/deleteNode<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>layout_marginStart</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20dp<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>textAllCaps</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@string/delete_node<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span>
                <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/clearNode<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>layout_marginStart</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20dp<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>textAllCaps</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@string/clear_node<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span>
            <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/linear<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>horizontal<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5c/99/WV19IVl5_o.png" alt=""></p> 
<ol><li><a href="https://blog.csdn.net/helloworld370629/article/details/128123226">【Android】自定义View / ViewGroup</a></li><li><a href="https://blog.csdn.net/helloworld370629/article/details/127544072">【Android】动画简介</a></li><li><a href="https://blog.csdn.net/helloworld370629/article/details/128461898">【Android】事件分发详解</a></li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6e01d92d7509d8c80eb87c7ce98440cc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">离线使用huggingface bert对文本编码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9282762379db9654514e2874e6423f01/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">报错：虚拟机重启后发现ens33的ip地址失踪，导致xshell连接不上</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>