<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>学堂在线-清华大学-操作系统实验Lab1【练习1-2】 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="学堂在线-清华大学-操作系统实验Lab1【练习1-2】" />
<meta property="og:description" content="实验手册：https://chyyuu.gitbooks.io/ucore_os_docs/content/
练习1：理解通过make生成执行文件的过程 1. 操作系统镜像文件ucore.img是如何一步一步生成的？ 首先进入目录 home/moocos/ucore_lab/labcodes_answer/lab1_result
make：根据Makefile文件编译源代码、连接、生成目标文件、可执行文件。
make clean：清除上次的make命令所产生的object文件（后缀为“.o”的文件）及可执行文件。
make V=：显示make具体执行了哪些命令。
在linux下.c只是简单的文本文件，.o是编译之后的二进制文件也称对象文件。
以下是 make V= 显示的结果： &#43; cc kern/init/init.c gcc -Ikern/init/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/init/init.c -o obj/kern/init/init.o &#43; cc kern/libs/readline.c gcc -Ikern/libs/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/libs/readline.c -o obj/kern/libs/readline.o &#43; cc kern/libs/stdio.c gcc -Ikern/libs/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc -fno-stack-protector -Ilibs/ -Ikern/debug/ -Ikern/driver/ -Ikern/trap/ -Ikern/mm/ -c kern/libs/stdio." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/8ea91b9dc4959930b953ea2f0dbc0fa1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-13T11:39:31+08:00" />
<meta property="article:modified_time" content="2021-08-13T11:39:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">学堂在线-清华大学-操作系统实验Lab1【练习1-2】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>实验手册：<a href="https://chyyuu.gitbooks.io/ucore_os_docs/content/" rel="nofollow">https://chyyuu.gitbooks.io/ucore_os_docs/content/</a></p> 
<h4><a id="1make_2"></a>练习1：理解通过make生成执行文件的过程</h4> 
<h5><a id="1_ucoreimg_3"></a>1. 操作系统镜像文件ucore.img是如何一步一步生成的？</h5> 
<p>首先进入目录 home/moocos/ucore_lab/labcodes_answer/lab1_result</p> 
<p><mark>make</mark>：根据Makefile文件编译源代码、连接、生成目标文件、可执行文件。<br> <mark>make clean</mark>：清除上次的make命令所产生的object文件（后缀为“.o”的文件）及可执行文件。<br> <mark>make V=</mark>：显示make具体执行了哪些命令。</p> 
<p>在linux下.c只是简单的文本文件，.o是编译之后的二进制文件也称对象文件。</p> 
<pre><code class="prism language-c">以下是 make V<span class="token operator">=</span> 显示的结果：
<span class="token operator">+</span> cc kern<span class="token operator">/</span>init<span class="token operator">/</span>init<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>init<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>init<span class="token operator">/</span>init<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>init<span class="token operator">/</span>init<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc kern<span class="token operator">/</span>libs<span class="token operator">/</span>readline<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>libs<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>libs<span class="token operator">/</span>readline<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>libs<span class="token operator">/</span>readline<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc kern<span class="token operator">/</span>libs<span class="token operator">/</span>stdio<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>libs<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>libs<span class="token operator">/</span>stdio<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>libs<span class="token operator">/</span>stdio<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc kern<span class="token operator">/</span>debug<span class="token operator">/</span>kdebug<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>debug<span class="token operator">/</span>kdebug<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>debug<span class="token operator">/</span>kdebug<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc kern<span class="token operator">/</span>debug<span class="token operator">/</span>kmonitor<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>debug<span class="token operator">/</span>kmonitor<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>debug<span class="token operator">/</span>kmonitor<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc kern<span class="token operator">/</span>debug<span class="token operator">/</span>panic<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>debug<span class="token operator">/</span>panic<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>debug<span class="token operator">/</span>panic<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc kern<span class="token operator">/</span>driver<span class="token operator">/</span>clock<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>driver<span class="token operator">/</span>clock<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>driver<span class="token operator">/</span>clock<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc kern<span class="token operator">/</span>driver<span class="token operator">/</span>console<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>driver<span class="token operator">/</span>console<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>driver<span class="token operator">/</span>console<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc kern<span class="token operator">/</span>driver<span class="token operator">/</span>intr<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>driver<span class="token operator">/</span>intr<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>driver<span class="token operator">/</span>intr<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc kern<span class="token operator">/</span>driver<span class="token operator">/</span>picirq<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>driver<span class="token operator">/</span>picirq<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>driver<span class="token operator">/</span>picirq<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc kern<span class="token operator">/</span>trap<span class="token operator">/</span>trap<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>trap<span class="token operator">/</span>trap<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>trap<span class="token operator">/</span>trap<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc kern<span class="token operator">/</span>trap<span class="token operator">/</span>trapentry<span class="token punctuation">.</span>S
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>trap<span class="token operator">/</span>trapentry<span class="token punctuation">.</span>S <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>trap<span class="token operator">/</span>trapentry<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc kern<span class="token operator">/</span>trap<span class="token operator">/</span>vectors<span class="token punctuation">.</span>S
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>trap<span class="token operator">/</span>vectors<span class="token punctuation">.</span>S <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>trap<span class="token operator">/</span>vectors<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc kern<span class="token operator">/</span>mm<span class="token operator">/</span>pmm<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>debug<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>driver<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>trap<span class="token operator">/</span> <span class="token operator">-</span>Ikern<span class="token operator">/</span>mm<span class="token operator">/</span> <span class="token operator">-</span>c kern<span class="token operator">/</span>mm<span class="token operator">/</span>pmm<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>mm<span class="token operator">/</span>pmm<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc libs<span class="token operator">/</span>printfmt<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span>  <span class="token operator">-</span>c libs<span class="token operator">/</span>printfmt<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>libs<span class="token operator">/</span>printfmt<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc libs<span class="token operator">/</span>string<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span>  <span class="token operator">-</span>c libs<span class="token operator">/</span>string<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>libs<span class="token operator">/</span>string<span class="token punctuation">.</span>o
<span class="token operator">+</span> ld bin<span class="token operator">/</span>kernel
ld <span class="token operator">-</span>m    elf_i386 <span class="token operator">-</span>nostdlib <span class="token operator">-</span>T tools<span class="token operator">/</span>kernel<span class="token punctuation">.</span>ld <span class="token operator">-</span>o bin<span class="token operator">/</span>kernel  obj<span class="token operator">/</span>kern<span class="token operator">/</span>init<span class="token operator">/</span>init<span class="token punctuation">.</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>libs<span class="token operator">/</span>readline<span class="token punctuation">.</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>libs<span class="token operator">/</span>stdio<span class="token punctuation">.</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>debug<span class="token operator">/</span>kdebug<span class="token punctuation">.</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>debug<span class="token operator">/</span>kmonitor<span class="token punctuation">.</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>debug<span class="token operator">/</span>panic<span class="token punctuation">.</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>driver<span class="token operator">/</span>clock<span class="token punctuation">.</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>driver<span class="token operator">/</span>console<span class="token punctuation">.</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>driver<span class="token operator">/</span>intr<span class="token punctuation">.</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>driver<span class="token operator">/</span>picirq<span class="token punctuation">.</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>trap<span class="token operator">/</span>trap<span class="token punctuation">.</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>trap<span class="token operator">/</span>trapentry<span class="token punctuation">.</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>trap<span class="token operator">/</span>vectors<span class="token punctuation">.</span>o obj<span class="token operator">/</span>kern<span class="token operator">/</span>mm<span class="token operator">/</span>pmm<span class="token punctuation">.</span>o  obj<span class="token operator">/</span>libs<span class="token operator">/</span>printfmt<span class="token punctuation">.</span>o obj<span class="token operator">/</span>libs<span class="token operator">/</span>string<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc boot<span class="token operator">/</span>bootasm<span class="token punctuation">.</span>S
gcc <span class="token operator">-</span>Iboot<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Os <span class="token operator">-</span>nostdinc <span class="token operator">-</span>c boot<span class="token operator">/</span>bootasm<span class="token punctuation">.</span>S <span class="token operator">-</span>o obj<span class="token operator">/</span>boot<span class="token operator">/</span>bootasm<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc boot<span class="token operator">/</span>bootmain<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Iboot<span class="token operator">/</span> <span class="token operator">-</span>fno<span class="token operator">-</span>builtin <span class="token operator">-</span>Wall <span class="token operator">-</span>ggdb <span class="token operator">-</span>m32 <span class="token operator">-</span>gstabs <span class="token operator">-</span>nostdinc  <span class="token operator">-</span>fno<span class="token operator">-</span>stack<span class="token operator">-</span>protector <span class="token operator">-</span>Ilibs<span class="token operator">/</span> <span class="token operator">-</span>Os <span class="token operator">-</span>nostdinc <span class="token operator">-</span>c boot<span class="token operator">/</span>bootmain<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>boot<span class="token operator">/</span>bootmain<span class="token punctuation">.</span>o
<span class="token operator">+</span> cc tools<span class="token operator">/</span>sign<span class="token punctuation">.</span>c
gcc <span class="token operator">-</span>Itools<span class="token operator">/</span> <span class="token operator">-</span>g <span class="token operator">-</span>Wall <span class="token operator">-</span>O2 <span class="token operator">-</span>c tools<span class="token operator">/</span>sign<span class="token punctuation">.</span>c <span class="token operator">-</span>o obj<span class="token operator">/</span>sign<span class="token operator">/</span>tools<span class="token operator">/</span>sign<span class="token punctuation">.</span>o
gcc <span class="token operator">-</span>g <span class="token operator">-</span>Wall <span class="token operator">-</span>O2 obj<span class="token operator">/</span>sign<span class="token operator">/</span>tools<span class="token operator">/</span>sign<span class="token punctuation">.</span>o <span class="token operator">-</span>o bin<span class="token operator">/</span>sign
<span class="token operator">+</span> ld bin<span class="token operator">/</span>bootblock
ld <span class="token operator">-</span>m    elf_i386 <span class="token operator">-</span>nostdlib <span class="token operator">-</span>N <span class="token operator">-</span>e start <span class="token operator">-</span>Ttext <span class="token number">0x7C00</span> obj<span class="token operator">/</span>boot<span class="token operator">/</span>bootasm<span class="token punctuation">.</span>o obj<span class="token operator">/</span>boot<span class="token operator">/</span>bootmain<span class="token punctuation">.</span>o <span class="token operator">-</span>o obj<span class="token operator">/</span>bootblock<span class="token punctuation">.</span>o
<span class="token string">'obj/bootblock.out'</span> size<span class="token operator">:</span> <span class="token number">488</span> bytes
build <span class="token number">512</span> bytes boot sector<span class="token operator">:</span> <span class="token string">'bin/bootblock'</span> success<span class="token operator">!</span>
dd <span class="token keyword">if</span><span class="token operator">=</span><span class="token operator">/</span>dev<span class="token operator">/</span>zero of<span class="token operator">=</span>bin<span class="token operator">/</span>ucore<span class="token punctuation">.</span>img count<span class="token operator">=</span><span class="token number">10000</span>
<span class="token number">10000</span><span class="token operator">+</span><span class="token number">0</span> records in
<span class="token number">10000</span><span class="token operator">+</span><span class="token number">0</span> records out
<span class="token number">5120000</span> <span class="token function">bytes</span> <span class="token punctuation">(</span><span class="token number">5.1</span> MB<span class="token punctuation">)</span> copied<span class="token punctuation">,</span> <span class="token number">0.052428</span> s<span class="token punctuation">,</span> <span class="token number">97.7</span> MB<span class="token operator">/</span>s
dd <span class="token keyword">if</span><span class="token operator">=</span>bin<span class="token operator">/</span>bootblock of<span class="token operator">=</span>bin<span class="token operator">/</span>ucore<span class="token punctuation">.</span>img conv<span class="token operator">=</span>notrunc
<span class="token number">1</span><span class="token operator">+</span><span class="token number">0</span> records in
<span class="token number">1</span><span class="token operator">+</span><span class="token number">0</span> records out
<span class="token number">512</span> <span class="token function">bytes</span> <span class="token punctuation">(</span><span class="token number">512</span> B<span class="token punctuation">)</span> copied<span class="token punctuation">,</span> <span class="token number">8.8643e-05</span> s<span class="token punctuation">,</span> <span class="token number">5.8</span> MB<span class="token operator">/</span>s
dd <span class="token keyword">if</span><span class="token operator">=</span>bin<span class="token operator">/</span>kernel of<span class="token operator">=</span>bin<span class="token operator">/</span>ucore<span class="token punctuation">.</span>img seek<span class="token operator">=</span><span class="token number">1</span> conv<span class="token operator">=</span>notrunc
<span class="token number">146</span><span class="token operator">+</span><span class="token number">1</span> records in
<span class="token number">146</span><span class="token operator">+</span><span class="token number">1</span> records out
<span class="token number">74923</span> <span class="token function">bytes</span> <span class="token punctuation">(</span><span class="token number">75</span> kB<span class="token punctuation">)</span> copied<span class="token punctuation">,</span> <span class="token number">0.00101346</span> s<span class="token punctuation">,</span> <span class="token number">73.9</span> MB<span class="token operator">/</span>s
</code></pre> 
<p>cc来自于Unix的c语言编译器，是 c compiler 的缩写；gcc来自Linux世界，是GNU compiler collection 的缩写，是编译器集合。</p> 
<p>makefile中，命令行第一个字符为加号+，则执行命令时不受到make的-n -t -q三个参数的影响。</p> 
<p>上面命令前部分都是cc和gcc，用于编译.c文件生成.o文件，这里cc指向gcc，因此在Linux下cc等价于gcc。</p> 
<p>如果不加V=，也会输出+cc，+ld等内容，可能这里是一些提示信息。</p> 
<blockquote> 
 <p>gcc中-c和-o是编译时可选的参数<br> -加-c, (compile)只编译生成中间同名目标文件，不链接，生成.o文件，不产生执行文件<br> -加-o，(output)指定输出文件名，该文件为可执行文件，不加-o会默认生成filemame.out<br> 举例：<br> gcc -c hello.c 编译生成hello.o文件<br> gcc -o hello hello.c 生成可执行文件hello</p> 
</blockquote> 
<blockquote> 
 <p>gcc -c a.c 编译成目标文件a.o<br> gcc a.c 生成执行文件a.exe<br> gcc -o a -c a.c 编译成目标文件a<br> gcc -o a a.c 生成执行文件a.exe<br> 在a.c中引用test.c中的一个函数后：<br> gcc -c test.c 编译成目标文件test.o<br> gcc -c a.c 编译成目标文件a.o<br> gcc -o a test.o a.o 生成执行文件a.exe<br> gcc -o a test.o a.c 生成执行文件a.exe<br> gcc -o a test.c a.c 生成执行文件a.exe<br> 总结：只要参数中有-c，总是生成目标文件；只要参数中无-c而只有-o，则总是生成执行文件。</p> 
</blockquote> 
<p><mark>-fno-builtin</mark>：允许定义函数的时候和C语言的内建函数重名。</p> 
<p><mark>-Wall</mark>：该选项能发现程序中一系列的常见错误警告。虽然GCC提供了非常丰富的警告，但前提是你已经启用了它们，否则它不会报告这些检测到的警告。</p> 
<p><mark>-ggdb</mark>：-ggdb产生的debug信息更倾向于给GDB使用的。如果用的GDB调试器，那么使用-ggdb选项，如果是其他调试器，则使用-g。</p> 
<p><mark>-m32</mark>：-m32 生成32位机器的汇编代码；-m64则生成64位机器汇编代码。</p> 
<p><mark>-I</mark>（大写i）：指定头文件路径（相对路径或绝对路径，建议相对路径）。gcc/g++ 会先在当前目录查找你所制定的头文件，如果没有找到，他回到默认的头文件目录找，如果使用 -I 制定了目录,他会先在你所制定的目录查找, 然后再按常规的顺序去找。</p> 
<p><mark>-gstabs</mark>：-gstabs，以stabs格式声称调试信息，但是不包括gdb调试信息；-gstabs+，以stabs格式声称调试信息，并且包含仅供gdb使用的额外调试信息。</p> 
<p><mark>-nostdinc</mark>：不在标准系统文件夹寻找头文件，只在 -I 等参数指定的文件夹中搜索头文件。</p> 
<p><mark>-fno-stack-protector</mark>：禁用堆栈保护机制。</p> 
<p>ld：ld 命令是二进制工具集 GNU Binutils 的一员，是 GNU 链接器，用于将目标文件与库链接为可执行文件或库文件。在上面的ld命令的作用就是分别生成了kernel和bootblock文件。</p> 
<pre><code class="prism language-c">命令格式：ld <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> OBJFILES

<span class="token operator">-</span>b <span class="token operator">&lt;</span>input<span class="token operator">-</span>format<span class="token operator">&gt;</span>
	指定目标代码输入文件的格式
<span class="token operator">-</span>Bstatic
	只使用静态库
<span class="token operator">-</span>Bdynamic
	只使用动态库
<span class="token operator">-</span>Bsymbolic
	把引用捆绑到共享库中的全局符号
<span class="token operator">-</span>c <span class="token operator">&lt;</span>MRI<span class="token operator">-</span>commandfile<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">--</span>mri<span class="token operator">-</span>script<span class="token operator">=</span><span class="token operator">&lt;</span>MRI<span class="token operator">-</span>commandfile<span class="token operator">&gt;</span>
	为与 MRI 链接器兼容，ld 接受由 MRI 命令语言编写的脚本文件
<span class="token operator">--</span>cref
	创建跨引用表
<span class="token operator">-</span>d<span class="token punctuation">,</span><span class="token operator">-</span>dc<span class="token punctuation">,</span><span class="token operator">-</span>dp
	即使指定了可重定位的输出文件（使用<span class="token operator">-</span>r），也会为公共符号分配空间。脚本命令“FORCE_COMMON_ALLOCATION”具有相同的效果
<span class="token operator">-</span>defsym
	在输出文件中创建指定的全局符号
<span class="token operator">-</span>demangle
	在错误消息中还原符号名称
<span class="token operator">-</span>e <span class="token operator">&lt;</span>entry<span class="token operator">&gt;</span>
	使用指定的符号作为程序的初始执行点
<span class="token operator">-</span>E<span class="token punctuation">,</span><span class="token operator">--</span>export<span class="token operator">-</span>dynamic
	对于ELF格式文件，创建动态链接的可执行文件时，把所有符号添加到动态符号表
<span class="token operator">-</span>f <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">--</span>auxiliary<span class="token operator">=</span><span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>
	对于 ELF 格式共享对象，设置 DT_AUXILIARY 名称
<span class="token operator">-</span>F <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">--</span>filter<span class="token operator">=</span><span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>
	对于ELF格式共享对象，设置 DT_FILTER 名称。这告诉动态链接器，正在创建的共享对象的符号表应该用作共享对象名称的符号表的筛选器。
<span class="token operator">-</span>g
	被忽略。用于提供和其他工具的兼容性
<span class="token operator">-</span>h
	对于 ELF 格式共享对象，设置 DT_SONAME 名称
<span class="token operator">-</span>I<span class="token operator">&lt;</span>file<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">-</span>dynamic<span class="token operator">-</span>linker <span class="token operator">&lt;</span>file<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">--</span>dynamic<span class="token operator">-</span>linker<span class="token operator">=</span><span class="token operator">&lt;</span>file<span class="token operator">&gt;</span>
	指定动态链接器。这仅在生成依赖动态链接库的 ELF 可执行文件时才有意义。默认的动态链接器通常是正确的，除非您知道正在做什么，否则不要使用该选项。
<span class="token operator">-</span>l <span class="token operator">&lt;</span>namespec<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">--</span>library<span class="token operator">=</span><span class="token operator">&lt;</span>namespec<span class="token operator">&gt;</span>
	把指定的库文件添加到要链接的文件清单
<span class="token operator">-</span>L <span class="token operator">&lt;</span>searchdir<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">--</span>library<span class="token operator">-</span>path<span class="token operator">=</span>searchdir
	把指定的路径添加添加到搜索库的目录清单
<span class="token operator">-</span>M<span class="token punctuation">,</span> <span class="token operator">--</span>print<span class="token operator">-</span>map
	显示链接映射，用于诊断目的
<span class="token operator">-</span>Map<span class="token operator">=</span><span class="token operator">&lt;</span>mapfile<span class="token operator">&gt;</span><span class="token operator">:</span>
	将链接映射输出到指定的文件
<span class="token operator">-</span>m <span class="token operator">&lt;</span>emulation<span class="token operator">&gt;</span>
	模拟指定的链接器
<span class="token operator">-</span>N<span class="token punctuation">,</span><span class="token operator">--</span>omagic
	指定读取<span class="token operator">/</span>写入文本和数据段
<span class="token operator">-</span>n<span class="token punctuation">,</span><span class="token operator">--</span>nmagic
	关闭节的页面对齐，并禁用对共享库的链接。如果输出格式支持Unix样式的幻数，则将输出标记为<span class="token string">"NMAGIC"</span>
<span class="token operator">-</span>noinhibit<span class="token operator">-</span>exec
	生成输出文件，即使出现非致命链接错误。通常，如果链接器在链接过程中遇到错误，它将不会生成输出文件。
<span class="token operator">-</span>no<span class="token operator">-</span>keep<span class="token operator">-</span>memory
	ld 通常在内存中缓存输入文件的符号表来优化内存使用速度。此选项告诉 ld 不要缓存符号表。当链接大型可执行文件时，如果ld耗尽内存空间，则可能需要使用该选项
<span class="token operator">-</span>O <span class="token operator">&lt;</span>level<span class="token operator">&gt;</span>
	对于非零的优化等级，ld将优化输出。此操作会比较耗时，应该在生成最终的结果时使用。
<span class="token operator">-</span>o <span class="token operator">&lt;</span>output<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">--</span>output<span class="token operator">=</span><span class="token operator">&lt;</span>output<span class="token operator">&gt;</span>
	指定输出文件的名称
<span class="token operator">-</span>oformat<span class="token operator">=</span><span class="token operator">&lt;</span>output<span class="token operator">-</span>format<span class="token operator">&gt;</span>
	指定输出文件的二进制格式
<span class="token operator">-</span>R <span class="token operator">&lt;</span>filename<span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token operator">--</span>just<span class="token operator">-</span>symbols<span class="token operator">=</span><span class="token operator">&lt;</span>filename<span class="token operator">&gt;</span>
	从指定的文件读取符号名称和地址
<span class="token operator">-</span>r<span class="token punctuation">,</span><span class="token operator">--</span>relocatable
	生成可重定位的输出（称为部分连接）
<span class="token operator">-</span>rpath<span class="token operator">=</span><span class="token operator">&lt;</span>dir<span class="token operator">&gt;</span>
	把指定的目录添加到运行时库搜索路径
<span class="token operator">-</span>rpath<span class="token operator">-</span>link<span class="token operator">=</span><span class="token operator">&lt;</span>dir<span class="token operator">&gt;</span>
	指定搜索运行时共享库的目录
<span class="token operator">-</span>S<span class="token punctuation">,</span><span class="token operator">--</span>strip<span class="token operator">-</span>debug
	忽略来自输出文件的调试器符号信息
<span class="token operator">-</span>s<span class="token punctuation">,</span><span class="token operator">--</span>strip<span class="token operator">-</span>all
	忽略来自输出文件的所有符号信息
<span class="token operator">-</span>shared<span class="token punctuation">,</span> <span class="token operator">-</span>Bshareable
	创建共享库
<span class="token operator">-</span>split<span class="token operator">-</span>by<span class="token operator">-</span>file<span class="token punctuation">[</span><span class="token operator">=</span>size<span class="token punctuation">]</span>
	为每个目标文件在输出文件中创建额外的段大小达到size。size默认为<span class="token number">1</span>
<span class="token operator">-</span>split<span class="token operator">-</span>by<span class="token operator">-</span>reloc<span class="token punctuation">[</span><span class="token operator">=</span>count<span class="token punctuation">]</span>
	按照指定的长度在输出文件中创建额外的段
<span class="token operator">--</span>section<span class="token operator">-</span>start<span class="token operator">=</span><span class="token operator">&lt;</span>sectionname<span class="token operator">&gt;=</span><span class="token operator">&lt;</span>org<span class="token operator">&gt;</span>
	在输出文件中指定的地址定位指定的段
<span class="token operator">-</span>T <span class="token operator">&lt;</span>scriptfile<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">--</span>script<span class="token operator">=</span><span class="token operator">&lt;</span>scriptfile<span class="token operator">&gt;</span>
	使用 scriptfile 作为链接器脚本。此脚本将替换 ld 的默认链接器脚本（而不是添加到其中），因此脚本必须指定输出文件所需的所有内容。如果当前目录中不存在脚本文件，ld 会在 <span class="token operator">-</span>L 选项指定的目录中查找
<span class="token operator">-</span>Ttext<span class="token operator">=</span><span class="token operator">&lt;</span>org<span class="token operator">&gt;</span>
	使用指定的地址作为文本段的起始点
<span class="token operator">-</span>Tdata<span class="token operator">=</span><span class="token operator">&lt;</span>org<span class="token operator">&gt;</span>
	使用指定的地址作为数据段的起始点
<span class="token operator">-</span>Tbss<span class="token operator">=</span><span class="token operator">&lt;</span>org<span class="token operator">&gt;</span>
	使用指定的地址作为bss段的起始点
<span class="token operator">-</span>t<span class="token punctuation">,</span><span class="token operator">--</span>trace
	在处理输入文件时显示它们的名称
<span class="token operator">-</span>u <span class="token operator">&lt;</span>symbol<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">--</span>undefined<span class="token operator">=</span><span class="token operator">&lt;</span>symbol<span class="token operator">&gt;</span>
	强制指定符号在输出文件中作为未定义符号
<span class="token operator">-</span>v<span class="token punctuation">,</span> <span class="token operator">-</span>V<span class="token punctuation">,</span> <span class="token operator">--</span>version
	示ld版本号
<span class="token operator">-</span>warn<span class="token operator">-</span>common
	当一个通用符号和另一个通用符号结合时发出警告
<span class="token operator">-</span>warn<span class="token operator">-</span>constructors
	如果没有使用任何全局构造器，则发出警告
<span class="token operator">-</span>warn<span class="token operator">-</span>once
	对于每个未定义的符号只发出一次警告
<span class="token operator">-</span>warn<span class="token operator">-</span>section<span class="token operator">-</span>align
	如果为了对齐而改动了输出段地址，则发出警告
<span class="token operator">--</span>whole<span class="token operator">-</span>archive
	对于指定的存档文件，在存档中包含所有文件
<span class="token operator">-</span>X<span class="token punctuation">,</span> <span class="token operator">--</span>discard<span class="token operator">-</span>locals
	删除所有本地临时符号
<span class="token operator">-</span>x<span class="token punctuation">,</span> <span class="token operator">--</span>discard<span class="token operator">-</span>al
	删除所有本地符号
</code></pre> 
<p>实例：ld -m elf_i386 -nostdlib -T tools/kernel.ld -o bin/kernel obj/kern/init/init.o</p> 
<p>-m elf_i386：指定模拟仿真链接器为 elf_i386；-nostdlib：只搜索命令行上显式指定的库目录，在链接器脚本中指定的库目录（包括在命令行中指定的链接器脚本）将被忽略；-T tools/kernel.ld：指定链接器的脚本为 tools 目录下的 kernel.ld 文件；-o bin/kernel obj/kern/init/init.o：将转化好的可执行文件放到 bin/ 目录下，并命名为 kernel，链接的文件为 obj/kern/init/ 目录中的 init.o。</p> 
<p>dd：用指定大小的块拷贝一个文件，并在拷贝的同时进行指定的转换。上面的dd命令将dev/zero,，bin/bootblock，bin/kernel 写入到bin/ucore.img。</p> 
<blockquote> 
 <p>注意：指定数字的地方若以下列字符结尾，则乘以相应的数字：b=512；c=1；k=1024；w=2<br> 参数注释：<br> if=文件名：输入文件名，缺省为标准输入。即指定源文件。&lt; if=input file &gt;<br> of=文件名：输出文件名，缺省为标准输出。即指定目的文件。&lt; of=output file &gt;<br> ibs=bytes：一次读入bytes个字节，即指定一个块大小为bytes个字节。<br> obs=bytes：一次输出bytes个字节，即指定一个块大小为bytes个字节。<br> bs=bytes：同时设置读入/输出的块大小为bytes个字节。<br> cbs=bytes：一次转换bytes个字节，即指定转换缓冲区大小。<br> skip=blocks：从输入文件开头跳过blocks个块后再开始复制。<br> seek=blocks：从输出文件开头跳过blocks个块后再开始复制。<br> 注意：通常只用当输出文件是磁盘或磁带时才有效，即备份到磁盘或磁带时才有效。<br> count=blocks：仅拷贝blocks个块，块大小等于ibs指定的字节数。<br> conv=conversion：用指定的参数转换文件。<br> ascii：转换ebcdic为ascii<br> ebcdic：转换ascii为ebcdic<br> ibm：转换ascii为alternate ebcdic<br> block：把每一行转换为长度为cbs，不足部分用空格填充<br> unblock：使每一行的长度都为cbs，不足部分用空格填充<br> lcase：把大写字符转换为小写字符<br> ucase：把小写字符转换为大写字符<br> swab：交换输入的每对字节<br> noerror：出错时不停止<br> notrunc：不截短输出文件<br> sync：将每个输入块填充到ibs个字节，不足部分用空（NUL）字符补齐。</p> 
</blockquote> 
<p>实例：dd if=/dev/zero of=bin/ucore.img count=10000<br> 从 /dev/zero 文件中读取内容来替代标准输入stdin，将输出的内容写入到 bin 目录下的 ucore.img，替代标准的输出 stdout，复制 10000 个输入块。</p> 
<h5><a id="2_261"></a>2.一个被系统认为是符合规范的硬盘主引导扇区的特征是什么？</h5> 
<p>参考其它博文，发现都是从sign.c文件里面找到如下代码段：</p> 
<pre><code class="prism language-c">	buf<span class="token punctuation">[</span><span class="token number">510</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x55</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">511</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xAA</span><span class="token punctuation">;</span>
    FILE <span class="token operator">*</span>ofp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"wb+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size <span class="token operator">=</span> <span class="token function">fwrite</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> ofp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> <span class="token number">512</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"write '%s' error, size is %d.\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>判断出硬盘主引导扇区的特征是大小为512字节，并且最后两个字节是0x55AA。</p> 
<h4><a id="2qemulab1_277"></a>练习2：使用qemu执行并调试lab1中的软件。</h4> 
<p>通过查看Makefile，发现lab1-mon内容如下：</p> 
<pre><code class="prism language-c"> lab1<span class="token operator">-</span>mon<span class="token operator">:</span> $<span class="token punctuation">(</span>UCOREIMG<span class="token punctuation">)</span>
           $<span class="token punctuation">(</span>V<span class="token punctuation">)</span>$<span class="token punctuation">(</span>TERMINAL<span class="token punctuation">)</span> <span class="token operator">-</span>e <span class="token string">"$(QEMU) -S -s -d in_asm -D $(BINDIR)/q.log -m    202 onitor stdio -hda $&lt; -serial null"</span>
           $<span class="token punctuation">(</span>V<span class="token punctuation">)</span>sleep <span class="token number">2</span>
    	   $<span class="token punctuation">(</span>V<span class="token punctuation">)</span>$<span class="token punctuation">(</span>TERMINAL<span class="token punctuation">)</span> <span class="token operator">-</span>e <span class="token string">"gdb -q -x tools/lab1init"</span>
</code></pre> 
<p>第一条指令是让qemu把执行的指令log信息记录下来放入q.log，第二条是用gdb调试正在执行的Bootloader。</p> 
<p>查看 labcodes_answer/lab1_result/tools/lab1init 文件内容：</p> 
<pre><code class="prism language-c">file bin<span class="token operator">/</span>kernel
target remote <span class="token operator">:</span><span class="token number">1234</span>
set architecture i8086
b <span class="token operator">*</span><span class="token number">0x7c00</span>
<span class="token keyword">continue</span>
x <span class="token operator">/</span><span class="token number">2</span>i $pc
</code></pre> 
<p>这里都是gdb能识别的指令，第一行是加载bin/kernel，第二行是与qemu连接，第三行设置当前调试的CPU是8086，第四行是在0x7c00处设置一个断点，第五行继续运行，第六行是显示PC处的两条指令。</p> 
<h5><a id="1CPUBIOS_299"></a>1.从CPU加电后执行的第一条指令开始，单步跟踪BIOS的执行。</h5> 
<p>关于qemu这里摘录实验指导书的内容：</p> 
<pre><code class="prism language-c">运行参数
如果 qemu 使用的是默认 <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin 安装路径，则在命令行中可以直接使用 qemu 命令运行程序。qemu 运行可以有多参数，格式如：

qemu <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>disk_image<span class="token punctuation">]</span>
其中 disk_image 即硬盘镜像文件。

部分参数说明：

`<span class="token operator">-</span>hda file<span class="token string">'        `-hdb file'</span> `<span class="token operator">-</span>hdc file<span class="token string">' `-hdd file'</span>
    使用 file  作为硬盘<span class="token number">0</span>、<span class="token number">1</span>、<span class="token number">2</span>、<span class="token number">3</span>镜像。
`<span class="token operator">-</span>fda file<span class="token string">'  `-fdb file'</span>
    使用 file  作为软盘镜像，可以使用 <span class="token operator">/</span>dev<span class="token operator">/</span>fd0 作为 file 来使用主机软盘。
`<span class="token operator">-</span>cdrom file'
    使用 file  作为光盘镜像，可以使用 <span class="token operator">/</span>dev<span class="token operator">/</span>cdrom 作为 file 来使用主机 cd<span class="token operator">-</span>rom。
`<span class="token operator">-</span>boot <span class="token punctuation">[</span>a<span class="token operator">|</span>c<span class="token operator">|</span>d<span class="token punctuation">]</span>'
    从软盘<span class="token punctuation">(</span>a<span class="token punctuation">)</span>、光盘<span class="token punctuation">(</span>c<span class="token punctuation">)</span>、硬盘启动<span class="token punctuation">(</span>d<span class="token punctuation">)</span>，默认硬盘启动。
`<span class="token operator">-</span>snapshot'
    写入临时文件而不写回磁盘镜像，可以使用 C<span class="token operator">-</span>a s 来强制写回。
`<span class="token operator">-</span>m megs'
    设置虚拟内存为 msg M字节，默认为 <span class="token number">128</span>M 字节。
`<span class="token operator">-</span>smp n'
    设置为有 n 个 CPU 的 SMP 系统。以 PC 为目标机，最多支持 <span class="token number">255</span> 个 CPU。
`<span class="token operator">-</span>nographic'
    禁止使用图形输出。
其他：
    可用的主机设备 dev 例如：
        vc
            虚拟终端。
        null
            空设备
        <span class="token operator">/</span>dev<span class="token operator">/</span>XXX
            使用主机的 tty。
        file<span class="token operator">:</span> filename
            将输出写入到文件 filename 中。
        stdio
            标准输入<span class="token operator">/</span>输出。
        pipe：pipename
            命令管道 pipename。
        等。
    使用 dev 设备的命令如：
        `<span class="token operator">-</span>serial dev'
            重定向虚拟串口到主机设备 dev 中。
        `<span class="token operator">-</span>parallel dev'
            重定向虚拟并口到主机设备 dev 中。
        `<span class="token operator">-</span>monitor dev'
            重定向 monitor 到主机设备 dev 中。
    其他参数：
        `<span class="token operator">-</span>s'
            等待 gdb 连接到端口 <span class="token number">1234</span>。
        `<span class="token operator">-</span>p port'
            改变 gdb 连接端口到 port。
        `<span class="token operator">-</span>S'
            在启动时不启动 CPU， 需要在 monitor 中输入 <span class="token string">'c'</span>，才能让qemu继续模拟工作。
        `<span class="token operator">-</span>d'
            输出日志到 qemu<span class="token punctuation">.</span>log 文件。
</code></pre> 
<p>在可以使用 gdb 调试程序之前，必须使用 -g 或 –ggdb编译选项编译源文件。gdb 调试程序时通常使用的命令：<code>gdb progname</code><br> 这里是常用的一些指令：<a href="https://blog.csdn.net/q357010621/article/details/80244789">https://blog.csdn.net/q357010621/article/details/80244789</a></p> 
<p>从lab0的内容中可以找到，要进入bin目录下，执行qemu -S -s -hda ./ucore.img -monitor stdio指令。</p> 
<p>再打开一个terminal，输入以下指令：</p> 
<pre><code class="prism language-c">gdb kernel
target remote <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">1234</span>
si
x <span class="token operator">/</span><span class="token number">2</span>i $pc
</code></pre> 
<p>si是stepi的简写，单步执行一条机械指令（包括进入函数）。</p> 
<h5><a id="20x7c00_376"></a>2.在初始化位置0x7c00设置实地址断点,测试断点正常。</h5> 
<pre><code class="prism language-c"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> b<span class="token operator">*</span><span class="token number">0x7c00</span>
Breakpoint <span class="token number">1</span> at <span class="token number">0</span><span class="token function">x7c00</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> c
Continuing<span class="token punctuation">.</span>

Breakpoint <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x00007c00</span> in <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> x <span class="token operator">/</span><span class="token number">2</span>i $pc
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0x7c00</span><span class="token operator">:</span>	cli    
   <span class="token number">0x7c01</span><span class="token operator">:</span>	cld  
</code></pre> 
<h5><a id="30x7c00bootasmS_bootblockasm_390"></a>3.从0x7c00开始跟踪代码运行,将单步跟踪反汇编得到的代码与bootasm.S和 bootblock.asm进行比较。</h5> 
<p>反汇编(Disassembly)：把目标代码转为汇编代码的过程，也可以说是把机器语言转换为汇编语言代码、低级转高级的意思。</p> 
<pre><code class="prism language-c"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> b<span class="token operator">*</span><span class="token number">0x7c00</span>
Breakpoint <span class="token number">1</span> at <span class="token number">0</span><span class="token function">x7c00</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> c
Continuing<span class="token punctuation">.</span>

Breakpoint <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x00007c00</span> in <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> x <span class="token operator">/</span><span class="token number">2</span>i $pc
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0x7c00</span><span class="token operator">:</span>	cli    
   <span class="token number">0x7c01</span><span class="token operator">:</span>	<span class="token function">cld</span>    
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> si
<span class="token number">0x00007c01</span> in <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> si
<span class="token number">0x00007c02</span> in <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> x <span class="token operator">/</span><span class="token number">10</span>i $pc
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0x7c02</span><span class="token operator">:</span>	xor    <span class="token operator">%</span>eax<span class="token punctuation">,</span><span class="token operator">%</span>eax
   <span class="token number">0x7c04</span><span class="token operator">:</span>	mov    <span class="token operator">%</span>eax<span class="token punctuation">,</span><span class="token operator">%</span>ds
   <span class="token number">0x7c06</span><span class="token operator">:</span>	mov    <span class="token operator">%</span>eax<span class="token punctuation">,</span><span class="token operator">%</span>es
   <span class="token number">0x7c08</span><span class="token operator">:</span>	mov    <span class="token operator">%</span>eax<span class="token punctuation">,</span><span class="token operator">%</span>ss
   <span class="token number">0x7c0a</span><span class="token operator">:</span>	in     $<span class="token number">0x64</span><span class="token punctuation">,</span><span class="token operator">%</span>al
   <span class="token number">0x7c0c</span><span class="token operator">:</span>	test   $<span class="token number">0x2</span><span class="token punctuation">,</span><span class="token operator">%</span>al
   <span class="token number">0x7c0e</span><span class="token operator">:</span>	jne    <span class="token number">0x7c0a</span>
   <span class="token number">0x7c10</span><span class="token operator">:</span>	mov    $<span class="token number">0xd1</span><span class="token punctuation">,</span><span class="token operator">%</span>al
   <span class="token number">0x7c12</span><span class="token operator">:</span>	out    <span class="token operator">%</span>al<span class="token punctuation">,</span>$<span class="token number">0x64</span>
   <span class="token number">0x7c14</span><span class="token operator">:</span>	in     $<span class="token number">0x64</span><span class="token punctuation">,</span><span class="token operator">%</span>al
</code></pre> 
<p>与bootasm.S和 bootblock.asm进行比较后发现相应位置的代码一致。</p> 
<p>bootblock.S：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Start the CPU<span class="token operator">:</span> <span class="token keyword">switch</span> to <span class="token number">32</span><span class="token operator">-</span>bit protected mode<span class="token punctuation">,</span> jump into C<span class="token punctuation">.</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">The BIOS loads this code from the first sector of the hard disk into</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">memory</span> <span class="token expression">at physical address <span class="token number">0x7c00</span> and starts executing in real mode</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">with</span> <span class="token expression"><span class="token operator">%</span>cs<span class="token operator">=</span><span class="token number">0</span> <span class="token operator">%</span>ip<span class="token operator">=</span><span class="token number">7</span>c00<span class="token punctuation">.</span></span></span>

<span class="token punctuation">.</span>set PROT_MODE_CSEG<span class="token punctuation">,</span>        <span class="token number">0x8</span>                     # kernel code segment selector
<span class="token punctuation">.</span>set PROT_MODE_DSEG<span class="token punctuation">,</span>        <span class="token number">0x10</span>                    # kernel data segment selector
<span class="token punctuation">.</span>set CR0_PE_ON<span class="token punctuation">,</span>             <span class="token number">0x1</span>                     # protected mode enable flag

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">start</span> <span class="token expression">address should be <span class="token number">0</span><span class="token operator">:</span><span class="token number">7</span>c00<span class="token punctuation">,</span> in real mode<span class="token punctuation">,</span> the beginning address of the running bootloader</span></span>
<span class="token punctuation">.</span>globl start
start<span class="token operator">:</span>
<span class="token punctuation">.</span>code16                                             # Assemble <span class="token keyword">for</span> <span class="token number">16</span><span class="token operator">-</span>bit mode
    cli                                             # Disable interrupts
    cld                                             # String operations increment

    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Set up the important data segment <span class="token function">registers</span> <span class="token punctuation">(</span>DS<span class="token punctuation">,</span> ES<span class="token punctuation">,</span> SS<span class="token punctuation">)</span><span class="token punctuation">.</span></span></span>
    xorw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>ax                                   # Segment number zero
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>ds                                   # <span class="token operator">-&gt;</span> Data Segment
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>es                                   # <span class="token operator">-&gt;</span> Extra Segment
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>ss                                   # <span class="token operator">-&gt;</span> Stack Segment

    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Enable A20<span class="token operator">:</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span>  <span class="token expression">For backwards compatibility with the earliest PCs<span class="token punctuation">,</span> physical</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">address</span> <span class="token expression">line <span class="token number">20</span> is tied low<span class="token punctuation">,</span> so that addresses higher than</span></span>
    #  <span class="token number">1</span>MB wrap around to zero by <span class="token keyword">default</span><span class="token punctuation">.</span> This code undoes this<span class="token punctuation">.</span>
seta20<span class="token punctuation">.</span><span class="token number">1</span><span class="token operator">:</span>
    inb $<span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token operator">%</span>al                                  # Wait <span class="token keyword">for</span> not <span class="token function">busy</span><span class="token punctuation">(</span><span class="token number">8042</span> input buffer empty<span class="token punctuation">)</span><span class="token punctuation">.</span>
    testb $<span class="token number">0x2</span><span class="token punctuation">,</span> <span class="token operator">%</span>al
    jnz seta20<span class="token punctuation">.</span><span class="token number">1</span>

    movb $<span class="token number">0xd1</span><span class="token punctuation">,</span> <span class="token operator">%</span>al                                 # <span class="token number">0xd1</span> <span class="token operator">-&gt;</span> port <span class="token number">0x64</span>
    outb <span class="token operator">%</span>al<span class="token punctuation">,</span> $<span class="token number">0x64</span>                                 # <span class="token number">0xd1</span> means<span class="token operator">:</span> write data to <span class="token number">8042</span>'s P2 port

seta20<span class="token punctuation">.</span><span class="token number">2</span><span class="token operator">:</span>
    inb $<span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token operator">%</span>al                                  # Wait <span class="token keyword">for</span> not <span class="token function">busy</span><span class="token punctuation">(</span><span class="token number">8042</span> input buffer empty<span class="token punctuation">)</span><span class="token punctuation">.</span>
    testb $<span class="token number">0x2</span><span class="token punctuation">,</span> <span class="token operator">%</span>al
    jnz seta20<span class="token punctuation">.</span><span class="token number">2</span>

    movb $<span class="token number">0xdf</span><span class="token punctuation">,</span> <span class="token operator">%</span>al                                 # <span class="token number">0xdf</span> <span class="token operator">-&gt;</span> port <span class="token number">0x60</span>
    outb <span class="token operator">%</span>al<span class="token punctuation">,</span> $<span class="token number">0x60</span>                                 # <span class="token number">0xdf</span> <span class="token operator">=</span> <span class="token number">11011111</span><span class="token punctuation">,</span> means set P2's A20 <span class="token function">bit</span><span class="token punctuation">(</span>the <span class="token number">1</span> bit<span class="token punctuation">)</span> to <span class="token number">1</span>

    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Switch from real to protected mode<span class="token punctuation">,</span> using a bootstrap GDT</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">and</span> <span class="token expression">segment translation that makes virtual addresses</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">identical</span> <span class="token expression">to physical addresses<span class="token punctuation">,</span> so that the</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">effective</span> <span class="token expression">memory map does not change during the <span class="token keyword">switch</span><span class="token punctuation">.</span></span></span>
    lgdt gdtdesc
    movl <span class="token operator">%</span>cr0<span class="token punctuation">,</span> <span class="token operator">%</span>eax
    orl $CR0_PE_ON<span class="token punctuation">,</span> <span class="token operator">%</span>eax
    movl <span class="token operator">%</span>eax<span class="token punctuation">,</span> <span class="token operator">%</span>cr0

    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Jump to next instruction<span class="token punctuation">,</span> but in <span class="token number">32</span><span class="token operator">-</span>bit code segment<span class="token punctuation">.</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Switches processor into <span class="token number">32</span><span class="token operator">-</span>bit mode<span class="token punctuation">.</span></span></span>
    ljmp $PROT_MODE_CSEG<span class="token punctuation">,</span> $protcseg

<span class="token punctuation">.</span>code32                                             # Assemble <span class="token keyword">for</span> <span class="token number">32</span><span class="token operator">-</span>bit mode
protcseg<span class="token operator">:</span>
    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Set up the protected<span class="token operator">-</span>mode data segment registers</span></span>
    movw $PROT_MODE_DSEG<span class="token punctuation">,</span> <span class="token operator">%</span>ax                       # Our data segment selector
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>ds                                   # <span class="token operator">-&gt;</span> DS<span class="token operator">:</span> Data Segment
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>es                                   # <span class="token operator">-&gt;</span> ES<span class="token operator">:</span> Extra Segment
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>fs                                   # <span class="token operator">-&gt;</span> FS
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>gs                                   # <span class="token operator">-&gt;</span> GS
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>ss                                   # <span class="token operator">-&gt;</span> SS<span class="token operator">:</span> Stack Segment

    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Set up the stack pointer and call into C<span class="token punctuation">.</span> The stack region is from <span class="token number">0</span><span class="token operator">--</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">0x7c00</span><span class="token punctuation">)</span></span></span>
    movl $<span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token operator">%</span>ebp
    movl $start<span class="token punctuation">,</span> <span class="token operator">%</span>esp
    call bootmain

    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">If bootmain <span class="token function">returns</span> <span class="token punctuation">(</span>it shouldn't<span class="token punctuation">)</span><span class="token punctuation">,</span> loop<span class="token punctuation">.</span></span></span>
spin<span class="token operator">:</span>
    jmp spin

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Bootstrap GDT</span></span>
<span class="token punctuation">.</span>p2align <span class="token number">2</span>                                          # force <span class="token number">4</span> byte alignment
gdt<span class="token operator">:</span>
    SEG_NULLASM                                     # null seg
    <span class="token function">SEG_ASM</span><span class="token punctuation">(</span>STA_X<span class="token operator">|</span>STA_R<span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span>           # code seg <span class="token keyword">for</span> bootloader and kernel
    <span class="token function">SEG_ASM</span><span class="token punctuation">(</span>STA_W<span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">,</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span>                 # data seg <span class="token keyword">for</span> bootloader and kernel

gdtdesc<span class="token operator">:</span>
    <span class="token punctuation">.</span>word <span class="token number">0x17</span>                                      # <span class="token keyword">sizeof</span><span class="token punctuation">(</span>gdt<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token punctuation">.</span><span class="token keyword">long</span> gdt                                       # address gdt
</code></pre> 
<p>bootblock.asm：</p> 
<pre><code class="prism language-c">
obj<span class="token operator">/</span>bootblock<span class="token punctuation">.</span>o<span class="token operator">:</span>     file format elf32<span class="token operator">-</span>i386


Disassembly of section <span class="token punctuation">.</span>text<span class="token operator">:</span>

<span class="token number">00007</span>c00 <span class="token operator">&lt;</span>start<span class="token operator">&gt;</span><span class="token operator">:</span>

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">start</span> <span class="token expression">address should be <span class="token number">0</span><span class="token operator">:</span><span class="token number">7</span>c00<span class="token punctuation">,</span> in real mode<span class="token punctuation">,</span> the beginning address of the running bootloader</span></span>
<span class="token punctuation">.</span>globl start
start<span class="token operator">:</span>
<span class="token punctuation">.</span>code16                                             # Assemble <span class="token keyword">for</span> <span class="token number">16</span><span class="token operator">-</span>bit mode
    cli                                             # Disable interrupts
    <span class="token number">7</span>c00<span class="token operator">:</span>	fa                   	cli    
    cld                                             # String operations increment
    <span class="token number">7</span>c01<span class="token operator">:</span>	fc                   	cld    

    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Set up the important data segment <span class="token function">registers</span> <span class="token punctuation">(</span>DS<span class="token punctuation">,</span> ES<span class="token punctuation">,</span> SS<span class="token punctuation">)</span><span class="token punctuation">.</span></span></span>
    xorw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>ax                                   # Segment number zero
    <span class="token number">7</span>c02<span class="token operator">:</span>	<span class="token number">31</span> c0                	xor    <span class="token operator">%</span>eax<span class="token punctuation">,</span><span class="token operator">%</span>eax
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>ds                                   # <span class="token operator">-&gt;</span> Data Segment
    <span class="token number">7</span>c04<span class="token operator">:</span>	<span class="token number">8</span>e d8                	mov    <span class="token operator">%</span>eax<span class="token punctuation">,</span><span class="token operator">%</span>ds
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>es                                   # <span class="token operator">-&gt;</span> Extra Segment
    <span class="token number">7</span>c06<span class="token operator">:</span>	<span class="token number">8</span>e c0                	mov    <span class="token operator">%</span>eax<span class="token punctuation">,</span><span class="token operator">%</span>es
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>ss                                   # <span class="token operator">-&gt;</span> Stack Segment
    <span class="token number">7</span>c08<span class="token operator">:</span>	<span class="token number">8</span>e d0                	mov    <span class="token operator">%</span>eax<span class="token punctuation">,</span><span class="token operator">%</span>ss

<span class="token number">00007</span>c0a <span class="token operator">&lt;</span>seta20<span class="token punctuation">.</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token operator">:</span>
    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Enable A20<span class="token operator">:</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span>  <span class="token expression">For backwards compatibility with the earliest PCs<span class="token punctuation">,</span> physical</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">address</span> <span class="token expression">line <span class="token number">20</span> is tied low<span class="token punctuation">,</span> so that addresses higher than</span></span>
    #  <span class="token number">1</span>MB wrap around to zero by <span class="token keyword">default</span><span class="token punctuation">.</span> This code undoes this<span class="token punctuation">.</span>
seta20<span class="token punctuation">.</span><span class="token number">1</span><span class="token operator">:</span>
    inb $<span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token operator">%</span>al                                  # Wait <span class="token keyword">for</span> not <span class="token function">busy</span><span class="token punctuation">(</span><span class="token number">8042</span> input buffer empty<span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token number">7</span>c0a<span class="token operator">:</span>	e4 <span class="token number">64</span>                	in     $<span class="token number">0x64</span><span class="token punctuation">,</span><span class="token operator">%</span>al
    testb $<span class="token number">0x2</span><span class="token punctuation">,</span> <span class="token operator">%</span>al
    <span class="token number">7</span>c0c<span class="token operator">:</span>	a8 <span class="token number">02</span>                	test   $<span class="token number">0x2</span><span class="token punctuation">,</span><span class="token operator">%</span>al
    jnz seta20<span class="token punctuation">.</span><span class="token number">1</span>
    <span class="token number">7</span>c0e<span class="token operator">:</span>	<span class="token number">75</span> fa                	jne    <span class="token number">7</span>c0a <span class="token operator">&lt;</span>seta20<span class="token punctuation">.</span><span class="token number">1</span><span class="token operator">&gt;</span>

    movb $<span class="token number">0xd1</span><span class="token punctuation">,</span> <span class="token operator">%</span>al                                 # <span class="token number">0xd1</span> <span class="token operator">-&gt;</span> port <span class="token number">0x64</span>
    <span class="token number">7</span>c10<span class="token operator">:</span>	b0 d1                	mov    $<span class="token number">0xd1</span><span class="token punctuation">,</span><span class="token operator">%</span>al
    outb <span class="token operator">%</span>al<span class="token punctuation">,</span> $<span class="token number">0x64</span>                                 # <span class="token number">0xd1</span> means<span class="token operator">:</span> write data to <span class="token number">8042</span>'s P2 port
    <span class="token number">7</span>c12<span class="token operator">:</span>	e6 <span class="token number">64</span>                	out    <span class="token operator">%</span>al<span class="token punctuation">,</span>$<span class="token number">0x64</span>

<span class="token number">00007</span>c14 <span class="token operator">&lt;</span>seta20<span class="token punctuation">.</span><span class="token number">2</span><span class="token operator">&gt;</span><span class="token operator">:</span>

seta20<span class="token punctuation">.</span><span class="token number">2</span><span class="token operator">:</span>
    inb $<span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token operator">%</span>al                                  # Wait <span class="token keyword">for</span> not <span class="token function">busy</span><span class="token punctuation">(</span><span class="token number">8042</span> input buffer empty<span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token number">7</span>c14<span class="token operator">:</span>	e4 <span class="token number">64</span>                	in     $<span class="token number">0x64</span><span class="token punctuation">,</span><span class="token operator">%</span>al
    testb $<span class="token number">0x2</span><span class="token punctuation">,</span> <span class="token operator">%</span>al
    <span class="token number">7</span>c16<span class="token operator">:</span>	a8 <span class="token number">02</span>                	test   $<span class="token number">0x2</span><span class="token punctuation">,</span><span class="token operator">%</span>al
    jnz seta20<span class="token punctuation">.</span><span class="token number">2</span>
    <span class="token number">7</span>c18<span class="token operator">:</span>	<span class="token number">75</span> fa                	jne    <span class="token number">7</span>c14 <span class="token operator">&lt;</span>seta20<span class="token punctuation">.</span><span class="token number">2</span><span class="token operator">&gt;</span>

    movb $<span class="token number">0xdf</span><span class="token punctuation">,</span> <span class="token operator">%</span>al                                 # <span class="token number">0xdf</span> <span class="token operator">-&gt;</span> port <span class="token number">0x60</span>
    <span class="token number">7</span>c1a<span class="token operator">:</span>	b0 df                	mov    $<span class="token number">0xdf</span><span class="token punctuation">,</span><span class="token operator">%</span>al
    outb <span class="token operator">%</span>al<span class="token punctuation">,</span> $<span class="token number">0x60</span>                                 # <span class="token number">0xdf</span> <span class="token operator">=</span> <span class="token number">11011111</span><span class="token punctuation">,</span> means set P2's A20 <span class="token function">bit</span><span class="token punctuation">(</span>the <span class="token number">1</span> bit<span class="token punctuation">)</span> to <span class="token number">1</span>
    <span class="token number">7</span>c1c<span class="token operator">:</span>	e6 <span class="token number">60</span>                	out    <span class="token operator">%</span>al<span class="token punctuation">,</span>$<span class="token number">0x60</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h5><a id="4bootloader_577"></a>4.自己找一个bootloader或内核中的代码位置，设置断点并进行测试。</h5> 
<pre><code class="prism language-c"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> b<span class="token operator">*</span> <span class="token number">0x7c14</span>
Breakpoint <span class="token number">2</span> at <span class="token number">0</span><span class="token function">x7c14</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> c
Continuing<span class="token punctuation">.</span>

Breakpoint <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x00007c14</span> in <span class="token operator">?</span><span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> x <span class="token operator">/</span><span class="token number">2</span>i $pc
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0x7c14</span><span class="token operator">:</span>	in     $<span class="token number">0x64</span><span class="token punctuation">,</span><span class="token operator">%</span>al
   <span class="token number">0x7c16</span><span class="token operator">:</span>	test   $<span class="token number">0x2</span><span class="token punctuation">,</span><span class="token operator">%</span>al
</code></pre> 
<h4><a id="_593"></a>参考</h4> 
<ul><li><a href="https://blog.csdn.net/JeromeCoco/article/details/111387152">[从 0 开始写一个操作系统] 六、编译过程分析</a></li><li><a href="https://www.cnblogs.com/ginvip/p/6370836.html" rel="nofollow">linux命令总结dd命令详解</a></li><li><a href="https://blog.csdn.net/K346K346/article/details/89088652">Linux 命令（65）—— ld 命令</a></li><li><a href="https://blog.csdn.net/weixin_45803768/article/details/102771058">操作系统Lab1实验</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4083e7079fc72524ed8abdd22ba9406a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">wow服务器合并信息,WOW魔兽世界5月21日大服务合并维护 二区合并至电信区</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d8735ab12ca2782ba0fe8265a5c01e1b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">u大侠装服务器系统,U大侠一键U盘装系统装机&amp;UEFI二合一版</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>