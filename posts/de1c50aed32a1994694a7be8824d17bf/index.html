<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux内核编程小妙招 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux内核编程小妙招" />
<meta property="og:description" content="延时处理 #include &lt;linux/device.h&gt; #include &lt;linux/input.h&gt; #include &lt;linux/jiffies.h&gt; #include &lt;linux/mutex.h&gt; #include &lt;linux/slab.h&gt; #include &lt;linux/types.h&gt; #include &lt;linux/workqueue.h&gt; struct work_poller { void (*poll)(void *dev); unsigned int poll_interval; void *private; struct delayed_work work; }; void poller_queue_work(struct work_poller *poller) { unsigned long delay; delay = msecs_to_jiffies(poller-&gt;poll_interval); if (delay &gt;= HZ) delay = round_jiffies_relative(delay); queue_delayed_work(system_freezable_wq, &amp;poller-&gt;work, delay); } void poller_work(struct work_struct *work) { struct work_poller *poller = container_of(work, struct work_poller, work.work); poller-&gt;poll(poller-&gt;private); poller_queue_work(poller); } int init_polling(struct work_poller *polling, void (*poll_fn)(void *dev)) { polling = kzalloc(sizeof(struct work_poller), GFP_KERNEL); if (!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/de1c50aed32a1994694a7be8824d17bf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-25T14:33:54+08:00" />
<meta property="article:modified_time" content="2023-04-25T14:33:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux内核编程小妙招</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>延时处理</h2> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/input.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/jiffies.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mutex.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/workqueue.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">work_poller</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>poll<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> poll_interval<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>private<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">delayed_work</span> work<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">poller_queue_work</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">work_poller</span> <span class="token operator">*</span>poller<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> delay<span class="token punctuation">;</span>

	delay <span class="token operator">=</span> <span class="token function">msecs_to_jiffies</span><span class="token punctuation">(</span>poller<span class="token operator">-&gt;</span>poll_interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">&gt;=</span> HZ<span class="token punctuation">)</span>
		delay <span class="token operator">=</span> <span class="token function">round_jiffies_relative</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">queue_delayed_work</span><span class="token punctuation">(</span>system_freezable_wq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>poller<span class="token operator">-&gt;</span>work<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">poller_work</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">work_struct</span> <span class="token operator">*</span>work<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">work_poller</span> <span class="token operator">*</span>poller <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>work<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">work_poller</span><span class="token punctuation">,</span> work<span class="token punctuation">.</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>

	poller<span class="token operator">-&gt;</span><span class="token function">poll</span><span class="token punctuation">(</span>poller<span class="token operator">-&gt;</span>private<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">poller_queue_work</span><span class="token punctuation">(</span>poller<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">init_polling</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">work_poller</span> <span class="token operator">*</span>polling<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>poll_fn<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	polling <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">work_poller</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>polling<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">dev_err</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>parent <span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%s: unable to allocate poller structure\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">INIT_DELAYED_WORK</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>polling<span class="token operator">-&gt;</span>work<span class="token punctuation">,</span> poller_work<span class="token punctuation">)</span><span class="token punctuation">;</span>
	polling<span class="token operator">-&gt;</span>poll <span class="token operator">=</span> poll_fn<span class="token punctuation">;</span>
	polling<span class="token operator">-&gt;</span>private <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//内核5.15</span>
<span class="token comment">/*
struct delayed_work work;
INIT_DELAYED_WORK(&amp;work, delay_work_fn);
void delay_work_fn(struct work_struct *work)
{
	{
	TODO ...
	}
	queue_delayed_work(system_freezable_wq, &amp;work, delay_time);
}
*/</span>
</code></pre> 
<h2><a id="_61"></a>定时器</h2> 
<pre><code class="prism language-c"><span class="token comment">//内核5.15</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/interrupt.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/input.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/workqueue.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/firmware.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/time64.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/timekeeping.h&gt;</span></span>
<span class="token comment">//static DEFINE_TIMER(timer, timer_handler);</span>
<span class="token keyword">struct</span> <span class="token class-name">timer_list</span> <span class="token operator">*</span>timer<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">timer_cb</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">timer_list</span> <span class="token operator">*</span>timer<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TODO <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token function">mod_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> jiffies <span class="token operator">+</span> <span class="token function">msecs_to_jiffies</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">timer_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">timer_setup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>timer<span class="token punctuation">,</span> timer_cb<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">mod_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tm<span class="token punctuation">,</span> jiffies <span class="token operator">+</span> <span class="token function">msecs_to_jiffies</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="proc_85"></a>/proc文件系统</h2> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/idr.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/input/mt.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/random.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/major.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/proc_fs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/sched.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/seq_file.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/poll.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/mutex.h&gt;</span></span>

<span class="token keyword">static</span> <span class="token function">LIST_HEAD</span><span class="token punctuation">(</span>dev_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">input_devices_seq_start</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>seq<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//seq-&gt;private;</span>
	TODO
	<span class="token keyword">return</span> <span class="token function">seq_list_start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev_list<span class="token punctuation">,</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">input_devices_seq_next</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>seq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>pos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TODO
	<span class="token keyword">return</span> <span class="token function">seq_list_next</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev_list<span class="token punctuation">,</span> pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">input_seq_stop</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>seq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//seq-&gt;private;</span>
	TODO
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">input_devices_seq_show</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>seq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>v<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TODO
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
struct seq_operations {
	void * (*start) (struct seq_file *m, loff_t *pos);
	void (*stop) (struct seq_file *m, void *v);
	void * (*next) (struct seq_file *m, void *v, loff_t *pos);
	int (*show) (struct seq_file *m, void *v);
};
*/</span>
<span class="token keyword">struct</span> <span class="token class-name">seq_operations</span> devices_seq_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>start	<span class="token operator">=</span> input_devices_seq_start<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>next	<span class="token operator">=</span> input_devices_seq_next<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>stop	<span class="token operator">=</span> input_seq_stop<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>show	<span class="token operator">=</span> input_devices_seq_show<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">proc_devices_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TODO
	<span class="token function">seq_open</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token operator">&amp;</span>devices_seq_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">proc_ops</span> devices_proc_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>proc_open	<span class="token operator">=</span> proc_devices_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>proc_read	<span class="token operator">=</span> seq_read<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>proc_lseek	<span class="token operator">=</span> seq_lseek<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>proc_release	<span class="token operator">=</span> seq_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> __init <span class="token function">input_proc_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">proc_dir_entry</span> <span class="token operator">*</span>entry<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">proc_dir_entry</span> <span class="token operator">*</span>proc_bus_dir<span class="token punctuation">;</span>
	proc_bus_dir <span class="token operator">=</span> <span class="token function">proc_mkdir</span><span class="token punctuation">(</span><span class="token string">"bus/input"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>proc_bus_input_dir<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
	entry <span class="token operator">=</span> <span class="token function">proc_create</span><span class="token punctuation">(</span><span class="token string">"devices"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> proc_bus_dir<span class="token punctuation">,</span> <span class="token operator">&amp;</span>devices_proc_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> fail1<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
 fail1<span class="token operator">:</span> <span class="token function">remove_proc_entry</span><span class="token punctuation">(</span><span class="token string">"bus/input"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">input_proc_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">remove_proc_entry</span><span class="token punctuation">(</span><span class="token string">"devices"</span><span class="token punctuation">,</span> proc_bus_input_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">remove_proc_entry</span><span class="token punctuation">(</span><span class="token string">"bus/input"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="sys_178"></a>/sys文件系统</h2> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">bus_type</span> bus_type <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"name"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">class</span> class_type<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>name		<span class="token operator">=</span> <span class="token string">"className"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">sys_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//在/sys/bus下创建目录</span>
	<span class="token function">bus_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bus_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//在/sys/class下创建目录</span>
	<span class="token function">class_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>class_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">sys_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">bus_unregister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bus_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="DEBUG_FS_200"></a>DEBUG_FS</h2> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">iio_debugfs_read_reg</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>userbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//file-&gt;private_data;</span>
	TODO
	<span class="token comment">//ssize_t simple_read_from_buffer(void __user *to, size_t count, loff_t *ppos, const void *from, size_t available);</span>
	<span class="token keyword">return</span> <span class="token function">simple_read_from_buffer</span><span class="token punctuation">(</span>userbuf<span class="token punctuation">,</span> count<span class="token punctuation">,</span> ppos<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">iio_debugfs_write_reg</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>userbuf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span>ppos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//file-&gt;private_data;</span>
	<span class="token comment">//copy_from_user(buf, userbuf, count)</span>
	<span class="token comment">//sscanf(buf, "%i %i", &amp;reg, &amp;val)</span>
	TODO
	<span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> debugfs_fops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>open <span class="token operator">=</span> simple_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>read <span class="token operator">=</span> iio_debugfs_read_reg<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>write <span class="token operator">=</span> iio_debugfs_write_reg<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">debug_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">dentry</span> <span class="token operator">*</span>debugfs_dentry
	debugfs_dentry <span class="token operator">=</span> <span class="token function">debugfs_create_dir</span><span class="token punctuation">(</span><span class="token string">"iio"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//struct dentry *debugfs_create_file(const char *name, umode_t mode, struct dentry *parent, void *data, const struct file_operations *fops);</span>
	<span class="token function">debugfs_create_file</span><span class="token punctuation">(</span><span class="token string">"direct_reg_access"</span><span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">,</span> debugfs_dentry <span class="token punctuation">,</span> <span class="token operator">&amp;</span>private_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>debugfs_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">debug_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">debugfs_remove</span><span class="token punctuation">(</span>debugfs_dentry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="irq_domain_237"></a>irq_domain</h2> 
<pre><code class="prism language-c"><span class="token comment">/*
static const struct of_device_id irqchip_of_match_end __used __section("__irqchip_of_table_end");

extern struct of_device_id __irqchip_of_table[];

void __init irqchip_init(void)
{
	of_irq_init(__irqchip_of_table);
	acpi_probe_device_table(irqchip);
}

int platform_irqchip_probe(struct platform_device *pdev)
{
	struct device_node *np = pdev-&gt;dev.of_node;
	struct device_node *par_np = of_irq_find_parent(np);
	of_irq_init_cb_t irq_init_cb = of_device_get_match_data(&amp;pdev-&gt;dev);

	if (!irq_init_cb)
		return -EINVAL;

	if (par_np == np)
		par_np = NULL;
	if (par_np &amp;&amp; !irq_find_matching_host(par_np, DOMAIN_BUS_ANY))
		return -EPROBE_DEFER;

	return irq_init_cb(np, par_np);
}
EXPORT_SYMBOL_GPL(platform_irqchip_probe);

#define IRQCHIP_PLATFORM_DRIVER_BEGIN(drv_name) \
static const struct of_device_id drv_name##_irqchip_match_table[] = {

#define IRQCHIP_MATCH(compat, fn) { .compatible = compat, .data = fn },

#define IRQCHIP_PLATFORM_DRIVER_END(drv_name)				\
	{},								\
};									\
MODULE_DEVICE_TABLE(of, drv_name##_irqchip_match_table);		\
static struct platform_driver drv_name##_driver = {		\
	.probe  = platform_irqchip_probe,				\
	.driver = {							\
		.name = #drv_name,					\
		.owner = THIS_MODULE,					\
		.of_match_table = drv_name##_irqchip_match_table,	\
		.suppress_bind_attrs = true,				\
	},								\
};									\
builtin_platform_driver(drv_name##_driver)
*/</span>

<span class="token function">IRQCHIP_PLATFORM_DRIVER_BEGIN</span><span class="token punctuation">(</span>drv_name<span class="token punctuation">)</span>
<span class="token function">IRQCHIP_MATCH</span><span class="token punctuation">(</span>compat<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
<span class="token function">IRQCHIP_PLATFORM_DRIVER_END</span><span class="token punctuation">(</span>drv_name<span class="token punctuation">)</span>
<span class="token comment">//或者</span>
<span class="token function">MODULE_DEVICE_TABLE</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> drv_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">builtin_platform_driver</span><span class="token punctuation">(</span>drv_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="irq_296"></a>irq</h2> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">irq_desc</span> irq_desc<span class="token punctuation">[</span>NR_IRQS<span class="token punctuation">]</span> __cacheline_aligned_in_smp <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">[</span><span class="token number">0</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> NR_IRQS<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>handle_irq	<span class="token operator">=</span> handle_bad_irq<span class="token punctuation">,</span>
		<span class="token punctuation">.</span>depth		<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span>lock		<span class="token operator">=</span> <span class="token function">__RAW_SPIN_LOCK_UNLOCKED</span><span class="token punctuation">(</span>irq_desc<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> __init <span class="token function">early_irq_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> count<span class="token punctuation">,</span> i<span class="token punctuation">,</span> node <span class="token operator">=</span> first_online_node<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">irq_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">;</span>

	<span class="token function">init_irq_default_affinity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"NR_IRQS: %d\n"</span><span class="token punctuation">,</span> NR_IRQS<span class="token punctuation">)</span><span class="token punctuation">;</span>

	desc <span class="token operator">=</span> irq_desc<span class="token punctuation">;</span>
	count <span class="token operator">=</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>irq_desc<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>kstat_irqs <span class="token operator">=</span> <span class="token function">alloc_percpu</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">alloc_masks</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">raw_spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">lockdep_set_class</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>irq_desc_lock_class<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>request_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>wait_for_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">desc_set_defaults</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//对应与不同架构，如arch/ia64/kernel/irq.c</span>
	<span class="token keyword">return</span> <span class="token function">arch_early_irq_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="bootargs_333"></a>bootargs传递以及处理</h2> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">obs_kernel_param</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>setup_func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> early<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*
 * Only for really core code.  See moduleparam.h for the normal way.
 * Force the alignment so the compiler doesn't space elements of the
 * obs_kernel_param "array" too far apart in .init.setup.
 */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__setup_param</span><span class="token expression"><span class="token punctuation">(</span>str<span class="token punctuation">,</span> unique_id<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> early<span class="token punctuation">)</span>			</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __setup_str_</span><span class="token punctuation">##</span><span class="token expression">unique_id<span class="token punctuation">[</span><span class="token punctuation">]</span> __initconst		</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">__aligned</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> str<span class="token punctuation">;</span> 					</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">obs_kernel_param</span> __setup_</span><span class="token punctuation">##</span><span class="token expression">unique_id		</span><span class="token punctuation">\</span>
		<span class="token expression">__used <span class="token function">__section</span><span class="token punctuation">(</span></span><span class="token string">".init.setup"</span><span class="token expression"><span class="token punctuation">)</span>				</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">__aligned</span><span class="token punctuation">(</span><span class="token function">__alignof__</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">obs_kernel_param</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> __setup_str_</span><span class="token punctuation">##</span><span class="token expression">unique_id<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> early <span class="token punctuation">}</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__setup</span><span class="token expression"><span class="token punctuation">(</span>str<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>						</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">__setup_param</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token comment">//一般用于bootargs传递参数</span>
<span class="token comment">/*
如：__setup("irqaffinity=", irq_affinity_setup);对应的设备树
chosen: chosen {
		bootargs = "console=ttyMSM0,115200n8 ... irqaffinity=0-3 ...";
};
*/</span>
</code></pre> 
<h2><a id="_363"></a>工作队列</h2> 
<pre><code class="prism language-c"><span class="token comment">/*
include/linux/workqueue.h
*/</span>
<span class="token keyword">struct</span> <span class="token class-name">work_struct</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">atomic_long_t</span> data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> entry<span class="token punctuation">;</span>
	<span class="token class-name">work_func_t</span> func<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_LOCKDEP</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">lockdep_map</span> lockdep_map<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">WORK_DATA_INIT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token function">ATOMIC_LONG_INIT</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>WORK_STRUCT_NO_POOL<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">WORK_DATA_STATIC_INIT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>	</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">ATOMIC_LONG_INIT</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>WORK_STRUCT_NO_POOL <span class="token operator">|</span> WORK_STRUCT_STATIC<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">struct</span> <span class="token class-name">delayed_work</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">work_struct</span> work<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">timer_list</span> timer<span class="token punctuation">;</span>

	<span class="token comment">/* target workqueue and CPU -&gt;timer uses to queue -&gt;work */</span>
	<span class="token keyword">struct</span> <span class="token class-name">workqueue_struct</span> <span class="token operator">*</span>wq<span class="token punctuation">;</span>
	<span class="token keyword">int</span> cpu<span class="token punctuation">;</span>

	<span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ANDROID_KABI_RESERVE</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * schedule_work - put work task in global workqueue
 * @work: job to be done
 */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> bool <span class="token function">schedule_work</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">work_struct</span> <span class="token operator">*</span>work<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">queue_work</span><span class="token punctuation">(</span>system_wq<span class="token punctuation">,</span> work<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">__INIT_WORK</span><span class="token expression"><span class="token punctuation">(</span>_work<span class="token punctuation">,</span> _func<span class="token punctuation">,</span> _onstack<span class="token punctuation">)</span>				</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>								</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">__init_work</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_work<span class="token punctuation">)</span><span class="token punctuation">,</span> _onstack<span class="token punctuation">)</span><span class="token punctuation">;</span>				</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token punctuation">(</span>_work<span class="token punctuation">)</span><span class="token operator">-&gt;</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">atomic_long_t</span><span class="token punctuation">)</span> <span class="token function">WORK_DATA_INIT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>_work<span class="token punctuation">)</span><span class="token operator">-&gt;</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>			</span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token punctuation">(</span>_work<span class="token punctuation">)</span><span class="token operator">-&gt;</span>func <span class="token operator">=</span> <span class="token punctuation">(</span>_func<span class="token punctuation">)</span><span class="token punctuation">;</span>				</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">INIT_WORK</span><span class="token expression"><span class="token punctuation">(</span>_work<span class="token punctuation">,</span> _func<span class="token punctuation">)</span>						</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">__INIT_WORK</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_work<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>_func<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span>
</code></pre> 
<h2><a id="python3windows_415"></a>python3在windows上的串口测试代码</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> threading
<span class="token keyword">from</span> time <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> re
<span class="token keyword">import</span> serial
<span class="token keyword">import</span> serial<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>list_ports

<span class="token comment">#扫描串口</span>
<span class="token keyword">def</span> <span class="token function">serial_scanf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    port_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>serial<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>list_ports<span class="token punctuation">.</span>comports<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>port_list<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'无可用串口'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>port_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>port_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">#打开串口</span>
<span class="token keyword">def</span> <span class="token function">serial_open</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> bps<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> ser
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        ser <span class="token operator">=</span> serial<span class="token punctuation">.</span>Serial<span class="token punctuation">(</span>port<span class="token punctuation">,</span> bps<span class="token punctuation">,</span> stopbits<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> bytesize<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ser
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> result<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Open serial {} failed"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token comment">#关闭串口</span>
<span class="token keyword">def</span> <span class="token function">serial_close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#发送数据</span>
<span class="token keyword">def</span> <span class="token function">serial_send</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">len</span> <span class="token operator">=</span> ser<span class="token punctuation">.</span>write<span class="token punctuation">(</span>buf<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token builtin">len</span> <span class="token operator">+=</span> ser<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">len</span>

<span class="token comment">#接收数据</span>
<span class="token keyword">def</span> <span class="token function">serial_recv</span><span class="token punctuation">(</span>expect <span class="token operator">=</span> <span class="token string">"OK"</span><span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response<span class="token operator">=</span><span class="token string">''</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> ser<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> data <span class="token operator">!=</span> <span class="token string">b''</span><span class="token punctuation">:</span>
            response <span class="token operator">+=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">"OK"</span><span class="token punctuation">,</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time <span class="token operator">&gt;</span> timeout <span class="token punctuation">:</span>
                <span class="token keyword">break</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token keyword">if</span> expect <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> response
    <span class="token keyword">if</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>expect<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    serial_scanf<span class="token punctuation">(</span><span class="token punctuation">)</span>
    serial_open<span class="token punctuation">(</span><span class="token string">"COM28"</span><span class="token punctuation">,</span> <span class="token number">115200</span><span class="token punctuation">)</span>
    serial_send<span class="token punctuation">(</span><span class="token string">"AT"</span><span class="token punctuation">)</span>
    <span class="token builtin">str</span> <span class="token operator">=</span> serial_recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c9997d33f6deaa8f61108d70e030b0e7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">WSL2 对外暴露端口</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a5829bf6c5f9ec551210bfd2ee1f7801/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue3 &#43; Element-UI 搭建一个后台管理系统框架模板</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>