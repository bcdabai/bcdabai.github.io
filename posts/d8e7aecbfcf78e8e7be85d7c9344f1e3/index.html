<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>线段树详解 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="线段树详解" />
<meta property="og:description" content="文章目录 1. 线段树概念2. 线段树的普通形式3. 线段树中的“懒操作”4. 线段树之动态开点 1. 线段树概念 线段树（segment tree）是一种基于分治思想的二叉树，它的每个节点都对应一个[L , R ]区间，叶子节点对应的区间L =R 。每一个非叶子节点[L , R ]其左子节点的区间都为[L , (L &#43;R )/2]，右子节点的区间都为[(L &#43;R )/2&#43;1, R ]。[1, 10]区间的线段树如下图所示
线段树的存储方式：
线段树除了最后一层，其他层构成一颗满二叉树，因此采用顺序存储方式，用一个数组tree[]存储节点。若一个节点的存储下标为k ，则其左子节点的下标为2k ，其右子节点的下标为2k &#43;1
注意：这里使用2k 2k&#43;1作为访问左右孩子，是有空间消耗的，一般而言只有一棵树是完全二叉才可以使用2k 2k&#43;1表示左右孩子，从下图中可以看到，区间[6,6]如果想要被2k进行访问，实际上区间[3,3] [4,4] [5,5]也需要创建相应的空叶子节点
简单来说，如果区间内的元素个数为 2 k 2^k 2k， 则构造出来的线段树是一棵完全二叉树，否则构造出来的树和上图一样，去掉最后一层后才是满二叉树，此时如果还需要利用完全二叉树的性质，就需要把最后一层不存在的叶子节点也创建出来
元素个数 n = 2 k n=2^k n=2k：
第0层 2 0 = 1 2^0=1 20=1
第1层 2 1 = 2 2^1=2 21=2
第2层 2 2 = 4. 2^2=4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/d8e7aecbfcf78e8e7be85d7c9344f1e3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-13T09:24:58+08:00" />
<meta property="article:modified_time" content="2022-07-13T09:24:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">线段树详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1__2" rel="nofollow">1. 线段树概念</a></li><li><a href="#2__46" rel="nofollow">2. 线段树的普通形式</a></li><li><a href="#3__202" rel="nofollow">3. 线段树中的“懒操作”</a></li><li><a href="#4__380" rel="nofollow">4. 线段树之动态开点</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__2"></a>1. 线段树概念</h2> 
<p>线段树（segment tree）是一种基于分治思想的二叉树，它的每个节点都对应一个[L , R ]区间，叶子节点对应的区间L =R 。每一个非叶子节点[L , R ]其左子节点的区间都为[L , (L +R )/2]，右子节点的区间都为[(L +R )/2+1, R ]。[1, 10]区间的线段树如下图所示<br> <img src="https://images2.imgbox.com/84/10/dGE4XtbQ_o.png" alt="在这里插入图片描述"></p> 
<p><font color="red">线段树的存储方式：</font><br> 线段树除了最后一层，其他层构成一颗满二叉树，因此采用顺序存储方式，用一个数组tree[]存储节点。若一个节点的存储下标为k ，则其左子节点的下标为2k ，其右子节点的下标为2k +1</p> 
<p>注意：这里使用2k 2k+1作为访问左右孩子，是有空间消耗的，一般而言只有一棵树是完全二叉才可以使用2k 2k+1表示左右孩子，从下图中可以看到，区间[6,6]如果想要被2k进行访问，实际上区间<code>[3,3] [4,4] [5,5]</code>也需要创建相应的空叶子节点<br> <img src="https://images2.imgbox.com/9a/6f/lNSF3ypi_o.png" alt="在这里插入图片描述"></p> 
<p>简单来说，如果区间内的元素个数为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          2 
         
        
          k 
         
        
       
      
        2^k 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.849108em; vertical-align: 0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span></span></span></span></span></span></span></span></span></span></span></span>， 则构造出来的线段树是一棵完全二叉树，否则构造出来的树和上图一样，去掉最后一层后才是满二叉树，此时如果还需要利用完全二叉树的性质，就需要把最后一层不存在的叶子节点也创建出来</p> 
<p><strong>元素个数<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          n 
         
        
          = 
         
         
         
           2 
          
         
           k 
          
         
        
       
         n=2^k 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.849108em; vertical-align: 0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span></span></span></span></span></span></span></span></span></span></span></span>：</strong><br> <img src="https://images2.imgbox.com/1c/e0/FwhKy4H2_o.png" alt="在这里插入图片描述"></p> 
<p>第0层<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          2 
         
        
          0 
         
        
       
         = 
        
       
         1 
        
       
      
        2^0=1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">1</span></span></span></span></span><br> 第1层 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          2 
         
        
          1 
         
        
       
         = 
        
       
         2 
        
       
      
        2^1=2 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">2</span></span></span></span></span><br> 第2层<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          2 
         
        
          2 
         
        
       
         = 
        
       
         4. 
        
       
      
        2^2=4. 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">4</span><span class="mord">.</span></span></span></span></span><br> …<br> 第k层<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          2 
         
        
          k 
         
        
       
      
        2^{k} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.849108em; vertical-align: 0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span></span></span></span></span></span></span></span></span></span></span></span></span><br> 总的结点数：<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         1 
        
       
         + 
        
       
         2 
        
       
         + 
        
       
         4 
        
       
         + 
        
       
         . 
        
       
         . 
        
       
         . 
        
       
         . 
        
       
         + 
        
        
        
          2 
         
        
          k 
         
        
       
         = 
        
        
        
          2 
         
         
         
           k 
          
         
           + 
          
         
           1 
          
         
        
       
         − 
        
       
         1 
        
       
      
        1+2+4+....+2^{k}=2^{k+1}-1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">4</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.66666em; vertical-align: -0.08333em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.849108em; vertical-align: 0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.932438em; vertical-align: -0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">1</span></span></span></span></span><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          2 
         
        
          k 
         
        
       
         = 
        
       
         n 
        
        
        
        
          2 
         
         
         
           k 
          
         
           + 
          
         
           1 
          
         
        
       
         = 
        
       
         2 
        
       
         n 
        
       
      
        2^{k}=n \quad 2^{k+1}=2n 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.849108em; vertical-align: 0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.849108em; vertical-align: 0em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 1em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">2</span><span class="mord mathdefault">n</span></span></span></span></span></p> 
<p>因此这种情况空间只需要2n</p> 
<p><strong>元素个数<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          n 
         
        
          ! 
         
        
          = 
         
         
         
           2 
          
         
           k 
          
         
        
       
         n!=2^k 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault">n</span><span class="mclose">!</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.849108em; vertical-align: 0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span></span></span></span></span></span></span></span></span></span></span></span>：</strong></p> 
<p><img src="https://images2.imgbox.com/f0/89/bLSaHHH7_o.png" alt="在这里插入图片描述"></p> 
<p>多出来的元素需要额外一层开来存储，此时结点数在前面的基础上加上最后一层(因为最后一层的最右边有子节点，因此最后一层需要加满节点保证完全二叉树的特性，实际区间节点+额外创建的节点)：<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          2 
         
         
         
           k 
          
         
           + 
          
         
           1 
          
         
        
       
         − 
        
       
         1 
        
       
         + 
        
        
        
          2 
         
         
         
           k 
          
         
           + 
          
         
           1 
          
         
        
       
         = 
        
       
         2 
        
       
         × 
        
        
        
          2 
         
         
         
           k 
          
         
           + 
          
         
           1 
          
         
        
       
         − 
        
       
         1 
        
       
      
        2^{k+1}-1+2^{k+1}=2 \times 2^{k+1}-1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.932438em; vertical-align: -0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.849108em; vertical-align: 0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.932438em; vertical-align: -0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">1</span></span></span></span></span> 其中<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         k 
        
       
         = 
        
       
         l 
        
       
         o 
        
       
         g 
        
       
         n 
        
       
      
        k=logn 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span style="margin-right: 0.03148em;" class="mord mathdefault">k</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span style="margin-right: 0.01968em;" class="mord mathdefault">l</span><span class="mord mathdefault">o</span><span style="margin-right: 0.03588em;" class="mord mathdefault">g</span><span class="mord mathdefault">n</span></span></span></span></span><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          2 
         
         
         
           k 
          
         
           + 
          
         
           1 
          
         
        
       
         = 
        
       
         4 
        
       
         n 
        
       
      
        2^{k+1}=4n 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.849108em; vertical-align: 0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.03148em;" class="mord mathdefault mtight">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">4</span><span class="mord mathdefault">n</span></span></span></span></span><br> 因此这种情况需要4n</p> 
<p><strong>综合上面两种情况，最坏情况需要4n;</strong></p> 
<p>图片来源：<a href="https://blog.csdn.net/mmww1994/article/details/104206072/">https://blog.csdn.net/mmww1994/article/details/104206072/</a></p> 
<hr> 
<h2><a id="2__46"></a>2. 线段树的普通形式</h2> 
<p><strong>1. 创建线段树</strong></p> 
<p>采用递归的方法创建线段树，算法步骤如下：</p> 
<ul><li>若是叶子节点（l =r ），则节点的最值就是对应位置的元素值</li><li>若是非叶子节点，则递归创建左子树和右子树</li><li>节点的区间最值等于该节点左右子树最值的最大值</li><li>节点的区间和等于该节点左右子树区间和的相加</li></ul> 
<p><strong>2. 区间查询</strong></p> 
<p>区间查询指查询一个[l , r ]区间的最值或区间和。采用递归的方法进行区间查询的算法步骤如下：</p> 
<ul><li>若节点所在的区间被查询区间[l , r ]覆盖，则返回该节点的最值或区间和</li><li>判断是在左子树中查询，还是在右子树中查询</li><li>返回最值或区间和</li></ul> 
<p><strong>3. 点更新</strong><br> 点更新指修改一个元素的值，例如将a [i ]修改为v 。采用递归进行点更新，算法步骤如下：</p> 
<ul><li>若i属于当前节点所在区间，更新当前节点区间的最值和区间和</li><li>若是非叶子节点，则判断是在左子树中更新还是在右子树中更新，是叶子节点，更新完毕，返回</li></ul> 
<p><img src="https://images2.imgbox.com/f6/0d/HbVR6I9a_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">algorithm</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SegmentTree</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> sz<span class="token punctuation">;</span><span class="token comment">//需要创建的tree数组大小</span>
	<span class="token keyword">int</span> n<span class="token punctuation">;</span><span class="token comment">//区间长度</span>
	<span class="token class-name">Node</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tree<span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token class-name">SegmentTree</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>n<span class="token operator">=</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>arr<span class="token operator">=</span>arr<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>tree<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">*</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>tree<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			tree<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">build</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/*
	 * 创建线段树 节点存储下标为k 节点区间为[left,right]
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span><span class="token keyword">int</span> left<span class="token punctuation">,</span><span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">=</span>left<span class="token punctuation">;</span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token operator">=</span>right<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>left<span class="token operator">==</span>right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token operator">=</span>arr<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token operator">=</span>arr<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">int</span> mid<span class="token operator">=</span>left<span class="token operator">+</span><span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//划分点</span>
		<span class="token keyword">int</span> lChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//左子节点存储下标</span>
		<span class="token keyword">int</span> rChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//右子节点存储下标</span>
		<span class="token function">build</span><span class="token punctuation">(</span>lChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">build</span><span class="token punctuation">(</span>rChild<span class="token punctuation">,</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//更新节点k最大值</span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>lChild<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">,</span>tree<span class="token punctuation">[</span>rChild<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//更新节点k区间和</span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token operator">=</span>tree<span class="token punctuation">[</span>lChild<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token operator">+</span>tree<span class="token punctuation">[</span>rChild<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/*
	 * 更新arr[i]=val
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateTree</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span><span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">==</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token operator">&amp;&amp;</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">==</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token operator">=</span>val<span class="token punctuation">;</span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token operator">=</span>val<span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">int</span> mid<span class="token operator">=</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">+</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//划分点</span>
		<span class="token keyword">int</span> lChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//左子节点存储下标</span>
		<span class="token keyword">int</span> rChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//右子节点存储下标</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;=</span>mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">updateTree</span><span class="token punctuation">(</span>lChild<span class="token punctuation">,</span> i<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//到左子树更新</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">updateTree</span><span class="token punctuation">(</span>rChild<span class="token punctuation">,</span> i<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//到右子树更新</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//更新节点k最大值</span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>lChild<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">,</span>tree<span class="token punctuation">[</span>rChild<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//更新节点k区间和</span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token operator">=</span>tree<span class="token punctuation">[</span>lChild<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token operator">+</span>tree<span class="token punctuation">[</span>rChild<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/*
	 * 求区间[left,right]中的最大值
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">queryMax</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span><span class="token keyword">int</span> left<span class="token punctuation">,</span><span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//查询区间覆盖该节点区间</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">&gt;=</span>left<span class="token operator">&amp;&amp;</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token operator">&lt;=</span>right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">int</span> mid<span class="token operator">=</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">+</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//划分点</span>
		<span class="token keyword">int</span> lChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//左子节点存储下标</span>
		<span class="token keyword">int</span> rChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//右子节点存储下标</span>
		<span class="token keyword">int</span> maxVal<span class="token operator">=</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>left<span class="token operator">&lt;=</span>mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			maxVal<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxVal<span class="token punctuation">,</span><span class="token function">queryMax</span><span class="token punctuation">(</span>lChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>right<span class="token operator">&gt;</span>mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			maxVal<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxVal<span class="token punctuation">,</span><span class="token function">queryMax</span><span class="token punctuation">(</span>rChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> maxVal<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/*
	 * 求区间[left,right]元素和
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">querySum</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span><span class="token keyword">int</span> left<span class="token punctuation">,</span><span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//查询区间覆盖该节点区间</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">&gt;=</span>left<span class="token operator">&amp;&amp;</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token operator">&lt;=</span>right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">int</span> mid<span class="token operator">=</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">+</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//划分点</span>
		<span class="token keyword">int</span> lChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//左子节点存储下标</span>
		<span class="token keyword">int</span> rChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//右子节点存储下标</span>
		<span class="token keyword">int</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>left<span class="token operator">&lt;=</span>mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			sum<span class="token operator">+=</span><span class="token function">querySum</span><span class="token punctuation">(</span>lChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>right<span class="token operator">&gt;</span>mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			sum<span class="token operator">+=</span><span class="token function">querySum</span><span class="token punctuation">(</span>rChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> sum<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
		
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token class-name">SegmentTree</span> sTree<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SegmentTree</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span><span class="token function">queryMax</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span><span class="token function">querySum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span>tree<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
		sTree<span class="token punctuation">.</span><span class="token function">updateTree</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span><span class="token function">queryMax</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span><span class="token function">querySum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span>tree<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> left<span class="token punctuation">,</span>right<span class="token punctuation">;</span><span class="token comment">//左右孩子编号 2k+1 2k+2 因为从0开始编号</span>
	<span class="token keyword">int</span> sum<span class="token punctuation">;</span><span class="token comment">//区间和</span>
	<span class="token keyword">int</span> max<span class="token punctuation">;</span><span class="token comment">//区间最大值</span>
	
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h2><a id="3__202"></a>3. 线段树中的“懒操作”</h2> 
<p>若对区间的每个点都进行更新，则时间复杂度较高，可以引入懒操作，此时的更新算法如下：</p> 
<p><strong>区间更新</strong></p> 
<ul><li>若当前节点的区间被查询区间[l , r ]覆盖，则仅对该节点进行更新并做懒标记，表示该节点已被更新，对该节点的子节点<strong>暂不更新</strong></li><li>判断是在左子树中查询还是在右子树中查询。在查询过程中，若当前节点带有懒标记，则将懒标记下传给子节点（将当前节点的懒标记清除，将子节点更新并做懒标记），继续查询</li><li>在返回时更新最值</li></ul> 
<p><strong>区间查询</strong></p> 
<ul><li>在查询过程中若遇到节点有懒标记，则下传懒标记，继续查询</li></ul> 
<p>代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">algorithm</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SegmentTree</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> sz<span class="token punctuation">;</span><span class="token comment">//需要创建的tree数组大小</span>
	<span class="token keyword">int</span> n<span class="token punctuation">;</span><span class="token comment">//区间长度</span>
	<span class="token class-name">Node</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tree<span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token class-name">SegmentTree</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>n<span class="token operator">=</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>arr<span class="token operator">=</span>arr<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>tree<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">*</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>tree<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			tree<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">build</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/*
	 * 创建线段树 节点存储下标为k 节点区间为[left,right]
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span><span class="token keyword">int</span> left<span class="token punctuation">,</span><span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">=</span>left<span class="token punctuation">;</span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token operator">=</span>right<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>left<span class="token operator">==</span>right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token operator">=</span>arr<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token operator">=</span>arr<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">int</span> mid<span class="token operator">=</span>left<span class="token operator">+</span><span class="token punctuation">(</span>right<span class="token operator">-</span>left<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//划分点</span>
		<span class="token keyword">int</span> lChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//左子节点存储下标</span>
		<span class="token keyword">int</span> rChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//右子节点存储下标</span>
		<span class="token function">build</span><span class="token punctuation">(</span>lChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">build</span><span class="token punctuation">(</span>rChild<span class="token punctuation">,</span> mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//更新节点k最大值</span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>lChild<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">,</span>tree<span class="token punctuation">[</span>rChild<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//更新节点k区间和</span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token operator">=</span>tree<span class="token punctuation">[</span>lChild<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token operator">+</span>tree<span class="token punctuation">[</span>rChild<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/*
	 * 将区间[left,right]中的元素都加上delta
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateTree</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span><span class="token keyword">int</span> right<span class="token punctuation">,</span><span class="token keyword">int</span> delta<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//区间覆盖 递归结束 此时更新该区间节点的delta max sum</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">&gt;=</span>left<span class="token operator">&amp;&amp;</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token operator">&lt;=</span>right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token operator">+=</span>delta<span class="token punctuation">;</span><span class="token comment">//delta是累加</span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token operator">+=</span>delta<span class="token punctuation">;</span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token operator">+=</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token operator">-</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>delta<span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">pushDown</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">int</span> mid<span class="token operator">=</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">+</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//划分点</span>
		<span class="token keyword">int</span> lChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//左子节点存储下标</span>
		<span class="token keyword">int</span> rChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//右子节点存储下标</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>left<span class="token operator">&lt;=</span>mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">updateTree</span><span class="token punctuation">(</span>lChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span>right<span class="token punctuation">,</span> delta<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//到左子树更新</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>right<span class="token operator">&gt;</span>mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">updateTree</span><span class="token punctuation">(</span>rChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span>right<span class="token punctuation">,</span> delta<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//到右子树更新</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//更新节点k最大值</span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>lChild<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">,</span>tree<span class="token punctuation">[</span>rChild<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//更新节点k区间和</span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token operator">=</span>tree<span class="token punctuation">[</span>lChild<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token operator">+</span>tree<span class="token punctuation">[</span>rChild<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/*
	 * 求区间[left,right]中的最大值
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">queryMax</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span><span class="token keyword">int</span> left<span class="token punctuation">,</span><span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//查询区间覆盖该节点区间</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">&gt;=</span>left<span class="token operator">&amp;&amp;</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token operator">&lt;=</span>right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">pushDown</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//懒标记下传</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">int</span> mid<span class="token operator">=</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">+</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//划分点</span>
		<span class="token keyword">int</span> lChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//左子节点存储下标</span>
		<span class="token keyword">int</span> rChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//右子节点存储下标</span>
		<span class="token keyword">int</span> maxVal<span class="token operator">=</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>left<span class="token operator">&lt;=</span>mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			maxVal<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxVal<span class="token punctuation">,</span><span class="token function">queryMax</span><span class="token punctuation">(</span>lChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>right<span class="token operator">&gt;</span>mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			maxVal<span class="token operator">=</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxVal<span class="token punctuation">,</span><span class="token function">queryMax</span><span class="token punctuation">(</span>rChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> maxVal<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/*
	 * 求区间[left,right]元素和
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">querySum</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span><span class="token keyword">int</span> left<span class="token punctuation">,</span><span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//查询区间覆盖该节点区间</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">&gt;=</span>left<span class="token operator">&amp;&amp;</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token operator">&lt;=</span>right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">pushDown</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//懒标记下传</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">int</span> mid<span class="token operator">=</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token operator">+</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//划分点</span>
		<span class="token keyword">int</span> lChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//左子节点存储下标</span>
		<span class="token keyword">int</span> rChild<span class="token operator">=</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//右子节点存储下标</span>
		<span class="token keyword">int</span> sum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>left<span class="token operator">&lt;=</span>mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			sum<span class="token operator">+=</span><span class="token function">querySum</span><span class="token punctuation">(</span>lChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>right<span class="token operator">&gt;</span>mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			sum<span class="token operator">+=</span><span class="token function">querySum</span><span class="token punctuation">(</span>rChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> sum<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">/*
	 * 向子节点传递懒标记
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pushDown</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Node</span> root<span class="token operator">=</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token class-name">Node</span> lChild<span class="token operator">=</span>tree<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token class-name">Node</span> rChild<span class="token operator">=</span>tree<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> delta<span class="token operator">=</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">;</span>
		lChild<span class="token punctuation">.</span>delta<span class="token operator">+=</span>root<span class="token punctuation">.</span>delta<span class="token punctuation">;</span>
		lChild<span class="token punctuation">.</span>sum<span class="token operator">+=</span><span class="token punctuation">(</span>lChild<span class="token punctuation">.</span>right<span class="token operator">-</span>lChild<span class="token punctuation">.</span>left<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>delta<span class="token punctuation">;</span>
		lChild<span class="token punctuation">.</span>max<span class="token operator">+=</span>delta<span class="token punctuation">;</span>
		root<span class="token punctuation">.</span>delta<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token class-name">SegmentTree</span> sTree<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SegmentTree</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"修改前："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span><span class="token function">queryMax</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span><span class="token function">querySum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span>tree<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
		sTree<span class="token punctuation">.</span><span class="token function">updateTree</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//区间0-9中的所有元素加上3</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"修改后："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span><span class="token function">queryMax</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span><span class="token function">querySum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span>tree<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
		sTree<span class="token punctuation">.</span><span class="token function">updateTree</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//区间0-9中的所有元素加上4</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"修改后："</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span><span class="token function">queryMax</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span><span class="token function">querySum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sTree<span class="token punctuation">.</span>tree<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> left<span class="token punctuation">,</span>right<span class="token punctuation">;</span><span class="token comment">//左右孩子编号 2k+1 2k+2 因为从0开始编号</span>
	<span class="token keyword">int</span> sum<span class="token punctuation">;</span><span class="token comment">//区间和</span>
	<span class="token keyword">int</span> max<span class="token punctuation">;</span><span class="token comment">//区间最大值</span>
	<span class="token keyword">int</span> delta<span class="token punctuation">;</span><span class="token comment">//懒标记 表示加上过的值 变化量</span>
	
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>总结：</strong></p> 
<p>在没有设置懒标记之前，即使区间覆盖也还是需要更新该区间的子节点，直到遇到区间长度为1的节点，设置懒标记之后，只需要更新区间覆盖的节点，其子节点延迟更新；当需要访问的时候再将懒惰标记下移，继续查询。</p> 
<hr> 
<h2><a id="4__380"></a>4. 线段树之动态开点</h2> 
<p>当区间范围比较大时，比如<code>[1,1e9]</code>, 此时如果再开4倍空间可能会导致内存溢出，但是实际上我们并不需要建=建立一棵完整的线段树，先只建立一个根节点代表整个区间，然后当需要访问的时候再去创建相应的节点，没有访问到的区间就不为其创建相应的节点，如果我们是按照连续段进行查询或插入，最坏情况下仍然会占到4n的空间。<strong>每一个节点的左右儿子不是该点编号的两倍和两倍加一，而是现加出来的，比如之前节点k的左子节点为2*k+1, 在动态开点的创建方式中，节点k的左子节点为k+1</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">algorithm</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SegmentTree</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> sz<span class="token punctuation">;</span><span class="token comment">// 需要创建的tree数组大小</span>
	<span class="token keyword">int</span> n<span class="token punctuation">;</span><span class="token comment">// 区间长度</span>
	<span class="token class-name">Node</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tree<span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">;</span>
	<span class="token comment">//N M的值尽量大</span>
	<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token class-name">N</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token number">1e9</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//N代表值域大小</span>
	<span class="token keyword">int</span> <span class="token class-name">M</span> <span class="token operator">=</span> <span class="token number">500010</span><span class="token punctuation">,</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//M代表查询次数 查询一次最多创建3个节点</span>

	<span class="token keyword">public</span> <span class="token class-name">SegmentTree</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>n <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>arr <span class="token operator">=</span> arr<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>tree <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">[</span><span class="token class-name">M</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*
	 * 创建线段树 只创建一个根节点 其他的节点延迟创建
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		tree<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		tree<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		tree<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		tree<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>delta <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*
	 * 将区间[left,right]中的元素都加上delta
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateTree</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">int</span> lChild<span class="token punctuation">,</span> <span class="token keyword">int</span> rChild<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> delta<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;=</span> lChild <span class="token operator">&amp;&amp;</span> rChild <span class="token operator">&lt;=</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 区间覆盖 更新当前区间的区间和和最大值</span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>rChild <span class="token operator">-</span> lChild <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> delta<span class="token punctuation">;</span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>max <span class="token operator">+=</span> delta<span class="token punctuation">;</span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta <span class="token operator">+=</span> delta<span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">lazyCreate</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 延迟创建节点k</span>
		<span class="token function">pushDown</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> rChild <span class="token operator">-</span> lChild <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 懒标记下移</span>
		<span class="token keyword">int</span> mid <span class="token operator">=</span> lChild <span class="token operator">+</span> <span class="token punctuation">(</span>rChild <span class="token operator">-</span> lChild<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">updateTree</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token punctuation">,</span> lChild<span class="token punctuation">,</span> mid<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> delta<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 更新左子树</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>right <span class="token operator">&gt;</span> mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">updateTree</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">,</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> rChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> delta<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 更新右子树</span>
		<span class="token punctuation">}</span>
		<span class="token function">pushUp</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 更新区间节点k的sum和max</span>

	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lazyCreate</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 编号为k的节点没有被创建</span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 左子节点没有被创建</span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token operator">++</span>cnt<span class="token punctuation">;</span><span class="token comment">// 左子节点编号</span>
			tree<span class="token punctuation">[</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token operator">++</span>cnt<span class="token punctuation">;</span><span class="token comment">// 右子节点编号</span>
			tree<span class="token punctuation">[</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pushDown</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// delta=0不要进行懒标记下移</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 对区间进行加」的更新操作，下推懒惰标记时需要累加起来，不能直接覆盖</span>
		tree<span class="token punctuation">[</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token punctuation">]</span><span class="token punctuation">.</span>delta <span class="token operator">+=</span> tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">;</span>
		tree<span class="token punctuation">[</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">]</span><span class="token punctuation">.</span>delta <span class="token operator">+=</span> tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">;</span>
		tree<span class="token punctuation">[</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> len <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">;</span>
		tree<span class="token punctuation">[</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">+=</span> <span class="token punctuation">(</span>len <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">;</span>
		tree<span class="token punctuation">[</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token punctuation">]</span><span class="token punctuation">.</span>max <span class="token operator">+=</span> tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">;</span>
		tree<span class="token punctuation">[</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">]</span><span class="token punctuation">.</span>max <span class="token operator">+=</span> tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">;</span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>delta <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 父节点k的懒标记清除</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*
	 * 更新节点k的sum和max
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pushUp</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">=</span> tree<span class="token punctuation">[</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token punctuation">]</span><span class="token punctuation">.</span>sum <span class="token operator">+</span> tree<span class="token punctuation">[</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">;</span>
		tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>max <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">,</span> tree<span class="token punctuation">[</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*
	 * 求区间[left,right]中的最大值
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">queryMax</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">int</span> lChild<span class="token punctuation">,</span> <span class="token keyword">int</span> rChild<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;=</span> lChild <span class="token operator">&amp;&amp;</span> rChild <span class="token operator">&lt;=</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>max<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">lazyCreate</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pushDown</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> rChild <span class="token operator">-</span> lChild <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> mid <span class="token operator">=</span> lChild <span class="token operator">+</span> <span class="token punctuation">(</span>rChild <span class="token operator">-</span> lChild<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> maxVal <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			maxVal <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxVal<span class="token punctuation">,</span> <span class="token function">queryMax</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token punctuation">,</span> lChild<span class="token punctuation">,</span> mid<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>right <span class="token operator">&gt;</span> mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			maxVal <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxVal<span class="token punctuation">,</span> <span class="token function">queryMax</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">,</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> rChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> maxVal<span class="token punctuation">;</span>

	<span class="token punctuation">}</span>

	<span class="token comment">/*
	 * 求区间[left,right]元素和
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">querySum</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">int</span> lChild<span class="token punctuation">,</span> <span class="token keyword">int</span> rChild<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;=</span> lChild <span class="token operator">&amp;&amp;</span> rChild <span class="token operator">&lt;=</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>sum<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">lazyCreate</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">pushDown</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> rChild <span class="token operator">-</span> lChild <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> mid <span class="token operator">=</span> lChild <span class="token operator">+</span> <span class="token punctuation">(</span>rChild <span class="token operator">-</span> lChild<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			sum <span class="token operator">+=</span> <span class="token function">querySum</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>left<span class="token punctuation">,</span> lChild<span class="token punctuation">,</span> mid<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>right <span class="token operator">&gt;</span> mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			sum <span class="token operator">+=</span> <span class="token function">querySum</span><span class="token punctuation">(</span>tree<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>right<span class="token punctuation">,</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> rChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> sum<span class="token punctuation">;</span>

	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token class-name">SegmentTree</span> sTree <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SegmentTree</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 更新和查询时设置区间[lChild,rChild] 不被区间[left,right] 覆盖 否则无法延迟创建节点 导致空指针异常</span>
		<span class="token comment">// N是一个比较大的值</span>
		sTree<span class="token punctuation">.</span><span class="token function">updateTree</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 区间[1,9]值为5</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"区间和查询:"</span> <span class="token operator">+</span> sTree<span class="token punctuation">.</span><span class="token function">querySum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// [1,9]区间和为45</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"最大值查询:"</span> <span class="token operator">+</span> sTree<span class="token punctuation">.</span><span class="token function">queryMax</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// [1,9]区间最大值为5</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		sTree<span class="token punctuation">.</span><span class="token function">updateTree</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// [0,3]区间+15--&gt;15 20 20 20 5 5 5 5 5 5</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"区间和查询:"</span> <span class="token operator">+</span> sTree<span class="token punctuation">.</span><span class="token function">querySum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// [1,9]区间和为90</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"最大值查询:"</span> <span class="token operator">+</span> sTree<span class="token punctuation">.</span><span class="token function">queryMax</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">N</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// [1,9]区间最大值为20</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> left<span class="token punctuation">,</span> right<span class="token punctuation">;</span><span class="token comment">// 左右孩子编号 2k+1 2k+2 因为从0开始编号</span>
	<span class="token keyword">int</span> sum<span class="token punctuation">;</span><span class="token comment">// 区间和</span>
	<span class="token keyword">int</span> max<span class="token punctuation">;</span><span class="token comment">// 区间最大值</span>
	<span class="token keyword">int</span> delta<span class="token punctuation">;</span><span class="token comment">// 懒标记 表示加上过的值 变化量</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>再贴一个动态开点的指针做法，即不提前创建tree[]数组，<a href="https://leetcode.cn/problems/my-calendar-i/solution/by-jiang-hui-4-pyfn/" rel="nofollow">参考代码出处</a></p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * 线段树的结点
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//左范围</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> left<span class="token punctuation">;</span>
        <span class="token comment">//右范围</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> right<span class="token punctuation">;</span>
        <span class="token comment">//区间和</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>
        <span class="token comment">//懒标记</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> lazy<span class="token punctuation">;</span>
        <span class="token comment">//左子树和右子树</span>
        <span class="token class-name">Node</span> leftChild<span class="token punctuation">,</span> rightChild<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token keyword">int</span> leftX<span class="token punctuation">,</span> <span class="token keyword">int</span> rightX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> leftX<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> rightX<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Node</span> root<span class="token punctuation">;</span>


    <span class="token comment">/**
     * 区间更新
     *
     * @param root  树的根
     * @param left  左边界
     * @param right 有边界
     * @param value 更新值
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Node</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//不在范围内 直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>left <span class="token operator">&gt;</span> right <span class="token operator">||</span> root<span class="token punctuation">.</span>right <span class="token operator">&lt;</span> left<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//修改的区间包含当前结点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>left <span class="token operator">&gt;=</span> left <span class="token operator">&amp;&amp;</span> root<span class="token punctuation">.</span>right <span class="token operator">&lt;=</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            root<span class="token punctuation">.</span>lazy <span class="token operator">=</span> value<span class="token punctuation">;</span>
            root<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>right <span class="token operator">-</span> root<span class="token punctuation">.</span>left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//动态开点</span>
            <span class="token function">lazyCreate</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//下传lazy</span>
            <span class="token function">pushDown</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//更新左子树</span>
            <span class="token function">update</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>leftChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//更新右子树</span>
            <span class="token function">update</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>rightChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//上传结果</span>
            <span class="token function">pushUp</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">Node</span> root<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;=</span> root<span class="token punctuation">.</span>left <span class="token operator">&amp;&amp;</span> root<span class="token punctuation">.</span>right <span class="token operator">&lt;=</span> right<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> root<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">lazyCreate</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pushDown</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> mid <span class="token operator">=</span> root<span class="token punctuation">.</span>left <span class="token operator">+</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>right <span class="token operator">-</span> root<span class="token punctuation">.</span>left<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>right <span class="token operator">&lt;=</span> mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">query</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>leftChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&gt;</span> mid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">query</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>rightChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">query</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>leftChild<span class="token punctuation">,</span> left<span class="token punctuation">,</span> mid<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">query</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>rightChild<span class="token punctuation">,</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 创建左右子树
     *
     * @param root
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lazyCreate</span><span class="token punctuation">(</span><span class="token class-name">Node</span> root<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>leftChild <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            root<span class="token punctuation">.</span>leftChild <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">,</span> root<span class="token punctuation">.</span>left <span class="token operator">+</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>right <span class="token operator">-</span> root<span class="token punctuation">.</span>left<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>rightChild <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            root<span class="token punctuation">.</span>rightChild <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left <span class="token operator">+</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>right <span class="token operator">-</span> root<span class="token punctuation">.</span>left<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 下传lazy
     *
     * @param root
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pushDown</span><span class="token punctuation">(</span><span class="token class-name">Node</span> root<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>lazy <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> value <span class="token operator">=</span> root<span class="token punctuation">.</span>lazy<span class="token punctuation">;</span>
        root<span class="token punctuation">.</span>leftChild<span class="token punctuation">.</span>lazy <span class="token operator">=</span> value<span class="token punctuation">;</span>
        root<span class="token punctuation">.</span>rightChild<span class="token punctuation">.</span>lazy <span class="token operator">=</span> value<span class="token punctuation">;</span>
        root<span class="token punctuation">.</span>leftChild<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>leftChild<span class="token punctuation">.</span>right <span class="token operator">-</span> root<span class="token punctuation">.</span>leftChild<span class="token punctuation">.</span>left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> value<span class="token punctuation">;</span>
        root<span class="token punctuation">.</span>rightChild<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>rightChild<span class="token punctuation">.</span>right <span class="token operator">-</span> root<span class="token punctuation">.</span>rightChild<span class="token punctuation">.</span>left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> value<span class="token punctuation">;</span>
        root<span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 上传结果
     *
     * @param root
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pushUp</span><span class="token punctuation">(</span><span class="token class-name">Node</span> root<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        root<span class="token punctuation">.</span>value <span class="token operator">=</span> root<span class="token punctuation">.</span>leftChild<span class="token punctuation">.</span>value <span class="token operator">+</span> root<span class="token punctuation">.</span>rightChild<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">MyCalendar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token number">1e9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">book</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> query <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>query <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">update</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/77b0dc6924f57d86ee5c21e32b7e9a8b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">牛客网刷题记录 || 第一番</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a4895190dc14bc49a4517be0f5c9c69d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【JS】url传参中文乱码的解决方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>