<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql数据库连接池python - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql数据库连接池python" />
<meta property="og:description" content="1. DBUtils 官方文档还是11年的，但还是非常简单好用。主要使用其中的PersistentDB 和 PooledDB两个模块。
1. PersistentDB 每当线程第一次打开数据库连接时，PersistentDB将建立一个与该数据库的新连接，该连接将始终用于此特定线程，不能被其他线程使用。当该线程调用close()后，该连接回到线程池，静静的等待这个线程再次调用它（其他线程无法使用这个连接）。该连接最终随该线程死亡而真正关闭。
2. PooledDB @singleton class TlcfDBconPool(object): def __init__(self): db_conf_dict = InternalCFG().get_datayesdb_conf self.pool = PersistentDB.PersistentDB(creator=MySQLdb, maxusage=5,host=db_conf_dict[&#39;host&#39;], user=db_conf_dict[&#39;user&#39;], passwd=db_conf_dict[&#39;passwd&#39;],db=db_conf_dict[&#39;db&#39;], port=db_conf_dict[&#39;port&#39;]) def get_db_connection(self): return self.pool.connection() 2. SqlAlchemy中的连接池 作为高级的ORM工具，SqlAlchemy本身就有连接池的
首先engine.connect()返回的是Connection object.
Return a new Connection object.
The Connection object is a facade that uses a DBAPI connection internally in order to communicate with the database. This connection is procured from the connection-holding Pool referenced by this Engine." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5a8d4f64e47c41887d3777382742c43e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-24T16:20:09+08:00" />
<meta property="article:modified_time" content="2021-06-24T16:20:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql数据库连接池python</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1_DBUtils_0"></a>1. DBUtils</h3> 
<p><a href="https://cito.github.io/w4py-olde-docs/Webware/DBUtils/Docs/UsersGuide.html" rel="nofollow">官方文档</a>还是11年的，但还是非常简单好用。主要使用其中的PersistentDB 和 PooledDB两个模块。</p> 
<h4><a id="1__PersistentDB_4"></a>1. PersistentDB</h4> 
<p>每当线程第一次打开数据库连接时，PersistentDB将建立一个与该数据库的新连接，该连接将始终用于此特定线程，不能被其他线程使用。当该线程调用close()后，该连接回到线程池，静静的等待这个线程再次调用它（其他线程无法使用这个连接）。该连接最终随该线程死亡而真正关闭。</p> 
<h4><a id="2_PooledDB_7"></a>2. PooledDB</h4> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@singleton</span>
<span class="token keyword">class</span> <span class="token class-name">TlcfDBconPool</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        db_conf_dict <span class="token operator">=</span> InternalCFG<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_datayesdb_conf
        self<span class="token punctuation">.</span>pool <span class="token operator">=</span> PersistentDB<span class="token punctuation">.</span>PersistentDB<span class="token punctuation">(</span>creator<span class="token operator">=</span>MySQLdb<span class="token punctuation">,</span> maxusage<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>host<span class="token operator">=</span>db_conf_dict<span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> user<span class="token operator">=</span>db_conf_dict<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> passwd<span class="token operator">=</span>db_conf_dict<span class="token punctuation">[</span><span class="token string">'passwd'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>db<span class="token operator">=</span>db_conf_dict<span class="token punctuation">[</span><span class="token string">'db'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> port<span class="token operator">=</span>db_conf_dict<span class="token punctuation">[</span><span class="token string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_db_connection</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>connection<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="2_SqlAlchemy_22"></a>2. SqlAlchemy中的连接池</h3> 
<p>作为高级的ORM工具，SqlAlchemy本身就有连接池的</p> 
<p>首先engine.connect()返回的是Connection object.</p> 
<blockquote> 
 <p>Return a new Connection object.</p> 
</blockquote> 
<blockquote> 
 <p>The Connection object is a facade that uses a DBAPI connection internally in order to communicate with the database. This connection is procured from the connection-holding Pool referenced by this Engine. When the close() method of the Connection object is called, the underlying DBAPI connection is then returned to the connection pool, where it may be used again in a subsequent call to connect().</p> 
</blockquote> 
<p>engine.raw_connection()返回的是 Raw DBAPI Connections，但是这个依然不是我想要的东西，因为我在代码中依然发现这个connection是“proxied”的,每次返回的object的id都不一样</p> 
<p>The name “fairy” is inspired by the fact that the _ConnectionFairy object’s lifespan is transitory, as it lasts only for the length of a specific DBAPI connection being checked out from the pool, and additionally that as a transparent proxy, it is mostly invisible.</p> 
<pre><code class="prism language-python">engine <span class="token operator">=</span> DBConnectionFactory<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_db_connection<span class="token punctuation">(</span><span class="token string">'db'</span><span class="token punctuation">)</span>
conn <span class="token operator">=</span> engine<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> conn<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>thread_id<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token builtin">id</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
sql <span class="token operator">=</span> <span class="token string">"select * from mytable where trade_date={2}"</span>
dat <span class="token operator">=</span> read_db<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> sql<span class="token punctuation">)</span>
dat<span class="token punctuation">.</span>columns <span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'ID'</span><span class="token punctuation">,</span> <span class="token string">'factor'</span><span class="token punctuation">]</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8304c6ed066ed1184bffa03bb6580bb7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">flask&#43;pyecharts显示中国省份地图出现的问题1</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e2a40a5d47e2c0c86b153c64e108ecf2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">找不到libstdc&#43;&#43;.so.5问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>