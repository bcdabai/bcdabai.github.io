<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用 Nginx Ingress 快速实现 URL 重写 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用 Nginx Ingress 快速实现 URL 重写" />
<meta property="og:description" content="什么是URL重写 URL重写（URL rewriting）是一种在Web服务器上修改或转换请求URL的过程。它通常涉及使用服务器配置或规则来更改传入的URL，以便在不改变实际请求资源的情况下，实现不同的行为，如重定向、路径映射、参数处理等。
URL重写在服务器层面进行，因此客户端（如浏览器）对于URL的请求不会感知到这些更改，但服务器会根据配置进行适当的处理。URL重写可以用于多种目的，例如：
重定向: 将一个URL重写为另一个URL，实现301永久重定向或302临时重定向。这可以用于更改站点结构、修复错误的URL、实现SEO优化等。
路径映射: 将一个URL的路径映射到另一个位置，这对于隐藏实际文件路径或路径重组很有用。
查询参数处理: 在URL中添加、删除或修改查询参数，以适应不同的应用需求。
动态URL到静态URL: 将动态生成的URL（带有参数）转化为静态URL，更友好且易于索引。
隐藏技术细节: 可以通过URL重写隐藏后端服务器或应用程序的实际技术细节，提高安全性。
在Nginx、Apache等常见的Web服务器中，URL重写可以通过正则表达式、规则匹配等方式来实现。具体的语法和方法会因服务器软件的不同而有所不同。通常，服务器配置文件中会有专门的部分用于配置URL重写规则，例如在Nginx中是使用rewrite指令。URL重写是一种强大的技术，但在使用时需要小心，确保配置正确以避免潜在的问题，例如无限循环重定向或错误的重写规则可能导致网站不可用。
Ingress 内置变量 内置预定义变量即无需声明就可以使用的变量，通常包括一个http请求或响应中一部分内容的值，以下为一些常用的内置预定义变量：
变量名 定义
$arg_PARAMETER GET请求中变量名PARAMETER参数的值。
$args 这个变量等于GET请求中的参数。例如，foo=123&amp;bar=blahblah;这个变量只可以被修改
$binary_remote_addr 二进制码形式的客户端地址。
$body_bytes_sent 传送页面的字节数
$content_length 请求头中的Content-length字段。
$content_type 请求头中的Content-Type字段。
$cookie_COOKIE cookie COOKIE的值。
$document_root 当前请求在root指令中指定的值。
$document_uri 与$uri相同。
$host 请求中的主机头(Host)字段，如果请求中的主机头不可用或者空，则为处理请求的server名称(处理请求的server的server_name指令的值)。值为小写，不包含端口。
$hostname 机器名使用 gethostname系统调用的值
$http_HEADER HTTP请求头中的内容，HEADER为HTTP请求中的内容转为小写，-变为_(破折号变为下划线)，例如：$http_user_agent(Uaer-Agent的值);
$http_user_agent ： 客户端agent信息;
$http_cookie ： 客户端cookie信息;
$sent_http_HEADER HTTP响应头中的内容，HEADER为HTTP响应中的内容转为小写，-变为_(破折号变为下划线)，例如： $sent_http_cache_control, $sent_http_content_type…;
$is_args 如果$args设置，值为&#34;?&#34;，否则为&#34;&#34;。
$limit_rate 这个变量可以限制连接速率。
$nginx_version 当前运行的nginx版本号。
$query_string 与$args相同。
$remote_addr 客户端的IP地址。
$remote_port 客户端的端口。
$remote_user 已经经过Auth Basic Module验证的用户名。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4006a1f5b01f444ae1c8ae20207fa218/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-29T10:08:59+08:00" />
<meta property="article:modified_time" content="2023-11-29T10:08:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用 Nginx Ingress 快速实现 URL 重写</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><img alt="" height="608" src="https://images2.imgbox.com/34/e0/dNhlwwwA_o.png" width="1080"></p> 
<h4>什么是URL重写</h4> 
<p>URL重写（URL rewriting）是一种在<a href="https://so.csdn.net/so/search?q=Web%E6%9C%8D%E5%8A%A1%E5%99%A8&amp;spm=1001.2101.3001.7020" title="Web服务器">Web服务器</a>上修改或转换请求URL的过程。它通常涉及使用服务器配置或规则来更改传入的URL，以便在不改变实际请求资源的情况下，实现不同的行为，如重定向、路径映射、参数处理等。</p> 
<p>URL重写在服务器层面进行，因此客户端（如浏览器）对于URL的请求不会感知到这些更改，但服务器会根据配置进行适当的处理。URL重写可以用于多种目的，例如：</p> 
<ol><li> <p>重定向: 将一个URL重写为另一个URL，实现301永久重定向或302临时重定向。这可以用于更改站点结构、修复错误的URL、实现SEO优化等。</p> </li><li> <p>路径映射: 将一个URL的路径映射到另一个位置，这对于隐藏实际文件路径或路径重组很有用。</p> </li><li> <p>查询参数处理: 在URL中添加、删除或修改查询参数，以适应不同的应用需求。</p> </li><li> <p>动态URL到静态URL: 将动态生成的URL（带有参数）转化为静态URL，更友好且易于索引。</p> </li><li> <p>隐藏技术细节: 可以通过URL重写隐藏后端服务器或应用程序的实际技术细节，提高安全性。</p> </li></ol> 
<p>在Nginx、Apache等常见的Web服务器中，URL重写可以通过正则表达式、规则匹配等方式来实现。具体的语法和方法会因服务器软件的不同而有所不同。通常，<a href="https://so.csdn.net/so/search?q=%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE&amp;spm=1001.2101.3001.7020" title="服务器配置">服务器配置</a>文件中会有专门的部分用于配置URL重写规则，例如在Nginx中是使用rewrite指令。URL重写是一种强大的技术，但在使用时需要小心，确保配置正确以避免潜在的问题，例如无限循环重定向或错误的重写规则可能导致网站不可用。</p> 
<h4>Ingress 内置变量</h4> 
<p>内置预定义变量即无需声明就可以使用的变量，通常包括一个http请求或响应中一部分内容的值，以下为一些常用的内置预定义变量：</p> 
<p>变量名      定义<br> $arg_PARAMETER  GET请求中变量名PARAMETER参数的值。<br> $args   这个变量等于GET请求中的参数。例如，foo=123&amp;bar=blahblah;这个变量只可以被修改<br> $binary_remote_addr 二进制码形式的客户端地址。<br> $body_bytes_sent    传送页面的字节数<br> $content_length 请求头中的Content-length字段。<br> $content_type   请求头中的Content-Type字段。<br> $cookie_COOKIE  cookie COOKIE的值。<br> $document_root  当前请求在root指令中指定的值。<br> $document_uri   与$uri相同。<br> $host   请求中的主机头(Host)字段，如果请求中的主机头不可用或者空，则为处理请求的server名称(处理请求的server的server_name指令的值)。值为小写，不包含端口。<br> $hostname   机器名使用 gethostname系统调用的值<br> $http_HEADER    HTTP请求头中的内容，HEADER为HTTP请求中的内容转为小写，-变为_(破折号变为下划线)，例如：$http_user_agent(Uaer-Agent的值);<br> $http_user_agent ： 客户端agent信息;<br> $http_cookie ： 客户端cookie信息;<br> $sent_http_HEADER   HTTP响应头中的内容，HEADER为HTTP响应中的内容转为小写，-变为_(破折号变为下划线)，例如： $sent_http_cache_control, $sent_http_content_type…;<br> $is_args    如果$args设置，值为"?"，否则为""。<br> $limit_rate 这个变量可以限制连接速率。<br> $nginx_version  当前运行的nginx版本号。<br> $query_string   与$args相同。<br> $remote_addr    客户端的IP地址。<br> $remote_port    客户端的端口。<br> $remote_user    已经经过Auth Basic Module验证的用户名。<br> $request_filename   当前连接请求的文件路径，由root或alias指令与URI请求生成。<br> $request_body   这个变量（0.7.58+）包含请求的主要信息。在使用proxy_pass或fastcgi_pass指令的location中比较有意义。<br> $request_body_file  客户端请求主体信息的临时文件名。<br> $request_completion 如果请求成功，设为"OK"；如果请求未完成或者不是一系列请求中最后一部分则设为空。<br> $request_method 这个变量是客户端请求的动作，通常为GET或POST。包括0.8.20及之前的版本中，这个变量总为main request中的动作，如果当前请求是一个子请求，并不使用这个当前请求的动作。<br> $request_uri    这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看$uri更改或重写URI,<br> 包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”。<br> $scheme 所用的协议，比如http或者是https，比如rewrite ^(.+)$ $scheme://example.com$1 redirect;<br> $server_addr    服务器地址，在完成一次系统调用后可以确定这个值，如果要绕开系统调用，则必须在listen中指定地址并且使用bind参数。<br> $server_name    服务器名称。<br> $server_port    请求到达服务器的端口号。<br> $server_protocol    请求使用的协议，通常是HTTP/1.0或HTTP/1.1。<br> $uri    请求中的当前URI(不带请求参数，参数位于args)，不同于浏览器传递的args)，不同于浏览器传递的args)，不同于浏览器传递的request_uri的值，它可以通过内部重定向，或者使用index指令进行修改。uri不包含主机名，如”/foo/bar.html”。</p> 
<h4>Ingress 正则表达式</h4> 
<pre><code class="hljs">正则表达式匹配，其中：
~       为区分大小写匹配
~*      为不区分大小写匹配
!~和!~*  分别为区分大小写不匹配及不区分大小写不匹配
.      匹配除换行符以外的任意字符
\w     匹配字母或数字或下划线或汉字
\s     匹配任意的空白符
\d     匹配数字
\b     匹配单词的开始或结束
^      匹配字符串的开始
$      匹配字符串的结束
*         重复零次或更多次
+         重复一次或更多次
?         重复零次或一次
{n}       重复n次
{n,}      重复n次或更多次
{n,m}     重复n到m次
*?        复任意次，但尽可能少重复
+?        重复1次或更多次，但尽可能少重复
??        重复0次或1次，但尽可能少重复
{n,m}?    重复n到m次，但尽可能少重复
{n,}?     重复n次以上，但尽可能少重复
\W        匹配任意不是字母，数字，下划线，汉字的字符
\S        匹配任意不是空白符的字符
\D        匹配任意非数字的字符
\B        匹配不是单词开头或结束的位置
[^x]      匹配除了x以外的任意字符
[^aeiou]  匹配除了aeiou这几个字母以外的任意字符   
(exp)         匹配exp,并捕获文本到自动命名的组里
(?&lt;name&gt;exp)  匹配exp,并捕获文本到名称为name的组里，也可以写成(?'name'exp)
(?:exp)       匹配exp,不捕获匹配的文本，也不给此分组分配组号   
(?=exp)       匹配exp前面的位置
(?&lt;=exp)      匹配exp后面的位置
(?!exp)       匹配后面跟的不是exp的位置
(?&lt;!exp)      匹配前面不是exp的位置
(?#comment)   注释分组不对正则表达式的处理产生任何影响</code></pre> 
<h4>配置URL重写规则</h4> 
<p>在某些应用场景中，后端服务提供的URL与Ingress规则中执行的路径不同，而Ingress访将访问路径直接转发到后端相同路径，如果不配置URL重写规则，所有访问都将返回404。比如如下案例，Ingress规则中配置的是/user/info，而后端服务提供的访问路径是/info,在不配置重写的情况下，会直接转发给后端/user/info与实际提供的访问路径/info不匹配，会直接返回404。接下来咱们用案例的方式进行验证。</p> 
<p>不配置URL重写直接转发：</p> 
<pre><code class="hljs">$ cat ingress.yml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: demo
spec:
  rules:
  - host: demo.kubesre.com
    http:
      paths:
      - path: /
        pathType: ImplementationSpecific
        backend:
          service:
            name: demo-svc
            port:
              number: 8080
  ingressClassName: nginx
 
$ kubectl apply -f ingress.yml
ingress.networking.k8s.io/demo configured</code></pre> 
<p>访问验证(/user/info)：</p> 
<pre><code class="hljs"># 访问/user/info，可以看出直接正常返回了
$ curl  http://demo.kubesre.com/user/info
{"message":"云原生运维圈！"}</code></pre> 
<p>注解说明：</p> 
<p>以上案例Ingress重写是通过<code>nginx.ingress.kubernetes.io/rewrite-target</code>注解实现不同路径的重写规则。占位符$2表示将第二个括号即(.*)中匹配到的所有字符填写到<code>nginx.ingress.kubernetes.io/rewrite-target</code>注解中。想必大家都知道Ingress是基于Nginx开发的，此时是通过Ingress CRD进行创建的重写配置，其本质也是修改Nginx配置文件的，此时从Ingress里的Nginx拷贝出来的配置如下：</p> 
<pre><code class="hljs">server {
  server_name demo.kubesre.com ;
 
  listen 80  ;
  listen [::]:80  ;
  listen 443  ssl http2 ;
  listen [::]:443  ssl http2 ;
 
  set $proxy_upstream_name "-";
 
  ssl_certificate_by_lua_block {
   certificate.call()
  }
 
  location ~* "^/user(/|$)(.*)" {
 
   set $namespace      "default";
   rewrite "(?i)/user(/|$)(.*)" /$2 break;
   proxy_pass http://upstream_balancer;
 
   proxy_redirect     off;
   }</code></pre> 
<h4>高级URL重写规则</h4> 
<p>对于一些复杂的重写规则需求，可以通过如下注解来实现，其本质也是修改Nginx配置文件。</p> 
<ul><li> <p>nginx.ingress.kubernetes.io/server-snippet：在nginx.conf的“server”字段中添加自定义配置。</p> </li><li> <p>nginx.ingress.kubernetes.io/configuration-snippet：在nginx.conf的“location”字段中添加自定义配置。</p> </li></ul> 
<p>URL重写Flag参数：</p> 
<ul><li> <p>last：表示本条规则匹配完成后继续向下匹配。</p> </li><li> <p>break：表示本条规则匹配完成后停止匹配。</p> </li><li> <p>redirect：表示临时重定向，返回状态码302。</p> </li><li> <p>permanent：表示永久重定向，返回状态码301。</p> </li></ul> 
<p>重定向就是将网页自动转向重定向：</p> 
<ul><li> <p>301永久性重定向：新网址完全继承旧网址，旧网址的SEO网络搜索引擎的排名等完全清零</p> </li><li> <p>301重定向是网页更改地址后对搜索引擎友好的最好方法，只要不是暂时搬移的情况，都建议使用301来做转址。</p> </li><li> <p>302临时性重定向：对旧网址没有影响，但新网址不会有排名</p> </li><li> <p>搜索引擎爬虫会抓取新的内容而保留旧的网址</p> </li></ul> 
<p>配置Location：</p> 
<p>通过Ingress注解<code>nginx.ingress.kubernetes.io/server-snippet</code>配置location，访问/sre，返回401错误代码，案例如下：</p> 
<pre><code class="hljs">$ cat sre.yml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/server-snippet: |
       location /sre {
        return 401;
        }
  name: demo-redirect
spec:
  rules:
  - host: demo.kubesre.com
    http:
      paths:
      - path: /
        pathType: ImplementationSpecific
        backend:
          service:
            name: demo-svc
            port:
              number: 8080
  ingressClassName: nginx
 
$ kubectl apply -f 1.yml
ingress.networking.k8s.io/demo-redirect configured</code></pre> 
<p>访问验证：</p> 
<pre><code class="hljs"># 表示验证成功
$ curl http://demo.kubesre.com/sre/
&lt;html&gt;
&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre> 
<p>URL重定向（permanent）：</p> 
<pre><code class="hljs">cat  demo-permanent.yml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/configuration-snippet: |
      rewrite ^/$ https://www.baidu.com redirect;
  name: demo-redirect
spec:
  rules:
  - host: demo.kubesre.com
    http:
      paths:
      - path: /
        pathType: ImplementationSpecific
        backend:
          service:
            name: demo-svc
            port:
              number: 8080
  ingressClassName: nginx
 
$ kubectl apply -f demo-permanent.yml
ingress.networking.k8s.io/demo-permanent created</code></pre> 
<p>访问验证：</p> 
<pre><code class="hljs"># 301永久重定向，浏览器器地址栏会显示跳转后的URL地址,真实效果可以通过浏览器访问测试验证
$ curl http://demo.kubesre.com
&lt;html&gt;
&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre> 
<p>URL重定向（redirect）：</p> 
<p>通过URL重定向，访问/test/info,直接重定向302跳转到/user/info。</p> 
<pre><code class="hljs">$ cat demo-redirect.yml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/configuration-snippet: |
       rewrite ^/test/(.*)$ /user/$1 redirect;
  name: demo-redirect
spec:
  rules:
  - host: demo.kubesre.com
    http:
      paths:
      - path: /test
        pathType: ImplementationSpecific
        backend:
          service:
            name: demo-svc
            port:
              number: 8080
  ingressClassName: nginx
  
$ kubectl apply -f demo-redirect.yml
ingress.networking.k8s.io/demo-redirect created</code></pre> 
<p>访问验证：</p> 
<pre><code class="hljs"># 302 说明已经重定向了，实际效果可以通过浏览器访问查看
$ curl  http://demo.kubesre.com/test/info
&lt;html&gt;
&lt;head&gt;&lt;title&gt;302 Found&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;302 Found&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre> 
<p>URL重写（last）：</p> 
<p>通过URL重写实现，访问/sre,返回的是/kube的结果，可以利用重写Flag last参数，当URL重写后，会发送一个新的请求，再次进入server块，重试location匹配，匹配成功直接把结果直接返回。</p> 
<pre><code class="hljs">$ cat sre.yml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/configuration-snippet: |
      rewrite ^/sre /kube last;
    nginx.ingress.kubernetes.io/server-snippet: |
       location /sre {
        return 401;
        }
        location /kube {
        return 403;
        }
  name: demo-redirect
spec:
  rules:
  - host: demo.kubesre.com
    http:
      paths:
      - path: /sre
        pathType: ImplementationSpecific
        backend:
          service:
            name: demo-svc
            port:
              number: 8080
  ingressClassName: nginx
 
$ kubectl apply -f sre.yml
ingress.networking.k8s.io/demo-redirect configured</code></pre> 
<p>访问验证：</p> 
<pre><code class="hljs"># 访问/sre，则返回/kube结果403
$ curl http://demo.kubesre.com/sre/
&lt;html&gt;
&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;</code></pre> 
<h4>总结</h4> 
<p>本文介绍了 URL 重写的概念，并通过实际案例的方式讲解了 URL 重写的方方面面。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5e57872f2e327d4d61a039b2398cd651/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">微信小程序的几种常见的样式写法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b1d2b10c950f50f9fbf7078db4e215b5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux内核查看配置文件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>