<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>go-consul实战 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="go-consul实战" />
<meta property="og:description" content="consul简介 官网介绍地址 视频介绍的挺不错的，不过是英文的
Consul is a service mesh solution providing a full featured control plane with service discovery, configuration, and segmentation functionality. Each of these features can be used individually as needed, or they can be used together to build a full service mesh. Consul requires a data plane and supports both a proxy and native integration model. Consul ships with a simple built-in proxy so that everything works out of the box, but also supports 3rd party proxy integrations such as Envoy." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/bf44dd03ba8a9c67922bb9fda3759376/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-06T18:29:36+08:00" />
<meta property="article:modified_time" content="2022-03-06T18:29:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">go-consul实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="consul_0"></a>consul简介</h3> 
<p><a href="https://www.consul.io/docs/intro" rel="nofollow">官网介绍地址</a> 视频介绍的挺不错的，不过是英文的</p> 
<blockquote> 
 <p>Consul is a service mesh solution providing a full featured control plane with service discovery, configuration, and segmentation functionality. Each of these features can be used individually as needed, or they can be used together to build a full service mesh. Consul requires a data plane and supports both a proxy and native integration model. Consul ships with a simple built-in proxy so that everything works out of the box, but also supports 3rd party proxy integrations such as Envoy.<br> 大致的意思是，Consul提供<strong>服务网格</strong>(可自行搜索一下含义)解决方案，功能齐全，支持控制平面，服务发现、配置和分段功能。这些功能中的每个特性都可以根据需要单独使用，也可以一起使用来构建一个完整的服务网格。Consul需要一个数据平面，并支持代理和原生集成模型。Consul提供了一个简单的内置代理，因此一切都可以开箱即用，但也支持第三方代理集成，如Envoy。</p> 
</blockquote> 
<p>学习参考的资料<br> <a href="https://www.consul.io/" rel="nofollow">官网</a><br> <a href="https://yushuai-w.gitbook.io/consul/" rel="nofollow">中文文档</a></p> 
<h3><a id="_10"></a>环境搭建</h3> 
<blockquote> 
 <p>前面介绍了consul的功能很强大，提供了服务网格的整体解决方案。本文主要使用 consul来演示其中服务发现这个单独的特性。本案例采用的是consul单机进行测试。启动服务consul服务端，需要占用6个端口，因此只部署了单实例，内存占用 17m， 占用端口8300,8301,8302,8500,8502,8600</p> 
</blockquote> 
<h3><a id="_12"></a>说明</h3> 
<blockquote> 
 <p>本文的实操环境是基于虚拟机完成，虚拟机通过静态ip与本机相连，虚拟机局域网ip地址固定为 10.248.174.155。consul的版本为1.11.1</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># 虚拟机操作系统</span>
<span class="token operator">&gt;</span> <span class="token function">uname</span> -a
<span class="token operator">&gt;</span> Linux n248-174-155 4.14.81.bm.15-amd64 <span class="token comment">#1 SMP Debian 4.14.81.bm.15 Sun Sep 8 05:02:31 UTC 2019 x86_64 GNU/Linux</span>
</code></pre> 
<h3><a id="_21"></a>下载安装</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 下载</span>
<span class="token function">wget</span> https://releases.hashicorp.com/consul/1.11.1/consul_1.11.1_linux_amd64.zip
<span class="token comment"># 解压</span>
unzip consul_1.11.1_linux_amd64.zip
</code></pre> 
<p>解压后只有一个可执行文件，将这个可执行文件加入到环境变量PATH中即可，记得使用source 命令让PATH的变量重新加载</p> 
<h4><a id="_29"></a>测试是否安装成功</h4> 
<pre><code class="prism language-shell"><span class="token comment"># consul version 查看版本号</span>
root@n248-174-155:~/file$ consul version
Consul v1.11.1
Revision 2c56447e
Protocol 2 spoken by default, understands 2 to 3 <span class="token punctuation">(</span>agent will automatically use protocol <span class="token operator">&gt;</span>2 when speaking to compatible agents<span class="token punctuation">)</span>
</code></pre> 
<p>另外由于启动时，指定了参数开始 web-ui 所以可以在web端可视化的展示服务的状态，将ip替换成你的ip即可<br> <a href="http://10.248.174.155:8500/" rel="nofollow">http://10.248.174.155:8500/</a></p> 
<h3><a id="_40"></a>命令实战</h3> 
<blockquote> 
 <p>一般来说，官方提供的各种语言相关的sdk都原生命令有对应的联系，consul是用go语言编写的，原生api对go的支持非常好。<br> 由于已经将consul 加入到PATH变量中了，所以接下来的操作都和在哪个目录完全没有关系了。</p> 
</blockquote> 
<h4><a id="_consul_43"></a>启动 consul</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 后台启动方式，指定了日志文件路径/home/root/consul/consul.log</span>
<span class="token function">nohup</span> consul agent -dev -client 0.0.0.0 -ui <span class="token operator">&gt;</span> /home/root/consul/consul.log 2<span class="token operator">&gt;</span><span class="token operator">&amp;</span>1 <span class="token operator">&amp;</span>
</code></pre> 
<p>查看进程</p> 
<pre><code class="prism language-go">root@n248<span class="token operator">-</span><span class="token number">174</span><span class="token operator">-</span><span class="token number">155</span><span class="token punctuation">:</span>~<span class="token operator">/</span>file$ netstat <span class="token operator">-</span>ntpl<span class="token operator">|</span>grep consul
<span class="token punctuation">(</span>Not all processes could be identified<span class="token punctuation">,</span> non<span class="token operator">-</span>owned process info
 will not be shown<span class="token punctuation">,</span> you would have to be root to see it all<span class="token punctuation">.</span><span class="token punctuation">)</span>
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8300</span>          <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token operator">*</span>               LISTEN      <span class="token number">793138</span><span class="token operator">/</span>consul
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8301</span>          <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token operator">*</span>               LISTEN      <span class="token number">793138</span><span class="token operator">/</span>consul
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8302</span>          <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token operator">*</span>               LISTEN      <span class="token number">793138</span><span class="token operator">/</span>consul
tcp6       <span class="token number">0</span>      <span class="token number">0</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">8500</span>                 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span>                    LISTEN      <span class="token number">793138</span><span class="token operator">/</span>consul
tcp6       <span class="token number">0</span>      <span class="token number">0</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">8502</span>                 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span>                    LISTEN      <span class="token number">793138</span><span class="token operator">/</span>consul
tcp6       <span class="token number">0</span>      <span class="token number">0</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">8600</span>                 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span>                    LISTEN      <span class="token number">793138</span><span class="token operator">/</span>consul
</code></pre> 
<h4><a id="kv_61"></a>新增kv</h4> 
<pre><code class="prism language-shell">consul kv put services/svr1/001 <span class="token string">'{"Addr":"192.168.4.5","Port":3358}'</span>
consul kv put services/svr1/002 <span class="token string">'{"Addr":"192.164.45.22","Port":3458}'</span>
consul kv put services/svr2/001 <span class="token string">'{"Addr":"192.138.44.55","Port":3456}'</span>
</code></pre> 
<h4><a id="key_flags_69"></a>新增key 指定额外flags</h4> 
<pre><code class="prism language-shell">consul kv put -flags<span class="token operator">=</span>25 service/svr1/003 <span class="token string">'{"Addr":"192.174.35.67","Port":8890}'</span>
</code></pre> 
<h4><a id="kv_74"></a>查询kv</h4> 
<pre><code class="prism language-shell">consul kv get service/svr1/001
</code></pre> 
<h4><a id="kv_78"></a>查询kv详情</h4> 
<pre><code class="prism language-shell">consul kv get -detailed service/svr1/001
</code></pre> 
<h4><a id="kv__82"></a>查询所有kv 递归查询</h4> 
<pre><code class="prism language-shell">consul kv get -recurse
</code></pre> 
<h4><a id="keykv_86"></a>根据key前缀查询，返回所有kv</h4> 
<pre><code class="prism language-shell">consul kv get -recurse service/svr1/
</code></pre> 
<h4><a id="keykey_90"></a>根据key前缀查询，只返回key</h4> 
<pre><code class="prism language-shell">consul kv get -keys service/svr1/
</code></pre> 
<h4><a id="kv_95"></a>删除kv</h4> 
<pre><code class="prism language-shell">consul kv delete service/svr1/001
</code></pre> 
<h4><a id="_99"></a>根据前缀删除</h4> 
<pre><code class="prism language-shell">consul kv delete -recurse service/svr1/
</code></pre> 
<h4><a id="watch__104"></a>watch 某个前缀的结点，会一次性返回所有结点的信息</h4> 
<pre><code class="prism language-shell">consul <span class="token function">watch</span> -type<span class="token operator">=</span>keyprefix -prefix<span class="token operator">=</span>/services/svr1/001
</code></pre> 
<h3><a id="_110"></a>服务注册</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 指定服务ip地址、端口号、服务唯一id、服务名、服务的多个tag</span>
consul services register -address<span class="token operator">=</span>124.3.2.4 -port<span class="token operator">=</span>4458 -id<span class="token operator">=</span>1234001 -name<span class="token operator">=</span>mysvr-rpc -tag<span class="token operator">=</span>v.1.1 -tag<span class="token operator">=</span>user
</code></pre> 
<h3><a id="_115"></a>为服务注册添加健康检查</h3> 
<p>heath.json 文件内容</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"ID"</span><span class="token punctuation">:</span> <span class="token string">"service:1234001"</span><span class="token punctuation">,</span>
  <span class="token string">"Name"</span><span class="token punctuation">:</span> <span class="token string">"自定义结点健康检查"</span><span class="token punctuation">,</span>
  <span class="token string">"Notes"</span><span class="token punctuation">:</span> <span class="token string">"回调http接口查看"</span><span class="token punctuation">,</span>
  <span class="token string">"DeregisterCriticalServiceAfter"</span><span class="token punctuation">:</span> <span class="token string">"30s"</span><span class="token punctuation">,</span>
  <span class="token string">"HTTP"</span><span class="token punctuation">:</span> <span class="token string">"http://ip:port/consul/health/?id=555"</span><span class="token punctuation">,</span>
  <span class="token string">"Method"</span><span class="token punctuation">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span>
  <span class="token string">"Interval"</span><span class="token punctuation">:</span> <span class="token string">"10s"</span><span class="token punctuation">,</span>
  <span class="token string">"Timeout"</span><span class="token punctuation">:</span> <span class="token string">"5s"</span><span class="token punctuation">,</span>
  <span class="token string">"ServiceID"</span><span class="token punctuation">:</span><span class="token string">"1234001"</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>ID: 健康检查的唯一id,类似于db里面的主键</li><li>Name: 健康检查的名字，后续可以在自带的web面板展示出来</li><li>DeregisterCriticalServiceAfter: 代表服务停止多久后进行注销该服务</li><li>HTTP: 去哪个地址检测服务的健康状态</li><li>Method: 发送请求的方式</li><li>Interval:健康检查时间间隔，即心跳间隔</li><li>Timeout:请求超时时间</li><li>ServiceID:额外参数，如果指定则是检测具体某个服务的健康状态，不指定则是consul的agent健康状态</li></ul> 
<pre><code class="prism language-shell"><span class="token comment"># heath.json 定义的是只针对某个服务结点的健康检查，直接从文件中读取具体的数据</span>
<span class="token function">curl</span> --request PUT --data @heath.json http://127.0.0.1:8500/v1/agent/check/register
</code></pre> 
<h3><a id="_144"></a>服务卸载</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 根据服务的唯一id卸载服务</span>
consul services deregister -id<span class="token operator">=</span>1234001
</code></pre> 
<h3><a id="_151"></a>获取所有健康检查条目</h3> 
<pre><code class="prism language-shell"><span class="token function">curl</span> http://127.0.0.1:8500/v1/agent/checks
</code></pre> 
<h3><a id="_156"></a>获取服务信息</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 只返回健康没问题的</span>
<span class="token function">curl</span> http://127.0.0.1:8500/v1/health/service/mysvr-rpc?passing<span class="token operator">=</span>1
</code></pre> 
<h3><a id="goconsul_162"></a>go-consul实战</h3> 
<blockquote> 
 <p>consul自带服务发现与注册功能，下面将做一个服务注册与发现的例子，仅供参考。</p> 
</blockquote> 
<h4><a id="_164"></a>服务注册</h4> 
<blockquote> 
 <p>注意如果你指定了http的健康检查方式，一定要在对应的地址启动http服务，否则健康检查会失败，直接摘除服务。或者可以使用grpc的方式进行代替。</p> 
</blockquote> 
<pre><code class="prism language-go"><span class="token keyword">package</span> consul

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"google.golang.org/grpc/health/grpc_health_v1"</span>
	<span class="token string">"log"</span>
	<span class="token string">"strings"</span>

	<span class="token string">"github.com/hashicorp/consul/api"</span>
	uuid <span class="token string">"github.com/satori/go.uuid"</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	consulIp   <span class="token operator">=</span> <span class="token string">"10.248.174.155"</span>
	consulPort <span class="token operator">=</span> <span class="token string">"8500"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">RandomStr</span><span class="token punctuation">(</span><span class="token builtin">len</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	nUid <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">NewV4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	str <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>nUid<span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token builtin">len</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token builtin">len</span> <span class="token operator">&gt;=</span> <span class="token number">32</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> str
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> str<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// HttpReg 服务注册时候提供一个健康检查地址，支持http，grpc</span>
<span class="token keyword">func</span> <span class="token function">HttpReg</span><span class="token punctuation">(</span>svrName <span class="token builtin">string</span><span class="token punctuation">,</span> ipAddr <span class="token builtin">string</span><span class="token punctuation">,</span> port <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 创建Consul客户端连接</span>
	client<span class="token punctuation">,</span> err <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>api<span class="token punctuation">.</span>Config<span class="token punctuation">{<!-- --></span>
		Address<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"http://%v:%v"</span><span class="token punctuation">,</span> consulIp<span class="token punctuation">,</span> consulPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"client 创建失败，退出:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	svrID <span class="token operator">:=</span> <span class="token function">RandomStr</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
	<span class="token comment">// 设置Consul对服务健康检查的参数</span>
	check <span class="token operator">:=</span> api<span class="token punctuation">.</span>AgentServiceCheck<span class="token punctuation">{<!-- --></span>
		HTTP<span class="token punctuation">:</span>                           fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"http://%v:%v/consul/health/?id=%v"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> svrID<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 健康检查地址，自定义ip和端口</span>
		Interval<span class="token punctuation">:</span>                       <span class="token string">"3s"</span><span class="token punctuation">,</span>                                                                        <span class="token comment">// 健康检查频率</span>
		Timeout<span class="token punctuation">:</span>                        <span class="token string">"2s"</span><span class="token punctuation">,</span>                                                                        <span class="token comment">// 健康检查超时</span>
		Notes<span class="token punctuation">:</span>                          <span class="token string">"Consul 代码健康检查"</span><span class="token punctuation">,</span>
		DeregisterCriticalServiceAfter<span class="token punctuation">:</span> <span class="token string">"5s"</span><span class="token punctuation">,</span> <span class="token comment">// 健康检查失败30s后 consul自动将注册服务删除</span>
		Name<span class="token punctuation">:</span>                           <span class="token string">"代码自定义检查svr1"</span><span class="token punctuation">,</span>
		<span class="token comment">//GRPC:     fmt.Sprintf("%v:%v/%v", svcHost, svcPort, "svrName"),</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//设置微服务向Consul注册信息</span>
	reg <span class="token operator">:=</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>AgentServiceRegistration<span class="token punctuation">{<!-- --></span>
		ID<span class="token punctuation">:</span>      svrID<span class="token punctuation">,</span>                      <span class="token comment">// 服务节点的ID</span>
		Name<span class="token punctuation">:</span>    svrName<span class="token punctuation">,</span>                    <span class="token comment">// 服务名称</span>
		Address<span class="token punctuation">:</span> ipAddr<span class="token punctuation">,</span>                     <span class="token comment">// 服务IP</span>
		Port<span class="token punctuation">:</span>    port<span class="token punctuation">,</span>                       <span class="token comment">// 服务端口</span>
		Tags<span class="token punctuation">:</span>    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span><span class="token string">"v1.1"</span><span class="token punctuation">,</span> <span class="token string">"backup"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 标签，可在服务发现时筛选服务，类似v1.1</span>
		Check<span class="token punctuation">:</span>   <span class="token operator">&amp;</span>check<span class="token punctuation">,</span>                     <span class="token comment">// 健康检查</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 执行注册</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Agent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ServiceRegister</span><span class="token punctuation">(</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> svrID
<span class="token punctuation">}</span>
<span class="token comment">//HttpUnReg 服务卸载</span>
<span class="token keyword">func</span> <span class="token function">HttpUnReg</span><span class="token punctuation">(</span>svrID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 创建Consul客户端连接</span>
	client<span class="token punctuation">,</span> err <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>api<span class="token punctuation">.</span>Config<span class="token punctuation">{<!-- --></span>
		Address<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"http://%v:%v"</span><span class="token punctuation">,</span> consulIp<span class="token punctuation">,</span> consulPort<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"client 创建失败，退出:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 执行服务卸载</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Agent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ServiceDeregister</span><span class="token punctuation">(</span>svrID<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//========如果使用grpc接口实现健康检查，则需要实现HealthServer 接口，服务启动时候注册这个pb==========</span>

<span class="token comment">// HealthImpl 健康检查实现</span>
<span class="token keyword">type</span> HealthImpl <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment">// Check 实现健康检查接口，这里直接返回健康状态</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HealthImpl<span class="token punctuation">)</span> <span class="token function">Check</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>grpc_health_v1<span class="token punctuation">.</span>HealthCheckRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>grpc_health_v1<span class="token punctuation">.</span>HealthCheckResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>grpc_health_v1<span class="token punctuation">.</span>HealthCheckResponse<span class="token punctuation">{<!-- --></span>
		Status<span class="token punctuation">:</span> grpc_health_v1<span class="token punctuation">.</span>HealthCheckResponse_SERVING<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// Watch 让HealthImpl实现RegisterHealthServer内部的interface接口</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HealthImpl<span class="token punctuation">)</span> <span class="token function">Watch</span><span class="token punctuation">(</span>req <span class="token operator">*</span>grpc_health_v1<span class="token punctuation">.</span>HealthCheckRequest<span class="token punctuation">,</span> w grpc_health_v1<span class="token punctuation">.</span>Health_WatchServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="_266"></a>服务注册单元测试</h4> 
<pre><code class="prism language-go"><span class="token keyword">package</span> consul

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/hashicorp/consul/api"</span>
	<span class="token string">"log"</span>
	<span class="token string">"testing"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestClient</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">// Get a new client</span>
	client<span class="token punctuation">,</span> err <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>api<span class="token punctuation">.</span>Config<span class="token punctuation">{<!-- --></span>
		Address<span class="token punctuation">:</span> <span class="token string">"http://10.248.174.155:8500"</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Get a handle to the KV API</span>
	kv <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">KV</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// PUT a new KV pair</span>
	p <span class="token operator">:=</span> <span class="token operator">&amp;</span>api<span class="token punctuation">.</span>KVPair<span class="token punctuation">{<!-- --></span>Key<span class="token punctuation">:</span> <span class="token string">"my-svr"</span><span class="token punctuation">,</span> Value<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"1000"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Flags<span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">}</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Lookup the pair</span>
	pair<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> kv<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"my-svr"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"KV: %v %s\n"</span><span class="token punctuation">,</span> pair<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> pair<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestHttpReg</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	svrID <span class="token operator">:=</span> <span class="token function">HttpReg</span><span class="token punctuation">(</span><span class="token string">"mysvr-rpc"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">3456</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"服务注册成功：%v\n"</span><span class="token punctuation">,</span> svrID<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">true</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 制定一个定时器，模拟20s后摘除服务</span>
		t <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">20</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> tt <span class="token operator">:=</span> <span class="token operator">&lt;-</span>t<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			<span class="token function">HttpUnReg</span><span class="token punctuation">(</span>svrID<span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"服务卸载，tt:%v\n"</span><span class="token punctuation">,</span> tt<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="_325"></a>服务发现</h4> 
<pre><code class="prism language-bash">package consul

<span class="token function">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"github.com/hashicorp/consul/api"</span>
	<span class="token string">"log"</span>
<span class="token punctuation">)</span>

// GetNode 没有watch的api 无法感知结点的变更，如果做本地缓存则需要启动协程去定时轮询，全量更新到本地缓存
func GetNode<span class="token punctuation">(</span>svrName string<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	// 创建Consul客户端连接
	client, err :<span class="token operator">=</span> api.NewClient<span class="token punctuation">(</span><span class="token operator">&amp;</span>api.Config<span class="token punctuation">{<!-- --></span>
		Address: fmt.Sprintf<span class="token punctuation">(</span><span class="token string">"http://%v:%v"</span>, consulIp, consulPort<span class="token punctuation">)</span>,
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> nil <span class="token punctuation">{<!-- --></span>
		log.Fatalf<span class="token punctuation">(</span><span class="token string">"client 创建失败，退出:%v\n"</span>, err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	// 根据服务名和tag 是否健康检查通过 以及其它option 筛选service实例
	service, meta, serr :<span class="token operator">=</span> client.Health<span class="token punctuation">(</span><span class="token punctuation">)</span>.Service<span class="token punctuation">(</span>svrName, <span class="token string">""</span>, true, nil<span class="token punctuation">)</span>
	log.Printf<span class="token punctuation">(</span><span class="token string">"结束svr%+v,meta:%+v, err:%v\n"</span>, service, meta, serr<span class="token punctuation">)</span>
	<span class="token keyword">for</span> _, s :<span class="token operator">=</span> range <span class="token function">service</span> <span class="token punctuation">{<!-- --></span>
		fmt.Printf<span class="token punctuation">(</span><span class="token string">"服务：%+v\n"</span>, s.Service<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="_356"></a>服务发现单元测试</h4> 
<pre><code class="prism language-go"><span class="token keyword">package</span> consul

<span class="token keyword">import</span> <span class="token string">"testing"</span>

<span class="token keyword">func</span> <span class="token function">TestGetNode</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">GetNode</span><span class="token punctuation">(</span><span class="token string">"mysvr-rpc"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="_369"></a>总结</h3> 
<blockquote> 
 <p>本文没有深入介绍consul的一些底层原理性东西，主要介绍了consul的安装及功能的使用，介绍了一些常用的api命令，最后用go语言简单实现了一下服务注册与发现的过程。</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a84931d82b11bd5e122add6514db589a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring主从数据库的配置和动态数据源切换原理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4a0a9504372c13f083288ee1dc47a517/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">判断 素数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>