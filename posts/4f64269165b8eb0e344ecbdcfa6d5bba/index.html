<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32与FPGA实现以太网功能--web、UDP、tcp测试 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32与FPGA实现以太网功能--web、UDP、tcp测试" />
<meta property="og:description" content="web网管程序在ETH工程已经做好并验证完成了，现在STM32&#43;FPGA实现ping功能，那么web功能应该一样能实现
问题1：浏览器输入192.168.1.30，能出现登入界面，但是输入密码点击没反应，果然没有一帆风顺的。
原因：发现有一个设备正常，另一个设备通过TFTP下发web网页偶尔正常。打印排查下，发现读网页大小不对（估计用W25Q16弄的文件系统哪里bug，记录下，等以后处理）
问题2：web网管有的卡，登入界面不是很流畅
原因：浏览器下发命令，STM32上传web数据帧，网页数据比较大，有10K以上，需要发送10帧以上数据，STM32与FPGA数据传输效率不行，
解决方法：
1、FSMC驱动速率尽可能快，减少与FPGA通信时间
/* ComSpaceTiming */ ComSpaceTiming.SetupTime = 0; ComSpaceTiming.WaitSetupTime = 2; ComSpaceTiming.HoldSetupTime = 2; ComSpaceTiming.HiZSetupTime = 1; /* AttSpaceTiming */ AttSpaceTiming.SetupTime = 0; AttSpaceTiming.WaitSetupTime = 2; AttSpaceTiming.HoldSetupTime = 2; AttSpaceTiming.HiZSetupTime = 1; 2、STM32网络输出等待FPGA发送完（数据频率快，可能出现丢包现象）
uint8_t fpgaBuf[1600] = {0}; uint8_t fpga_SendPacket(struct pbuf *p) { struct pbuf* q = NULL; uint8_t regData = 0; uint16_t txLen = 0; xSemaphoreTake(FSMC_Handle, 1000); regData = fpga_One_read(FPAG_TX_ISR); while((regData &amp;0X01)==1)//FPGA中有未发送完成数据 { xSemaphoreGive( FSMC_Handle );//给出互斥量 // printf(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4f64269165b8eb0e344ecbdcfa6d5bba/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-30T18:54:29+08:00" />
<meta property="article:modified_time" content="2024-01-30T18:54:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32与FPGA实现以太网功能--web、UDP、tcp测试</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>web网管程序在ETH工程已经做好并验证完成了，现在STM32+FPGA实现ping功能，那么web功能应该一样能实现</p> 
<p><strong>问题1：</strong>浏览器输入192.168.1.30，能出现登入界面，但是输入密码点击没反应，果然没有一帆风顺的。</p> 
<p>原因：发现有一个设备正常，另一个设备通过TFTP下发web网页偶尔正常。打印排查下，发现读网页大小不对（估计用W25Q16弄的文件系统哪里bug，记录下，等以后处理）</p> 
<p><strong>问题2：</strong>web网管有的卡，登入界面不是很流畅</p> 
<p>原因：浏览器下发命令，STM32上传web数据帧，网页数据比较大，有10K以上，需要发送10帧以上数据，STM32与FPGA数据传输效率不行，</p> 
<p>解决方法：</p> 
<p>1、FSMC驱动速率尽可能快，减少与FPGA通信时间</p> 
<pre><code class="hljs">  /* ComSpaceTiming */
  ComSpaceTiming.SetupTime = 0;
  ComSpaceTiming.WaitSetupTime = 2;
  ComSpaceTiming.HoldSetupTime = 2;
  ComSpaceTiming.HiZSetupTime = 1;
  /* AttSpaceTiming */
  AttSpaceTiming.SetupTime = 0;
  AttSpaceTiming.WaitSetupTime = 2;
  AttSpaceTiming.HoldSetupTime = 2;
  AttSpaceTiming.HiZSetupTime = 1;</code></pre> 
<p>2、STM32网络输出等待FPGA发送完（数据频率快，可能出现丢包现象）</p> 
<pre><code class="hljs">uint8_t fpgaBuf[1600] = {0};
uint8_t fpga_SendPacket(struct pbuf *p)
{
	struct pbuf* q = NULL;
    uint8_t regData = 0;
    uint16_t txLen = 0;
	xSemaphoreTake(FSMC_Handle, 1000);
    regData = fpga_One_read(FPAG_TX_ISR);
    while((regData &amp;0X01)==1)//FPGA中有未发送完成数据
    {
		xSemaphoreGive( FSMC_Handle );//给出互斥量
        // printf("FPGA donot send over %d\r\n", regData);
        return 0;
    }

    q = p;
    txLen = 0;
    while(q)
	{
        if(txLen + q-&gt;len &gt;= 1600)
        {
            xSemaphoreGive( FSMC_Handle );//给出互斥量
            printf("FPGA err %d %d\r\n", txLen, q-&gt;len);
            return 0;
        }
        memcpy(&amp;fpgaBuf[txLen], (uint8_t*)q-&gt;payload, q-&gt;len);
        txLen += q-&gt;len;
        q = q-&gt;next;
	}

    if(txLen &lt; 60)// 最少60，ARP应答42字节无效？
    {
        memset(&amp;fpgaBuf[txLen], 0, (60 - txLen));
        txLen = 60;
    }
    fpga_write(FPAG_TX_ADD, fpgaBuf, txLen);
	fpga_One_write(FPAG_TX_LEN_ADDH,(txLen&gt;&gt;8)&amp;0XFF);
    fpga_One_write(FPAG_TX_LEN_ADDL, txLen&amp;0XFF);
    fpga_One_write(FPAG_TX_ISR, 0X01);
    while((fpga_One_read(FPAG_TX_ISR)&amp;0X01));			//等待发送完成

    // printf("FPGA send start %d\r\n", txLen);
	xSemaphoreGive( FSMC_Handle );//给出互斥量
	return 1;
}</code></pre> 
<p>3、减小web网页，减少发送次数</p> 
<p>web网管实现，udp、tcp通讯应该没问题，这监控数据通信，频率很低，数据很少</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7bb2e43c0d112f8b21691dc8afde6a03/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Qt 基础之QDataTime</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/082cd3771304d2e09d0cda8db67fa8e0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">707. 设计链表(力扣刷题)（C语言题解）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>