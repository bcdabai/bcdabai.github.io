<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nacos 1.4.2升级到nacos 2.1.1遇到的一些坑 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="nacos 1.4.2升级到nacos 2.1.1遇到的一些坑" />
<meta property="og:description" content="文章目录 1 前言2 拉取nacos配置失败2.1 可能是端口号问题2.2 可能存在jar冲突2.3 可能nacos配置不对 1 前言 为了各组件更好的的兼容，最近系统进行了nacos升级, 由1.4.2升级为2.1.1，这里把遇到的一些坑做一下记录。
2 拉取nacos配置失败 在升级后，有的微服务，无论怎么启动，都拉取不到nacos 配置信息
2.1 可能是端口号问题 当nacos客户端升级为2.1.1版本后，新增了gRPC的通信方式，增加了两个偏移量端口9848,9849，在原端口8848基础上面偏移量1000和1001。
端口说明原端口: 8848服务使用偏移量端口1：9848客户端gRPC请求服务端端口，用于客户端向服务端发起连接和请求偏移量端口2：9849服务端gRPC请求服务端端口，用于服务间同步等 注：如果开启了防火墙或者使用了容器化部署，需要在阿里云等服务器，容器等，开通相应服务端口： 8848、9848、9849
2.2 可能存在jar冲突 如果排除冲突还是起不来，只能跟踪错误原因，查看源码了。笔者百度了一些issue，没能解决问题，只能跟踪源码
查看源码发现，确实是拉取配置时出问题了：
com.alibaba.nacos.client.config.impl.ClientWorker，第778行queryConfig方法，拿不到nacos配置的response
跟踪源码发现，com.alibaba.nacos.common.remote.client.RpcClient，第468行，这里就是执行不到，发现是currentConnection为空
然后发现，重试了3次都是拉去失败
最后发现，是createNewChannelStub方法，执行有问题，手动可以进入源码，但是debug执行进不去，发现是jar冲突导致，有2个RequestGrpc。原因是，有个小伙伴继承了base脚手架，里面有维护nacos依赖，然后项目又额外引入了依赖：
导致项目有两个RequestGrpc
com.alibaba.nacos.api.grpc.auto.RequestGrpc
导致无法选择唯一的bean去执行，导致连接nacos服务异常，导致currentConnection为空，导致nacos配置拉取失败。最后把nacos-api依赖排除，问题得到了解决。
这两个依赖里面，RequestGrpc类有冲突，nacos config拉去不到，本地没有配置信息（mac命令：cd ~/nacos/config/）
2.3 可能nacos配置不对 检查下ip，端口，以及namespace，前缀prefix、file-extension等等
写博客是为了记住自己容易忘记的东西，另外也是对自己工作的总结，希望尽自己的努力，做到更好，大家一起努力进步！
如果有什么问题，欢迎大家一起探讨，代码如有问题，欢迎各位大神指正！
给自己的梦想添加一双翅膀，让它可以在天空中自由自在的飞翔！" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/260719f9714d201488ac388732007789/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-21T12:55:39+08:00" />
<meta property="article:modified_time" content="2023-04-21T12:55:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nacos 1.4.2升级到nacos 2.1.1遇到的一些坑</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1__1" rel="nofollow">1 前言</a></li><li><a href="#2_nacos_4" rel="nofollow">2 拉取nacos配置失败</a></li><li><ul><li><a href="#21__7" rel="nofollow">2.1 可能是端口号问题</a></li><li><a href="#22_jar_19" rel="nofollow">2.2 可能存在jar冲突</a></li><li><a href="#23_nacos_47" rel="nofollow">2.3 可能nacos配置不对</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1__1"></a>1 前言</h2> 
<p>为了各组件更好的的兼容，最近系统进行了nacos升级, 由1.4.2升级为2.1.1，这里把遇到的一些坑做一下记录。</p> 
<h2><a id="2_nacos_4"></a>2 拉取nacos配置失败</h2> 
<p>在升级后，有的微服务，无论怎么启动，都拉取不到nacos 配置信息</p> 
<h3><a id="21__7"></a>2.1 可能是端口号问题</h3> 
<p>当nacos客户端升级为<code>2.1.1</code>版本后，新增了<code>gRPC</code>的通信方式，增加了两个<code>偏移量端口9848,9849</code>，在原端口<code>8848</code>基础上面偏移量1000和1001。</p> 
<table><thead><tr><th>端口</th><th>说明</th></tr></thead><tbody><tr><td>原端口: 8848</td><td>服务使用</td></tr><tr><td>偏移量端口1：9848</td><td>客户端gRPC请求服务端端口，用于客户端向服务端发起连接和请求</td></tr><tr><td>偏移量端口2：9849</td><td>服务端gRPC请求服务端端口，用于服务间同步等</td></tr></tbody></table> 
<p>注：<strong>如果开启了防火墙或者使用了容器化部署，需要在阿里云等服务器，容器等，开通相应服务端口：</strong> <code>8848、9848、9849</code></p> 
<h3><a id="22_jar_19"></a>2.2 可能存在jar冲突</h3> 
<p>如果排除冲突还是起不来，只能跟踪错误原因，查看源码了。笔者百度了一些issue，没能解决问题，只能跟踪源码</p> 
<p><strong>查看源码发现，确实是拉取配置时出问题了：</strong><br> <strong>com.alibaba.nacos.client.config.impl.ClientWorker，第778行queryConfig方法，拿不到nacos配置的response</strong><br> <img src="https://images2.imgbox.com/de/11/RsNdo13X_o.png" alt="在这里插入图片描述"></p> 
<p><strong>跟踪源码发现，com.alibaba.nacos.common.remote.client.RpcClient，第468行，这里就是执行不到，发现是currentConnection为空</strong><br> <img src="https://images2.imgbox.com/3e/c6/dJeD3sId_o.png" alt="在这里插入图片描述"></p> 
<p><strong>然后发现，重试了3次都是拉去失败</strong><br> <img src="https://images2.imgbox.com/c7/c0/CXn1LROa_o.png" alt="在这里插入图片描述"></p> 
<p>最后发现，是createNewChannelStub方法，执行有问题，手动可以进入源码，但是debug执行进不去，发现是jar冲突导致，有2个RequestGrpc。原因是，有个小伙伴继承了base脚手架，里面有维护nacos依赖，然后项目又额外引入了依赖：<br> <img src="https://images2.imgbox.com/7e/e3/xdIngfXl_o.png" alt="在这里插入图片描述"></p> 
<p>导致项目有两个RequestGrpc<br> com.alibaba.nacos.api.grpc.auto.RequestGrpc</p> 
<p>导致无法选择唯一的bean去执行，导致连接nacos服务异常，导致currentConnection为空，导致nacos配置拉取失败。最后把<code>nacos-api依赖排除</code>，问题得到了解决。<br> <img src="https://images2.imgbox.com/60/b0/9v9ZaOa5_o.png" alt="在这里插入图片描述"></p> 
<p>这两个依赖里面，<code>RequestGrpc类</code>有冲突，nacos config拉去不到，本地没有配置信息（mac命令：<code>cd ~/nacos/config/</code>）<br> <img src="https://images2.imgbox.com/9a/5e/MTtCN56P_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23_nacos_47"></a>2.3 可能nacos配置不对</h3> 
<p>检查下ip，端口，以及namespace，前缀prefix、file-extension等等</p> 
<blockquote> 
 <p>写博客是为了记住自己容易忘记的东西，另外也是对自己工作的总结，希望尽自己的努力，做到更好，大家一起努力进步！<br><br> 如果有什么问题，欢迎大家一起探讨，代码如有问题，欢迎各位大神指正！<br><br> 给自己的梦想添加一双翅膀，让它可以在天空中自由自在的飞翔！</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f30a9da7c29f110fa7b332af3ba6a423/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于网络带宽单位的转换</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3b2f8b977b600a876507af817b5baa8e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决Windows系统本地代理服务开启情况下创建Conda环境报错</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>