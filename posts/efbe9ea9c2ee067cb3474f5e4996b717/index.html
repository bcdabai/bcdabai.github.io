<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>cJSON学习 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="cJSON学习" />
<meta property="og:description" content="cJSON学习 1、JSON简介 JSON(JavaScript Object Notation, JS 对象标记) 是一种轻量级的数据交换格式。它采用完全独立于编程语言的文本格式来存储和表示数据。简洁和清晰的层次结构使得 JSON 成为理想的数据交换语言。 易于人阅读和编写，同时也易于机器解析和生成，并有效地提升网络传输效率。
2、cJSON解析器下载 https://sourceforge.net/projects/cjson/
3、cJSON分析 3.1、cJSON简介 cJSON是用C语言写的用于解析json字符串和生成json字符串的库，他只有一个头文件和源文件。使用它只需要在自己的项目中加入cJSON.c和cJSON.h文件
3.2、cJSON分析 3.2.1. cJSON的机构体
typedef struct cJSON { //后继和前驱指针 struct cJSON *next,*prev; /* next/prev allow you to walk array/object chains. Alternatively, use GetArraySize/GetArrayItem/GetObjectItem */ //子对象指针 struct cJSON *child; /* An array or object item will have a child pointer pointing to a chain of the items in the array/object. */ //cJSON的类型 int type; /* The type of the item, as above." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/efbe9ea9c2ee067cb3474f5e4996b717/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-01-17T11:28:25+08:00" />
<meta property="article:modified_time" content="2018-01-17T11:28:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">cJSON学习</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2 id="cjson学习">cJSON学习</h2> 
<h3 id="1json简介">1、JSON简介</h3> 
<p>JSON(JavaScript Object Notation, JS 对象标记) 是一种轻量级的数据交换格式。它采用完全独立于编程语言的文本格式来存储和表示数据。简洁和清晰的层次结构使得 JSON 成为理想的数据交换语言。 易于人阅读和编写，同时也易于机器解析和生成，并有效地提升网络传输效率。</p> 
<h3 id="2cjson解析器下载">2、cJSON解析器下载</h3> 
<p><a href="https://sourceforge.net/projects/cjson/" rel="nofollow noopener noreferrer" target="_blank">https://sourceforge.net/projects/cjson/</a></p> 
<h3 id="3cjson分析">3、cJSON分析</h3> 
<h4 id="31cjson简介">3.1、cJSON简介</h4> 
<p>cJSON是用C语言写的用于解析json字符串和生成json字符串的库，他只有一个头文件和源文件。使用它只需要在自己的项目中加入cJSON.c和cJSON.h文件</p> 
<h4 id="32cjson分析">3.2、cJSON分析</h4> 
<p>3.2.1. cJSON的机构体</p> 
<pre class="prettyprint"><code class=" hljs fsharp">typedef <span class="hljs-keyword">struct</span> cJSON {
    <span class="hljs-comment">//后继和前驱指针</span>
    <span class="hljs-keyword">struct</span> cJSON *next,*prev;   /* next/prev allow you <span class="hljs-keyword">to</span> walk array/object chains. Alternatively, <span class="hljs-keyword">use</span> GetArraySize/GetArrayItem/GetObjectItem */
    <span class="hljs-comment">//子对象指针</span>
    <span class="hljs-keyword">struct</span> cJSON *child;        /* An array <span class="hljs-keyword">or</span> object item will have a child pointer pointing <span class="hljs-keyword">to</span> a chain <span class="hljs-keyword">of</span> the items <span class="hljs-keyword">in</span> the array/object. */
    <span class="hljs-comment">//cJSON的类型</span>
    int <span class="hljs-class"><span class="hljs-keyword">type</span>;                   /* <span class="hljs-title">The</span> <span class="hljs-title">type</span> <span class="hljs-title">of</span> <span class="hljs-title">the</span> <span class="hljs-title">item</span>, <span class="hljs-title">as</span> <span class="hljs-title">above</span>. */</span>
    <span class="hljs-comment">//item的值【string、int、double】</span>
    char *valuestring;          /* The item's string, <span class="hljs-keyword">if</span> <span class="hljs-class"><span class="hljs-keyword">type</span>=</span>=cJSON_String */
    int valueint;               /* The item's number, <span class="hljs-keyword">if</span> <span class="hljs-class"><span class="hljs-keyword">type</span>=</span>=cJSON_Number */
    double valuedouble;         /* The item's number, <span class="hljs-keyword">if</span> <span class="hljs-class"><span class="hljs-keyword">type</span>=</span>=cJSON_Number */
    <span class="hljs-comment">//item的名字</span>
    char *string;               /* The item's name string, <span class="hljs-keyword">if</span> this item is the child <span class="hljs-keyword">of</span>, <span class="hljs-keyword">or</span> is <span class="hljs-keyword">in</span> the list <span class="hljs-keyword">of</span> subitems <span class="hljs-keyword">of</span> an object. */
} cJSON;</code></pre> 
<p>3.2.2 cJSON的类型</p> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> cJSON_False 0</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> cJSON_True 1</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> cJSON_NULL 2</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> cJSON_Number 3</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> cJSON_String 4</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> cJSON_Array 5</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> cJSON_Object 6</span>

<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> cJSON_IsReference 256</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> cJSON_StringIsConst 512</span></code></pre> 
<p>3.2.3 使用cJSON解析json字符串 <br> 使用到函数：</p> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-comment">//解析</span>
<span class="hljs-keyword">extern</span> cJSON *cJSON_Parse(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">value</span>);
<span class="hljs-comment">//打印</span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">char</span>  *cJSON_Print(cJSON *item);</code></pre> 
<p>例子：来源于<a href="https://www.cnblogs.com/catgatp/p/6379955.html" rel="nofollow noopener noreferrer" target="_blank">https://www.cnblogs.com/catgatp/p/6379955.html</a>：</p> 
<pre class="prettyprint"><code class=" hljs json">{
    "<span class="hljs-attribute">semantic</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">slots</span>":    <span class="hljs-value">{
            "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"张三"</span>
        </span>}
    </span>}</span>,
    "<span class="hljs-attribute">rc</span>":   <span class="hljs-value"><span class="hljs-number">0</span></span>,
    "<span class="hljs-attribute">operation</span>":    <span class="hljs-value"><span class="hljs-string">"CALL"</span></span>,
    "<span class="hljs-attribute">service</span>":  <span class="hljs-value"><span class="hljs-string">"telephone"</span></span>,
    "<span class="hljs-attribute">text</span>": <span class="hljs-value"><span class="hljs-string">"打电话给张三"</span>
</span>}</code></pre> 
<pre class="prettyprint"><code class=" hljs perl"><span class="hljs-comment">#include &lt;stdio.h&gt;</span>
<span class="hljs-comment">#include &lt;stdlib.h&gt;</span>
<span class="hljs-comment">#include "cJSON.h"</span>

void printJson(cJSON * root)//以递归的方式打印json的最内层键值对
{
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;cJSON_GetArraySize(root); i++)   //遍历最外层json键值对
    {
        cJSON * item = cJSON_GetArrayItem(root, i);        
        <span class="hljs-keyword">if</span>(cJSON_Object == item-&gt;type)      //如果对应键的值仍为cJSON_Object就递归调用printJson
            printJson(item);
        <span class="hljs-keyword">else</span>                                //值不为json对象就直接打印出键和值
        {
            <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>-&gt;"</span>, item-&gt;string);
            <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>\n"</span>, cJSON_Print(item));
        }
    }
}

<span class="hljs-keyword">int</span> main()
{
    char * jsonStr = <span class="hljs-string">"{\"semantic\":{\"slots\":{\"name\":\"张三\"}}, \"rc\":0, \"operation\":\"CALL\", \"service\":\"telephone\", \"text\":\"打电话给张三\"}"</span>;
    cJSON * root = NULL;
    cJSON * item = NULL;<span class="hljs-regexp">//cjson</span>对象

    root = cJSON_Parse(jsonStr);     
    <span class="hljs-keyword">if</span> (!root) 
    {
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"Error before: [<span class="hljs-variable">%s</span>]\n"</span>,cJSON_GetErrorPtr());
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>\n"</span>, <span class="hljs-string">"有格式的方式打印Json:"</span>);           
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>\n\n"</span>, cJSON_Print(root));
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>\n"</span>, <span class="hljs-string">"无格式方式打印json："</span>);
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>\n\n"</span>, cJSON_PrintUnformatted(root));

        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>\n"</span>, <span class="hljs-string">"一步一步的获取name 键值对:"</span>);
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>\n"</span>, <span class="hljs-string">"获取semantic下的cjson对象:"</span>);
        item = cJSON_GetObjectItem(root, <span class="hljs-string">"semantic"</span>);<span class="hljs-regexp">//</span>
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>\n"</span>, cJSON_Print(item));
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>\n"</span>, <span class="hljs-string">"获取slots下的cjson对象"</span>);
        item = cJSON_GetObjectItem(item, <span class="hljs-string">"slots"</span>);
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>\n"</span>, cJSON_Print(item));
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>\n"</span>, <span class="hljs-string">"获取name下的cjson对象"</span>);
        item = cJSON_GetObjectItem(item, <span class="hljs-string">"name"</span>);
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>\n"</span>, cJSON_Print(item));

        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>:"</span>, item-&gt;string);   <span class="hljs-regexp">//</span>看一下cjson对象的结构体中这两个成员的意思
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"<span class="hljs-variable">%s</span>\n"</span>, item-&gt;valuestring);


        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"\n<span class="hljs-variable">%s</span>\n"</span>, <span class="hljs-string">"打印json所有最内层键值对:"</span>);
        printJson(root);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;    
}</code></pre> 
<p>cJSON创建的结构体如下图所示： <br> <img src="https://images2.imgbox.com/aa/e1/tyAPSbTb_o.jpg" alt="这里写图片描述" title=""></p> 
<pre class="prettyprint"><code class=" hljs fix"><span class="hljs-attribute">root </span>=<span class="hljs-string"> cJSON_Parse(jsonStr);  
传入jsonStr的json字符串cJSON_Parse返回一个指向双向链表的指针。
注意！！！！头结点不是双向链表的第一个节点的prev，第一个节点的前驱为NULL，这在cJSON的源代码中多处有判断。</span></code></pre> 
<h4 id="33-源码分析">3.3 源码分析</h4> 
<pre class="prettyprint"><code class=" hljs markdown">/*
  Copyright (c) 2009 Dave Gamble

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
  THE SOFTWARE.
*/

<span class="hljs-header">#ifndef cJSON__h</span>
<span class="hljs-header">#define cJSON__h</span>

<span class="hljs-header">#ifdef __cplusplus</span>
extern "C"
{
<span class="hljs-header">#endif</span>
/<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*
<span class="hljs-code">        cJSON的类型</span>
<span class="hljs-code">        cJSON Types:</span>
<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*/
<span class="hljs-header">#define cJSON_False 0</span>
<span class="hljs-header">#define cJSON_True 1</span>
<span class="hljs-header">#define cJSON_NULL 2</span>
<span class="hljs-header">#define cJSON_Number 3</span>
<span class="hljs-header">#define cJSON_String 4</span>
<span class="hljs-header">#define cJSON_Array 5</span>
<span class="hljs-header">#define cJSON_Object 6</span>

<span class="hljs-header">#define cJSON_IsReference 256</span>
<span class="hljs-header">#define cJSON_StringIsConst 512</span>

/<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*
<span class="hljs-bullet">*            </span>cJSON的结构体
<span class="hljs-bullet">*            </span>The cJSON structure:
<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*/
typedef struct cJSON {
<span class="hljs-code">    //后继和前驱指针</span>
<span class="hljs-code">    struct cJSON *next,*prev;   /* next/prev allow you to walk array/object chains. Alternatively, use GetArraySize/GetArrayItem/GetObjectItem */</span>
<span class="hljs-code">    //子对象指针</span>
<span class="hljs-code">    struct cJSON *child;        /* An array or object item will have a child pointer pointing to a chain of the items in the array/object. */</span>
<span class="hljs-code">    //cJSON的类型</span>
<span class="hljs-code">    int type;                   /* The type of the item, as above. */</span>
<span class="hljs-code">    //item的值【string、int、double】</span>
<span class="hljs-code">    char *valuestring;          /* The item's string, if type==cJSON_String */</span>
<span class="hljs-code">    int valueint;               /* The item's number, if type==cJSON_Number */</span>
<span class="hljs-code">    double valuedouble;         /* The item's number, if type==cJSON_Number */</span>
<span class="hljs-code">    //item的名字</span>
<span class="hljs-code">    char *string;               /* The item's name string, if this item is the child of, or is in the list of subitems of an object. */</span>
} cJSON;

typedef struct cJSON_Hooks {
<span class="hljs-code">      void *(*malloc_fn)(size_t sz);</span>
<span class="hljs-code">      void (*free_fn)(void *ptr);</span>
} cJSON_Hooks;

/<span class="hljs-bullet">* Supply malloc, realloc and free functions to cJSON *</span>/
extern void cJSON<span class="hljs-emphasis">_InitHooks(cJSON_</span>Hooks* hooks);


//解析
/<span class="hljs-bullet">* Supply a block of JSON, and this returns a cJSON object you can interrogate. Call cJSON_Delete when finished. *</span>/
extern cJSON <span class="hljs-emphasis">*cJSON_Parse(const char *</span>value);
/<span class="hljs-bullet">* Render a cJSON entity to text for transfer/storage. Free the char*</span> when finished. */
//打印
extern char  <span class="hljs-emphasis">*cJSON_Print(cJSON *</span>item);
/<span class="hljs-bullet">* Render a cJSON entity to text for transfer/storage without any formatting. Free the char*</span> when finished. */
extern char  <span class="hljs-emphasis">*cJSON_PrintUnformatted(cJSON *</span>item);
/<span class="hljs-bullet">* Render a cJSON entity to text using a buffered strategy. prebuffer is a guess at the final size. guessing well reduces reallocation. fmt=0 gives unformatted, =1 gives formatted *</span>/
extern char <span class="hljs-emphasis">*cJSON_PrintBuffered(cJSON *</span>item,int prebuffer,int fmt);
/<span class="hljs-bullet">* Delete a cJSON entity and all subentities. *</span>/
extern void   cJSON_Delete(cJSON *c);

//返回cJSON中item的个数
/<span class="hljs-bullet">* Returns the number of items in an array (or object). *</span>/
extern int    cJSON_GetArraySize(cJSON *array);
//返回索引为item的cJSON对象
/<span class="hljs-bullet">* Retrieve item number "item" from array "array". Returns NULL if unsuccessful. *</span>/
extern cJSON <span class="hljs-emphasis">*cJSON_GetArrayItem(cJSON *</span>array,int item);
//返回item为string的cJSON对象【大小写不敏感】
/<span class="hljs-bullet">* Get item "string" from object. Case insensitive. *</span>/
extern cJSON <span class="hljs-emphasis">*cJSON_GetObjectItem(cJSON *</span>object,const char *string);

//返回解析cJSON对象错误时对应的字符串
/* For analysing failed parses. This returns a pointer to the parse error. 
You'll probably need to look a few chars back to make sense of it.
Defined when cJSON<span class="hljs-emphasis">_Parse() returns 0. 0 when cJSON_</span>Parse() succeeds. */
extern const char *cJSON_GetErrorPtr(void);


/<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*
<span class="hljs-bullet">*           </span>返回创建的对应cJSON对象
<span class="hljs-bullet">*           </span>These calls create a cJSON item of the appropriate type. 
<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*/
extern cJSON *cJSON_CreateNull(void);
extern cJSON *cJSON_CreateTrue(void);
extern cJSON *cJSON_CreateFalse(void);
extern cJSON *cJSON_CreateBool(int b);
extern cJSON *cJSON_CreateNumber(double num);
extern cJSON <span class="hljs-emphasis">*cJSON_CreateString(const char *</span>string);
extern cJSON *cJSON_CreateArray(void);
extern cJSON *cJSON_CreateObject(void);


/<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*
<span class="hljs-bullet">*           </span>创建count个数组cJSON对象
<span class="hljs-bullet">*           </span>These utilities create an Array of count items.
<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*/
extern cJSON <span class="hljs-emphasis">*cJSON_CreateIntArray(const int *</span>numbers,int count);
extern cJSON <span class="hljs-emphasis">*cJSON_CreateFloatArray(const float *</span>numbers,int count);
extern cJSON <span class="hljs-emphasis">*cJSON_CreateDoubleArray(const double *</span>numbers,int count);
extern cJSON <span class="hljs-emphasis">*cJSON_CreateStringArray(const char *</span>*strings,int count);

/<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*
<span class="hljs-code">            添加item到特定的数组/对象cJSON中</span>
<span class="hljs-code">            Append item to the specified array/object.</span>
<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*/
extern void cJSON_AddItemToArray(cJSON <span class="hljs-emphasis">*array, cJSON *</span>item);
extern void cJSON_AddItemToObject(cJSON <span class="hljs-emphasis">*object,const char *</span>string,cJSON *item);
extern void cJSON_AddItemToObjectCS(cJSON <span class="hljs-emphasis">*object,const char *</span>string,cJSON <span class="hljs-emphasis">*item);  /*</span> Use this when string is definitely const (i.e. a literal, or as good as), and will definitely survive the cJSON object */
/<span class="hljs-bullet">* Append reference to item to the specified array/object. Use this when you want to add an existing cJSON to a new cJSON, but don't want to corrupt your existing cJSON. *</span>/
extern void cJSON_AddItemReferenceToArray(cJSON <span class="hljs-emphasis">*array, cJSON *</span>item);
extern void cJSON_AddItemReferenceToObject(cJSON <span class="hljs-emphasis">*object,const char *</span>string,cJSON *item);

/<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*
<span class="hljs-code">            从数组或者对象中移除/删除item</span>
<span class="hljs-code">            Remove/Detatch items from Arrays/Objects.</span>
<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*/
extern cJSON <span class="hljs-emphasis">*cJSON_DetachItemFromArray(cJSON *</span>array,int which);
extern void   cJSON_DeleteItemFromArray(cJSON *array,int which);
extern cJSON <span class="hljs-emphasis">*cJSON_DetachItemFromObject(cJSON *</span>object,const char *string);
extern void   cJSON_DeleteItemFromObject(cJSON <span class="hljs-emphasis">*object,const char *</span>string);
/<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*
<span class="hljs-code">            插入或者替换双向链表中的节点</span>
<span class="hljs-code">            Update array items.</span>
<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*/
extern void cJSON_InsertItemInArray(cJSON <span class="hljs-emphasis">*array,int which,cJSON *</span>newitem); /<span class="hljs-bullet">* Shifts pre-existing items to the right. *</span>/
extern void cJSON_ReplaceItemInArray(cJSON <span class="hljs-emphasis">*array,int which,cJSON *</span>newitem);
extern void cJSON_ReplaceItemInObject(cJSON <span class="hljs-emphasis">*object,const char *</span>string,cJSON *newitem);

/<span class="hljs-bullet">* Duplicate a cJSON item *</span>/
extern cJSON <span class="hljs-emphasis">*cJSON_Duplicate(cJSON *</span>item,int recurse);
/* Duplicate will create a new, identical cJSON item to the one you pass, in new memory that will
need to be released. With recurse!=0, it will duplicate any children connected to the item.
The item-&gt;next and -&gt;prev pointers are always zero on return from Duplicate. */

/<span class="hljs-bullet">* ParseWithOpts allows you to require (and check) that the JSON is null terminated, and to retrieve the pointer to the final byte parsed. *</span>/
extern cJSON <span class="hljs-emphasis">*cJSON_ParseWithOpts(const char *</span>value,const char **return<span class="hljs-emphasis">_parse_</span>end,int require<span class="hljs-emphasis">_null_</span>terminated);

extern void cJSON_Minify(char *json);
/<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*
<span class="hljs-code">            快速创建对象的宏</span>
<span class="hljs-code">            Macros for creating things quickly.</span>
<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*/
<span class="hljs-header">#define cJSON_AddNullToObject(object,name)      cJSON_AddItemToObject(object, name, cJSON_CreateNull())</span>
<span class="hljs-header">#define cJSON_AddTrueToObject(object,name)      cJSON_AddItemToObject(object, name, cJSON_CreateTrue())</span>
<span class="hljs-header">#define cJSON_AddFalseToObject(object,name)     cJSON_AddItemToObject(object, name, cJSON_CreateFalse())</span>
<span class="hljs-header">#define cJSON_AddBoolToObject(object,name,b)    cJSON_AddItemToObject(object, name, cJSON_CreateBool(b))</span>
<span class="hljs-header">#define cJSON_AddNumberToObject(object,name,n)  cJSON_AddItemToObject(object, name, cJSON_CreateNumber(n))</span>
<span class="hljs-header">#define cJSON_AddStringToObject(object,name,s)  cJSON_AddItemToObject(object, name, cJSON_CreateString(s))</span>

/<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*
<span class="hljs-code">            设置对象值的宏</span>
<span class="hljs-code">            When assigning an integer value, it needs to be propagated to valuedouble too.</span>
<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>*/
<span class="hljs-header">#define cJSON_SetIntValue(object,val)           ((object)?(object)-&gt;valueint=(object)-&gt;valuedouble=(val):(val))</span>
<span class="hljs-header">#define cJSON_SetNumberValue(object,val)        ((object)?(object)-&gt;valueint=(object)-&gt;valuedouble=(val):(val))</span>

<span class="hljs-header">#ifdef __cplusplus</span>
}
<span class="hljs-header">#endif</span>

<span class="hljs-header">#endif</span>
</code></pre> 
<pre class="prettyprint"><code class=" hljs cs"><span class="hljs-comment">/*
  Copyright (c) 2009 Dave Gamble

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
  THE SOFTWARE.
*/</span>

<span class="hljs-comment">/* cJSON */</span>
<span class="hljs-comment">/* JSON parser in C. */</span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span>
<span class="hljs-preprocessor">#include &lt;string.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;stdio.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;math.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;float.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;limits.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;ctype.h&gt;</span>
<span class="hljs-preprocessor">#include "cJSON.h"</span>

<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *ep;

<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *cJSON_GetErrorPtr(<span class="hljs-keyword">void</span>) {<!-- --><span class="hljs-keyword">return</span> ep;}

<span class="hljs-comment">//无大小字符串比较</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> cJSON_strcasecmp(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *s1,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *s2)
{
    <span class="hljs-keyword">if</span> (!s1) <span class="hljs-keyword">return</span> (s1==s2)?<span class="hljs-number">0</span>:<span class="hljs-number">1</span>;<span class="hljs-keyword">if</span> (!s2) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span>(; tolower(*s1) == tolower(*s2); ++s1, ++s2) <span class="hljs-keyword">if</span>(*s1 == <span class="hljs-number">0</span>)    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> tolower(*(<span class="hljs-keyword">const</span> unsigned <span class="hljs-keyword">char</span> *)s1) - tolower(*(<span class="hljs-keyword">const</span> unsigned <span class="hljs-keyword">char</span> *)s2);
}

<span class="hljs-comment">//cJSON的内存申请释放赋初值</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *(*cJSON_malloc)(size_t sz) = malloc;
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> (*cJSON_free)(<span class="hljs-keyword">void</span> *ptr) = free;

<span class="hljs-comment">//字符串深拷贝【string_duplicate】</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span>* cJSON_strdup(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* str)
{
      size_t len;
      <span class="hljs-keyword">char</span>* copy;

      len = strlen(str) + <span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span> (!(copy = (<span class="hljs-keyword">char</span>*)cJSON_malloc(len))) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
      memcpy(copy,str,len);
      <span class="hljs-keyword">return</span> copy;
}

<span class="hljs-comment">//初始化cJSON的malloc和free</span>
<span class="hljs-keyword">void</span> cJSON_InitHooks(cJSON_Hooks* hooks)
{
    <span class="hljs-keyword">if</span> (!hooks) { <span class="hljs-comment">/* Reset hooks */</span>
        cJSON_malloc = malloc;
        cJSON_free = free;
        <span class="hljs-keyword">return</span>;
    }

    cJSON_malloc = (hooks-&gt;malloc_fn)?hooks-&gt;malloc_fn:malloc;
    cJSON_free   = (hooks-&gt;free_fn)?hooks-&gt;free_fn:free;
}

<span class="hljs-comment">//构造cJSON结构体并初始化为0</span>
<span class="hljs-comment">/* Internal constructor. */</span>
<span class="hljs-keyword">static</span> cJSON *cJSON_New_Item(<span class="hljs-keyword">void</span>)
{
    cJSON* node = (cJSON*)cJSON_malloc(<span class="hljs-keyword">sizeof</span>(cJSON));
    <span class="hljs-keyword">if</span> (node) memset(node,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(cJSON));
    <span class="hljs-keyword">return</span> node;
}

<span class="hljs-comment">//删除cJSON结构体</span>
<span class="hljs-comment">/* Delete a cJSON structure. */</span>
<span class="hljs-keyword">void</span> cJSON_Delete(cJSON *c)
{
    cJSON *next;
    <span class="hljs-keyword">while</span> (c)
    {
        next=c-&gt;next;
        <span class="hljs-comment">//不是引用且有孩子则递归删除</span>
        <span class="hljs-keyword">if</span> (!(c-&gt;type&amp;cJSON_IsReference) &amp;&amp; c-&gt;child) cJSON_Delete(c-&gt;child);
        <span class="hljs-comment">//不是引用且为字符串值</span>
        <span class="hljs-keyword">if</span> (!(c-&gt;type&amp;cJSON_IsReference) &amp;&amp; c-&gt;valuestring) cJSON_free(c-&gt;valuestring);
        <span class="hljs-comment">//不是应有且有名称</span>
        <span class="hljs-keyword">if</span> (!(c-&gt;type&amp;cJSON_StringIsConst) &amp;&amp; c-&gt;<span class="hljs-keyword">string</span>) cJSON_free(c-&gt;<span class="hljs-keyword">string</span>);
        <span class="hljs-comment">//释放节点内存</span>
        cJSON_free(c);
        c=next;
    }
}

<span class="hljs-comment">//解析数值</span>
<span class="hljs-comment">/* Parse the input text to generate a number, and populate the result into item. */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *parse_number(cJSON *item,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *num)
{
    <span class="hljs-keyword">double</span> n=<span class="hljs-number">0</span>,sign=<span class="hljs-number">1</span>,scale=<span class="hljs-number">0</span>;<span class="hljs-keyword">int</span> subscale=<span class="hljs-number">0</span>,signsubscale=<span class="hljs-number">1</span>;

    <span class="hljs-keyword">if</span> (*num==<span class="hljs-string">'-'</span>) sign=-<span class="hljs-number">1</span>,num++;   <span class="hljs-comment">/* Has sign? */</span>
    <span class="hljs-keyword">if</span> (*num==<span class="hljs-string">'0'</span>) num++;           <span class="hljs-comment">/* is zero */</span>
    <span class="hljs-keyword">if</span> (*num&gt;=<span class="hljs-string">'1'</span> &amp;&amp; *num&lt;=<span class="hljs-string">'9'</span>) <span class="hljs-keyword">do</span>  n=(n*<span class="hljs-number">10.0</span>)+(*num++ -<span class="hljs-string">'0'</span>);   <span class="hljs-keyword">while</span> (*num&gt;=<span class="hljs-string">'0'</span> &amp;&amp; *num&lt;=<span class="hljs-string">'9'</span>); <span class="hljs-comment">/* Number? */</span>
    <span class="hljs-keyword">if</span> (*num==<span class="hljs-string">'.'</span> &amp;&amp; num[<span class="hljs-number">1</span>]&gt;=<span class="hljs-string">'0'</span> &amp;&amp; num[<span class="hljs-number">1</span>]&lt;=<span class="hljs-string">'9'</span>) {num++;        <span class="hljs-keyword">do</span>  n=(n*<span class="hljs-number">10.0</span>)+(*num++ -<span class="hljs-string">'0'</span>),scale--; <span class="hljs-keyword">while</span> (*num&gt;=<span class="hljs-string">'0'</span> &amp;&amp; *num&lt;=<span class="hljs-string">'9'</span>);}  <span class="hljs-comment">/* Fractional part? */</span>
    <span class="hljs-keyword">if</span> (*num==<span class="hljs-string">'e'</span> || *num==<span class="hljs-string">'E'</span>)     <span class="hljs-comment">/* Exponent? */</span>
    {   num++;<span class="hljs-keyword">if</span> (*num==<span class="hljs-string">'+'</span>) num++; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*num==<span class="hljs-string">'-'</span>) signsubscale=-<span class="hljs-number">1</span>,num++;      <span class="hljs-comment">/* With sign? */</span>
        <span class="hljs-keyword">while</span> (*num&gt;=<span class="hljs-string">'0'</span> &amp;&amp; *num&lt;=<span class="hljs-string">'9'</span>) subscale=(subscale*<span class="hljs-number">10</span>)+(*num++ - <span class="hljs-string">'0'</span>);   <span class="hljs-comment">/* Number? */</span>
    }

    n=sign*n*pow(<span class="hljs-number">10.0</span>,(scale+subscale*signsubscale));   <span class="hljs-comment">/* number = +/- number.fraction * 10^+/- exponent */</span>

    item-&gt;valuedouble=n;
    item-&gt;valueint=(<span class="hljs-keyword">int</span>)n;
    item-&gt;type=cJSON_Number;
    <span class="hljs-keyword">return</span> num;
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> pow2gt (<span class="hljs-keyword">int</span> x)   {   --x;    x|=x&gt;&gt;<span class="hljs-number">1</span>;    x|=x&gt;&gt;<span class="hljs-number">2</span>;    x|=x&gt;&gt;<span class="hljs-number">4</span>;    x|=x&gt;&gt;<span class="hljs-number">8</span>;    x|=x&gt;&gt;<span class="hljs-number">16</span>;   <span class="hljs-keyword">return</span> x+<span class="hljs-number">1</span>; }

typedef <span class="hljs-keyword">struct</span> {
    <span class="hljs-keyword">char</span> *buffer; 
    <span class="hljs-keyword">int</span> length;
    <span class="hljs-keyword">int</span> offset; 
} printbuffer;

<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span>* ensure(printbuffer *p,<span class="hljs-keyword">int</span> needed)
{
    <span class="hljs-keyword">char</span> *newbuffer;<span class="hljs-keyword">int</span> newsize;
    <span class="hljs-keyword">if</span> (!p || !p-&gt;buffer) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    needed+=p-&gt;offset;
    <span class="hljs-keyword">if</span> (needed&lt;=p-&gt;length) <span class="hljs-keyword">return</span> p-&gt;buffer+p-&gt;offset;

    newsize=pow2gt(needed);
    newbuffer=(<span class="hljs-keyword">char</span>*)cJSON_malloc(newsize);
    <span class="hljs-keyword">if</span> (!newbuffer) {cJSON_free(p-&gt;buffer);p-&gt;length=<span class="hljs-number">0</span>,p-&gt;buffer=<span class="hljs-number">0</span>;<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}
    <span class="hljs-keyword">if</span> (newbuffer) memcpy(newbuffer,p-&gt;buffer,p-&gt;length);
    cJSON_free(p-&gt;buffer);
    p-&gt;length=newsize;
    p-&gt;buffer=newbuffer;
    <span class="hljs-keyword">return</span> newbuffer+p-&gt;offset;
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> update(printbuffer *p)
{
    <span class="hljs-keyword">char</span> *str;
    <span class="hljs-keyword">if</span> (!p || !p-&gt;buffer) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    str=p-&gt;buffer+p-&gt;offset;
    <span class="hljs-keyword">return</span> p-&gt;offset+strlen(str);
}

<span class="hljs-comment">//打印数值</span>
<span class="hljs-comment">/* Render the number nicely from the given item into a string. */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *print_number(cJSON *item,printbuffer *p)
{
    <span class="hljs-keyword">char</span> *str=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">double</span> d=item-&gt;valuedouble;
    <span class="hljs-comment">//0</span>
    <span class="hljs-keyword">if</span> (d==<span class="hljs-number">0</span>)
    {
        <span class="hljs-keyword">if</span> (p)  str=ensure(p,<span class="hljs-number">2</span>);
        <span class="hljs-keyword">else</span>    str=(<span class="hljs-keyword">char</span>*)cJSON_malloc(<span class="hljs-number">2</span>); <span class="hljs-comment">/* special case for 0. */</span>
        <span class="hljs-keyword">if</span> (str) strcpy(str,<span class="hljs-string">"0"</span>);
    }
    <span class="hljs-comment">//整数</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fabs(((<span class="hljs-keyword">double</span>)item-&gt;valueint)-d)&lt;=DBL_EPSILON &amp;&amp; d&lt;=INT_MAX &amp;&amp; d&gt;=INT_MIN)
    {
        <span class="hljs-keyword">if</span> (p)  str=ensure(p,<span class="hljs-number">21</span>);
        <span class="hljs-keyword">else</span>    str=(<span class="hljs-keyword">char</span>*)cJSON_malloc(<span class="hljs-number">21</span>);    <span class="hljs-comment">/* 2^64+1 can be represented in 21 chars. */</span>
        <span class="hljs-keyword">if</span> (str)    sprintf(str,<span class="hljs-string">"%d"</span>,item-&gt;valueint);
    }
    <span class="hljs-comment">//浮点数</span>
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-keyword">if</span> (p)  str=ensure(p,<span class="hljs-number">64</span>);
        <span class="hljs-keyword">else</span>    str=(<span class="hljs-keyword">char</span>*)cJSON_malloc(<span class="hljs-number">64</span>);    <span class="hljs-comment">/* This is a nice tradeoff. */</span>
        <span class="hljs-keyword">if</span> (str)
        {
            <span class="hljs-keyword">if</span> (fabs(floor(d)-d)&lt;=DBL_EPSILON &amp;&amp; fabs(d)&lt;<span class="hljs-number">1.0e60</span>)sprintf(str,<span class="hljs-string">"%.0f"</span>,d);
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fabs(d)&lt;<span class="hljs-number">1.0e-6</span> || fabs(d)&gt;<span class="hljs-number">1.0e9</span>)           sprintf(str,<span class="hljs-string">"%e"</span>,d);
            <span class="hljs-keyword">else</span>                                                sprintf(str,<span class="hljs-string">"%f"</span>,d);
        }
    }
    <span class="hljs-keyword">return</span> str;
}

<span class="hljs-comment">//将4字节的16进制转化为无符号整型</span>
<span class="hljs-keyword">static</span> unsigned parse_hex4(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *str)
{
    unsigned h=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (*str&gt;=<span class="hljs-string">'0'</span> &amp;&amp; *str&lt;=<span class="hljs-string">'9'</span>) h+=(*str)-<span class="hljs-string">'0'</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*str&gt;=<span class="hljs-string">'A'</span> &amp;&amp; *str&lt;=<span class="hljs-string">'F'</span>) h+=<span class="hljs-number">10</span>+(*str)-<span class="hljs-string">'A'</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*str&gt;=<span class="hljs-string">'a'</span> &amp;&amp; *str&lt;=<span class="hljs-string">'f'</span>) h+=<span class="hljs-number">10</span>+(*str)-<span class="hljs-string">'a'</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    h=h&lt;&lt;<span class="hljs-number">4</span>;str++;
    <span class="hljs-keyword">if</span> (*str&gt;=<span class="hljs-string">'0'</span> &amp;&amp; *str&lt;=<span class="hljs-string">'9'</span>) h+=(*str)-<span class="hljs-string">'0'</span>; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*str&gt;=<span class="hljs-string">'A'</span> &amp;&amp; *str&lt;=<span class="hljs-string">'F'</span>) h+=<span class="hljs-number">10</span>+(*str)-<span class="hljs-string">'A'</span>; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*str&gt;=<span class="hljs-string">'a'</span> &amp;&amp; *str&lt;=<span class="hljs-string">'f'</span>) h+=<span class="hljs-number">10</span>+(*str)-<span class="hljs-string">'a'</span>; <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    h=h&lt;&lt;<span class="hljs-number">4</span>;str++;
    <span class="hljs-keyword">if</span> (*str&gt;=<span class="hljs-string">'0'</span> &amp;&amp; *str&lt;=<span class="hljs-string">'9'</span>) h+=(*str)-<span class="hljs-string">'0'</span>; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*str&gt;=<span class="hljs-string">'A'</span> &amp;&amp; *str&lt;=<span class="hljs-string">'F'</span>) h+=<span class="hljs-number">10</span>+(*str)-<span class="hljs-string">'A'</span>; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*str&gt;=<span class="hljs-string">'a'</span> &amp;&amp; *str&lt;=<span class="hljs-string">'f'</span>) h+=<span class="hljs-number">10</span>+(*str)-<span class="hljs-string">'a'</span>; <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    h=h&lt;&lt;<span class="hljs-number">4</span>;str++;
    <span class="hljs-keyword">if</span> (*str&gt;=<span class="hljs-string">'0'</span> &amp;&amp; *str&lt;=<span class="hljs-string">'9'</span>) h+=(*str)-<span class="hljs-string">'0'</span>; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*str&gt;=<span class="hljs-string">'A'</span> &amp;&amp; *str&lt;=<span class="hljs-string">'F'</span>) h+=<span class="hljs-number">10</span>+(*str)-<span class="hljs-string">'A'</span>; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*str&gt;=<span class="hljs-string">'a'</span> &amp;&amp; *str&lt;=<span class="hljs-string">'f'</span>) h+=<span class="hljs-number">10</span>+(*str)-<span class="hljs-string">'a'</span>; <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> h;
}

<span class="hljs-comment">/* Parse the input text into an unescaped cstring, and populate item. */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> unsigned <span class="hljs-keyword">char</span> firstByteMark[<span class="hljs-number">7</span>] = { <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xC0</span>, <span class="hljs-number">0xE0</span>, <span class="hljs-number">0xF0</span>, <span class="hljs-number">0xF8</span>, <span class="hljs-number">0xFC</span> };

<span class="hljs-comment">//解析字符串</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *parse_string(cJSON *item,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *str)
{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *ptr=str+<span class="hljs-number">1</span>;
    <span class="hljs-keyword">char</span> *ptr2;
    <span class="hljs-keyword">char</span> *<span class="hljs-keyword">out</span>;
    <span class="hljs-keyword">int</span> len=<span class="hljs-number">0</span>;
    unsigned uc,uc2;
    <span class="hljs-keyword">if</span> (*str!=<span class="hljs-string">'\"'</span>) {ep=str;<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}  <span class="hljs-comment">/* not a string! */</span>

    <span class="hljs-comment">//\"与\"之间的字符个数</span>
    <span class="hljs-keyword">while</span> (*ptr!=<span class="hljs-string">'\"'</span> &amp;&amp; *ptr &amp;&amp; ++len) 
        <span class="hljs-keyword">if</span> (*ptr++ == <span class="hljs-string">'\\'</span>)
            ptr++;  <span class="hljs-comment">/* Skip escaped quotes. */</span>

    <span class="hljs-keyword">out</span>=(<span class="hljs-keyword">char</span>*)cJSON_malloc(len+<span class="hljs-number">1</span>); <span class="hljs-comment">/* This is how long we need for the string, roughly. */</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">out</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    ptr=str+<span class="hljs-number">1</span>;
    ptr2=<span class="hljs-keyword">out</span>;
    <span class="hljs-keyword">while</span> (*ptr!=<span class="hljs-string">'\"'</span> &amp;&amp; *ptr)
    {
        <span class="hljs-keyword">if</span> (*ptr!=<span class="hljs-string">'\\'</span>) *ptr2++=*ptr++;
        <span class="hljs-keyword">else</span>
        {
            ptr++;
            <span class="hljs-keyword">switch</span> (*ptr)
            {
                <span class="hljs-keyword">case</span> <span class="hljs-string">'b'</span>: *ptr2++=<span class="hljs-string">'\b'</span>; <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'f'</span>: *ptr2++=<span class="hljs-string">'\f'</span>; <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'n'</span>: *ptr2++=<span class="hljs-string">'\n'</span>; <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'r'</span>: *ptr2++=<span class="hljs-string">'\r'</span>; <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'t'</span>: *ptr2++=<span class="hljs-string">'\t'</span>; <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'u'</span>:    <span class="hljs-comment">/* transcode utf16 to utf8. */</span>
                    uc=parse_hex4(ptr+<span class="hljs-number">1</span>);ptr+=<span class="hljs-number">4</span>;    <span class="hljs-comment">/* get the unicode char. */</span>

                    <span class="hljs-keyword">if</span> ((uc&gt;=<span class="hljs-number">0xDC00</span> &amp;&amp; uc&lt;=<span class="hljs-number">0xDFFF</span>) || uc==<span class="hljs-number">0</span>)    <span class="hljs-keyword">break</span>;  <span class="hljs-comment">/* check for invalid.   */</span>

                    <span class="hljs-keyword">if</span> (uc&gt;=<span class="hljs-number">0xD800</span> &amp;&amp; uc&lt;=<span class="hljs-number">0xDBFF</span>)   <span class="hljs-comment">/* UTF16 surrogate pairs.   */</span>
                    {
                        <span class="hljs-keyword">if</span> (ptr[<span class="hljs-number">1</span>]!=<span class="hljs-string">'\\'</span> || ptr[<span class="hljs-number">2</span>]!=<span class="hljs-string">'u'</span>)    <span class="hljs-keyword">break</span>;  <span class="hljs-comment">/* missing second-half of surrogate.    */</span>
                        uc2=parse_hex4(ptr+<span class="hljs-number">3</span>);ptr+=<span class="hljs-number">6</span>;
                        <span class="hljs-keyword">if</span> (uc2&lt;<span class="hljs-number">0xDC00</span> || uc2&gt;<span class="hljs-number">0xDFFF</span>)       <span class="hljs-keyword">break</span>;  <span class="hljs-comment">/* invalid second-half of surrogate.    */</span>
                        uc=<span class="hljs-number">0x10000</span> + (((uc&amp;<span class="hljs-number">0x3FF</span>)&lt;&lt;<span class="hljs-number">10</span>) | (uc2&amp;<span class="hljs-number">0x3FF</span>));
                    }

                    len=<span class="hljs-number">4</span>;<span class="hljs-keyword">if</span> (uc&lt;<span class="hljs-number">0x80</span>) len=<span class="hljs-number">1</span>;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uc&lt;<span class="hljs-number">0x800</span>) len=<span class="hljs-number">2</span>;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uc&lt;<span class="hljs-number">0x10000</span>) len=<span class="hljs-number">3</span>; ptr2+=len;

                    <span class="hljs-keyword">switch</span> (len) {
                        <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: *--ptr2 =((uc | <span class="hljs-number">0x80</span>) &amp; <span class="hljs-number">0xBF</span>); uc &gt;&gt;= <span class="hljs-number">6</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: *--ptr2 =((uc | <span class="hljs-number">0x80</span>) &amp; <span class="hljs-number">0xBF</span>); uc &gt;&gt;= <span class="hljs-number">6</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: *--ptr2 =((uc | <span class="hljs-number">0x80</span>) &amp; <span class="hljs-number">0xBF</span>); uc &gt;&gt;= <span class="hljs-number">6</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: *--ptr2 =(uc | firstByteMark[len]);
                    }
                    ptr2+=len;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:  *ptr2++=*ptr; <span class="hljs-keyword">break</span>;
            }
            ptr++;
        }
    }
    *ptr2=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (*ptr==<span class="hljs-string">'\"'</span>) ptr++;
    item-&gt;valuestring=<span class="hljs-keyword">out</span>;
    item-&gt;type=cJSON_String;
    <span class="hljs-keyword">return</span> ptr;
}

<span class="hljs-comment">//打印字符串</span>
<span class="hljs-comment">/* Render the cstring provided to an escaped version that can be printed. */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *print_string_ptr(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *str,printbuffer *p)
{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *ptr;
    <span class="hljs-keyword">char</span> *ptr2,*<span class="hljs-keyword">out</span>;
    <span class="hljs-keyword">int</span> len=<span class="hljs-number">0</span>,flag=<span class="hljs-number">0</span>;
    unsigned <span class="hljs-keyword">char</span> token;

    <span class="hljs-keyword">for</span> (ptr=str;*ptr;ptr++)
        flag|=((*ptr&gt;<span class="hljs-number">0</span> &amp;&amp; *ptr&lt;<span class="hljs-number">32</span>)||(*ptr==<span class="hljs-string">'\"'</span>)||(*ptr==<span class="hljs-string">'\\'</span>))?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!flag)<span class="hljs-comment">//没有\"和\\和&gt;32的字符</span>
    {
        len=ptr-str;
        <span class="hljs-keyword">if</span> (p) <span class="hljs-keyword">out</span>=ensure(p,len+<span class="hljs-number">3</span>);
        <span class="hljs-keyword">else</span>        <span class="hljs-keyword">out</span>=(<span class="hljs-keyword">char</span>*)cJSON_malloc(len+<span class="hljs-number">3</span>);
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">out</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        ptr2=<span class="hljs-keyword">out</span>;*ptr2++=<span class="hljs-string">'\"'</span>;
        strcpy(ptr2,str);
        ptr2[len]=<span class="hljs-string">'\"'</span>;
        ptr2[len+<span class="hljs-number">1</span>]=<span class="hljs-number">0</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">out</span>;
    }

    <span class="hljs-keyword">if</span> (!str)<span class="hljs-comment">//空字符串</span>
    {
        <span class="hljs-keyword">if</span> (p)  <span class="hljs-keyword">out</span>=ensure(p,<span class="hljs-number">3</span>);
        <span class="hljs-keyword">else</span>    <span class="hljs-keyword">out</span>=(<span class="hljs-keyword">char</span>*)cJSON_malloc(<span class="hljs-number">3</span>);
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">out</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        strcpy(<span class="hljs-keyword">out</span>,<span class="hljs-string">"\"\""</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">out</span>;
    }
    ptr=str;
    <span class="hljs-keyword">while</span> ((token=*ptr) &amp;&amp; ++len) {
        <span class="hljs-keyword">if</span> (strchr(<span class="hljs-string">"\"\\\b\f\n\r\t"</span>,token)) 
            len++; <span class="hljs-comment">//有"\"\\\b\f\n\r\t"当中的字符 </span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token&lt;<span class="hljs-number">32</span>)
            len+=<span class="hljs-number">5</span>;<span class="hljs-comment">//为什么加5：因该是和下面的case的default对应</span>
        ptr++;
    }

    <span class="hljs-keyword">if</span> (p)  <span class="hljs-keyword">out</span>=ensure(p,len+<span class="hljs-number">3</span>);
    <span class="hljs-keyword">else</span>    <span class="hljs-keyword">out</span>=(<span class="hljs-keyword">char</span>*)cJSON_malloc(len+<span class="hljs-number">3</span>);
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">out</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    ptr2=<span class="hljs-keyword">out</span>;ptr=str;
    *ptr2++=<span class="hljs-string">'\"'</span>;
    <span class="hljs-keyword">while</span> (*ptr)
    {
        <span class="hljs-keyword">if</span> ((unsigned <span class="hljs-keyword">char</span>)*ptr&gt;<span class="hljs-number">31</span> &amp;&amp; *ptr!=<span class="hljs-string">'\"'</span> &amp;&amp; *ptr!=<span class="hljs-string">'\\'</span>) *ptr2++=*ptr++;
        <span class="hljs-keyword">else</span>
        {
            *ptr2++=<span class="hljs-string">'\\'</span>;
            <span class="hljs-keyword">switch</span> (token=*ptr++)
            {
                <span class="hljs-keyword">case</span> <span class="hljs-string">'\\'</span>:  *ptr2++=<span class="hljs-string">'\\'</span>;   <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'\"'</span>:  *ptr2++=<span class="hljs-string">'\"'</span>;   <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'\b'</span>:  *ptr2++=<span class="hljs-string">'b'</span>;    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'\f'</span>:  *ptr2++=<span class="hljs-string">'f'</span>;    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'\n'</span>:  *ptr2++=<span class="hljs-string">'n'</span>;    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'\r'</span>:  *ptr2++=<span class="hljs-string">'r'</span>;    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">'\t'</span>:  *ptr2++=<span class="hljs-string">'t'</span>;    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>: sprintf(ptr2,<span class="hljs-string">"u%04x"</span>,token);ptr2+=<span class="hljs-number">5</span>;   <span class="hljs-keyword">break</span>;  <span class="hljs-comment">/* escape and print */</span>
            }
        }
    }
    *ptr2++=<span class="hljs-string">'\"'</span>;*ptr2++=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">out</span>;
}
<span class="hljs-comment">/* Invote print_string_ptr (which is useful) on an item. */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *print_string(cJSON *item,printbuffer *p)   {
    <span class="hljs-keyword">return</span> print_string_ptr(item-&gt;valuestring,p);
}

<span class="hljs-comment">/* Predeclare these prototypes. */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *parse_value(cJSON *item,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">value</span>);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *print_value(cJSON *item,<span class="hljs-keyword">int</span> depth,<span class="hljs-keyword">int</span> fmt,printbuffer *p);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *parse_array(cJSON *item,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">value</span>);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *print_array(cJSON *item,<span class="hljs-keyword">int</span> depth,<span class="hljs-keyword">int</span> fmt,printbuffer *p);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *parse_object(cJSON *item,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">value</span>);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *print_object(cJSON *item,<span class="hljs-keyword">int</span> depth,<span class="hljs-keyword">int</span> fmt,printbuffer *p);

<span class="hljs-comment">//跳过空白</span>
<span class="hljs-comment">/* Utility to jump whitespace and cr/lf */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *skip(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">in</span>) {
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">in</span> &amp;&amp; *<span class="hljs-keyword">in</span> &amp;&amp; (unsigned <span class="hljs-keyword">char</span>)*<span class="hljs-keyword">in</span>&lt;=<span class="hljs-number">32</span>) 
        <span class="hljs-keyword">in</span>++; 
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">in</span>;
}

<span class="hljs-comment">//解析对象、创建带头结点的双向链表</span>
<span class="hljs-comment">/* Parse an object - create a new root, and populate. */</span>
cJSON *cJSON_ParseWithOpts(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">value</span>,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **return_parse_end,<span class="hljs-keyword">int</span> require_null_terminated)
{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *end=<span class="hljs-number">0</span>;
    cJSON *c=cJSON_New_Item();
    ep=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!c) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;       <span class="hljs-comment">/* memory fail */</span>

    end=parse_value(c,skip(<span class="hljs-keyword">value</span>));
    <span class="hljs-comment">//解析失败</span>
    <span class="hljs-keyword">if</span> (!end)   {cJSON_Delete(c);<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;} <span class="hljs-comment">/* parse failure. ep is set. */</span>

    <span class="hljs-comment">/* if we require null-terminated JSON without appended garbage, skip and then check for a null terminator */</span>
    <span class="hljs-keyword">if</span> (require_null_terminated) {
        end=skip(end);
        <span class="hljs-keyword">if</span> (*end) {
            cJSON_Delete(c);
            ep=end;
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
    }
    <span class="hljs-keyword">if</span> (return_parse_end) 
        *return_parse_end=end;
    <span class="hljs-keyword">return</span> c;
}
<span class="hljs-comment">/* Default options for cJSON_Parse */</span>
cJSON *cJSON_Parse(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">value</span>) {
    <span class="hljs-keyword">return</span> cJSON_ParseWithOpts(<span class="hljs-keyword">value</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);
}

<span class="hljs-comment">//有格式打印</span>
<span class="hljs-comment">/* Render a cJSON item/entity/structure to text. */</span>
<span class="hljs-keyword">char</span> *cJSON_Print(cJSON *item)              {
    <span class="hljs-keyword">return</span> print_value(item,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);
}
<span class="hljs-comment">//无格式打印</span>
<span class="hljs-keyword">char</span> *cJSON_PrintUnformatted(cJSON *item)   {
    <span class="hljs-keyword">return</span> print_value(item,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);
}

<span class="hljs-keyword">char</span> *cJSON_PrintBuffered(cJSON *item,<span class="hljs-keyword">int</span> prebuffer,<span class="hljs-keyword">int</span> fmt)
{
    printbuffer p;
    p.buffer=(<span class="hljs-keyword">char</span>*)cJSON_malloc(prebuffer);
    p.length=prebuffer;
    p.offset=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> print_value(item,<span class="hljs-number">0</span>,fmt,&amp;p);
    <span class="hljs-keyword">return</span> p.buffer;
}

<span class="hljs-comment">//解析JSON字符串的核心函数，返回最后一个字符指针</span>
<span class="hljs-comment">/* Parser core - when encountering text, process appropriately. */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *parse_value(cJSON *item,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">value</span>)
{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">value</span>)                     <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <span class="hljs-comment">/* Fail on null. */</span>
    <span class="hljs-keyword">if</span> (!strncmp(<span class="hljs-keyword">value</span>,<span class="hljs-string">"null"</span>,<span class="hljs-number">4</span>))   { item-&gt;type=cJSON_NULL;  <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>+<span class="hljs-number">4</span>; }
    <span class="hljs-keyword">if</span> (!strncmp(<span class="hljs-keyword">value</span>,<span class="hljs-string">"false"</span>,<span class="hljs-number">5</span>))  { item-&gt;type=cJSON_False; <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>+<span class="hljs-number">5</span>; }
    <span class="hljs-keyword">if</span> (!strncmp(<span class="hljs-keyword">value</span>,<span class="hljs-string">"true"</span>,<span class="hljs-number">4</span>))   { item-&gt;type=cJSON_True; item-&gt;valueint=<span class="hljs-number">1</span>;  <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>+<span class="hljs-number">4</span>; }
    <span class="hljs-comment">//字符串</span>
    <span class="hljs-keyword">if</span> (*<span class="hljs-keyword">value</span>==<span class="hljs-string">'\"'</span>)               { <span class="hljs-keyword">return</span> parse_string(item,<span class="hljs-keyword">value</span>); }
    <span class="hljs-comment">//数值</span>
    <span class="hljs-keyword">if</span> (*<span class="hljs-keyword">value</span>==<span class="hljs-string">'-'</span> || (*<span class="hljs-keyword">value</span>&gt;=<span class="hljs-string">'0'</span> &amp;&amp; *<span class="hljs-keyword">value</span>&lt;=<span class="hljs-string">'9'</span>))    { <span class="hljs-keyword">return</span> parse_number(item,<span class="hljs-keyword">value</span>); }
    <span class="hljs-comment">//数组</span>
    <span class="hljs-keyword">if</span> (*<span class="hljs-keyword">value</span>==<span class="hljs-string">'['</span>)                { <span class="hljs-keyword">return</span> parse_array(item,<span class="hljs-keyword">value</span>); }
    <span class="hljs-comment">//对象</span>
    <span class="hljs-keyword">if</span> (*<span class="hljs-keyword">value</span>==<span class="hljs-string">'{'</span>)                { <span class="hljs-keyword">return</span> parse_object(item,<span class="hljs-keyword">value</span>); }
    <span class="hljs-comment">//字符串错误</span>
    ep=<span class="hljs-keyword">value</span>;<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">/* failure. */</span>
}

<span class="hljs-comment">//根据cJSON对象的类型打印其值</span>
<span class="hljs-comment">//非常重要的一个函数</span>
<span class="hljs-comment">/* Render a value to text. */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *print_value(cJSON *item,<span class="hljs-keyword">int</span> depth,<span class="hljs-keyword">int</span> fmt,printbuffer *p)
{
    <span class="hljs-keyword">char</span> *<span class="hljs-keyword">out</span>=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!item) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (p)
    {
        <span class="hljs-keyword">switch</span> ((item-&gt;type)&amp;<span class="hljs-number">255</span>)
        {
            <span class="hljs-keyword">case</span> cJSON_NULL:    {<!-- --><span class="hljs-keyword">out</span>=ensure(p,<span class="hljs-number">5</span>);   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">out</span>) strcpy(<span class="hljs-keyword">out</span>,<span class="hljs-string">"null"</span>);    <span class="hljs-keyword">break</span>;}
            <span class="hljs-keyword">case</span> cJSON_False:   {<!-- --><span class="hljs-keyword">out</span>=ensure(p,<span class="hljs-number">6</span>);   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">out</span>) strcpy(<span class="hljs-keyword">out</span>,<span class="hljs-string">"false"</span>);   <span class="hljs-keyword">break</span>;}
            <span class="hljs-keyword">case</span> cJSON_True:    {<!-- --><span class="hljs-keyword">out</span>=ensure(p,<span class="hljs-number">5</span>);   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">out</span>) strcpy(<span class="hljs-keyword">out</span>,<span class="hljs-string">"true"</span>);    <span class="hljs-keyword">break</span>;}
            <span class="hljs-keyword">case</span> cJSON_Number:  <span class="hljs-keyword">out</span>=print_number(item,p);<span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> cJSON_String:  <span class="hljs-keyword">out</span>=print_string(item,p);<span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> cJSON_Array:   <span class="hljs-keyword">out</span>=print_array(item,depth,fmt,p);<span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> cJSON_Object:  <span class="hljs-keyword">out</span>=print_object(item,depth,fmt,p);<span class="hljs-keyword">break</span>;
        }
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-keyword">switch</span> ((item-&gt;type)&amp;<span class="hljs-number">255</span>)
        {
            <span class="hljs-keyword">case</span> cJSON_NULL:    <span class="hljs-keyword">out</span>=cJSON_strdup(<span class="hljs-string">"null"</span>);   <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> cJSON_False:   <span class="hljs-keyword">out</span>=cJSON_strdup(<span class="hljs-string">"false"</span>);<span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> cJSON_True:    <span class="hljs-keyword">out</span>=cJSON_strdup(<span class="hljs-string">"true"</span>); <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> cJSON_Number:  <span class="hljs-keyword">out</span>=print_number(item,<span class="hljs-number">0</span>);<span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> cJSON_String:  <span class="hljs-keyword">out</span>=print_string(item,<span class="hljs-number">0</span>);<span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> cJSON_Array:   <span class="hljs-keyword">out</span>=print_array(item,depth,fmt,<span class="hljs-number">0</span>);<span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> cJSON_Object:  <span class="hljs-keyword">out</span>=print_object(item,depth,fmt,<span class="hljs-number">0</span>);<span class="hljs-keyword">break</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">out</span>;
}

<span class="hljs-comment">//构建一个数组的带头结点的双向链表</span>
<span class="hljs-comment">/* Build an array from input text. */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *parse_array(cJSON *item,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">value</span>)
{
    cJSON *child;
    <span class="hljs-keyword">if</span> (*<span class="hljs-keyword">value</span>!=<span class="hljs-string">'['</span>)    {ep=<span class="hljs-keyword">value</span>;<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}    <span class="hljs-comment">/* not an array! */</span>

    item-&gt;type=cJSON_Array;
    <span class="hljs-keyword">value</span>=skip(<span class="hljs-keyword">value</span>+<span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span> (*<span class="hljs-keyword">value</span>==<span class="hljs-string">']'</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>+<span class="hljs-number">1</span>;    <span class="hljs-comment">/* empty array. */</span>

    item-&gt;child=child=cJSON_New_Item();
    <span class="hljs-keyword">if</span> (!item-&gt;child) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;      <span class="hljs-comment">/* memory fail */</span>
    <span class="hljs-comment">//第一个数组元素</span>
    <span class="hljs-keyword">value</span>=skip(parse_value(child,skip(<span class="hljs-keyword">value</span>))); <span class="hljs-comment">/* skip any spacing, get the value. */</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">value</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-comment">//剩下的数组元素</span>
    <span class="hljs-keyword">while</span> (*<span class="hljs-keyword">value</span>==<span class="hljs-string">','</span>)
    {
        cJSON *new_item;
        <span class="hljs-keyword">if</span> (!(new_item=cJSON_New_Item())) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;     <span class="hljs-comment">/* memory fail */</span>
        child-&gt;next=new_item;new_item-&gt;prev=child;child=new_item;
        <span class="hljs-keyword">value</span>=skip(parse_value(child,skip(<span class="hljs-keyword">value</span>+<span class="hljs-number">1</span>)));
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">value</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <span class="hljs-comment">/* memory fail */</span>
    }

    <span class="hljs-keyword">if</span> (*<span class="hljs-keyword">value</span>==<span class="hljs-string">']'</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>+<span class="hljs-number">1</span>;    <span class="hljs-comment">/* end of array */</span>
    ep=<span class="hljs-keyword">value</span>;<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">/* malformed. */</span>
}

<span class="hljs-comment">//打印数组</span>
<span class="hljs-comment">/* Render an array to text */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *print_array(cJSON *item,<span class="hljs-keyword">int</span> depth,<span class="hljs-keyword">int</span> fmt,printbuffer *p)
{
    <span class="hljs-keyword">char</span> **entries;
    <span class="hljs-keyword">char</span> *<span class="hljs-keyword">out</span>=<span class="hljs-number">0</span>,*ptr,*ret;<span class="hljs-keyword">int</span> len=<span class="hljs-number">5</span>;
    cJSON *child=item-&gt;child;
    <span class="hljs-keyword">int</span> numentries=<span class="hljs-number">0</span>,i=<span class="hljs-number">0</span>,fail=<span class="hljs-number">0</span>;
    size_t tmplen=<span class="hljs-number">0</span>;

    <span class="hljs-comment">//计算数组元素的个数</span>
    <span class="hljs-comment">/* How many entries in the array? */</span>
    <span class="hljs-keyword">while</span> (child) numentries++,child=child-&gt;next;
    <span class="hljs-comment">/* Explicitly handle numentries==0 */</span>
    <span class="hljs-keyword">if</span> (!numentries)
    {
        <span class="hljs-keyword">if</span> (p)  <span class="hljs-keyword">out</span>=ensure(p,<span class="hljs-number">3</span>);
        <span class="hljs-keyword">else</span>    <span class="hljs-keyword">out</span>=(<span class="hljs-keyword">char</span>*)cJSON_malloc(<span class="hljs-number">3</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">out</span>) strcpy(<span class="hljs-keyword">out</span>,<span class="hljs-string">"[]"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">out</span>;
    }

    <span class="hljs-keyword">if</span> (p)
    {
        <span class="hljs-comment">/* Compose the output array. */</span>
        i=p-&gt;offset;
        ptr=ensure(p,<span class="hljs-number">1</span>);<span class="hljs-keyword">if</span> (!ptr) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; *ptr=<span class="hljs-string">'['</span>;   p-&gt;offset++;
        child=item-&gt;child;
        <span class="hljs-keyword">while</span> (child &amp;&amp; !fail)
        {
            print_value(child,depth+<span class="hljs-number">1</span>,fmt,p);
            p-&gt;offset=update(p);
            <span class="hljs-keyword">if</span> (child-&gt;next) {len=fmt?<span class="hljs-number">2</span>:<span class="hljs-number">1</span>;ptr=ensure(p,len+<span class="hljs-number">1</span>);<span class="hljs-keyword">if</span> (!ptr) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;*ptr++=<span class="hljs-string">','</span>;<span class="hljs-keyword">if</span>(fmt)*ptr++=<span class="hljs-string">' '</span>;*ptr=<span class="hljs-number">0</span>;p-&gt;offset+=len;}
            child=child-&gt;next;
        }
        ptr=ensure(p,<span class="hljs-number">2</span>);<span class="hljs-keyword">if</span> (!ptr) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; *ptr++=<span class="hljs-string">']'</span>;*ptr=<span class="hljs-number">0</span>;
        <span class="hljs-keyword">out</span>=(p-&gt;buffer)+i;
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-comment">/* Allocate an array to hold the values for each */</span>
        entries=(<span class="hljs-keyword">char</span>**)cJSON_malloc(numentries*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>*));
        <span class="hljs-keyword">if</span> (!entries) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        memset(entries,<span class="hljs-number">0</span>,numentries*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>*));
        <span class="hljs-comment">//递归输出所有的数组元素</span>
        <span class="hljs-comment">/* Retrieve all the results: */</span>
        child=item-&gt;child;
        <span class="hljs-keyword">while</span> (child &amp;&amp; !fail)
        {
            ret=print_value(child,depth+<span class="hljs-number">1</span>,fmt,<span class="hljs-number">0</span>);
            entries[i++]=ret;
            <span class="hljs-keyword">if</span> (ret) len+=strlen(ret)+<span class="hljs-number">2</span>+(fmt?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>); <span class="hljs-keyword">else</span> fail=<span class="hljs-number">1</span>;
            child=child-&gt;next;
        }

        <span class="hljs-comment">/* If we didn't fail, try to malloc the output string */</span>
        <span class="hljs-keyword">if</span> (!fail)  <span class="hljs-keyword">out</span>=(<span class="hljs-keyword">char</span>*)cJSON_malloc(len);
        <span class="hljs-comment">/* If that fails, we fail. */</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">out</span>) fail=<span class="hljs-number">1</span>;

        <span class="hljs-comment">/* Handle failure. */</span>
        <span class="hljs-keyword">if</span> (fail)
        {
            <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;numentries;i++) <span class="hljs-keyword">if</span> (entries[i]) cJSON_free(entries[i]);
            cJSON_free(entries);
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }

        <span class="hljs-comment">/* Compose the output array. */</span>
        *<span class="hljs-keyword">out</span>=<span class="hljs-string">'['</span>;
        ptr=<span class="hljs-keyword">out</span>+<span class="hljs-number">1</span>;*ptr=<span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;numentries;i++)
        {
            tmplen=strlen(entries[i]);memcpy(ptr,entries[i],tmplen);ptr+=tmplen;
            <span class="hljs-keyword">if</span> (i!=numentries-<span class="hljs-number">1</span>) {*ptr++=<span class="hljs-string">','</span>;<span class="hljs-keyword">if</span>(fmt)*ptr++=<span class="hljs-string">' '</span>;*ptr=<span class="hljs-number">0</span>;}
            cJSON_free(entries[i]);
        }
        cJSON_free(entries);
        *ptr++=<span class="hljs-string">']'</span>;*ptr++=<span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">out</span>; 
}

<span class="hljs-comment">//构建一个带头结点的双向对象链表</span>
<span class="hljs-comment">/* Build an object from the text. */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *parse_object(cJSON *item,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">value</span>)
{
    cJSON *child;
    <span class="hljs-keyword">if</span> (*<span class="hljs-keyword">value</span>!=<span class="hljs-string">'{'</span>)    {ep=<span class="hljs-keyword">value</span>;<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}    <span class="hljs-comment">/* not an object! */</span>

    item-&gt;type=cJSON_Object;
    <span class="hljs-keyword">value</span>=skip(<span class="hljs-keyword">value</span>+<span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span> (*<span class="hljs-keyword">value</span>==<span class="hljs-string">'}'</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>+<span class="hljs-number">1</span>;    <span class="hljs-comment">/* empty array. */</span>

    item-&gt;child=child=cJSON_New_Item();
    <span class="hljs-keyword">if</span> (!item-&gt;child) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">value</span>=skip(parse_string(child,skip(<span class="hljs-keyword">value</span>)));
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">value</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    child-&gt;<span class="hljs-keyword">string</span>=child-&gt;valuestring;child-&gt;valuestring=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (*<span class="hljs-keyword">value</span>!=<span class="hljs-string">':'</span>) {ep=<span class="hljs-keyword">value</span>;<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}   <span class="hljs-comment">/* fail! */</span>
    <span class="hljs-comment">//第一个对象元素</span>
    <span class="hljs-keyword">value</span>=skip(parse_value(child,skip(<span class="hljs-keyword">value</span>+<span class="hljs-number">1</span>)));   <span class="hljs-comment">/* skip any spacing, get the value. */</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">value</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    <span class="hljs-keyword">while</span> (*<span class="hljs-keyword">value</span>==<span class="hljs-string">','</span>)
    {
        cJSON *new_item;
        <span class="hljs-keyword">if</span> (!(new_item=cJSON_New_Item()))   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">/* memory fail */</span>
        child-&gt;next=new_item;new_item-&gt;prev=child;child=new_item;
        <span class="hljs-keyword">value</span>=skip(parse_string(child,skip(<span class="hljs-keyword">value</span>+<span class="hljs-number">1</span>)));
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">value</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        child-&gt;<span class="hljs-keyword">string</span>=child-&gt;valuestring;child-&gt;valuestring=<span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (*<span class="hljs-keyword">value</span>!=<span class="hljs-string">':'</span>) {ep=<span class="hljs-keyword">value</span>;<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}   <span class="hljs-comment">/* fail! */</span>
        <span class="hljs-keyword">value</span>=skip(parse_value(child,skip(<span class="hljs-keyword">value</span>+<span class="hljs-number">1</span>)));   <span class="hljs-comment">/* skip any spacing, get the value. */</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">value</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }

    <span class="hljs-keyword">if</span> (*<span class="hljs-keyword">value</span>==<span class="hljs-string">'}'</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>+<span class="hljs-number">1</span>;    <span class="hljs-comment">/* end of array */</span>
    ep=<span class="hljs-keyword">value</span>;<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">/* malformed. */</span>
}

<span class="hljs-comment">/* Render an object to text. */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *print_object(cJSON *item,<span class="hljs-keyword">int</span> depth,<span class="hljs-keyword">int</span> fmt,printbuffer *p)
{
    <span class="hljs-keyword">char</span> **entries=<span class="hljs-number">0</span>,**names=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">char</span> *<span class="hljs-keyword">out</span>=<span class="hljs-number">0</span>,*ptr,*ret,*str;
    <span class="hljs-keyword">int</span> len=<span class="hljs-number">7</span>,i=<span class="hljs-number">0</span>,j;
    cJSON *child=item-&gt;child;
    <span class="hljs-keyword">int</span> numentries=<span class="hljs-number">0</span>,fail=<span class="hljs-number">0</span>;
    size_t tmplen=<span class="hljs-number">0</span>;
    <span class="hljs-comment">//计算双向链表中有多少个节点</span>
    <span class="hljs-comment">/* Count the number of entries. */</span>
    <span class="hljs-keyword">while</span> (child) numentries++,child=child-&gt;next;
    <span class="hljs-comment">/* Explicitly handle empty object case */</span>
    <span class="hljs-keyword">if</span> (!numentries)<span class="hljs-comment">//空对象</span>
    {
        <span class="hljs-keyword">if</span> (p) <span class="hljs-keyword">out</span>=ensure(p,fmt?depth+<span class="hljs-number">4</span>:<span class="hljs-number">3</span>);
        <span class="hljs-keyword">else</span>    <span class="hljs-keyword">out</span>=(<span class="hljs-keyword">char</span>*)cJSON_malloc(fmt?depth+<span class="hljs-number">4</span>:<span class="hljs-number">3</span>);
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">out</span>)   <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        ptr=<span class="hljs-keyword">out</span>;*ptr++=<span class="hljs-string">'{'</span>;
        <span class="hljs-keyword">if</span> (fmt) {*ptr++=<span class="hljs-string">'\n'</span>;<span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;depth-<span class="hljs-number">1</span>;i++) *ptr++=<span class="hljs-string">'\t'</span>;}
        *ptr++=<span class="hljs-string">'}'</span>;*ptr++=<span class="hljs-number">0</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">out</span>;
    }
    <span class="hljs-keyword">if</span> (p)
    {
        <span class="hljs-comment">/* Compose the output: */</span>
        i=p-&gt;offset;
        len=fmt?<span class="hljs-number">2</span>:<span class="hljs-number">1</span>;    ptr=ensure(p,len+<span class="hljs-number">1</span>);    <span class="hljs-keyword">if</span> (!ptr) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        *ptr++=<span class="hljs-string">'{'</span>; <span class="hljs-keyword">if</span> (fmt) *ptr++=<span class="hljs-string">'\n'</span>;   *ptr=<span class="hljs-number">0</span>; p-&gt;offset+=len;
        child=item-&gt;child;depth++;
        <span class="hljs-keyword">while</span> (child)
        {
            <span class="hljs-keyword">if</span> (fmt)
            {
                ptr=ensure(p,depth);    <span class="hljs-keyword">if</span> (!ptr) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
                <span class="hljs-keyword">for</span> (j=<span class="hljs-number">0</span>;j&lt;depth;j++) *ptr++=<span class="hljs-string">'\t'</span>;
                p-&gt;offset+=depth;
            }
            print_string_ptr(child-&gt;<span class="hljs-keyword">string</span>,p);
            p-&gt;offset=update(p);

            len=fmt?<span class="hljs-number">2</span>:<span class="hljs-number">1</span>;
            ptr=ensure(p,len);  <span class="hljs-keyword">if</span> (!ptr) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            *ptr++=<span class="hljs-string">':'</span>;<span class="hljs-keyword">if</span> (fmt) *ptr++=<span class="hljs-string">'\t'</span>;
            p-&gt;offset+=len;

            print_value(child,depth,fmt,p);
            p-&gt;offset=update(p);

            len=(fmt?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)+(child-&gt;next?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>);
            ptr=ensure(p,len+<span class="hljs-number">1</span>); <span class="hljs-keyword">if</span> (!ptr) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">if</span> (child-&gt;next) *ptr++=<span class="hljs-string">','</span>;
            <span class="hljs-keyword">if</span> (fmt) *ptr++=<span class="hljs-string">'\n'</span>;*ptr=<span class="hljs-number">0</span>;
            p-&gt;offset+=len;
            child=child-&gt;next;
        }
        ptr=ensure(p,fmt?(depth+<span class="hljs-number">1</span>):<span class="hljs-number">2</span>);   <span class="hljs-keyword">if</span> (!ptr) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (fmt)    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;depth-<span class="hljs-number">1</span>;i++) *ptr++=<span class="hljs-string">'\t'</span>;
        *ptr++=<span class="hljs-string">'}'</span>;*ptr=<span class="hljs-number">0</span>;
        <span class="hljs-keyword">out</span>=(p-&gt;buffer)+i;
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-comment">//分配空间给值【entries】、名字【names】</span>
        <span class="hljs-comment">/* Allocate space for the names and the objects */</span>
        entries=(<span class="hljs-keyword">char</span>**)cJSON_malloc(numentries*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>*));
        <span class="hljs-keyword">if</span> (!entries) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        names=(<span class="hljs-keyword">char</span>**)cJSON_malloc(numentries*<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>*));
        <span class="hljs-keyword">if</span> (!names) {cJSON_free(entries);<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}
        memset(entries,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>*)*numentries);
        memset(names,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">char</span>*)*numentries);

        <span class="hljs-comment">//收集所有的节点加入到数组names和entries中</span>
        <span class="hljs-comment">/* Collect all the results into our arrays: */</span>
        child=item-&gt;child;depth++;<span class="hljs-keyword">if</span> (fmt) len+=depth;
        <span class="hljs-keyword">while</span> (child)
        {
            names[i]=str=print_string_ptr(child-&gt;<span class="hljs-keyword">string</span>,<span class="hljs-number">0</span>);
            entries[i++]=ret=print_value(child,depth,fmt,<span class="hljs-number">0</span>);
            <span class="hljs-keyword">if</span> (str &amp;&amp; ret) len+=strlen(ret)+strlen(str)+<span class="hljs-number">2</span>+(fmt?<span class="hljs-number">2</span>+depth:<span class="hljs-number">0</span>);
            <span class="hljs-keyword">else</span> fail=<span class="hljs-number">1</span>;
            child=child-&gt;next;
        }

        <span class="hljs-comment">/* Try to allocate the output string */</span>
        <span class="hljs-keyword">if</span> (!fail)  <span class="hljs-keyword">out</span>=(<span class="hljs-keyword">char</span>*)cJSON_malloc(len);
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">out</span>) fail=<span class="hljs-number">1</span>;

        <span class="hljs-comment">/* Handle failure */</span>
        <span class="hljs-keyword">if</span> (fail)
        {
            <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;numentries;i++) {
                <span class="hljs-keyword">if</span> (names[i]) cJSON_free(names[i]);
                <span class="hljs-keyword">if</span> (entries[i]) cJSON_free(entries[i]);
            }
            cJSON_free(names);cJSON_free(entries);
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }

        <span class="hljs-comment">/* Compose the output: */</span>
        *<span class="hljs-keyword">out</span>=<span class="hljs-string">'{'</span>;ptr=<span class="hljs-keyword">out</span>+<span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (fmt)*ptr++=<span class="hljs-string">'\n'</span>;*ptr=<span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;numentries;i++)
        {
            <span class="hljs-keyword">if</span> (fmt) <span class="hljs-keyword">for</span> (j=<span class="hljs-number">0</span>;j&lt;depth;j++) *ptr++=<span class="hljs-string">'\t'</span>;
            tmplen=strlen(names[i]);memcpy(ptr,names[i],tmplen);ptr+=tmplen;
            *ptr++=<span class="hljs-string">':'</span>;<span class="hljs-keyword">if</span> (fmt) *ptr++=<span class="hljs-string">'\t'</span>;
            strcpy(ptr,entries[i]);ptr+=strlen(entries[i]);
            <span class="hljs-keyword">if</span> (i!=numentries-<span class="hljs-number">1</span>) *ptr++=<span class="hljs-string">','</span>;
            <span class="hljs-keyword">if</span> (fmt) *ptr++=<span class="hljs-string">'\n'</span>;*ptr=<span class="hljs-number">0</span>;
            cJSON_free(names[i]);cJSON_free(entries[i]);
        }

        cJSON_free(names);cJSON_free(entries);
        <span class="hljs-keyword">if</span> (fmt) <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;depth-<span class="hljs-number">1</span>;i++) *ptr++=<span class="hljs-string">'\t'</span>;
        *ptr++=<span class="hljs-string">'}'</span>;*ptr++=<span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">out</span>; 
}

<span class="hljs-comment">/* Get Array size/item / object item. */</span>
<span class="hljs-comment">//获取数组cJSON对象的个数</span>
<span class="hljs-keyword">int</span>    cJSON_GetArraySize(cJSON *array){
    cJSON *c=array-&gt;child;
    <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span>(c)
        i++,c=c-&gt;next;
    <span class="hljs-keyword">return</span> i;
}
<span class="hljs-comment">//返回索引为item的数组cJSON指针</span>
cJSON *cJSON_GetArrayItem(cJSON *array,<span class="hljs-keyword">int</span> item){
    cJSON *c=array-&gt;child;  
    <span class="hljs-keyword">while</span> (c &amp;&amp; item&gt;<span class="hljs-number">0</span>)
        item--,c=c-&gt;next;
    <span class="hljs-keyword">return</span> c;
}
<span class="hljs-comment">//返回名字为string的对象cJSON指针</span>
cJSON *cJSON_GetObjectItem(cJSON *<span class="hljs-keyword">object</span>,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">string</span>){
    cJSON *c=<span class="hljs-keyword">object</span>-&gt;child;
    <span class="hljs-keyword">while</span> (c &amp;&amp; cJSON_strcasecmp(c-&gt;<span class="hljs-keyword">string</span>,<span class="hljs-keyword">string</span>)) 
        c=c-&gt;next;
    <span class="hljs-keyword">return</span> c;
}

<span class="hljs-comment">//双向链表的连接辅助函数</span>
<span class="hljs-comment">/* Utility for array list handling. */</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> suffix_object(cJSON *prev,cJSON *item) {
    prev-&gt;next=item;
    item-&gt;prev=prev;
}

<span class="hljs-comment">//创建引用类型的cJSON对象</span>
<span class="hljs-comment">/* Utility for handling references. */</span>
<span class="hljs-keyword">static</span> cJSON *create_reference(cJSON *item) {
    cJSON *<span class="hljs-keyword">ref</span>=cJSON_New_Item();
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">ref</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    memcpy(<span class="hljs-keyword">ref</span>,item,<span class="hljs-keyword">sizeof</span>(cJSON));
    <span class="hljs-keyword">ref</span>-&gt;<span class="hljs-keyword">string</span>=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">ref</span>-&gt;type|=cJSON_IsReference;
    <span class="hljs-keyword">ref</span>-&gt;next=<span class="hljs-keyword">ref</span>-&gt;prev=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">ref</span>;
}

<span class="hljs-comment">//添加item到array/object的cJSON结构中</span>
<span class="hljs-comment">/* Add item to array/object. */</span>
<span class="hljs-keyword">void</span>   cJSON_AddItemToArray(cJSON *array, cJSON *item){
    cJSON *c=array-&gt;child;
    <span class="hljs-keyword">if</span> (!item) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (!c) {array-&gt;child=item;}
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">while</span> (c &amp;&amp; c-&gt;next) 
            c=c-&gt;next; 
        suffix_object(c,item);
    }
}
<span class="hljs-keyword">void</span>   cJSON_AddItemToObject(cJSON *<span class="hljs-keyword">object</span>,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">string</span>,cJSON *item)  {
    <span class="hljs-keyword">if</span> (!item) <span class="hljs-keyword">return</span>; 
    <span class="hljs-keyword">if</span> (item-&gt;<span class="hljs-keyword">string</span>)
        cJSON_free(item-&gt;<span class="hljs-keyword">string</span>);
    item-&gt;<span class="hljs-keyword">string</span>=cJSON_strdup(<span class="hljs-keyword">string</span>);
    cJSON_AddItemToArray(<span class="hljs-keyword">object</span>,item);
}
<span class="hljs-keyword">void</span>   cJSON_AddItemToObjectCS(cJSON *<span class="hljs-keyword">object</span>,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">string</span>,cJSON *item)    {<!-- --><span class="hljs-keyword">if</span> (!item) <span class="hljs-keyword">return</span>; <span class="hljs-keyword">if</span> (!(item-&gt;type&amp;cJSON_StringIsConst) &amp;&amp; item-&gt;<span class="hljs-keyword">string</span>) cJSON_free(item-&gt;<span class="hljs-keyword">string</span>);item-&gt;<span class="hljs-keyword">string</span>=(<span class="hljs-keyword">char</span>*)<span class="hljs-keyword">string</span>;item-&gt;type|=cJSON_StringIsConst;cJSON_AddItemToArray(<span class="hljs-keyword">object</span>,item);}
<span class="hljs-keyword">void</span>    cJSON_AddItemReferenceToArray(cJSON *array, cJSON *item)                        {cJSON_AddItemToArray(array,create_reference(item));}
<span class="hljs-keyword">void</span>    cJSON_AddItemReferenceToObject(cJSON *<span class="hljs-keyword">object</span>,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">string</span>,cJSON *item){
    cJSON_AddItemToObject(<span class="hljs-keyword">object</span>,<span class="hljs-keyword">string</span>,create_reference(item));
}

<span class="hljs-comment">//移除【detach】索引为which的节点</span>
cJSON *cJSON_DetachItemFromArray(cJSON *array,<span class="hljs-keyword">int</span> which)            {
    cJSON *c=array-&gt;child;
    <span class="hljs-comment">//找到索引为which的cJSON对象</span>
    <span class="hljs-keyword">while</span> (c &amp;&amp; which&gt;<span class="hljs-number">0</span>)
        c=c-&gt;next,which--;
    <span class="hljs-keyword">if</span> (!c) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-comment">//双向链表的删除</span>
    <span class="hljs-keyword">if</span> (c-&gt;prev) 
        c-&gt;prev-&gt;next=c-&gt;next;
    <span class="hljs-keyword">if</span> (c-&gt;next)
        c-&gt;next-&gt;prev=c-&gt;prev;
    <span class="hljs-comment">//如果删除的是第一个子节点</span>
    <span class="hljs-keyword">if</span> (c==array-&gt;child) 
        array-&gt;child=c-&gt;next;
    c-&gt;prev=c-&gt;next=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> c;
}
<span class="hljs-comment">//删除【delete】索引为which的节点</span>
<span class="hljs-keyword">void</span>   cJSON_DeleteItemFromArray(cJSON *array,<span class="hljs-keyword">int</span> which){
    cJSON_Delete(cJSON_DetachItemFromArray(array,which));
}
<span class="hljs-comment">//移除【detach】字符串为string的节点</span>
cJSON *cJSON_DetachItemFromObject(cJSON *<span class="hljs-keyword">object</span>,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">string</span>) {
    <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;
    cJSON *c=<span class="hljs-keyword">object</span>-&gt;child;
    <span class="hljs-keyword">while</span> (c &amp;&amp; cJSON_strcasecmp(c-&gt;<span class="hljs-keyword">string</span>,<span class="hljs-keyword">string</span>))
        i++,c=c-&gt;next;
    <span class="hljs-keyword">if</span> (c)
        <span class="hljs-keyword">return</span> cJSON_DetachItemFromArray(<span class="hljs-keyword">object</span>,i);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
<span class="hljs-comment">//删除【delete】字符串为string的节点</span>
<span class="hljs-keyword">void</span>   cJSON_DeleteItemFromObject(cJSON *<span class="hljs-keyword">object</span>,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">string</span>) {
    cJSON_Delete(cJSON_DetachItemFromObject(<span class="hljs-keyword">object</span>,<span class="hljs-keyword">string</span>));
}

<span class="hljs-comment">/* Replace array/object items with new ones. */</span>
<span class="hljs-comment">//在数组cJSON中索引为which之前插入newitem</span>
<span class="hljs-keyword">void</span>   cJSON_InsertItemInArray(cJSON *array,<span class="hljs-keyword">int</span> which,cJSON *newitem){
    cJSON *c=array-&gt;child;
    <span class="hljs-keyword">while</span> (c &amp;&amp; which&gt;<span class="hljs-number">0</span>) 
        c=c-&gt;next,which--;
    <span class="hljs-keyword">if</span> (!c) {<!-- --><span class="hljs-comment">//which为最后一个</span>
        cJSON_AddItemToArray(array,newitem);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-comment">//双向链表的连接</span>
    newitem-&gt;next=c;
    newitem-&gt;prev=c-&gt;prev;
    c-&gt;prev=newitem;
    <span class="hljs-keyword">if</span> (c==array-&gt;child)<span class="hljs-comment">//如果插入节点为第一个子孩子</span>
        array-&gt;child=newitem; 
    <span class="hljs-keyword">else</span> 
        newitem-&gt;prev-&gt;next=newitem;
}
<span class="hljs-comment">//将索引为which的节点替换为newitem</span>
<span class="hljs-keyword">void</span>   cJSON_ReplaceItemInArray(cJSON *array,<span class="hljs-keyword">int</span> which,cJSON *newitem){
    cJSON *c=array-&gt;child;
    <span class="hljs-comment">//找索引为which的节点</span>
    <span class="hljs-keyword">while</span> (c &amp;&amp; which&gt;<span class="hljs-number">0</span>)
        c=c-&gt;next,which--;
    <span class="hljs-keyword">if</span> (!c) <span class="hljs-keyword">return</span>;<span class="hljs-comment">//没有找到则返回</span>
    <span class="hljs-comment">//双向链表的连接</span>
    newitem-&gt;next=c-&gt;next;
    newitem-&gt;prev=c-&gt;prev;
    <span class="hljs-keyword">if</span> (newitem-&gt;next)
        newitem-&gt;next-&gt;prev=newitem;
    <span class="hljs-keyword">if</span> (c==array-&gt;child)
        array-&gt;child=newitem;
    <span class="hljs-keyword">else</span>
        newitem-&gt;prev-&gt;next=newitem;
    <span class="hljs-comment">//释放被替换的节点内存</span>
    c-&gt;next=c-&gt;prev=<span class="hljs-number">0</span>;
    cJSON_Delete(c);
}
<span class="hljs-comment">//替换名称为string的cJSON对象为newitem</span>
<span class="hljs-keyword">void</span>   cJSON_ReplaceItemInObject(cJSON *<span class="hljs-keyword">object</span>,<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">string</span>,cJSON *newitem){
    <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;
    cJSON *c=<span class="hljs-keyword">object</span>-&gt;child;
    <span class="hljs-comment">//找名称为string的对象</span>
    <span class="hljs-keyword">while</span>(c &amp;&amp; cJSON_strcasecmp(c-&gt;<span class="hljs-keyword">string</span>,<span class="hljs-keyword">string</span>))
        i++,c=c-&gt;next;
    <span class="hljs-keyword">if</span>(c){
        newitem-&gt;<span class="hljs-keyword">string</span>=cJSON_strdup(<span class="hljs-keyword">string</span>);
        cJSON_ReplaceItemInArray(<span class="hljs-keyword">object</span>,i,newitem);
    }
}

<span class="hljs-comment">//创建基本的cJSON对象</span>
<span class="hljs-comment">/* Create basic types: */</span>
cJSON *cJSON_CreateNull(<span class="hljs-keyword">void</span>)                   {cJSON *item=cJSON_New_Item();<span class="hljs-keyword">if</span>(item)item-&gt;type=cJSON_NULL;<span class="hljs-keyword">return</span> item;}
cJSON *cJSON_CreateTrue(<span class="hljs-keyword">void</span>)                   {cJSON *item=cJSON_New_Item();<span class="hljs-keyword">if</span>(item)item-&gt;type=cJSON_True;<span class="hljs-keyword">return</span> item;}
cJSON *cJSON_CreateFalse(<span class="hljs-keyword">void</span>)                  {cJSON *item=cJSON_New_Item();<span class="hljs-keyword">if</span>(item)item-&gt;type=cJSON_False;<span class="hljs-keyword">return</span> item;}
<span class="hljs-comment">//三目运算法【？：】的优先级 &gt; 赋值运算符【=】</span>
cJSON *cJSON_CreateBool(<span class="hljs-keyword">int</span> b)                  {cJSON *item=cJSON_New_Item();<span class="hljs-keyword">if</span>(item)item-&gt;type=b?cJSON_True:cJSON_False;<span class="hljs-keyword">return</span> item;}
cJSON *cJSON_CreateNumber(<span class="hljs-keyword">double</span> num)           {cJSON *item=cJSON_New_Item();<span class="hljs-keyword">if</span>(item){item-&gt;type=cJSON_Number;item-&gt;valuedouble=num;item-&gt;valueint=(<span class="hljs-keyword">int</span>)num;}<span class="hljs-keyword">return</span> item;}
cJSON *cJSON_CreateString(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">string</span>)   {cJSON *item=cJSON_New_Item();<span class="hljs-keyword">if</span>(item){item-&gt;type=cJSON_String;item-&gt;valuestring=cJSON_strdup(<span class="hljs-keyword">string</span>);}<span class="hljs-keyword">return</span> item;}
cJSON *cJSON_CreateArray(<span class="hljs-keyword">void</span>)                  {cJSON *item=cJSON_New_Item();<span class="hljs-keyword">if</span>(item)item-&gt;type=cJSON_Array;<span class="hljs-keyword">return</span> item;}
cJSON *cJSON_CreateObject(<span class="hljs-keyword">void</span>)                 {cJSON *item=cJSON_New_Item();<span class="hljs-keyword">if</span>(item)item-&gt;type=cJSON_Object;<span class="hljs-keyword">return</span> item;}

<span class="hljs-comment">//创建数组类型的cJSON对象【int float double string】</span>
<span class="hljs-comment">/* Create Arrays: */</span>
cJSON *cJSON_CreateIntArray(<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> *numbers,<span class="hljs-keyword">int</span> count)       {
    <span class="hljs-keyword">int</span> i;
    cJSON *n=<span class="hljs-number">0</span>,*p=<span class="hljs-number">0</span>,*a=cJSON_CreateArray();
    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;a &amp;&amp; i&lt;count;i++){
        n=cJSON_CreateNumber(numbers[i]);
        <span class="hljs-keyword">if</span>(!i)a-&gt;child=n;
        <span class="hljs-keyword">else</span> suffix_object(p,n);
        p=n;
    }
    <span class="hljs-keyword">return</span> a;
}
cJSON *cJSON_CreateFloatArray(<span class="hljs-keyword">const</span> <span class="hljs-keyword">float</span> *numbers,<span class="hljs-keyword">int</span> count)   {<!-- --><span class="hljs-keyword">int</span> i;cJSON *n=<span class="hljs-number">0</span>,*p=<span class="hljs-number">0</span>,*a=cJSON_CreateArray();<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;a &amp;&amp; i&lt;count;i++){n=cJSON_CreateNumber(numbers[i]);<span class="hljs-keyword">if</span>(!i)a-&gt;child=n;<span class="hljs-keyword">else</span> suffix_object(p,n);p=n;}<span class="hljs-keyword">return</span> a;}
cJSON *cJSON_CreateDoubleArray(<span class="hljs-keyword">const</span> <span class="hljs-keyword">double</span> *numbers,<span class="hljs-keyword">int</span> count) {<!-- --><span class="hljs-keyword">int</span> i;cJSON *n=<span class="hljs-number">0</span>,*p=<span class="hljs-number">0</span>,*a=cJSON_CreateArray();<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;a &amp;&amp; i&lt;count;i++){n=cJSON_CreateNumber(numbers[i]);<span class="hljs-keyword">if</span>(!i)a-&gt;child=n;<span class="hljs-keyword">else</span> suffix_object(p,n);p=n;}<span class="hljs-keyword">return</span> a;}
cJSON *cJSON_CreateStringArray(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> **strings,<span class="hljs-keyword">int</span> count)  {
    <span class="hljs-keyword">int</span> i;
    cJSON *n=<span class="hljs-number">0</span>,*p=<span class="hljs-number">0</span>,*a=cJSON_CreateArray();
    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;a &amp;&amp; i&lt;count;i++){
        n=cJSON_CreateString(strings[i]);
        <span class="hljs-keyword">if</span>(!i)a-&gt;child=n;
        <span class="hljs-keyword">else</span> suffix_object(p,n);
        p=n;
    }
    <span class="hljs-keyword">return</span> a;
}

<span class="hljs-comment">//复制【递归】</span>
<span class="hljs-comment">/* Duplication */</span>
cJSON *cJSON_Duplicate(cJSON *item,<span class="hljs-keyword">int</span> recurse)
{
    cJSON *newitem,*cptr,*nptr=<span class="hljs-number">0</span>,*newchild;
    <span class="hljs-comment">/* Bail on bad ptr */</span>
    <span class="hljs-keyword">if</span> (!item) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    <span class="hljs-comment">/* Create new item */</span>
    newitem=cJSON_New_Item();
    <span class="hljs-keyword">if</span> (!newitem) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    <span class="hljs-comment">//拷贝所有的字段</span>
    <span class="hljs-comment">/* Copy over all vars */</span>
    newitem-&gt;type=item-&gt;type&amp;(~cJSON_IsReference),newitem-&gt;valueint=item-&gt;valueint,newitem-&gt;valuedouble=item-&gt;valuedouble;
    <span class="hljs-keyword">if</span> (item-&gt;valuestring)  {newitem-&gt;valuestring=cJSON_strdup(item-&gt;valuestring);  <span class="hljs-keyword">if</span> (!newitem-&gt;valuestring)  {cJSON_Delete(newitem);<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}}
    <span class="hljs-keyword">if</span> (item-&gt;<span class="hljs-keyword">string</span>)       {newitem-&gt;<span class="hljs-keyword">string</span>=cJSON_strdup(item-&gt;<span class="hljs-keyword">string</span>);            <span class="hljs-keyword">if</span> (!newitem-&gt;<span class="hljs-keyword">string</span>)       {cJSON_Delete(newitem);<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}}

    <span class="hljs-comment">/* If non-recursive, then we're done! */</span>
    <span class="hljs-keyword">if</span> (!recurse) <span class="hljs-keyword">return</span> newitem;
    <span class="hljs-comment">/* Walk the -&gt;next chain for the child. */</span>
    cptr=item-&gt;child;
    <span class="hljs-keyword">while</span> (cptr)
    {
        newchild=cJSON_Duplicate(cptr,<span class="hljs-number">1</span>);       <span class="hljs-comment">/* Duplicate (with recurse) each item in the -&gt;next chain */</span>
        <span class="hljs-keyword">if</span> (!newchild) {cJSON_Delete(newitem);<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}
        <span class="hljs-keyword">if</span> (nptr)   {nptr-&gt;next=newchild,newchild-&gt;prev=nptr;nptr=newchild;}    <span class="hljs-comment">/* If newitem-&gt;child already set, then crosswire -&gt;prev and -&gt;next and move on */</span>
        <span class="hljs-keyword">else</span>        {newitem-&gt;child=newchild;nptr=newchild;}                    <span class="hljs-comment">/* Set newitem-&gt;child and move to it */</span>
        <span class="hljs-comment">//下一个节点</span>
        cptr=cptr-&gt;next;
    }
    <span class="hljs-keyword">return</span> newitem;
}
<span class="hljs-comment">//简化json的表示</span>
<span class="hljs-comment">//"{//xilo\n/*11*/\"\\ jei\":\"lli\"}"</span>
<span class="hljs-comment">//=====&gt;</span>
<span class="hljs-comment">//{"\ jei":"lli"}</span>
<span class="hljs-keyword">void</span> cJSON_Minify(<span class="hljs-keyword">char</span> *json)
{
    <span class="hljs-keyword">char</span> *<span class="hljs-keyword">into</span>=json;
    <span class="hljs-keyword">while</span> (*json)
    {
        <span class="hljs-keyword">if</span> (*json==<span class="hljs-string">' '</span>) json++;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*json==<span class="hljs-string">'\t'</span>) json++;   <span class="hljs-comment">/* Whitespace characters. */</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*json==<span class="hljs-string">'\r'</span>) json++;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*json==<span class="hljs-string">'\n'</span>) json++;
        <span class="hljs-comment">//删除单行注释://</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*json==<span class="hljs-string">'/'</span> &amp;&amp; json[<span class="hljs-number">1</span>]==<span class="hljs-string">'/'</span>)  <span class="hljs-keyword">while</span> (*json &amp;&amp; *json!=<span class="hljs-string">'\n'</span>) json++;  <span class="hljs-comment">/* double-slash comments, to end of line. */</span>
        <span class="hljs-comment">//删除多行注释：/**/</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*json==<span class="hljs-string">'/'</span> &amp;&amp; json[<span class="hljs-number">1</span>]==<span class="hljs-string">'*'</span>) {
            <span class="hljs-keyword">while</span> (*json &amp;&amp; !(*json==<span class="hljs-string">'*'</span> &amp;&amp; json[<span class="hljs-number">1</span>]==<span class="hljs-string">'/'</span>))
                json++;
            json+=<span class="hljs-number">2</span>;
        }   <span class="hljs-comment">/* multiline comments. */</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (*json==<span class="hljs-string">'\"'</span>){
            *<span class="hljs-keyword">into</span>++=*json++;
            <span class="hljs-keyword">while</span> (*json &amp;&amp; *json!=<span class="hljs-string">'\"'</span>){
                <span class="hljs-keyword">if</span> (*json==<span class="hljs-string">'\\'</span>)
                    *<span class="hljs-keyword">into</span>++=*json++;
                *<span class="hljs-keyword">into</span>++=*json++;
            }
            *<span class="hljs-keyword">into</span>++=*json++;
        } <span class="hljs-comment">/* string literals, which are \" sensitive. */</span>
        <span class="hljs-keyword">else</span> *<span class="hljs-keyword">into</span>++=*json++;           <span class="hljs-comment">/* All other characters. */</span>
    }
    *<span class="hljs-keyword">into</span>=<span class="hljs-number">0</span>;    <span class="hljs-comment">/* and null-terminate. */</span>
}
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2e27ebecdf9e4011ec325158e1811a10/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[MyBatis]模糊查询LIKE的三种方式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e0c9b25f77c46e294c60901755de377b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">git 解决fatal: Not a git repository</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>