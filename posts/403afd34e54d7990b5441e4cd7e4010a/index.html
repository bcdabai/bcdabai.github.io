<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>YOLOv8训练自己的数据集,通过LabelImg - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="YOLOv8训练自己的数据集,通过LabelImg" />
<meta property="og:description" content="记录下labelImg标注数据到YOLOv8训练的过程,其中容易遇到labelImg的坑
数据集处理 首先在mydata下创建4个文件夹 images文件夹下存放着所有的图片，包括训练集和测试集等。后续会根据代码进行划分。
json文件夹里存放的是labelImg标注的所有数据。需要注意的是，json文件的命名应与images文件夹中的图片一一对应。labels文件夹是空的，后续会根据代码将json转化为YOLOv8支持的训练数据集。接下来需要创建一个 split_train_val.py 文件，放在mydata目录下，用于将images文件夹中的图片划分为训练集和测试集。代码如下：
import os import json import random import argparse class DatasetSplitter: def __init__(self, json_path, txt_path): self.json_path = json_path self.txt_path = txt_path self.trainval_percent = 1.0 self.train_percent = 0.9 self.total_json = os.listdir(json_path) self.num = len(self.total_json) self.list_index = list(range(self.num)) if not os.path.exists(txt_path): os.makedirs(txt_path) def split_dataset(self): tv = int(self.num * self.trainval_percent) tr = int(tv * self.train_percent) trainval = random.sample(self.list_index, tv) train = random.sample(trainval, tr) file_trainval = open(os.path.join(self.txt_path, &#39;trainval." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/403afd34e54d7990b5441e4cd7e4010a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-26T14:57:17+08:00" />
<meta property="article:modified_time" content="2024-01-26T14:57:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">YOLOv8训练自己的数据集,通过LabelImg</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>记录下labelImg标注数据到YOLOv8训练的过程,其中容易遇到labelImg的坑</p> 
</blockquote> 
<h2><a id="_1"></a>数据集处理</h2> 
<h3><a id="mydata4_2"></a>首先在mydata下创建4个文件夹</h3> 
<p><img src="https://images2.imgbox.com/26/a3/U5x8EWkA_o.png" alt="在这里插入图片描述"><br> images文件夹下存放着所有的图片，包括训练集和测试集等。后续会根据代码进行划分。<br> json文件夹里存放的是labelImg标注的所有数据。需要注意的是，json文件的命名应与images文件夹中的图片一一对应。labels文件夹是空的，后续会根据代码将json转化为YOLOv8支持的训练数据集。接下来需要创建一个 <code>split_train_val.py</code> 文件，放在mydata目录下，用于将images文件夹中的图片划分为训练集和测试集。代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> json
<span class="token keyword">import</span> random
<span class="token keyword">import</span> argparse

<span class="token keyword">class</span> <span class="token class-name">DatasetSplitter</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> json_path<span class="token punctuation">,</span> txt_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>json_path <span class="token operator">=</span> json_path
        self<span class="token punctuation">.</span>txt_path <span class="token operator">=</span> txt_path
        self<span class="token punctuation">.</span>trainval_percent <span class="token operator">=</span> <span class="token number">1.0</span>
        self<span class="token punctuation">.</span>train_percent <span class="token operator">=</span> <span class="token number">0.9</span>

        self<span class="token punctuation">.</span>total_json <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>json_path<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>total_json<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>list_index <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>txt_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>txt_path<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">split_dataset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        tv <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>num <span class="token operator">*</span> self<span class="token punctuation">.</span>trainval_percent<span class="token punctuation">)</span>
        tr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>tv <span class="token operator">*</span> self<span class="token punctuation">.</span>train_percent<span class="token punctuation">)</span>
        trainval <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>self<span class="token punctuation">.</span>list_index<span class="token punctuation">,</span> tv<span class="token punctuation">)</span>
        train <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>trainval<span class="token punctuation">,</span> tr<span class="token punctuation">)</span>

        file_trainval <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>txt_path<span class="token punctuation">,</span> <span class="token string">'trainval.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
        file_test <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>txt_path<span class="token punctuation">,</span> <span class="token string">'test.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
        file_train <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>txt_path<span class="token punctuation">,</span> <span class="token string">'train.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
        file_val <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>txt_path<span class="token punctuation">,</span> <span class="token string">'val.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> self<span class="token punctuation">.</span>list_index<span class="token punctuation">:</span>
            name <span class="token operator">=</span> self<span class="token punctuation">.</span>total_json<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'\n'</span>  <span class="token comment"># Assuming filenames end with '.json'</span>
            <span class="token keyword">if</span> i <span class="token keyword">in</span> trainval<span class="token punctuation">:</span>
                file_trainval<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
                <span class="token keyword">if</span> i <span class="token keyword">in</span> train<span class="token punctuation">:</span>
                    file_train<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    file_val<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                file_test<span class="token punctuation">.</span>write<span class="token punctuation">(</span>name<span class="token punctuation">)</span>

        file_trainval<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        file_train<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        file_val<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        file_test<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--json_path'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'json'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'input json label path'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--txt_path'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'dataSet'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'output txt label path'</span><span class="token punctuation">)</span>
    opt <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

    dataset_splitter <span class="token operator">=</span> DatasetSplitter<span class="token punctuation">(</span>opt<span class="token punctuation">.</span>json_path<span class="token punctuation">,</span> opt<span class="token punctuation">.</span>txt_path<span class="token punctuation">)</span>
    dataset_splitter<span class="token punctuation">.</span>split_dataset<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>运行后会在dataSet生成四个文件.<br> <img src="https://images2.imgbox.com/08/46/dByhAHb6_o.png" alt="如图所示"><br> 然后前往mydata目录的上一级目录,例如我这里是<code>test</code>目录下,创建<code>voc_label.py</code>文件.用于将labelImg标注的json数据转化为txt文本数据.</p> 
<blockquote> 
 <p><em><strong>请注意，YULO的标注框中的x和y表示矩形框的左上角，而labelImg中的(x,y,w,h)可能表示矩形框的中心点坐标。在使用时需要确认，以免训练出来的YOLO存在偏差。</strong></em><br> 可以通过以下代码<code>draw_picture_by_json.py</code>进行绘图测试,以下我是默认labelImg的格式是(x_center,y_center,w,h)的格式进行绘制.</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image<span class="token punctuation">,</span> ImageDraw
<span class="token keyword">import</span> json

<span class="token keyword">def</span> <span class="token function">draw_pic_by_raw_data</span><span class="token punctuation">(</span>image_path<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">,</span> output_path<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">,</span> json_data<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> json_data
    img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span>
    draw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token comment"># Load JSON file with bounding box information</span>
    <span class="token comment"># Iterate through bounding boxes and draw them on the image</span>
    annotations <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"annotations"</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> bbox <span class="token keyword">in</span> annotations<span class="token punctuation">:</span>
        label <span class="token operator">=</span> bbox<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span>
        x_center<span class="token punctuation">,</span> y_center<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token operator">=</span> <span class="token punctuation">(</span>
            bbox<span class="token punctuation">[</span><span class="token string">"coordinates"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"x"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            bbox<span class="token punctuation">[</span><span class="token string">"coordinates"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"y"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            bbox<span class="token punctuation">[</span><span class="token string">"coordinates"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"width"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            bbox<span class="token punctuation">[</span><span class="token string">"coordinates"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"height"</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
        <span class="token comment">#FIXME TODO 从中心坐标x,y LabelImg 计算左上角坐标</span>
        x<span class="token punctuation">,</span> y <span class="token operator">=</span> x_center <span class="token operator">-</span> width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> y_center <span class="token operator">-</span> height <span class="token operator">/</span> <span class="token number">2</span>

        <span class="token comment"># Draw bounding box</span>
        draw<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token operator">+</span>width<span class="token punctuation">,</span> y<span class="token operator">+</span>height<span class="token punctuation">]</span><span class="token punctuation">,</span> outline<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>


        <span class="token comment"># Draw label</span>
        draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token operator">-</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> label<span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">)</span>

    <span class="token comment"># Save the result</span>
    img<span class="token punctuation">.</span>save<span class="token punctuation">(</span>output_path<span class="token punctuation">)</span>
    img<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    test_img_path <span class="token operator">=</span> <span class="token string">"3157.jpg"</span>
    test_json_path <span class="token operator">=</span> <span class="token string">"3157.json"</span>
    output_path <span class="token operator">=</span> <span class="token string">"out.jpg"</span>

    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>test_json_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

    draw_pic_by_raw_data<span class="token punctuation">(</span>test_img_path<span class="token punctuation">,</span> output_path<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
</code></pre> 
<p>通过以上代码，如果矩形框正确，则验证了labelImg的x、y、w和h坐标应该是x_center、y_center、w和h的情况。需要在将json转换为txt文本时进行处理。这里给出<code>voc_label.py</code>的代码如下：请注意修改classes中的类别，修改为和mydata.yaml的顺序一致，否则会导致标签错误。</p> 
<blockquote> 
 <p>代码运行前请在<code>mydata</code>目录的上一级,也就是我这里的<code>test</code>目录下创建一个<code>paper_data</code>文件夹,用于等会在mydata.yaml中指定路径.</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> json
<span class="token keyword">from</span> os <span class="token keyword">import</span> getcwd

sets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'val'</span><span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">]</span>
classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token string">"E"</span><span class="token punctuation">]</span>  <span class="token comment"># 请根据您的实际类别进行修改 对齐yaml文件中的names</span>
abs_path <span class="token operator">=</span> os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>abs_path<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">convert</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> box<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dw <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">.</span> <span class="token operator">/</span> size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    dh <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">.</span> <span class="token operator">/</span> size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    x <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span> <span class="token operator">-</span> <span class="token number">1</span>
    y <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span> <span class="token operator">-</span> <span class="token number">1</span>
    w <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    h <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    x <span class="token operator">=</span> x <span class="token operator">*</span> dw
    w <span class="token operator">=</span> w <span class="token operator">*</span> dw
    y <span class="token operator">=</span> y <span class="token operator">*</span> dh
    h <span class="token operator">=</span> h <span class="token operator">*</span> dh
    <span class="token keyword">return</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h


<span class="token keyword">def</span> <span class="token function">convert_annotation</span><span class="token punctuation">(</span>image_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    in_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'mydata/json/%s.json'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>image_id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'UTF-8'</span><span class="token punctuation">)</span>
    out_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'mydata/labels/%s.txt'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>image_id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>in_file<span class="token punctuation">)</span>
    <span class="token keyword">for</span> obj <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"annotations"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        w <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string">"coordinates"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"width"</span><span class="token punctuation">]</span>
        h <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string">"coordinates"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"height"</span><span class="token punctuation">]</span>
        difficult <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># JSON数据中没有difficult字段，设为0</span>
        cls <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> cls <span class="token keyword">not</span> <span class="token keyword">in</span> classes <span class="token keyword">or</span> difficult <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        cls_id <span class="token operator">=</span> classes<span class="token punctuation">.</span>index<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>
        <span class="token comment">##注意：这里的box是左上角和右下角的坐标，而不是中心点坐标</span>
        x_center <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string">"coordinates"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"x"</span><span class="token punctuation">]</span>
        y_center <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string">"coordinates"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"y"</span><span class="token punctuation">]</span>
        width <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string">"coordinates"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"width"</span><span class="token punctuation">]</span>
        height <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string">"coordinates"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"height"</span><span class="token punctuation">]</span>
        x<span class="token punctuation">,</span> y <span class="token operator">=</span> x_center <span class="token operator">-</span> width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> y_center <span class="token operator">-</span> height <span class="token operator">/</span> <span class="token number">2</span>
        b <span class="token operator">=</span> x<span class="token punctuation">,</span> x <span class="token operator">+</span> width<span class="token punctuation">,</span> y<span class="token punctuation">,</span> y <span class="token operator">+</span> height
        <span class="token comment"># b = obj["coordinates"]["x"], obj["coordinates"]["x"] + obj["coordinates"]["width"], \</span>
        <span class="token comment">#     obj["coordinates"]["y"], obj["coordinates"]["y"] + obj["coordinates"]["height"]</span>
        b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">,</span> b4 <span class="token operator">=</span> b
        <span class="token comment"># 标注越界修正</span>
        <span class="token keyword">if</span> b2 <span class="token operator">&gt;</span> w<span class="token punctuation">:</span>
            b2 <span class="token operator">=</span> w
        <span class="token keyword">if</span> b4 <span class="token operator">&gt;</span> h<span class="token punctuation">:</span>
            b4 <span class="token operator">=</span> h
        b <span class="token operator">=</span> <span class="token punctuation">(</span>b1<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> b3<span class="token punctuation">,</span> b4<span class="token punctuation">)</span>
        bb <span class="token operator">=</span> convert<span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
        out_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>cls_id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token keyword">for</span> a <span class="token keyword">in</span> bb<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>


wd <span class="token operator">=</span> getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> image_set <span class="token keyword">in</span> sets<span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'mydata/labels/'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">'mydata/labels/'</span><span class="token punctuation">)</span>
    image_ids <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'mydata/dataSet/%s.txt'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>image_set<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
    list_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'paper_data/%s.txt'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>image_set<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> image_id <span class="token keyword">in</span> image_ids<span class="token punctuation">:</span>
        list_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>abs_path <span class="token operator">+</span> <span class="token string">'/mydata/images/%s.jpg\n'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>image_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
        convert_annotation<span class="token punctuation">(</span>image_id<span class="token punctuation">)</span>
    list_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="yaml_186"></a>yaml文件配置</h2> 
<p>截止到这里数据preprocess处理完毕.接下来进行训练前的yaml文件配置.<br> 修改为刚才创建的paper_data的绝对路径<br> <img src="https://images2.imgbox.com/87/ef/er15o6CF_o.png" alt="如上配置"></p> 
<blockquote> 
 <p><strong>并进行names的配置,注意顺序和数量需要与<code>voc_label.py</code>里面的列表顺序一致.</strong></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/a7/4c/5YzjCQxq_o.png" alt=""></p> 
<h2><a id="yolov8yaml_194"></a>最后修改yolov8.yaml文件配置</h2> 
<p>yolov8.yaml的路径一般在<code>ultralytics/ultralytics/cfg/models/v8</code>目录下<br> 修改nc为names中的类别数量<br> <img src="https://images2.imgbox.com/94/ee/vcdVSKCV_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_198"></a>训练模型</h2> 
<pre><code class="prism language-bash">yolo <span class="token assign-left variable">task</span><span class="token operator">=</span>detect <span class="token assign-left variable">mode</span><span class="token operator">=</span>train <span class="token assign-left variable">model</span><span class="token operator">=</span>yolov8s.yaml <span class="token assign-left variable">data</span><span class="token operator">=</span>mydata.yaml <span class="token assign-left variable">epochs</span><span class="token operator">=</span><span class="token number">25</span> <span class="token assign-left variable">batch</span><span class="token operator">=</span><span class="token number">16</span>
</code></pre> 
<p>这些模型可以支持多种尺寸，包括小(n)、中(s)、中大(m)、大(l)和超大(x)。模型的尺寸参数越大，所需的显存和训练时间也越多。要切换模型尺寸，只需在"model=yolov8"后面加上相应的尺寸参数(n、s、m、l、x)，然后再加上.yaml即可。另外，epochs设置为25，batch大小为16。epochs表示训练的轮数, batch为每个批次的样本数量为16.</p> 
<h2><a id="_205"></a>推理</h2> 
<p>训练结束后可以通过以下代码进行测试.</p> 
<pre><code class="prism language-bash">yolo predict <span class="token assign-left variable">model</span><span class="token operator">=</span>xxxx/weights/best.pt <span class="token assign-left variable">source</span><span class="token operator">=</span>xxxx/mydata/testvedio.mp4 <span class="token assign-left variable">imgsz</span><span class="token operator">=</span><span class="token number">1280</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1840e48b4f7551cf003b4dda5a449f77/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">软考培训机构哪家比较好？各软考培训机构排名如何？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cba28e114e71b448ee238d270165868b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">2023年衣物清洁赛道行业数据分析（电商数据查询）：总销额同比下滑21%</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>