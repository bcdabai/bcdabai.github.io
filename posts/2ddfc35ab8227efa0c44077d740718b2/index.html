<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>synchronized锁的升级过程详细介绍,轻量级锁重量级锁偏向锁无锁 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="synchronized锁的升级过程详细介绍,轻量级锁重量级锁偏向锁无锁" />
<meta property="og:description" content="01 优化一
优化之后和Lock效率差不多
重量级锁，假如锁竞争激烈，性能会急剧下降，涉及用户态(用户正在使用)和内核态间的转变
在Java6通过引入锁升级的机制来实现高效Synchronized。这三种锁的状态是通过对象监视器在对象头中的字段来表明的。
synchronized监视器锁在互斥同步上对性能的影响很大。Java的线程是映射到操作系统原生线程之上的，如果要阻塞或唤醒一个线程就需要操作系统的帮忙，需要用户态和内核态之间的转换，状态转换需要花费很多的处理器时间，大大消耗性能，因为用户态和内核态都有自己的内存空间，专用的额寄存器等，用户态切换到内核态需要传递给许多变量参数给内核，内核也需要保护好用户态在切换时的一些寄存器值变量值，这种锁机制也被称为重量级锁，如果同步代码的内容比较简单，切换的时间比代码执行的时间还要长
jdk1.6后对synchronized进行优化，减少获得锁和释放锁带来的性能消耗，引入了偏向锁和轻量级锁，协调线程安全性和性能的平衡，这种优化主要解决上下文频繁切换，由于Java层面的线程与操作系统的原生线程有映射关系，如果要将一个线程进行阻塞或唤起都需要操作系统的协助，这就需要从用户态切换到内核态来执行，这种切换代价十分昂贵，很耗处理器时间。
锁的状态总共有四种：无锁状态、偏向锁、轻量级锁和重量级锁。随着锁的竞争，锁可以从偏向锁升级到轻量级锁，再升级的重量级锁。JDK 1.6中默认是开启偏向锁和轻量级锁的，也可以通过-XX:-UseBiasedLocking来禁用偏向锁。
锁的升级是单向的，也就是说只能从低到高升级，不会出现锁的降级
无锁状态
偏向锁状态
一段同步代码一直被一个线程所访问，那么该线程会自动获取锁。降低获取锁的代价。
轻量级锁状态
当锁是偏向锁时，被另一线程所访问，偏向锁就好升级为轻量级锁，其他线程会通过自旋的形式尝试获取锁，不会阻塞，提供性能。
重量级锁状态
当锁为轻量级锁时，另一个线程虽然是自旋，但自旋不会一直持续下去，当自旋一定次数后还没获取到锁，就进入阻塞，该锁膨胀为重量级锁。重量级锁会让其他申请的线程进入阻塞，性能降低。
重量级锁需要通过操作系统在用户态与核心态之间切换，就像它的名字是一个重量级操作，这也是synchronized效率不高的原因
01 无锁
对象锁没有被线程拥有，最后两位是01
下面函数打对象头信息
Object object = new Object(); System.out.println(ClassLayout.parseInstance(object).toPrintable()); 第一行和第二行是对象mark Word，是8个字节，每8位是一个字节，每8位倒着看，每8位里面又是从左到右看，只有第一个8位的后面的两位是01，是无锁
hashCode在不调用的时候是空的，所以hashCode的占位为空
java.lang.Object object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 4 (object header) 01 00 00 00 (00000001 00000000 00000000 00000000) (1) 4 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 8 4 (object header) 28 0f ff 7f (00101000 00001111 11111111 01111111) (2147421992) 12 4 (loss due to the next object alignment) Instance size: 16 bytes Space losses: 0 bytes internal &#43; 4 bytes external = 4 bytes total 如果调用hashCode" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2ddfc35ab8227efa0c44077d740718b2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-21T12:41:18+08:00" />
<meta property="article:modified_time" content="2023-03-21T12:41:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">synchronized锁的升级过程详细介绍,轻量级锁重量级锁偏向锁无锁</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>01 优化一</p> 
<p>优化之后和Lock效率差不多<br> 重量级锁，假如锁竞争激烈，性能会急剧下降，涉及用户态(用户正在使用)和内核态间的转变<br> 在Java6通过引入锁升级的机制来实现高效Synchronized。这三种锁的状态是通过对象监视器在对象头中的字段来表明的。</p> 
<p>synchronized监视器锁在互斥同步上对性能的影响很大。Java的线程是映射到操作系统原生线程之上的，如果要阻塞或唤醒一个线程就需要操作系统的帮忙，需要用户态和内核态之间的转换，状态转换需要花费很多的处理器时间，大大消耗性能，因为用户态和内核态都有自己的内存空间，专用的额寄存器等，用户态切换到内核态需要传递给许多变量参数给内核，内核也需要保护好用户态在切换时的一些寄存器值变量值，这种锁机制也被称为重量级锁，如果同步代码的内容比较简单，切换的时间比代码执行的时间还要长<br> jdk1.6后对synchronized进行优化，减少获得锁和释放锁带来的性能消耗，引入了偏向锁和轻量级锁，协调线程安全性和性能的平衡，这种优化主要解决上下文频繁切换，由于Java层面的线程与操作系统的原生线程有映射关系，如果要将一个线程进行阻塞或唤起都需要操作系统的协助，这就需要从用户态切换到内核态来执行，这种切换代价十分昂贵，很耗处理器时间。</p> 
<p><img src="https://images2.imgbox.com/51/0c/mBG3d8V5_o.png" alt="在这里插入图片描述"></p> 
<p>锁的状态总共有四种：无锁状态、偏向锁、轻量级锁和重量级锁。随着锁的竞争，锁可以从偏向锁升级到轻量级锁，再升级的重量级锁。JDK 1.6中默认是开启偏向锁和轻量级锁的，也可以通过-XX:-UseBiasedLocking来禁用偏向锁。</p> 
<p>锁的升级是单向的，也就是说只能从低到高升级，不会出现锁的降级</p> 
<p>无锁状态</p> 
<p>偏向锁状态<br> 一段同步代码一直被一个线程所访问，那么该线程会自动获取锁。降低获取锁的代价。<br> 轻量级锁状态<br> 当锁是偏向锁时，被另一线程所访问，偏向锁就好升级为轻量级锁，其他线程会通过自旋的形式尝试获取锁，不会阻塞，提供性能。<br> 重量级锁状态<br> 当锁为轻量级锁时，另一个线程虽然是自旋，但自旋不会一直持续下去，当自旋一定次数后还没获取到锁，就进入阻塞，该锁膨胀为重量级锁。重量级锁会让其他申请的线程进入阻塞，性能降低。<br> 重量级锁需要通过操作系统在用户态与核心态之间切换，就像它的名字是一个重量级操作，这也是synchronized效率不高的原因</p> 
<hr> 
<p>01 无锁</p> 
<p>对象锁没有被线程拥有，最后两位是01</p> 
<p><img src="https://images2.imgbox.com/04/07/GU3AMcnX_o.png" alt="在这里插入图片描述"></p> 
<p>下面函数打对象头信息</p> 
<pre><code class="prism language-cpp">Object object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ClassLayout<span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>第一行和第二行是对象mark Word，是8个字节，每8位是一个字节，每8位倒着看，每8位里面又是从左到右看，只有第一个8位的后面的两位是01，是无锁<br> hashCode在不调用的时候是空的，所以hashCode的占位为空</p> 
<pre><code class="prism language-cpp">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object object internals<span class="token operator">:</span>
OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
<span class="token number">0</span>         <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000001</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">4</span>         <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">8</span>         <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">28</span> <span class="token number">0f</span> ff <span class="token number">7f</span> <span class="token punctuation">(</span><span class="token number">00101000</span> <span class="token number">00001111</span> <span class="token number">11111111</span> <span class="token number">01111111</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">2147421992</span><span class="token punctuation">)</span>
<span class="token number">12</span>        <span class="token number">4</span>        <span class="token punctuation">(</span>loss due to the next object alignment<span class="token punctuation">)</span>
Instance size<span class="token operator">:</span> <span class="token number">16</span> bytes
Space losses<span class="token operator">:</span> <span class="token number">0</span> bytes internal <span class="token operator">+</span> <span class="token number">4</span> bytes external <span class="token operator">=</span> <span class="token number">4</span> bytes total
</code></pre> 
<p>如果调用hashCode</p> 
<pre><code class="prism language-cpp">Object object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"======二进制"</span> <span class="token operator">+</span>Integer<span class="token punctuation">.</span><span class="token function">toBinaryString</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"======十六进制"</span> <span class="token operator">+</span>Integer<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ClassLayout<span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>======十进制21685669<br> ======二进制1010010101110010110100101<br> ======十六进制14ae5a5<br> java.lang.Object object internals:<br> OFFSET SIZE TYPE DESCRIPTION VALUE<br> 0 4 (object header) 01 a5 e5 4a (00000001 10100101 11100101 01001010) (1256563969)<br> 4 4 (object header) 01 00 00 00 (00000001 00000000 00000000 00000000) (1)<br> 8 4 (object header) 28 0f ff 7f (00101000 00001111 11111111 01111111) (2147421992)<br> 12 4 (loss due to the next object alignment)<br> Instance size: 16 bytes<br> Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</p> 
<hr> 
<p>如果把偏向锁的延迟时间设置为0(或者4秒后再进行锁竞争，因为默认偏向锁是4秒开启)， 哪怕没有synchronic也直接是偏向锁，记录线程id的位置为空<br> -XX:BiasedLockingStartupDelay=0</p> 
<pre><code class="prism language-cpp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Object object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ClassLayout<span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-cpp">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object object internals<span class="token operator">:</span>
OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
<span class="token number">0</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">05</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000101</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token number">4</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">8</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">28</span> <span class="token number">0f</span> ff <span class="token number">7f</span> <span class="token punctuation">(</span><span class="token number">00101000</span> <span class="token number">00001111</span> <span class="token number">11111111</span> <span class="token number">01111111</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">2147421992</span><span class="token punctuation">)</span>
<span class="token number">12</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>loss due to the next object alignment<span class="token punctuation">)</span>
Instance size<span class="token operator">:</span> <span class="token number">16</span> bytes
Space losses<span class="token operator">:</span> <span class="token number">0</span> bytes internal <span class="token operator">+</span> <span class="token number">4</span> bytes external <span class="token operator">=</span> <span class="token number">4</span> bytes total
</code></pre> 
<hr> 
<p>01 偏向锁</p> 
<p>当有线程获取对象锁时，从无锁变为偏向锁，把线程ID设置为自己的，是否偏向锁改为偏向锁，使用的是cas更新</p> 
<pre><code> 大多数情况下锁不仅不存在多线程竞争，且总由同一个线程多次获取，不需要重量级锁的操作系统的用户态和内核态之间的切换，偏向锁让线程获得锁的代价更低，如果是同一个线程就消除了同步，先检测锁标记位是否是偏向锁，再检查mark word里面的线程id是不是自己，如果是就不需要再加锁释放锁，直接进入同步，不需要cas去更新头部信息，偏向锁几乎没有性能开销，性能很高，如果mark word里面的线程id不是自己的，会cas去更新为自己，如果更新成功，则偏向锁又会偏向于自己线程，锁不会升级，如果更新失败，有可能会升级为轻量级锁
 偏向锁只有在其他线程尝试竞争的时候才会释放，线程不会主动释放偏向锁
  一个同步方法被一个线程抢占到时，mark word里面会把锁最后三个标志位改为101，同时还会占用前54位记录当前线程id，若该线程再次访问时，只需判断偏向锁是否指向自己，不再需要去Monitor去竞争
偏向锁在无多线程竞争的情况下可以减少不必须要的轻量级锁执行路径，相比非同步的方法只有纳米的差距

偏向锁的获取：
</code></pre> 
<p>当对象锁第一次被获取时，在Mark Word中记录下该线程的ID，这个线程称为偏向线程，锁就是偏向锁</p> 
<p><img src="https://images2.imgbox.com/68/84/8hoBo21A_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<p>在linux在中输入下面的命令查看偏向锁信息<br> <img src="https://images2.imgbox.com/df/90/czhsQv3F_o.png" alt="在这里插入图片描述"></p> 
<p>最后一个true表示偏向锁是开启的，java6后默认开启，-XX:-UseBiasedLock，关闭轻量级锁，直接到重量级锁<br> 4000表示启动有延迟4秒， -XX:BiasedLockingStartupDelay=0 ，延迟时间设置为0</p> 
<hr> 
<p>测试</p> 
<pre><code class="prism language-cpp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Object object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">synchronized</span> <span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ClassLayout<span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>加入jvm启动参数， -XX:BiasedLockingStartupDelay=0， 把偏向锁的延迟改为0<br> 可以看到第一个8位(每8位是倒序的)的后三位是101，表示是偏向锁</p> 
<pre><code class="prism language-cpp">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object object internals<span class="token operator">:</span>
OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
<span class="token number">0</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">05</span> e8 <span class="token number">0</span>e <span class="token number">02</span> <span class="token punctuation">(</span><span class="token number">00000101</span> <span class="token number">11101000</span> <span class="token number">00001110</span> <span class="token number">00000010</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">34531333</span><span class="token punctuation">)</span>
<span class="token number">4</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">8</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">28</span> <span class="token number">0f</span> ff <span class="token number">7f</span> <span class="token punctuation">(</span><span class="token number">00101000</span> <span class="token number">00001111</span> <span class="token number">11111111</span> <span class="token number">01111111</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">2147421992</span><span class="token punctuation">)</span>
<span class="token number">12</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>loss due to the next object alignment<span class="token punctuation">)</span>
Instance size<span class="token operator">:</span> <span class="token number">16</span> bytes
Space losses<span class="token operator">:</span> <span class="token number">0</span> bytes internal <span class="token operator">+</span> <span class="token number">4</span> bytes external <span class="token operator">=</span> <span class="token number">4</span> bytes total
</code></pre> 
<p>如果不改延迟为0，直接轻量级锁，显示如下，第一个八位的最后两位是00</p> 
<pre><code class="prism language-cpp">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object object internals<span class="token operator">:</span>
OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
<span class="token number">0</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">68</span> f2 <span class="token number">43</span> <span class="token number">02</span> <span class="token punctuation">(</span><span class="token number">01101000</span> <span class="token number">11110010</span> <span class="token number">01000011</span> <span class="token number">00000010</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">38007400</span><span class="token punctuation">)</span>
<span class="token number">4</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">8</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">28</span> <span class="token number">0f</span> ff <span class="token number">7f</span> <span class="token punctuation">(</span><span class="token number">00101000</span> <span class="token number">00001111</span> <span class="token number">11111111</span> <span class="token number">01111111</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">2147421992</span><span class="token punctuation">)</span>
<span class="token number">12</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>loss due to the next object alignment<span class="token punctuation">)</span>
Instance size<span class="token operator">:</span> <span class="token number">16</span> bytes
Space losses<span class="token operator">:</span> <span class="token number">0</span> bytes internal <span class="token operator">+</span> <span class="token number">4</span> bytes external <span class="token operator">=</span> <span class="token number">4</span> bytes total
</code></pre> 
<hr> 
<p>如果把偏向锁的延迟时间设置为0(或4秒后再进行锁竞争，因为默认偏向锁是4秒开启)， 哪怕没有synchronic也直接是偏向锁，记录线程id的位置为空<br> -XX:BiasedLockingStartupDelay=0</p> 
<pre><code class="prism language-cpp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Object object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ClassLayout<span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-cpp">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Object object internals<span class="token operator">:</span>
OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
<span class="token number">0</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">05</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000101</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token number">4</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">8</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">28</span> <span class="token number">0f</span> ff <span class="token number">7f</span> <span class="token punctuation">(</span><span class="token number">00101000</span> <span class="token number">00001111</span> <span class="token number">11111111</span> <span class="token number">01111111</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">2147421992</span><span class="token punctuation">)</span>
<span class="token number">12</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>loss due to the next object alignment<span class="token punctuation">)</span>
Instance size<span class="token operator">:</span> <span class="token number">16</span> bytes
Space losses<span class="token operator">:</span> <span class="token number">0</span> bytes internal <span class="token operator">+</span> <span class="token number">4</span> bytes external <span class="token operator">=</span> <span class="token number">4</span> bytes total
</code></pre> 
<hr> 
<p>关闭偏向锁<br> -XX:-UseBiasedLocking 开启偏向锁 -XX:+UseBiasedLocking</p> 
<hr> 
<p>01 轻量级锁</p> 
<p>一旦有不同的线程获取或竞争锁对象，使用cas更新对象头失败后<br> 先判断拥有偏向锁的线程是否还在执行，如果不执行，就把偏向锁改为无锁，再cas偏向于当前线程，锁不升级<br> 若之前线程在运行，到了全局安全点(没有字节码执行)，把之前线程暂停(stw)，把锁升级为轻量级锁，仍然是之前线程持有，继续执行同步代码，其他线程cas自旋获取轻量级锁</p> 
<p>Mrak Word存储的是指向线程栈中Lock Record的指针</p> 
<p>目的：在大多数情况下同步块并不会出现竞争情况，都是不同线程交替持有锁，引入轻量级锁可以减少重量级锁对线程的阻塞带来的开销。<br> 轻量级锁认为环境中线程几乎没有对锁对象的竞争，即使有竞争也只需要稍微等待(自旋)下就可以获取锁，但是自旋次数有限制，如果超过该次数，则会升级为重量级锁。</p> 
<p>自旋锁<br> 当锁被占用时，当前想要获取锁的线程不会被立即挂起，而是做几个空循环，看持有锁的线程是否会很快释放锁，在经过若干次循环后，如果得到锁，就顺利进入临界区；如果还不能获得锁，那就会将线程在操作系统层面挂起阻塞</p> 
<p>自适应自旋<br> 自旋的次数不是固定的，它由前一次在同一个锁上的自旋时间及锁的拥有者的状态来决定。线程如果自旋成功了，那么下次自旋的次数会更加多，因为虚拟机认为既然上次成功了，那么此次自旋也很有可能会再次成功，那么它就会允许自旋等待持续的次数更多。如果对于某个锁，很少有自旋能够成功的，那么在以后要或者这个锁的时候自旋的次数会减少甚至省略掉自旋过程，以免浪费处理器资源。随着程序运行和性能监控信息的不断完善，虚拟机对程序锁的状况预测会越来越准确，虚拟机会变得越来越聪明。</p> 
<p>自旋和阻塞的区别<br> 是不是放弃处理器的执行时间，阻塞放弃了CPU时间，进入等待区，等待被唤醒。响应慢。自旋锁一直占用CPU时间，时刻检查共享资源是否可以被访问，所以响应速度更快。</p> 
<p>优点<br> 如果持有锁的线程很快就释放了锁，那么自旋的效率就非常好。<br> 缺点<br> 若持有锁的线程占用锁时间较长，等待锁的线程自旋一定次数后还是拿不到锁而被阻塞，那么自旋就白白浪费了CPU的资源<br> 自旋的次数直接决定了自旋锁的性能。JDK自旋的默认次数为10次，可以通过参数-XX:PreBlockSpin来调整。</p> 
<p>jdk15后开始废弃偏向锁，因为开销比较大，默认已经不开启了，要开始的话要使用jvm参数</p> 
<hr> 
<p>重量级锁</p> 
<p>监视器锁Monitor<br> Mark Word存储的是指向堆中的Monitor对象的指针<br> synchronized监视器锁在互斥同步上对性能的影响很大。Java的线程是映射到操作系统原生线程之上的，如果要阻塞或唤醒一个线程就需要操作系统的帮忙，这就要从用户态转换到内核态，状态转换需要花费很多的处理器时间，大大消耗性能，这种锁机制也被称为重量级锁</p> 
<p>在轻量级锁中，如果cas自旋一直都没有获取的锁，就会消耗很大的cup资源，需要升级为重量级锁<br> 在jdk6前是自旋了10次会升级为重量锁或自旋的线程数超过了cup核数的一半<br> 在jdk6后是自适应自旋锁，如果线程自旋成功了，下次自旋的次数会增加，jvm认为既然上次都成功了那下次大概率也会成功， 如果线程很少会自旋成功，那么下次会减少自旋的次数甚至不自旋，避免cup空转</p> 
<p>有大量的线程争夺锁</p> 
<pre><code> 没有获取锁被阻塞的线程会被加入到阻塞队列中，等待被唤醒去争抢，是非公平公平锁
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/295017498ada516c360e3728416bbf0e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">实现 当 a ＞ b 时交换两数的值（目的是为了让第一个变量永远是两个变量中较小的），要求不使用第三个变量</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ed423d1dbe6e6868de3a4c22150be9a0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">调用chatgpt官方api实现聊天和绘图</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>