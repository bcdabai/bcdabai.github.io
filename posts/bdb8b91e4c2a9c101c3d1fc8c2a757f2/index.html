<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringSecurity OAuth2实现单点登录,微信扫码登录,Redis缓存验证码---入门到实战 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringSecurity OAuth2实现单点登录,微信扫码登录,Redis缓存验证码---入门到实战" />
<meta property="og:description" content="1. 认证授权 1.1 什么是认证授权 ​ 例如课程发布后用户通过在线学习页面点播视频进行学习。如何去记录学生的学习过程呢？要想掌握学生的学习情况就需要知道用户的身份信息，记录哪个用户在什么时间学习什么课程，如果用户要购买课程也需要知道用户的身份信息。所以，去管理学生的学习过程最基本的要实现用户的身份认证。
​ 认证授权模块实现平台所有用户的身份认证与用户授权功能。
​ 用户身份认证即用户去访问系统资源时系统要求验证用户的身份信息，身份合法方可继续访问。常见的用户身份认证的表现形式有：用户名密码登录，微信扫码等方式。
​ 本案例基于黑马程序员2023版的学成在线-Plus中的第五章认证授权v3.1。
1.1.1 什么是用户认证 项目包括学生、学习机构的老师、平台运营人员三类用户，不管哪一类用户在访问项目受保护资源时都需要进行身份认证。比如：发布课程操作，需要学习机构的老师首先登录系统成功，然后再执行发布课程操作。创建订单，需要学生用户首先登录系统，才可以创建订单。如下图：
1.1.2 什么是用户授权 ​ 用户认证通过后去访问系统的资源，系统会判断用户是否拥有访问资源的权限，只允许访问有权限的系统资源，没有权限的资源将无法访问，这个过程叫用户授权。比如：用户去发布课程，系统首先进行用户身份认证，认证通过后继续判断用户是否有发布课程的权限，如果没有权限则拒绝继续访问系统，如果有权限则继续发布课程。如下图：
1.2 单点登录 ​ 用户只需要认证一次便可以在多个拥有访问权限的系统中访问，这个功能叫做单点登录。
​ 引用百度百科：单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。
​ 如下图，用户只需要认证一次，便可以在多个拥有访问权限的系统中访问。
1.3 第三方认证 ​ 为了提高用户体验，很多网站有扫码登录的功能，如：微信扫码登录、QQ扫码登录等。扫码登录的好处是用户不用输入账号和密码，操作简便，另外一个好处就是有利于用户信息的共享，互联网的优势就是资源共享，用户也是一种资源，对于一个新网站如果让用户去注册是很困难的，如果提供了微信扫码登录将省去用户注册的成本，是一种非常有效的推广手段。
​ 微信扫码登录其中的原理正是使用了第三方认证，如下图：
2. Spring Security 认证研究 2.1 Spring Security 介绍 ​ 认证功能几乎是每个项目都要具备的功能，并且它与业务无关，市面上有很多认证框架，如：Apache Shiro、CAS、Spring Security等。由于本项目基于Spring Cloud技术构建，Spring Security是spring家族的一份子且和Spring Cloud集成的很好，所以本项目选用Spring Security作为认证服务的技术框架。
​ Spring Security 是一个功能强大且高度可定制的身份验证和访问控制框架，它是一个专注于为 Java 应用程序提供身份验证和授权的框架。
​ 项目主页：https://spring.io/projects/spring-security
​ Spring cloud Security： https://spring.io/projects/spring-cloud-security
2.2 认证授权入门 2.2.1 认证测试工程 ​ 下边我们使用Spring Security框架快速构建认证授权功能体系。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/bdb8b91e4c2a9c101c3d1fc8c2a757f2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-25T22:07:41+08:00" />
<meta property="article:modified_time" content="2023-04-25T22:07:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringSecurity OAuth2实现单点登录,微信扫码登录,Redis缓存验证码---入门到实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1__0"></a>1. 认证授权</h2> 
<h3><a id="11__2"></a>1.1 什么是认证授权</h3> 
<p>​ 例如课程发布后用户通过在线学习页面点播视频进行学习。如何去记录学生的学习过程呢？要想掌握学生的学习情况就需要知道用户的身份信息，记录哪个用户在什么时间学习什么课程，如果用户要购买课程也需要知道用户的身份信息。所以，去管理学生的学习过程最基本的要实现用户的身份认证。</p> 
<p>​ 认证授权模块实现平台所有用户的身份认证与用户授权功能。</p> 
<p>​ 用户身份认证即用户去访问系统资源时系统要求验证用户的身份信息，身份合法方可继续访问。常见的用户身份认证的表现形式有：用户名密码登录，微信扫码等方式。</p> 
<p>​ 本案例基于黑马程序员<a href="https://www.bilibili.com/video/BV1j8411N7Bm?p=107&amp;vd_source=7f17f63081128ffb90a32de67fb60f76" rel="nofollow">2023版的学成在线-Plus</a>中的第五章认证授权v3.1。</p> 
<h4><a id="111__12"></a>1.1.1 什么是用户认证</h4> 
<p>项目包括学生、学习机构的老师、平台运营人员三类用户，不管哪一类用户在访问项目受保护资源时都需要进行身份认证。比如：发布课程操作，需要学习机构的老师首先登录系统成功，然后再执行发布课程操作。创建订单，需要学生用户首先登录系统，才可以创建订单。如下图：</p> 
<p><img src="https://images2.imgbox.com/8d/a3/rrUmRql7_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-uKrkccZH-1682427813418)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424183350312.png)]"></p> 
<h4><a id="112__19"></a>1.1.2 什么是用户授权</h4> 
<p>​ 用户认证通过后去访问系统的资源，系统会判断用户是否拥有访问资源的权限，只允许访问有权限的系统资源，没有权限的资源将无法访问，这个过程叫用户授权。比如：用户去发布课程，系统首先进行用户身份认证，认证通过后继续判断用户是否有发布课程的权限，如果没有权限则拒绝继续访问系统，如果有权限则继续发布课程。如下图：</p> 
<p><img src="https://images2.imgbox.com/02/50/my0iVxIj_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Gx3GFu5p-1682427813419)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424184342549.png)]"></p> 
<h3><a id="12__26"></a>1.2 单点登录</h3> 
<p>​ 用户只需要认证一次便可以在多个拥有访问权限的系统中访问，这个功能叫做单点登录。</p> 
<p>​ 引用百度百科：<mark>单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统</mark>。</p> 
<p>​ 如下图，用户只需要认证一次，便可以在多个拥有访问权限的系统中访问。</p> 
<p><img src="https://images2.imgbox.com/89/5a/157P4s4q_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-39aSGW3N-1682427813420)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424184622227.png)]"></p> 
<h3><a id="13__37"></a>1.3 第三方认证</h3> 
<p>​ 为了提高用户体验，很多网站有扫码登录的功能，如：微信扫码登录、QQ扫码登录等。扫码登录的好处是用户不用输入账号和密码，操作简便，另外一个好处就是有利于用户信息的共享，互联网的优势就是资源共享，用户也是一种资源，对于一个新网站如果让用户去注册是很困难的，如果提供了微信扫码登录将省去用户注册的成本，是一种非常有效的推广手段。</p> 
<p>​ <mark>微信扫码</mark>登录其中的原理正是使用了第三方认证，如下图：</p> 
<p><img src="https://images2.imgbox.com/68/02/nwJ6Y0Jo_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-rZWAiJHZ-1682427813420)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424184747459.png)]"></p> 
<h2><a id="2_Spring_Security__48"></a>2. Spring Security 认证研究</h2> 
<h3><a id="21_Spring_Security__50"></a>2.1 <strong>Spring Security 介绍</strong></h3> 
<p>​ 认证功能几乎是每个项目都要具备的功能，并且它与业务无关，市面上有很多认证框架，如：Apache Shiro、CAS、Spring Security等。由于本项目基于Spring Cloud技术构建，Spring Security是spring家族的一份子且和Spring Cloud集成的很好，所以本项目选用Spring Security作为认证服务的技术框架。</p> 
<p>​ Spring Security 是一个功能强大且高度可定制的身份验证和访问控制框架，它是一个专注于为 Java 应用程序提供身份验证和授权的框架。</p> 
<p>​ 项目主页：https://spring.io/projects/spring-security</p> 
<p>​ Spring cloud Security： https://spring.io/projects/spring-cloud-security</p> 
<h3><a id="22__60"></a>2.2 <strong>认证授权入门</strong></h3> 
<h4><a id="221__62"></a>2.2.1 认证测试工程</h4> 
<p>​ 下边我们使用Spring Security框架快速构建认证授权功能体系。</p> 
<p>​ 1. 创建一个命名为 auth普通的spring boot工程，可以连接数据库。此工程不具备认证授权的功能。</p> 
<p>​ 2. 创建一个Controller来测试</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> userMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/login-success"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"登录成功"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/user/{id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">getuser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/r/r1"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">r1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"访问r1资源"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/r/r2"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">r2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"访问r2资源"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>启动工程，尝试访问http://localhost:63070/auth/r/r1 , http://localhost:63070/auth/user/52</li></ol> 
<p><img src="https://images2.imgbox.com/6e/af/qh0cJk1I_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-t7HseX4U-1682427813442)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424194437466.png)]"></p> 
<p>​ <img src="https://images2.imgbox.com/d7/5e/DlAKrw8I_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-99KhQoUD-1682427813443)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424194530815.png)]"></p> 
<p>​ 以上测试一切正常说明此工程部署成功。</p> 
<h4><a id="222__113"></a>2.2.2 认证测试</h4> 
<p>​ 1. 向 auth 认证工程集成Spring security，向pom.xml加入Spring Security所需要的依赖。</p> 
<pre><code class="prism language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>​ 2. 重启工程，访问http://localhost:63070/auth/r/r1</p> 
<p>​ 自动进入/login登录页面，/login是spring security提供的,此页面有几个css样式加载会稍微慢点，如下图：</p> 
<p><img src="https://images2.imgbox.com/c6/e1/HfIzISU2_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Ff8eFY6v-1682427813444)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424195217313.png)]"></p> 
<p>​ 那么账号和密码是什么呢？我们需要进行安全配置，创建<mark>WebSecurityConfig</mark>配置类，继承<mark>WebSecurityConfigurerAdapter</mark></p> 
<ol start="3"><li> <p>配置用户信息</p> 
  <ul><li> <p>在内存配置两个用户：zhangsan、lisi</p> </li><li> <p>zhangsan用户拥有的权限为p1</p> </li><li> <p>lisi用户拥有的权限为p2</p> </li></ul> </li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 配置用户信息服务，暂时将用户信息存储在内存，后面会改成从数据库查</span>
    <span class="token class-name">InMemoryUserDetailsManager</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 创建用户信息, Kyle的权限是p1，Lucy的权限是p2</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"p1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"lisi"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"456"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"p2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> manager<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>设置密码的方式 
  <ul><li>密码方式，暂时采用明文的方式</li></ul> </li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">NoOpPasswordEncoder</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>配置安全拦截机制 
  <ul><li>安全拦截机制，<code>/r/**</code>开头的请求需要认证</li></ul> </li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/r/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">successForwardUrl</span><span class="token punctuation">(</span><span class="token string">"/login-success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="6"><li> <p>重启工程</p> 
  <ul><li> <p>访问http://localhost:63070/auth/user/52 可以正常访问</p> </li><li> <p>访问http://localhost:63070/auth/r/r1 显示登录页面</p> </li><li> <p>账号zhangsan，密码为123，如果输入的密码不正确会认证失败，输入正确显示登录成功。</p> </li></ul> </li></ol> 
<h4><a id="223__192"></a>2.2.3 认证测试总结</h4> 
<p>完整代码如下:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 配置用户信息服务，暂时将用户信息存储在内存，后面会改成从数据库查</span>
        <span class="token class-name">InMemoryUserDetailsManager</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 创建用户信息, Kyle的权限是p1，Lucy的权限是p2</span>
        manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"p1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"lisi"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"456"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"p2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> manager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">NoOpPasswordEncoder</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/r/**"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">successForwardUrl</span><span class="token punctuation">(</span><span class="token string">"/login-success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        http<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>配置说明：</p> 
<ol><li>通过 <code>authorizeRequests()</code> 方法来配置请求授权规则。</li><li>使用 <code>antMatchers()</code> 方法指定需要进行访问控制的 <code>URL</code> 路径模式。在这里，<code>/r/**</code> 表示所有以 <code>/r/</code> 开头的 URL 都需要进行授权访问。</li><li>使用 <code>authenticated()</code> 方法指定需要进行身份验证的请求。</li><li>使用 <code>anyRequest()</code> 方法配置除了 <code>/r/**</code> 以外的所有请求都不需要进行身份验证。</li><li>使用 <code>permitAll()</code> 方法表示任何用户都可以访问不需要进行身份验证的 <code>URL</code>。</li><li>使用 <code>formLogin()</code> 方法配置登录页表单认证，其中 <code>successForwardUrl()</code> 方法指定登录成功后的跳转页面。</li><li>使用 <code>logout()</code> 方法配置退出登录，其中 <code>logoutUrl()</code> 方法指定退出登录的 <code>URL</code>。</li></ol> 
<h4><a id="224__241"></a>2.2.4 授权测试</h4> 
<p>​ 用户认证通过去访问系统资源时spring security进行授权控制，判断用户是否有该资源的访问权限，如果有则继续访问，如果没有则拒绝访问。下边测试授权功能：</p> 
<ol><li>配置用户拥有哪些权限。</li></ol> 
<p>​ 在WebSecurityConfig类配置zhangsan拥有p1权限，lisi拥有p2权限。在<strong>WebSecurityConfig</strong>中我们已经配置过了。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 配置用户信息服务，暂时将用户信息存储在内存，后面会改成从数据库查</span>
    <span class="token class-name">InMemoryUserDetailsManager</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 创建用户信息, Kyle的权限是p1，Lucy的权限是p2</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"Kyle"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"p1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"Lucy"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"456"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"p2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> manager<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li> <p>指定资源与权限的关系</p> <p>什么是系统的资源?</p> <p>比如：查询一个用户的信息，用户信息就是系统的资源，要访问资源需要通过==<em>URL</em><mark>，所以我们在</mark><em>controller</em><mark>中定义的每个</mark><em>http</em>==的接口就是访问资源的接口。</p> <p>下边在controller中使用==<em>@PreAuthorize(“hasAuthority(’ ')”)</em><mark>配置</mark>/r/r1<mark>需要p1权限，</mark>/r/r2==需要p2权限。</p> <p>hasAuthority(‘p1’)表示拥有p1权限方可访问。</p> <p>代码如下:</p> </li></ol> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/r/r1"</span><span class="token punctuation">)</span>
<span class="token operator">+</span>   <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAnyAuthority('p1')"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">r1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"访问r1资源"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/r/r2"</span><span class="token punctuation">)</span>
<span class="token operator">+</span>   <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('p2')"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">r2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"访问r2资源"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li> <p>重启工程</p> <p>访问/r/r1，使用zhangsan登录可以正常访问，因为在/r/r1的方法上指定了权限p1，zhangsan用户拥有权限p1,所以可以正常访问。</p> <p>访问/r/r1，使用lisi登录则拒绝访问，由于lisi用户不具有权限p1需要拒绝访问</p> <p>注意：如果controller上不加==@PreAuthorize==，此方法没有授权控制。</p> </li></ol> 
<h4><a id="225__295"></a>2.2.5 授权测试总结</h4> 
<p>整理授权的过程见下图所示:</p> 
<p><img src="https://images2.imgbox.com/b4/b4/wBpyjH3v_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-bT4CPuba-1682427813446)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424211037288.png)]"></p> 
<p>注意:在controller中使用*@PreAuthorize(“hasAuthority(’ ')”)*配置权限</p> 
<h4><a id="226__304"></a>2.2.6 工作原理</h4> 
<p>​ 通过测试认证和授权两个功能，我们了解了Spring Security的基本使用方法，下边了解它的工作流程。</p> 
<p>Spring Security所解决的问题就是_<strong>安全访问控制</strong>_，而安全访问控制功能其实就是对所有进入系统的请求进行拦截，校验每个请求是否能够访问它所期望的资源。根据前边知识的学习，可以通过Filter或AOP等技术来实现，Spring Security对Web资源的保护是靠Filter实现的，所以从这个Filter来入手，逐步深入Spring Security原理。</p> 
<p>​ 当初始化Spring Security时，会创建一个名为SpringSecurityFilterChain的Servlet过滤器，类型为 org.springframework.security.web.FilterChainProxy，它实现了javax.servlet.Filter，因此外部的请求会经过此类，下图是Spring Security过虑器链结构图：</p> 
<p><img src="https://images2.imgbox.com/41/7e/BrbAHHVF_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-AXUjARBO-1682427813448)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424222848968.png)]"></p> 
<p>​ <mark>FilterChainProxy</mark>是一个代理，真正起作用的是FilterChainProxy中SecurityFilterChain所包含的各个Filter，同时这些Filter作为Bean被Spring管理，它们是Spring Security核心，各有各的职责，但他们并不直接处理用户的<strong>认证</strong>，也不直接处理用户的<strong>授权</strong>，而是把它们交给了<mark>认证管理器</mark>（AuthenticationManager）和<mark>决策管理器</mark>（AccessDecisionManager）进行处理。</p> 
<p>Spring Security功能的实现主要是由一系列过滤器链相互配合完成。</p> 
<p><img src="https://images2.imgbox.com/26/c7/7oawHbZP_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-rvDeznmG-1682427813450)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424222859076.png)]"></p> 
<p>下面介绍过滤器链中主要的几个过滤器及其作用：</p> 
<p><strong>SecurityContextPersistenceFilter</strong> 这个Filter是整个拦截过程的入口和出口（也就是第一个和最后一个拦截器），会在请求开始时从配置好的 SecurityContextRepository 中获取 SecurityContext，然后把它设置给 SecurityContextHolder。在请求完成后将 SecurityContextHolder 持有的 SecurityContext 再保存到配置好的 SecurityContextRepository，同时清除 securityContextHolder 所持有的 SecurityContext；</p> 
<p><strong>UsernamePasswordAuthenticationFilter</strong> 用于处理来自表单提交的认证。该表单必须提供对应的用户名和密码，其内部还有登录成功或失败后进行处理的 AuthenticationSuccessHandler 和 AuthenticationFailureHandler，这些都可以根据需求做相关改变；</p> 
<p><strong>FilterSecurityInterceptor</strong> 是用于保护web资源的，使用AccessDecisionManager对当前用户进行授权访问，前面已经详细介绍过了；</p> 
<p><strong>ExceptionTranslationFilter</strong> 能够捕获来自 FilterChain 所有的异常，并进行处理。但是它只会处理两类异常：AuthenticationException 和 AccessDeniedException，其它的异常它会继续抛出。</p> 
<p>Spring Security的执行流程如下：</p> 
<p><img src="https://images2.imgbox.com/d8/1c/UIimGZP5_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-5LnfQENB-1682427813451)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424222937966.png)]"></p> 
<p>\1. 用户提交用户名、密码被SecurityFilterChain中的UsernamePasswordAuthenticationFilter过滤器获取到，封装为请求Authentication，通常情况下是UsernamePasswordAuthenticationToken这个实现类。</p> 
<p>\2. 然后过滤器将Authentication提交至认证管理器（AuthenticationManager）进行认证</p> 
<p>\3. 认证成功后，AuthenticationManager身份管理器返回一个被填充满了信息的（包括上面提到的权限信息，身份信息，细节信息，但密码通常会被移除）Authentication实例。</p> 
<p>\4. SecurityContextHolder安全上下文容器将第3步填充了信息的Authentication，通过SecurityContextHolder.getContext().setAuthentication(…)方法，设置到其中。</p> 
<p>\5. 可以看出AuthenticationManager接口（认证管理器）是认证相关的核心接口，也是发起认证的出发点，它的实现类为ProviderManager。而Spring Security支持多种认证方式，因此ProviderManager维护着一个List列表，存放多种认证方式，最终实际的认证工作是由AuthenticationProvider完成的。咱们知道web表单的对应的AuthenticationProvider实现类为DaoAuthenticationProvider，它的内部又维护着一个UserDetailsService负责UserDetails的获取。最终AuthenticationProvider将UserDetails填充至Authentication。</p> 
<h3><a id="23_OAuth2_350"></a>2.3 <strong>什么是OAuth2</strong></h3> 
<h4><a id="231_OAuth2_352"></a>2.3.1 OAuth2认证流程</h4> 
<p>前面我们提到的微信扫码认证，是一种第三方认证方式，这种认证方式是基于OAuth2协议实现的</p> 
<p>OAUTH协议为用户资源的授权提供了一个安全的、开放而又简易的标准。</p> 
<p>同时，任何第三方都可以使用OAUTH认证服务，任何服务提供商都可以实现自身的OAUTH认证服务，因而OAUTH是开放的。</p> 
<p>业界提供了OAUTH的多种实现，如PHP、JavaScript、Java、Ruby等各种语言开发包，大大节约了程序员的时间，因而OAUTH是简易的。</p> 
<p>互联网很多服务如Open API，很多大公司如Google、Yahoo、Microsoft等都提供了OAUTH认证服务，这些都足以说明OAUTH标准逐渐成为开放资源授权的标准</p> 
<p>OAUTH协议目前发展到2.0版本，1.0版本过于复杂，2.0版本已得到广泛应用</p> 
<p>参考：https://baike.baidu.com/item/oAuth/7153134?fr=aladdin</p> 
<p>Oauth协议：https://tools.ietf.org/html/rfc6749</p> 
<p><strong>下面分析一个OAUTH2认证的例子，微信认证扫码登录的过程</strong>：</p> 
<p><img src="https://images2.imgbox.com/0f/e0/7qdgnHOW_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-FS0KeI9N-1682427813452)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424221332461.png)]"></p> 
<ol><li> <p>具体流程如下</p> 
  <ol><li> <p>用户点击微信扫码登录，微信扫码的目的是通过微信认证登录目标网站，目标网站需要从微信获取当前用户的身份信息才会让当前用户在目标网站登录成功</p> 
    <ul><li>首先搞清楚几个概念 
      <ul><li><code>资源</code>：用户信息，在微信中存储</li><li><code>资源拥有者</code>：用户是用户信息资源的拥有者</li><li><code>认证服务</code>：微信负责认证当前用户的身份，负责为客户端颁发令牌</li><li><code>客户端</code>：客户端会携带令牌请求微信获取用户信息</li></ul> </li></ul> </li><li> <p>用户授权网站访问用户信息</p> 
    <ul><li> <p>资源拥有者扫描二维码，表示资源拥有者请求微信进行认证，微信认证通过向用户手机返回授权页面（让你确认登录）</p> </li><li> <p>询问用户是否授权目标网站访问自己在微信的用户信息，用户点击（确认登录）表示同意授权，微信认证服务器会颁发一个授权码给目标网站</p> </li><li> <p>只有资源拥有者同意，微信才允许目标网站访问资源</p> </li></ul> </li><li> <p>目标网站获取到授权码</p> </li><li> <p>携带授权码请求微信认证服务器，申请令牌（此交互过程用户看不到）</p> </li><li> <p>微信认证服务器想目标网站响应令牌（此交互过程用户看不到）</p> </li><li> <p>目标网站携带令牌请求微信服务器获取用户的基本信息</p> </li><li> <p>资源服务器返回受保护资源，即用户信息</p> </li><li> <p>目标网站接收到用户信息，此时用户在目标网站登录成功</p> </li></ol> </li><li> <p><code>OAUTH 2.0</code>认证流程如下</p> <p><img src="https://images2.imgbox.com/da/1d/OpfUyfO8_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-XQnqVrVD-1682427813453)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424221953982.png)]"></p> </li></ol> 
<ul><li> <pre><code>OAUTH 2.0
</code></pre> <p>包括以下角色</p> 
  <ol><li><code>客户端</code>：本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，例如：手机客户端、浏览器等</li><li><code>资源拥有者</code>：通常为用户，也可以是应用程序，即该资源的拥有者</li><li><code>授权服务器（认证服务器）</code>：认证服务器对资源拥有者进行认证，还会对客户端进行认证并颁发令牌</li><li><code>资源服务器</code>：存储资源的服务器</li></ol> </li><li> <p>上图中</p> 
  <ul><li><code>A</code>表示：客户端请求资源拥有者授权</li><li><code>B</code>表示：资源拥有者授权客户端，即用户授权目标网站访问自己的用户信息</li><li><code>C</code>表示：目标网站携带授权码请求认证</li><li><code>D</code>表示：认证通过，颁发令牌</li><li><code>E</code>表示：目标网站携带令牌请求资源服务器，获取资源</li><li><code>F</code>表示：资源服务器校验令牌通过后，提供受保护的资源</li></ul> </li></ul> 
<h4><a id="232_OAuth2_429"></a>2.3.2 OAuth2在本项目的应用</h4> 
<ul><li>OAuth2是一个标准的开放的授权协议，应用程序可以根据自己的需求去使用</li><li>本项目使用OAuth2实现如下目标 
  <ol><li>学成在线访问第三方系统的资源 
    <ul><li>本项目要接入微信扫码登录，所以本项目要是用OAuth2协议访问微信中的用户信息</li></ul> </li><li>外部系统访问学成在线的资源 
    <ul><li>同样当第三方系统想要访问学成在线网站的资源，也可以基于OAuth2协议来访问用户信息</li></ul> </li><li>学成在线前端（客户端）访问学成在线微服务的资源 
    <ul><li>本项目是前后端分离架构，前端访问微服务资源也可以基于OAuth2协议</li></ul> </li></ol> </li></ul> 
<h4><a id="233_OAuth2_440"></a>2.3.3 OAuth2的授权模式</h4> 
<ul><li>Spring Security支持OAuth2认证，OAuth2提供授权码模式、密码模式、简化模式、客户端模式等四种授权模式。前面举的微信扫码登录的例子就是基于授权码模式。</li><li>这四种模式中，授权码模式和密码模式应用较多，这里使用Spring Security演示授权码模式、密码模式。</li></ul> 
<h5><a id="2331__445"></a>2.3.3.1 授权码模式</h5> 
<ul><li>OAuth2的几个授权模式是根据不同的应用场景以不同的方式去获取令牌，最终目的是要获取认证服务颁发的令牌，然后通过令牌去获取资源</li><li>授权码模式简单理解就是使用授权码去获取令牌，要想获取令牌，首先要获取授权码，授权码的获取需要资源拥有者亲自授权同意才可以获取</li><li>下图是授权码模式的交互图</li></ul> 
<p><img src="https://images2.imgbox.com/50/01/Ngy64wzS_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-mqA4v0so-1682427813453)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424223124720.png)]"></p> 
<ol><li>用户打开浏览器</li><li>通过浏览器访问客户端</li><li>通过浏览器想认证服务请求授权（用户扫描二维码） 
  <ul><li>请求授权时会携带客户端的URL，此URL为下发授权码的重定向地址</li></ul> </li><li>认证服务向资源拥有者返回授权页面</li><li>资源拥有者亲自授权同意（用户点击<code>同意登录</code>）</li><li>通过浏览器向认证服务发送授权同意</li><li>认证服务向客户端地址重定向，并携带授权码</li><li>客户端收到授权码</li><li>客户端携带授权码向认证服务申请令牌</li><li>认证服务向客户端颁发令牌</li></ol> 
<h5><a id="2332__466"></a>2.3.3.2 授权码模式测试</h5> 
<p>​ 要想测试授权码模式，首先要<strong>配置授权服务</strong>，即上图中的认证服务器，需要配置<mark>授权服务</mark>及<mark>认证服务</mark>(<strong>令牌策略</strong>)</p> 
<p>​ 在config中创建AuthorizationService.java (授权服务器)和 TokenConfig.java(令牌策略配置)</p> 
<ol><li> <p><code>AuthorizationService</code>使用<code>@EnableAuthorizationServer</code>注解标识并继承<code>AuthorizationServerConfigurerAdapter</code>来配置<code>OAuth2.0</code>授权服务器</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAuthorizationServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServer</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
    ···
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><code>AuthorizationServerConfigurerAdapter</code>要求配置以下几个类</p> 
  <ul><li><strong>AuthorizationServerSecurityConfigurer</strong>：用来配置令牌断点的安全约束</li><li><strong>ClientDetailsServiceConfigurer</strong>：用来配置客户端详情服务 
    <ul><li>随便一个客户端都可以随便接入到它的认证服务吗？答案是否定的，服务提供商会给批准接入的客户端一个身份，用于接入时的凭据，有客户端标识和客户端秘钥，在这里配置批准接入的客户端的详情信息</li></ul> </li><li><strong>AuthorizationServerEndpointsConfigurer</strong>：用来配置令牌（token）的访问端点和令牌服务（token services）</li></ul> <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">AuthorizationServerConfigurer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerSecurityConfigurer</span> security<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>TokenConfig为令牌策略配置类</p> <p>暂时使用InMemoryTokenStore在内存存储令牌，令牌的有效期等信息配置如下</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//使用内存存储令牌（普通令牌）</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryTokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"authorizationServerTokenServicesCustom"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationServerTokenServices</span> <span class="token function">tokenService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">DefaultTokenServices</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">setSupportRefreshToken</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支持刷新令牌</span>
        service<span class="token punctuation">.</span><span class="token function">setTokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//令牌存储策略</span>
        service<span class="token punctuation">.</span><span class="token function">setAccessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">7200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 令牌默认有效期2小时</span>
        service<span class="token punctuation">.</span><span class="token function">setRefreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">259200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 刷新令牌默认有效期3天</span>
        <span class="token keyword">return</span> service<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>配置认证管理Bean (在WebSecurityConfig中配置)</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ···

<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<p>到这里WebSecurityConfig里面已经配置了密码方式,OAuth2,安全拦截机制,其中完整代码如下:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// OAuth2</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">authenticationManagerBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 密码设置为明文模式</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//配置安全拦截机制</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/r/**"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">successForwardUrl</span><span class="token punctuation">(</span><span class="token string">"/login-success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    http<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">"/logout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p>重启认证服务</p> 
<ol><li> <p>get请求获取授权码</p> <p>地址: http://localhost:63070/auth/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn</p> <p>参数列表如下：</p> <p>• client_id：客户端准入标识。</p> <p>• response_type：授权码模式固定为code。</p> <p>• scope：客户端权限。</p> <p>• redirect_uri：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上code参数（授权码）。</p> <p>输入账号zhangsan、密码123登录成功，输入/oauth/authorize?client_id=XcWebApp&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn</p> <p>显示授权页面</p> </li></ol> 
<p><img src="https://images2.imgbox.com/72/da/ne8QjZ36_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-5VlutaYZ-1682427813454)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424225917963.png)]"></p> 
<ol start="2"><li> <p>请求成功，重定向至http://www.51xuecheng.cn/?code=授权码，比如：http://www.51xuecheng.cn/?code=Wqjb5H</p> </li><li> <p>使用httpclient工具post申请令牌</p> <p>/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=authorization_code&amp;code=授权码&amp;redirect_uri=http://www.51xuecheng.cn/</p> <p>参数列表如下</p> <p>• client_id：客户端准入标识。</p> <p>• client_secret：客户端秘钥。</p> <p>• grant_type：授权类型，填写authorization_code，表示授权码模式</p> <p>• code：授权码，就是刚刚获取的授权码，注意：授权码只使用一次就无效了，需要重新申请。</p> <p>• redirect_uri：申请授权码时的跳转url，一定和申请授权码时用的redirect_uri一致。</p> <p>httpclient脚本如下：</p> <pre><code class="prism language-httpclient">### 授权码模式
### 第一步申请授权码(浏览器请求)/oauth/authorize?client_id=c1&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.51xuecheng.cn
### 第二步申请令牌
POST {<!-- -->{auth_host}}/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=authorization_code&amp;code=CTvCrB&amp;redirect_uri=http://www.51xuecheng.cn

</code></pre> <p>申请令牌成功如下所示：</p> <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"access_token"</span><span class="token operator">:</span> <span class="token string">"368b1ee7-a9ee-4e9a-aae6-0fcab243aad2"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"token_type"</span><span class="token operator">:</span> <span class="token string">"bearer"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"refresh_token"</span><span class="token operator">:</span> <span class="token string">"3d56e139-0ee6-4ace-8cbe-1311dfaa991f"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"expires_in"</span><span class="token operator">:</span> <span class="token number">7199</span><span class="token punctuation">,</span>
  <span class="token string-property property">"scope"</span><span class="token operator">:</span> <span class="token string">"all"</span>
<span class="token punctuation">}</span>

</code></pre> <p>说明：</p> <p>1、access_token，访问令牌，用于访问资源使用。</p> <p>2、token_type，bearer是在RFC6750中定义的一种token类型，在携带令牌访问资源时需要在head中加入bearer 空格 令牌内容</p> <p>3、refresh_token，当令牌快过期时使用刷新令牌可以再次生成令牌。</p> <p>4、expires_in：过期时间（秒）</p> <p>5、scope，令牌的权限范围，服务端可以根据令牌的权限范围去对令牌授权。</p> </li></ol> 
<h5><a id="2334__660"></a>2.3.3.4 <strong>密码模式</strong></h5> 
<p>密码模式相对授权码模式简单，授权码模式需要借助浏览器供用户亲自授权，密码模式不用借助浏览器，如下图：</p> 
<p><img src="https://images2.imgbox.com/1c/09/PJvZdDOv_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-b7vFsYNH-1682427813455)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230424230510718.png)]"></p> 
<ol><li> <p>资源拥有者提供账号和密码</p> </li><li> <p>客户端向认证服务申请令牌，请求中携带账号和密码</p> </li><li> <p>认证服务校验账号和密码正确颁发令牌。</p> </li></ol> 
<p>开始测试：</p> 
<ol><li> <p>POST请求获取令牌</p> <p>/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=shangsan&amp;password=123</p> <p>参数列表如下：</p> <p>• client_id：客户端准入标识。</p> <p>• client_secret：客户端秘钥。</p> <p>• grant_type：授权类型，填写password表示密码模式</p> <p>• username：资源拥有者用户名。</p> <p>• password：资源拥有者密码。</p> </li><li> <p>授权服务器将令牌（access_token）发送给client</p> <p>使用httpclient进行测试</p> <pre><code>### 密码模式
POST {<!-- -->{auth_host}}/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=zhangsan&amp;password=123

</code></pre> <p>返回实例:</p> <pre><code class="prism language-JSON">{
  "access_token": "368b1ee7-a9ee-4e9a-aae6-0fcab243aad2",
  "token_type": "bearer",
  "refresh_token": "3d56e139-0ee6-4ace-8cbe-1311dfaa991f",
  "expires_in": 6806,
  "scope": "all"
}

</code></pre> </li></ol> 
<p><strong>注意:这种模式十分简单，但是却意味着直接将用户敏感信息泄漏给了client，因此这就说明<mark>这种模式只能用于client是我们自己开发的情况下</mark>。</strong></p> 
<h3><a id="24_JWT_718"></a>2.4 JWT令牌</h3> 
<h4><a id="241_JWT_720"></a>2.4.1 什么是JWT</h4> 
<p>JSON Web Token（JWT）是一种使用JSON格式传递数据的网络令牌技术，它是一个开放的行业标准（RFC 7519），它定义了一种简洁的、自包含的协议格式，用于在通信双方传递json对象，传递的信息经过数字签名可以被验证和信任，它可以使用HMAC算法或使用RSA的公钥/私钥对来签名，防止内容篡改。官网：https://jwt.io/</p> 
<p>使用JWT可以实现无状态认证，什么是无状态认证？</p> 
<p>传统的基于session的方式是有状态认证，用户登录成功将用户的身份信息存储在服务端，这样加大了服务端的存储压力，并且这种方式不适合在分布式系统中应用。</p> 
<p>如下图，当用户访问应用服务，每个应用服务都会去服务器查看session信息，如果session中没有该用户则说明用户没有登录，此时就会重新认证，而解决这个问题的方法是Session复制、Session黏贴。</p> 
<p><img src="https://images2.imgbox.com/f1/68/0hyXaAlz_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-TDVTkPgi-1682427813456)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425100230833.png)]"></p> 
<p>如果是基于令牌技术在分布式系统中实现认证则服务端不用存储session，可以将用户身份信息存储在令牌中，用户认证通过后认证服务颁发令牌给用户，用户将令牌存储在客户端，去访问应用服务时携带令牌去访问，服务端从jwt解析出用户信息。这个过程就是无状态认证。</p> 
<p><img src="https://images2.imgbox.com/ae/91/sbEl9LHr_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Be8JIVbE-1682427813456)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425100248528.png)]"></p> 
<ul><li>JWT令牌的优点 
  <ol><li>JWT基于Json，非常方便解析</li><li>可以在令牌中自定义丰富的内容，易扩展</li><li>通过非对称加密算法及数字签名技术，JWT防篡改，安全性高</li><li>资源服务使用JWT可不依赖认证服务即可完成授权</li></ol> </li></ul> 
<p>缺点</p> 
<ol><li> <p>JWT令牌较长，占存储空间比较大，下面是一个JWT令牌的示例</p> <pre><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsicmVzMSJdLCJ1c2VyX25hbWUiOiJ6aGFuZ3NhbiIsInNjb3BlIjpbImFsbCJdLCJleHAiOjE2NjQyNTQ2NzIsImF1dGhvcml0aWVzIjpbInAxIl0sImp0aSI6Ijg4OTEyYjJkLTVkMDUtNGMxNC1iYmMzLWZkZTk5NzdmZWJjNiIsImNsaWVudF9pZCI6ImMxIn0.wkDBL7roLrvdBG2oGnXeoXq-zZRgE9IVV2nxd-ez_oA
</code></pre> </li></ol> 
<p>JWT令牌由三部分组成，每部分中间使用点（.）分隔，例如xxxx.yyyyyy.zzzzzzz</p> 
<ol><li> <p>Header：第一部分是头部</p> 
  <ul><li>头部包括令牌的类型（即JWT）及使用的哈希算法（如HMAC、SHA256或RSA），一个例子如下</li></ul> <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"alg"</span><span class="token operator">:</span> <span class="token string">"HS256"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"typ"</span><span class="token operator">:</span> <span class="token string">"JWT"</span>
<span class="token punctuation">}</span>
</code></pre> 
  <ul><li>将上面的内容使用Base64Url编码，得到一个字符串就是JWT令牌的第一部分</li></ul> </li><li> <p>Payload：第二部分是负载，内容也是一个Json对象</p> 
  <ul><li>它是存放有效信息的地方，它可以存放JWT提供的现成字段，如iss（签发者）、exp（过期时间戳）、sub（面向的用户）等，也可以自定义字段</li><li>此部分不建议存放敏感信息，因为此部分可以解码还原原始内容</li><li>最后将第二部分负载使用Base64Url编码，得到一个字符串就是JWT令牌的第二部分</li></ul> <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"sub"</span><span class="token operator">:</span> <span class="token string">"1234567890"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"456"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"admin"</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>Sugbature：第三部分是签名，此部分用于防止JWT内容被篡改。</p> 
  <ul><li>这个部分使用Base64Url将前两部分进行编码，编码后使用点（.）连接组成字符串，最后使用Header中声明的签名算法进行签名</li></ul> <pre><code class="prism language-java"><span class="token function">HMACSHA256</span><span class="token punctuation">(</span>
    <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span>
    <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
    secret<span class="token punctuation">)</span>
</code></pre> 
  <ul><li>base64UrlEncode(header)：JWT令牌的第一部分</li><li>base64UrlEncode(payload)：JWT令牌的第二部分</li></ul> </li></ol> 
<ul><li>为什么JWT可以防止篡改？ 
  <ul><li> <p>第三部分使用签名算法对第一部分和第二部分的内容进行签名，常见的签名算法是HS526，常见的还有MD5、SHA等，签名算法需要使用密钥进行签名，密钥不对外公开，并且签名是不可逆的，如果第三方更改了内容，那么服务器验证前面就会失败，要想保证签名正确，必须保证内容、密钥与签名前一致</p> </li><li> <p><img src="https://images2.imgbox.com/5d/72/TQwMX5mE_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-SnYFtMD9-1682427813457)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425100725742.png)]"></p> </li><li> <p>从上图中可以看出，认证服务和资源服务使用相同的密钥，这叫对称加密，对称加密效率高，如果一旦密钥泄露可以伪造JWT令牌</p> </li><li> <p>JWT还可以使用非对称加密，认证服务自己保留私钥，将公钥下发给受信任的客户端、资源服务，公钥和私钥是配对的，成对的公钥和私钥才可以正常加密、解密，非对称加密效率低，但相比较于对称加密更加安全</p> </li></ul> </li></ul> 
<h4><a id="242_JWT_804"></a>2.4.2 测试生成JWT令牌</h4> 
<p>在认证服务(TokenConfig)中配置JWT令牌服务，即可实现生成JWT格式的令牌</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> SIGNING_KEY <span class="token operator">=</span> <span class="token string">"mq123"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtAccessTokenConverter</span> accessTokenConverter<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token comment">//  // 内存存储令牌</span>
<span class="token comment">//    @Bean</span>
<span class="token comment">//    public TokenStore tokenStore() {<!-- --></span>
<span class="token comment">//        //使用内存存储令牌（普通令牌）</span>
<span class="token comment">//        return new InMemoryTokenStore();</span>
<span class="token comment">//    }</span>

    <span class="token comment">// JWT令牌</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converter<span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>SIGNING_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//令牌管理服务</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"authorizationServerTokenServicesCustom"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationServerTokenServices</span> <span class="token function">tokenService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">DefaultTokenServices</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">setSupportRefreshToken</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//支持刷新令牌</span>
        service<span class="token punctuation">.</span><span class="token function">setTokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//令牌存储策略</span>

        <span class="token class-name">TokenEnhancerChain</span> tokenEnhancerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenEnhancerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenEnhancerChain<span class="token punctuation">.</span><span class="token function">setTokenEnhancers</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>accessTokenConverter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">setTokenEnhancer</span><span class="token punctuation">(</span>tokenEnhancerChain<span class="token punctuation">)</span><span class="token punctuation">;</span>

        service<span class="token punctuation">.</span><span class="token function">setAccessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">7200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 令牌默认有效期2小时</span>
        service<span class="token punctuation">.</span><span class="token function">setRefreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">259200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 刷新令牌默认有效期3天</span>
        <span class="token keyword">return</span> service<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>重启认证服务，通过HttpClient通过密码模式申请令牌</p> 
<pre><code class="prism language-httpclient">### 密码模式
POST {<!-- -->{auth_host}}/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=zhangsan&amp;password=123
</code></pre> 
<p>生成的JWT示例如下</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
<span class="token string-property property">"access_token"</span><span class="token operator">:</span> <span class="token string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJLeWxlIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY3ODQyNzQ5NiwiYXV0aG9yaXRpZXMiOlsicDEiXSwianRpIjoiY2IyOTI0ZjYtOGZiOS00N2ViLThjNGEtMWFmMjkzZWU4NTg4IiwiY2xpZW50X2lkIjoiWGNXZWJBcHAifQ.aVZOsHBEuowof41HgV2auyDrRh9ZiNfwn4qoQWjla7o"</span><span class="token punctuation">,</span>
<span class="token string-property property">"token_type"</span><span class="token operator">:</span> <span class="token string">"bearer"</span><span class="token punctuation">,</span>
<span class="token string-property property">"refresh_token"</span><span class="token operator">:</span> <span class="token string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJLeWxlIiwic2NvcGUiOlsiYWxsIl0sImF0aSI6ImNiMjkyNGY2LThmYjktNDdlYi04YzRhLTFhZjI5M2VlODU4OCIsImV4cCI6MTY3ODY3OTQ5NiwiYXV0aG9yaXRpZXMiOlsicDEiXSwianRpIjoiNjFhNWRmOGItZTc3ZS00YmVkLWE3OTQtZTlmMjJkM2FmMTYyIiwiY2xpZW50X2lkIjoiWGNXZWJBcHAifQ.JqEL9V4Yn8tWYtvH46wtbAgJQ1dEoseuWyQhDdZNveo"</span><span class="token punctuation">,</span>
<span class="token string-property property">"expires_in"</span><span class="token operator">:</span> <span class="token number">7199</span><span class="token punctuation">,</span>
<span class="token string-property property">"scope"</span><span class="token operator">:</span> <span class="token string">"all"</span><span class="token punctuation">,</span>
<span class="token string-property property">"jti"</span><span class="token operator">:</span> <span class="token string">"cb2924f6-8fb9-47eb-8c4a-1af293ee8588"</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol><li><code>access_token</code>：生成的JWT令牌，用于访问资源使用</li><li><code>token_type</code>：bearer是在RFC6750中定义的一种token类型，在携带JWT访问资源时，需要在head中加入bearer jwt令牌内容</li><li><code>refresh_token</code>：当JWT令牌快过期时使用刷新令牌可以再次生成JWT令牌</li><li><code>expires_in</code>：过期时间（秒）</li><li><code>scope</code>：令牌的权限范围，服务端可以根据令牌的权限范围去对令牌授权</li><li><code>jti</code>：令牌的唯一表示</li></ol> 
<p>我们可以通过check_token接口校验jwt令牌</p> 
<pre><code>### 校验JWT令牌
POST {<!-- -->{auth_host}}/auth/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJLeWxlIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY3ODQyOTg5MywiYXV0aG9yaXRpZXMiOlsicDEiXSwianRpIjoiMzNhMzg4YWMtNzNmYS00ODBmLWEzMWUtOTdmOTJmMjBkNWZkIiwiY2xpZW50X2lkIjoiWGNXZWJBcHAifQ.cTcfIzL2avSp2XEsPvGU2IoJ060ooln1hARZCrvCxp4
</code></pre> 
<p>响应实例如下:</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"aud"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"res1"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"user_name"</span><span class="token operator">:</span> <span class="token string">"zhangsan"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"scope"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"all"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"active"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"exp"</span><span class="token operator">:</span> <span class="token number">1664371780</span><span class="token punctuation">,</span>
  <span class="token string-property property">"authorities"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"p1"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"jti"</span><span class="token operator">:</span> <span class="token string">"f0a3cdeb-399d-48f0-8804-eca638ad8857"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"client_id"</span><span class="token operator">:</span> <span class="token string">"c1"</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="243__915"></a>2.4.3 <strong>携带令牌访问资源服务</strong></h4> 
<p>拿到了jwt令牌下一步就要携带令牌去访问资源服务中的资源，本项目各个微服务就是资源服务，比如：内容管理服务，客户端申请到jwt令牌，携带jwt去内容管理服务查询课程信息，此时内容管理服务要对jwt进行校验，只有jwt合法才可以继续访问。如下图：</p> 
<p><img src="https://images2.imgbox.com/bb/a6/mEa040h8_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-S93H3Tmj-1682427813458)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425102158503.png)]"></p> 
<ol><li>在资源服务的内容管理服务的content-api工程中添加依赖</li></ol> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--认证相关--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<ol start="2"><li>在资源服务content-api中添加<mark>TokenConfig.java</mark></li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> SIGNING_KEY <span class="token operator">=</span> <span class="token string">"mq123"</span><span class="token punctuation">;</span>

    <span class="token comment">// JWT令牌</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converter<span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>SIGNING_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 令牌选择</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>在资源服务content-api中添加<mark>ResourceServerConfig.java</mark></li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableResourceServer</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceServerConfig</span> <span class="token keyword">extends</span> <span class="token class-name">ResourceServerConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span>  <span class="token keyword">final</span>  <span class="token class-name">String</span> RESOURCE_ID <span class="token operator">=</span> <span class="token string">"xuecheng-plus"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

    <span class="token comment">// 配置资源服务访问令牌方式</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ResourceServerSecurityConfigurer</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        resources<span class="token punctuation">.</span><span class="token function">resourceId</span><span class="token punctuation">(</span>RESOURCE_ID<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stateless</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 安全http配置</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token comment">// 禁用 CSRF 保护</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//配置对请求的授权策略</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/r/**"</span><span class="token punctuation">,</span> <span class="token string">"/course/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 指定 "/r/" 和 "/course/" 这两个路径需要进行身份认证才能访问。</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 允许所有其他请求（除了上面指定的路径之外）都可以被访问，不需要进行身份认证。</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>说明: 这里的 <em>/course/</em> 是资源服务中的请求前缀,当时在nacos中已经配置好</li></ul> 
<ol start="4"><li> <p>重启内容管理服务，使用HttpClient进行测试</p> 
  <ol><li> <p>访问根据课程id查询课程接口</p> <pre><code class="prism language-httpclient">### 根据课程id查询课程基本信息
GET {<!-- -->{content_host}}/content/course/22
Content-Type: application/json
</code></pre> <p>返回结果:</p> <pre><code>{
"error": "unauthorized",
"error_description": "Full authentication is required to access this resource"
} 
</code></pre> </li></ol> 
  <ul><li>从返回信息可知，当前没有认证</li></ul> 
  <ol start="2"><li> <p>携带JWT令牌访问接口</p> 
    <ol><li>首先申请令牌</li></ol> <pre><code>### 密码模式
POST {<!-- -->{auth_host}}/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=Kyle&amp;password=123
</code></pre> 
    <ol start="2"><li>携带JWT令牌访问资源服务地址</li></ol> <pre><code>GET {<!-- -->{content_host}}/content/course/160
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJLeWxlIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY3ODQzOTMwOSwiYXV0aG9yaXRpZXMiOlsicDEiXSwianRpIjoiNTAxNDNiZTItOGM3ZC00MmUzLWEwNDMtMTQwMGQ5NWQ5MmZiIiwiY2xpZW50X2lkIjoiWGNXZWJBcHAifQ.o3nWLeRkJncEnnZ0egFmBpyC8Keq-L8IY6k0Uc0a96c
</code></pre> 
    <ol start="3"><li>携带JWT令牌，且JWT令牌正确，则正常访问资源服务的内容</li></ol> <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
<span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token number">160</span><span class="token punctuation">,</span>
<span class="token string-property property">"companyId"</span><span class="token operator">:</span> <span class="token number">1232141425</span><span class="token punctuation">,</span>
<span class="token string-property property">"companyName"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"猫片"</span><span class="token punctuation">,</span>
<span class="token string-property property">"users"</span><span class="token operator">:</span> <span class="token string">"不知道啊不知道啊不知道啊a a a "</span><span class="token punctuation">,</span>
<span class="token string-property property">"tags"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
<span class="token string-property property">"mt"</span><span class="token operator">:</span> <span class="token string">"1-5"</span><span class="token punctuation">,</span>
<span class="token string-property property">"st"</span><span class="token operator">:</span> <span class="token string">"1-5-4"</span><span class="token punctuation">,</span>
<span class="token string-property property">"grade"</span><span class="token operator">:</span> <span class="token string">"204003"</span><span class="token punctuation">,</span>
<span class="token string-property property">"teachmode"</span><span class="token operator">:</span> <span class="token string">"200002"</span><span class="token punctuation">,</span>
<span class="token string-property property">"description"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token string-property property">"pic"</span><span class="token operator">:</span> <span class="token string">"/mediafiles/2023/03/03/76ac562669dc346992af9dd039060e7b.jpg"</span><span class="token punctuation">,</span>
<span class="token string-property property">"createDate"</span><span class="token operator">:</span> <span class="token string">"2023-03-02 17:17:07"</span><span class="token punctuation">,</span>
<span class="token string-property property">"changeDate"</span><span class="token operator">:</span> <span class="token string">"2023-03-05 11:09:31"</span><span class="token punctuation">,</span>
<span class="token string-property property">"createPeople"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token string-property property">"changePeople"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token string-property property">"auditStatus"</span><span class="token operator">:</span> <span class="token string">"203002"</span><span class="token punctuation">,</span>
<span class="token string-property property">"status"</span><span class="token operator">:</span> <span class="token string">"203001"</span><span class="token punctuation">,</span>
<span class="token string-property property">"charge"</span><span class="token operator">:</span> <span class="token string">"201000"</span><span class="token punctuation">,</span>
<span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span>
<span class="token string-property property">"originalPrice"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token string-property property">"qq"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
<span class="token string-property property">"wechat"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
<span class="token string-property property">"phone"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
<span class="token string-property property">"validDays"</span><span class="token operator">:</span> <span class="token number">365</span><span class="token punctuation">,</span>
<span class="token string-property property">"mtName"</span><span class="token operator">:</span> <span class="token string">"人工智能"</span><span class="token punctuation">,</span>
<span class="token string-property property">"stName"</span><span class="token operator">:</span> <span class="token string">"计算机视觉"</span>
<span class="token punctuation">}</span>
</code></pre> 
    <ol start="4"><li>如果JWT令牌错误，咋会报令牌无效</li></ol> <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
<span class="token string-property property">"error"</span><span class="token operator">:</span> <span class="token string">"invalid_token"</span><span class="token punctuation">,</span>
<span class="token string-property property">"error_description"</span><span class="token operator">:</span> <span class="token string">"Cannot convert access token to JSON"</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> </li></ol> 
<h4><a id="244__1073"></a>2.4.4 <strong>测试获取用户身份</strong></h4> 
<p>jwt令牌中记录了用户身份信息，当客户端携带jwt访问资源服务，资源服务验签通过后将前两部分的内容还原即可取出用户的身份信息，并将用户身份信息放在了SecurityContextHolder上下文，SecurityContext与当前线程进行绑定，方便获取用户身份。</p> 
<p>还以查询课程接口为例，进入查询课程接口的代码中，添加获取用户身份的代码</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"根据课程id查询课程基础信息"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/course/{courseId}"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CourseBaseInfoDto</span> <span class="token function">getCourseBaseById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"courseId"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">//取出当前用户身份</span>
    <span class="token class-name">Object</span> principal <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>principal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> courseBaseInfoService<span class="token punctuation">.</span><span class="token function">getCourseBaseInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>测试时需要注意：</p> 
<ol><li> <p>首先在资源服务配置中指定安全拦截机制 /course/开头的请求需要认证，即请求<code>/course/{courseId}</code>接口需要携带jwt令牌且签证通过。</p> </li><li> <p>认证服务生成jwt令牌将用户身份信息写入令牌，目前还是将用户信息硬编码并暂放在内存中。(前文认证测试时在<code>WebSecurityConfig</code>已经配置好)</p> </li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//这里配置用户信息,这里暂时使用这种方式将用户存储在内存中</span>
    <span class="token class-name">InMemoryUserDetailsManager</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"p1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    manager<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token string">"lisi"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"456"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"p2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> manager<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<ol start="3"><li> <p>我们在使用密码模式生成jwt令牌时用的是zhangsan的信息，所以jwt令牌中存储了zhangsan的信息，那么在资源服务中应该取出zhangsan的信息才对。</p> <p>清楚了以上内容，下边重启内容管理服务，跟踪取到的用户身份是否正确。</p> <pre><code>当前用户身份为：zhangsan
</code></pre> </li></ol> 
<h3><a id="25__1117"></a>2.5 网关鉴权</h3> 
<h4><a id="251__1119"></a>2.5.1 什么是网关鉴权</h4> 
<p>到目前为止，测试通过了认证服务颁发的JWT令牌，客户端携带JWT访问资源服务，资源服务会对JWT的合法性进行验证，如下图</p> 
<p><img src="https://images2.imgbox.com/78/15/6yuU0ZU7_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-VUevnmpq-1682427813458)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425110227648.png)]"></p> 
<p>仔细观察此图，遗漏了本项目架构中非常重要的组件：网关，加上网关并完善后如下图所示：</p> 
<p><img src="https://images2.imgbox.com/37/59/I5D2JyLb_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-45eCJkkI-1682427813459)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425110248731.png)]"></p> 
<p><mark>所有访问微服务的请求都要经过网关，在网关进行用户身份的认证可以将很多非法的请求拦截到微服务以外，这叫做网关认证。</mark></p> 
<p>下边需要明确网关的职责：</p> 
<ol><li> <p>网站白名单维护 : 针对不用认证的URL全部放行。</p> </li><li> <p>校验jwt的合法性 : 除了白名单剩下的就是需要认证的请求，网关需要验证jwt的合法性，jwt合法则说明用户身份合法，否则说明身份不合法则拒绝继续访问。</p> </li><li> <p>网关负责授权吗？ <strong>网关不负责授权，对请求的授权操作在各个微服务进行，因为微服务最清楚用户有哪些权限访问哪些接口。</strong></p> </li></ol> 
<h4><a id="252__1140"></a>2.5.2 <strong>实现网关认证</strong></h4> 
<p>下边实现网关认证，实现以下职责：</p> 
<ol><li> <p>网站白名单维护</p> </li><li> <p>校验jwt的合法性。</p> </li></ol> 
<p>下面是详细步骤:</p> 
<ol><li>在网关工程添加依赖</li></ol> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<ol start="2"><li>添加网关鉴权配置类到gateway-api的config包下</li></ol> 
<p><code>GatewayAuthFilter</code></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayAuthFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//白名单</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> whitelist <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//加载白名单</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>
                <span class="token class-name">InputStream</span> resourceAsStream <span class="token operator">=</span> <span class="token class-name">GatewayAuthFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"/security-whitelist.properties"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            properties<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>resourceAsStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> strings <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">stringPropertyNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            whitelist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>strings<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"加载/security-whitelist.properties出错:{}"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> requestUrl <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AntPathMatcher</span> pathMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//白名单放行</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> url <span class="token operator">:</span> whitelist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pathMatcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> requestUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//检查token是否存在</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token function">getToken</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">buildReturnMono</span><span class="token punctuation">(</span><span class="token string">"没有认证"</span><span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//判断是否是有效的token</span>
        <span class="token class-name">OAuth2AccessToken</span> oAuth2AccessToken<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            oAuth2AccessToken <span class="token operator">=</span> tokenStore<span class="token punctuation">.</span><span class="token function">readAccessToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> expired <span class="token operator">=</span> oAuth2AccessToken<span class="token punctuation">.</span><span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>expired<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">buildReturnMono</span><span class="token punctuation">(</span><span class="token string">"认证令牌已过期"</span><span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidTokenException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"认证令牌无效: {}"</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">buildReturnMono</span><span class="token punctuation">(</span><span class="token string">"认证令牌无效"</span><span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
    * 获取token
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> tokenStr <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>tokenStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> tokenStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildReturnMono</span><span class="token punctuation">(</span><span class="token class-name">String</span> error<span class="token punctuation">,</span> <span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RestErrorResponse</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bits <span class="token operator">=</span> jsonString<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataBuffer</span> buffer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>RestErrorResponse</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestErrorResponse</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> errMessage<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RestErrorResponse</span><span class="token punctuation">(</span><span class="token class-name">String</span> errMessage<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errMessage<span class="token operator">=</span> errMessage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getErrMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> errMessage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setErrMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> errMessage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errMessage <span class="token operator">=</span> errMessage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>SecurityConfig</code></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableWebFluxSecurity</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//安全拦截配置</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityWebFilterChain</span> <span class="token function">webFluxSecurityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">ServerHttpSecurity</span> http<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">authorizeExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">pathMatchers</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">anyExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>TokenConfig</code></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">String</span> SIGNING_KEY <span class="token operator">=</span> <span class="token string">"mq123"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JwtTokenStore</span><span class="token punctuation">(</span><span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtAccessTokenConverter</span> <span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JwtAccessTokenConverter</span> converter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        converter<span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>SIGNING_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> converter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>在网关的resources中配置白名单文件<code>security-whitelist.properties</code></li></ol> 
<pre><code class="prism language-properties">/auth/**=认证地址
/content/open/**=内容管理公开放文件接口
/media/open/**=媒资管理公开访问接口
</code></pre> 
<ol start="4"><li> <p>重启网关工程，进行测试</p> 
  <ol><li>重启网关工程，进行测试</li></ol> <pre><code>### 密码模式
POST {<!-- -->{auth_host}}/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=Kyle&amp;password=123
</code></pre> 
  <ol start="2"><li>通过网关访问资源服务（将端口换为网关端口）</li></ol> <pre><code>GET {<!-- -->{gateway_host}}/content/course/40
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJLeWxlIiwic2NvcGUiOlsiYWxsIl0sImV4cCI6MTY3ODQ0MTU3MiwiYXV0aG9yaXRpZXMiOlsicDEiXSwianRpIjoiZWJkNDkzNjgtMjc4My00OTAxLWE5MTMtZGM5ZjUyYTg5ZWQ2IiwiY2xpZW50X2lkIjoiWGNXZWJBcHAifQ.6V9OaU5FutGp9Ol2QzaP57HVxe9w1d5S0Y5TdWLDxzw
</code></pre> 
  <ol start="3"><li>当token正确时可以正常访问资源服务，token验证失败时，会返回token失效</li></ol> <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
<span class="token string-property property">"errMessage"</span><span class="token operator">:</span> <span class="token string">"认证令牌无效"</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<ul><li> <p><mark>注意：网关鉴权功能调试通过后，由于目前还没有开发认证功能，前端请求网关的URL不在白名单时，会出现<code>没有认证</code>错误，所以暂时在白名单中添加全部放行配置，待认证功能开发完成后，再屏蔽全部放行配置</mark></p> </li><li> <pre><code class="prism language-properties">/**=暂时全部放开
/auth/**=认证地址
/content/open/**=内容管理公开访问接口
/media/open/**=媒资管理公开访问接口
</code></pre> </li><li> <p>由于是在网关处进行令牌校验，所以在微服务处不再校验令牌的合法性，修改内容管理服务<code>content-api</code>的<code>ResouceServerConfig</code>类，屏蔽<code>authenticated()</code>。</p> </li><li> <pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
  http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//          .antMatchers("/r/**","/course/**").authenticated()//所有/r/**的请求必须认证通过</span>
          <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

</code></pre> <p>到这里资源服务content-api中<mark>ResourceServerConfig.java</mark>完整代码如下:</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableResourceServer</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceServerConfig</span> <span class="token keyword">extends</span> <span class="token class-name">ResourceServerConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span>  <span class="token keyword">final</span>  <span class="token class-name">String</span> RESOURCE_ID <span class="token operator">=</span> <span class="token string">"xuecheng-plus"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">TokenStore</span> tokenStore<span class="token punctuation">;</span>

    <span class="token comment">// 配置资源服务访问令牌方式</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ResourceServerSecurityConfigurer</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        resources<span class="token punctuation">.</span><span class="token function">resourceId</span><span class="token punctuation">(</span>RESOURCE_ID<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span>tokenStore<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stateless</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 安全http配置</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token comment">// 禁用 CSRF 保护</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//配置对请求的授权策略</span>
                <span class="token comment">//.antMatchers("/r/**", "/course/**").authenticated() // 指定 "/r/" 和 "/course/" 这两个路径需要进行身份认证才能访问。</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 允许所有其他请求（除了上面指定的路径之外）都可以被访问，不需要进行身份认证。</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ul> 
<h2><a id="3__1414"></a>3. 用户认证</h2> 
<h3><a id="31__1416"></a>3.1 需求分析</h3> 
<p>​ 至此我们了解了使用Spring Security进行认证授权的过程，本节实现用户认证功能。</p> 
<p>​ 目前各大网站的认证方式非常丰富：账号密码认证、手机验证码认证、扫码登录等。</p> 
<p>​ 本项目也要支持多种认证试。</p> 
<h3><a id="32__1424"></a>3.2 <strong>连接用户中心数据库</strong></h3> 
<h4><a id="321__1426"></a>3.2.1 <strong>连接数据库认证</strong></h4> 
<p>​ 基于的认证流程在研究Spring Security过程中已经测试通过，到目前为止用户认证流程如下：</p> 
<p><img src="https://images2.imgbox.com/ae/51/AqFfT207_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-NVbIPDwc-1682427813459)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425112819129.png)]"></p> 
<p>​ 认证所需要的用户信息存储在xc_user库中，之前我们是将用户信息硬编码，放在内存中的，现在我们要从数据库来查询用户信息来登录(<mark><strong>下文会把xc_user分享出来,有想要研究的小伙伴可以研究一下</strong></mark>)</p> 
<p>​ 如何使用Spring Security连接数据库认证？</p> 
<p><img src="https://images2.imgbox.com/c1/e5/l3obBINg_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-O4BtbAce-1682427813460)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425113513774.png)]"></p> 
<p>​ 用户提交账号和密码由<code>DaoAuthenticationProvider</code>调用<code>UserDetailsService</code>的<code>loadUserByUsername()</code>方法获取<code>UserDetails</code>用户信息。</p> 
<p>​ <code>UserDetailsService</code>是一个接口，如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ <code>UserDetails</code>是用户信息接口:</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetails</span> <span class="token keyword">extends</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>​ 我们只要实现<code>UserDetailsService </code>接口查询数据库得到用户信息返回<code>UserDetails</code> 类型的用户信息即可,框架调用<code>loadUserByUsername()</code>方法拿到用户信息之后是如何执行的，见下图：</p> 
<p><img src="https://images2.imgbox.com/7b/f5/0pYqidDa_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-XTyvvzDv-1682427813460)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425113941869.png)]"></p> 
<ol><li>首先屏蔽原来定义的<code>UserDetailsService</code>。(在<code>WebSecurityConfig</code>中之前定义的)</li></ol> 
<pre><code class="prism language-java"><span class="token comment">//   @Bean</span>
<span class="token comment">//   public UserDetailsService userDetailsService() {<!-- --></span>
<span class="token comment">//       // 1. 配置用户信息服务，暂时将用户信息存储在内存，后面会改成从数据库查</span>
<span class="token comment">//       InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();</span>
<span class="token comment">//       // 2. 创建用户信息, Kyle的权限是p1，Lucy的权限是p2</span>
<span class="token comment">//       manager.createUser(User.withUsername("Kyle").password("123").authorities("p1").build());</span>
<span class="token comment">//       manager.createUser(User.withUsername("Lucy").password("456").authorities("p2").build());</span>
<span class="token comment">//       return manager;</span>
<span class="token comment">//   }</span>
</code></pre> 
<ol start="2"><li>下面自己在auth工程的service中定义<code>UserDetailsService</code>,这里的mapper都用Mybatis-Plus生成</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetailsImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
    *
    * @param s     用户输入的登录账号
    * @return      UserDetails
    * @throws UsernameNotFoundException
    */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 没别的意思，只是变量名看着舒服</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> s<span class="token punctuation">;</span>
        <span class="token comment">// 根据username去XcUser表中查询对应的用户信息</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回NULL表示用户不存在，SpringSecurity会帮我们处理，框架抛出异常用户不存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 取出数据库存储的密码</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果查到了用户拿到正确的密码，最终封装成一个UserDetails对象给spring security框架返回，由框架进行密码比对</span>
        <span class="token keyword">return</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li> <p>数据库中的密码加过密的，用户输入的密码是明文，我们需要将<code>WebSecurityConfig</code>修改密码格式器<code>PasswordEncoder</code>，原来使用的是<code>NoOpPasswordEncoder</code>，它是通过明文方式比较密码，现在我们修改为<code>BCryptPasswordEncoder</code>，它是将用户输入的密码编码为<code>BCrypt</code>格式与数据库中的密码进行比对。</p> <p>如下：</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//        //密码为明文方式</span>
<span class="token comment">//        return NoOpPasswordEncoder.getInstance();</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> <p>我们通过测试代码测试<code>BCryptPasswordEncoder</code>，如下</p> <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token string">"123456"</span><span class="token punctuation">;</span>
    <span class="token class-name">BCryptPasswordEncoder</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 每个计算出的Hash值都不一样</span>
        <span class="token class-name">String</span> encodePsw <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 虽然Hash值不一样，但是校验是可以通过的</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"转换后密码："</span> <span class="token operator">+</span> encodePsw <span class="token operator">+</span> <span class="token string">"比对情况："</span> <span class="token operator">+</span> encoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> encodePsw<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 转换后密码：$2a$10$6hbvtCtgcISvbBHJ.UnhPO1io7StF.ySPkmAvzO/efvNmHVVJZOeK比对情况：true</span>
<span class="token comment">// 转换后密码：$2a$10$ufYW9qXSAk0N201B/wCR7uGrzygawnwXtyL2vKpDLAOCOkF33sGnK比对情况：true</span>
<span class="token comment">// 转换后密码：$2a$10$DEaVxYHakIE/kDvAU4eC7OZ7c9kqKBJedClVxDPnYH.zwuZvCRnzm比对情况：true</span>
<span class="token comment">// 转换后密码：$2a$10$s2qgaKGgULYQ7tce2u6TIeHopap4HqfyghJYu1vdDZ2WcNk70ykFe比对情况：true</span>
<span class="token comment">// 转换后密码：$2a$10$XQaQJIfXyd/UvMHC..uBNuDXNVrZHnEGn.tW0oSB6WVjdsZLFpkGq比对情况：true</span>
</code></pre> </li><li> <p>修改数据库中的密码为<code>Bcrypt</code>格式，并且记录明文密码，稍后申请令牌时需要。</p> <p>由于修改密码编码方式还需要将(<mark>授权服务的<code>AuthorizationServer</code></mark>)客户端的密钥更改为<code>Bcrypt</code>格式。</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span>
          <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        clients<span class="token punctuation">.</span><span class="token function">inMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 使用in-memory存储</span>
                <span class="token punctuation">.</span><span class="token function">withClient</span><span class="token punctuation">(</span><span class="token string">"XcWebApp"</span><span class="token punctuation">)</span><span class="token comment">// client_id</span>
<span class="token comment">//                .secret("secret")//客户端密钥</span>
                <span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"XcWebApp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//客户端密钥</span>
                <span class="token punctuation">.</span><span class="token function">resourceIds</span><span class="token punctuation">(</span><span class="token string">"xuecheng-plus"</span><span class="token punctuation">)</span><span class="token comment">//资源列表</span>
                <span class="token punctuation">.</span><span class="token function">authorizedGrantTypes</span><span class="token punctuation">(</span><span class="token string">"authorization_code"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">,</span><span class="token string">"client_credentials"</span><span class="token punctuation">,</span><span class="token string">"implicit"</span><span class="token punctuation">,</span><span class="token string">"refresh_token"</span><span class="token punctuation">)</span><span class="token comment">// 该client允许的授权类型authorization_code,password,refresh_token,implicit,client_credentials</span>
                <span class="token punctuation">.</span><span class="token function">scopes</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">)</span><span class="token comment">// 允许的授权范围</span>
                <span class="token punctuation">.</span><span class="token function">autoApprove</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token comment">//false跳转到授权页面</span>
                <span class="token comment">//客户端接收授权码的重定向地址</span>
                <span class="token punctuation">.</span><span class="token function">redirectUris</span><span class="token punctuation">(</span><span class="token string">"http://www.51xuecheng.cn"</span><span class="token punctuation">)</span>
   <span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre> </li><li> <p>现在重启认证服务。</p> 
  <ol><li>下边使用httpclient进行测试：</li></ol> <pre><code>### 密码模式
POST {<!-- -->{auth_host}}/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=stu1&amp;password=111111

</code></pre> 
  <ol start="2"><li> <p>输入正确的账号和密码，申请令牌成功。</p> </li><li> <p>输入错误的密码，报错：</p> </li></ol> <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"error"</span><span class="token operator">:</span> <span class="token string">"invalid_grant"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"error_description"</span><span class="token operator">:</span> <span class="token string">"用户名或密码错误"</span>
<span class="token punctuation">}</span>

</code></pre> 
  <ol start="4"><li>输入错误的账号，报错：</li></ol> <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"error"</span><span class="token operator">:</span> <span class="token string">"unauthorized"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"error_description"</span><span class="token operator">:</span> <span class="token string">"UserDetailsService returned null, which is an interface contract violation"</span>
<span class="token punctuation">}</span>

</code></pre> </li></ol> 
<h4><a id="322_Security__1614"></a>3.2.2 拓展Security 用户的身份信息</h4> 
<p>​ 用户表中存储了用户的<code>账号</code>、<code>手机号</code>、<code>email</code>、<code>昵称</code>、<code>QQ</code>等信息，<code>UserDetails</code>接口只返回了<code>username</code>、<code>password</code>等信息</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetails</span> <span class="token keyword">extends</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><mark><strong>如何扩展Spring Security的用户身份信息呢？</strong></mark></p> 
<p>​ 在认证阶段DaoAuthenticationProvider会调用UserDetailsService查询用户的信息，这里是可以获取到齐全的用户信息。</p> 
<p>​ 由于JWT令牌中用户身份信息来源于UserDetails，UserDetails中仅定义了username为用户的身份信息，这里有两个思路</p> 
<ol><li>扩展UserDetails，时期包括更多的自定义属性</li><li>扩展username的内容，例如存入Json数据作为username的内容</li></ol> 
<p>​ 相较而言，方案2比较简单，而且也不用破坏UserDetails的结构，这里采用方案二</p> 
<p>下面是具体步骤:</p> 
<ol><li>修改UserDetailsImpl如下</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetailsImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     *
     * @param s     用户输入的登录账号
     * @return      UserDetails
     * @throws UsernameNotFoundException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 没别的意思，只是变量名看着舒服</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> s<span class="token punctuation">;</span>
        <span class="token comment">// 根据username去XcUser表中查询对应的用户信息</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回空表示用户不存在，SpringSecurity会帮我们处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 取出数据库存储的密码</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token comment">// 用户敏感信息不要设置</span>
<span class="token operator">+</span>       user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token class-name">String</span> userString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建UserDetails对象，并返回，注意这里的authorities必须指定</span>
<span class="token operator">-</span>       <span class="token keyword">return</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token keyword">return</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>userString<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>重启认证服务，重新生成令牌</li></ol> 
<pre><code>### 密码模式
POST localhost:53070/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username=Kyle&amp;password=111111
</code></pre> 
<ol start="3"><li>校验令牌</li></ol> 
<pre><code>### 校验JWT令牌
POST localhost:53070/auth/oauth/check_token?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsieHVlY2hlbmctcGx1cyJdLCJ1c2VyX25hbWUiOiJ7XCJjb21wYW55SWRcIjpcIjEyMzIxNDE0MjVcIixcImNyZWF0ZVRpbWVcIjpcIjIwMjItMDktMjhUMDg6MzI6MDNcIixcImlkXCI6XCI1MlwiLFwibmFtZVwiOlwiS2lraVwiLFwicGFzc3dvcmRcIjpcIiQyYSQxMCQwcHQ3V2xmVGJuUERUY1d0cC8uMk11NUNUWHZvaG5OUWhSNjI4cXE0Um9LU2MwZEdBZEVnbVwiLFwic2V4XCI6XCIxXCIsXCJzdGF0dXNcIjpcIlwiLFwidXNlcm5hbWVcIjpcIkt5bGVcIixcInV0eXBlXCI6XCIxMDEwMDJcIn0iLCJzY29wZSI6WyJhbGwiXSwiZXhwIjoxNjc4NDUyMzU0LCJhdXRob3JpdGllcyI6WyJ0ZXN0Il0sImp0aSI6Ijc2MDc0MDI4LTBiM2MtNDQ4Mi1hN2Y0LTc1NDI3ZTA2OTFjMSIsImNsaWVudF9pZCI6IlhjV2ViQXBwIn0._GKfGE2s5k0n6VC4_RKQrzdzydWY-WtX3Q_Hc4DxQ1g
</code></pre> 
<ol start="4"><li>响应示例如下</li></ol> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"aud"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"xuecheng-plus"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"user_name"</span><span class="token operator">:</span> <span class="token string">"{\"companyId\":\"1232141425\",\"createTime\":\"2022-09-28T08:32:03\",\"id\":\"52\",\"name\":\"Kiki\",\"password\":\"$2a$10$0pt7WlfTbnPDTcWtp/.2Mu5CTXvohnNQhR628qq4RoKSc0dGAdEgm\",\"sex\":\"1\",\"status\":\"\",\"username\":\"Kyle\",\"utype\":\"101002\"}"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"scope"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"all"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"active"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"exp"</span><span class="token operator">:</span> <span class="token number">1678452354</span><span class="token punctuation">,</span>
  <span class="token string-property property">"authorities"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"test"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"jti"</span><span class="token operator">:</span> <span class="token string">"76074028-0b3c-4482-a7f4-75427e0691c1"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"client_id"</span><span class="token operator">:</span> <span class="token string">"XcWebApp"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><mark>总结 : <code>user_name</code>存储了用户信息的JSON格式，在资源服务中就可以取出该JSON格式的内容，转换为用户对象去使用</mark></p> 
<h4><a id="323__1722"></a>3.2.3 <strong>资源服务获取用户身份</strong></h4> 
<p>​ 下边编写一个工具类在各个微服务中去使用，获取当前登录用户的对象。</p> 
<p>在``content-api<code>中定义</code>SecurityUtil`此类：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityUtil</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">XcUser</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Object</span> principalObj <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>principalObj <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//取出用户身份信息</span>
                <span class="token class-name">String</span> principal <span class="token operator">=</span> principalObj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//将json转成对象</span>
                <span class="token class-name">XcUser</span> user <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>principal<span class="token punctuation">,</span> <span class="token class-name">XcUser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> user<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"获取当前登录用户身份出错:{}"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">XcUser</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> salt<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> wxUnionid<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> companyId<span class="token punctuation">;</span>
        <span class="token comment">/**
         * 头像
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> userpic<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> utype<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> birthday<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> sex<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> cellphone<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">String</span> qq<span class="token punctuation">;</span>

        <span class="token comment">/**
         * 用户状态
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> createTime<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> updateTime<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<ul><li>下面在内容管理服务中测试此工具类，以查询课程信息接口为例</li></ul> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"根据课程id查询课程基础信息"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/course/{courseId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CourseBaseInfoDto</span> <span class="token function">getCourseBaseById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>       <span class="token class-name">SecurityUtil<span class="token punctuation">.</span>XcUser</span> user <span class="token operator">=</span> <span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>       <span class="token class-name">Object</span> principal <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前用户身份为："</span> <span class="token operator">+</span> principal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前用户身份为："</span> <span class="token operator">+</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> courseBaseInfoService<span class="token punctuation">.</span><span class="token function">getCourseBaseInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="33___1814"></a>3.3 如何支持认证方式多样化</h3> 
<h4><a id="331__1816"></a>3.3.1 统一认证入口</h4> 
<p>​ 目前各大网站的认证方式非常丰富：账号密码认证、手机验证码认证、扫码登录等。基于当前研究的Spring Security认证流程如何支持多样化的认证方式呢？</p> 
<p>1、支持账号和密码认证</p> 
<p>​ 采用OAuth2协议的密码模式即可实现。</p> 
<p>2、支持手机号加验证码认证</p> 
<p>​ 用户认证提交的是手机号和验证码，并不是账号和密码。</p> 
<p>3、微信扫码认证</p> 
<p>​ 基于OAuth2协议与微信交互，学成在线网站向微信服务器申请到一个令牌，然后携带令牌去微信查询用户信息，查询成功则用户在学成在线项目认证通过。</p> 
<p>​ 目前我们测试通过OAuth2的密码模式，用户认证会提交账号和密码，由DaoAuthenticationProvider调用UserDetailsService的loadUserByUsername()方法获取UserDetails用户信息。</p> 
<p>​ 在前边我们自定义了UserDetailsService接口实现类，通过loadUserByUsername()方法根据账号查询用户信息。</p> 
<p>​ 而不同的认证方式提交的数据不一样，比如：<mark>手机加验证码方式会提交手机号和验证码</mark>，<mark>账号密码方式会提交账号、密码、验证码</mark>。</p> 
<p>​ 我们可以在<code>loadUserByUsername()</code>方法上作文章，将用户原来提交的账号数据改为提交json数据，json数据可以扩展不同认证方式所提交的各种参数。</p> 
<ol><li>首先创建一个DTO类表示认证的参数：</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthParamsDto</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span> <span class="token comment">//用户名</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span> <span class="token comment">//域  用于扩展</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> cellphone<span class="token punctuation">;</span><span class="token comment">//手机号</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> checkcode<span class="token punctuation">;</span><span class="token comment">//验证码</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> checkcodekey<span class="token punctuation">;</span><span class="token comment">//验证码key</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> authType<span class="token punctuation">;</span> <span class="token comment">// 认证的类型   password:用户名密码模式类型    sms:短信模式类型</span>

    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> payload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//附加数据，作为扩展，不同认证类型可拥有不同的附加数据。如认证类型为短信时包含smsKey : sms:3d21042d054548b08477142bbca95cfa; 所有情况下都包含clientId</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>同时我们也需要修改<code>loadUserByUsername()</code>方法</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetailsImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * @param s 用户输入的登录账号
     * @return UserDetails
     * @throws UsernameNotFoundException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>       <span class="token class-name">AuthParamsDto</span> authParamsDto <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>           authParamsDto <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">AuthParamsDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>           log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"认证请求数据格式不对：{}"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"认证请求数据格式不对"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token punctuation">}</span>
<span class="token operator">-</span>       <span class="token comment">// 没别的意思，只是变量名看着舒服</span>
<span class="token operator">-</span>       <span class="token class-name">String</span> name <span class="token operator">=</span> s<span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token class-name">String</span> name <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据username去XcUser表中查询对应的用户信息</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回空表示用户不存在，SpringSecurity会帮我们处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 取出数据库存储的密码</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建UserDetails对象，并返回，注意这里的authorities必须指定</span>
        <span class="token keyword">return</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>userString<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>刚刚我们重写的<code>loadUserByUsername()</code>方法是由<code>DaoAuthenticationProvider</code>调用的，而<code>DaoAuthenticationProvider</code>中有一个方法是用于校验密码的，但是并不是所有的校验方式都需要密码，所以我们现在需要重写一个<code>DaoAuthenticationProviderCustom</code></li></ol> 
<ul><li><code>DaoAuthenticationProviderCustom</code></li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DaoAuthenticationProviderCustom</span> <span class="token keyword">extends</span> <span class="token class-name">DaoAuthenticationProvider</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 由于DaoAuthenticationProvider调用UserDetailsService，所以这里需要注入一个</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserDetailsService</span><span class="token punctuation">(</span><span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setUserDetailsService</span><span class="token punctuation">(</span>userDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 屏蔽密码对比，因为不是所有的认证方式都需要校验密码</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span> userDetails<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 里面啥也不写就不会校验密码了</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><code>DaoAuthenticationProvider</code>中会校验密码</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span> userDetails<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Authentication failed: no credentials provided"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span><span class="token punctuation">,</span> <span class="token string">"Bad credentials"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> presentedPassword <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>presentedPassword<span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Authentication failed: password does not match stored value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span><span class="token punctuation">,</span> <span class="token string">"Bad credentials"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>同时也需要修改<code>WebSecurityConfig</code>类，指定<code>DaoAuthenticationProviderCustom</code></li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">DaoAuthenticationProviderCustom</span> daoAuthenticationProviderCustom<span class="token punctuation">;</span>
<span class="token comment">// 配置密码验证方式</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    auth<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span>daoAuthenticationProviderCustom<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>重启认证服务，测试申请令牌，传入账号信息改为JSON数据，打个断点，看看传入的请求参数是否为JSON格式</li></ol> 
<pre><code>### 密码模式
POST localhost:53070/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username={"username":"Kyle","password":"111111"}
</code></pre> 
<ul><li>经过测试发现loadUserByUsername()方法可以正常接收到认证请求中的json数据。</li></ul> 
<p>​ 有了这些认证参数我们可以定义一个认证Service接口去进行各种方式的认证。</p> 
<p>​ 定义dto用户信息，为了扩展性让它继承XcUser(<strong>注:这里最好不要直接用XcUser类，理由在之前的文章也说过，万一我们需要扩展一些其他的用户信息，那么我们直接修改XcUser类是不现实的，因为XcUser类对应的是数据库中的表。所以即使我们要使用XcUser类作为返回类型，也最好是让一个其他的类继承XcUser</strong>)</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XcUserExt</span> <span class="token keyword">extends</span> <span class="token class-name">XcUser</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre> 
<ol><li>定义认证Service接口</li></ol> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 认证Service
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 认证方法
     * @param authParamsDto 认证参数
     * @return  用户信息
     */</span>
    <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li> <p>定义AuthService接口的实现类，即各种认证方式</p> 
  <ol><li> <p>定义AuthService接口的实现类，即各种认证方式</p> <p>一个接口的多种实现，我们依靠<code>beanName</code>来做区分，例如这里的<code>password_authservice</code>，见名知意就知道是密码登录方式</p> </li></ol> <pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"password_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PasswordAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
  <ol start="2"><li>微信扫码方式</li></ol> <pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"wx_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>修改<code>UserDetailsImpl</code>的<code>loadUserByUsername()</code></p> </li></ol> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">AuthParamsDto</span> authParamsDto <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            authParamsDto <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">AuthParamsDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"认证请求数据格式不对：{}"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"认证请求数据格式不对"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token operator">+</span>       <span class="token comment">// 获取认证类型，beanName就是 认证类型 + 后缀，例如 password + _authservice = password_authservice</span>
<span class="token operator">+</span>       <span class="token class-name">String</span> authType <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getAuthType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token comment">// 根据认证类型，从Spring容器中取出对应的bean</span>
<span class="token operator">+</span>       <span class="token class-name">AuthService</span> authService <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>authType <span class="token operator">+</span> <span class="token string">"_authservice"</span><span class="token punctuation">,</span> <span class="token class-name">AuthService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token class-name">XcUserExt</span> user <span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>authParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>       <span class="token class-name">String</span> name <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>       <span class="token comment">// 根据username去XcUser表中查询对应的用户信息</span>
<span class="token operator">-</span>       <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回空表示用户不存在，SpringSecurity会帮我们处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 取出数据库存储的密码</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建UserDetails对象，并返回，注意这里的authorities必须指定</span>
        <span class="token keyword">return</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>userString<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>到此我们基于Spring Security认证流程修改为如下</strong></p> 
<p><img src="https://images2.imgbox.com/54/4d/DVcPhTdy_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-3XjfDUxx-1682427813461)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425133307015.png)]"></p> 
<h4><a id="332__2060"></a>3.3.2 <strong>实现账号密码认证</strong></h4> 
<p>​ 上节定义了AuthService认证接口，下边实现该接口实现账号密码认证</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"password_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PasswordAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 获取账号</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 根据账号去数据库中查询是否存在</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 不存在抛异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xcUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"账号不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4. 校验密码</span>
        <span class="token comment">// 4.1 获取用户输入的密码</span>
        <span class="token class-name">String</span> passwordForm <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.2 获取数据库中存储的密码</span>
        <span class="token class-name">String</span> passwordDb <span class="token operator">=</span> xcUser<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.3 比较密码</span>
        <span class="token keyword">boolean</span> matches <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>passwordForm<span class="token punctuation">,</span> passwordDb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.4 不匹配，抛异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matches<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"账号或密码错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4.5 匹配，封装返回</span>
        <span class="token class-name">XcUserExt</span> xcUserExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>xcUser<span class="token punctuation">,</span> xcUserExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUserExt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 修改<code>UserDetails</code>中<code>loadUserByUsername()</code>方法，我们可以将最后的封装<code>UserDetails</code>的相关代码抽取为一个方法</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">AuthParamsDto</span> authParamsDto <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            authParamsDto <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">AuthParamsDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"认证请求数据格式不对：{}"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"认证请求数据格式不对"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取认证类型，beanName就是 认证类型 + 后缀，例如 password + _authservice = password_authservice</span>
        <span class="token class-name">String</span> authType <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getAuthType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据认证类型，从Spring容器中取出对应的bean</span>
        <span class="token class-name">AuthService</span> authService <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>authType <span class="token operator">+</span> <span class="token string">"_authservice"</span><span class="token punctuation">,</span> <span class="token class-name">AuthService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcUserExt</span> user <span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>authParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>       <span class="token comment">// 返回空表示用户不存在，SpringSecurity会帮我们处理</span>
<span class="token operator">-</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">-</span>           <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token operator">-</span>       <span class="token punctuation">}</span>
<span class="token operator">-</span>       <span class="token comment">// 取出数据库存储的密码</span>
<span class="token operator">-</span>       <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>       user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>       <span class="token class-name">String</span> userString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>       <span class="token comment">// 创建UserDetails对象，并返回，注意这里的authorities必须指定</span>
<span class="token operator">-</span>       <span class="token keyword">return</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>userString<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token keyword">return</span> <span class="token function">getUserPrincipal</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token operator">+</span>   <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">getUserPrincipal</span><span class="token punctuation">(</span><span class="token class-name">XcUserExt</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>       <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> authorities <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"test"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token class-name">String</span> userJsonStr <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>userJsonStr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>
<span class="token operator">+</span>   <span class="token punctuation">}</span>
</code></pre> 
<p>重启认证服务，测试申请令牌接口</p> 
<ul><li>申请令牌，注意JSON数据中要带上==<strong>authType</strong>==</li></ul> 
<pre><code>### 密码模式
POST localhost:53070/auth/oauth/token?client_id=XcWebApp&amp;client_secret=XcWebApp&amp;grant_type=password&amp;username={"username":"Kyle","password":"111111","authType":"password"}
</code></pre> 
<h4><a id="333_Redis_2154"></a>3.3.3 Redis实现<strong>验证码服务</strong></h4> 
<p>​ 在认证时一般都需要输入验证码，验证码有什么用？</p> 
<p>​ 验证码可以防止恶性攻击，比如：XSS跨站脚本攻击、CSRF跨站请求伪造攻击，一些比较复杂的图形验证码可以有效的防止恶性攻击。</p> 
<p>​ 为了保护系统的安全在一些比较重要的操作都需要验证码。</p> 
<p>​ 验证码的类型也有很多：图片、语音、手机短信验证码等。</p> 
<p><img src="https://images2.imgbox.com/19/c3/PDYld2h1_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-06eby6ot-1682427813462)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425134542510.png)]"></p> 
<p>下面导入黑马的验证码模块:</p> 
<p><img src="https://images2.imgbox.com/50/26/vPDOUUx6_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-KVYTLu6r-1682427813462)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425134759035.png)]"></p> 
<ol><li>定义nacos配置文件</li></ol> 
<pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /checkcode
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">63075</span>

</code></pre> 
<ol start="2"><li>配置<code>redis-dev.yaml</code></li></ol> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.101.65
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">20</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>
    <span class="token comment">#redisson:</span>
      <span class="token comment">#配置文件目录</span>
      <span class="token comment">#config: classpath:singleServerConfig.yaml</span>

</code></pre> 
<ol start="3"><li>新增网关的nacos配置</li></ol> 
<pre><code class="prism language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> auth<span class="token punctuation">-</span>service
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//auth<span class="token punctuation">-</span>service
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/auth/<span class="token important">**</span>
<span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> checkcode
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//checkcode
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/checkcode/<span class="token important">**</span>
</code></pre> 
<ol start="4"><li>验证码模块的bootstrap.yaml</li></ol> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> checkcode
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.profiles.active<span class="token punctuation">}</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.profiles.active<span class="token punctuation">}</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> swagger<span class="token punctuation">-</span>$<span class="token punctuation">{<!-- --></span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> logging<span class="token punctuation">-</span>$<span class="token punctuation">{<!-- --></span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>$<span class="token punctuation">{<!-- --></span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
</code></pre> 
<ol start="5"><li>在验证码模块中引入redis的依赖</li></ol> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--redis依赖--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--common-pool--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ol start="6"><li>在验证码模块中(xuecheng-plus-checkcod),<code>CheckCodeService</code>是验证码接口，其内部还有一个<code>CheckCodeStore</code>接口，<code>CheckCodeStore</code>接口是负责存储验证码的</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CheckCodeStore</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * @param key    key
     * @param value  value
     * @param expire 过期时间,单位秒
     * @return void
     * @description 向缓存设置key
     * @author Mr.M
     * @date 2022/9/29 17:15
     */</span>
    <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">Integer</span> expire<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="7"><li>它的实现类为<code>MemoryCheckCodeStore</code>，现在我们只需要修改这个类，改为用Redis缓存验证码即可</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"MemoryCheckCodeStore"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemoryCheckCodeStore</span> <span class="token keyword">implements</span> <span class="token class-name">CheckCodeService<span class="token punctuation">.</span>CheckCodeStore</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 注入StringRedisTemplate</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">Integer</span> expire<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> expire<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>验证码服务测试:</p> 
<ol><li>Controller中<code>generatePicCheckCode</code>方法，是用来<mark>生成验证码图片</mark>的</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"生成验证信息"</span><span class="token punctuation">,</span> notes<span class="token operator">=</span><span class="token string">"生成验证信息"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/pic"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CheckCodeResultDto</span> <span class="token function">generatePicCheckCode</span><span class="token punctuation">(</span><span class="token class-name">CheckCodeParamsDto</span> checkCodeParamsDto<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> picCheckCodeService<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>checkCodeParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>我们使用HttpClient测试该接口</li></ol> 
<pre><code>### 获取验证码图片
POST localhost:53075/checkcode/pic
</code></pre> 
<ol start="3"><li>响应结果如下，图片是以base64编码格式存储的，我们可以复制直接在浏览器中打开</li></ol> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token string">"checkcode:20a2ccb511bc472ea785db14d0a547ba"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aliasing"</span><span class="token operator">:</span> <span class="token string">"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIoAAAAiCAIAAAAPqtawAAAL9UlEQVR42t2aeVRV1xXGH86CgsNyFgccEJazqDjgPOKEshwAxVlUQMWFOE8FWTiLIi6cWSqi4ISCOKA2U5s0HZI2aZqGpk3TNDGmbdqkSeuw+lvneJ7Pd++77z4ID+33x1v33eEM+zt7f3vfeyz3FH6s8IrAqwKvKbwu8IbATwR+qvCmwFsCP1N4W+DnAr8Q+KXCrxTeEXhX4NcCv1F4T+B9gd8qfCDwO4EPBX6v8JFAqcAfFD4W+KPCnwQ+EfizwqcCfxH4TOCvCp8LfCFwX+FLgQcCXwn8TeHvCv8Q+FrgnwL/UvhG4FuBfyt8J/C9wH8E/qtgsaPnFQVbel5X0NLzpoItPW8rGNDzjoKWnvcUbOn5QEFLz0cKtvR8rGDLjR09nypo6flcwZaeLxW09Nhxo0vPNwq29HynoKXn4cOH+vS8qqB1HV163lLQuo4xPe8qaOl5X0HrOrr0lCoY0POJgtZ1dOn5QkHrOsb0fK1gkp7vFVygxyCy6dJjENms9BhENvP0fKjwA9LzmYJJer5ScBrZ7Oj5VsFRZNOh5/9VeHiEO19S4bGn5+UVHu7kqqSHrmlH0sNtXH1JhUefHrcJz+nTp7k/JyeH2+iuzMLDL61ZHYimOObMjBkzJk+eTKdlEx5dehgbtzEFrla08BjR46rw6NJjJzy29HAcEBCwaNGinj17Hjp0iAO4uXHjhqvCs3jxYshITU0dOnQo4zxz5syaNWsiIiKWLl169OjRffv2FRQU4JrlFx4eZHYxMTEJCQnDhg1zSk/5hecpPe4XHp5KSUnp2rWrt7d3jRo1OnTowEFUVNSIESPy8vLu3r2LlR0JD4A/iKEvxlxYWJifn4+jZGRkwHS1atXatGnDr6+v7+jRoyEJyhleeYSH27KyslauXNmkSZMqVao0bNgQkjIzMytaeJ6jx53Ck5ubi7ts2bKlefPmXl5e9evXx6AeHh5169YNCgpq27bt3Llzd+zYQQta4eGAk9nZ2aGhodeuXRs0aNDYsWOZBb5CC/jQpEmTaNDHx6dv376xsbGMyqnwQDYSiG4xSMkNJFm9B+Pgo56enrRvsVhCQkLghpbNC48uPQbC45Ae9wjPpUuXsGxJScm2bduSkpIgIzg4uEWLFtWrV69atSomGDBgQLt27WbPns1ItMJz7NixefPm0VFcXJy/vz+/y5cv79+/P/63detWfAhTduzYMTIyEpeiO0f0yIyuuLj4RwIHDx5kTZw9e/bWrVu4r+QGnrghPj6+igBjW7hwIa7PyE0KD5eYNVM+efIkrmxeeFyj5wcUHmvORms8e/v27RMnTqSnp2Prli1b4knNmjUjRiUnJxO4GICt8DBUFIW04siRI/hHYmLiDIG9e/dCEvEHgrEj9CBIDMM4L+CejRs30g6MoiiBgYG7d+++cuUKc5H0HD58+Pz58xAvm4Ue/B55KyoqMik8WHjixIk1a9bkWVaAeeF59OiR5QWpeLA10+jVq1d0dPS0adMITUQtvITz0oGs9OB28tlVq1Zx8/Tp03fu3Im9Vq9ejUvhOkS28PBw0g16J7c2rngGDhyI9fnFdp06dWrQoMH8+fPpAmK4H+Eh9yNsjhkzhhVTu3ZtbmNgOCUtO6WHTA+ThoWF1alTxyIAqeaF5xk9lV7xHD9+HMfHdeAGtW/UqNHNmzeXLVt2584drupWPMRG7IjtyNwIhrjLhg0bEHAOiDz0ZeZVG0EMmpFAPANpQfnwWqawa9cuuoMeYixtEjlxUMjjNn6xiV3apis8DB524UaKFmAu5oXHnp7KetXGNCADbgggRDb6YkrMBJ0nSTOoeOCGAzIFMjQIRrpIE1asWEEyjc4b0wM3w4cP5y9PkU2QQGJEXJDEhEscSO8ZPHgwiWW/fv0Qp9atW0tD41vGwgMYLaQS0/A5Kz2cNy88LtBTEcIjueFxVv2BAweYAzPBEOgQ6kJiTbgzftVGd9xGWnXhwgWcj5R31KhRDI9LTl+10SAhi2GQLpIR+Pn51apVi8e7dOnCCCEbDiAeepo2bUqWOHPmzCFDhmBiPNug4uEXdkkuCNRQTuMEN8lN48aNXRIefXrcLDyEspEjR5JkEzewEVKMfnKP01dtuBfDg5UePXoQzXA1eCotLaVfk994aJOsBFZIDXA7/IbAxe+mTZu4yp0I2KxZsyZMmDB+/Hhu4AArw5+jioczdMoUIJ7pQOSSJUvOnTsn6aHOc0l4ntJTucJDutm5c2fWJkkXEk2zly9fNvmqDYZOnTrF2kc8MDFyTePG9NgKD0Mi34MPGMJrSfzwD9Y7sY6rEI8QEipJ7fAAitxx48ZhZRI8O3okN6Tg8k1Vt27doJk6gSyDaZIHSnooul0SnufocVV4dOkpg/CQyLLKIAYlIA1z6VUbRJKt7d+/H+Nu376dYEgvZj7ByWqUzBALUnVhuz59+uArHLPqoYe5kA0SoEhPyB5jYmJIjmWCN3XqVF3XwVzr168nryOmkQQmJCRgIkpR4qSkh9m5JDxm6akg4eGX7lB10oH27dtThKalpZl81UbKQIObN29GruvVqzdlyhQGJt9Sc0k6kNM3oYRE2KWShRJauH79+pw5c8gUOEkVSYDCAxgVi4BEDuOSI2DlBQsW6NKTmZnJLPBjghjZIAsIiYKePXv2SHqIvS4Jjw49bhYeGaZbtWpFVcHSo0eT33hoh5FjU8IRYYf4JumhFxqHITPfeNAYnCMpKYmMkQMmhdIwEtI2ailKKPIuCKPNq1evEn69vLwIg9xPg1p6aM1DAFLXrVv34MED+S6HNSTpoVmX6Hn8+LGlcoWHcE9cwijdu3cnfzP5jYe/tED1zlKFXWKULF0pYhAMykwEOTc31+mrNsombI3mYztiEbNjPESwyMhIqhx/f39oY9HQCCJHfOO2wMBAzE13dsLDAeWRx/MIDg6Oi4sj8ZH0EBXxV5JMk8LjhJ4KFR6apTWIoaIkdGBlYj3N6uZsdvQgEiTi0ENkIyOA19TUVByRWicnJwcx5yp6DlsGwsMYOE9oRflwC+zIlCGVdIAMmHyBNB0HolnOcz/dYWJ8aO3atbSsTanxZkTLQw8WG+CXJoXnGT3uFx4a4REWqa+vL1k1K4vgwOOcNBAe+SwLmfju4+ODXCO8yAPtENkxhKenJ7GOXBbKs7OzCXGO6KFTrEzsImMkYyYpuHjxIndygJhRFyNCiYmJ+GJRURFhkyQC4zJIPCwrK8tRQYre4M3wRBjUcgPS09NNCo89Pe4UHvmLdShFKf0IMlSj8mupgfDQNQscn+vduzfJa0REBLGRiIERZW4dHh5OUCJ9IrCQ0Unv0RUeUmqopSlMWVBQAMEQhv8xJMZDRKJ9skryAuihEc4T63BxvJPuzHyCKykpIZ8ki5PEBAUFEQCZtUnh0afHbcJDaU3RQ3hh+XPgVHjoi5bR8ICAAG9v7+jo6KioKJhgRRMhsa/8DhQfH49ZMX1eXh4Bh8cdbS6APOiBDIpTDnAL1gfhC++EKiIn7citCvfv34cVBJKSubi4mMGY/MbDX5m4g4yMDPMVjxN63FDx0AL3yx51937YCU9hYSF2ZNWHhIT4C1CTwhCZElSRDlBwYGvKQMIUZzAlXfOgo80FrAyUH0ekkdjYWJYIN0B2SkoKbBF1qTGtu9oYhvUDtvnNBZyUUdEa1swLz1N6KuVVW9l2tZ0VoJIgv8Ky8gMajTBCIom1IMVp0BVmYby5gKhFWCOo+vn5JScny1wcC6BbZGjwjQXotDy72vhLO5IemnVKj63wPEfPS7GrDWKYLckPwyaOk25RALL8qSgdbTo02FzAydLSUu7BXRAqxsl4iGMMkmnSNZfkzqky0wNYT2FhYaGhofn5+eYrHn16DIRHl55y7mrTpcdRxSP/EoLS0tJwDrmr7d69e3YbQp2+atPu/WCozEVuxXK6q834G085NxfY0vPkyRNLZQmP002H2opHnseIDIxmy7Db3dVdbe7cTq1Pz0skPC/ydmpdegx2tZkRnmf0uFl4dOkxEB5deuy2U7sqPLr0GGynLvOmQ4NvPMbCY0/Piyw8jugpv/C4tJ3ancID/geQCXNUYmEBQwAAAABJRU5ErkJggg=="</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>Controller中<code>verify</code>方法,是用来<mark>校验验证码</mark>的</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/verify"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Boolean</span> isSuccess <span class="token operator">=</span> picCheckCodeService<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> isSuccess<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>我们同样使用HttpClient进行测试</li></ol> 
<pre><code>### 校验验证码
POST localhost:53075/checkcode/verisfy?key=checkcode:c3dce1413f95414e943dcf0a97983fe8&amp;code=HZCG
</code></pre> 
<h4><a id="334__2356"></a>3.3.4 <strong>账号密码认证</strong></h4> 
<h5><a id="3341__2358"></a>3.3.4.1 <strong>需求分析</strong></h5> 
<p>​ 效果图:</p> 
<pre><code>![\[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-DRmedWBQ-1682427813463)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425140045733.png)\]](https://img-blog.csdnimg.cn/f1b4ec7e24e0499687f9abc8e1486794.png)
</code></pre> 
<p>​ 执行流程如下：</p> 
<p><img src="https://images2.imgbox.com/4b/5b/X2bt7Qc6_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-1rQ8ixEG-1682427813463)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425140057149.png)]"></p> 
<h5><a id="3342_auth_2370"></a>3.3.4.2 auth工程<strong>账号密码认证开发</strong></h5> 
<ol><li>在auth工程中定义远程调用验证码服务的接口</li></ol> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"checkcode"</span><span class="token punctuation">,</span>fallbackFactory <span class="token operator">=</span> <span class="token class-name">CheckCodeClientFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
 <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/checkcode"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CheckCodeClient</span> <span class="token punctuation">{<!-- --></span>

 <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/verify"</span><span class="token punctuation">)</span>
 <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre> 
<ol start="2"><li><code>CheckCodeClientFactory</code>熔断降级实现方案:</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheckCodeClientFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CheckCodeClient</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">CheckCodeClient</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CheckCodeClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"调用验证码服务熔断异常:{}"</span><span class="token punctuation">,</span> throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<ol start="3"><li>启动类添加注解</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.xuecheng.*.feignclient"</span><span class="token punctuation">)</span>
</code></pre> 
<ol start="4"><li>完善PasswordAuthServiceImpl</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"password_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PasswordAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>

<span class="token operator">+</span>   <span class="token annotation punctuation">@Autowired</span>
<span class="token operator">+</span>   <span class="token class-name">CheckCodeClient</span> checkCodeClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>       <span class="token comment">// 校验验证码</span>
<span class="token operator">+</span>       <span class="token class-name">String</span> checkcode <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getCheckcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token class-name">String</span> checkcodekey <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getCheckcodekey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>checkcode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>checkcodekey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"验证码为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token punctuation">}</span>
<span class="token operator">+</span>       <span class="token class-name">Boolean</span> verify <span class="token operator">=</span> checkCodeClient<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>checkcodekey<span class="token punctuation">,</span> checkcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>verify<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"验证码输入错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token punctuation">}</span>
        <span class="token comment">// 1. 获取账号</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 根据账号去数据库中查询是否存在</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 不存在抛异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xcUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"账号不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4. 校验密码</span>
        <span class="token comment">// 4.1 获取用户输入的密码</span>
        <span class="token class-name">String</span> passwordForm <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.2 获取数据库中存储的密码</span>
        <span class="token class-name">String</span> passwordDb <span class="token operator">=</span> xcUser<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.3 比较密码</span>
        <span class="token keyword">boolean</span> matches <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>passwordForm<span class="token punctuation">,</span> passwordDb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.4 不匹配，抛异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matches<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"账号或密码错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4.5 匹配，封装返回</span>
        <span class="token class-name">XcUserExt</span> xcUserExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>xcUser<span class="token punctuation">,</span> xcUserExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUserExt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>到这里,<code>PasswordAuthServiceImpl</code>完整的代码如下:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"password_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PasswordAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">PasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">CheckCodeClient</span> checkCodeClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 校验验证码</span>
        <span class="token class-name">String</span> checkcode <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getCheckcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> checkcodekey <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getCheckcodekey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>checkcode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>checkcodekey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"验证码为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Boolean</span> verify <span class="token operator">=</span> checkCodeClient<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>checkcodekey<span class="token punctuation">,</span> checkcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>verify<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"验证码输入错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 1. 获取账号</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 根据账号去数据库中查询是否存在</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 不存在抛异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xcUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"账号不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4. 校验密码</span>
        <span class="token comment">// 4.1 获取用户输入的密码</span>
        <span class="token class-name">String</span> passwordForm <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.2 获取数据库中存储的密码</span>
        <span class="token class-name">String</span> passwordDb <span class="token operator">=</span> xcUser<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.3 比较密码</span>
        <span class="token keyword">boolean</span> matches <span class="token operator">=</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>passwordForm<span class="token punctuation">,</span> passwordDb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.4 不匹配，抛异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matches<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"账号或密码错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4.5 匹配，封装返回</span>
        <span class="token class-name">XcUserExt</span> xcUserExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>xcUser<span class="token punctuation">,</span> xcUserExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUserExt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="3343__2525"></a>3.3.4.3 <strong>账号密码认证测试</strong></h5> 
<p><img src="https://images2.imgbox.com/e6/2c/1FO1HIAn_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-ah3M2xU7-1682427813464)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425141016169.png)]"></p> 
<ol><li> <p>首先测试验证码，分别输入正确的验证码和错误的验证码进行测试</p> </li><li> <p>输入正确的账号密码和错误的账号密码进行测试</p> </li><li> <p>登录成功将jwt令牌存储cookie.</p> </li><li> <p>测试自动登录</p> </li><li> <p>勾选自动登录cookie生成时间为30天，不勾选自动登录关闭浏览器窗口后自动删除cookie。</p> </li></ol> 
<h2><a id="4__2542"></a>4. <strong>微信扫码登录</strong></h2> 
<h3><a id="41__2544"></a>4.1 接入规范</h3> 
<h4><a id="411__2546"></a>4.1.1 接入流程</h4> 
<p>​ 微信扫码登录基于OAuth2协议的授权码模式，</p> 
<p>接口文档：</p> 
<p>https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html</p> 
<p>流程如下：</p> 
<p><img src="https://images2.imgbox.com/ba/30/yhmzA6PQ_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-dGo0pvod-1682427813465)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425184012245.png)]"></p> 
<p>​ 第三方应用获取access_token令牌后即可请求微信获取用户的信息，成功获取到用户的信息表示用户在第三方应用认证成功。</p> 
<h4><a id="412__2561"></a>4.1.2 <strong>请求获取授权码</strong></h4> 
<p>步骤1：在页面中先引入如下 JS 文件（支持https）：</p> 
<p>http://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js</p> 
<p>步骤2：在需要使用微信登录的地方实例以下 JS 对象：</p> 
<pre><code class="prism language-js"><span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxLogin</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
 <span class="token literal-property property">self_redirect</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
 <span class="token literal-property property">id</span><span class="token operator">:</span><span class="token string">"login_container"</span><span class="token punctuation">,</span> 
 <span class="token literal-property property">appid</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> 
 <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> 
 <span class="token literal-property property">redirect_uri</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
 <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
 <span class="token literal-property property">href</span><span class="token operator">:</span> <span class="token string">""</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/20/7a/U31JVPPr_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-VgAc1oAT-1682427813465)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425184531846.png)]"></p> 
<p><img src="https://images2.imgbox.com/7d/89/C3h3xUAt_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-vmVoy9h8-1682427813465)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425184538597.png)]"></p> 
<h4><a id="413__2591"></a>4.1.3 接入微信登录</h4> 
<h5><a id="4131__2593"></a>4.1.3.1 接入分析</h5> 
<p>​ 根据OAuth2协议授权码流程，结合本项目自身特点，分析接入微信扫码登录的流程</p> 
<p><img src="https://images2.imgbox.com/ef/d7/Z7br84jX_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-OaRrIbFQ-1682427813466)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425184745497.png)]"></p> 
<h5><a id="4132__2600"></a>4.1.3.2 定义接口定义接口</h5> 
<ol><li>定义<code>WxLoginController</code>类，如下：</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxLoginController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">WxAuthServiceImpl</span> wxAuthService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/wxLogin"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wxLogin</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> state<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"微信扫码回调,code:{},state:{}"</span><span class="token punctuation">,</span>code<span class="token punctuation">,</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> wxAuthService<span class="token punctuation">.</span><span class="token function">wxAuth</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>xcUser<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">"redirect:http://localhost/error.html"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> xcUser<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"redirect:http://localhost/sign.html?username="</span><span class="token operator">+</span>username<span class="token operator">+</span><span class="token string">"&amp;authType=wx"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>定义微信认证的service</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"wx_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">wxAuth</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//TODO: 获取access_token</span>

        <span class="token comment">//TODO: 获取用户信息</span>

        <span class="token comment">// 这里先用个假数据</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> <span class="token string">"Kyle"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//TODO: 添加用户信息到数据库</span>
        
        <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 微信扫码认证，不需要校验密码和验证码
     *
     * @param authParamsDto 认证参数
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 账号</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"账号不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">XcUserExt</span> xcUserExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> xcUserExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUserExt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="4133__2665"></a>4.1.3.3 申请令牌</h5> 
<p>​ 接下来请求微信申请令牌。</p> 
<ol><li> <p>使用<code>restTemplate</code>请求微信，配置<code>RestTemplate bean</code></p> <p>在启动类配置<code>restTemplate</code></p> </li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthApplication</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">AuthApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RestTemplate</span> restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OkHttp3ClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span>  restTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>定义与微信认证的service接口：</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WxAuthService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">wxAuth</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre> 
<ol start="3"><li>让<code>WxAuthServiceImpl</code>实现<code>WxAuthService</code>和<code>AuthService</code></li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"wx_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span><span class="token punctuation">,</span> <span class="token class-name">WxAuthService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">wxAuth</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//TODO: 获取access_token</span>

        <span class="token comment">//TODO: 获取用户信息</span>

        <span class="token comment">// 这里先用个假数据</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> <span class="token string">"Kyle"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//TODO: 添加用户信息到数据库</span>

        <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
    * 微信扫码认证，不需要校验密码和验证码
    *
    * @param authParamsDto 认证参数
    * @return
    */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 账号</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"账号不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">XcUserExt</span> xcUserExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> xcUserExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUserExt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li> <p>在<code>WxAuthServiceImpl</code>类中定义<mark>申请令牌</mark>和<mark>获取用户信息</mark>的私有方法，刚刚我们是用的一个死数据登录的，现在我们要从微信获取真实的用户信息</p> <p><strong>申请令牌<code>getAccess_token()</code>:</strong></p> </li></ol> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAccess_token</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 请求路径模板，参数用%s占位符</span>
    <span class="token class-name">String</span> url_template <span class="token operator">=</span> <span class="token string">"https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&amp;secret=%s&amp;code=%s&amp;grant_type=authorization_code"</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 填充占位符：appid，secret，code</span>
    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>url_template<span class="token punctuation">,</span> appid<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. 远程调用URL，POST方式（详情参阅官方文档）</span>
    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> exchange <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4. 获取相应结果，响应结果为json格式</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5. 转为map</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ <strong>获取用户信息<code>getUserinfo()</code></strong></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserinfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> access_token<span class="token punctuation">,</span><span class="token class-name">String</span> openid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">String</span> wxUrl_template <span class="token operator">=</span> <span class="token string">"https://api.weixin.qq.com/sns/userinfo?access_token=%s&amp;openid=%s"</span><span class="token punctuation">;</span>
    <span class="token comment">//请求微信地址</span>
    <span class="token class-name">String</span> wxUrl <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>wxUrl_template<span class="token punctuation">,</span> access_token<span class="token punctuation">,</span>openid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"调用微信接口申请access_token, url:{}"</span><span class="token punctuation">,</span> wxUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> exchange <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>wxUrl<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//防止乱码进行转码</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token keyword">new</span>     <span class="token class-name">String</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>ISO_8859_1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"调用微信接口申请access_token: 返回值:{}"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> resultMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<ol start="5"><li> <p>测试获取用户信息</p> <p>1、在获取用户信息处打断点</p> <p>2、进入http://www.51xuecheng.cn/wxsign.html</p> <p>3、手机扫码授权</p> </li></ol> 
<h5><a id="4134__2795"></a>4.1.3.4 <strong>保存用户信息</strong></h5> 
<p>​ 向数据库保存用户信息，如果用户不存在，则将其保存在数据库</p> 
<p>下面是具体步骤:</p> 
<ol><li>在<code>WxAuthServiceImpl</code>中定义方法<code>addWxUser()</code>:</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">addWxUser</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> user_info_map<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 获取用户唯一标识：unionid作为用户的唯一表示</span>
    <span class="token class-name">String</span> unionid <span class="token operator">=</span> user_info_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"unionid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 根据唯一标识，判断数据库是否存在该用户</span>
    <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getWxUnionid</span><span class="token punctuation">,</span> unionid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.1 存在，则直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xcUser <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
         <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2.2 不存在，新增</span>
    xcUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.3 设置主键</span>
    <span class="token class-name">String</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.4 设置其他数据库非空约束的属性</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>unionid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>unionid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setWxUnionid</span><span class="token punctuation">(</span>unionid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>user_info_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"nickname"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setUserpic</span><span class="token punctuation">(</span>user_info_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"headimgurl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>user_info_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"nickname"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setUtype</span><span class="token punctuation">(</span><span class="token string">"101001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 学生类型</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.5 添加到数据库</span>
    xcUserMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. 添加用户信息到用户角色表</span>
    <span class="token class-name">XcUserRole</span> xcUserRole <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setRoleId</span><span class="token punctuation">(</span><span class="token string">"17"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRoleMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcUserRole<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>在<code>WxAuthServiceImpl</code>调用<code>addWxUser()</code>方法,<strong><mark>调用<code>@Transactional</code>事务方法,注入自身</mark></strong></li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"wx_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span><span class="token punctuation">,</span> <span class="token class-name">WxAuthService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserRoleMapper</span> xcUserRoleMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">WxAuthServiceImpl</span> wxAuthService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${weixin.appid}"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> appid<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${weixin.secret}"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> secret<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">wxAuth</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 获取access_token</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> access_token_map <span class="token operator">=</span> <span class="token function">getAccess_token</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> accessToken <span class="token operator">=</span> access_token_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 获取用户信息</span>
        <span class="token class-name">String</span> openid <span class="token operator">=</span> access_token_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"openid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> user_info_map <span class="token operator">=</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">,</span> openid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 添加用户信息到数据库</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> wxAuthService<span class="token punctuation">.</span><span class="token function">addWxUser</span><span class="token punctuation">(</span>user_info_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>Controller具体实现:</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/wxLogin"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wxLogin</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> state<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"微信扫码回调,code:{},state:{}"</span><span class="token punctuation">,</span>code<span class="token punctuation">,</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">XcUser</span> user <span class="token operator">=</span> wxAuthService<span class="token punctuation">.</span><span class="token function">wxAuth</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"redirect:http://localhost/error.html"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> username <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"redirect:http://localhost/sign.html?username="</span><span class="token operator">+</span>username<span class="token operator">+</span><span class="token string">"&amp;authType=wx"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>到这里,<code>WxAuthServiceImpl</code>的完整代码如下:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"wx_authservice"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxAuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span><span class="token punctuation">,</span> <span class="token class-name">WxAuthService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserRoleMapper</span> xcUserRoleMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">WxAuthServiceImpl</span> wxAuthService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${weixin.appid}"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> appid<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${weixin.secret}"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> secret<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">wxAuth</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 获取access_token</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> access_token_map <span class="token operator">=</span> <span class="token function">getAccess_token</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> accessToken <span class="token operator">=</span> access_token_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 获取用户信息</span>
        <span class="token class-name">String</span> openid <span class="token operator">=</span> access_token_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"openid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> user_info_map <span class="token operator">=</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">,</span> openid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 添加用户信息到数据库</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> wxAuthService<span class="token punctuation">.</span><span class="token function">addWxUser</span><span class="token punctuation">(</span>user_info_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 微信扫码认证，不需要校验密码和验证码
     *
     * @param authParamsDto 认证参数
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">XcUserExt</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AuthParamsDto</span> authParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 账号</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"账号不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">XcUserExt</span> xcUserExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> xcUserExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUserExt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAccess_token</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 请求路径模板，参数用%s占位符</span>
        <span class="token class-name">String</span> url_template <span class="token operator">=</span> <span class="token string">"https://api.weixin.qq.com/sns/oauth2/access_token?appid=%s&amp;secret=%s&amp;code=%s&amp;grant_type=authorization_code"</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 填充占位符：appid，secret，code</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>url_template<span class="token punctuation">,</span> appid<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 远程调用URL，POST方式（详情参阅官方文档）</span>
        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> exchange <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 获取响应结果，响应结果为json格式</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 转为map</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> access_token<span class="token punctuation">,</span> <span class="token class-name">String</span> openid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 请求路径模板，参数用%s占位符</span>
        <span class="token class-name">String</span> url_template <span class="token operator">=</span> <span class="token string">"https://api.weixin.qq.com/sns/userinfo?access_token=%s&amp;openid=%s"</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 填充占位符，access_token和openid</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>url_template<span class="token punctuation">,</span> access_token<span class="token punctuation">,</span> openid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 远程调用URL，GET方式（详情参阅官方文档）</span>
        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> exchange <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 获取响应结果，JSON格式</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.1 需要转码</span>
        result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>ISO_8859_1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 转为map</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span>

    <span class="token keyword">public</span> <span class="token class-name">XcUser</span> <span class="token function">addWxUser</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> user_info_map<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 获取用户唯一标识：unionid作为用户的唯一表示</span>
        <span class="token class-name">String</span> unionid <span class="token operator">=</span> user_info_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"unionid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 根据唯一标识，判断数据库是否存在该用户</span>
        <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> xcUserMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getWxUnionid</span><span class="token punctuation">,</span> unionid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.1 存在，则直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xcUser <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.2 不存在，新增</span>
        xcUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.3 设置主键</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcUser<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.4 设置其他数据库非空约束的属性</span>
        xcUser<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>unionid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcUser<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>unionid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcUser<span class="token punctuation">.</span><span class="token function">setWxUnionid</span><span class="token punctuation">(</span>unionid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcUser<span class="token punctuation">.</span><span class="token function">setNickname</span><span class="token punctuation">(</span>user_info_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"nickname"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcUser<span class="token punctuation">.</span><span class="token function">setUserpic</span><span class="token punctuation">(</span>user_info_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"headimgurl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcUser<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>user_info_map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"nickname"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcUser<span class="token punctuation">.</span><span class="token function">setUtype</span><span class="token punctuation">(</span><span class="token string">"101001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 学生类型</span>
        xcUser<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcUser<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.5 添加到数据库</span>
        xcUserMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 添加用户信息到用户角色表</span>
        <span class="token class-name">XcUserRole</span> xcUserRole <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcUserRole<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcUserRole<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcUserRole<span class="token punctuation">.</span><span class="token function">setRoleId</span><span class="token punctuation">(</span><span class="token string">"17"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcUserRole<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xcUserRoleMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcUserRole<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xcUser<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="5__3020"></a>5. 用户授权</h2> 
<h3><a id="51_RBAC_3022"></a>5.1 RBAC</h3> 
<p>​ 如何实现授权？业界通常基于RBAC实现授权。</p> 
<p>RBAC分为两种方式：</p> 
<p>​ 1. 基于角色的访问控制（Role-Based Access Control）</p> 
<p>​ (但是如果现在的需求是：总经理和部门经理都可以查询报表和工资，那么此时就需要修改逻辑判断)</p> 
<pre><code class="prism language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>主体<span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"总经理角色ID"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">//TODO: 查询报表</span>
    <span class="token comment">//TODO: 查询工资</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 修改:</p> 
<pre><code class="prism language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>主体<span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"总经理角色ID"</span><span class="token punctuation">)</span> <span class="token operator">||</span> 主体<span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">"部门经理角色ID"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">//TODO: 查询报表</span>
    <span class="token comment">//TODO: 查询工资</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 2. 基于资源的访问控制（Resource-Based Access Control）</p> 
<pre><code class="prism language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>主体<span class="token punctuation">.</span><span class="token function">hasPermission</span><span class="token punctuation">(</span><span class="token string">"查询工资权限标识"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">//TODO: 查询工资</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 优点：系统设计时定义好查询工资的权限标识，即使查询工资所需要的角色变化为总经理和部门经理，也不需要修改授权代码，系统可扩展性强</p> 
<h3><a id="52__3058"></a>5.2 资源服务授权</h3> 
<p>​ 在需要授权的接口处使用==<code>@PreAuthorize("hasAuthority('权限标识符')")</code>==进行控制</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"课程查询接口"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('xc_teachmanager_course_list')"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/course/list"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseBase</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">PageParams</span> pageParams<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">QueryCourseParamDto</span> queryCourseParams<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">PageResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CourseBase</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> courseBaseInfoService<span class="token punctuation">.</span><span class="token function">queryCourseBaseList</span><span class="token punctuation">(</span>pageParams<span class="token punctuation">,</span> queryCourseParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 如果当前用户没有请求该接口的权限，则会抛异常</p> 
<pre><code class="prism language-java"><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span></span>AccessDeniedException</span><span class="token operator">:</span> 不允许访问
</code></pre> 
<p>​ 由于该异常是Spring Security框架抛出的，而我们的统一异常处理器是在base工程中，我们不想让base工程依赖Spring Security，所以采取下面的解决方案</p> 
<h4><a id="521__3080"></a>5.2.1 在统一异常处理器中解析异常信息</h4> 
<p>​ 我们只判断拿到的异常信息是否为<code>不允许访问</code>，如果是，则提示<code>没有操作此功能的权限</code></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>INTERNAL_SERVER_ERROR<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">RestErrorResponse</span> <span class="token function">exception</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"系统异常：{}"</span><span class="token punctuation">,</span> exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"不允许访问"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestErrorResponse</span><span class="token punctuation">(</span><span class="token string">"您没有权限操作此功能"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestErrorResponse</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 这里我们可以重启服务测试</p> 
<h3><a id="53__3097"></a>5.3 查询用户权限</h3> 
<h4><a id="531__3099"></a>5.3.1 用户授权相关的数据表模型</h4> 
<p>​ 如何给用户分配权限呢？查看数据库中的表结构</p> 
<ul><li><code>xc_user</code>：用户表，存储了系统用户信息</li><li><code>xc_user_role</code>：用户角色表，一个用户可拥有多个角色，一个角色可被多个用户拥有</li><li><code>xc_role</code>：角色表，存储了系统的角色类型，角色类型包括：学生、老师、管理员、教学管理员、超级管理员</li><li><code>xc_permission</code>：角色权限表，一个角色可拥有多个权限，一个权限可被多个角色拥有</li><li><code>xc_menu</code>：权限菜单表，里面记录了各种操作的权限code</li></ul> 
<p>步骤:</p> 
<p>查询用户的id</p> 
<p>查询用户所拥有的角色</p> 
<p>查询用户所拥有的权限</p> 
<p>例子：</p> 
<p>SELECT * FROM xc_menu WHERE id IN(<br> SELECT menu_id FROM xc_permission WHERE role_id IN(<br> SELECT role_id FROM xc_user_role WHERE user_id = ‘49’<br> )<br> )</p> 
<ol start="2"><li>给用户分配权限</li></ol> 
<p>1）添加权限</p> 
<p>查询用户的id</p> 
<p>查询权限的id</p> 
<p>查询用户的角色，如果没有角色需要先给用户指定角色</p> 
<p>向角色权限表添加记录</p> 
<p>2）删除用户权限</p> 
<p>本项目是基于角色分配权限，如果要删除用户的权限可以给用户换角色，那么新角色下的权限就是用户的权限；如果不换用户的角色可以删除角色下的权限即删除角色权限关系表相应记录，这样操作是将角色下的权限删除，属于该角色的用户都将删除此权限。</p> 
<h4><a id="532__3141"></a>5.3.2 实现查询用户权限</h4> 
<p>​ 使用Spring Security进行授权，首先在生成jwt前会查询用户的权限，如下图：</p> 
<p><img src="https://images2.imgbox.com/e7/7d/LD2BdLs8_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-v5bRmUcb-1682427813466)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425195906215.png)]"></p> 
<p>​ 接下来修改<code>UserDetailsImpl</code>和<code>PasswordAuthServiceImpl</code>，从数据库查询用户的权限，查询权限的SQL代码如下</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> xc_menu <span class="token keyword">WHERE</span> id <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> menu_id <span class="token keyword">FROM</span> xc_permission <span class="token keyword">WHERE</span>	role_id <span class="token operator">IN</span> <span class="token punctuation">(</span> 
    <span class="token keyword">SELECT</span> role_id <span class="token keyword">FROM</span> xc_user_role <span class="token keyword">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'52'</span> 
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>下面是具体步骤:</p> 
<ol><li>定义mapper接口</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">XcMenuMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcMenu</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"SELECT	* FROM xc_menu WHERE id IN (SELECT menu_id FROM xc_permission WHERE role_id IN ( SELECT role_id FROM xc_user_role WHERE user_id = #{userId} ))"</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcMenu</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectPermissionByUserId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li> <p>修改<code>PasswordAuthServiceImpl</code></p> 
  <ul><li>首先确保在XcUserExt中添加用户权限</li></ul> <pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XcUserExt</span> <span class="token keyword">extends</span> <span class="token class-name">XcUser</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//用户权限</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<p>​ 修改<code>UserDetailsImpl</code>类中的<code>getUserPrincipal</code>方法，查询权限信息，并设置</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">getUserPrincipal</span><span class="token punctuation">(</span><span class="token class-name">XcUserExt</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>   <span class="token comment">// 获取用户id</span>
<span class="token operator">+</span>   <span class="token class-name">String</span> userId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   <span class="token comment">// 根据用户id查询用户权限</span>
<span class="token operator">+</span>   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcMenu</span><span class="token punctuation">&gt;</span></span> xcMenus <span class="token operator">=</span> xcMenuMapper<span class="token punctuation">.</span><span class="token function">selectPermissionByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   <span class="token comment">// 没权限，给一个默认的</span>
<span class="token operator">+</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>xcMenus<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>       permissions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>       <span class="token comment">// 获取权限，加入到集合里</span>
<span class="token operator">+</span>       xcMenus<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>xcMenu <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>           permissions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>xcMenu<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   <span class="token punctuation">}</span>
<span class="token operator">+</span>   <span class="token comment">// 设置权限</span>
<span class="token operator">+</span>   user<span class="token punctuation">.</span><span class="token function">setPermissions</span><span class="token punctuation">(</span>permissions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">-</span>   <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> authorities <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"test"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">+</span>   <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> authorities <span class="token operator">=</span> permissions<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> userJsonStr <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>userJsonStr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>到这里,<code>UserDetailsImpl</code>的完整代码如下:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetailsImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcUserMapper</span> xcUserMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">XcMenuMapper</span> xcMenuMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span>

    <span class="token comment">/**
     * @param s 用户输入的登录账号
     * @return UserDetails
     * @throws UsernameNotFoundException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">AuthParamsDto</span> authParamsDto <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            authParamsDto <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">AuthParamsDto</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"认证请求数据格式不对：{}"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"认证请求数据格式不对"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取认证类型，beanName就是 认证类型 + 后缀，例如 password + _authservice = password_authservice</span>
        <span class="token class-name">String</span> authType <span class="token operator">=</span> authParamsDto<span class="token punctuation">.</span><span class="token function">getAuthType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据认证类型，从Spring容器中取出对应的bean</span>
        <span class="token class-name">AuthService</span> authService <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>authType <span class="token operator">+</span> <span class="token string">"_authservice"</span><span class="token punctuation">,</span> <span class="token class-name">AuthService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcUserExt</span> user <span class="token operator">=</span> authService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>authParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getUserPrincipal</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">getUserPrincipal</span><span class="token punctuation">(</span><span class="token class-name">XcUserExt</span> user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取用户id</span>
        <span class="token class-name">String</span> userId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据用户id查询用户权限</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcMenu</span><span class="token punctuation">&gt;</span></span> xcMenus <span class="token operator">=</span> xcMenuMapper<span class="token punctuation">.</span><span class="token function">selectPermissionByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 没权限，给一个默认的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xcMenus<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            permissions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 获取权限，加入到集合里</span>
            xcMenus<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>xcMenu <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                permissions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>xcMenu<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 设置权限</span>
        user<span class="token punctuation">.</span><span class="token function">setPermissions</span><span class="token punctuation">(</span>permissions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> authorities <span class="token operator">=</span> permissions<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userJsonStr <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>userJsonStr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorities</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> userDetails<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2><a id="6__3277"></a>6. 实现发送邮件</h2> 
<p>​ 1. 在checkcode模块中导入邮件发送相关依赖</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/javax.activation/activation --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.activation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>activation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/javax.mail/mail --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>javax.mail<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mail<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.4.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-email --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-email<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ol start="2"><li>编写邮件工具类</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MailUtil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MessagingException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//可以在这里直接测试方法，填自己的邮箱即可</span>
        <span class="token function">sendTestMail</span><span class="token punctuation">(</span><span class="token string">"1272633570@qq.com"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MailUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">achieveCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 发送邮件
     * @param email 收件邮箱号
     * @param code  验证码
     * @throws MessagingException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sendTestMail</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MessagingException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建Properties 类用于记录邮箱的一些属性</span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 表示SMTP发送邮件，必须进行身份验证</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mail.smtp.auth"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//此处填写SMTP服务器</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mail.smtp.host"</span><span class="token punctuation">,</span> <span class="token string">"smtp.qq.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//端口号，QQ邮箱端口587</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mail.smtp.port"</span><span class="token punctuation">,</span> <span class="token string">"587"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 此处填写，写信人的账号</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mail.user"</span><span class="token punctuation">,</span> <span class="token string">"1272633570@qq.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 此处填写16位STMP口令</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"mail.password"</span><span class="token punctuation">,</span> <span class="token string">"bqmqocdniybljfbb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构建授权信息，用于进行SMTP进行身份验证</span>
        <span class="token class-name">Authenticator</span> authenticator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Authenticator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">protected</span> <span class="token class-name">PasswordAuthentication</span> <span class="token function">getPasswordAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 用户名、密码</span>
                <span class="token class-name">String</span> userName <span class="token operator">=</span> props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"mail.user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> password <span class="token operator">=</span> props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"mail.password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PasswordAuthentication</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 使用环境属性和授权信息，创建邮件会话</span>
        <span class="token class-name">Session</span> mailSession <span class="token operator">=</span> <span class="token class-name">Session</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> authenticator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建邮件消息</span>
        <span class="token class-name">MimeMessage</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeMessage</span><span class="token punctuation">(</span>mailSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置发件人</span>
        <span class="token class-name">InternetAddress</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternetAddress</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"mail.user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置收件人的邮箱</span>
        <span class="token class-name">InternetAddress</span> <span class="token keyword">to</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternetAddress</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span><span class="token function">setRecipient</span><span class="token punctuation">(</span><span class="token class-name">RecipientType</span><span class="token punctuation">.</span>TO<span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置邮件标题</span>
        message<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">"ZL邮件测试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置邮件的内容体</span>
        message<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token string">"尊敬的用户:你好!\n注册验证码为:"</span> <span class="token operator">+</span> code <span class="token operator">+</span> <span class="token string">"(有效期为一分钟,请勿告知他人)"</span><span class="token punctuation">,</span> <span class="token string">"text/html;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 最后当然就是发送邮件啦</span>
        <span class="token class-name">Transport</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *  生成验证码
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">achieveCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//由于数字 1 、 0 和字母 O 、l 有时分不清楚，所以，没有数字 1 、 0</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> beforeShuffle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token string">"9"</span><span class="token punctuation">,</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token string">"E"</span><span class="token punctuation">,</span> <span class="token string">"F"</span><span class="token punctuation">,</span>
                <span class="token string">"G"</span><span class="token punctuation">,</span> <span class="token string">"H"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">,</span> <span class="token string">"J"</span><span class="token punctuation">,</span> <span class="token string">"K"</span><span class="token punctuation">,</span> <span class="token string">"L"</span><span class="token punctuation">,</span> <span class="token string">"M"</span><span class="token punctuation">,</span> <span class="token string">"N"</span><span class="token punctuation">,</span> <span class="token string">"O"</span><span class="token punctuation">,</span> <span class="token string">"P"</span><span class="token punctuation">,</span> <span class="token string">"Q"</span><span class="token punctuation">,</span> <span class="token string">"R"</span><span class="token punctuation">,</span> <span class="token string">"S"</span><span class="token punctuation">,</span> <span class="token string">"T"</span><span class="token punctuation">,</span> <span class="token string">"U"</span><span class="token punctuation">,</span> <span class="token string">"V"</span><span class="token punctuation">,</span> <span class="token string">"W"</span><span class="token punctuation">,</span> <span class="token string">"X"</span><span class="token punctuation">,</span> <span class="token string">"Y"</span><span class="token punctuation">,</span> <span class="token string">"Z"</span><span class="token punctuation">,</span> <span class="token string">"a"</span><span class="token punctuation">,</span>
                <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"i"</span><span class="token punctuation">,</span> <span class="token string">"j"</span><span class="token punctuation">,</span> <span class="token string">"k"</span><span class="token punctuation">,</span> <span class="token string">"l"</span><span class="token punctuation">,</span> <span class="token string">"m"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"o"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"q"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"t"</span><span class="token punctuation">,</span> <span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"v"</span><span class="token punctuation">,</span>
                <span class="token string">"w"</span><span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">,</span> <span class="token string">"y"</span><span class="token punctuation">,</span> <span class="token string">"z"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>beforeShuffle<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将数组转换为集合</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">shuffle</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//打乱集合顺序</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将集合转化为字符串</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<ol start="3"><li>测试成功了,可以发送邮件了</li></ol> 
<h2><a id="7__3379"></a>7. 实现找回密码</h2> 
<ul><li> <p>邮箱验证码：/api/checkcode/phone?param1=电子邮箱地址</p> </li><li> <p>找回密码：/api/auth/findpassword</p> </li><li> <p>执行流程</p> 
  <ol><li>校验验证码，不一致则抛异常</li><li>判断两次密码是否一致，不一致则抛异常</li><li>根据邮箱查询用户</li><li>如果找到用户，更新其密码</li></ol> </li></ul> 
<p>下面是具体步骤:</p> 
<ol><li>在Controller层中添加对应的接口</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"发送邮箱验证码"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"发送邮箱验证码"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/phone"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendEMail</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"param1"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> email<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>定义<code>FindPswDto</code>类，用于接收找回密码的参数信息</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FindPswDto</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token class-name">String</span> cellphone<span class="token punctuation">;</span>
 
    <span class="token class-name">String</span> email<span class="token punctuation">;</span>
 
    <span class="token class-name">String</span> checkcodekey<span class="token punctuation">;</span>
 
    <span class="token class-name">String</span> checkcode<span class="token punctuation">;</span>
 
    <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token class-name">String</span> confirmpwd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 注意: 找回密码在auth模块下</p> 
<ol start="3"><li>service层需要修改<code>service层</code>和添加<code>VerifyService</code></li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SendCodeService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 向目标邮箱发送验证码
     * @param email 目标邮箱
     * @param code  我们发送的验证码
     */</span>
    <span class="token keyword">void</span> <span class="token function">sendEMail</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">VerifyService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">void</span> <span class="token function">findPassword</span><span class="token punctuation">(</span><span class="token class-name">FindPswDto</span> findPswDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li> <p>实现service</p> <p><code>SendCodeServiceImpl</code>:</p> </li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendCodeServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">SendCodeService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> CODE_TTL <span class="token operator">=</span> <span class="token number">120L</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendEMail</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1. 向用户发送验证码</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">MailUtil</span><span class="token punctuation">.</span><span class="token function">sendTestMail</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MessagingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"邮件发送失败：{}"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"发送验证码失败，请稍后再试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2. 将验证码缓存到redis，TTL设置为2分钟</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> code<span class="token punctuation">,</span> CODE_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ <mark>注意要事先在auth工程中导入redis的依赖</mark></p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--redis依赖--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--common-pool--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>​ <code>VerifyServiceImpl</code></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VerifyServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">VerifyService</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findPassword</span><span class="token punctuation">(</span><span class="token class-name">FindPswDto</span> findPswDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> email <span class="token operator">=</span> findPswDto<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> checkcode <span class="token operator">=</span> findPswDto<span class="token punctuation">.</span><span class="token function">getCheckcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> verify <span class="token operator">=</span> <span class="token function">verify</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> checkcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>verify<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"验证码输入错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> findPswDto<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> confirmpwd <span class="token operator">=</span> findPswDto<span class="token punctuation">.</span><span class="token function">getConfirmpwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>password<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>confirmpwd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"两次输入的密码不一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getEmail</span><span class="token punctuation">,</span> findPswDto<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XcUser</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"用户不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li> <p>完善Controller层</p> <p>在<code>LoginController</code>中添加<code>sendEMail()</code></p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">SendCodeService</span> sendCodeService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"发送邮箱验证码"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"发送邮箱验证码"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/phone"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendEMail</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"param1"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> email<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">MailUtil</span><span class="token punctuation">.</span><span class="token function">achieveCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sendCodeService<span class="token punctuation">.</span><span class="token function">sendEMail</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<p>​ 在<code>CheckCodeController</code>中添加<code>findPassword()</code></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"找回密码"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"找回密码"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/findpassword"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findPassword</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">FindPswDto</span> findPswDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    verifyService<span class="token punctuation">.</span><span class="token function">findPassword</span><span class="token punctuation">(</span>findPswDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="6"><li>测试成功</li></ol> 
<h2><a id="8__3551"></a>8. 实现用户注册</h2> 
<p>接口</p> 
<ul><li>邮箱验证码：/api/checkcode/phone?param1=邮箱</li><li>注册：/api/auth/register</li></ul> 
<p>请求:</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
<span class="token string-property property">"cellphone"</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
<span class="token string-property property">"username"</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
<span class="token string-property property">"email"</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
<span class="token string-property property">"nickname"</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
<span class="token string-property property">"password"</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
<span class="token string-property property">"confirmpwd"</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
<span class="token string-property property">"checkcodekey"</span><span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">,</span>
<span class="token string-property property">"checkcode"</span><span class="token operator">:</span><span class="token string">''</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>执行流程 
  <ol><li>校验验证码，不一致，抛异常</li><li>校验两次密码是否一致，不一致，抛异常</li><li>校验用户是否存在，已存在，抛异常</li><li>向用户表、用户关系角色表添加数据，角色为学生</li></ol> </li></ul> 
<p>下面是具体步骤:</p> 
<ol><li>准备一个Dto类，接收注册请求的参数</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterDto</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> cellphone<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> checkcode<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> checkcodekey<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> confirmpwd<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> nickname<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>在<code>LoginController</code>中添加接口</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"注册"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"注册"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">RegisterDto</span> registerDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
<span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>Service层</li></ol> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">RegisterDto</span> registerDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="4"><li>实现Service</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">RegisterDto</span> registerDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> email <span class="token operator">=</span> registerDto<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> checkcode <span class="token operator">=</span> registerDto<span class="token punctuation">.</span><span class="token function">getCheckcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Boolean</span> verify <span class="token operator">=</span> <span class="token function">verify</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> checkcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>verify<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"验证码输入错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> password <span class="token operator">=</span> registerDto<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> confirmpwd <span class="token operator">=</span> registerDto<span class="token punctuation">.</span><span class="token function">getConfirmpwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>password<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>confirmpwd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"两次输入的密码不一致"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XcUser</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">XcUser</span><span class="token operator">::</span><span class="token function">getEmail</span><span class="token punctuation">,</span> registerDto<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">XcUser</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"用户已存在，一个邮箱只能注册一个账号"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">XcUser</span> xcUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>registerDto<span class="token punctuation">,</span> xcUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setUtype</span><span class="token punctuation">(</span><span class="token string">"101001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 学生类型</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>registerDto<span class="token punctuation">.</span><span class="token function">getNickname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUser<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> insert <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>insert <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"新增用户信息失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">XcUserRole</span> xcUserRole <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XcUserRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setRoleId</span><span class="token punctuation">(</span><span class="token string">"17"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xcUserRole<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> insert1 <span class="token operator">=</span> xcUserRoleMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>xcUserRole<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>insert1 <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"新增用户角色信息失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>完善Controller</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"注册"</span><span class="token punctuation">,</span> tags <span class="token operator">=</span> <span class="token string">"注册"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">RegisterDto</span> registerDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    verifyService<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>registerDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="6"><li>完成用户注册</li></ol> 
<h2><a id="9_Redis_3686"></a>9. Redis实现验证码业务</h2> 
<p>​ 在认证时一般都需要输入验证码，验证码有什么用？</p> 
<p>​ 验证码可以防止恶性攻击，比如：XSS跨站脚本攻击、CSRF跨站请求伪造攻击，一些比较复杂的图形验证码可以有效的防止恶性攻击。</p> 
<p>​ 为了保护系统的安全在一些比较重要的操作都需要验证码。</p> 
<p>​ 验证码的类型也有很多：图片、语音、手机短信验证码等。</p> 
<p><img src="https://images2.imgbox.com/b9/6e/AB8DbZhl_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-uMqSgNFA-1682427813467)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425134542510.png)]"></p> 
<p>下面导入黑马的验证码模块:</p> 
<p><img src="https://images2.imgbox.com/72/e0/8fQhHSGq_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-P6ub735t-1682427813467)(C:/Users/%E9%9A%8F%E5%90%9B/AppData/Roaming/Typora/typora-user-images/image-20230425134759035.png)]"></p> 
<ol><li>定义nacos配置文件</li></ol> 
<pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">context-path</span><span class="token punctuation">:</span> /checkcode
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">63075</span>

</code></pre> 
<ol start="2"><li>配置<code>redis-dev.yaml</code></li></ol> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.101.65
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">20</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>
    <span class="token comment">#redisson:</span>
      <span class="token comment">#配置文件目录</span>
      <span class="token comment">#config: classpath:singleServerConfig.yaml</span>

</code></pre> 
<ol start="3"><li>新增网关的nacos配置</li></ol> 
<pre><code class="prism language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> auth<span class="token punctuation">-</span>service
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//auth<span class="token punctuation">-</span>service
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/auth/<span class="token important">**</span>
<span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> checkcode
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//checkcode
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Path=/checkcode/<span class="token important">**</span>
</code></pre> 
<ol start="4"><li>验证码模块的bootstrap.yaml</li></ol> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> checkcode
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.101.65<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.profiles.active<span class="token punctuation">}</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.profiles.active<span class="token punctuation">}</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>project
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        <span class="token key atrule">refresh-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> swagger<span class="token punctuation">-</span>$<span class="token punctuation">{<!-- --></span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> logging<span class="token punctuation">-</span>$<span class="token punctuation">{<!-- --></span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>$<span class="token punctuation">{<!-- --></span>spring.profiles.active<span class="token punctuation">}</span>.yaml
            <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
            <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
</code></pre> 
<ol start="5"><li>在验证码模块中引入redis的依赖</li></ol> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--redis依赖--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--common-pool--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ol start="6"><li> <p>Kaptcha图片验证码配置类</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KaptchaConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//图片验证码生成器，使用开源的kaptcha</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DefaultKaptcha</span> <span class="token function">producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"kaptcha.border"</span><span class="token punctuation">,</span> <span class="token string">"no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.font.color"</span><span class="token punctuation">,</span> <span class="token string">"black"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.char.space"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.char.length"</span><span class="token punctuation">,</span><span class="token string">"4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"kaptcha.image.height"</span><span class="token punctuation">,</span><span class="token string">"34"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"kaptcha.image.width"</span><span class="token punctuation">,</span><span class="token string">"138"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"kaptcha.textproducer.font.size"</span><span class="token punctuation">,</span><span class="token string">"25"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"kaptcha.noise.impl"</span><span class="token punctuation">,</span><span class="token string">"com.google.code.kaptcha.impl.NoNoise"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DefaultKaptcha</span> defaultKaptcha <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultKaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        defaultKaptcha<span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> defaultKaptcha<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> </li><li> <p>创建一个DTO来保存验证码信息</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheckCodeResultDto</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * key用于验证
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 混淆后的内容
     * 举例：
     * 1.图片验证码为:图片base64编码
     * 2.短信验证码为:null
     * 3.邮件验证码为: null
     * 4.邮件链接点击验证为：null
     * ...
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> aliasing<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>创建一个验证码接口</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractCheckCodeService</span> <span class="token keyword">implements</span> <span class="token class-name">CheckCodeService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">protected</span> <span class="token class-name">CheckCodeGenerator</span> checkCodeGenerator<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token class-name">KeyGenerator</span> keyGenerator<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token class-name">CheckCodeStore</span> checkCodeStore<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span>  <span class="token function">setCheckCodeGenerator</span><span class="token punctuation">(</span><span class="token class-name">CheckCodeGenerator</span> checkCodeGenerator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span>  <span class="token function">setKeyGenerator</span><span class="token punctuation">(</span><span class="token class-name">KeyGenerator</span> keyGenerator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span>  <span class="token function">setCheckCodeStore</span><span class="token punctuation">(</span><span class="token class-name">CheckCodeStore</span> <span class="token class-name">CheckCodeStore</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * @description 生成验证公用方法
     * @param checkCodeParamsDto 生成验证码参数
     * @param code_length 验证码长度
     * @param keyPrefix key的前缀
     * @param expire 过期时间
     * @return com.xuecheng.checkcode.service.AbstractCheckCodeService.GenerateResult 生成结果
     * @author Mr.M
     * @date 2022/9/30 6:07
    */</span>
    <span class="token keyword">public</span> <span class="token class-name">GenerateResult</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">CheckCodeParamsDto</span> checkCodeParamsDto<span class="token punctuation">,</span><span class="token class-name">Integer</span> code_length<span class="token punctuation">,</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span><span class="token class-name">Integer</span> expire<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//生成四位验证码</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> checkCodeGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>code_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"生成验证码:{}"</span><span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//生成一个key</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> keyGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>keyPrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//存储验证码</span>
        checkCodeStore<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>code<span class="token punctuation">,</span>expire<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回验证码生成结果</span>
        <span class="token class-name">GenerateResult</span> generateResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenerateResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        generateResult<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        generateResult<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> generateResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">protected</span> <span class="token keyword">class</span> <span class="token class-name">GenerateResult</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> key<span class="token punctuation">;</span>
        <span class="token class-name">String</span> code<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">CheckCodeResultDto</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">CheckCodeParamsDto</span> checkCodeParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> code_l <span class="token operator">=</span> checkCodeStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>code_l <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> code_l<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//删除验证码</span>
            checkCodeStore<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> </li><li> <p>创建一个数字生成器</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"NumberLetterCheckCodeGenerator"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NumberLetterCheckCodeGenerator</span> <span class="token keyword">implements</span> <span class="token class-name">CheckCodeService<span class="token punctuation">.</span>CheckCodeGenerator</span> <span class="token punctuation">{<!-- --></span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> str<span class="token operator">=</span><span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"</span><span class="token punctuation">;</span>
        <span class="token class-name">Random</span> random<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StringBuffer</span> sb<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> number<span class="token operator">=</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> </li><li> <p>创建一个图片验证码生成器</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">"PicCheckCodeService"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PicCheckCodeServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractCheckCodeService</span> <span class="token keyword">implements</span> <span class="token class-name">CheckCodeService</span> <span class="token punctuation">{<!-- --></span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DefaultKaptcha</span> kaptcha<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"NumberLetterCheckCodeGenerator"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCheckCodeGenerator</span><span class="token punctuation">(</span><span class="token class-name">CheckCodeGenerator</span> checkCodeGenerator<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>checkCodeGenerator <span class="token operator">=</span> checkCodeGenerator<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"UUIDKeyGenerator"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setKeyGenerator</span><span class="token punctuation">(</span><span class="token class-name">KeyGenerator</span> keyGenerator<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>keyGenerator <span class="token operator">=</span> keyGenerator<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"MemoryCheckCodeStore"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCheckCodeStore</span><span class="token punctuation">(</span><span class="token class-name">CheckCodeStore</span> checkCodeStore<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>checkCodeStore <span class="token operator">=</span> checkCodeStore<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">CheckCodeResultDto</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">CheckCodeParamsDto</span> checkCodeParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">GenerateResult</span> generate <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>checkCodeParamsDto<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"checkcode:"</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> generate<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> generate<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> pic <span class="token operator">=</span> <span class="token function">createPic</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CheckCodeResultDto</span> checkCodeResultDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckCodeResultDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkCodeResultDto<span class="token punctuation">.</span><span class="token function">setAliasing</span><span class="token punctuation">(</span>pic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        checkCodeResultDto<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> checkCodeResultDto<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">createPic</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 生成图片验证码</span>
        <span class="token class-name">ByteArrayOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">BufferedImage</span> image <span class="token operator">=</span> kaptcha<span class="token punctuation">.</span><span class="token function">createImage</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>

        outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> imgBase64Encoder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 对字节数组Base64编码</span>
            <span class="token comment">//BASE64Encoder base64Encoder = new BASE64Encoder();</span>
            <span class="token class-name">ImageIO</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token string">"png"</span><span class="token punctuation">,</span> outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            imgBase64Encoder <span class="token operator">=</span> <span class="token string">"data:image/png;base64,"</span> <span class="token operator">+</span> <span class="token class-name">EncryptUtil</span><span class="token punctuation">.</span><span class="token function">encodeBase64</span><span class="token punctuation">(</span>outputStream<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> imgBase64Encoder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> </li><li> <p>在验证码模块中(xuecheng-plus-checkcod),<code>CheckCodeService</code>是验证码接口，其内部还有一个<code>CheckCodeStore</code>接口，<code>CheckCodeStore</code>接口是负责存储验证码的</p> </li></ol> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CheckCodeService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * @param checkCodeParamsDto 生成验证码参数
     * @return com.xuecheng.checkcode.model.CheckCodeResultDto 验证码结果
     * @description 生成验证码
     * @author Mr.M
     * @date 2022/9/29 18:21
     */</span>
    <span class="token class-name">CheckCodeResultDto</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">CheckCodeParamsDto</span> checkCodeParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @param key
     * @param code
     * @return boolean
     * @description 校验验证码
     * @author Mr.M
     * @date 2022/9/29 18:46
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * @author Mr.M
     * @description 验证码生成器
     * @date 2022/9/29 16:34
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CheckCodeGenerator</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * 验证码生成
         *
         * @return 验证码
         */</span>
        <span class="token class-name">String</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @author Mr.M
     * @description key生成器
     * @date 2022/9/29 16:34
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">KeyGenerator</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">/**
         * key生成
         *
         * @return 验证码
         */</span>
        <span class="token class-name">String</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">String</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * @author Mr.M
     * @description 验证码存储
     * @date 2022/9/29 16:34
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CheckCodeStore</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">/**
         * @param key    key
         * @param value  value
         * @param expire 过期时间,单位秒
         * @return void
         * @description 向缓存设置key
         * @author Mr.M
         * @date 2022/9/29 17:15
         */</span>
        <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">Integer</span> expire<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="7"><li>它的实现类为<code>MemoryCheckCodeStore</code>，现在我们只需要修改这个类，改为用Redis缓存验证码即可</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"MemoryCheckCodeStore"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MemoryCheckCodeStore</span> <span class="token keyword">implements</span> <span class="token class-name">CheckCodeService<span class="token punctuation">.</span>CheckCodeStore</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 注入StringRedisTemplate</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">Integer</span> expire<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> expire<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>验证码服务测试:</p> 
<ol><li>Controller中<code>generatePicCheckCode</code>方法，是用来<mark>生成验证码图片</mark>的</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">"生成验证信息"</span><span class="token punctuation">,</span> notes<span class="token operator">=</span><span class="token string">"生成验证信息"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/pic"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">CheckCodeResultDto</span> <span class="token function">generatePicCheckCode</span><span class="token punctuation">(</span><span class="token class-name">CheckCodeParamsDto</span> checkCodeParamsDto<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> picCheckCodeService<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>checkCodeParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>我们使用HttpClient测试该接口</li></ol> 
<pre><code>### 获取验证码图片
POST localhost:53075/checkcode/pic
</code></pre> 
<ol start="3"><li>响应结果如下，图片是以base64编码格式存储的，我们可以复制直接在浏览器中打开</li></ol> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"key"</span><span class="token operator">:</span> <span class="token string">"checkcode:20a2ccb511bc472ea785db14d0a547ba"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"aliasing"</span><span class="token operator">:</span> <span class="token string">"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIoAAAAiCAIAAAAPqtawAAAL9UlEQVR42t2aeVRV1xXGH86CgsNyFgccEJazqDjgPOKEshwAxVlUQMWFOE8FWTiLIi6cWSqi4ISCOKA2U5s0HZI2aZqGpk3TNDGmbdqkSeuw+lvneJ7Pd++77z4ID+33x1v33eEM+zt7f3vfeyz3FH6s8IrAqwKvKbwu8IbATwR+qvCmwFsCP1N4W+DnAr8Q+KXCrxTeEXhX4NcCv1F4T+B9gd8qfCDwO4EPBX6v8JFAqcAfFD4W+KPCnwQ+EfizwqcCfxH4TOCvCp8LfCFwX+FLgQcCXwn8TeHvCv8Q+FrgnwL/UvhG4FuBfyt8J/C9wH8E/qtgsaPnFQVbel5X0NLzpoItPW8rGNDzjoKWnvcUbOn5QEFLz0cKtvR8rGDLjR09nypo6flcwZaeLxW09Nhxo0vPNwq29HynoKXn4cOH+vS8qqB1HV163lLQuo4xPe8qaOl5X0HrOrr0lCoY0POJgtZ1dOn5QkHrOsb0fK1gkp7vFVygxyCy6dJjENms9BhENvP0fKjwA9LzmYJJer5ScBrZ7Oj5VsFRZNOh5/9VeHiEO19S4bGn5+UVHu7kqqSHrmlH0sNtXH1JhUefHrcJz+nTp7k/JyeH2+iuzMLDL61ZHYimOObMjBkzJk+eTKdlEx5dehgbtzEFrla08BjR46rw6NJjJzy29HAcEBCwaNGinj17Hjp0iAO4uXHjhqvCs3jxYshITU0dOnQo4zxz5syaNWsiIiKWLl169OjRffv2FRQU4JrlFx4eZHYxMTEJCQnDhg1zSk/5hecpPe4XHp5KSUnp2rWrt7d3jRo1OnTowEFUVNSIESPy8vLu3r2LlR0JD4A/iKEvxlxYWJifn4+jZGRkwHS1atXatGnDr6+v7+jRoyEJyhleeYSH27KyslauXNmkSZMqVao0bNgQkjIzMytaeJ6jx53Ck5ubi7ts2bKlefPmXl5e9evXx6AeHh5169YNCgpq27bt3Llzd+zYQQta4eGAk9nZ2aGhodeuXRs0aNDYsWOZBb5CC/jQpEmTaNDHx6dv376xsbGMyqnwQDYSiG4xSMkNJFm9B+Pgo56enrRvsVhCQkLghpbNC48uPQbC45Ae9wjPpUuXsGxJScm2bduSkpIgIzg4uEWLFtWrV69atSomGDBgQLt27WbPns1ItMJz7NixefPm0VFcXJy/vz+/y5cv79+/P/63detWfAhTduzYMTIyEpeiO0f0yIyuuLj4RwIHDx5kTZw9e/bWrVu4r+QGnrghPj6+igBjW7hwIa7PyE0KD5eYNVM+efIkrmxeeFyj5wcUHmvORms8e/v27RMnTqSnp2Prli1b4knNmjUjRiUnJxO4GICt8DBUFIW04siRI/hHYmLiDIG9e/dCEvEHgrEj9CBIDMM4L+CejRs30g6MoiiBgYG7d+++cuUKc5H0HD58+Pz58xAvm4Ue/B55KyoqMik8WHjixIk1a9bkWVaAeeF59OiR5QWpeLA10+jVq1d0dPS0adMITUQtvITz0oGs9OB28tlVq1Zx8/Tp03fu3Im9Vq9ejUvhOkS28PBw0g16J7c2rngGDhyI9fnFdp06dWrQoMH8+fPpAmK4H+Eh9yNsjhkzhhVTu3ZtbmNgOCUtO6WHTA+ThoWF1alTxyIAqeaF5xk9lV7xHD9+HMfHdeAGtW/UqNHNmzeXLVt2584drupWPMRG7IjtyNwIhrjLhg0bEHAOiDz0ZeZVG0EMmpFAPANpQfnwWqawa9cuuoMeYixtEjlxUMjjNn6xiV3apis8DB524UaKFmAu5oXHnp7KetXGNCADbgggRDb6YkrMBJ0nSTOoeOCGAzIFMjQIRrpIE1asWEEyjc4b0wM3w4cP5y9PkU2QQGJEXJDEhEscSO8ZPHgwiWW/fv0Qp9atW0tD41vGwgMYLaQS0/A5Kz2cNy88LtBTEcIjueFxVv2BAweYAzPBEOgQ6kJiTbgzftVGd9xGWnXhwgWcj5R31KhRDI9LTl+10SAhi2GQLpIR+Pn51apVi8e7dOnCCCEbDiAeepo2bUqWOHPmzCFDhmBiPNug4uEXdkkuCNRQTuMEN8lN48aNXRIefXrcLDyEspEjR5JkEzewEVKMfnKP01dtuBfDg5UePXoQzXA1eCotLaVfk994aJOsBFZIDXA7/IbAxe+mTZu4yp0I2KxZsyZMmDB+/Hhu4AArw5+jioczdMoUIJ7pQOSSJUvOnTsn6aHOc0l4ntJTucJDutm5c2fWJkkXEk2zly9fNvmqDYZOnTrF2kc8MDFyTePG9NgKD0Mi34MPGMJrSfzwD9Y7sY6rEI8QEipJ7fAAitxx48ZhZRI8O3okN6Tg8k1Vt27doJk6gSyDaZIHSnooul0SnufocVV4dOkpg/CQyLLKIAYlIA1z6VUbRJKt7d+/H+Nu376dYEgvZj7ByWqUzBALUnVhuz59+uArHLPqoYe5kA0SoEhPyB5jYmJIjmWCN3XqVF3XwVzr168nryOmkQQmJCRgIkpR4qSkh9m5JDxm6akg4eGX7lB10oH27dtThKalpZl81UbKQIObN29GruvVqzdlyhQGJt9Sc0k6kNM3oYRE2KWShRJauH79+pw5c8gUOEkVSYDCAxgVi4BEDuOSI2DlBQsW6NKTmZnJLPBjghjZIAsIiYKePXv2SHqIvS4Jjw49bhYeGaZbtWpFVcHSo0eT33hoh5FjU8IRYYf4JumhFxqHITPfeNAYnCMpKYmMkQMmhdIwEtI2ailKKPIuCKPNq1evEn69vLwIg9xPg1p6aM1DAFLXrVv34MED+S6HNSTpoVmX6Hn8+LGlcoWHcE9cwijdu3cnfzP5jYe/tED1zlKFXWKULF0pYhAMykwEOTc31+mrNsombI3mYztiEbNjPESwyMhIqhx/f39oY9HQCCJHfOO2wMBAzE13dsLDAeWRx/MIDg6Oi4sj8ZH0EBXxV5JMk8LjhJ4KFR6apTWIoaIkdGBlYj3N6uZsdvQgEiTi0ENkIyOA19TUVByRWicnJwcx5yp6DlsGwsMYOE9oRflwC+zIlCGVdIAMmHyBNB0HolnOcz/dYWJ8aO3atbSsTanxZkTLQw8WG+CXJoXnGT3uFx4a4REWqa+vL1k1K4vgwOOcNBAe+SwLmfju4+ODXCO8yAPtENkxhKenJ7GOXBbKs7OzCXGO6KFTrEzsImMkYyYpuHjxIndygJhRFyNCiYmJ+GJRURFhkyQC4zJIPCwrK8tRQYre4M3wRBjUcgPS09NNCo89Pe4UHvmLdShFKf0IMlSj8mupgfDQNQscn+vduzfJa0REBLGRiIERZW4dHh5OUCJ9IrCQ0Unv0RUeUmqopSlMWVBQAMEQhv8xJMZDRKJ9skryAuihEc4T63BxvJPuzHyCKykpIZ8ki5PEBAUFEQCZtUnh0afHbcJDaU3RQ3hh+XPgVHjoi5bR8ICAAG9v7+jo6KioKJhgRRMhsa/8DhQfH49ZMX1eXh4Bh8cdbS6APOiBDIpTDnAL1gfhC++EKiIn7citCvfv34cVBJKSubi4mMGY/MbDX5m4g4yMDPMVjxN63FDx0AL3yx51937YCU9hYSF2ZNWHhIT4C1CTwhCZElSRDlBwYGvKQMIUZzAlXfOgo80FrAyUH0ekkdjYWJYIN0B2SkoKbBF1qTGtu9oYhvUDtvnNBZyUUdEa1swLz1N6KuVVW9l2tZ0VoJIgv8Ky8gMajTBCIom1IMVp0BVmYby5gKhFWCOo+vn5JScny1wcC6BbZGjwjQXotDy72vhLO5IemnVKj63wPEfPS7GrDWKYLckPwyaOk25RALL8qSgdbTo02FzAydLSUu7BXRAqxsl4iGMMkmnSNZfkzqky0wNYT2FhYaGhofn5+eYrHn16DIRHl55y7mrTpcdRxSP/EoLS0tJwDrmr7d69e3YbQp2+atPu/WCozEVuxXK6q834G085NxfY0vPkyRNLZQmP002H2opHnseIDIxmy7Db3dVdbe7cTq1Pz0skPC/ydmpdegx2tZkRnmf0uFl4dOkxEB5deuy2U7sqPLr0GGynLvOmQ4NvPMbCY0/Piyw8jugpv/C4tJ3ancID/geQCXNUYmEBQwAAAABJRU5ErkJggg=="</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>Controller中<code>verify</code>方法,是用来<mark>校验验证码</mark>的</li></ol> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/verify"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Boolean</span> isSuccess <span class="token operator">=</span> picCheckCodeService<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> isSuccess<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>我们同样使用HttpClient进行测试</li></ol> 
<pre><code>### 校验验证码
POST localhost:53075/checkcode/verisfy?key=checkcode:c3dce1413f95414e943dcf0a97983fe8&amp;code=HZCG
</code></pre> 
<p>此时,Controller完整代码如下:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"验证码服务接口"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheckCodeController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">SendCodeService</span> sendCodeService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"PicCheckCodeService"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">CheckCodeService</span> picCheckCodeService<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"生成验证信息"</span><span class="token punctuation">,</span> notes <span class="token operator">=</span> <span class="token string">"生成验证信息"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/pic"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CheckCodeResultDto</span> <span class="token function">generatePicCheckCode</span><span class="token punctuation">(</span><span class="token class-name">CheckCodeParamsDto</span> checkCodeParamsDto<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> picCheckCodeService<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>checkCodeParamsDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"校验"</span><span class="token punctuation">,</span> notes <span class="token operator">=</span> <span class="token string">"校验"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ApiImplicitParams</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"name"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"业务名称"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"String"</span><span class="token punctuation">,</span> paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"key"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"验证key"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"String"</span><span class="token punctuation">,</span> paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@ApiImplicitParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"code"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"验证码"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">"String"</span><span class="token punctuation">,</span> paramType <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/verify"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Boolean</span> isSuccess <span class="token operator">=</span> picCheckCodeService<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> isSuccess<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>最后附上自己码云<a href="https://gitee.com/katongZL/xuecheng-plus-project.git" rel="nofollow">黑马学成在线-Plus</a>项目地址</p> 
<p>注:当时参照大佬 <a href="https://github.com/Cyborg2077/xuecheng-plus">Kele</a> 的项目以及文章</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6e7ee28cd393a546527bc5f6a8a64aed/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">华为ensp基础命令的学习（1）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ef0d2078b64a2d73b369aafac7597cba/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">DPDK和RDMA的区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>