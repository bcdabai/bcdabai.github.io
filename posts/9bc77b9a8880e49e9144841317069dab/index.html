<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>微信小程序 - 云开发轮询实现定时推送订阅消息 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="微信小程序 - 云开发轮询实现定时推送订阅消息" />
<meta property="og:description" content="前言 受众：已有小程序和云开发经验（没有的话照着流程和官方文档也应该可以实现）
关于小程序的消息推送，我了解到的有以下几种实现方式
1、模板消息，已于2020 年 1 月 10 日下线
2、通过服务端的统一服务消息下发推送，因为模板消息现已下线，现只支持公众号。统一服务消息官方文档
2、通过关注公众号通过公众号实现长期的消息推送
3、订阅消息，包含一次性订阅消息和长期订阅消息
订阅消息官方文档
关于技术实现的选择 关于小程序的消息推送的几种实现方式，先简单说一下各自的优缺点：
1、统一服务消息 优点：可以长期多次发送
缺点：因为模板消息现已下线，现只支持公众号
2、通过公众号实现 优点：可以长期多次发送
缺点：需要引导关注公众号，没有公众号还得注册一个，以下还有一些注意事项
1、公众号和小程序需要在同一个微信开放平台下，保证拿到相同的UnionID
2、如果需要在消息模板上加上小程序的入口，需要微信公众号和小程序做关联
3、小程序和公众号都必须是认证过的
4、小程序需要提前知道公众号的appid和appsecret
5、发送消息之前需要拿到用户对应于公众号的openid
3、订阅消息实现 订阅消息，包含一次性订阅消息和长期订阅消息，可惜长期订阅消息只对指定类目开放
一次性订阅消息
优点：服务端，云开发都可以实现推送
缺点：每次需要授权，每次授权同意只推送一次
哎，没什么可挑的，最终选择的是订阅消息的一次性订阅消息，下面是微信官方介绍
小程序订阅消息 功能介绍 消息能力是小程序能力中的重要组成，我们为开发者提供了订阅消息能力，以便实现服务的闭环和更优的体验。
订阅消息推送位置：服务通知订阅消息下发条件：用户自主订阅订阅消息卡片跳转能力：点击查看详情可跳转至该小程序的页面
消息类型 1. 一次性订阅消息 一次性订阅消息用于解决用户使用小程序后，后续服务环节的通知问题。用户自主订阅后，开发者可不限时间地下发一条对应的服务消息；每条消息可单独订阅或退订。
2. 长期订阅消息 一次性订阅消息可满足小程序的大部分服务场景需求，但线下公共服务领域存在一次性订阅无法满足的场景，如航班延误，需根据航班实时动态来多次发送消息提醒。为便于服务，我们提供了长期性订阅消息，用户订阅一次后，开发者可长期下发多条消息。
目前长期性订阅消息仅向政务民生、医疗、交通、金融、教育等线下公共服务开放，后期将逐步支持到其他线下公共服务业务。
3. 设备订阅消息 设备订阅消息是一种特殊类型的订阅消息，它属于长期订阅消息类型，且需要完成「设备接入」才能使用。
设备订阅消息用于在设备触发某些需要人工介入的事件时（例如设备发生故障、设备耗材不足等），向用户发送消息通知。详见设备订阅消息文档。
使用说明 步骤一：获取模板 ID 在微信公众平台手动配置获取模板 ID：
登录 https://mp.weixin.qq.com 获取模板，如果没有合适的模板，可以申请添加新模板，审核通过后可使用。
步骤二：获取下发权限 一次性订阅消息、长期订阅消息，详见接口 wx.requestSubscribeMessage
设备订阅消息，详见接口 wx.requestSubscribeDeviceMessage
步骤三：调用接口下发订阅消息 一次性订阅消息、长期订阅消息，详见服务端接口 subscribeMessage.send
设备订阅消息，详见服务端接口 hardwareDevice.send
注意事项 用户勾选 “总是保持以上选择，不再询问” 之后，下次订阅调用 wx." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9bc77b9a8880e49e9144841317069dab/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-16T09:17:18+08:00" />
<meta property="article:modified_time" content="2022-05-16T09:17:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">微信小程序 - 云开发轮询实现定时推送订阅消息</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<blockquote> 
 <p>受众：已有小程序和云开发经验（没有的话照着流程和官方文档也应该可以实现）</p> 
</blockquote> 
<blockquote> 
 <p>关于小程序的消息推送，我了解到的有以下几种实现方式<br> 1、<s>模板消息，已于2020 年 1 月 10 日下线</s><br> 2、通过服务端的统一服务消息下发推送，<code>因为模板消息现已下线，现只支持公众号</code>。<a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/uniform-message/uniformMessage.send.html" rel="nofollow">统一服务消息官方文档</a><br> 2、通过关注公众号通过公众号实现长期的消息推送<br> 3、订阅消息，包含一次性订阅消息和长期订阅消息<br> <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html" rel="nofollow">订阅消息官方文档</a></p> 
</blockquote> 
<h2><a id="_10"></a>关于技术实现的选择</h2> 
<p>关于小程序的消息推送的几种实现方式，先简单说一下各自的优缺点：</p> 
<h3><a id="1_13"></a>1、统一服务消息</h3> 
<p>优点：可以长期多次发送<br> 缺点：因为模板消息现已下线，现只支持公众号</p> 
<h3><a id="2_16"></a>2、通过公众号实现</h3> 
<p>优点：可以长期多次发送<br> 缺点：需要引导关注公众号，没有公众号还得注册一个，以下还有一些注意事项</p> 
<blockquote> 
 <p>1、公众号和小程序需要在同一个微信开放平台下，保证拿到相同的UnionID<br> 2、如果需要在消息模板上加上小程序的入口，需要微信公众号和小程序做关联<br> 3、小程序和公众号都必须是认证过的<br> 4、小程序需要提前知道公众号的appid和appsecret<br> 5、发送消息之前需要拿到用户对应于公众号的openid</p> 
</blockquote> 
<h3><a id="3_26"></a>3、订阅消息实现</h3> 
<blockquote> 
 <p>订阅消息，包含一次性订阅消息和长期订阅消息，可惜<code>长期订阅消息只对指定类目开放</code></p> 
</blockquote> 
<p>一次性订阅消息<br> 优点：服务端，云开发都可以实现推送<br> 缺点：每次需要授权，每次授权同意只推送一次</p> 
<blockquote> 
 <p>哎，没什么可挑的，<code>最终选择的是订阅消息的一次性订阅消息</code>，下面是微信官方介绍</p> 
</blockquote> 
<h2><a id="_35"></a>小程序订阅消息</h2> 
<h3><a id="_36"></a>功能介绍</h3> 
<blockquote> 
 <p>消息能力是小程序能力中的重要组成，我们为开发者提供了订阅消息能力，以便实现服务的闭环和更优的体验。</p> 
</blockquote> 
<ul><li>订阅消息推送位置：服务通知</li><li>订阅消息下发条件：用户自主订阅</li><li>订阅消息卡片跳转能力：点击查看详情可跳转至该小程序的页面<br> <img src="https://images2.imgbox.com/09/3c/EtjyXCBs_o.png" alt="在这里插入图片描述"></li></ul> 
<h3><a id="_45"></a>消息类型</h3> 
<h4><a id="1__46"></a>1. 一次性订阅消息</h4> 
<blockquote> 
 <p>一次性订阅消息用于解决用户使用小程序后，后续服务环节的通知问题。用户自主订阅后，开发者可不限时间地下发一条对应的服务消息；每条消息可单独订阅或退订。</p> 
</blockquote> 
<h4><a id="2__49"></a>2. 长期订阅消息</h4> 
<blockquote> 
 <p>一次性订阅消息可满足小程序的大部分服务场景需求，但线下公共服务领域存在一次性订阅无法满足的场景，如航班延误，需根据航班实时动态来多次发送消息提醒。为便于服务，我们提供了长期性订阅消息，用户订阅一次后，开发者可长期下发多条消息。</p> 
</blockquote> 
<p><code>目前长期性订阅消息仅向政务民生、医疗、交通、金融、教育等线下公共服务开放，后期将逐步支持到其他线下公共服务业务。</code></p> 
<h4><a id="3__54"></a>3. 设备订阅消息</h4> 
<blockquote> 
 <p>设备订阅消息是一种特殊类型的订阅消息，它属于长期订阅消息类型，且需要完成「设备接入」才能使用。<br> 设备订阅消息用于在设备触发某些需要人工介入的事件时（例如设备发生故障、设备耗材不足等），向用户发送消息通知。详见<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/device/device-message.html" rel="nofollow">设备订阅消息文档</a>。</p> 
</blockquote> 
<h4><a id="_59"></a>使用说明</h4> 
<h5><a id="_ID_60"></a>步骤一：获取模板 ID</h5> 
<p>在微信公众平台手动配置获取模板 ID：<br> 登录 <a href="https://mp.weixin.qq.com" rel="nofollow">https://mp.weixin.qq.com</a> 获取模板，如果没有合适的模板，可以申请添加新模板，审核通过后可使用。<br> <img src="https://images2.imgbox.com/32/12/WEFVJxjK_o.png" alt="intro"></p> 
<h5><a id="_64"></a>步骤二：获取下发权限</h5> 
<p>一次性订阅消息、长期订阅消息，详见接口 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html" rel="nofollow">wx.requestSubscribeMessage</a></p> 
<p>设备订阅消息，详见接口 <a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeDeviceMessage.html" rel="nofollow">wx.requestSubscribeDeviceMessage</a></p> 
<h5><a id="_69"></a>步骤三：调用接口下发订阅消息</h5> 
<p>一次性订阅消息、长期订阅消息，详见服务端接口 <a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html" rel="nofollow">subscribeMessage.send</a></p> 
<p>设备订阅消息，详见服务端接口 <a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/hardware-device/hardwareDevice.send.html" rel="nofollow">hardwareDevice.send</a></p> 
<h5><a id="_74"></a>注意事项</h5> 
<ul><li>用户勾选 “总是保持以上选择，不再询问” 之后，下次订阅调用 wx.requestSubscribeMessage 不会弹窗，保持之前的选择，修改选择需要打开小程序设置进行修改。</li></ul> 
<h2><a id="_77"></a>实现</h2> 
<h4><a id="_78"></a>设计思路</h4> 
<blockquote> 
 <p>我这里的需求是纪念日的推送，到用户设置的纪念日当天或者前几天，需要给用户推送一条消息，提醒用户纪念日已到。因为是一次性授权，首先要考虑授权的时机，因此考虑是在用户新增或者编辑纪念日信息那里，设置一个开关，开启时判断通知权限，无权限提醒到设置页开启通知，有权限请求授权，授权成功开关开启，失败或者未开启通知权限开关关闭，最后提交信息到数据库，推送的接口会每天轮询一次，根据这个状态和是否到纪念日提醒时间判断是否进行推送，推送成功重置状态。推送之后用户再次开启推送开关可实现下一次推送，形成一个闭环。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/31/fa/pgdPTzCb_o.png" alt="请添加图片描述"></p> 
<h4><a id="_82"></a>实现流程</h4> 
<ul><li>首先要去小程序后台选择一个模板</li><li>然后在新增编辑页面实现设计的逻辑（包含通知权限的判断，请求一次性订阅，失败关闭开关状态，保存数据到数据库）</li><li>云开发轮询推送消息（先查出需要推送的数据，然后对应模板的数据格式发送推送）</li></ul> 
<h2><a id="_87"></a>具体实现</h2> 
<h4><a id="1_88"></a>1、选择模板</h4> 
<blockquote> 
 <p>登录小程序开发后台 - 订阅消息 - 公共模板库搜索选择一个合适的模板，然后在我的模板那里可以查看模板详情，<code>模板id</code>和<code>详情里的字段</code>在云开发那里需要使用</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/c8/1e/5YZQt086_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d5/25/12KGtp6R_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e0/e1/kjyXWkwg_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2_94"></a>2、编辑页代码实现</h4> 
<p>首先先把开关相关的页面和逻辑实现，这里就不细说。<br> 然后是判断通知权限和请求一次性订阅</p> 
<h5><a id="21_97"></a>2.1、判断通知权限</h5> 
<blockquote> 
 <p>判断通知权限使用的是<a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/setting/SubscriptionsSetting.html" rel="nofollow">wx.getSetting</a></p> 
</blockquote> 
<pre><code class="prism language-js">wx<span class="token punctuation">.</span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">withSubscriptions</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token function">success</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>authSetting<span class="token punctuation">)</span>
    <span class="token comment">// res.authSetting = {<!-- --></span>
    <span class="token comment">//   "scope.userInfo": true,</span>
    <span class="token comment">//   "scope.userLocation": true</span>
    <span class="token comment">// }</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>subscriptionsSetting<span class="token punctuation">)</span>
    <span class="token comment">// res.subscriptionsSetting = {<!-- --></span>
    <span class="token comment">//   mainSwitch: true, // 订阅消息总开关</span>
    <span class="token comment">//   itemSettings: {   // 每一项开关</span>
    <span class="token comment">//     SYS_MSG_TYPE_INTERACTIVE: 'accept', // 小游戏系统订阅消息</span>
    <span class="token comment">//     SYS_MSG_TYPE_RANK: 'accept'</span>
    <span class="token comment">//     zun-LzcQyW-edafCVvzPkK4de2Rllr1fFpw2A_x0oXE: 'reject', // 普通一次性订阅消息</span>
    <span class="token comment">//     ke_OZC_66gZxALLcsuI7ilCJSP2OJ2vWo2ooUPpkWrw: 'ban',</span>
    <span class="token comment">//   }</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="22_121"></a>2.2、请求一次性订阅</h5> 
<blockquote> 
 <p>请求一次性订阅使用的是<a href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html" rel="nofollow">wx.requestSubscribeMessage</a></p> 
</blockquote> 
<pre><code class="prism language-js">wx<span class="token punctuation">.</span><span class="token function">requestSubscribeMessage</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">tmplIds</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 模板id</span>
  <span class="token function">success</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="23_129"></a>2.3、把数据存储到云数据库</h5> 
<p>每个项目数据结构不一样，这里也不展开说</p> 
<h5><a id="_132"></a>核心代码</h5> 
<pre><code class="prism language-js">  <span class="token comment">// 是否提醒</span>
  <span class="token function-variable function">onSwitchChange</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">[</span><span class="token string">"dict.isPush"</span><span class="token punctuation">]</span><span class="token operator">:</span> event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">[</span><span class="token string">"dict.pushTime"</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">''</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkAndRequestSubscribeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 检查订阅消息权限，未开启提示前往开启，已开启请求订阅消息</span>
  <span class="token function">checkAndRequestSubscribeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    wx<span class="token punctuation">.</span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">withSubscriptions</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>subscriptionsSetting<span class="token punctuation">)</span>
        <span class="token comment">// 订阅消息总开关是否开启</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>subscriptionsSetting<span class="token punctuation">.</span>mainSwitch<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          that<span class="token punctuation">.</span><span class="token function">subscriptionFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          wx<span class="token punctuation">.</span><span class="token function">showModal</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'提示'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">'当前暂未开启接消息提醒，是否前往设置页开启？'</span><span class="token punctuation">,</span>
            <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>confirm<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                wx<span class="token punctuation">.</span><span class="token function">openSetting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">let</span> templateId <span class="token operator">=</span> <span class="token string">'c64Gp5-89xyD55rnDr0oBWQNphWlNm_l4MX-Sduuj2c'</span> <span class="token comment">// 模板ID</span>
          wx<span class="token punctuation">.</span><span class="token function">requestSubscribeMessage</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">tmplIds</span><span class="token operator">:</span> <span class="token punctuation">[</span>templateId<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
              <span class="token comment">// 申请订阅成功，将订阅信息调用云函数存入云开发数据</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>errMsg <span class="token operator">===</span> <span class="token string">'requestSubscribeMessage:ok'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// res[templateId]: 'accept'、'reject'、'ban'、'filter'</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">[</span>templateId<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'accept'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                  that<span class="token punctuation">.</span><span class="token function">subscriptionFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
              that<span class="token punctuation">.</span><span class="token function">subscriptionFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'订阅失败'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">'none'</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 订阅失败</span>
  <span class="token function">subscriptionFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">[</span><span class="token string">"dict.isPush"</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<h4><a id="3_201"></a>3、云开发轮询推送</h4> 
<blockquote> 
 <p>这里才是重点！！！首先在项目中选择云函数目录右键新建一个云函数，然后就需要在这个云函数中实现轮询推送的代码了，我这里建的云函数是<code>push</code></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/ba/28/q15rXDK3_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="31_205"></a>3.1、推送</h5> 
<blockquote> 
 <p>推送使用的是服务端的<a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html" rel="nofollow">subscribeMessage.send</a>方法。<br> 这里是的是云调用进行推送，这样可以使用云开发<br> <code>subscribeMessage.send</code>使用需要在云函数代码的<code>config.json</code>文件中配置 <code>subscribeMessage.send</code> API 的权限，<a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/openapi/openapi.html#usage-3" rel="nofollow">详情</a></p> 
</blockquote> 
<p>配置如下</p> 
<pre><code class="prism language-js">  <span class="token string-property property">"permissions"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"openapi"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"subscribeMessage.send"</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ca/32/9KvfdEk4_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_218"></a>请求参数</h5> 
<table><thead><tr><th>属性</th><th>类型</th><th>默认值</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td>touser</td><td>string</td><td></td><td>是</td><td>接收者（用户）的 openid</td></tr><tr><td>templateId</td><td>string</td><td></td><td>是</td><td>所需下发的订阅模板id</td></tr><tr><td>page</td><td>string</td><td></td><td>否</td><td>点击模板卡片后的跳转页面，仅限本小程序内的页面。支持带参数,（示例index?foo=bar）。该字段不填则模板无跳转。</td></tr><tr><td>data</td><td>Object</td><td></td><td>是</td><td>模板内容，格式形如 { “key1”: { “value”: any }, “key2”: { “value”: any } }</td></tr><tr><td>miniprogramState</td><td>string</td><td></td><td>否</td><td>跳转小程序类型：developer为开发版；trial为体验版；formal为正式版；默认为正式版</td></tr><tr><td>lang</td><td>string</td><td></td><td>否</td><td>进入小程序查看”的语言类型，支持zh_CN(简体中文)、en_US(英文)、zh_HK(繁体中文)、zh_TW(繁体中文)，默认为zh_CN</td></tr></tbody></table> 
<h5><a id="_228"></a>官方请求示例</h5> 
<pre><code class="prism language-js"><span class="token keyword">const</span> cloud <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'wx-server-sdk'</span><span class="token punctuation">)</span>
cloud<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">env</span><span class="token operator">:</span> cloud<span class="token punctuation">.</span><span class="token constant">DYNAMIC_CURRENT_ENV</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> cloud<span class="token punctuation">.</span>openapi<span class="token punctuation">.</span>subscribeMessage<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"touser"</span><span class="token operator">:</span> <span class="token string">'OPENID'</span><span class="token punctuation">,</span>
        <span class="token string-property property">"page"</span><span class="token operator">:</span> <span class="token string">'index'</span><span class="token punctuation">,</span>
        <span class="token string-property property">"lang"</span><span class="token operator">:</span> <span class="token string">'zh_CN'</span><span class="token punctuation">,</span>
        <span class="token string-property property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"number01"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">'339208499'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string-property property">"date01"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">'2015年01月05日'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string-property property">"site01"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">'TIT创意园'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string-property property">"site02"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">'广州市新港中路397号'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"templateId"</span><span class="token operator">:</span> <span class="token string">'TEMPLATE_ID'</span><span class="token punctuation">,</span>
        <span class="token string-property property">"miniprogramState"</span><span class="token operator">:</span> <span class="token string">'developer'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p><code>miniprogramState</code>在正式环境要换成<code>formal</code>或注释掉这行</p> 
</blockquote> 
<h5><a id="32_264"></a>3.2、轮询</h5> 
<blockquote> 
 <p>轮询使用的云开发的<a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/triggers.html" rel="nofollow">定时触发器</a></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/7d/6e/kuXsGmPa_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="_268"></a>定时触发器官方介绍</h6> 
<blockquote> 
 <p>该功能需开发者工具 1.02.1811270 及以上版本方可使用 从开发者工具 1.02.1910182 开始，新上传的定时触发器内支持使用云调用</p> 
</blockquote> 
<ul><li> <p>如果云函数需要定时 / 定期执行，也就是定时触发，我们可以使用云函数定时触发器。配置了定时触发器的云函数，会在相应时间点被自动触发，函数的返回结果不会返回给调用方。</p> </li><li> <p>在需要添加触发器的云函数目录下新建文件 <code>config.json</code>，格式如下：</p> </li></ul> 
<pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span>
  <span class="token comment">// triggers 字段是触发器数组，目前仅支持一个触发器，即数组只能填写一个，不可添加多个</span>
  <span class="token string-property property">"triggers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// name: 触发器的名字，规则见下方说明</span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"myTrigger"</span><span class="token punctuation">,</span>
      <span class="token comment">// type: 触发器类型，目前仅支持 timer (即 定时触发器)</span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"timer"</span><span class="token punctuation">,</span>
      <span class="token comment">// config: 触发器配置，在定时触发器下，config 格式为 cron 表达式，规则见下方说明</span>
      <span class="token string-property property">"config"</span><span class="token operator">:</span> <span class="token string">"0 0 2 1 * * *"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="_289"></a>官方示例</h6> 
<p>下面展示了一些 Cron 表达式和相关含义的示例：</p> 
<ul><li>*/5 * * * * * * 表示每5秒触发一次</li><li>0 0 2 1 * * * 表示在每月的1日的凌晨2点触发</li><li>0 15 10 * * MON-FRI * 表示在周一到周五每天上午10:15触发</li><li>0 0 10,14,16 * * * * 表示在每天上午10点，下午2点，4点触发</li><li>0 */30 9-17 * * * * 表示在每天上午9点到下午5点内每半小时触发</li><li>0 0 12 * * WED * 表示在每个星期三中午12点触发</li></ul> 
<blockquote> 
 <p><code>triggers</code>中的<code>config</code>字段可以控制触发的频率，具体开发测试时我使用的是50秒调用一次</p> 
</blockquote> 
<pre><code class="prism language-js"> <span class="token string-property property">"config"</span><span class="token operator">:</span> <span class="token string">"*/50 * * * * * *"</span>
</code></pre> 
<p><code>这里有个坑，如果代码实现上传并部署云函数之后，左等右等在日志中看不到日志，因为少了一个步骤，在上传并部署云函数之后，需要右键云函数上传触发器，这样才生效，想关闭可以删除触发器</code></p> 
<h5><a id="_307"></a>轮询推送完整代码</h5> 
<p>config.json</p> 
<pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"permissions"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"openapi"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"subscribeMessage.send"</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"triggers"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"myTimer"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"timer"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"config"</span><span class="token operator">:</span> <span class="token string">"0 0 8 * * * *"</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>index.js</p> 
<pre><code class="prism language-js"><span class="token comment">// 云函数入口文件</span>
<span class="token keyword">const</span> cloud <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'wx-server-sdk'</span><span class="token punctuation">)</span>

<span class="token comment">// 初始化 cloud</span>
cloud<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment">// API 调用都保持和云函数当前所在环境一致</span>
  <span class="token literal-property property">env</span><span class="token operator">:</span> cloud<span class="token punctuation">.</span><span class="token constant">DYNAMIC_CURRENT_ENV</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> db <span class="token operator">=</span> cloud<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> _ <span class="token operator">=</span> db<span class="token punctuation">.</span>command
<span class="token keyword">const</span> $ <span class="token operator">=</span> db<span class="token punctuation">.</span>command<span class="token punctuation">.</span>aggregate
<span class="token keyword">const</span> kTableName <span class="token operator">=</span> <span class="token string">'换成自己的表名'</span>

<span class="token comment">// 云函数入口函数</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 从云开发数据库中查询等待发送的消息列表</span>
    <span class="token keyword">const</span> msgArr <span class="token operator">=</span> <span class="token keyword">await</span> db
      <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span>kTableName<span class="token punctuation">)</span>
      <span class="token comment">// 查询条件，已开启推送，并且提醒时间为今天</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">A_IsPush</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">A_PushTime</span><span class="token operator">:</span> <span class="token function">timeStampToTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'{y}/{m}/{d}'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 循环消息列表</span>
    <span class="token keyword">const</span> sendPromises <span class="token operator">=</span> msgArr<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">msgData</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 发送订阅消息</span>
        <span class="token keyword">await</span> cloud<span class="token punctuation">.</span>openapi<span class="token punctuation">.</span>subscribeMessage<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">touser</span><span class="token operator">:</span> msgData<span class="token punctuation">.</span>_openid<span class="token punctuation">,</span> <span class="token comment">// 要发送用户的openid</span>
          <span class="token literal-property property">page</span><span class="token operator">:</span> <span class="token string">'pages/home/home'</span><span class="token punctuation">,</span> <span class="token comment">// 用户通过消息通知点击进入小程序的页面</span>
          <span class="token literal-property property">lang</span><span class="token operator">:</span> <span class="token string">'zh_CN'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">templateId</span><span class="token operator">:</span> <span class="token string">'c64Gp5-89xyD55rnDr0oBWQNphWlNm_l4MX-Sduuj2c'</span><span class="token punctuation">,</span> <span class="token comment">// 订阅消息模板ID</span>
          <span class="token comment">// 跳转小程序类型：developer为开发版；trial为体验版；formal为正式版；默认为正式版</span>
          <span class="token comment">// miniprogramState: 'developer',</span>
          <span class="token comment">// 要发送的数据，要和模板一致</span>
          <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 纪念日名称</span>
            <span class="token literal-property property">thing5</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token literal-property property">value</span><span class="token operator">:</span> msgData<span class="token punctuation">.</span>A_Title
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">// 纪念日时间</span>
            <span class="token literal-property property">time2</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token literal-property property">value</span><span class="token operator">:</span> msgData<span class="token punctuation">.</span>A_Time
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">// 备注</span>
            <span class="token literal-property property">thing4</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token literal-property property">value</span><span class="token operator">:</span> msgData<span class="token punctuation">.</span>A_Remarks <span class="token operator">?</span> msgData<span class="token punctuation">.</span>A_Remarks <span class="token operator">:</span> <span class="token string">'无'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 发送成功后将数据状态重置</span>
        <span class="token keyword">return</span> db
          <span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span>kTableName<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>msgData<span class="token punctuation">.</span>_id<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token literal-property property">A_IsPush</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token literal-property property">A_PushTime</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
              <span class="token literal-property property">A_NextTime</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> e
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>sendPromises<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token keyword">return</span> err
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">timeStampToTime</span><span class="token punctuation">(</span><span class="token parameter">time<span class="token punctuation">,</span> cFormat</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> format <span class="token operator">=</span> cFormat <span class="token operator">||</span> <span class="token string">'{y}-{m}-{d} {h}:{i}:{s}'</span>
  <span class="token keyword">let</span> date
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> time <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">''</span> <span class="token operator">+</span> time<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">10</span><span class="token punctuation">)</span> time <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>
    date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> formatObj <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">y</span><span class="token operator">:</span> date<span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">m</span><span class="token operator">:</span> date<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">d</span><span class="token operator">:</span> date<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">h</span><span class="token operator">:</span> date<span class="token punctuation">.</span><span class="token function">getHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">i</span><span class="token operator">:</span> date<span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">s</span><span class="token operator">:</span> date<span class="token punctuation">.</span><span class="token function">getSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">w</span><span class="token operator">:</span> date<span class="token punctuation">.</span><span class="token function">getDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> time_str <span class="token operator">=</span> format<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">{(y|m|d|h|i|s|w)+}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> formatObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'日'</span><span class="token punctuation">,</span> <span class="token string">'一'</span><span class="token punctuation">,</span> <span class="token string">'二'</span><span class="token punctuation">,</span> <span class="token string">'三'</span><span class="token punctuation">,</span> <span class="token string">'四'</span><span class="token punctuation">,</span> <span class="token string">'五'</span><span class="token punctuation">,</span> <span class="token string">'六'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>value<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> value <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      value <span class="token operator">=</span> <span class="token string">'0'</span> <span class="token operator">+</span> value
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> value <span class="token operator">||</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> time_str
<span class="token punctuation">}</span>

<span class="token comment">// 定时触发器 </span>
<span class="token comment">// https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/triggers.html</span>

<span class="token comment">// 50秒一次</span>
<span class="token comment">// "config": "*/50 * * * * * *"</span>

<span class="token comment">// 每天上午8点一次</span>
<span class="token comment">// "config": "0 0 8 * * * *"</span>
</code></pre> 
<p>package.json</p> 
<pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"push"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"description"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token string-property property">"main"</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"test"</span><span class="token operator">:</span> <span class="token string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"author"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token string-property property">"license"</span><span class="token operator">:</span> <span class="token string">"ISC"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"wx-server-sdk"</span><span class="token operator">:</span> <span class="token string">"~2.6.1"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="33_459"></a>3.3、上传并部署云函数</h5> 
<blockquote> 
 <p>所有代码实现之后，可以先把项目环境设置为开发环境，然后右键上传并部署云函数，然后上传触发器</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/c4/f7/aSZ4owW5_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>然后打开云函数控制台，选择云函数-日志，进行查看状态，如果成功并且有需要推送的数据，手机会收到推送消息，失败的话根据日志进行修改。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/70/ad/JmtMg3MN_o.png" alt="在这里插入图片描述"><br> 至此结束</p> 
<blockquote> 
 <p>最后推荐一下我的小程序，<code>我的纪念日小助手</code></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/b0/00/WmQcZ0OT_o.png" alt="请添加图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/65f0defea73c73361a1574eaead8a784/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL基础-17 事物的介绍</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/44eb744b715befa614688959ae56e616/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">该博客太监了。。</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>