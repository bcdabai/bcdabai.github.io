<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python爬虫 之 异步爬虫 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Python爬虫 之 异步爬虫" />
<meta property="og:description" content="异步爬虫 异步爬虫初识异步爬虫方式li视频源码讲解 协程异步编程什么是协程：实现携程的方法：事件循环单条时间启动多个事件启动（重要）await关键字（重要）回调函数（重要）协程中的requests—aiohttp（重要）基于协程的数据爬取 完整版！！！！！！！
完整版！！！！！！！
完整版！！！！！！！ 爬虫完整版
异步爬虫 初识异步爬虫方式 多线程，多进程（不建议）：
- 优点：可以为相关堵塞（耗时间）的操作单独开启线程和进程，堵塞程序就会实现异步执行
- 缺点：无法限制多进程或多进程线程池，进程池：
- 优点：降低系统对于线程和进程创建和销毁的频率，减小系统开销
- 缺点：池中线程和进程数量有上限 举个栗子直观地看一下线程的作用吧
import time def get_text(char): print(&#34;正在下载&#34;,char) time.sleep(2) print(&#34;成功加载&#34;,char) return char #单线程运行： #运行文本 text=[&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;] #记录开始时间 start_time=time.time() for i in text: get_text(i) #记录结束时间 end_time=time.time() print(&#34;单进程共需要时间：&#34;,end_time-start_time) #多线程运行 #导库 from multiprocessing.dummy import Pool #实例化4线程池 pool=Pool(4) start_time=time.time() text_list=pool.map(get_text#进行多线程的目标函数名，没有() ,text#传入数据的列表 ) #该函数返回值为函数return值组成的列表，顺序和传入列表相对应 end_time=time.time() print(&#34;多进程共需要时间：&#34;,end_time-start_time) print(text_list) 结果为： 正在下载 a 成功加载 a 正在下载 b 成功加载 b 正在下载 c 成功加载 c 正在下载 d 成功加载 d 单进程共需要时间：8." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/d35add4be6b916d03d951a2253b72592/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-29T16:03:43+08:00" />
<meta property="article:modified_time" content="2021-06-29T16:03:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python爬虫 之 异步爬虫</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>异步爬虫</h4> 
 <ul><li><ul><li><ul><li><a href="#_8" rel="nofollow">异步爬虫</a></li><li><ul><li><a href="#_9" rel="nofollow">初识异步爬虫方式</a></li><li><a href="#li_78" rel="nofollow">li视频源码讲解</a></li></ul> 
    </li><li><a href="#_96" rel="nofollow">协程异步编程</a></li><li><ul><li><a href="#_98" rel="nofollow">什么是协程：</a></li><li><a href="#_105" rel="nofollow">实现携程的方法：</a></li><li><a href="#_112" rel="nofollow">事件循环</a></li><li><a href="#_146" rel="nofollow">单条时间启动</a></li><li><a href="#_183" rel="nofollow">多个事件启动（重要）</a></li><li><a href="#await_229" rel="nofollow">await关键字（重要）</a></li><li><a href="#_275" rel="nofollow">回调函数（重要）</a></li><li><a href="#requestsaiohttp_317" rel="nofollow">协程中的requests—aiohttp（重要）</a></li><li><a href="#_363" rel="nofollow">基于协程的数据爬取</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<br> 
<strong>完整版！！！！！！！<br> 完整版！！！！！！！<br> 完整版！！！！！！！</strong> 
<p></p> 
<p><a href="https://blog.csdn.net/weixin_54884881/article/details/118029903?spm=1001.2014.3001.5502">爬虫完整版</a></p> 
<h4><a id="_8"></a>异步爬虫</h4> 
<h5><a id="_9"></a>初识异步爬虫方式</h5> 
<ol><li>多线程，多进程（不建议）：<br> - 优点：可以为相关堵塞（耗时间）的操作单独开启线程和进程，堵塞程序就会实现异步执行<br> - 缺点：无法限制多进程或多进程</li><li>线程池，进程池：<br> - 优点：降低系统对于线程和进程创建和销毁的频率，减小系统开销<br> - 缺点：池中线程和进程数量有上限</li></ol> 
<p>举个栗子直观地看一下线程的作用吧</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">get_text</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"正在下载"</span><span class="token punctuation">,</span>char<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"成功加载"</span><span class="token punctuation">,</span>char<span class="token punctuation">)</span>
    <span class="token keyword">return</span> char

<span class="token comment">#单线程运行：</span>
<span class="token comment">#运行文本</span>
text<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">]</span>
<span class="token comment">#记录开始时间</span>
start_time<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> text<span class="token punctuation">:</span>
    get_text<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token comment">#记录结束时间</span>
end_time<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"单进程共需要时间："</span><span class="token punctuation">,</span>end_time<span class="token operator">-</span>start_time<span class="token punctuation">)</span>


<span class="token comment">#多线程运行</span>
<span class="token comment">#导库</span>
<span class="token keyword">from</span> multiprocessing<span class="token punctuation">.</span>dummy <span class="token keyword">import</span> Pool
<span class="token comment">#实例化4线程池</span>
pool<span class="token operator">=</span>Pool<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
start_time<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

text_list<span class="token operator">=</span>pool<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>get_text<span class="token comment">#进行多线程的目标函数名，没有()</span>
                   <span class="token punctuation">,</span>text<span class="token comment">#传入数据的列表</span>
                   <span class="token punctuation">)</span>
<span class="token comment">#该函数返回值为函数return值组成的列表，顺序和传入列表相对应</span>
end_time<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"多进程共需要时间："</span><span class="token punctuation">,</span>end_time<span class="token operator">-</span>start_time<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>text_list<span class="token punctuation">)</span>

结果为：
正在下载 a
成功加载 a
正在下载 b
成功加载 b
正在下载 c
成功加载 c
正在下载 d
成功加载 d
单进程共需要时间：<span class="token number">8.001578569412231</span>
正在下载 a
正在下载 b
正在下载 c
正在下载 d
成功加载 b成功加载 d
成功加载 c
成功加载 a
多进程共需要时间：<span class="token number">2.0006678104400635</span>
<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">]</span>
我们发现：多线程输出的顺序结束时间是随机的，也证实了多线程之间运行并不会相互影响
</code></pre> 
<h5><a id="li_78"></a>li视频源码讲解</h5> 
<p><strong>文本源码见评论</strong></p> 
<p><a href="https://www.pearvideo.com/" rel="nofollow">li视频网址</a><br> <img src="https://images2.imgbox.com/94/72/iw8iVz7Z_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dc/7d/PUPEPYbV_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a7/df/oXSTp41y_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0a/3d/jStQIjrP_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4d/79/uPDLX0kV_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f3/2c/kwo9Tbnz_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1b/1b/NpwpvKkA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/11/72/pEWsp1RE_o.png" alt="在这里插入图片描述"></p> 
<p>下面我们开始最常用也是最难的基于协程的异步编程了<br> 不过只要静下心来理解，一定能理解的啊，加油！！！</p> 
<h4><a id="_96"></a>协程异步编程</h4> 
<h5><a id="_98"></a>什么是协程：</h5> 
<p>协程不是进程或线程，其执行过程更类似于子例程，或者说不带返回值的函数调用。<br> 一个程序可以包含多个协程，可以对比与一个进程包含多个线程，因而下面我们来比较协程和线程。我们知道多个线程相对独立，有自己的上下文，切换受系统控制；而协程也相对独立，有自己的上下文，但是其切换由自己控制，由当前协程切换到其他协程由当前协程来控制。</p> 
<p><strong>协程的意义</strong>：<br> 同时对于多个耗时间的操作进行同时运行以提高我们代码运算效率，在爬虫中，就可以同时请求多条数据，爬取多个数据/图片/视频</p> 
<h5><a id="_105"></a>实现携程的方法：</h5> 
<ol><li>greeenlt</li><li>yeid</li><li>asyncio</li><li>async，await关键字</li></ol> 
<p>这里不需要知道1，2，3 我们重点关注4，因为第四种效率最高，代码更简洁。</p> 
<h5><a id="_112"></a>事件循环</h5> 
<pre><code class="prism language-python"><span class="token operator">-</span> 时间循环可理解为死循环，一直检查一些代码执行情况，并做出相应处理
	
<span class="token operator">-</span> 事件就是指我们在爬取数据过程，不过该事件通常是以函数调用的形式出现
	
<span class="token operator">-</span> 就像我们想爬取多个视频，那么一个事件就可以是将视频url传入函数，进行爬取的过程

<span class="token comment"># 每个事件均有他自己的状态已完成：finished，未完成：pending</span>
任务列表<span class="token operator">=</span><span class="token punctuation">[</span>任务<span class="token number">1</span>，任务<span class="token number">2</span>，任务<span class="token number">3</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
	可执行的任务列表<span class="token operator">=</span>任务列表中取出可以被运行的任务
	已完成任务列表<span class="token operator">=</span>任务列表中取出已经运行完成的任务

	<span class="token keyword">for</span> 就绪任务 <span class="token keyword">in</span> 可执行的任务列表<span class="token punctuation">:</span>
		执行就绪任务

	<span class="token keyword">for</span> 已完成任务 <span class="token keyword">in</span> 已完成任务列表<span class="token punctuation">:</span>
		在任务列表移除已完成任务
	
	直到任务列表全部完成跳出循环
	
</code></pre> 
<pre><code>形如
async def 函数名:
    函数体
就是一个协程函数
协程函数的调用就是一个协程对象即 函数名()
但是调用协程函数得到的对象并不会直接执行(因为事件并未加载进事件循环的任务列表中去)
需要用到特定函数才能实现
</code></pre> 
<h5><a id="_146"></a>单条时间启动</h5> 
<pre><code class="prism language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request_1</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在请求的url是'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'请求成功,'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> url

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request_2</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在请求的url是'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'请求成功,'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> url

<span class="token comment"># 创建一个事件循环对象</span>
loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 基于loop创建了一个task_1任务对象(注意创建任务loop.create_task必须在事件循环创建以后)</span>
task_1 <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>request_1<span class="token punctuation">(</span><span class="token string">"https://www.taobao.com/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 基于loop创建了一个task_2任务对象，现在loop事件循环的时间里就存在了两个任务</span>
task_2<span class="token operator">=</span>loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>request_2<span class="token punctuation">(</span><span class="token string">"https://www.baidu.com/?"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>task_2<span class="token punctuation">)</span><span class="token comment">#查看一下状态</span>

<span class="token comment"># 启动事件循环loop，可以传入task对象，也可以是协程对象</span>
<span class="token comment"># 只不过传入协程对象该函数会自动增加一步在loop事件循环中注册该协程对象</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>task_1<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>task_2<span class="token punctuation">)</span><span class="token comment">#结果 finished</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>task_1<span class="token punctuation">)</span><span class="token comment">#结果 finished</span>
<span class="token comment">#说明loop.run_until_complete(task_1)在运行task_1时启动了事件循环loop中所有的task事件对象</span>
<span class="token comment"># 那么是不是咋以后的启动事件循环时只启动一个就可以运行所有了呢，当然不是</span>
<span class="token comment"># 因为在task_1完成后极短时间内，主程序还没来得及print(task_2)，task_2也随即完成了，使我们看到print(task_2)时task_2已完成</span>
<span class="token comment">#当task_2耗时更长一点时（例如在request_2添加await asyncio.sleep(0.01)，就会发现虽然是0.01秒print(task_2)结果是pending，即未完成）</span>
<span class="token comment">#说明可能某些原因导致在其他任务未完成的情况下就执行了下面代码</span>
<span class="token comment">#所以我们需要保证所有任务都要完成才能继续运行那么该怎么做呢？</span>

</code></pre> 
<h5><a id="_183"></a>多个事件启动（重要）</h5> 
<pre><code class="prism language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request_1</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在请求的url是'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'请求成功,'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> url

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request_2</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在请求的url是'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'请求成功,'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> url
    
<span class="token comment">#******************方法一****************</span>

<span class="token comment"># 创建一个事件循环对象</span>
loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#实际上不用使用loop.create_task也可以运行，不过还是建议加上</span>
task_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>request_1<span class="token punctuation">(</span><span class="token string">"https://www.baidu.com/?"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span>loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>request_1<span class="token punctuation">(</span><span class="token string">"https://www.taobao.com/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

<span class="token comment">#上面已提到在run_until_complete中要传入任务对象和协程对象</span>
<span class="token comment">#所以loop.run_until_complete(task_list)是错误的，因为task_list是一个列表</span>
<span class="token comment">#而添加上asyncio.wait就可以实现传入任务列表了</span>
<span class="token comment">#这样一来就可以实现loop里面所有任务全部实现完成后才进行下一步</span>
done<span class="token punctuation">,</span>pending<span class="token operator">=</span>loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>task_list<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#done是已完成任务的集合，pending是未完成任务的集合</span>



<span class="token comment">#******************方法二****************</span>

task_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    request_1<span class="token punctuation">(</span><span class="token string">"https://www.baidu.com/?"</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span>request_1<span class="token punctuation">(</span><span class="token string">"https://www.taobao.com/"</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

<span class="token comment">#这句代码的含义是创建事件循环并运行</span>
<span class="token comment">#相当于loop = asyncio.get_event_loop()和loop.run_until_complete(asyncio.wait(task_list))的集合</span>
<span class="token comment">#不过要特别注意的是因为创建任务必须在事件循环创建以后，所以在创建task_list时只能写成协程对象，不能是任务对象</span>
done<span class="token punctuation">,</span>pending<span class="token operator">=</span>asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>task_list<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>到这里上述的协程代码均是单线程运行的，也就是说在启动事件循环时运行的顺序是一个任务运行完后又运行下一个任务，并不是时间循环中所有时间同时运行，所以并没有达到我们多线程的目的，对于同时运行多个线程的话，需要手动对于协程函数中某些特定语句进行挂起，这些挂起的函数一般是比较费时间的函数，在函数挂起后什么时候向下运行呢？这里回到我们的循环时间，循环时间的作用就是对于任务里挂起函数进行状态检测，当检测到已完成就会向下运行。那么怎么挂起呢，就用到关键字await</p> 
<h5><a id="await_229"></a>await关键字（重要）</h5> 
<pre><code class="prism language-python"><span class="token keyword">import</span> asyncio

<span class="token comment"># await+可等待对象（协程对象，Future，Task对象）IO等待</span>
<span class="token comment"># 在运行await后的语句时，会自动切换到其他任务实现同时运行多个任务</span>
<span class="token comment">#在爬虫使用时通常是get，post请求</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request_1</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在请求的url是'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'请求成功,'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> url
    
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request_2</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在请求的url是'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'请求成功,'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> url

task_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    request_1<span class="token punctuation">(</span><span class="token string">"https://www.baidu.com/?"</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> request_2<span class="token punctuation">(</span><span class="token string">"https://www.taobao.com/"</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
done<span class="token punctuation">,</span>pending<span class="token operator">=</span>asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>task_list<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span>

结果：
正在请求的url是 https<span class="token punctuation">:</span><span class="token operator">//</span>www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>?
正在请求的url是 https<span class="token punctuation">:</span><span class="token operator">//</span>www<span class="token punctuation">.</span>taobao<span class="token punctuation">.</span>com<span class="token operator">/</span>
请求成功<span class="token punctuation">,</span> https<span class="token punctuation">:</span><span class="token operator">//</span>www<span class="token punctuation">.</span>taobao<span class="token punctuation">.</span>com<span class="token operator">/</span>
请求成功<span class="token punctuation">,</span> https<span class="token punctuation">:</span><span class="token operator">//</span>www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token operator">/</span>?
<span class="token number">5.001507520675659</span> 

<span class="token triple-quoted-string string">"""
asyncio.run(asyncio.wait(task_list))运行顺序：
先进入request_1("https://www.baidu.com/?")中运行，运行到await asyncio.sleep(5)挂起
接着进入request_2("https://www.taobao.com/")中运行，运行到await asyncio.sleep(2)挂起（若有其他任务接着运行），
检测到没有任务了那么这一个循环结束，那么事件循环继续对整个任务列表中任务依次检测状态，
如果挂起函数仍未完成，那么进行下一个任务，都没有完成就再来继续对整个任务列表中任务依次检测状态，
若检测有任务完成了挂起函数，那么会紧接着运行这个任务挂起函数的下面，直到又遇见其他await函数或者运行完（从任务列表删除），
再进行下一个任务状态检测

"""</span>
</code></pre> 
<h5><a id="_275"></a>回调函数（重要）</h5> 
<p><strong>为什么要有回调函数</strong></p> 
<pre><code>async def request_1(url):
	print('正在请求的url是', url)
	await asyncio.sleep(5)
	print('请求成功,', url)
	return url
在爬虫使用时，通常是传入url，
return返回所get，post的信息
但是我们不能直接拿到return返回的值
所以要通过回调函数进行实现
另外回调函数实在任务结束后立即执行，属于异步进行
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> asyncio

<span class="token comment">#协程函数</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request_1</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'正在请求的url是'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'请求成功,'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> url

<span class="token comment">#回调函数</span>
<span class="token keyword">def</span> <span class="token function">call_back</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># 可在此通过t.result()进行数据解析</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">#创建事件循环</span>
loop<span class="token operator">=</span>asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#在时间循环中添加任务</span>
task_1<span class="token operator">=</span>loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>request_1<span class="token punctuation">(</span><span class="token string">"https://www.baidu.com/?"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#将协程任务绑定回调函数</span>
task_1<span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>call_back<span class="token punctuation">)</span>
<span class="token comment">#运行loop</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>task_1<span class="token punctuation">)</span>

注：回调函数一定是在运行完<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request_1</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>后
会自动将返回值经过特殊的包装作为参数传入<span class="token keyword">def</span> call_back<span class="token punctuation">(</span>t<span class="token punctuation">)</span>中
在回调函数中通过t<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>就能拿到request_1返回的值
</code></pre> 
<h5><a id="requestsaiohttp_317"></a>协程中的requests—aiohttp（重要）</h5> 
<pre><code>由于requests不支持多线程运行，所以我们不得不更换库来实现数据爬取，那就是aiohttp中的ClientSession()
它和requests用法相同，除了get，post函数中参数proxy从字典形式换成了字符串形式。
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> aiohttp

<span class="token comment">#关于为什么会用async with as 实现是因为它结束运行后自动关闭实例化对象，修饰关键字async是协程函数with as的固定用法</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>url_1<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
    <span class="token comment"># 不要忘了ClientSession()中的()</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url_1<span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span>
            <span class="token comment"># 注意是字符串类型数据text()</span>
            <span class="token comment"># 二进制(图片视频)类型数据read()</span>
            <span class="token comment"># json()返回json对象</span>
            page_text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> page_text


<span class="token keyword">def</span> <span class="token function">call_back_fun</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># 可解析存放数据</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结果是："</span><span class="token punctuation">,</span>t<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 爬取网址目标</span>
loc_list <span class="token operator">=</span> <span class="token punctuation">[</span>
   <span class="token string">"https://www.taobao.com/"</span>
    <span class="token punctuation">,</span> <span class="token string">"https://www.jd.com/"</span>
<span class="token punctuation">]</span>

<span class="token comment"># 创建事件循环</span>
loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 存储任务对象</span>
task_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> loc_list<span class="token punctuation">:</span>
    <span class="token comment"># 在loop中添加任务对象</span>
    task <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>request<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 对每个任务对象进行回调函数绑定</span>
    task<span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>call_back_fun<span class="token punctuation">)</span>
    <span class="token comment"># 将任务存入列表</span>
    task_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span>

<span class="token comment"># 启动loop</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>task_list<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<h5><a id="_363"></a>基于协程的数据爬取</h5> 
<pre><code>一般思路：
1. 将数据地址存入列表
2. 通过协程函数进行异步爬取
3. 通过回调函数进行数据解析和储存
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> aiohttp

header <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"User-Agent"</span><span class="token punctuation">:</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36 SLBrowser/7.0.0.5211 SLBChan/25"</span>
<span class="token punctuation">}</span>


<span class="token comment"># 传入url和图片名称</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">request</span><span class="token punctuation">(</span>url_1<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> <span class="token keyword">await</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url_1<span class="token punctuation">,</span>headers<span class="token operator">=</span>header<span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span>
            page_text <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span>page_text<span class="token punctuation">,</span> name<span class="token punctuation">]</span>
            <span class="token comment"># 把数据和图片名称给回调函数</span>


<span class="token comment"># 回调参数是列表形式</span>
<span class="token comment"># 由于request函数直接返回的是图片数据就没有进行数据解析的需要(和通用爬虫聚焦爬虫使用情况相同)</span>
<span class="token keyword">def</span> <span class="token function">call_back_fun</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># 数据命名</span>
    data<span class="token operator">=</span>t<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment"># 存储名称</span>
    name<span class="token operator">=</span>t<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"./图片爬取/"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">".jpg"</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
        fp<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token string">" has been over"</span><span class="token punctuation">)</span>


<span class="token comment"># 爬取网址目标(两张图片地址)</span>
loc_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"https://img1.baidu.com/it/u=684012728,3682755741&amp;fm=26&amp;fmt=auto&amp;gp=0.jpg"</span>
    <span class="token punctuation">,</span> <span class="token string">"https://img2.baidu.com/it/u=3236440276,662654086&amp;fm=26&amp;fmt=auto&amp;gp=0.jpg"</span>
<span class="token punctuation">]</span>
name_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"小姐姐1"</span><span class="token punctuation">,</span> <span class="token string">"小姐姐2"</span><span class="token punctuation">]</span>
<span class="token comment"># 创建事件循环</span>
loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 存储任务对象</span>
task_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> j<span class="token punctuation">,</span> i <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>loc_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 在loop中添加任务对象</span>
    task <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>request<span class="token punctuation">(</span>i<span class="token punctuation">,</span> name_list<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 对每个任务对象进行回调函数绑定</span>
    task<span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>call_back_fun<span class="token punctuation">)</span>
    <span class="token comment"># 将任务存入列表</span>
    task_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">"./图片爬取"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token string">"./图片爬取"</span><span class="token punctuation">)</span>

<span class="token comment"># 启动loop</span>
loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>task_list<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/96/9e/kmvBRWLj_o.png" alt="在这里插入图片描述" width="450"><br> <img src="https://images2.imgbox.com/da/6f/B7eGpNfL_o.png" alt="在这里插入图片描述" width="450"></p> 
<p><strong>over</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6463eb83808a0b3d394e8a17f54968bd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">windows 无法停止 Internet Connection Sharing (ICS)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5791bf6a9438492c5d7b7e04b075b493/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">docker 中文文档</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>