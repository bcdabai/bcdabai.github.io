<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>关于HTTP2.0 gzip和br解压缩 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="关于HTTP2.0 gzip和br解压缩" />
<meta property="og:description" content="关于gzip格式解码
使用zlib库解压GZIP格式数据，相关函数inflateInit2(),inflate(),inflateEnd().
zlib库安装这个比较简单不做过多描述
代码示例
直接加入#include &lt;zlib.h&gt;
static int vidpeek_uncompressGzip(unsigned char* pSrc, unsigned int srcSize,char*pOutDest, unsigned int* pOutBufSize) { int ret = OK; char* pBuf = pSrc&#43; (srcSize - 1); unsigned int len =1000000; int uncompressResult; z_stream d_stream; int i = 0; printf(&#34;#############pSrc 0x%x 0x%x 0x%x 0x%x %d&#34;, pSrc[0], pSrc[1],*pSrc, *(pSrc&#43;1),srcSize); if((*pSrc !=0x1f)||(*(pSrc&#43;1) != 0x8b)) { printf(&#34;\nuncompressGzip non Gzip\n&#34;); return ERR; } //初始化解压系统 d_stream.zalloc =Z_NULL; d_stream.zfree =Z_NULL; d_stream.opaque = Z_NULL; d_stream." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/b6f7c3b250d921943f9d3b0a3888b27a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-24T15:58:57+08:00" />
<meta property="article:modified_time" content="2020-11-24T15:58:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">关于HTTP2.0 gzip和br解压缩</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>关于gzip格式解码</strong><br> 使用zlib库解压GZIP格式数据，相关函数inflateInit2(),inflate(),inflateEnd().<br> zlib库安装这个比较简单不做过多描述<br> <strong>代码示例</strong><br> 直接加入#include &lt;zlib.h&gt;</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">vidpeek_uncompressGzip</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> pSrc<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> srcSize<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>pOutDest<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span> pOutBufSize<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> OK<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> pBuf <span class="token operator">=</span> pSrc<span class="token operator">+</span> <span class="token punctuation">(</span>srcSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len <span class="token operator">=</span><span class="token number">1000000</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> uncompressResult<span class="token punctuation">;</span>   
    z_stream d_stream<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"#############pSrc 0x%x 0x%x 0x%x 0x%x %d"</span><span class="token punctuation">,</span> pSrc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pSrc<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">*</span>pSrc<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>pSrc<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>srcSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>pSrc <span class="token operator">!=</span><span class="token number">0x1f</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>pSrc<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x8b</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nuncompressGzip non Gzip\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ERR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
	<span class="token comment">//初始化解压系统</span>
    d_stream<span class="token punctuation">.</span>zalloc <span class="token operator">=</span>Z_NULL<span class="token punctuation">;</span>
    d_stream<span class="token punctuation">.</span>zfree <span class="token operator">=</span>Z_NULL<span class="token punctuation">;</span>
    d_stream<span class="token punctuation">.</span>opaque <span class="token operator">=</span> Z_NULL<span class="token punctuation">;</span>
    d_stream<span class="token punctuation">.</span>next_in <span class="token operator">=</span>Z_NULL<span class="token punctuation">;</span>
    d_stream<span class="token punctuation">.</span>avail_in<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    uncompressResult <span class="token operator">=</span><span class="token function">inflateInit2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d_stream<span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>uncompressResult<span class="token operator">!=</span>Z_OK<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\ninflateInit2 error:%d\n"</span><span class="token punctuation">,</span>uncompressResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> uncompressResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    d_stream<span class="token punctuation">.</span>next_in<span class="token operator">=</span>pSrc<span class="token punctuation">;</span>
    d_stream<span class="token punctuation">.</span>avail_in<span class="token operator">=</span>srcSize<span class="token punctuation">;</span>
    d_stream<span class="token punctuation">.</span>next_out<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pOutDest<span class="token punctuation">;</span>
    d_stream<span class="token punctuation">.</span>avail_out<span class="token operator">=</span>len<span class="token punctuation">;</span>
    uncompressResult <span class="token operator">=</span><span class="token function">inflate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d_stream<span class="token punctuation">,</span>Z_NO_FLUSH<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">switch</span><span class="token punctuation">(</span>uncompressResult<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> Z_NEED_DICT<span class="token operator">:</span>
            uncompressResult <span class="token operator">=</span> Z_DATA_ERROR<span class="token punctuation">;</span>
        <span class="token keyword">case</span> Z_DATA_ERROR<span class="token operator">:</span>
        <span class="token keyword">case</span> Z_MEM_ERROR<span class="token operator">:</span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">inflateEnd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d_stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> uncompressResult<span class="token punctuation">;</span>		
    <span class="token punctuation">}</span>
 
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"outlen= %d, total_in= %d, total_out= %d, avail_out= %d@@@@@@@@@@@\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">,</span> d_stream<span class="token punctuation">.</span>total_in<span class="token punctuation">,</span> d_stream<span class="token punctuation">.</span>total_out<span class="token punctuation">,</span> d_stream<span class="token punctuation">.</span>avail_out<span class="token punctuation">)</span><span class="token punctuation">;</span>           
 
    <span class="token function">inflateEnd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d_stream<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token macro property">#<span class="token directive keyword">if</span> 0</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span>pOutDest<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	<span class="token operator">*</span>pOutBufSize <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pOutDest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下面代码是处理gzip分片的数据</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">vidpeek_uncompressGzip</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> pSrc<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> srcSize<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>pOutDest<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span> pOutBufSize<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>ctx<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> OK<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> pBuf <span class="token operator">=</span> pSrc<span class="token operator">+</span> <span class="token punctuation">(</span>srcSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len <span class="token operator">=</span><span class="token number">1000000</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> uncompressResult<span class="token punctuation">;</span>   

	z_stream<span class="token operator">*</span> d_stream<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>  
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		d_stream<span class="token operator">=</span><span class="token punctuation">(</span>z_stream<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>z_stream<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//初始化解压系统</span>
		d_stream<span class="token operator">-</span><span class="token operator">&gt;</span>zalloc <span class="token operator">=</span>Z_NULL<span class="token punctuation">;</span>
		d_stream<span class="token operator">-</span><span class="token operator">&gt;</span>zfree <span class="token operator">=</span>Z_NULL<span class="token punctuation">;</span>
		d_stream<span class="token operator">-</span><span class="token operator">&gt;</span>opaque <span class="token operator">=</span> Z_NULL<span class="token punctuation">;</span>
		d_stream<span class="token operator">-</span><span class="token operator">&gt;</span>next_in <span class="token operator">=</span>Z_NULL<span class="token punctuation">;</span>
		d_stream<span class="token operator">-</span><span class="token operator">&gt;</span>avail_in<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		uncompressResult <span class="token operator">=</span><span class="token function">inflateInit2</span><span class="token punctuation">(</span>d_stream<span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>uncompressResult<span class="token operator">!=</span>Z_OK<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\ninflateInit2 error:%d\n"</span><span class="token punctuation">,</span>uncompressResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> uncompressResult<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	  <span class="token operator">*</span>ctx <span class="token operator">=</span> d_stream<span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
	  d_stream <span class="token operator">=</span> <span class="token operator">*</span>ctx<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    d_stream<span class="token operator">-</span><span class="token operator">&gt;</span>next_in<span class="token operator">=</span>pSrc<span class="token punctuation">;</span>
    d_stream<span class="token operator">-</span><span class="token operator">&gt;</span>avail_in<span class="token operator">=</span>srcSize<span class="token punctuation">;</span>
    d_stream<span class="token operator">-</span><span class="token operator">&gt;</span>next_out<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pOutDest<span class="token punctuation">;</span>
    d_stream<span class="token operator">-</span><span class="token operator">&gt;</span>avail_out<span class="token operator">=</span>len<span class="token punctuation">;</span>
    uncompressResult <span class="token operator">=</span><span class="token function">inflate</span><span class="token punctuation">(</span>d_stream<span class="token punctuation">,</span>Z_NO_FLUSH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>uncompressResult<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> Z_NEED_DICT<span class="token operator">:</span>
            uncompressResult <span class="token operator">=</span> Z_DATA_ERROR<span class="token punctuation">;</span>
        <span class="token keyword">case</span> Z_DATA_ERROR<span class="token operator">:</span>
        <span class="token keyword">case</span> Z_MEM_ERROR<span class="token operator">:</span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">inflateEnd</span><span class="token punctuation">(</span>d_stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> uncompressResult<span class="token punctuation">;</span>		
    <span class="token punctuation">}</span>
	         
	<span class="token operator">*</span>pOutBufSize <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pOutDest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>关于br解压缩</strong><br> https://github.com/google/brotli 上下载，下面有编译方法<br> 使用brotli库解压br，相关函数BrotliDecoderDecompress();（brotli-1.0.9\c\include\brotli\decode.h）<br> 如果需要解压所的数据比较完整 直接调用上面函数即可。</p> 
<p>但是br数据解压 后面数据的解压依赖前面数据 故将BrotliDecoderDecompress()改造加入到decode.c .h 中 ，重新生成动态库调用即可。</p> 
<pre><code class="prism language-cpp">BrotliDecoderResult <span class="token function">BrotliDecoderDecompress_new</span><span class="token punctuation">(</span>
	size_t encoded_size<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span><span class="token operator">*</span> encoded_buffer<span class="token punctuation">,</span> size_t<span class="token operator">*</span> decoded_size<span class="token punctuation">,</span>
	<span class="token keyword">uint8_t</span><span class="token operator">*</span> decoded_buffer<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>ctx<span class="token punctuation">,</span> size_t<span class="token operator">*</span> total_out<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	
  BrotliDecoderState <span class="token operator">*</span>s<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
	  s <span class="token operator">=</span> <span class="token function">BrotliDecoderCreateInstance</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  BrotliDecoderResult result<span class="token punctuation">;</span>
  <span class="token comment">//size_t total_out = 0;</span>
  size_t available_in <span class="token operator">=</span> encoded_size<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">uint8_t</span><span class="token operator">*</span> next_in <span class="token operator">=</span> encoded_buffer<span class="token punctuation">;</span>
  <span class="token comment">//size_t available_out = *decoded_size;</span>
  <span class="token keyword">uint8_t</span><span class="token operator">*</span> next_out <span class="token operator">=</span> decoded_buffer<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">BrotliDecoderStateInit</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> BROTLI_DECODER_RESULT_ERROR<span class="token punctuation">;</span>
	  <span class="token punctuation">}</span>
	<span class="token operator">*</span>ctx <span class="token operator">=</span> s<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{<!-- --></span>
	s <span class="token operator">=</span> <span class="token operator">*</span>ctx<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  result <span class="token operator">=</span> <span class="token function">BrotliDecoderDecompressStream</span><span class="token punctuation">(</span>
	  s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>available_in<span class="token punctuation">,</span> <span class="token operator">&amp;</span>next_in<span class="token punctuation">,</span> decoded_size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>next_out<span class="token punctuation">,</span> total_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//*decoded_size = total_out;</span>
  
  <span class="token comment">// 判断是否解完</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">BrotliDecoderIsFinished</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
	  <span class="token function">BrotliDecoderStateCleanup</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token comment">// 销毁</span>
	  <span class="token function">BrotliDecoderDestroyInstance</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token operator">*</span>ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> BROTLI_DECODER_RESULT_SUCCESS <span class="token operator">&amp;&amp;</span> result <span class="token operator">!=</span> BROTLI_DECODER_RESULT_NEEDS_MORE_INPUT  <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	result <span class="token operator">=</span> BROTLI_DECODER_RESULT_ERROR<span class="token punctuation">;</span>
	<span class="token function">BrotliDecoderStateCleanup</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 销毁</span>
	<span class="token function">BrotliDecoderDestroyInstance</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">*</span>ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试结果：</p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token comment">/* For "exit". */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token comment">/* For "strerror". */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;decode.h&gt;</span></span>

<span class="token comment">//数据太大 不贴了  </span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> in<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> in1<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> in2<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> out<span class="token punctuation">[</span><span class="token number">100000</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> out1<span class="token punctuation">[</span><span class="token number">100000</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> out2<span class="token punctuation">[</span><span class="token number">100000</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> out3<span class="token punctuation">[</span><span class="token number">100000</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    size_t psize<span class="token operator">=</span><span class="token number">100000</span><span class="token punctuation">;</span> 
	size_t total_out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>ctx<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-------len : %d\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token function">BrotliDecoderDecompress_new</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span>in<span class="token punctuation">,</span><span class="token operator">&amp;</span>psize<span class="token punctuation">,</span><span class="token operator">&amp;</span>out<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx<span class="token punctuation">,</span><span class="token operator">&amp;</span>total_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen =%d,ret=%d total_out: %d\n"</span><span class="token punctuation">,</span> psize<span class="token punctuation">,</span>ret<span class="token punctuation">,</span> total_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen=%d\n"</span><span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//printf("strlen=%s\n",out);</span>
	
	ret<span class="token operator">=</span><span class="token function">BrotliDecoderDecompress_new</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">500</span><span class="token punctuation">,</span>in<span class="token operator">+</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>psize<span class="token punctuation">,</span><span class="token operator">&amp;</span>out<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx<span class="token punctuation">,</span><span class="token operator">&amp;</span>total_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen =%d,ret=%d total_out: %d\n"</span><span class="token punctuation">,</span> psize<span class="token punctuation">,</span>ret<span class="token punctuation">,</span> total_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen=%d\n"</span><span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//printf("strlen=%s\n",out);</span>
	psize<span class="token operator">=</span><span class="token number">100000</span><span class="token punctuation">;</span> 
	<span class="token keyword">int</span> ret1<span class="token operator">=</span><span class="token function">BrotliDecoderDecompress_new</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>in1<span class="token punctuation">)</span><span class="token punctuation">,</span>in1<span class="token punctuation">,</span><span class="token operator">&amp;</span>psize<span class="token punctuation">,</span><span class="token operator">&amp;</span>out1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx<span class="token punctuation">,</span><span class="token operator">&amp;</span>total_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen =%d,ret=%d total_out: %d\n"</span><span class="token punctuation">,</span>psize<span class="token punctuation">,</span>ret<span class="token punctuation">,</span> total_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen=%d\n"</span><span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>out1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen=%s\n"</span><span class="token punctuation">,</span>out1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	psize<span class="token operator">=</span><span class="token number">100000</span><span class="token punctuation">;</span> 
	<span class="token keyword">int</span> ret2<span class="token operator">=</span><span class="token function">BrotliDecoderDecompress_new</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>in2<span class="token punctuation">)</span><span class="token punctuation">,</span>in2<span class="token punctuation">,</span><span class="token operator">&amp;</span>psize<span class="token punctuation">,</span><span class="token operator">&amp;</span>out2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx<span class="token punctuation">,</span><span class="token operator">&amp;</span>total_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen =%d,ret=%d total_out: %d\n"</span><span class="token punctuation">,</span>psize<span class="token punctuation">,</span>ret<span class="token punctuation">,</span> total_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen=%d\n"</span><span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>out2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen=%s\n"</span><span class="token punctuation">,</span>out2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	psize<span class="token operator">=</span><span class="token number">100000</span><span class="token punctuation">;</span> 
	<span class="token keyword">int</span> ret3<span class="token operator">=</span><span class="token function">BrotliDecoderDecompress_new</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>in3<span class="token punctuation">)</span><span class="token punctuation">,</span>in3<span class="token punctuation">,</span><span class="token operator">&amp;</span>psize<span class="token punctuation">,</span><span class="token operator">&amp;</span>out3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ctx<span class="token punctuation">,</span><span class="token operator">&amp;</span>total_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen =%d,ret=%d total_out: %d\n"</span><span class="token punctuation">,</span>psize<span class="token punctuation">,</span>ret<span class="token punctuation">,</span> total_out<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen=%d\n"</span><span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>out3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"strlen=%s\n"</span><span class="token punctuation">,</span>out3<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>gcc unbr.c -I. -L. -lbrotlidec</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9ee7f874f0d74638d1e80cf4f8b0f15d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">v-model和v-bind的区别</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0e44723596001029faaedbb308c95d4c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ABAP CDS-介绍(ABAP CDS视图)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>