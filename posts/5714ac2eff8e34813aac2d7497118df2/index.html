<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>java杂文系列(1) poi导出excel文件（包含图片）大的奇葩事件 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="java杂文系列(1) poi导出excel文件（包含图片）大的奇葩事件" />
<meta property="og:description" content="最近负责的项目出现了个奇葩的问题，两个方法几乎同样的逻辑，模板也差不多，导出内容也差不多，但是导出的文件却相差10几兆，用户不能忍，我也不能忍，但是反复对比代码，反复推敲逻辑，硬是找不到个所以然。在百般摸索下最后发现了解决方案，但是根源还不是很清楚，知道的人还望不吝赐教。下面对解决的过程记录下，已备后续警示自己。
刚开始我是把文件中的图片复制到QQ里，然后再复制到桌面，然后看图片大小，发现图片都差不多，于是乎就排除里图片的可能。但是在同事的帮助下，我意识到这个思路有严重的问题，通过上述操作，我活生生的把12兆多的图片变成了60多K。于是乎顿然发现原来问题在图片上，于是采取正确的方式，先在导出的excel里把图片还原，然后将图片另存到另一个空的excel里，看图片的大小。（还原后再复制到QQ--》桌面 然后看大小也靠谱点）
确定是图片的问题了，分别调试两个方法发现下载图片的路径是一样的。下面是导出较大的excel的图片生成代码。其实通过调试图片后缀就是 .png 但是换种写法差距就是10几兆啊。
ImageIO.write(image, &#34;png&#34; , byteArray); 这句是关键只要把&#34;png&#34;改成suffix 就可以将导出文件从17兆降到1.4兆。问题是解决了，但是疑问还在，逻辑上想不通Why? protected void toImage(Cell cell, String uri, ClientAnchor anchor) { if (uri == null) { return; } //新代码 String suffix = FileUtils.getFileSuffix(uri).substring(1); int ptype = 0; if(&#34;png&#34;.equalsIgnoreCase(suffix)){ ptype = Workbook.PICTURE_TYPE_PNG; }else if(&#34;jpg&#34;.equalsIgnoreCase(suffix) || &#34;jpeg&#34;.equalsIgnoreCase(suffix)){ ptype = Workbook.PICTURE_TYPE_JPEG; }else if(&#34;emf&#34;.equalsIgnoreCase(suffix)){ ptype = Workbook.PICTURE_TYPE_EMF; }else{ ptype = -1; } //新代码结束 Drawing drawing = sheet.createDrawingPatriarch(); try { ByteArrayOutputStream byteArray = new ByteArrayOutputStream(); BufferedImage image = ImageIO." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5714ac2eff8e34813aac2d7497118df2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-03-29T10:28:41+08:00" />
<meta property="article:modified_time" content="2017-03-29T10:28:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">java杂文系列(1) poi导出excel文件（包含图片）大的奇葩事件</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>最近负责的项目出现了个奇葩的问题，两个方法几乎同样的逻辑，模板也差不多，导出内容也差不多，但是导出的文件却相差10几兆，用户不能忍，我也不能忍，但是反复对比代码，反复推敲逻辑，硬是找不到个所以然。在百般摸索下最后发现了解决方案，但是根源还不是很清楚，知道的人还望不吝赐教。下面对解决的过程记录下，已备后续警示自己。</p> 
<p>刚开始我是把文件中的图片复制到QQ里，然后再复制到桌面，然后看图片大小，发现图片都差不多，于是乎就排除里图片的可能。但是在同事的帮助下，我意识到这个思路有严重的问题，通过上述操作，我活生生的把12兆多的图片变成了60多K。于是乎顿然发现原来问题在图片上，于是采取正确的方式，先在导出的excel里把图片还原，然后将图片另存到另一个空的excel里，看图片的大小。（还原后再复制到QQ--》桌面 然后看大小也靠谱点）</p> 
<p>确定是图片的问题了，分别调试两个方法发现下载图片的路径是一样的。下面是导出较大的excel的图片生成代码。其实通过调试图片后缀就是 .png 但是换种写法差距就是10几兆啊。</p> 
<p> </p> 
<pre class="has"><code class="language-java">ImageIO.write(image, "png" , byteArray); 这句是关键只要把"png"改成suffix 就可以将导出文件从17兆降到1.4兆。问题是解决了，但是疑问还在，逻辑上想不通Why?</code></pre> 
<pre><code class="language-html hljs"> </code></pre> 
<p> </p> 
<pre class="has"><code class="language-java">protected void toImage(Cell cell, String uri, ClientAnchor anchor) {
        if (uri == null) {
            return;
        }</code></pre> 
<pre class="has"><code class="language-java">	//新代码
        String suffix = FileUtils.getFileSuffix(uri).substring(1);
        int ptype = 0;
        if("png".equalsIgnoreCase(suffix)){
            ptype = Workbook.PICTURE_TYPE_PNG;
        }else if("jpg".equalsIgnoreCase(suffix) || "jpeg".equalsIgnoreCase(suffix)){
            ptype = Workbook.PICTURE_TYPE_JPEG;
        }else if("emf".equalsIgnoreCase(suffix)){
            ptype = Workbook.PICTURE_TYPE_EMF;
        }else{
            ptype = -1;
        }
        //新代码结束
        Drawing drawing = sheet.createDrawingPatriarch();
        
        try {
            ByteArrayOutputStream byteArray = new ByteArrayOutputStream();
            BufferedImage image = ImageIO.read(new File(uri));
            //老代码
            /*ImageIO.write(image, "png" , byteArray);
            drawing.createPicture(anchor, getWorkBook().addPicture(byteArray   
                    .toByteArray(), Workbook.PICTURE_TYPE_PNG));*/
            //新代码
            ImageIO.write(image, suffix , byteArray);
            drawing.createPicture(anchor, getWorkBook().addPicture(byteArray.toByteArray() , ptype));
            //新代码结束
        } catch (IOException e) {
            e.printStackTrace();
        }
    }</code>//新代码
        String suffix = FileUtils.getFileSuffix(uri).substring(1);
        int ptype = 0;
        if("png".equalsIgnoreCase(suffix)){
            ptype = Workbook.PICTURE_TYPE_PNG;
        }else if("jpg".equalsIgnoreCase(suffix) || "jpeg".equalsIgnoreCase(suffix)){
            ptype = Workbook.PICTURE_TYPE_JPEG;
        }else if("emf".equalsIgnoreCase(suffix)){
            ptype = Workbook.PICTURE_TYPE_EMF;
        }else{
            ptype = -1;
        }
        //新代码结束
        Drawing drawing = sheet.createDrawingPatriarch();
        
        try {
            ByteArrayOutputStream byteArray = new ByteArrayOutputStream();
            BufferedImage image = ImageIO.read(new File(uri));
            //老代码
            /*ImageIO.write(image, "png" , byteArray);
            drawing.createPicture(anchor, getWorkBook().addPicture(byteArray   
                    .toByteArray(), Workbook.PICTURE_TYPE_PNG));*/
            //新代码
            ImageIO.write(image, suffix , byteArray);
            drawing.createPicture(anchor, getWorkBook().addPicture(byteArray.toByteArray() , ptype));
            //新代码结束
        } catch (IOException e) {
            e.printStackTrace();
        }
    }</pre> 
<p> </p> 
<p>影响excel文件大小的因素：</p> 
<p> </p> 
<p>1、可能版本不一样，高版本会小一点。<br> 2、公式数量不一样。同样的内容，由公式计算出来的和复制粘贴值之后大小相差甚远，尤其是引用外部数据。<br> 3、某些单元格设置有条件格式，只是没表现出来。<br> 4、有隐藏的工作表标签。</p> 
<p>当然内容还是主要的因素。</p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d0b6692d9bdc070d42df0f4b564f5a69/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring&#43;SpringMVC&#43;MyBatis&#43;easyUI整合优化篇（一）Java语言中System.out.print与Log的比较</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/be51060a043a318d8818bde5610a890b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何将小视频制作成动态图片</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>