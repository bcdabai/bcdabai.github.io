<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>react-router和react-router-dom的实现 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="react-router和react-router-dom的实现" />
<meta property="og:description" content="React Router 是完整的 React 路由解决方案
React Router 保持 UI 与 URL 同步。它拥有简单的 API 与强大的功能例如代码缓冲加载、动态路由匹配、以及建立正确的位置过渡处理。今天我们就来大概的看一下这个强大的组件是如何实现的。
react-router为了能实现跨平台的路由解决方案，将react-router分成了三个模块：react-router，react-router-native，react-router-dom三个包，react-router是另外两个模块的基础。这里我们主要分析react-router-dom的基本实现。
react-router源码地址: https://github.com/ReactTraining/react-router
RouterContext react-router使用context实现跨组件间数据传递，所以react-router定义了一个routerContext作为数据源，
// packages/react-router/modules/RouterContext.js import createContext from &#34;mini-create-react-context&#34;; const createNamedContext = name =&gt; { const context = createContext(); context.displayName = name; return context; }; const context = createNamedContext(&#34;Router&#34;); export default context; 代码非常好理解，定义createNamedContext函数，然后调用它来创建一个context。
Router 我们在使用react-router-dom的使用，经常会用到BroswerRouter和HashRouter两个组件，这两个组件都使用了Router组件，所以所Router组件是基础，我们先来看看Router组件定义
// packages/react-router/modules/Router.js import RouterContext from &#34;./RouterContext&#34;; class Router extends React.Component { static computeRootMatch(pathname) { return { path: &#34;/&#34;, url: &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/d415450de4c730563d58abe7127feb04/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-24T10:45:12+08:00" />
<meta property="article:modified_time" content="2019-07-24T10:45:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">react-router和react-router-dom的实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>React Router 是完整的 React 路由解决方案<br> React Router 保持 UI 与 URL 同步。它拥有简单的 API 与强大的功能例如代码缓冲加载、动态路由匹配、以及建立正确的位置过渡处理。今天我们就来大概的看一下这个强大的组件是如何实现的。<br> react-router为了能实现跨平台的路由解决方案，将react-router分成了三个模块：<code>react-router</code>，<code>react-router-native</code>，<code>react-router-dom</code>三个包，<code>react-router</code>是另外两个模块的基础。这里我们主要分析react-router-dom的基本实现。<br> react-router源码地址: <a href="https://github.com/ReactTraining/react-router">https://github.com/ReactTraining/react-router</a></p> 
<h4><a id="RouterContext_4"></a>RouterContext</h4> 
<p>react-router使用context实现跨组件间数据传递，所以react-router定义了一个routerContext作为数据源，</p> 
<pre><code class="prism language-javascript"><span class="token comment">// packages/react-router/modules/RouterContext.js</span>
<span class="token keyword">import</span> createContext <span class="token keyword">from</span> <span class="token string">"mini-create-react-context"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">createNamedContext</span> <span class="token operator">=</span> name <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>displayName <span class="token operator">=</span> name<span class="token punctuation">;</span>

  <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">createNamedContext</span><span class="token punctuation">(</span><span class="token string">"Router"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> context<span class="token punctuation">;</span>
</code></pre> 
<p>代码非常好理解，定义<code>createNamedContext</code>函数，然后调用它来创建一个context。</p> 
<h4><a id="Router_22"></a>Router</h4> 
<p>我们在使用react-router-dom的使用，经常会用到BroswerRouter和HashRouter两个组件，这两个组件都使用了Router组件，所以所Router组件是基础，我们先来看看Router组件定义</p> 
<pre><code class="prism language-javascript"><span class="token comment">// packages/react-router/modules/Router.js</span>
<span class="token keyword">import</span> RouterContext <span class="token keyword">from</span> <span class="token string">"./RouterContext"</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Router</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">static</span> <span class="token function">computeRootMatch</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span> path<span class="token punctuation">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span> params<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> isExact<span class="token punctuation">:</span> pathname <span class="token operator">===</span> <span class="token string">"/"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      location<span class="token punctuation">:</span> props<span class="token punctuation">.</span>history<span class="token punctuation">.</span>location
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingLocation <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>props<span class="token punctuation">.</span>staticContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>unlisten <span class="token operator">=</span> props<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>location <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isMounted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> location <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingLocation <span class="token operator">=</span> location<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_pendingLocation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> location<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pendingLocation <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>unlisten<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unlisten</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>RouterContext<span class="token punctuation">.</span>Provider
        children<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">}</span>
        value<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>
          history<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>history<span class="token punctuation">,</span>
          location<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>location<span class="token punctuation">,</span>
          match<span class="token punctuation">:</span> Router<span class="token punctuation">.</span><span class="token function">computeRootMatch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span><span class="token punctuation">,</span>
          staticContext<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>staticContext
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Router组件引入了刚刚提到的RouterContext，将其作为Provider为子组件提提供数据，主要的数据有两个<code>history</code>和<code>location</code>，这两个对象主要封装了路由跳转的相关功能和路由的相关信息</p> 
<h4><a id="BrowserRouterHashRouter_83"></a>BrowserRouter和HashRouter</h4> 
<p>看完了Router的基本实现后，我们可以来看看BrowserRouter和HashRouter的实现了，</p> 
<ul><li>BrowserRouter</li></ul> 
<pre><code class="prism language-javascript">
<span class="token comment">// BrowserRouter packages/react-router-dom/modules/BrowserRouter.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react-router"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> createBrowserHistory <span class="token keyword">as</span> createHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"history"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> PropTypes <span class="token keyword">from</span> <span class="token string">"prop-types"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> warning <span class="token keyword">from</span> <span class="token string">"tiny-warning"</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">BrowserRouter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{<!-- --></span>
  history <span class="token operator">=</span> <span class="token function">createHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Router history<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">}</span> children<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

BrowserRouter<span class="token punctuation">.</span>propTypes <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  basename<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>string<span class="token punctuation">,</span>
  children<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>node<span class="token punctuation">,</span>
  forceRefresh<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>bool<span class="token punctuation">,</span>
  getUserConfirmation<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>func<span class="token punctuation">,</span>
  keyLength<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>number
<span class="token punctuation">}</span>

<span class="token comment">// HashRouter packages/react-router-dom/modules/HashRouter.js</span>
<span class="token keyword">class</span> <span class="token class-name">HashRouter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{<!-- --></span>
  history <span class="token operator">=</span> <span class="token function">createHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>Router history<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">}</span> children<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

 HashRouter<span class="token punctuation">.</span>propTypes <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
   basename<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>string<span class="token punctuation">,</span>
   children<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>node<span class="token punctuation">,</span>
   getUserConfirmation<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span>func<span class="token punctuation">,</span>
   hashType<span class="token punctuation">:</span> PropTypes<span class="token punctuation">.</span><span class="token function">oneOf</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"hashbang"</span><span class="token punctuation">,</span> <span class="token string">"noslash"</span><span class="token punctuation">,</span> <span class="token string">"slash"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>两个Router的实现非常简单，而且非常相似：创建一个history对象，然后渲染Router组件，但这里history对象是怎么创建出来的呢? 感兴趣的朋友可以看看这篇文章：<a href="https://blog.csdn.net/tangzhl/article/details/79696055%E3%80%82">https://blog.csdn.net/tangzhl/article/details/79696055。</a><br> 在这里我大致说一下他们的作用<br> <code>createBrowserHistory</code>是通过使用HTML5 history的API来实现路由的跳转(<code>pushState和replaceState</code>)并通过监听<code>popstate</code>事件路由变换，进而更新location对象(Router中提到，location对象封装了路由信息)，location对象的改变出发了组件的重新渲染，从而根据路由来渲染不同的组件<br> <code>createHashHistory</code>通过浏览器的hash来改变路由，然后监听<code>hashChange</code>事件监听hash的改版，然后出发location对象的改变，进而更新试图</p> 
<h4><a id="Route_131"></a>Route组件</h4> 
<p>我们常用route组件来进行路径和组件的匹配，所以我们来看看Route组件的实现<br> 我们先看看Route的不同使用方式</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">"xxx"</span> component<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>Xxx<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">"xxx"</span> render<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token operator">/</span>Xxx<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>Route path<span class="token operator">=</span><span class="token string">"xxx"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>Xxx <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Route<span class="token operator">&gt;</span>
</code></pre> 
<p>在来看源码，方便理解，都打上了注释，为了代码更新其，也删除了一些判断</p> 
<pre><code class="prism language-javascript"><span class="token comment">// /packages/react-router/modules/Switch.js</span>
<span class="token keyword">class</span> <span class="token class-name">Route</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
        <span class="token punctuation">{<!-- --></span>context <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
		  <span class="token comment">// 获取location对象 Router组件上面的</span>
          <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>location <span class="token operator">||</span> context<span class="token punctuation">.</span>location<span class="token punctuation">;</span>
          <span class="token comment">// 判断path和location是否对应</span>
          <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>computedMatch
            <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>computedMatch <span class="token comment">// &lt;Switch&gt; already computed the match for us</span>
            <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>path
              <span class="token operator">?</span> <span class="token function">matchPath</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span>  <span class="token comment">// 在这里判断path和locations是否对象</span>
              <span class="token punctuation">:</span> context<span class="token punctuation">.</span>match<span class="token punctuation">;</span>

          <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span>context<span class="token punctuation">,</span> location<span class="token punctuation">,</span> match <span class="token punctuation">}</span><span class="token punctuation">;</span>

	      <span class="token comment">// 获取Route上的对应的渲染组件,</span>
          <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> children<span class="token punctuation">,</span> component<span class="token punctuation">,</span> render <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
          <span class="token comment">// 判断是children长度是否为0</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            children <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

		  <span class="token comment">// 获取children</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> children <span class="token operator">===</span> <span class="token string">"function"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            children <span class="token operator">=</span> <span class="token function">children</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token punctuation">}</span>

          <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>RouterContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>props<span class="token punctuation">}</span><span class="token operator">&gt;</span>
              <span class="token punctuation">{<!-- --></span>children <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isEmptyChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span>
                <span class="token operator">?</span> children
                <span class="token punctuation">:</span> props<span class="token punctuation">.</span>match <span class="token comment">// 判断path与locaiton是否匹配，如果匹配则渲染component,否则返回null</span>
                  <span class="token operator">?</span> component
                    <span class="token operator">?</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> props<span class="token punctuation">)</span>
                    <span class="token punctuation">:</span> render
                      <span class="token operator">?</span> <span class="token function">render</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
                      <span class="token punctuation">:</span> <span class="token keyword">null</span>
                  <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>RouterContext<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Route工作核心步骤只有两三步，获取RouterContext的信息(<code>location对象</code>)，获取<code>path</code>和<code>component</code>属性，判断path和当前的location是否匹配，如果匹配，则渲染<code>component</code>，否则返回<code>null</code>，不渲染任何内容</p> 
<h4><a id="Switch_193"></a>Switch</h4> 
<pre><code class="prism language-javascript"><span class="token comment">// /packages/react-router/modules/Route.js</span>
<span class="token keyword">class</span> <span class="token class-name">Switch</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
        <span class="token punctuation">{<!-- --></span>context <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>

          <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>location <span class="token operator">||</span> context<span class="token punctuation">.</span>location<span class="token punctuation">;</span>

          <span class="token keyword">let</span> element<span class="token punctuation">,</span> match<span class="token punctuation">;</span>

          React<span class="token punctuation">.</span>Children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> child <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> React<span class="token punctuation">.</span><span class="token function">isValidElement</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              element <span class="token operator">=</span> child<span class="token punctuation">;</span>

              <span class="token keyword">const</span> path <span class="token operator">=</span> child<span class="token punctuation">.</span>props<span class="token punctuation">.</span>path <span class="token operator">||</span> child<span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">;</span>
			  <span class="token comment">// 判断Route的path和当前location是否匹配，如果匹配则渲染，否则不渲染</span>
              match <span class="token operator">=</span> path
                <span class="token operator">?</span> <span class="token function">matchPath</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">...</span>child<span class="token punctuation">.</span>props<span class="token punctuation">,</span> path <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">:</span> context<span class="token punctuation">.</span>match<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">return</span> match
            <span class="token operator">?</span> React<span class="token punctuation">.</span><span class="token function">cloneElement</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> location<span class="token punctuation">,</span> computedMatch<span class="token punctuation">:</span> match <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>Switch</code>组件实现很简单，遍历所有子元素(<code>Route</code>)，判断<code>Route</code>的<code>path</code>和location是否匹配，如果匹配，则渲染，否则不渲染。从代码可以看出，貌似<code>Switch</code>会渲染最后一个匹配的<code>Route</code></p> 
<h4><a id="Link_228"></a>Link组件</h4> 
<pre><code class="prism language-javascript"><span class="token comment">// /packages/react-router-dom/modules/Link.js</span>
<span class="token keyword">function</span> <span class="token function">LinkAnchor</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> innerRef<span class="token punctuation">,</span> navigate<span class="token punctuation">,</span> onClick<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> target <span class="token punctuation">}</span> <span class="token operator">=</span> rest<span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>a
      <span class="token punctuation">{<!-- --></span><span class="token operator">...</span>rest<span class="token punctuation">}</span>
      ref<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>innerRef<span class="token punctuation">}</span> <span class="token comment">// TODO: Use forwardRef instead</span>
      onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>event <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>onClick<span class="token punctuation">)</span> <span class="token function">onClick</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ex</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token operator">!</span>event<span class="token punctuation">.</span>defaultPrevented <span class="token operator">&amp;&amp;</span> <span class="token comment">// onClick prevented default</span>
          event<span class="token punctuation">.</span>button <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// ignore everything but left clicks</span>
          <span class="token punctuation">(</span><span class="token operator">!</span>target <span class="token operator">||</span> target <span class="token operator">===</span> <span class="token string">"_self"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// let browser handle "target=_blank" etc.</span>
          <span class="token operator">!</span><span class="token function">isModifiedEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token comment">// ignore clicks with modifier keys</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">navigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Link</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> component <span class="token operator">=</span> LinkAnchor<span class="token punctuation">,</span> replace<span class="token punctuation">,</span> to<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
      <span class="token punctuation">{<!-- --></span>context <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">invariant</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"You should not use &lt;Link&gt; outside a &lt;Router&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> history <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">;</span>

        <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">normalizeToLocation</span><span class="token punctuation">(</span>
          <span class="token function">resolveToLocation</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> context<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">,</span>
          context<span class="token punctuation">.</span>location
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> href <span class="token operator">=</span> location <span class="token operator">?</span> history<span class="token punctuation">.</span><span class="token function">createHref</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
          <span class="token operator">...</span>rest<span class="token punctuation">,</span>
          href<span class="token punctuation">,</span>
          <span class="token function">navigate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">resolveToLocation</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> context<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> method <span class="token operator">=</span> replace <span class="token operator">?</span> history<span class="token punctuation">.</span>replace <span class="token punctuation">:</span> history<span class="token punctuation">.</span>push<span class="token punctuation">;</span>

            <span class="token function">method</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从代码意义看出，<code>Link</code>组件本质就是<code>a</code>标签，它修改了<code>a</code>标签的默认行为，当点击Link时，会导航到对应的路由，导致<code>locaiton</code>对象的改变，出发组件的更新</p> 
<h4><a id="withRouter_293"></a>withRouter</h4> 
<p>withRouter是要高阶函数，对传入的组件进行加强，功能就是获取routerContext上面的信息，然后作为props传给需要加强的组件</p> 
<pre><code class="prism language-javascript"><span class="token comment">// /packages/react-router/modules/withRouter.js </span>
<span class="token keyword">function</span> <span class="token function">withRouter</span><span class="token punctuation">(</span>Component<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token function-variable function">C</span> <span class="token operator">=</span> props <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> wrappedComponentRef<span class="token punctuation">,</span> <span class="token operator">...</span>remainingProps <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
        <span class="token punctuation">{<!-- --></span>context <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>Component
              <span class="token punctuation">{<!-- --></span><span class="token operator">...</span>remainingProps<span class="token punctuation">}</span>
              <span class="token punctuation">{<!-- --></span><span class="token operator">...</span>context<span class="token punctuation">}</span>
              ref<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>wrappedComponentRef<span class="token punctuation">}</span>
            <span class="token operator">/</span><span class="token operator">&gt;</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>RouterContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
 <span class="token keyword">return</span> <span class="token function">hoistStatics</span><span class="token punctuation">(</span><span class="token constant">C</span><span class="token punctuation">,</span> Component<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_319"></a>总结</h4> 
<p>React-Router博大精深，同志仍需努力</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1d47b0ed8013e5c3286679b29248abd4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">react native 安卓中headerTitle居中对齐</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1adbe2d3ad9fc73e74bdb8100148926f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">最全的LBS手机定位技术说明</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>