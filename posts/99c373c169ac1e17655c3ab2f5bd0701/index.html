<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>无人机——像素坐标系转世界坐标系（NED） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="无人机——像素坐标系转世界坐标系（NED）" />
<meta property="og:description" content=" 目录
前言
一、针孔相机的原理
二、像素坐标系转相机坐标系
三、相机坐标系转机体坐标系
四、机体坐标系转世界坐标系（NED）
前言 正文开始前先推荐我做这个坐标系转换受益最深的一本书《视觉SLAM14讲》，为什么要推荐这本书，首先这本书详细介绍了视觉slam的结构，从前端VO到后端Optimization到回环检测最后建图，十分详细并且通俗易懂。
我还没有读完这本书，因为最近正在做一个比赛，其中一项工作是做了一个圆圈检测，要将检测结果从像素坐标系转换到NED坐标系，起初找了别人的源码，但是还是想从原理上理解这个坐标系变换，所以我细读了《视觉SLAM14讲》这本书的第五讲“相机与图像”，从针孔相机的原理开始了解最后转换到世界坐标系。
整体的转换流程：
本人初次撰写博客，若全文有不当或者不合理之处，请予批评指正 一、针孔相机的原理 话不多说，先细说针孔相机的原理，为什么要介绍这个原理，因为这个原理让我认识清楚了相机内参（fx，fy，cx，cy）的含义，以及我们为什么要在使用相机前做矫正。
首先借用《视觉SLAM14讲》P97中的一张图：
左边的图大家应该很熟悉，和初二物理课本上的图很像，右边的图相当于左边图的俯视图（从上往下看），所以没有考虑y轴分量。这张图已经包含了整个转换过程的前两个坐标系，像素坐标系和相机坐标系。
二、像素坐标系转相机坐标系 现实中的点为,可以认为P在相机坐标系下，经过针孔投影后的点为，P’可以认为在像素坐标系下，但是要注意这个像素坐标系不是我们实际使用的像素坐标系，两者之间还相差缩放以及平移关系，这也就是相机内参的含义，后文将会详细介绍。还有一个比较重要的物理量是焦距(f),即相机光心O到成像平面的距离。
根据上图中的相似三角形的关系很容易可以得到：
对上式进行一个变换，将成像平面的坐标点放在左边：
到这一步，像素坐标系到相机坐标系的转换已经完成了一半，还差一个成像平面到像素坐标系的缩放平移。一般像素坐标系定义为o-u-v,其中o是像素坐标系的原点，位于图像的左上角，u轴与成像平面的x轴平行，v轴与成像平面的y轴平行，这个对于熟悉opencv的同学应该很熟悉。然后我们需要定义成像平面到像素坐标系的缩放平移关系，这里一定要弄明白，相机内参就是来源于此，缩放关系：我们假设像素坐标在u轴上缩放了α倍，在v轴上缩放了β倍，这里α和β的单位都是像素/m，因为成像平面和相机坐标系的点都是以m为单位的，平移关系：像素坐标系相对于成像平面平移了，那么成像平面P&#39;的坐标和像素坐标系的关系如下：
将上式代入其中即可得到：
将αf合并成为，βf合并成为，那么上式就可以转换为：
再将其写成矩阵相乘的形式。
对于上式，定义相机内参矩阵K：
那么上式可以简化为：
将上式做一个简单的变形：
上式就是像素坐标系转相机坐标系的表达式，可以看出一个点要想从像素坐标系转换到相机坐标系需要三个信息，首先是该点在像素坐标系下的坐标,然后需要相机的内参矩阵K，最后一个需要的就是深度信息Z，即该点在相机坐标系下Z轴的分量，如果你使用的是单目相机，那么有单目测距的手段，如果你使用的是双目相机，有双目测距的手段，如果你使用的是RGBD相机，那么直接就可以获取深度信息，如此一下，像素坐标系转相机坐标系就完成了。
三、相机坐标系转机体坐标系 首先相机坐标系转机体坐标系并不存在平移的关系，只是定义的不同，相机坐标系满足右手定则，机体坐标系满足左手定则：
所以两者之间只需要一个简单的转换矩阵，定义机体坐标系下的点为，定义相机坐标系下的点为，定义相机坐标系到机体坐标系的转换矩阵为:
那么从相机坐标系到机体坐标系的转换如下：
四、机体坐标系转世界坐标系（NED） 首先要理清，机体坐标系是与机体固连的，随着飞机的飞行，机体坐标系的原点以及对应的x,y,z三轴的方向都会发生相应的变化，而世界坐标系（此处我们以NED坐标系，即北东地坐标系为例）的原点以及三轴方向不会发生变化，两者之间相差的就是飞机的位姿关系，位姿即飞机的位置信息和姿态信息（在NED坐标系下），这个信息可以依靠视觉里程计得到，而位姿信息我们一般用旋转矩阵R和平移向量t来描述，旋转矩阵描述的就是姿态信息，通过四元数或者欧拉角都可以得到旋转矩阵，而位置信息就是飞机在NED坐标系下的位置，那么机体坐标系下的某个点在NED坐标系下即可表示为：
至此，坐标系转换全部完成！ " />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/99c373c169ac1e17655c3ab2f5bd0701/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-26T09:54:41+08:00" />
<meta property="article:modified_time" content="2022-09-26T09:54:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">无人机——像素坐标系转世界坐标系（NED）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E5%89%8D%E8%A8%80-toc" style="margin-left:40px;"><a href="#%E5%89%8D%E8%A8%80" rel="nofollow">前言</a></p> 
<p id="%E4%B8%80%E3%80%81%E9%92%88%E5%AD%94%E7%9B%B8%E6%9C%BA%E7%9A%84%E5%8E%9F%E7%90%86-toc" style="margin-left:40px;"><a href="#%E4%B8%80%E3%80%81%E9%92%88%E5%AD%94%E7%9B%B8%E6%9C%BA%E7%9A%84%E5%8E%9F%E7%90%86" rel="nofollow">一、针孔相机的原理</a></p> 
<p id="%E4%BA%8C%E3%80%81%E5%83%8F%E7%B4%A0%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E7%9B%B8%E6%9C%BA%E5%9D%90%E6%A0%87%E7%B3%BB-toc" style="margin-left:40px;"><a href="#%E4%BA%8C%E3%80%81%E5%83%8F%E7%B4%A0%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E7%9B%B8%E6%9C%BA%E5%9D%90%E6%A0%87%E7%B3%BB" rel="nofollow">二、像素坐标系转相机坐标系</a></p> 
<p id="%E4%B8%89%E3%80%81%E7%9B%B8%E6%9C%BA%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E6%9C%BA%E4%BD%93%E5%9D%90%E6%A0%87%E7%B3%BB-toc" style="margin-left:40px;"><a href="#%E4%B8%89%E3%80%81%E7%9B%B8%E6%9C%BA%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E6%9C%BA%E4%BD%93%E5%9D%90%E6%A0%87%E7%B3%BB" rel="nofollow">三、相机坐标系转机体坐标系</a></p> 
<p id="%C2%A0%E5%9B%9B%E3%80%81%E6%9C%BA%E4%BD%93%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E4%B8%96%E7%95%8C%E5%9D%90%E6%A0%87%E7%B3%BB%EF%BC%88NED%EF%BC%89-toc" style="margin-left:40px;"><a href="#%C2%A0%E5%9B%9B%E3%80%81%E6%9C%BA%E4%BD%93%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E4%B8%96%E7%95%8C%E5%9D%90%E6%A0%87%E7%B3%BB%EF%BC%88NED%EF%BC%89" rel="nofollow">四、机体坐标系转世界坐标系（NED）</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h3 id="%E5%89%8D%E8%A8%80">前言</h3> 
<p>正文开始前先推荐我做这个坐标系转换受益最深的一本书《视觉SLAM14讲》，为什么要推荐这本书，首先这本书详细介绍了视觉slam的结构，从前端VO到后端Optimization到回环检测最后建图，十分详细并且通俗易懂。</p> 
<p>我还没有读完这本书，因为最近正在做一个比赛，其中一项工作是做了一个圆圈检测，要将检测结果从像素坐标系转换到NED坐标系，起初找了别人的源码，但是还是想从原理上理解这个坐标系变换，所以我细读了《视觉SLAM14讲》这本书的第五讲“相机与图像”，从针孔相机的原理开始了解最后转换到世界坐标系。</p> 
<p>整体的转换流程：</p> 
<p class="img-center"><img alt="" height="251" src="https://images2.imgbox.com/cb/de/9iCLiGOd_o.png" width="121"></p> 
<p>本人初次撰写博客，若全文有不当或者不合理之处，请予批评指正 </p> 
<h3 id="%E4%B8%80%E3%80%81%E9%92%88%E5%AD%94%E7%9B%B8%E6%9C%BA%E7%9A%84%E5%8E%9F%E7%90%86">一、针孔相机的原理</h3> 
<p>话不多说，先细说针孔相机的原理，为什么要介绍这个原理，因为这个原理让我认识清楚了相机内参（fx，fy，cx，cy）的含义，以及我们为什么要在使用相机前做矫正。</p> 
<p>首先借用《视觉SLAM14讲》P97中的一张图：</p> 
<p class="img-center"><img alt="" height="318" src="https://images2.imgbox.com/a3/f6/t44kO5Yb_o.png" width="690"></p> 
<p> 左边的图大家应该很熟悉，和初二物理课本上的图很像，右边的图相当于左边图的俯视图（从上往下看），所以没有考虑y轴分量。这张图已经包含了整个转换过程的前两个坐标系，像素坐标系和相机坐标系。</p> 
<h3 id="%E4%BA%8C%E3%80%81%E5%83%8F%E7%B4%A0%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E7%9B%B8%E6%9C%BA%E5%9D%90%E6%A0%87%E7%B3%BB">二、像素坐标系转相机坐标系</h3> 
<p>现实中的点为<img alt="P[X,Y,Z]^{T}" class="mathcode" src="https://images2.imgbox.com/57/23/Sonfe0iF_o.png">,可以认为P在相机坐标系下，经过针孔投影后的点为<img alt="P'[X',Y',Z']^{T}" class="mathcode" src="https://images2.imgbox.com/a8/a4/jmPPCdE0_o.png">，P’可以认为在像素坐标系下，<strong>但是要注意这个像素坐标系不是我们实际使用的像素坐标系，两者之间还相差缩放以及平移关系</strong>，这也就是相机内参的含义，后文将会详细介绍。还有一个比较重要的物理量是焦距(f),即相机光心O到成像平面的距离。</p> 
<p> 根据上图中的相似三角形的关系很容易可以得到：</p> 
<p style="text-align:center;"><img alt="\frac{Z}{f}=\frac{X}{X'}=\frac{Y}{Y'}" class="mathcode" src="https://images2.imgbox.com/4b/74/RTLLdGON_o.png"></p> 
<p>对上式进行一个变换，将成像平面的坐标点放在左边：</p> 
<p style="text-align:center;"><img alt="X' = f \frac{X}{Z}" class="mathcode" src="https://images2.imgbox.com/66/10/XUtCYkLV_o.png"></p> 
<p style="text-align:center;"><img alt="Y' = f\frac{Y}{Z}" class="mathcode" src="https://images2.imgbox.com/69/8e/475YRfEn_o.png"></p> 
<p> 到这一步，像素坐标系到相机坐标系的转换已经完成了一半，还差一个成像平面到像素坐标系的缩放平移。一般像素坐标系定义为o-u-v,其中o是像素坐标系的原点，位于图像的左上角，u轴与成像平面的x轴平行，v轴与成像平面的y轴平行，这个对于熟悉opencv的同学应该很熟悉。然后我们需要定义成像平面到像素坐标系的<strong>缩放平移关系</strong>，这里一定要弄明白，相机内参就是来源于此，<strong>缩放关系：</strong>我们假设像素坐标在u轴上缩放了α倍，在v轴上缩放了β倍，这里α和β的单位都是像素/m，因为成像平面和相机坐标系的点都是以m为单位的，<strong>平移关系：</strong>像素坐标系相对于成像平面平移了<img alt="[cx,cy]^{T}" class="mathcode" src="https://images2.imgbox.com/93/20/zkp2FZji_o.png">，那么成像平面P'的坐标和像素坐标系<img alt="[u,v]^{T}" class="mathcode" src="https://images2.imgbox.com/7a/5b/ReNXVcwh_o.png">的关系如下：</p> 
<p style="text-align:center;"><img alt="\begin{cases}u =\alpha X' + c_{x}\\ v =\beta Y'+ c_{y}\\ \end{cases}" class="mathcode" src="https://images2.imgbox.com/04/62/MR3F24Nj_o.png"></p> 
<p>将上式代入其中即可得到：</p> 
<p style="text-align:center;"><img alt="\begin{cases}u = \alpha f\frac{X}{Z} + c_{x}\\ v = \beta f\frac{Y}{Z}+ c_{y}\\ \end{cases}" class="mathcode" src="https://images2.imgbox.com/5f/76/rijedRiL_o.png"></p> 
<p>将αf合并成为<img alt="f_{x}" class="mathcode" src="https://images2.imgbox.com/5c/33/MGZle1n8_o.png">，βf合并成为<img alt="f_{y}" class="mathcode" src="https://images2.imgbox.com/8c/2e/496U7kMc_o.png">，那么上式就可以转换为：</p> 
<p style="text-align:center;"><img alt="\begin{cases}u = f_{x}\frac{X}{Z} + c_{x}\\ v = f_{y} \frac{Y}{Z}+ c_{y}\\ \end{cases}" class="mathcode" src="https://images2.imgbox.com/57/ef/Cq5p5Gyn_o.png"></p> 
<p>再将其写成矩阵相乘的形式。</p> 
<p style="text-align:center;"><img alt="\begin{bmatrix} u\\ v\\ 1 \end{bmatrix} = \frac{1}{Z}\begin{bmatrix} f_{x} &amp; 0 &amp;c_{x} \\ 0&amp;f_{y} &amp; c_{y}\\ 0&amp;0 &amp;1 \end{bmatrix}\begin{bmatrix} X\\ Y\\ Z \end{bmatrix}" class="mathcode" src="https://images2.imgbox.com/a6/de/L3DP3IqQ_o.png"></p> 
<p>对于上式<img alt="P[X,Y,Z]^{T}" class="mathcode" src="https://images2.imgbox.com/d0/43/28hXu05z_o.png">，定义<strong>相机内参矩阵K</strong>：</p> 
<p style="text-align:center;"><img alt="K = \begin{bmatrix} f_{x} &amp; 0 &amp;c_{x} \\ 0&amp;f_{y} &amp; c_{y}\\ 0&amp;0 &amp;1 \end{bmatrix}" class="mathcode" src="https://images2.imgbox.com/73/3f/MGVaI8mV_o.png"></p> 
<p>那么上式可以简化为：</p> 
<p style="text-align:center;"><img alt="\begin{bmatrix} u\\ v\\ 1 \end{bmatrix} = \frac{1}{Z}KP" class="mathcode" src="https://images2.imgbox.com/fb/0d/zMU5PyXp_o.png"></p> 
<p>将上式做一个简单的变形：</p> 
<p style="text-align:center;"> <img alt="P = ZK^{-1}\begin{bmatrix} u\\ v\\ 1 \end{bmatrix}" class="mathcode" src="https://images2.imgbox.com/42/ff/qbKzs6Vc_o.png"></p> 
<p>上式就是像素坐标系转相机坐标系的表达式，可以看出一个点要想从像素坐标系转换到相机坐标系需要三个信息，首先是该点在像素坐标系下的坐标<img alt="(u,v)^{T}" class="mathcode" src="https://images2.imgbox.com/8b/bb/zxBiHRCh_o.png">,然后需要相机的内参矩阵K，最后一个需要的就是深度信息Z，即该点在相机坐标系下Z轴的分量，如果你使用的是单目相机，那么有单目测距的手段，如果你使用的是双目相机，有双目测距的手段，如果你使用的是RGBD相机，那么直接就可以获取深度信息，如此一下，像素坐标系转相机坐标系就完成了。</p> 
<h3 id="%E4%B8%89%E3%80%81%E7%9B%B8%E6%9C%BA%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E6%9C%BA%E4%BD%93%E5%9D%90%E6%A0%87%E7%B3%BB">三、相机坐标系转机体坐标系</h3> 
<p>首先相机坐标系转机体坐标系并不存在平移的关系，只是定义的不同，相机坐标系满足右手定则，机体坐标系满足左手定则：</p> 
<p class="img-center"><img alt="" height="223" src="https://images2.imgbox.com/c8/fd/zLr3bCIX_o.png" width="409"></p> 
<p> 所以两者之间只需要一个简单的转换矩阵，定义机体坐标系下的点为<img alt="P_{b}" class="mathcode" src="https://images2.imgbox.com/1e/35/aLbxQhxM_o.png">，定义相机坐标系下的点为<img alt="P_{c}" class="mathcode" src="https://images2.imgbox.com/f9/5a/ZA5ubbar_o.png">，定义相机坐标系到机体坐标系的转换矩阵为<img alt="R_{c2b}" class="mathcode" src="https://images2.imgbox.com/9d/27/0GRusw2R_o.png">:</p> 
<p style="text-align:center;"><img alt="R_{c2b} = \begin{bmatrix} 0 &amp;1 &amp;0 \\ 0&amp; 0 &amp; 1\\ 1&amp; 0 &amp;0 \end{bmatrix}" class="mathcode" src="https://images2.imgbox.com/d8/be/3xvR17M7_o.png"></p> 
<p>那么从相机坐标系到机体坐标系的转换如下：</p> 
<p style="text-align:center;"><img alt="P_{b} = R_{c2b}P_{c}" class="mathcode" src="https://images2.imgbox.com/e5/85/fIbPphEa_o.png"></p> 
<h3 id="%C2%A0%E5%9B%9B%E3%80%81%E6%9C%BA%E4%BD%93%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E4%B8%96%E7%95%8C%E5%9D%90%E6%A0%87%E7%B3%BB%EF%BC%88NED%EF%BC%89">四、机体坐标系转世界坐标系（NED）</h3> 
<p>首先要理清，机体坐标系是与机体固连的，随着飞机的飞行，机体坐标系的原点以及对应的x,y,z三轴的方向都会发生相应的变化，而世界坐标系（此处我们以NED坐标系，即北东地坐标系为例）的原点以及三轴方向不会发生变化，两者之间相差的就是飞机的位姿关系，<strong>位姿</strong>即飞机的位置信息和姿态信息（在NED坐标系下），这个信息可以依靠视觉里程计得到，而位姿信息我们一般用<strong>旋转矩阵R</strong>和<strong>平移向量t</strong>来描述，旋转矩阵描述的就是姿态信息，通过四元数或者欧拉角都可以得到旋转矩阵，而位置信息就是飞机在NED坐标系下的位置，那么机体坐标系下的某个点<img alt="P_{b}" class="mathcode" src="https://images2.imgbox.com/c0/39/BDYVSPBf_o.png">在NED坐标系下即可表示为：</p> 
<p style="text-align:center;"><img alt="P_{NED} = RP_{b} + t" class="mathcode" src="https://images2.imgbox.com/94/64/imusdmET_o.png"></p> 
<p>至此，坐标系转换全部完成！ </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b19974415a84578ec1a8ebd3fd03f015/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">图片格式，内联框架，音视频的插入播放</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9dda9208bc17564ed61f109f8ffae7af/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CentOS下安装mysql8.0</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>