<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C&#43;&#43;基础--完善Socket C/S ，实现客户端，服务器端断开重连 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C&#43;&#43;基础--完善Socket C/S ，实现客户端，服务器端断开重连" />
<meta property="og:description" content="原文地址::http://www.cnblogs.com/kingdom_0/articles/2571727.html
相关文章
1、socket连接，判断连接中断，如果中断，并自动重连。----http://blog.csdn.net/yoland/article/details/6448139
2、关于socket判断连接断开并重连----http://blog.csdn.net/tengxiaoming/article/details/5842307
3、讨论一种可靠的socket断线重连方法----http://bbs.csdn.net/topics/390800788?page=1
4、Socket连接问题，高难度的，解决后对大家也有好处----http://bbs.csdn.net/topics/80185609
1 // WindowsSocketServer.cpp : 定义控制台应用程序的入口点。 2 // 3 4 #include &#34;stdafx.h&#34; 5 #include &lt;iostream&gt; 6 #include &lt;string&gt; 7 #include &lt;Windows.h&gt; 8 #include &lt;Winsock2.h&gt; 9 #include &lt;fstream&gt; 10 #pragma comment(lib,&#34;Ws2_32.lib&#34;) 11 12 using namespace std; 13 #define PORT 8080 14 #define IP_ADDRESS &#34;172.16.20.181&#34; 15 CRITICAL_SECTION cs; 16 //#define CLIENT_PORT 8081 17 ///#define CLIENT_IP_ADDRESS &#34;172.16.20.181&#34; 18 19 //接收每个客户端连接的处理函数 20 DWORD WINAPI ClientThread(LPVOID lpParameter); 21 22 //连接和服务器端有连接的客户端 23 DWORD WINAPI ConnectClientsThread(LPVOID lpParameter); 24 25 int main(int argc, char* argv[]) 26 { 27 //HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE); 28 //SetConsoleTextAttribute(hConsole,FOREGROUND_GREEN); 29 InitializeCriticalSection(&amp;cs); 30 //初始化事件和关键段，自动置位，初始无触发的匿名事件 31 //g_hThreadEvent = CreateEvent(NULL,FALSE,FALSE,NULL); 32 33 //system(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f72b7c78103edc5354da2b5ff891f666/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-01-10T14:03:53+08:00" />
<meta property="article:modified_time" content="2018-01-10T14:03:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C&#43;&#43;基础--完善Socket C/S ，实现客户端，服务器端断开重连</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>原文地址::<a target="_blank" href="http://www.cnblogs.com/kingdom_0/articles/2571727.html" rel="nofollow noopener noreferrer"><u><span style="color:#0066cc">http://www.cnblogs.com/kingdom_0/articles/2571727.html</span></u></a></p> 
<p><u></u><span style="color:#0066cc"></span><br> </p> 
<p>相关文章</p> 
<p>1、<a target="_blank" href="http://blog.csdn.net/yoland/article/details/6448139" style="color:rgb(102,102,102); text-decoration:none; margin:0px; padding:0px; font-family:'Microsoft YaHei'; font-size:20px; line-height:30px" rel="noopener noreferrer">socket连接，判断连接中断，如果中断，并自动重连。</a>----<a target="_blank" href="http://blog.csdn.net/yoland/article/details/6448139" rel="noopener noreferrer"><u><span style="color:#0066cc">http://blog.csdn.net/yoland/article/details/6448139</span></u></a></p> 
<p>2、<a target="_blank" href="http://blog.csdn.net/tengxiaoming/article/details/5842307" style="color:rgb(102,102,102); text-decoration:none; margin:0px; padding:0px; font-family:'Microsoft YaHei'; font-size:20px; line-height:30px" rel="noopener noreferrer">关于socket判断连接断开并重连</a>----<a target="_blank" href="http://blog.csdn.net/tengxiaoming/article/details/5842307" rel="noopener noreferrer"><u><span style="color:#0066cc">http://blog.csdn.net/tengxiaoming/article/details/5842307</span></u></a></p> 
<p>3、讨论一种可靠的socket断线重连方法----<a target="_blank" href="http://bbs.csdn.net/topics/390800788?page=1" rel="noopener noreferrer"><u><span style="color:#0066cc">http://bbs.csdn.net/topics/390800788?page=1</span></u></a></p> 
<p>4、Socket连接问题，高难度的，解决后对大家也有好处----<a target="_blank" href="http://bbs.csdn.net/topics/80185609" rel="noopener noreferrer"><u><span style="color:#0066cc">http://bbs.csdn.net/topics/80185609</span></u></a></p> 
<p><u></u><span style="color:#0066cc"></span><br> </p> 
<p><u></u><span style="color:#0066cc"></span><br> </p> 
<p><u><span style="color:#0066cc"><br> </span></u><br> </p> 
<div class="cnblogs_code" style="margin:5px 0px; padding:5px; border:1px solid rgb(204,204,204); overflow:auto; font-family:'Courier New'!important; background-color:rgb(245,245,245)"> 
 <pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; font-family:'Courier New'!important"><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  1</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important"> WindowsSocketServer.cpp : 定义控制台应用程序的入口点。
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  2</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  3</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  4</span> #include <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">stdafx.h</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  5</span> #include &lt;iostream&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  6</span> #include &lt;<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span>&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  7</span> #include &lt;Windows.h&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  8</span> #include &lt;Winsock2.h&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  9</span> #include &lt;fstream&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 10</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#pragma</span> comment(lib,"Ws2_32.lib")
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 11</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 12</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">using</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">namespace</span><span style="margin:0px; padding:0px; line-height:1.5!important"> std;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 13</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#define</span> PORT 8080
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 14</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#define</span> IP_ADDRESS "172.16.20.181"
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 15</span> <span style="margin:0px; padding:0px; line-height:1.5!important">CRITICAL_SECTION cs;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 16</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">#define CLIENT_PORT 8081</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 17</span> <span style="margin:0px; padding:0px; color:rgb(128,128,128); line-height:1.5!important">///</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">#define CLIENT_IP_ADDRESS "172.16.20.181"</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 18</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 19</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">接收每个客户端连接的处理函数</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 20</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI ClientThread(LPVOID lpParameter);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 21</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 22</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">连接和服务器端有连接的客户端</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 23</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI ConnectClientsThread(LPVOID lpParameter);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 24</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 25</span>   <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> main(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> argc, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">char</span>*<span style="margin:0px; padding:0px; line-height:1.5!important"> argv[])
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 26</span> <span style="margin:0px; padding:0px; line-height:1.5!important">  {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 27</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 28</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">SetConsoleTextAttribute(hConsole,FOREGROUND_GREEN); </span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 29</span>       InitializeCriticalSection(&amp;<span style="margin:0px; padding:0px; line-height:1.5!important">cs);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 30</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">初始化事件和关键段，自动置位，初始无触发的匿名事件
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 31</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">g_hThreadEvent = CreateEvent(NULL,FALSE,FALSE,NULL);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 32</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 33</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">system("ipconfig /all &gt;log.txt");
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 34</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">WSADATA 结构体主要包含了系统所支持的Winsock版本信息</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 35</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      WSADATA  Ws;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 36</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      SOCKET ServerSocket, ClientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 37</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">TCP/IP 套接字指定套接字的地址</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 38</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> sockaddr_in LocalAddr, ClientAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 39</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> Ret = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 40</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> AddrLen = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 41</span>       HANDLE hThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 42</span>       HANDLE hConnectThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 43</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Init Windows Socket
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 44</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The WSAStartup function initiates use of WS2_32.DLL by a process.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 45</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">初始化Winsock2.2.使用WSAStartup函数
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 46</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">第一个参数是所要用的Winsock版本号
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 47</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The MAKEWORD macro creates a WORD value by concatenating the specified values. 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 48</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">第二个参数就是WSADATA 结构体的指针。如果初始化成功则返回0
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 49</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">要注意任何WinsockAPI函数都必须在初始化后使用，包括错误检查函数</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 50</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( WSAStartup(MAKEWORD(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>), &amp;Ws) != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 51</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 52</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">初始化 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 53</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 54</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 55</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Create Socket</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 56</span>       ServerSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 57</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( ServerSocket ==<span style="margin:0px; padding:0px; line-height:1.5!important"> INVALID_SOCKET )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 58</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 59</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">创建 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 60</span>           system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 61</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 62</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 63</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 64</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">the address of family specification</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 65</span>       LocalAddr.sin_family =<span style="margin:0px; padding:0px; line-height:1.5!important"> AF_INET;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 66</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 67</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The inet_addr function converts a string containing an (Ipv4) Internet Protocol dotted address into a proper address for the IN_ADDR structure.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 68</span>       LocalAddr.sin_addr.s_addr =<span style="margin:0px; padding:0px; line-height:1.5!important"> inet_addr(IP_ADDRESS); 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 69</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 70</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The htons function converts a u_short from host to TCP/IP network byte order (which is big-endian).</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 71</span>       LocalAddr.sin_port =<span style="margin:0px; padding:0px; line-height:1.5!important"> htons(PORT);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 72</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 73</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Sets buffers to a specified character.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 74</span>       memset(LocalAddr.sin_zero, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0x00</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">8</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 75</span>   
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 76</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Bind Socket,The bind function associates a local address with a socket.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 77</span>       Ret = bind(ServerSocket, (<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;LocalAddr, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(LocalAddr));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 78</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( Ret != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 79</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 80</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">绑定 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 81</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 82</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 83</span>     
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 84</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The listen function places a socket in a state in which it is listening for an incoming connection.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 85</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">listen 命令套接字监听来自客户端的连接.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 86</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">第二个参数是最大连接数.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 87</span>       Ret = listen(ServerSocket, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">10</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 88</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( Ret != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 89</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 90</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">监听 Client Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 91</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 92</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 93</span>     
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 94</span>       cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">服务端已经启动，正在监听</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 95</span>     
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 96</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">创建重连或连接客户端子线程</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 97</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">/*</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">hConnectThread = CreateThread(NULL,0,ConnectClientsThread,NULL,0,NULL);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 98</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">     if( hConnectThread == NULL )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 99</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">100</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">         cout&lt;&lt;"创建重连客户端线程失败"&lt;&lt;endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">101</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">         system("pause");
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">102</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">     }</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">*/</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">103</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span> ( <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">true</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">104</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">105</span>           AddrLen = <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(ClientAddr);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">106</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">107</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The accept function permits an incoming connection attempt on a socket.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">108</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">接收即将到来的客户端连接。</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">109</span>           ClientSocket = accept(ServerSocket, (<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;ClientAddr, &amp;<span style="margin:0px; padding:0px; line-height:1.5!important">AddrLen);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">110</span>         
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">111</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( ClientSocket ==<span style="margin:0px; padding:0px; line-height:1.5!important"> INVALID_SOCKET )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">112</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">113</span>               cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">接收客户端消息失败 :</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">114</span>               system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">115</span>               <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">break</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">116</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">117</span>           EnterCriticalSection(&amp;<span style="margin:0px; padding:0px; line-height:1.5!important">cs);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">118</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The inet_ntoa function converts an (Ipv4) Internet network address into a string in Internet standard dotted format.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">119</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">\n客户端连接 :</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;inet_ntoa(ClientAddr.sin_addr)&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;ClientAddr.sin_port&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">120</span>           LeaveCriticalSection(&amp;<span style="margin:0px; padding:0px; line-height:1.5!important">cs);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">121</span>           <span style="margin:0px; padding:0px; color:rgb(128,128,128); line-height:1.5!important">///</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">/创建文件流，写入数据</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">122</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">ofstream outfile("D:\\clientIps.txt");
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">123</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">outfile&lt;&lt;inet_ntoa(ClientAddr.sin_addr)&lt;&lt;":"&lt;&lt;ClientAddr.sin_port&lt;&lt;"\n";
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">124</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">outfile.close();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">125</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">126</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Call this function to create a thread that can use CRT functions.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">127</span>           hThread = CreateThread(NULL, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span>, ClientThread, (LPVOID)ClientSocket, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">, NULL);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">128</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">WaitForSingleObject(g_hThreadEvent,INFINITE);</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">129</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( hThread ==<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">130</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">131</span>               cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">创建线程失败!</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">132</span>               system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">133</span>               <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">break</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">134</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">135</span>           
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">136</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          CloseHandle(hThread);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">137</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">138</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">销毁关键段</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">139</span>       DeleteCriticalSection(&amp;<span style="margin:0px; padding:0px; line-height:1.5!important">cs);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">140</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">141</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">关闭套接字，并释放套接字描述符</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">142</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     closesocket(ServerSocket);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">143</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     closesocket(ClientSocket);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">144</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">最初这个函数也许有些拥簇，现在保留它只是为了向后兼容。
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">145</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">但是调用它可能会更安全，可能某些实现会使用它来结束ws2_32.DLL</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">146</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     WSACleanup();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">147</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">148</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">149</span> <span style="margin:0px; padding:0px; line-height:1.5!important"> }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">150</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">151</span> <span style="margin:0px; padding:0px; line-height:1.5!important"> DWORD WINAPI ConnectClientsThread(LPVOID lpParameter)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">152</span> <span style="margin:0px; padding:0px; line-height:1.5!important"> {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">153</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    WSADATA  Ws;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">154</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     SOCKET ServerSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">155</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> sockaddr_in ClientAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">156</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> Ret = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">157</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> AddrLen = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">158</span>      
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">159</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The WSAStartup function initiates use of WS2_32.DLL by a process.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">160</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">初始化 Windows Socket</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">161</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( WSAStartup(MAKEWORD(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>), &amp;Ws) != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">162</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">163</span>          cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">ConnectClients 初始化 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">164</span>          <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">165</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">166</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">创建 Socket
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">167</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">TCP 传输</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">168</span>      ServerSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">169</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( ServerSocket ==<span style="margin:0px; padding:0px; line-height:1.5!important"> INVALID_SOCKET )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">170</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">171</span>          cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">ConnectClients 创建 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">172</span>          <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">173</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">174</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span><span style="margin:0px; padding:0px; line-height:1.5!important"> line;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">175</span>      ifstream myfile(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">D:\\clientIps.txt</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">176</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span><span style="margin:0px; padding:0px; line-height:1.5!important">(myfile.is_open())
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">177</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {    
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">178</span>          <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span>(!<span style="margin:0px; padding:0px; line-height:1.5!important">myfile.eof())
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">179</span> <span style="margin:0px; padding:0px; line-height:1.5!important">         {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">180</span> <span style="margin:0px; padding:0px; line-height:1.5!important">             getline(myfile,line);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">181</span>             <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important"> cout&lt;&lt;"Msg:"&lt;&lt;line&lt;&lt;endl;</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">182</span>              <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> index = (<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span>)(line.find(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">'</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">'</span><span style="margin:0px; padding:0px; line-height:1.5!important">));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">183</span>              <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>(index &gt;=<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span>  &amp;&amp; line.length() &gt; <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">184</span> <span style="margin:0px; padding:0px; line-height:1.5!important">             {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">185</span>                  <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span> clientIp = line.substr(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">,index);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">186</span>                  <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span> clientPort = line.substr(index+<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">187</span>                  ClientAddr.sin_family =<span style="margin:0px; padding:0px; line-height:1.5!important"> AF_INET;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">188</span>                  ClientAddr.sin_addr.s_addr =<span style="margin:0px; padding:0px; line-height:1.5!important"> inet_addr(clientIp.c_str());
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">189</span>                  ClientAddr.sin_port = htons((unsigned <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">short</span><span style="margin:0px; padding:0px; line-height:1.5!important">)clientPort.c_str());
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">190</span>                 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">191</span>                  <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">设置ServerAddr中前8个字符为0x00</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">192</span>                  memset(ClientAddr.sin_zero, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0x00</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">8</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">193</span>                 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">194</span>                  Ret = connect(ServerSocket,(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;ClientAddr, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(ClientAddr));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">195</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">196</span>                 <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( Ret ==<span style="margin:0px; padding:0px; line-height:1.5!important"> SOCKET_ERROR )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">197</span> <span style="margin:0px; padding:0px; line-height:1.5!important">                {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">198</span>                     cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">服务端的方法 ConnectClients 在 建立与:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;clientIp&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;clientPort&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">连接过程发生错误:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">199</span> <span style="margin:0px; padding:0px; line-height:1.5!important">                }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">200</span>                 <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">201</span> <span style="margin:0px; padding:0px; line-height:1.5!important">                {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">202</span>                     cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">连接建立成功</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">203</span> <span style="margin:0px; padding:0px; line-height:1.5!important">                }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">204</span> <span style="margin:0px; padding:0px; line-height:1.5!important">             }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">205</span> <span style="margin:0px; padding:0px; line-height:1.5!important">         }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">206</span>          cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">文件读取结束</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">207</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">208</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">209</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">210</span>          cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">文件打开失败</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">211</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">212</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">213</span> <span style="margin:0px; padding:0px; line-height:1.5!important"> }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">214</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">/*</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">215</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">    接收客户端连接创建的子线程处理函数
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">216</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">*/</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">217</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI ClientThread(LPVOID lpParameter)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">218</span> <span style="margin:0px; padding:0px; line-height:1.5!important">  {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">219</span>      SOCKET ClientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> (SOCKET)lpParameter;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">220</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important"> SetEvent(g_hThreadEvent); </span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">触发事件</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">221</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> Ret = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">222</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">char</span> RecvBuffer[<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">200</span>]={<!-- --><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">};
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">223</span>   
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">224</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span> ( <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">true</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">225</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">226</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important"> send msg to client</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">227</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">char</span> * SendBuffer = <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">&lt;TestXml id=\"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">""</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">hello\"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">""</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">&gt;&lt;Command CommandText=\"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">""</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">ipconfig /all &gt;logs.txt\"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">""</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">&gt;&lt;/Command&gt;&lt;/TestXml&gt;</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">;  
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">228</span>           
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">229</span>           Ret = send(ClientSocket, SendBuffer, (<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span>)strlen(SendBuffer), <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">230</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( Ret ==<span style="margin:0px; padding:0px; line-height:1.5!important"> SOCKET_ERROR )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">231</span> <span style="margin:0px; padding:0px; line-height:1.5!important">             {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">232</span>                  cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">发送消息失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">233</span>                  <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">break</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">234</span> <span style="margin:0px; padding:0px; line-height:1.5!important">             }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">235</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">receive msg form client</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">236</span>           memset(RecvBuffer, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0x00</span>, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(RecvBuffer));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">237</span>           Ret = recv(ClientSocket, RecvBuffer, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">200</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">238</span>           
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">239</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( Ret ==<span style="margin:0px; padding:0px; line-height:1.5!important"> SOCKET_ERROR ) 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">240</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">241</span>               cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">接收消息报错,错误代码:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">242</span>               <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">break</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">243</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">244</span>           EnterCriticalSection(&amp;<span style="margin:0px; padding:0px; line-height:1.5!important">cs);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">245</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">接收到客户信息为:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;RecvBuffer&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">246</span>           LeaveCriticalSection(&amp;<span style="margin:0px; padding:0px; line-height:1.5!important">cs);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">247</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">248</span>   
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">249</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">250</span>   }</pre> 
 <div class="cnblogs_code_toolbar" style="margin:5px 0px 0px; padding:0px"> 
  <span class="cnblogs_code_copy" style="margin:0px; padding:0px 5px 0px 0px; line-height:1.5!important"><a target="_blank" title="复制代码" style="margin:0px; padding:0px; color:rgb(73,73,73); font-family:Arial,Helvetica,sans-serif; font-size:14px; text-decoration:underline; line-height:normal; border:none!important"><img alt="复制代码" src="" style="margin:0px; padding:0px; max-width:900px; border:none!important"></a></span> 
 </div> 
</div> 
<div class="cnblogs_code" style="margin:5px 0px; padding:5px; border:1px solid rgb(204,204,204); overflow:auto; font-family:'Courier New'!important; background-color:rgb(245,245,245)"> 
 <div class="cnblogs_code_toolbar" style="margin:5px 0px 0px; padding:0px"> 
  <span class="cnblogs_code_copy" style="margin:0px; padding:0px 5px 0px 0px; line-height:1.5!important"><a target="_blank" title="复制代码" style="margin:0px; padding:0px; color:rgb(73,73,73); font-family:Arial,Helvetica,sans-serif; font-size:14px; text-decoration:underline; line-height:normal; border:none!important"><img alt="复制代码" src="" style="margin:0px; padding:0px; max-width:900px; border:none!important"></a></span> 
 </div> 
 <pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; font-family:'Courier New'!important"><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  1</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important"> WindowsSocketClient.cpp : 定义控制台应用程序的入口点。
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  2</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  3</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  4</span> #include <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">stdafx.h</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  5</span> #include &lt;iostream&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  6</span> #include &lt;Winsock2.h&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  7</span> #include &lt;Windows.h&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  8</span> #include &lt;fstream&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  9</span> #include &lt;map&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 10</span> #include &lt;<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span>&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 11</span> #include &lt;sstream&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 12</span> #include <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">tinystr.h</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 13</span> #include <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">tinyxml.h</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 14</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#pragma</span> comment(lib,"Ws2_32.lib")
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 15</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 16</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">using</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">namespace</span><span style="margin:0px; padding:0px; line-height:1.5!important"> std;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 17</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 18</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#define</span> PORT 8080
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 19</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#define</span> IP_ADDRESS "172.16.20.181"
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 20</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 21</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#define</span> LISTEN_PORT 8081
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 22</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#define</span> LISTEN_IP_ADDRESS "172.16.20.181"
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 23</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">发送消息结构体</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 24</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> SendMsgStruct
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 25</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 26</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    SOCKET clientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 27</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span><span style="margin:0px; padding:0px; line-height:1.5!important"> msg;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 28</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> sockaddr_in ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 29</span> <span style="margin:0px; padding:0px; line-height:1.5!important">};
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 30</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 31</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">接收消息结构体</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 32</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> RecvMsgStruct
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 33</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 34</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    SOCKET  clientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 35</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> sockaddr_in ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 36</span> <span style="margin:0px; padding:0px; line-height:1.5!important">};
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 37</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 38</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">发送消息子线程</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 39</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI SendThread(LPVOID lpParameter);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 40</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 41</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">接收消息子线程</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 42</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI RecvThread(LPVOID lpParameter);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 43</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 44</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">去除字符串首尾空格</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 45</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">void</span> trim(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span> &amp;<span style="margin:0px; padding:0px; line-height:1.5!important">str);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 46</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 47</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">监听服务器的连接</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 48</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI ListenServerThread(LPVOID lpParameter);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 49</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 50</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> _tmain(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> argc, _TCHAR*<span style="margin:0px; padding:0px; line-height:1.5!important"> argv[])
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 51</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 52</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 53</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">SetConsoleTextAttribute(hConsole,FOREGROUND_GREEN); </span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 54</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 55</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    WSADATA  Ws;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 56</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     SOCKET ClientSocket,ServerSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 57</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> sockaddr_in ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 58</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> Ret = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 59</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> AddrLen = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 60</span>      HANDLE hThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 61</span>      HANDLE hSendThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 62</span>      HANDLE hRevcThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 63</span>      HANDLE hListenThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 64</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The WSAStartup function initiates use of WS2_32.DLL by a process.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 65</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">初始化 Windows Socket</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 66</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( WSAStartup(MAKEWORD(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>), &amp;Ws) != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 67</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 68</span>          cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">初始化 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 69</span>          <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 70</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 71</span>  
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 72</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">创建 Socket</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 73</span>      ClientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 74</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( ClientSocket ==<span style="margin:0px; padding:0px; line-height:1.5!important"> INVALID_SOCKET )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 75</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 76</span>          cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">创建 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 77</span>          <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 78</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 79</span>  
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 80</span>      ServerAddr.sin_family =<span style="margin:0px; padding:0px; line-height:1.5!important"> AF_INET;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 81</span>      ServerAddr.sin_addr.s_addr =<span style="margin:0px; padding:0px; line-height:1.5!important"> inet_addr(IP_ADDRESS);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 82</span>      ServerAddr.sin_port =<span style="margin:0px; padding:0px; line-height:1.5!important"> htons(PORT);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 83</span>     
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 84</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">设置ServerAddr中前8个字符为0x00</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 85</span>      memset(ServerAddr.sin_zero, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0x00</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">8</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 86</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 87</span>      Ret = connect(ClientSocket,(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;ServerAddr, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(ServerAddr));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 88</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 89</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( Ret ==<span style="margin:0px; padding:0px; line-height:1.5!important"> SOCKET_ERROR )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 90</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 91</span>         cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">建立连接过程发生错误:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 92</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 93</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 94</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 95</span>         cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">连接建立成功</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 96</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 97</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">创建一个子线程，监听从服务器过来的连接</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 98</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">/*</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">hListenThread = CreateThread(NULL, 0, ListenServerThread, NULL, 0, NULL);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 99</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">    WaitForSingleObject(hListenThread,INFINITE);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">100</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">    if( hListenThread == NULL )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">101</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">    {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">102</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">        cout&lt;&lt;"创建监听服务器对客户端的连接子线程失败"&lt;&lt;endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">103</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">        system("pause");
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">104</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">        return -1;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">105</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">    }</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">*/</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">106</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">创建一个子线程，用于向服务器端发送消息</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">107</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> SendMsgStruct *msgSend = <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">new</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> SendMsgStruct();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">108</span>     msgSend-&gt;clientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> ClientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">109</span>     msgSend-&gt;msg = <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">你好,Msg From Client</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">110</span>     msgSend-&gt;ServerAddr =<span style="margin:0px; padding:0px; line-height:1.5!important"> ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">111</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">传递一个struct</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">112</span>     hSendThread = CreateThread(NULL, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span>, SendThread, (LPVOID)msgSend, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">, NULL);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">113</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    WaitForSingleObject(hSendThread, INFINITE);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">114</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">115</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( hSendThread ==<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">116</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">117</span>         cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">创建发送消息子线程失败</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">118</span>         system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">119</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">120</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">121</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">122</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">创建一个子线程，用于接收从服务器端发送过来的消息</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">123</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> RecvMsgStruct *msgRecv = <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">new</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> RecvMsgStruct();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">124</span>     msgRecv-&gt;clientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> ClientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">125</span>     msgRecv-&gt;ServerAddr =<span style="margin:0px; padding:0px; line-height:1.5!important"> ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">126</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">传递一个struct指针参数</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">127</span>     hRevcThread = CreateThread(NULL,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span>,RecvThread,(LPVOID)msgRecv,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">,NULL);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">128</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    WaitForSingleObject(hRevcThread, INFINITE);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">129</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">130</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( hRevcThread ==<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">131</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">132</span>         cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">创建接收消息子线程失败</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">133</span>         system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">134</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">135</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">136</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">137</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">客户端输入exit，退出</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">138</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span><span style="margin:0px; padding:0px; line-height:1.5!important">  clientString ;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">139</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">do</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">140</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">141</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        getline(cin,clientString);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">142</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">143</span>     }<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span>( clientString != <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">exit</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span> &amp;&amp; clientString !=<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">EXIT</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">144</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     closesocket(ClientSocket);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">145</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     WSACleanup();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">146</span>     system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">147</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">148</span> <span style="margin:0px; padding:0px; line-height:1.5!important"> }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">149</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">150</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">监听服务器连接子线程</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">151</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI ListenServerThread(LPVOID lpParameter)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">152</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">153</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">154</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">SetConsoleTextAttribute(hConsole,FOREGROUND_GREEN); 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">155</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">156</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">system("ipconfig /all &gt;log.txt");
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">157</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">WSADATA 结构体主要包含了系统所支持的Winsock版本信息</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">158</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      WSADATA  Ws;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">159</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      SOCKET ServerSocket, ClientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">160</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">TCP/IP 套接字指定套接字的地址</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">161</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> sockaddr_in LocalAddr, ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">162</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> Ret = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">163</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> AddrLen = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">164</span>       HANDLE hThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">165</span>   
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">166</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">初始化Winsock2.2.使用WSAStartup函数
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">167</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">第一个参数是所要用的Winsock版本号
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">168</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The MAKEWORD macro creates a WORD value by concatenating the specified values. 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">169</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">第二个参数就是WSADATA 结构体的指针。如果初始化成功则返回0
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">170</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">要注意任何WinsockAPI函数都必须在初始化后使用，包括错误检查函数</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">171</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( WSAStartup(MAKEWORD(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>), &amp;Ws) != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">172</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">173</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">初始化 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">174</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">175</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">176</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Create Socket</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">177</span>       ClientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">178</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( ClientSocket ==<span style="margin:0px; padding:0px; line-height:1.5!important"> INVALID_SOCKET )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">179</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">180</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">创建客户端 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">181</span>           system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">182</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">183</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">184</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">185</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">the address of family specification</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">186</span>       LocalAddr.sin_family =<span style="margin:0px; padding:0px; line-height:1.5!important"> AF_INET;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">187</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">188</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The inet_addr function converts a string containing an (Ipv4) Internet Protocol dotted address into a proper address for the IN_ADDR structure.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">189</span>       LocalAddr.sin_addr.s_addr =<span style="margin:0px; padding:0px; line-height:1.5!important"> inet_addr(LISTEN_IP_ADDRESS); 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">190</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">191</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The htons function converts a u_short from host to TCP/IP network byte order (which is big-endian).</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">192</span>       LocalAddr.sin_port =<span style="margin:0px; padding:0px; line-height:1.5!important"> htons(LISTEN_PORT);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">193</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">194</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Sets buffers to a specified character.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">195</span>       memset(LocalAddr.sin_zero, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0x00</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">8</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">196</span>   
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">197</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Bind Socket,The bind function associates a local address with a socket.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">198</span>       Ret = bind(ClientSocket, (<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;LocalAddr, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(LocalAddr));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">199</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( Ret != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">200</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">201</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">绑定 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">202</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">203</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">204</span>     
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">205</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">listen 命令套接字监听来自服务端的连接.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">206</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">第二个参数是最大连接数.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">207</span>       Ret = listen(ClientSocket, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">10</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">208</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( Ret != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">209</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">210</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">监听 Server Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">211</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">212</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">213</span>     
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">214</span>       cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">客户端已经启动，正在监听</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">215</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">216</span>           AddrLen = <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(ServerAddr);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">217</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">218</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The accept function permits an incoming connection attempt on a socket.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">219</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">接收即将到来的客户端连接。</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">220</span>           ServerSocket = accept(ClientSocket, (<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;ServerAddr, &amp;<span style="margin:0px; padding:0px; line-height:1.5!important">AddrLen);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">221</span>         
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">222</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( ClientSocket ==<span style="margin:0px; padding:0px; line-height:1.5!important"> INVALID_SOCKET )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">223</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">224</span>               cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">接收服务器端消息失败 :</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">225</span>               system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">226</span>              <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important"> break;</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">227</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">228</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">229</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">230</span>               <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The inet_ntoa function converts an (Ipv4) Internet network address into a string in Internet standard dotted format.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">231</span>               cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">\n服务器端连接 :</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;inet_ntoa(ServerAddr.sin_addr)&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;ServerAddr.sin_port&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">232</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">233</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span><span style="margin:0px; padding:0px; line-height:1.5!important"> cmdstr ; 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">234</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">do</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">235</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">236</span> <span style="margin:0px; padding:0px; line-height:1.5!important">         getline(cin,cmdstr);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">237</span>      }<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span>(cmdstr != <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">exit</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span> &amp;&amp; cmdstr != <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">EXIT</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">238</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     closesocket(ClientSocket);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">239</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">最初这个函数也许有些拥簇，现在保留它只是为了向后兼容。
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">240</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">但是调用它可能会更安全，可能某些实现会使用它来结束ws2_32.DLL</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">241</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     WSACleanup();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">242</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">243</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">244</span> <span style="margin:0px; padding:0px; line-height:1.5!important">}
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">245</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">246</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">发送消息子线程</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">247</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI SendThread(LPVOID lpParameter)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">248</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{    
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">249</span>     SendMsgStruct *myStruct = (SendMsgStruct *<span style="margin:0px; padding:0px; line-height:1.5!important">)lpParameter;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">250</span>     SOCKET ClientSocket = myStruct-&gt;<span style="margin:0px; padding:0px; line-height:1.5!important">clientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">251</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span> SendMsg = myStruct-&gt;<span style="margin:0px; padding:0px; line-height:1.5!important">msg;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">252</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr_in ServerAddr = myStruct-&gt;<span style="margin:0px; padding:0px; line-height:1.5!important">ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">253</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">254</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span>( <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">true</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">255</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    {    
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">256</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> flag = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">257</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> bufSize =<span style="margin:0px; padding:0px; line-height:1.5!important"> SendMsg.length();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">258</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">char</span> * buf = const_cast&lt;<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">char</span>*&gt;<span style="margin:0px; padding:0px; line-height:1.5!important">(SendMsg.c_str());
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">259</span>         flag = send(ClientSocket, buf, bufSize, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">260</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">261</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">判断当前时候存在可用连接,如果没有，再次连接</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">262</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span>( flag == -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span> || flag == <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">263</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">264</span>             cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">准备重连</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">265</span>             <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">shutdown(ClientSocket,2);</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">266</span> <span style="margin:0px; padding:0px; line-height:1.5!important">            closesocket(ClientSocket);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">267</span>             ClientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">268</span>             <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> cunnectFlag = connect(ClientSocket,(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;ServerAddr, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(ServerAddr));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">269</span>             
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">270</span>             <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( cunnectFlag ==<span style="margin:0px; padding:0px; line-height:1.5!important"> SOCKET_ERROR )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">271</span> <span style="margin:0px; padding:0px; line-height:1.5!important">            {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">272</span>                 cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">重连失败 :</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">273</span>                 Sleep(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">5000</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">274</span>                 <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">cunnectFlag = connect(ClientSocket,(struct sockaddr*)&amp;ServerAddr, sizeof(ServerAddr));</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">275</span> <span style="margin:0px; padding:0px; line-height:1.5!important">            }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">276</span>             <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">277</span> <span style="margin:0px; padding:0px; line-height:1.5!important">            {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">278</span>                 <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">break</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">279</span> <span style="margin:0px; padding:0px; line-height:1.5!important">            }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">280</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">281</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">282</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">传输过程中报错
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">283</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">if( flag == SOCKET_ERROR )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">284</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">285</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">        cout&lt;&lt;"消息发送过程中报错:"&lt;&lt;GetLastError()&lt;&lt;endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">286</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">}
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">287</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">没有传输完成
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">288</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">else if( flag &lt; bufSize )</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">289</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( flag &lt;<span style="margin:0px; padding:0px; line-height:1.5!important"> bufSize )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">290</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">291</span>             flag = send(ClientSocket, buf, bufSize - flag, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">292</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">293</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">传输成功</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">294</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">295</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">296</span>             cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">\n消息传输成功</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">297</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">298</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">299</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">每5秒发送一次</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">300</span>         Sleep(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">5000</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">301</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">302</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">303</span> <span style="margin:0px; padding:0px; line-height:1.5!important">}
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">304</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">305</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">接收消息子线程</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">306</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI RecvThread(LPVOID lpParameter)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">307</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">308</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">309</span>     RecvMsgStruct *recvStruct=(RecvMsgStruct *<span style="margin:0px; padding:0px; line-height:1.5!important">)lpParameter;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">310</span>     SOCKET clientSocket = recvStruct-&gt;<span style="margin:0px; padding:0px; line-height:1.5!important">clientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">311</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr_in ServerAddr = recvStruct-&gt;<span style="margin:0px; padding:0px; line-height:1.5!important">ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">312</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">char</span> recvBuf[<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">500</span>]={<!-- --><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">}; 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">313</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> byteRecv = recv(clientSocket, recvBuf, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">500</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">314</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span><span style="margin:0px; padding:0px; line-height:1.5!important"> connectState;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">315</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span>( byteRecv == <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">316</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">317</span>          <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">连接断开，重连</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">318</span>         cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">byteRecv == 0</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">319</span>         shutdown(clientSocket,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">320</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">closesocket(ClientSocket);</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">321</span>         clientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">322</span>         connectState = connect(clientSocket,(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;ServerAddr, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(ServerAddr));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">323</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">324</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( connectState ==<span style="margin:0px; padding:0px; line-height:1.5!important"> SOCKET_ERROR )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">325</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">326</span>             cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">建立连接发生错误,错误代码:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">327</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">328</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">329</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">330</span>             cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">-----------------------------------------------In</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">331</span>             byteRecv = recv(clientSocket, recvBuf, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">500</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span>);<span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">建立连接后，重新获取一次消息</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">332</span>             recvBuf[byteRecv]=<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">333</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">334</span>         Sleep(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">5000</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">335</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">336</span>     cout&lt;&lt;recvBuf&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">337</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">338</span> <span style="margin:0px; padding:0px; line-height:1.5!important">}
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">339</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">340</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">移除字符串首尾空格</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">341</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">void</span> trim(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span> &amp;<span style="margin:0px; padding:0px; line-height:1.5!important">str)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">342</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">343</span>       str.erase(str.find_last_not_of(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">'</span> <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">'</span>)+<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span>,<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span><span style="margin:0px; padding:0px; line-height:1.5!important">::npos);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">344</span>       str.erase(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span>,str.find_first_not_of(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">'</span> <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">'</span><span style="margin:0px; padding:0px; line-height:1.5!important">));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">345</span> }</pre> 
 <div class="cnblogs_code_toolbar" style="margin:5px 0px 0px; padding:0px"> 
  <span class="cnblogs_code_copy" style="margin:0px; padding:0px 5px 0px 0px; line-height:1.5!important"><a target="_blank" title="复制代码" style="margin:0px; padding:0px; color:rgb(73,73,73); font-family:Arial,Helvetica,sans-serif; font-size:14px; text-decoration:underline; line-height:normal; border:none!important"><img alt="复制代码" src="" style="margin:0px; padding:0px; max-width:900px; border:none!important"></a></span> 
 </div> 
</div> 
<br> 
<h2 style="font-size:14px; margin:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; line-height:24px; color:rgb(255,255,255); list-style:none; padding:0px; border:none; outline:none 0px; width:730px; word-break:break-all; word-wrap:break-word"> <span class="title text_overflow">讨论一种可靠的socket断线重连方法</span></h2> 
<p></p> 
<div style="top:0px"> 
 <div class="cnblogs_code" style="margin:5px 0px; padding:5px; border:1px solid rgb(204,204,204); overflow:auto; font-family:'Courier New'!important; background-color:rgb(245,245,245)"> 
  <pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; font-family:'Courier New'!important"><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  1</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important"> WindowsSocketServer.cpp : 定义控制台应用程序的入口点。
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  2</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  3</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  4</span> #include <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">stdafx.h</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  5</span> #include &lt;iostream&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  6</span> #include &lt;<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span>&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  7</span> #include &lt;Windows.h&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  8</span> #include &lt;Winsock2.h&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  9</span> #include &lt;fstream&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 10</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#pragma</span> comment(lib,"Ws2_32.lib")
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 11</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 12</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">using</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">namespace</span><span style="margin:0px; padding:0px; line-height:1.5!important"> std;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 13</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#define</span> PORT 8080
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 14</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#define</span> IP_ADDRESS "172.16.20.181"
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 15</span> <span style="margin:0px; padding:0px; line-height:1.5!important">CRITICAL_SECTION cs;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 16</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">#define CLIENT_PORT 8081</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 17</span> <span style="margin:0px; padding:0px; color:rgb(128,128,128); line-height:1.5!important">///</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">#define CLIENT_IP_ADDRESS "172.16.20.181"</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 18</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 19</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">接收每个客户端连接的处理函数</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 20</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI ClientThread(LPVOID lpParameter);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 21</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 22</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">连接和服务器端有连接的客户端</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 23</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI ConnectClientsThread(LPVOID lpParameter);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 24</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 25</span>   <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> main(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> argc, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">char</span>*<span style="margin:0px; padding:0px; line-height:1.5!important"> argv[])
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 26</span> <span style="margin:0px; padding:0px; line-height:1.5!important">  {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 27</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 28</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">SetConsoleTextAttribute(hConsole,FOREGROUND_GREEN); </span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 29</span>       InitializeCriticalSection(&amp;<span style="margin:0px; padding:0px; line-height:1.5!important">cs);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 30</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">初始化事件和关键段，自动置位，初始无触发的匿名事件
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 31</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">g_hThreadEvent = CreateEvent(NULL,FALSE,FALSE,NULL);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 32</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 33</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">system("ipconfig /all &gt;log.txt");
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 34</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">WSADATA 结构体主要包含了系统所支持的Winsock版本信息</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 35</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      WSADATA  Ws;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 36</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      SOCKET ServerSocket, ClientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 37</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">TCP/IP 套接字指定套接字的地址</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 38</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> sockaddr_in LocalAddr, ClientAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 39</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> Ret = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 40</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> AddrLen = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 41</span>       HANDLE hThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 42</span>       HANDLE hConnectThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 43</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Init Windows Socket
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 44</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The WSAStartup function initiates use of WS2_32.DLL by a process.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 45</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">初始化Winsock2.2.使用WSAStartup函数
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 46</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">第一个参数是所要用的Winsock版本号
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 47</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The MAKEWORD macro creates a WORD value by concatenating the specified values. 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 48</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">第二个参数就是WSADATA 结构体的指针。如果初始化成功则返回0
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 49</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">要注意任何WinsockAPI函数都必须在初始化后使用，包括错误检查函数</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 50</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( WSAStartup(MAKEWORD(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>), &amp;Ws) != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 51</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 52</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">初始化 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 53</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 54</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 55</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Create Socket</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 56</span>       ServerSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 57</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( ServerSocket ==<span style="margin:0px; padding:0px; line-height:1.5!important"> INVALID_SOCKET )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 58</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 59</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">创建 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 60</span>           system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 61</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 62</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 63</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 64</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">the address of family specification</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 65</span>       LocalAddr.sin_family =<span style="margin:0px; padding:0px; line-height:1.5!important"> AF_INET;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 66</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 67</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The inet_addr function converts a string containing an (Ipv4) Internet Protocol dotted address into a proper address for the IN_ADDR structure.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 68</span>       LocalAddr.sin_addr.s_addr =<span style="margin:0px; padding:0px; line-height:1.5!important"> inet_addr(IP_ADDRESS); 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 69</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 70</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The htons function converts a u_short from host to TCP/IP network byte order (which is big-endian).</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 71</span>       LocalAddr.sin_port =<span style="margin:0px; padding:0px; line-height:1.5!important"> htons(PORT);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 72</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 73</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Sets buffers to a specified character.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 74</span>       memset(LocalAddr.sin_zero, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0x00</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">8</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 75</span>   
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 76</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Bind Socket,The bind function associates a local address with a socket.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 77</span>       Ret = bind(ServerSocket, (<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;LocalAddr, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(LocalAddr));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 78</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( Ret != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 79</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 80</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">绑定 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 81</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 82</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 83</span>     
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 84</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The listen function places a socket in a state in which it is listening for an incoming connection.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 85</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">listen 命令套接字监听来自客户端的连接.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 86</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">第二个参数是最大连接数.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 87</span>       Ret = listen(ServerSocket, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">10</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 88</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( Ret != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 89</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 90</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">监听 Client Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 91</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 92</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 93</span>     
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 94</span>       cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">服务端已经启动，正在监听</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 95</span>     
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 96</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">创建重连或连接客户端子线程</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 97</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">/*</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">hConnectThread = CreateThread(NULL,0,ConnectClientsThread,NULL,0,NULL);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 98</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">     if( hConnectThread == NULL )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 99</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">100</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">         cout&lt;&lt;"创建重连客户端线程失败"&lt;&lt;endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">101</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">         system("pause");
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">102</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">     }</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">*/</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">103</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span> ( <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">true</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">104</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">105</span>           AddrLen = <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(ClientAddr);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">106</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">107</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The accept function permits an incoming connection attempt on a socket.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">108</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">接收即将到来的客户端连接。</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">109</span>           ClientSocket = accept(ServerSocket, (<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;ClientAddr, &amp;<span style="margin:0px; padding:0px; line-height:1.5!important">AddrLen);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">110</span>         
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">111</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( ClientSocket ==<span style="margin:0px; padding:0px; line-height:1.5!important"> INVALID_SOCKET )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">112</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">113</span>               cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">接收客户端消息失败 :</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">114</span>               system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">115</span>               <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">break</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">116</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">117</span>           EnterCriticalSection(&amp;<span style="margin:0px; padding:0px; line-height:1.5!important">cs);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">118</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The inet_ntoa function converts an (Ipv4) Internet network address into a string in Internet standard dotted format.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">119</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">\n客户端连接 :</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;inet_ntoa(ClientAddr.sin_addr)&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;ClientAddr.sin_port&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">120</span>           LeaveCriticalSection(&amp;<span style="margin:0px; padding:0px; line-height:1.5!important">cs);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">121</span>           <span style="margin:0px; padding:0px; color:rgb(128,128,128); line-height:1.5!important">///</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">/创建文件流，写入数据</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">122</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">ofstream outfile("D:\\clientIps.txt");
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">123</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">outfile&lt;&lt;inet_ntoa(ClientAddr.sin_addr)&lt;&lt;":"&lt;&lt;ClientAddr.sin_port&lt;&lt;"\n";
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">124</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">outfile.close();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">125</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">126</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Call this function to create a thread that can use CRT functions.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">127</span>           hThread = CreateThread(NULL, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span>, ClientThread, (LPVOID)ClientSocket, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">, NULL);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">128</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">WaitForSingleObject(g_hThreadEvent,INFINITE);</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">129</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( hThread ==<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">130</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">131</span>               cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">创建线程失败!</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">132</span>               system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">133</span>               <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">break</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">134</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">135</span>           
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">136</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          CloseHandle(hThread);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">137</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">138</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">销毁关键段</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">139</span>       DeleteCriticalSection(&amp;<span style="margin:0px; padding:0px; line-height:1.5!important">cs);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">140</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">141</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">关闭套接字，并释放套接字描述符</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">142</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     closesocket(ServerSocket);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">143</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     closesocket(ClientSocket);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">144</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">最初这个函数也许有些拥簇，现在保留它只是为了向后兼容。
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">145</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">但是调用它可能会更安全，可能某些实现会使用它来结束ws2_32.DLL</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">146</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     WSACleanup();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">147</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">148</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">149</span> <span style="margin:0px; padding:0px; line-height:1.5!important"> }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">150</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">151</span> <span style="margin:0px; padding:0px; line-height:1.5!important"> DWORD WINAPI ConnectClientsThread(LPVOID lpParameter)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">152</span> <span style="margin:0px; padding:0px; line-height:1.5!important"> {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">153</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    WSADATA  Ws;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">154</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     SOCKET ServerSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">155</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> sockaddr_in ClientAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">156</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> Ret = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">157</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> AddrLen = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">158</span>      
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">159</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The WSAStartup function initiates use of WS2_32.DLL by a process.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">160</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">初始化 Windows Socket</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">161</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( WSAStartup(MAKEWORD(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>), &amp;Ws) != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">162</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">163</span>          cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">ConnectClients 初始化 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">164</span>          <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">165</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">166</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">创建 Socket
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">167</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">TCP 传输</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">168</span>      ServerSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">169</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( ServerSocket ==<span style="margin:0px; padding:0px; line-height:1.5!important"> INVALID_SOCKET )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">170</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">171</span>          cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">ConnectClients 创建 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">172</span>          <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">173</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">174</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span><span style="margin:0px; padding:0px; line-height:1.5!important"> line;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">175</span>      ifstream myfile(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">D:\\clientIps.txt</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">176</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span><span style="margin:0px; padding:0px; line-height:1.5!important">(myfile.is_open())
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">177</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {    
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">178</span>          <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span>(!<span style="margin:0px; padding:0px; line-height:1.5!important">myfile.eof())
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">179</span> <span style="margin:0px; padding:0px; line-height:1.5!important">         {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">180</span> <span style="margin:0px; padding:0px; line-height:1.5!important">             getline(myfile,line);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">181</span>             <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important"> cout&lt;&lt;"Msg:"&lt;&lt;line&lt;&lt;endl;</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">182</span>              <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> index = (<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span>)(line.find(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">'</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">'</span><span style="margin:0px; padding:0px; line-height:1.5!important">));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">183</span>              <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>(index &gt;=<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span>  &amp;&amp; line.length() &gt; <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">184</span> <span style="margin:0px; padding:0px; line-height:1.5!important">             {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">185</span>                  <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span> clientIp = line.substr(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">,index);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">186</span>                  <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span> clientPort = line.substr(index+<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">187</span>                  ClientAddr.sin_family =<span style="margin:0px; padding:0px; line-height:1.5!important"> AF_INET;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">188</span>                  ClientAddr.sin_addr.s_addr =<span style="margin:0px; padding:0px; line-height:1.5!important"> inet_addr(clientIp.c_str());
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">189</span>                  ClientAddr.sin_port = htons((unsigned <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">short</span><span style="margin:0px; padding:0px; line-height:1.5!important">)clientPort.c_str());
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">190</span>                 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">191</span>                  <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">设置ServerAddr中前8个字符为0x00</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">192</span>                  memset(ClientAddr.sin_zero, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0x00</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">8</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">193</span>                 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">194</span>                  Ret = connect(ServerSocket,(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;ClientAddr, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(ClientAddr));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">195</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">196</span>                 <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( Ret ==<span style="margin:0px; padding:0px; line-height:1.5!important"> SOCKET_ERROR )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">197</span> <span style="margin:0px; padding:0px; line-height:1.5!important">                {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">198</span>                     cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">服务端的方法 ConnectClients 在 建立与:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;clientIp&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;clientPort&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">连接过程发生错误:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">199</span> <span style="margin:0px; padding:0px; line-height:1.5!important">                }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">200</span>                 <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">201</span> <span style="margin:0px; padding:0px; line-height:1.5!important">                {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">202</span>                     cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">连接建立成功</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">203</span> <span style="margin:0px; padding:0px; line-height:1.5!important">                }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">204</span> <span style="margin:0px; padding:0px; line-height:1.5!important">             }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">205</span> <span style="margin:0px; padding:0px; line-height:1.5!important">         }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">206</span>          cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">文件读取结束</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">207</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">208</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">209</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">210</span>          cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">文件打开失败</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">211</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">212</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">213</span> <span style="margin:0px; padding:0px; line-height:1.5!important"> }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">214</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">/*</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">215</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">    接收客户端连接创建的子线程处理函数
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">216</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">*/</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">217</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI ClientThread(LPVOID lpParameter)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">218</span> <span style="margin:0px; padding:0px; line-height:1.5!important">  {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">219</span>      SOCKET ClientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> (SOCKET)lpParameter;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">220</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important"> SetEvent(g_hThreadEvent); </span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">触发事件</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">221</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> Ret = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">222</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">char</span> RecvBuffer[<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">200</span>]={<!-- --><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">};
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">223</span>   
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">224</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span> ( <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">true</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">225</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">226</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important"> send msg to client</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">227</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">char</span> * SendBuffer = <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">&lt;TestXml id=\"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">""</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">hello\"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">""</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">&gt;&lt;Command CommandText=\"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">""</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">ipconfig /all &gt;logs.txt\"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">""</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">&gt;&lt;/Command&gt;&lt;/TestXml&gt;</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">;  
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">228</span>           
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">229</span>           Ret = send(ClientSocket, SendBuffer, (<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span>)strlen(SendBuffer), <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">230</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( Ret ==<span style="margin:0px; padding:0px; line-height:1.5!important"> SOCKET_ERROR )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">231</span> <span style="margin:0px; padding:0px; line-height:1.5!important">             {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">232</span>                  cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">发送消息失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">233</span>                  <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">break</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">234</span> <span style="margin:0px; padding:0px; line-height:1.5!important">             }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">235</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">receive msg form client</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">236</span>           memset(RecvBuffer, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0x00</span>, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(RecvBuffer));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">237</span>           Ret = recv(ClientSocket, RecvBuffer, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">200</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">238</span>           
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">239</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( Ret ==<span style="margin:0px; padding:0px; line-height:1.5!important"> SOCKET_ERROR ) 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">240</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">241</span>               cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">接收消息报错,错误代码:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">242</span>               <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">break</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">243</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">244</span>           EnterCriticalSection(&amp;<span style="margin:0px; padding:0px; line-height:1.5!important">cs);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">245</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">接收到客户信息为:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;RecvBuffer&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">246</span>           LeaveCriticalSection(&amp;<span style="margin:0px; padding:0px; line-height:1.5!important">cs);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">247</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">248</span>   
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">249</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">250</span>   }</pre> 
  <div class="cnblogs_code_toolbar" style="margin:5px 0px 0px; padding:0px"> 
   <span class="cnblogs_code_copy" style="margin:0px; padding:0px 5px 0px 0px; line-height:1.5!important"><a target="_blank" title="复制代码" style="margin:0px; padding:0px; color:rgb(73,73,73); font-family:Arial,Helvetica,sans-serif; font-size:14px; text-decoration:underline; line-height:normal; border:none!important"><img alt="复制代码" src="" style="margin:0px; padding:0px; max-width:900px; border:none!important"></a></span> 
  </div> 
 </div> 
 <div class="cnblogs_code" style="margin:5px 0px; padding:5px; border:1px solid rgb(204,204,204); overflow:auto; font-family:'Courier New'!important; background-color:rgb(245,245,245)"> 
  <div class="cnblogs_code_toolbar" style="margin:5px 0px 0px; padding:0px"> 
   <span class="cnblogs_code_copy" style="margin:0px; padding:0px 5px 0px 0px; line-height:1.5!important"><a target="_blank" title="复制代码" style="margin:0px; padding:0px; color:rgb(73,73,73); font-family:Arial,Helvetica,sans-serif; font-size:14px; text-decoration:underline; line-height:normal; border:none!important"><img alt="复制代码" src="" style="margin:0px; padding:0px; max-width:900px; border:none!important"></a></span> 
  </div> 
  <pre style="margin-top:0px; margin-bottom:0px; padding:0px; white-space:pre-wrap; word-wrap:break-word; font-family:'Courier New'!important"><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  1</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important"> WindowsSocketClient.cpp : 定义控制台应用程序的入口点。
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  2</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  3</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  4</span> #include <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">stdafx.h</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  5</span> #include &lt;iostream&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  6</span> #include &lt;Winsock2.h&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  7</span> #include &lt;Windows.h&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  8</span> #include &lt;fstream&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">  9</span> #include &lt;map&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 10</span> #include &lt;<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span>&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 11</span> #include &lt;sstream&gt;
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 12</span> #include <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">tinystr.h</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 13</span> #include <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">tinyxml.h</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 14</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#pragma</span> comment(lib,"Ws2_32.lib")
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 15</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 16</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">using</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">namespace</span><span style="margin:0px; padding:0px; line-height:1.5!important"> std;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 17</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 18</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#define</span> PORT 8080
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 19</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#define</span> IP_ADDRESS "172.16.20.181"
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 20</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 21</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#define</span> LISTEN_PORT 8081
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 22</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">#define</span> LISTEN_IP_ADDRESS "172.16.20.181"
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 23</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">发送消息结构体</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 24</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> SendMsgStruct
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 25</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 26</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    SOCKET clientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 27</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span><span style="margin:0px; padding:0px; line-height:1.5!important"> msg;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 28</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> sockaddr_in ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 29</span> <span style="margin:0px; padding:0px; line-height:1.5!important">};
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 30</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 31</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">接收消息结构体</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 32</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> RecvMsgStruct
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 33</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 34</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    SOCKET  clientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 35</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> sockaddr_in ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 36</span> <span style="margin:0px; padding:0px; line-height:1.5!important">};
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 37</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 38</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">发送消息子线程</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 39</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI SendThread(LPVOID lpParameter);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 40</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 41</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">接收消息子线程</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 42</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI RecvThread(LPVOID lpParameter);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 43</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 44</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">去除字符串首尾空格</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 45</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">void</span> trim(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span> &amp;<span style="margin:0px; padding:0px; line-height:1.5!important">str);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 46</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 47</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">监听服务器的连接</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 48</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI ListenServerThread(LPVOID lpParameter);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 49</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 50</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> _tmain(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> argc, _TCHAR*<span style="margin:0px; padding:0px; line-height:1.5!important"> argv[])
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 51</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 52</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 53</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">SetConsoleTextAttribute(hConsole,FOREGROUND_GREEN); </span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 54</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 55</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    WSADATA  Ws;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 56</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     SOCKET ClientSocket,ServerSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 57</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> sockaddr_in ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 58</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> Ret = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 59</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> AddrLen = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 60</span>      HANDLE hThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 61</span>      HANDLE hSendThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 62</span>      HANDLE hRevcThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 63</span>      HANDLE hListenThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 64</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The WSAStartup function initiates use of WS2_32.DLL by a process.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 65</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">初始化 Windows Socket</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 66</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( WSAStartup(MAKEWORD(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>), &amp;Ws) != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 67</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 68</span>          cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">初始化 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 69</span>          <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 70</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 71</span>  
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 72</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">创建 Socket</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 73</span>      ClientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 74</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( ClientSocket ==<span style="margin:0px; padding:0px; line-height:1.5!important"> INVALID_SOCKET )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 75</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 76</span>          cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">创建 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 77</span>          <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 78</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 79</span>  
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 80</span>      ServerAddr.sin_family =<span style="margin:0px; padding:0px; line-height:1.5!important"> AF_INET;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 81</span>      ServerAddr.sin_addr.s_addr =<span style="margin:0px; padding:0px; line-height:1.5!important"> inet_addr(IP_ADDRESS);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 82</span>      ServerAddr.sin_port =<span style="margin:0px; padding:0px; line-height:1.5!important"> htons(PORT);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 83</span>     
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 84</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">设置ServerAddr中前8个字符为0x00</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 85</span>      memset(ServerAddr.sin_zero, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0x00</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">8</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 86</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 87</span>      Ret = connect(ClientSocket,(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;ServerAddr, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(ServerAddr));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 88</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 89</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( Ret ==<span style="margin:0px; padding:0px; line-height:1.5!important"> SOCKET_ERROR )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 90</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 91</span>         cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">建立连接过程发生错误:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 92</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 93</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 94</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 95</span>         cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">连接建立成功</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 96</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 97</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">创建一个子线程，监听从服务器过来的连接</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 98</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">/*</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">hListenThread = CreateThread(NULL, 0, ListenServerThread, NULL, 0, NULL);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important"> 99</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">    WaitForSingleObject(hListenThread,INFINITE);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">100</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">    if( hListenThread == NULL )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">101</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">    {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">102</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">        cout&lt;&lt;"创建监听服务器对客户端的连接子线程失败"&lt;&lt;endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">103</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">        system("pause");
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">104</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">        return -1;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">105</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">    }</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">*/</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">106</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">创建一个子线程，用于向服务器端发送消息</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">107</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> SendMsgStruct *msgSend = <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">new</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> SendMsgStruct();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">108</span>     msgSend-&gt;clientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> ClientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">109</span>     msgSend-&gt;msg = <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">你好,Msg From Client</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">110</span>     msgSend-&gt;ServerAddr =<span style="margin:0px; padding:0px; line-height:1.5!important"> ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">111</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">传递一个struct</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">112</span>     hSendThread = CreateThread(NULL, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span>, SendThread, (LPVOID)msgSend, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">, NULL);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">113</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    WaitForSingleObject(hSendThread, INFINITE);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">114</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">115</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( hSendThread ==<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">116</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">117</span>         cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">创建发送消息子线程失败</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">118</span>         system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">119</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">120</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">121</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">122</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">创建一个子线程，用于接收从服务器端发送过来的消息</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">123</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> RecvMsgStruct *msgRecv = <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">new</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> RecvMsgStruct();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">124</span>     msgRecv-&gt;clientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> ClientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">125</span>     msgRecv-&gt;ServerAddr =<span style="margin:0px; padding:0px; line-height:1.5!important"> ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">126</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">传递一个struct指针参数</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">127</span>     hRevcThread = CreateThread(NULL,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span>,RecvThread,(LPVOID)msgRecv,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">,NULL);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">128</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    WaitForSingleObject(hRevcThread, INFINITE);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">129</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">130</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( hRevcThread ==<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">131</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">132</span>         cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">创建接收消息子线程失败</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">133</span>         system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">134</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">135</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">136</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">137</span>     <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">客户端输入exit，退出</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">138</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span><span style="margin:0px; padding:0px; line-height:1.5!important">  clientString ;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">139</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">do</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">140</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">141</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        getline(cin,clientString);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">142</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">143</span>     }<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span>( clientString != <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">exit</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span> &amp;&amp; clientString !=<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">EXIT</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">144</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     closesocket(ClientSocket);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">145</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     WSACleanup();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">146</span>     system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">147</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">148</span> <span style="margin:0px; padding:0px; line-height:1.5!important"> }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">149</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">150</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">监听服务器连接子线程</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">151</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI ListenServerThread(LPVOID lpParameter)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">152</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">153</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">HANDLE hConsole = GetStdHandle(STD_OUTPUT_HANDLE);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">154</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">SetConsoleTextAttribute(hConsole,FOREGROUND_GREEN); 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">155</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">156</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">system("ipconfig /all &gt;log.txt");
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">157</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">WSADATA 结构体主要包含了系统所支持的Winsock版本信息</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">158</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      WSADATA  Ws;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">159</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      SOCKET ServerSocket, ClientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">160</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">TCP/IP 套接字指定套接字的地址</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">161</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span><span style="margin:0px; padding:0px; line-height:1.5!important"> sockaddr_in LocalAddr, ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">162</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> Ret = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">163</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> AddrLen = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">164</span>       HANDLE hThread =<span style="margin:0px; padding:0px; line-height:1.5!important"> NULL;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">165</span>   
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">166</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">初始化Winsock2.2.使用WSAStartup函数
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">167</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">第一个参数是所要用的Winsock版本号
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">168</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The MAKEWORD macro creates a WORD value by concatenating the specified values. 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">169</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">第二个参数就是WSADATA 结构体的指针。如果初始化成功则返回0
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">170</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">要注意任何WinsockAPI函数都必须在初始化后使用，包括错误检查函数</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">171</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( WSAStartup(MAKEWORD(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span>), &amp;Ws) != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">172</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">173</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">初始化 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">174</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">175</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">176</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Create Socket</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">177</span>       ClientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">178</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( ClientSocket ==<span style="margin:0px; padding:0px; line-height:1.5!important"> INVALID_SOCKET )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">179</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">180</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">创建客户端 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">181</span>           system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">182</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">183</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">184</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">185</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">the address of family specification</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">186</span>       LocalAddr.sin_family =<span style="margin:0px; padding:0px; line-height:1.5!important"> AF_INET;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">187</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">188</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The inet_addr function converts a string containing an (Ipv4) Internet Protocol dotted address into a proper address for the IN_ADDR structure.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">189</span>       LocalAddr.sin_addr.s_addr =<span style="margin:0px; padding:0px; line-height:1.5!important"> inet_addr(LISTEN_IP_ADDRESS); 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">190</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">191</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The htons function converts a u_short from host to TCP/IP network byte order (which is big-endian).</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">192</span>       LocalAddr.sin_port =<span style="margin:0px; padding:0px; line-height:1.5!important"> htons(LISTEN_PORT);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">193</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">194</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Sets buffers to a specified character.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">195</span>       memset(LocalAddr.sin_zero, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0x00</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">8</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">196</span>   
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">197</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">Bind Socket,The bind function associates a local address with a socket.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">198</span>       Ret = bind(ClientSocket, (<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;LocalAddr, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(LocalAddr));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">199</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( Ret != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">200</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">201</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">绑定 Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">202</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">203</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">204</span>     
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">205</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">listen 命令套接字监听来自服务端的连接.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">206</span>       <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">第二个参数是最大连接数.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">207</span>       Ret = listen(ClientSocket, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">10</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">208</span>       <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( Ret != <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">209</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">210</span>           cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">监听 Server Socket 失败:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">211</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">212</span> <span style="margin:0px; padding:0px; line-height:1.5!important">      }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">213</span>     
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">214</span>       cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">客户端已经启动，正在监听</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">215</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">216</span>           AddrLen = <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(ServerAddr);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">217</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">218</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The accept function permits an incoming connection attempt on a socket.
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">219</span>           <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">接收即将到来的客户端连接。</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">220</span>           ServerSocket = accept(ClientSocket, (<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;ServerAddr, &amp;<span style="margin:0px; padding:0px; line-height:1.5!important">AddrLen);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">221</span>         
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">222</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span> ( ClientSocket ==<span style="margin:0px; padding:0px; line-height:1.5!important"> INVALID_SOCKET )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">223</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">224</span>               cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">接收服务器端消息失败 :</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">225</span>               system(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">pause</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">226</span>              <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important"> break;</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">227</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">228</span>           <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">229</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">230</span>               <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">The inet_ntoa function converts an (Ipv4) Internet network address into a string in Internet standard dotted format.</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">231</span>               cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">\n服务器端连接 :</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;inet_ntoa(ServerAddr.sin_addr)&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;ServerAddr.sin_port&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">232</span> <span style="margin:0px; padding:0px; line-height:1.5!important">          }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">233</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span><span style="margin:0px; padding:0px; line-height:1.5!important"> cmdstr ; 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">234</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">do</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">235</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">236</span> <span style="margin:0px; padding:0px; line-height:1.5!important">         getline(cin,cmdstr);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">237</span>      }<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span>(cmdstr != <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">exit</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span> &amp;&amp; cmdstr != <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">EXIT</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">238</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     closesocket(ClientSocket);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">239</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">最初这个函数也许有些拥簇，现在保留它只是为了向后兼容。
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">240</span>      <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">但是调用它可能会更安全，可能某些实现会使用它来结束ws2_32.DLL</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">241</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     WSACleanup();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">242</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">243</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">244</span> <span style="margin:0px; padding:0px; line-height:1.5!important">}
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">245</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">246</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">发送消息子线程</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">247</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI SendThread(LPVOID lpParameter)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">248</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{    
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">249</span>     SendMsgStruct *myStruct = (SendMsgStruct *<span style="margin:0px; padding:0px; line-height:1.5!important">)lpParameter;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">250</span>     SOCKET ClientSocket = myStruct-&gt;<span style="margin:0px; padding:0px; line-height:1.5!important">clientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">251</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span> SendMsg = myStruct-&gt;<span style="margin:0px; padding:0px; line-height:1.5!important">msg;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">252</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr_in ServerAddr = myStruct-&gt;<span style="margin:0px; padding:0px; line-height:1.5!important">ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">253</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">254</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span>( <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">true</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">255</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    {    
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">256</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> flag = <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">257</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> bufSize =<span style="margin:0px; padding:0px; line-height:1.5!important"> SendMsg.length();
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">258</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">char</span> * buf = const_cast&lt;<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">char</span>*&gt;<span style="margin:0px; padding:0px; line-height:1.5!important">(SendMsg.c_str());
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">259</span>         flag = send(ClientSocket, buf, bufSize, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">260</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">261</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">判断当前时候存在可用连接,如果没有，再次连接</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">262</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span>( flag == -<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span> || flag == <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">263</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">264</span>             cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">准备重连</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">265</span>             <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">shutdown(ClientSocket,2);</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">266</span> <span style="margin:0px; padding:0px; line-height:1.5!important">            closesocket(ClientSocket);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">267</span>             ClientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">268</span>             <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> cunnectFlag = connect(ClientSocket,(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;ServerAddr, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(ServerAddr));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">269</span>             
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">270</span>             <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( cunnectFlag ==<span style="margin:0px; padding:0px; line-height:1.5!important"> SOCKET_ERROR )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">271</span> <span style="margin:0px; padding:0px; line-height:1.5!important">            {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">272</span>                 cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">重连失败 :</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">273</span>                 Sleep(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">5000</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">274</span>                 <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">cunnectFlag = connect(ClientSocket,(struct sockaddr*)&amp;ServerAddr, sizeof(ServerAddr));</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">275</span> <span style="margin:0px; padding:0px; line-height:1.5!important">            }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">276</span>             <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">277</span> <span style="margin:0px; padding:0px; line-height:1.5!important">            {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">278</span>                 <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">break</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">279</span> <span style="margin:0px; padding:0px; line-height:1.5!important">            }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">280</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">281</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">282</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">传输过程中报错
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">283</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">if( flag == SOCKET_ERROR )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">284</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">285</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">        cout&lt;&lt;"消息发送过程中报错:"&lt;&lt;GetLastError()&lt;&lt;endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">286</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">}
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">287</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">没有传输完成
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">288</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">else if( flag &lt; bufSize )</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">289</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( flag &lt;<span style="margin:0px; padding:0px; line-height:1.5!important"> bufSize )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">290</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">291</span>             flag = send(ClientSocket, buf, bufSize - flag, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">292</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">293</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">传输成功</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">294</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">295</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">296</span>             cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">\n消息传输成功</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">297</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">298</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">299</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">每5秒发送一次</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">300</span>         Sleep(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">5000</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">301</span> <span style="margin:0px; padding:0px; line-height:1.5!important">    }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">302</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">303</span> <span style="margin:0px; padding:0px; line-height:1.5!important">}
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">304</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">305</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">接收消息子线程</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">306</span> <span style="margin:0px; padding:0px; line-height:1.5!important">DWORD WINAPI RecvThread(LPVOID lpParameter)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">307</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">308</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">309</span>     RecvMsgStruct *recvStruct=(RecvMsgStruct *<span style="margin:0px; padding:0px; line-height:1.5!important">)lpParameter;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">310</span>     SOCKET clientSocket = recvStruct-&gt;<span style="margin:0px; padding:0px; line-height:1.5!important">clientSocket;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">311</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr_in ServerAddr = recvStruct-&gt;<span style="margin:0px; padding:0px; line-height:1.5!important">ServerAddr;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">312</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">char</span> recvBuf[<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">500</span>]={<!-- --><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; line-height:1.5!important">}; 
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">313</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span> byteRecv = recv(clientSocket, recvBuf, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">500</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">314</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">int</span><span style="margin:0px; padding:0px; line-height:1.5!important"> connectState;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">315</span>      <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">while</span>( byteRecv == <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important"> )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">316</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">317</span>          <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">连接断开，重连</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">318</span>         cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">byteRecv == 0</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">319</span>         shutdown(clientSocket,<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">2</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">320</span>         <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">closesocket(ClientSocket);</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">321</span>         clientSocket =<span style="margin:0px; padding:0px; line-height:1.5!important"> socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">322</span>         connectState = connect(clientSocket,(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">struct</span> sockaddr*)&amp;ServerAddr, <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">sizeof</span><span style="margin:0px; padding:0px; line-height:1.5!important">(ServerAddr));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">323</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">324</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">if</span>( connectState ==<span style="margin:0px; padding:0px; line-height:1.5!important"> SOCKET_ERROR )
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">325</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">326</span>             cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">建立连接发生错误,错误代码:</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;GetLastError()&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">327</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">328</span>         <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">else</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">329</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        {
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">330</span>             cout&lt;&lt;<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">-----------------------------------------------In</span><span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">"</span>&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">331</span>             byteRecv = recv(clientSocket, recvBuf, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">500</span>, <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span>);<span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">建立连接后，重新获取一次消息</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">332</span>             recvBuf[byteRecv]=<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">333</span> <span style="margin:0px; padding:0px; line-height:1.5!important">        }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">334</span>         Sleep(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">5000</span><span style="margin:0px; padding:0px; line-height:1.5!important">);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">335</span> <span style="margin:0px; padding:0px; line-height:1.5!important">     }
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">336</span>     cout&lt;&lt;recvBuf&lt;&lt;<span style="margin:0px; padding:0px; line-height:1.5!important">endl;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">337</span>     <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">return</span> <span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span><span style="margin:0px; padding:0px; line-height:1.5!important">;
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">338</span> <span style="margin:0px; padding:0px; line-height:1.5!important">}
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">339</span> 
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">340</span> <span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">//</span><span style="margin:0px; padding:0px; color:rgb(0,128,0); line-height:1.5!important">移除字符串首尾空格</span>
<span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">341</span> <span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">void</span> trim(<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span> &amp;<span style="margin:0px; padding:0px; line-height:1.5!important">str)
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">342</span> <span style="margin:0px; padding:0px; line-height:1.5!important">{
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">343</span>       str.erase(str.find_last_not_of(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">'</span> <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">'</span>)+<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">1</span>,<span style="margin:0px; padding:0px; color:rgb(0,0,255); line-height:1.5!important">string</span><span style="margin:0px; padding:0px; line-height:1.5!important">::npos);
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">344</span>       str.erase(<span style="margin:0px; padding:0px; color:rgb(128,0,128); line-height:1.5!important">0</span>,str.find_first_not_of(<span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">'</span> <span style="margin:0px; padding:0px; color:rgb(128,0,0); line-height:1.5!important">'</span><span style="margin:0px; padding:0px; line-height:1.5!important">));
</span><span style="margin:0px; padding:0px; color:rgb(0,128,128); line-height:1.5!important">345</span> }</pre> 
  <div class="cnblogs_code_toolbar" style="margin:5px 0px 0px; padding:0px"> 
   <span class="cnblogs_code_copy" style="margin:0px; padding:0px 5px 0px 0px; line-height:1.5!important"><a target="_blank" title="复制代码" style="margin:0px; padding:0px; color:rgb(73,73,73); font-family:Arial,Helvetica,sans-serif; font-size:14px; text-decoration:underline; line-height:normal; border:none!important"><img alt="复制代码" src="" style="margin:0px; padding:0px; max-width:900px; border:none!important"></a></span> 
  </div> 
 </div> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8e65c9d999191779d9733afb473c8089/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python语法学习—打印九九乘法表</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f05c944dda65303f205685dbff62cfa3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ByteBuffer详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>