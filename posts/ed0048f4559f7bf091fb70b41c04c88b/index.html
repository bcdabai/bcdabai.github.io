<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Power Query 系列 (13) - 自定义函数 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Power Query 系列 (13) - 自定义函数" />
<meta property="og:description" content="本篇博客介绍 Power Query 自定义函数的技巧，在 PQ 中计算个税。
以工资类所得应交个税为例，最新的个税起征点为 5000 并按下表的级次进行缴税（假设没有其它扣除项）。
对照税率表，我们先看看手工如何计算。比如 xxx 的薪资为 8900，没有其它扣除，那么应缴纳的个税为：
1: 应纳税所得额 = 8900 - 5000 = 3900 2： 3900 对应级数为 1，应纳税额 = 3900 * 10% - 210 = 180 接下来介绍在 PQ 中如何通过自定义函数来计算。有下面两个表：税率表（TaxRate）he员工薪资表（salaries），要计算张三和李四应交个税金额。假设我们用自定义函数的方式。本文将给出三种方法。
将 Excel 工作表中的两个数据源通过 Ctrl &#43; T 转换成表，加载到 PQ 中。
函数的语法 PQ 函数的语法示例：
(x, y) =&gt; x &#43; y 方法1：在高级编辑器中手写代码。新建一个空查询，改名为 GetIncomeTax，进入高级查询，在高级查询中输入下面的代码：
(taxable) =&gt; if taxable &lt;=0 then 0 else if taxable &lt;= 3000 then taxable * 0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ed0048f4559f7bf091fb70b41c04c88b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-09-13T07:14:21+08:00" />
<meta property="article:modified_time" content="2019-09-13T07:14:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Power Query 系列 (13) - 自定义函数</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>本篇博客介绍 Power Query 自定义函数的技巧，在 PQ 中计算个税。</p> 
<p>以工资类所得应交个税为例，最新的个税起征点为 5000 并按下表的级次进行缴税（假设没有其它扣除项）。<br> <img src="https://images2.imgbox.com/f9/f0/JV3PDKci_o.png" alt=""></p> 
<p>对照税率表，我们先看看手工如何计算。比如 xxx 的薪资为 8900，没有其它扣除，那么应缴纳的个税为：</p> 
<pre><code>1:  应纳税所得额 = 8900 - 5000 = 3900
2： 3900 对应级数为 1，应纳税额 = 3900 * 10% - 210 = 180
</code></pre> 
<p>接下来介绍在 PQ 中如何通过自定义函数来计算。有下面两个表：税率表（TaxRate）he员工薪资表（salaries），要计算张三和李四应交个税金额。假设我们用自定义函数的方式。本文将给出三种方法。</p> 
<p>将 Excel 工作表中的两个数据源通过 Ctrl + T 转换成表，加载到 PQ 中。<br> <img src="https://images2.imgbox.com/0c/b0/LLFOeTid_o.png" alt=""></p> 
<h3><a id="_17"></a>函数的语法</h3> 
<p>PQ 函数的语法示例：</p> 
<pre><code>(x, y) =&gt; x + y
</code></pre> 
<p>方法1：在高级编辑器中手写代码。新建一个<strong>空查询</strong>，改名为 GetIncomeTax，进入高级查询，在高级查询中输入下面的代码：</p> 
<pre><code>(taxable) =&gt;
    if taxable &lt;=0 then 0
    else if taxable &lt;= 3000 then taxable * 0.03
    else if taxable &lt;= 12000 then taxable * 0.1 - 210
    else if taxable &lt;= 25000 then taxable * 0.2 - 1410
    else if taxable &lt;= 35000 then taxable * 0.25 - 2660
    else if taxable &lt;= 55000 then taxable * 0.3 - 4410
    else if taxable &lt;= 80000 then taxable *0.35 - 7160
    else taxable * 0.45 - 15160
</code></pre> 
<p>点击<strong>完成</strong>按钮，回到查询编辑器界面，这个函数就完成了。以上代码跟其他编程语言差不多，思路比较直观。可以通过上面代码熟悉 M语言 <code>if then else</code> 的语法。</p> 
<h3><a id="_40"></a>函数调用</h3> 
<p>选中 salaries 查询，右键，点击【复制】，将 salaries 查询表复制一个名为 IncomeTaxMethod1 的新查询，添加一个自定义列， 计算应纳税所得额 (用 Taxable 表示）：<br> <img src="https://images2.imgbox.com/ba/ac/PIdzs5mg_o.png" alt=""><br> 再增加一个计算列，调用自定义函数 <code>GetIncomeTax</code> 计算个税 ：<br> <img src="https://images2.imgbox.com/3a/48/7IodXWpH_o.png" alt=""><br> <img src="https://images2.imgbox.com/92/1c/6Y1uVq4j_o.png" alt=""><br> 点击<strong>完成</strong>按钮回到查询编辑器界面，第一种方法定义函数和调用函数完成。</p> 
<p><img src="https://images2.imgbox.com/fd/7c/QjhmOlmO_o.png" alt=""><br> 对应的 M 语言脚本：</p> 
<pre><code>let
    源 = Excel.CurrentWorkbook(){[Name="salaries"]}[Content],
    ChangedTypes = Table.TransformColumnTypes(源,{<!-- -->{"Name", type text}, {"Salary", Int64.Type}}),
    
    AddedTaxableCol = Table.AddColumn(
        ChangedTypes, 
        "Taxable", 
        each [Salary] - 5000),
        
    Result = Table.AddColumn(
        AddedTaxableCol, "IncomeTax", each GetIncomeTax([Taxable]))
in
    Result
</code></pre> 
<h3><a id="_68"></a>查询转函数</h3> 
<p>方法2：方法 2 的个税计算方法来自于我见过的 Excel 中最简洁的计算公式：</p> 
<pre><code>=ROUND(MAX((B4-5000)*{3;10;20;25;30;35;45}%-{0;210;1410;2660;4410;7160;15160},0),2)
</code></pre> 
<p>公式中只有一个参数，但这个公式有点晦涩，先解释一下。这个公式用到了 Excel 的数组。第一个数组是<strong>税率</strong>， 为方便表述称为 taxrate_array，第二个数组是<strong>速算扣除数</strong>，为表述方便称为 deduction_array:</p> 
<pre><code>taxrate_array: {3;10;20;25;30;35;45}
deduction_array: {0;210;1410;2660;4410;7160;15160}
</code></pre> 
<p>所以，</p> 
<pre><code>(D2-5000)*{3;10;20;25;30;35;45}%-{0;210;1410;2660;4410;7160;15160}
</code></pre> 
<p>表示是将 (salary-5000）后的值 （taxable）与 taxrate_array 数组的每一个元素进行计算，再减去 deduction_array 数组的对应值，结果组成一个新数组。然后再从这个结果数组中取最大值，四舍五入保留两位小数。用伪代码表述更加清晰：</p> 
<pre><code>taxable = salary - 5000
incomeTax = {taxable*0.03-0; taxable*0.1-210; taxable*0.2-1410; ...}
incomeTax = Max({incomeTax})
IncomeTax = Round(IncomeTax, 2)
</code></pre> 
<p>这个算法是怎么想出来的我们不去管它，主要讲解在 PQ 中用同样算法实现的步骤。</p> 
<p>选中 TaxrateTable 查询，右键，点击【引用】菜单，得到一个新的查询，将查询改名为 <code>GetTax</code>。后面基于这个查询编写计算个税的函数。<br> <img src="https://images2.imgbox.com/92/d5/vAU3tQmD_o.png" alt=""></p> 
<p>根据刚才的 Excel 公式，上图中 Level 字段、TaxableFrom 字段和 TaxableTo 字段是无关字段，可以删除。可以用 <code>Table.RemoveColumn</code> 函数删除，也可以使用 <code>Table.SelectColumns</code> 函数保留需要的列。本次使用<code>Table.SelectColumns</code> 函数。在高级编辑器或公式栏中操作都可以：</p> 
<pre><code>SelectedCols = Table.SelectColumns(Source, {"Rate", "Deduction"})
</code></pre> 
<p><img src="https://images2.imgbox.com/c3/0a/jiM4XW7O_o.png" alt=""><br> 这样选择了相关的两列，查询编辑器界面如下：</p> 
<p><img src="https://images2.imgbox.com/11/73/YkxW793F_o.png" alt=""><br> 函数需要参数，比如计算个税需要应纳税所得额。为了方便，我先用一个特定值，后面再替换。进入高级编辑器，目前的代码如下：</p> 
<pre><code>let
    Source = TaxRatesTable,
    SelectedCols = Table.SelectColumns(Source, {"Rate", "Deduction"})
in
    SelectedCols
</code></pre> 
<p>比如用刚才的应纳税所得额 3900，将代码变更为：</p> 
<pre><code>let
    taxable = 3900,
    Source = TaxRatesTable,
    SelectedCols = Table.SelectColumns(Source, {"Rate", "Deduction"})
in
    SelectedCols
</code></pre> 
<p>注意下图我的变更是插入了一个变量：<br> <img src="https://images2.imgbox.com/5a/e8/KcO2sXnK_o.png" alt=""></p> 
<p>然后增加一个自定义列 Trial (表示试算）：</p> 
<p><img src="https://images2.imgbox.com/56/10/eqH6AjLu_o.png" alt=""><br> 此时查询编辑器界面如下：</p> 
<p><img src="https://images2.imgbox.com/96/d2/Oe7wnqON_o.png" alt=""></p> 
<p>对应的 M 语言代码如下：</p> 
<pre><code>let
    taxable = 3900,
    Source = TaxRatesTable,
    SelectedCols = Table.SelectColumns(Source, {"Rate", "Deduction"}),
    Trials = Table.AddColumn(
        SelectedCols, 
        "Trial", 
        each taxable * [Rate] - [Deduction])
in
    Trials
</code></pre> 
<p><img src="https://images2.imgbox.com/ce/cd/1jHL8msI_o.png" alt=""><br> 接下来取出 Trial 列的最大值。我们知道 Table 每列都是 List 类型的数据，所以可以增加一个步骤，命名为 MaxOfTrial，在公式栏输入：</p> 
<pre><code>= List.Max(Trials[Trial])
</code></pre> 
<p>再套用 <code>Number.Round</code> 函数:</p> 
<pre><code>= Number.Round(List.Max(Trials[Trial]),2)
</code></pre> 
<p>此时查询编辑器的界面如下：</p> 
<p><img src="https://images2.imgbox.com/49/4a/HraLOgLK_o.png" alt=""><br> 对应的 M 语言代码如下：</p> 
<pre><code>let
    taxable = 3900,
    Source = TaxRatesTable,
    SelectedCols = Table.SelectColumns(Source, {"Rate", "Deduction"}),
    
    Trials = Table.AddColumn(
        SelectedCols, 
        "Trial", 
        each taxable * [Rate] - [Deduction]),
        
    MaxOfTrial = Number.Round(List.Max(Trials[Trial]),2)
in
    MaxOfTrial
</code></pre> 
<p>接下来是见证奇迹的时刻，在高级编辑器中将代码变更为：</p> 
<pre><code>(taxable as number ) as number =&gt;
    let
        Source = TaxRatesTable,
        SelectedCols = Table.SelectColumns(Source, {"Rate", "Deduction"}),
        
        Trials = Table.AddColumn(
            SelectedCols, 
            "Trial", 
            each taxable * [Rate] - [Deduction]),
        MaxOfTrial = Number.Round(List.Max(Trials[Trial]),2)
    in
        MaxOfTrial
</code></pre> 
<p>回到查询编辑器界面，PQ 将查询变成了函数。经过本步骤，第二种方法定义函数完成。请体会和掌握如何将查询转换成函数，这种方式可以将编写函数的步骤分解，并且能看到每一个步骤的计算结果，从而降低了手写代码的难度。</p> 
<p><img src="https://images2.imgbox.com/9c/59/kBrzVLji_o.png" alt=""><br> 函数的调用比较简单，略去不提。</p> 
<p>个税计算方法 3： 对于应纳税所得额来说，需要在 TaxRatesTable 中找到对应行，从而确定税率和速算扣除数。仍以 3900 的应纳税所得额为例，对应下图的级次确定税率和速算扣除数：</p> 
<p><img src="https://images2.imgbox.com/70/5e/rHo7yREm_o.png" alt=""><br> 在 PQ 中，从另外一个 Table 中找出一行，使用<strong>构造结构化列</strong>的方法。这种方法具有普遍意义，能够处理两个表没有相等值，从而不能用合并查询的场景。</p> 
<p>选中 salaries 查询表，右键菜单【引用】，新建一个名为 IncomeTaxMethod3 的查询。添加一个自定义列。这一列每个单元格都包含完整的 TaxRatesTable 查询表数据。</p> 
<p><img src="https://images2.imgbox.com/ae/ac/Od1FtGXY_o.png" alt=""><br> 回到<strong>查询编辑器界</strong>面，我们看到，TaxInfo 每一个单元格都包含 TaxRateTable 的所有数据，我们需要对 sub-table 的数据进行筛选。</p> 
<p><img src="https://images2.imgbox.com/10/6f/0nimyAVV_o.png" alt=""></p> 
<p>这种操作技巧在本系列第 11 篇有详细介绍，本篇就不再赘述。在高级编辑器中，将代码变更。变更前代码：</p> 
<pre><code>let
    Source = salaries,
    AddedTaxData = Table.AddColumn(Source, "TaxInfo", each TaxRatesTable)
in
    AddedTaxData
</code></pre> 
<p>变更后代码后：</p> 
<pre><code class="prism language-let">    Source = salaries,
    AddedTaxData = Table.AddColumn(
        Source, 
        "TaxInfo", 
        each Table.SelectRows(
                TaxRatesTable, 
                (row)=&gt;row[TaxableFrom]&lt;=[Salary] - 5000
        )
    )
in
    AddedTaxData

</code></pre> 
<p>通过 <code>Table.SelectRows</code> 将税率级次高的数据排除掉。比如 8900 - 5000 = 3900，则只需先下面两行：</p> 
<p><img src="https://images2.imgbox.com/1b/a7/VUAztDlt_o.png" alt=""><br> 接下来调用 <code>Table.Last</code> 函数获取最后一行，得到一个 record 类型的数据：</p> 
<pre><code>let
    Source = salaries,
    AddedTaxData = Table.AddColumn(
        Source, 
        "TaxInfo", 
        each Table.Last(
            Table.SelectRows(
                TaxRatesTable, 
                (row)=&gt;row[TaxableFrom]&lt;=[Salary] - 5000
        ))
    )
in
    AddedTaxData
</code></pre> 
<p>这时 TaxInfo 变成了 record，对 TaxInfo 列进行展开操作，保留 Rate 和 Deduction:</p> 
<p><img src="https://images2.imgbox.com/37/d9/x7xK05Zm_o.png" alt=""><br> 查询编辑器的界面如下：</p> 
<p><img src="https://images2.imgbox.com/0e/eb/D9AGqLo1_o.png" alt=""></p> 
<p>最后添加一个计算列，计算出各自的个税：</p> 
<p><img src="https://images2.imgbox.com/c8/94/IB97YZbb_o.png" alt=""><br> 这种结构化列的方法，同样可以先做出查询，然后转换成函数。操作过程类似，就不重复说明了。给出获取 TaxRateTable 相应行的函数代码：</p> 
<pre><code>(taxable as number) =&gt;
    let
        Source = Table.SelectColumns(TaxRatesTable, {"TaxableFrom", "Rate", "Deduction"}),
        SelectedRow = Table.Last(
            Table.SelectRows(
                Source,  (row)=&gt;row[TaxableFrom] &lt;= taxable   
            )) 
    in
        SelectedRow
</code></pre> 
<p>示例数据已经放到 <a href="https://github.com/stonewm/python-practice-projects/tree/master/Power%20Query%20Sample%20Data">github - Income Tax Calculation</a> 上，方便大家学习。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dade30fe6b806378b42457d1d7e885ee/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">6-5抽象类和抽象方法的使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/70964e8ff07c73dac79e2191e8f56413/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Dubbo框架项目 启动服务提供者 tomcat报错[ERROR] No plugin found for prefix &#39;tomcat7&#39; in the current project and in</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>