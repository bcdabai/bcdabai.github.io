<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kubeadm搭建高可用K8S（一）环境准备 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kubeadm搭建高可用K8S（一）环境准备" />
<meta property="og:description" content="前提：自行安装VMWare 1.准备至少三套CentOS7系统，入门配置：master节点需要4G4C，worker节点需要2G2C
2.每台机器配置好静态IP
3.保证各个机器之间和宿主机之间通信没有问题
一、多master节点单node节点机器配置 集群角色IP主机名安装的组件Master-1192.168.74.10master01apiserver、controller-manager、scheduler、kubelet、etcd、docker、kube-proxy、keepalived、nginx、calicoMaster-2192.168.74.11master02apiserver、controller-manager、scheduler、kubelet、etcd、docker、kube-proxy、keepalived、nginx、calicoWorker-1192.168.74.12worker01kubelet、kube-proxy、docker、calico、corednsWorker-2192.168.74.13worker02kubelet、kube-proxy、docker、calico、corednsvirtual-ip(VIP)192.168.74.110 二、各机器实验环境准备 配置虚拟机静态IP vim /etc/sysconfig/network-scripts/ifcfg-ens33 配置主机名 # 每一台机器都操作 # 机器之间可以通过主机名访问 hostnamectl set-hostname master1 &amp;&amp; bash # 查看主机状况 hostnamectl 配置主机host文件 vim /etc/hosts # [ip] [hostname] 192.168.74.10 master01 # 【验证】互相ping域名，能够通 ping master02 ping www.baidu.com 配置主机之间无密码登录 # 要在每一台机器上都执行，且都需要拷贝（两两相互） # 使得机器之间可以无密码相互访问 ssh-keygen #一路回车，不输入密码 # 把本地生成的密钥文件和私钥文件拷贝到远程主机 ssh-copy-id master1 ssh-copy-id master2 ssh-copy-id worker1 ssh-copy-id -i /root/.ssh/id_rsa.pub master1 #【验证】在master1上执行 ssh root@master2 # 是否可以无密码跳转登录 ls -a #查看隐藏文件夹 .ssh 关闭交换分区swap # 要在每一台机器上都操作 # 避免资源耗尽导致k8s异常，提升性能 #1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/db4b8512f7eb680c58c896b3fe4095c4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-08T17:55:57+08:00" />
<meta property="article:modified_time" content="2022-06-08T17:55:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kubeadm搭建高可用K8S（一）环境准备</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>前提：自行安装VMWare</h2> 
<p>1.准备至少三套CentOS7系统，入门配置：master节点需要4G4C，worker节点需要2G2C</p> 
<p>2.每台机器配置好静态IP</p> 
<p>3.保证各个机器之间和宿主机之间通信没有问题</p> 
<h2>一、多master节点单node节点机器配置</h2> 
<table><thead><tr><th>集群角色</th><th>IP</th><th>主机名</th><th>安装的组件</th></tr></thead><tbody><tr><td>Master-1</td><td>192.168.74.10</td><td>master01</td><td>apiserver、controller-manager、scheduler、kubelet、etcd、docker、kube-proxy、keepalived、nginx、calico</td></tr><tr><td>Master-2</td><td>192.168.74.11</td><td>master02</td><td>apiserver、controller-manager、scheduler、kubelet、etcd、docker、kube-proxy、keepalived、nginx、calico</td></tr><tr><td>Worker-1</td><td>192.168.74.12</td><td>worker01</td><td>kubelet、kube-proxy、docker、calico、coredns</td></tr><tr><td>Worker-2</td><td>192.168.74.13</td><td>worker02</td><td>kubelet、kube-proxy、docker、calico、coredns</td></tr><tr><td>virtual-ip(VIP)</td><td>192.168.74.110</td><td></td><td></td></tr></tbody></table> 
<h2>二、各机器实验环境准备</h2> 
<h3>配置虚拟机静态IP</h3> 
<pre><code>vim /etc/sysconfig/network-scripts/ifcfg-ens33</code></pre> 
<h3>配置主机名</h3> 
<pre><code># 每一台机器都操作
# 机器之间可以通过主机名访问
hostnamectl set-hostname master1 &amp;&amp; bash
# 查看主机状况
hostnamectl</code></pre> 
<h3>配置主机host文件</h3> 
<pre><code>vim /etc/hosts
# [ip] [hostname]
192.168.74.10 master01
# 【验证】互相ping域名，能够通
ping master02
ping www.baidu.com</code></pre> 
<h3>配置主机之间无密码登录</h3> 
<pre><code># 要在每一台机器上都执行，且都需要拷贝（两两相互）
# 使得机器之间可以无密码相互访问
ssh-keygen  #一路回车，不输入密码
# 把本地生成的密钥文件和私钥文件拷贝到远程主机
ssh-copy-id master1
ssh-copy-id master2
ssh-copy-id worker1
ssh-copy-id -i /root/.ssh/id_rsa.pub master1
#【验证】在master1上执行
ssh root@master2
# 是否可以无密码跳转登录
ls -a #查看隐藏文件夹 .ssh</code></pre> 
<h3>关闭交换分区swap</h3> 
<pre><code># 要在每一台机器上都操作
# 避免资源耗尽导致k8s异常，提升性能
#1.临时关闭
swapoff -a
#2.永久关闭：注释swap挂载，给swap这行开头加一下注释
vim /etc/fstab
    /dev/mapper/centos-swap swap      swap    defaults        0 0
#如果是克隆的虚拟机，需要删除UUID
# 运行完毕后，查看交换分区情况，执行如下命令：
free -m</code></pre> 
<h3>修改机器内核参数 </h3> 
<pre><code># 要在每一台机器上都操作
# 开启包转发等等（？？）
modprobe br_netfilter
​
echo "modprobe br_netfilter" &gt;&gt; /etc/profile
​
cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt;EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF
​
# 在运行时配置内核参数 -p：从指定的文件加载系统参数，如不指定即从/etc/sysctl.conf中加载
sysctl -p /etc/sysctl.d/k8s.conf
​
# 为什么要修改内核参数
#/etc/sysctl.d/k8s.conf文件中三行参数的意思</code></pre> 
<h3>关闭firewalld防火墙</h3> 
<pre><code># 要在每一台机器上都操作
# 安全相关，kubeadm初始化检测项目
systemctl stop firewalld ; systemctl disable firewalld
# 查看防火墙状态
systemctl status firewalld 
# 或者
firewall-cmd --state</code></pre> 
<h3>关闭selinux (?)</h3> 
<pre><code># 要在每一台机器上都操作
# 安全相关，kubeadm初始化检测项目
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
#修改selinux配置文件之后，重启机器，selinux配置才能永久生效
​
#显示Disabled说明selinux已经关闭
getenforce</code></pre> 
<h3>配置阿里云的repo源</h3> 
<pre><code># 要在每一台机器上都操作
# 安装文件操作工具
yum install lrzsz -y
yum install openssh-clients
# 备份repo源(只需要操作Base源即可，其他保留)
mkdir /root/repo.bak
cd /etc/yum.repos.d/
mv CentOS-Base.repo /root/repo.bak/
# 把CentOS-Base.repo文件上传到master1主机的/etc/yum.repos.d/目录下
​
#安装yum-utils
yum -y install yum-utils
# 配置国内阿里云docker的repo源
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
# 配置epel.repo
# 直接上传文件即可
# 最终/etc/yum.repo.d/下有 CentOS-Base.repo、docker-ce.repo、epel.repo</code></pre> 
<h3>配置安装k8s组件需要的阿里云的repo源 （二进制不需要做）</h3> 
<pre><code># 编辑文件
vim  /etc/yum.repos.d/kubernetes.repo
# 内容如下
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=0
# 使用scp命令将文件copy到其他虚拟机
scp /etc/yum.repos.d/kubernetes.repo master2:/etc/yum.repos.d/</code></pre> 
<h3>配置时间同步</h3> 
<pre><code># 要在每一台机器上都操作
# kubeadm要求的
# 安装时间同步工具
yum install ntpdate -y
# 跟网络时间做同步
ntpdate cn.pool.ntp.org
# 把时间同步做成计划任务
crontab -e
# 内容如下：
* */1 * * * /usr/sbin/ntpdate   cn.pool.ntp.org
# 重启定时服务
service crond restart</code></pre> 
<h3>开启IPVS</h3> 
<pre><code># 要在每一台机器上都操作
# 作用：数据包转发
# 把ipvs.modules脚本上传到master1机器的/etc/sysconfig/modules/目录下，其他可使用scp命令拷贝
chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash
# 执行命令并检测
/etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep ip_vs
# 结果如下即可
ip_vs_ftp              13079  0 
nf_nat                 26583  1 ip_vs_ftp
ip_vs_sed              12519  0 
ip_vs_nq               12516  0 
ip_vs_sh               12688  0 
ip_vs_dh               12688  0 </code></pre> 
<h3>安装基础软件包</h3> 
<pre><code># 要在每一台机器上都操作
yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack ntpdate telnet ipvsadm</code></pre> 
<h3>安装iptables</h3> 
<pre><code># 要在每一台机器上配置
# 由于k8s配置一些规则要用到iptables
yum install iptables-services -y
# 禁用
service iptables stop &amp;&amp; systemctl disable iptables
# 清空防火墙规则
iptables -F</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dfa340dbd3e4c15e07af0e794a2a6d99/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java 8 date/time type `java.time.LocalDateTime` not supported by default</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/74eb1d45fb5f9872bb85021244e02ab9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">服务器安全防护措施有哪些？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>