<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Qt实现拖拽功能（支持拖放文件、拖放操作） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Qt实现拖拽功能（支持拖放文件、拖放操作）" />
<meta property="og:description" content="目录 拖放Qt程序接受其他程序的拖拽部件/控件之间相互拖放总结 拖放 拖放是在一个应用程序内或者多个应用程序之间传递信息的一种直观的现代操作方式。除了为剪贴板提供支持外,通常它还提供数据移动和复制的功能。
拖放操作包括两个截然不同的动作:拖动和放下。Qt窗口部件可以作为拖动点(darg site)、放下点(drop site)或者同时作为拖动点和放下点。
Qt程序接受其他程序的拖拽 我们经常将文本文件推拽到notepate&#43;&#43;等类型文本编辑器软件中。那么如何让Qt程序也能够支持这种操作呢？
我们需要在主窗口重新实现了来自父类的dragEnterEvent()和 dropEvent()函数。
protected: virtual void dragEnterEvent(QDragEnterEvent* event) override; virtual void dropEvent(QDropEvent* event) override; 在构造函数中,创建了一个QTextEdit并且把它设置为中央窗口部件。默认情况下，QTextEdit可以接受来自其他应用程序文本的拖动,并且如果用户在它上面放下一个文件,它将会把这个文件的内容填充到QTextEdit部件中。
由于拖放事件是从子窗口部件传递给父窗口部件的,所以通过禁用QTextEdit上的放下操作以及启用主窗口上的放下操作,就可以在整个MainWindow窗口中获得放下事件。
#include &lt;QMimeData&gt; #include &lt;QTextStream&gt; MainWindow::MainWindow(QWidget *parent) : QMainWindow(parent) , ui(new Ui::MainWindow) { ui-&gt;setupUi(this); textEdit = new QTextEdit(this); setCentralWidget(textEdit); textEdit-&gt;setAcceptDrops(false); setAcceptDrops(true); setWindowTitle(&#34;Text Editor&#34;); } 当用户把一个对象拖动到这个窗口部件上时,就会调用dragEnterEvent()。如果对这个事件调用acceptProposedAction(),就表明用户可以在这个窗口部件上拖放对象。默认情况下,窗口部件是不接受拖动的。Qt会自动改变光标来向用户说明这个窗口部件是不是有效的放下点。
这里,我们希望用户拖动的只能是文件,而非其他类型的东西。为了实现这一点,我们可以检查拖动的MIME类型。
MIME类型中的 text/uri-list 用于存储一系列的统一资源标识符(Universal Re-source Identifier ,URI),它们可以是文件名、统―资源定位器(Uniform Resource Locator , URL,如 HTTP或者FTP路径),或者其他全局资源标识符。标准的MIME类型是由国际因特网地址分配委员会(Internet Assigned Numbers Authority , IANA)定义的,它们由类型、子类型信息以及分隔两者的斜线组·成。MME类通常由剪贴板和拖放系统使用,以识别不同类型的数据。可以从下面的网站得到正式的 MIME类型列表: http://www.iana.org/assignments/media-types/
void MainWindow::dragEnterEvent(QDragEnterEvent *event) { if(event-&gt;mimeData()-&gt;hasFormat(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/92e89483d35f0295cfbb091a6888fd42/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-28T16:21:14+08:00" />
<meta property="article:modified_time" content="2023-06-28T16:21:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Qt实现拖拽功能（支持拖放文件、拖放操作）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_5" rel="nofollow">拖放</a></li><li><a href="#Qt_9" rel="nofollow">Qt程序接受其他程序的拖拽</a></li><li><a href="#_101" rel="nofollow">部件/控件之间相互拖放</a></li><li><a href="#_243" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_5"></a>拖放</h2> 
<p>拖放是在一个应用程序内或者多个应用程序之间传递信息的一种直观的现代操作方式。除了为剪贴板提供支持外,通常它还提供数据移动和复制的功能。</p> 
<p>拖放操作包括两个截然不同的动作:拖动和放下。Qt窗口部件可以作为拖动点(darg site)、放下点(drop site)或者同时作为拖动点和放下点。</p> 
<h2><a id="Qt_9"></a>Qt程序接受其他程序的拖拽</h2> 
<p>我们经常将文本文件推拽到notepate++等类型文本编辑器软件中。那么如何让Qt程序也能够支持这种操作呢？</p> 
<p>我们需要在主窗口重新实现了来自父类的<code>dragEnterEvent()</code>和 <code>dropEvent()</code>函数。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">dragEnterEvent</span><span class="token punctuation">(</span>QDragEnterEvent<span class="token operator">*</span> event<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">dropEvent</span><span class="token punctuation">(</span>QDropEvent<span class="token operator">*</span> event<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span>
</code></pre> 
<p>在构造函数中,创建了一个<code>QTextEdit</code>并且把它设置为中央窗口部件。默认情况下，<code>QTextEdit</code>可以接受来自其他应用程序文本的拖动,并且如果用户在它上面放下一个文件,它将会把这个文件的内容填充到QTextEdit部件中。</p> 
<p><strong>由于拖放事件是从子窗口部件传递给父窗口部件的,所以通过禁用QTextEdit上的放下操作以及启用主窗口上的放下操作,就可以在整个MainWindow窗口中获得放下事件。</strong></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QMimeData&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QTextStream&gt;</span></span>
<span class="token class-name">MainWindow</span><span class="token double-colon punctuation">::</span><span class="token function">MainWindow</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">QMainWindow</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">ui</span><span class="token punctuation">(</span><span class="token keyword">new</span> Ui<span class="token double-colon punctuation">::</span>MainWindow<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ui<span class="token operator">-&gt;</span><span class="token function">setupUi</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
 
    textEdit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QTextEdit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCentralWidget</span><span class="token punctuation">(</span>textEdit<span class="token punctuation">)</span><span class="token punctuation">;</span>

    textEdit<span class="token operator">-&gt;</span><span class="token function">setAcceptDrops</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setAcceptDrops</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setWindowTitle</span><span class="token punctuation">(</span><span class="token string">"Text Editor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>当用户把一个对象拖动到这个窗口部件上时,就会调用<code>dragEnterEvent()</code>。如果对这个事件调用<code>acceptProposedAction()</code>,就表明用户可以在这个窗口部件上拖放对象。默认情况下,窗口部件是不接受拖动的。<em>Qt会自动改变光标来向用户说明这个窗口部件是不是有效的放下点</em>。</p> 
<p>这里,我们希望用户拖动的只能是文件,而非其他类型的东西。为了实现这一点,我们可以检查拖动的<code>MIME</code>类型。</p> 
<blockquote> 
 <p><code>MIME</code>类型中的 <code>text/uri-list</code> 用于存储一系列的统一资源标识符(Universal Re-source Identifier ,URI),它们可以是文件名、统―资源定位器(Uniform Resource Locator , URL,如 HTTP或者FTP路径),或者其他全局资源标识符。标准的MIME类型是由国际因特网地址分配委员会(Internet Assigned Numbers Authority , IANA)定义的,它们由类型、子类型信息以及分隔两者的斜线组·成。MME类通常由剪贴板和拖放系统使用,以识别不同类型的数据。可以从下面的网站得到正式的 MIME类型列表: http://www.iana.org/assignments/media-types/</p> 
</blockquote> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">MainWindow</span><span class="token double-colon punctuation">::</span><span class="token function">dragEnterEvent</span><span class="token punctuation">(</span>QDragEnterEvent <span class="token operator">*</span>event<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>event<span class="token operator">-&gt;</span><span class="token function">mimeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">hasFormat</span><span class="token punctuation">(</span><span class="token string">"text/uri-list"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        event<span class="token operator">-&gt;</span><span class="token function">acceptProposedAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>当用户在窗口部件上放下一个对象时,就会调用<code>dropEvent()</code>。.我们调用函数<code>QMimeData::urls()</code>来获得<code>QUrl</code>列表。通常,用户一次只拖动一个文件,但是通过拖动一个选择区域来同时拖动多个文件也是可能的。如果要拖放的URL不止一个,或者要拖放的URL,不是一个本地文件名,则会立即返回到原调用处。<br> <em>QWidget也提供 dragMoveEvent()和 dragLeaveEvent()函数,但是在绝大多数应用程序中并不需要重新实现它们。</em></p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">MainWindow</span><span class="token double-colon punctuation">::</span><span class="token function">dropEvent</span><span class="token punctuation">(</span>QDropEvent <span class="token operator">*</span>event<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QList<span class="token operator">&lt;</span>QUrl<span class="token operator">&gt;</span> urls <span class="token operator">=</span> event<span class="token operator">-&gt;</span><span class="token function">mimeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">urls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>urls<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    QString fileName <span class="token operator">=</span> urls<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">setWindowTitle</span><span class="token punctuation">(</span><span class="token function">QString</span><span class="token punctuation">(</span><span class="token string">"%1-%2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"Drag File"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">bool</span> <span class="token class-name">MainWindow</span><span class="token double-colon punctuation">::</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> QString <span class="token operator">&amp;</span>filename<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QFile <span class="token function">file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    file<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>QIODevice<span class="token double-colon punctuation">::</span>ReadOnly <span class="token operator">|</span> QIODevice<span class="token double-colon punctuation">::</span>Text <span class="token operator">|</span> QIODevice<span class="token double-colon punctuation">::</span>Truncate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">==</span> file<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    QTextStream <span class="token function">stream</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    textEdit<span class="token operator">-&gt;</span><span class="token function">insertPlainText</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span><span class="token function">readAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    file<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    file<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>看看效果吧<br> <img src="https://images2.imgbox.com/b1/43/VITpsYdk_o.gif" alt="在这里插入图片描述"></p> 
<h2><a id="_101"></a>部件/控件之间相互拖放</h2> 
<p>我们将实现类似于一个下图的效果，但不需要向左向右的按键，通过拖拽目标实现移动。<br> <img src="https://images2.imgbox.com/1d/25/1oT5MTbl_o.png" alt="在这里插入图片描述"></p> 
<p><strong>思路</strong>：创建一个支持拖拽的<code>QListWidget</code>子类<code>ProjectListWidget</code>，并且作为该界面的一个部件。</p> 
<p>在ProjectListWidget类中需要重写父类的五个事件，和一个私有方法以及一个坐标记录</p> 
<pre><code class="prism language-cpp"><span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">mousePressEvent</span><span class="token punctuation">(</span>QMouseEvent<span class="token operator">*</span> event<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">mouseMoveEvent</span><span class="token punctuation">(</span>QMouseEvent<span class="token operator">*</span> event<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">dragEnterEvent</span><span class="token punctuation">(</span>QDragEnterEvent<span class="token operator">*</span> event<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">dragMoveEvent</span><span class="token punctuation">(</span>QDragMoveEvent<span class="token operator">*</span> event<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">dropEvent</span><span class="token punctuation">(</span>QDropEvent<span class="token operator">*</span> event<span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">performDrag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    QPoint startPos<span class="token punctuation">;</span>
</code></pre> 
<p>在构造函数中,我们使列表框上的放下生效。</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QApplication&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QDrag&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QMimeData&gt;</span></span>
<span class="token class-name">ProjectListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">ProjectListWidget</span><span class="token punctuation">(</span>QWidget<span class="token operator">*</span> parent<span class="token punctuation">)</span>
    <span class="token operator">:</span>QListWidget<span class="token punctuation">{<!-- --></span>parent<span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">setAcceptDrops</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>当用户按下鼠标左键,就把鼠标位置保存到<code>statPos</code>私有变量中。然后我们正常调用QListWidget 中<code>mousePressEvent()</code>。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">ProjectListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">mousePressEvent</span><span class="token punctuation">(</span>QMouseEvent <span class="token operator">*</span>event<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>event<span class="token operator">-&gt;</span><span class="token function">button</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Qt<span class="token double-colon punctuation">::</span>LeftButton<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        startPos <span class="token operator">=</span> event<span class="token operator">-&gt;</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">QListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">mousePressEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当用户按住鼠标左键并移动鼠标光标时,就认为这是一个拖动的开始。我们计算当前鼠标位置和原来鼠标左键按下的点之间的距离-—这个“<strong>曼哈顿长度</strong>”(Manhattan Length)其实是从坐标原点到该矢量长度快速计算的近似值。如果这个距离大于或等于QApplication推荐的拖动起始距离值(通常是4个像素),那么就调用私有函数<code>performDrag()</code>以启动拖动操作。这可以避免用户因为手握鼠标抖动而产生拖动。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">ProjectListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">mouseMoveEvent</span><span class="token punctuation">(</span>QMouseEvent <span class="token operator">*</span>event<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>event<span class="token operator">-&gt;</span><span class="token function">buttons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Qt<span class="token double-colon punctuation">::</span>LeftButton<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">int</span> distance <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token operator">-&gt;</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startPos<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">manhattanLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            distance <span class="token operator">&gt;=</span> <span class="token class-name">QApplication</span><span class="token double-colon punctuation">::</span><span class="token function">startDragDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">performDrag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">QListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">mouseMoveEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>在<code>perfomDrag()</code>中,创建了一个类型为QDrag的对象,并且把this作为它的父对象。这个QDrag对象将数据存储在<code>QMimeData</code>对象中。在这个实例中,我们利用<code>QMineData::setText()</code>提供了作为<code>text/plain</code>字符串的数据。QMimeData 提供了一些可用于处理最常用拖放类型(诸如图像、URL、颜色，等等)的函数,同时也可以处理任意由QByteArrays表宗的MiME类型。<code>QDrag::setPiximap()</code>调用则可以在拖放发生时使图标随光标移动。<br> <code>QDrag::exec()</code>调用启动并执行拖动操作;直到用户放下或取消此次拖动操作才会停止。它把所有支持的“拖放动作"(如 Qi: : CopyAction, Qt : : MoveAction和 Qt: : LinkAction)的组合作为其参数，并且返回被执行的拖放动作(如果没有执行任何动作,则返回Qt: IgnoreAction)。至于执行的是哪`个动作,取决于放下发生时源窗口部件是否允许、目标是否支持及按下了哪些组合键。在 exec()调用后,Qt拥有拖动对象的所有权并且可以在不需要它的时候删除它。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">ProjectListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">performDrag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>QListWidgetItem<span class="token operator">*</span> item <span class="token operator">=</span> <span class="token function">currentItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">nullptr</span> <span class="token operator">!=</span> item<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        QMimeData<span class="token operator">*</span> mineData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QMimeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mineData<span class="token operator">-&gt;</span><span class="token function">setText</span><span class="token punctuation">(</span>item<span class="token operator">-&gt;</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        QDrag<span class="token operator">*</span> drag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QDrag</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        drag<span class="token operator">-&gt;</span><span class="token function">setMimeData</span><span class="token punctuation">(</span>mineData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        drag<span class="token operator">-&gt;</span><span class="token function">setPixmap</span><span class="token punctuation">(</span><span class="token function">QPixmap</span><span class="token punctuation">(</span><span class="token string">":/icon.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>drag<span class="token operator">-&gt;</span><span class="token function">exec</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>MoveAction<span class="token punctuation">)</span> <span class="token operator">==</span> Qt<span class="token double-colon punctuation">::</span>MoveAction<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">delete</span> item<span class="token punctuation">;</span>
            item <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>	
</code></pre> 
<p><strong>ProjectListWidget窗口部件不仅能发起拖动,还可以接收同一个应用程序中来自另外一个ProjectListWidget部件的拖动</strong>。如果窗口部件是同个应用程序的一部分,<code>QDragEnterEvent::source()</code>返回一个启动这个拖动的窗口部件的指针;否则,返回一个空指针值。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">ProjectListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">dragEnterEvent</span><span class="token punctuation">(</span>QDragEnterEvent <span class="token operator">*</span>event<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ProjectListWidget<span class="token operator">*</span> source <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>ProjectListWidget<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>event<span class="token operator">-&gt;</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span> <span class="token operator">!=</span> source <span class="token operator">&amp;&amp;</span> source <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        event<span class="token operator">-&gt;</span><span class="token function">setDropAction</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>MoveAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        event<span class="token operator">-&gt;</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>dragMoveEvent()中的代码与dragEnterEvent()中编写的代码基本相同。因为需要重写QListWidget的函数实现(实际上是 QAbstractItemView的函数实现)。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">ProjectListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">dragMoveEvent</span><span class="token punctuation">(</span>QDragMoveEvent <span class="token operator">*</span>event<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ProjectListWidget<span class="token operator">*</span> source <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>ProjectListWidget<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>event<span class="token operator">-&gt;</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span> <span class="token operator">!=</span> source <span class="token operator">&amp;&amp;</span> source <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        event<span class="token operator">-&gt;</span><span class="token function">setDropAction</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>MoveAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        event<span class="token operator">-&gt;</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在dropEvent()中,我们使用<code>QMimeData::text()</code>重新找回拖动的文本并随文本创建一个拖动项。还需要将事件作为“移动动作”来接受,从而告诉源窗口部件现在可以删除原来的拖动项了。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">ProjectListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">dropEvent</span><span class="token punctuation">(</span>QDropEvent <span class="token operator">*</span>event<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ProjectListWidget<span class="token operator">*</span> source <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>ProjectListWidget<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>event<span class="token operator">-&gt;</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span> <span class="token operator">!=</span> source <span class="token operator">&amp;&amp;</span> source <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">addItem</span><span class="token punctuation">(</span>event<span class="token operator">-&gt;</span><span class="token function">mimeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        event<span class="token operator">-&gt;</span><span class="token function">setDropAction</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>MoveAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        event<span class="token operator">-&gt;</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>效果如下<br> <img src="https://images2.imgbox.com/97/9e/3Xdzcuqv_o.gif" alt="在这里插入图片描述"></p> 
<h2><a id="_243"></a>总结</h2> 
<p>拖放是在应用程序之间传递数据的有力机制。但是在某些情况下;,有可能在执行拖放时并未使用Qt的拖放工具。如果只是想在一个应用程序的窗口部件中移动数据,通常只要重新实现mousePressEvent()和 mouseReleaseEvent()函数就可以了。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0d16a58d3ba9f9d666c806c95c8aa2db/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">wangEditor5 富文本编辑器基于 vue3、Nuxt3</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/61514279f4df9ae21c31eec577f85a16/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[web]前端富文本编辑器</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>