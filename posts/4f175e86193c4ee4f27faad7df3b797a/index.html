<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C# 读取Word表格到DataSet - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C# 读取Word表格到DataSet" />
<meta property="og:description" content="目录
功能需求
Office 数据源的一些映射关系
范例运行环境
配置Office DCOM
关键代码
组件库引入
​核心代码
杀掉进程
总结
功能需求 在应用项目里，多数情况下我们会遇到导入 Excel 文件数据到数据库的功能需求，但某些情况下，也存在使用 Word 进行表格数据编辑的情况。Word 和 Excel 其实各有特点，用户的习惯不同，即使同一数据源，可能提供的数据源文件类型也不同，这其中也包括导入Word内容的功能，比如表格数据导出到DataSet数据集。
Office 数据源的一些映射关系 下图是一个简单的 Office 数据源的映射关系：
1、第一层级比如 WORD / EXCEL 为应用层级（Application）、 DATASET / DATABASE 为数据容器
2、第二层级，比如WORD 包含一个文档对象（Docment）、Excel 包含一个工作簿对象（WorkBook）、DataSet / DataBase 包括一组数据表对象（Tables）
3、第三层级，比如Word里的表格对象（Table）、Excel里的工作表对象（Sheet）
最实际的工作任务，是要将Table或Sheet对象的二维数据对应导出生成到 DataSet 里的 Table 对象，如果有多个则生成对应的集合。最后我们可能会再次导出到 DataBase 的数据表集合里（Tables）。
范例运行环境 操作系统： Windows Server 2019 DataCenter
操作系统上安装 Office Word 2016
.net版本： .netFramework4.7.1 或以上
开发工具：VS2019 C#
配置Office DCOM 对于安装原生Office应用，我们需要对DCOM进行进一步的配置方可使用其API。
打开控制面板、管理工具、组件服务：
点击组件服务、计算机、我的电脑、DCOM配置 找到 Microsoft Word97-2003 文档应用程序" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4f175e86193c4ee4f27faad7df3b797a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-25T16:40:54+08:00" />
<meta property="article:modified_time" content="2023-12-25T16:40:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C# 读取Word表格到DataSet</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:40px;"><a href="#main-toc" rel="nofollow">功能需求</a></p> 
<p id="Office%20%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E4%B8%80%E4%BA%9B%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB-toc" style="margin-left:40px;"><a href="#Office%20%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E4%B8%80%E4%BA%9B%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB" rel="nofollow">Office 数据源的一些映射关系</a></p> 
<p id="%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83-toc" style="margin-left:40px;"><a href="#%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83" rel="nofollow">范例运行环境</a></p> 
<p id="%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE-toc" style="margin-left:40px;"><a href="#%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE" rel="nofollow">配置Office DCOM</a></p> 
<p id="%E8%AE%BE%E8%AE%A1%E6%83%B3%E6%B3%95-toc" style="margin-left:40px;"><a href="#%E8%AE%BE%E8%AE%A1%E6%83%B3%E6%B3%95" rel="nofollow">关键代码</a></p> 
<p id="%E7%BB%84%E4%BB%B6%E5%BA%93%E5%BC%95%E5%85%A5-toc" style="margin-left:80px;"><a href="#%E7%BB%84%E4%BB%B6%E5%BA%93%E5%BC%95%E5%85%A5" rel="nofollow">组件库引入</a></p> 
<p id="%E5%9F%BA%E7%A1%80%E4%BB%A3%E7%A0%81-toc" style="margin-left:80px;"><a href="#%E5%9F%BA%E7%A1%80%E4%BB%A3%E7%A0%81" rel="nofollow">​</a><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81" rel="nofollow">核心代码</a></p> 
<p id="%E6%9D%80%E6%8E%89%E8%BF%9B%E7%A8%8B-toc" style="margin-left:80px;"><a href="#%E6%9D%80%E6%8E%89%E8%BF%9B%E7%A8%8B" rel="nofollow">杀掉进程</a></p> 
<p id="-toc" style="margin-left:40px;"><a href="#%E6%80%BB%E7%BB%93" rel="nofollow">总结</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h3 id="main-toc">功能需求</h3> 
<p>在应用项目里，多数情况下我们会遇到导入 Excel 文件数据到数据库的功能需求，但某些情况下，也存在使用 Word 进行表格数据编辑的情况。Word 和 Excel 其实各有特点，用户的习惯不同，即使同一数据源，可能提供的数据源文件类型也不同，这其中也包括导入Word内容的功能，比如表格数据导出到DataSet数据集。</p> 
<h3 id="Office%20%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E4%B8%80%E4%BA%9B%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB">Office 数据源的一些映射关系</h3> 
<p>下图是一个简单的 Office 数据源的映射关系：</p> 
<p>1、第一层级比如 WORD / EXCEL 为应用层级（Application）、 DATASET / DATABASE 为数据容器</p> 
<p>2、第二层级，比如WORD 包含一个文档对象（Docment）、Excel 包含一个工作簿对象（WorkBook）、DataSet / DataBase 包括一组数据表对象（Tables）</p> 
<p>3、第三层级，比如Word里的表格对象（Table）、Excel里的工作表对象（Sheet）</p> 
<p>最实际的工作任务，是要将Table或Sheet对象的二维数据对应导出生成到 DataSet 里的 Table 对象，如果有多个则生成对应的集合。最后我们可能会再次导出到 DataBase 的数据表集合里（Tables）。</p> 
<p><img alt="" height="719" src="https://images2.imgbox.com/1b/a8/SSSgVovK_o.png" width="1200"></p> 
<p></p> 
<h3 id="%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83">范例运行环境</h3> 
<p>操作系统： Windows Server 2019 DataCenter</p> 
<p>操作系统上安装 Office Word 2016</p> 
<p>.net版本： .netFramework4.7.1 或以上</p> 
<p>开发工具：VS2019  C#</p> 
<h3 id="%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE">配置Office DCOM</h3> 
<p>对于安装原生Office应用，我们需要对DCOM进行进一步的配置方可使用其API。</p> 
<p>打开控制面板、管理工具、组件服务：</p> 
<p class="img-center"><img alt="" height="855" src="https://images2.imgbox.com/22/0c/FC9woPn9_o.png" width="1200"></p> 
<p></p> 
<p>点击组件服务、计算机、我的电脑、DCOM配置 </p> 
<p><img alt="" height="1181" src="https://images2.imgbox.com/80/47/CgvfCGLn_o.png" width="1200"></p> 
<p> 找到 Microsoft Word97-2003 文档应用程序</p> 
<p><img alt="" height="1007" src="https://images2.imgbox.com/c8/64/HUEs5nrw_o.png" width="1200"></p> 
<p> 选择属性、打开标识选项卡、选择下列用户选项，设置启动Word应用的用户，点确定即可。</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/14/8c/uMZJx9cg_o.png" width="1025"></p> 
<p> 理论上设置到这里就可以了，但以防万一，可以继续设置启动权限，选择安全选项卡、启动和激活权限，如下图：</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/2e/ae/7DLJ1stf_o.png" width="977"></p> 
<p></p> 
<h3 id="%E8%AE%BE%E8%AE%A1%E6%83%B3%E6%B3%95">关键代码</h3> 
<h4 id="%E7%BB%84%E4%BB%B6%E5%BA%93%E5%BC%95%E5%85%A5">组件库引入</h4> 
<h4 id="%E5%9F%BA%E7%A1%80%E4%BB%A3%E7%A0%81"><img alt="" height="1200" src="https://images2.imgbox.com/49/ae/HqVdsKg1_o.png" width="1200"></h4> 
<h4 id="%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81">核心代码</h4> 
<p>public DataSet WordAsDataSet(string _filename) 方法，传入要读取的 WORD 文件路径即可，方法会遍历该WORD里的TABLES对象集合，如果找到TABLE对象，则按列的顺序创建字段列，比如F1、F2...Fn，以些类推，从第二行起为记录行，则根据创建的结构写入到 DataTable中。</p> 
<pre><code class="language-cs">        public DataSet WordAsDataSet(string _filename)
        {
            DataSet ds = new DataSet();

            Object Nothing = System.Reflection.Missing.Value;

            object filename = _filename;
            //创建一个名为WordApp的组件对象
            DateTime beforetime = DateTime.Now;
            Word.Application WordApp = new Word.Application();
            //创建一个名为WordDoc的文档对象
            WordApp.DisplayAlerts = Word.WdAlertLevel.wdAlertsNone;

            Word.Document WordDoc = WordApp.Documents.Open(ref filename, ref Nothing, ref Nothing, ref Nothing, ref Nothing, ref Nothing, ref Nothing, ref Nothing, ref Nothing, ref Nothing, ref Nothing, ref Nothing, ref Nothing, ref Nothing, ref Nothing, ref Nothing);

            WordDoc.SpellingChecked = false;//关闭拼写检查

            WordDoc.ShowSpellingErrors = false;//关闭显示拼写错误提示框

            DateTime aftertime = DateTime.Now;
//遍历所有的Word里的表格，并写到数据集的TABLES集合里
            foreach (Word.Table wTable in WordDoc.Tables)
            {
                System.Data.DataTable dt = new System.Data.DataTable();
                for (int colPos = 1; colPos &lt;= wTable.Columns.Count; colPos++)
                {
                    DataColumn dc = new DataColumn();
                    dc.ColumnName = "F" + colPos.ToString();
                    dt.Columns.Add(dc);
                }

                for (int rowPos = 1; rowPos &lt;= wTable.Rows.Count; rowPos++)
                {
                    DataRow drNew = dt.NewRow();
                    int columnIndex = 0;
                    foreach (Word.Cell cellObj in wTable.Rows[rowPos].Cells)
                    {
                        drNew[columnIndex] = cellObj.Range.Text.Remove(cellObj.Range.Text.Length - 2, 2);//remove \r\a
                        columnIndex++;
                    }
                    dt.Rows.Add(drNew);
                }
                ds.Tables.Add(dt);
            }


            WordDoc.Close(ref Nothing, ref Nothing, ref Nothing);
            //关闭WordApp组件对象
            WordApp.Quit(ref Nothing, ref Nothing, ref Nothing);

            KillProcessByStartTime("WINWORD", beforetime, aftertime);

            return ds;
        }
</code></pre> 
<h4 id="%E6%9D%80%E6%8E%89%E8%BF%9B%E7%A8%8B">杀掉进程</h4> 
<p>这是一个无奈之举，尝试了一些方法，但某些情况下仍然无法释放掉 Word 应用进程，因此根据时间点范围写了一个强制杀掉进程的方法。</p> 
<p>示例代码如下：</p> 
<pre><code class="language-cs">public string KillProcessByStartTime(string processName,DateTime beforetime,DateTime aftertime)
		{
			Process[] ps = Process.GetProcesses();
			foreach (Process p in ps)  
			{
				if(p.ProcessName.ToUpper()!=processName) continue;
				if(p.StartTime &gt; beforetime &amp;&amp; p.StartTime &lt; aftertime)
				{
					try
					{
						p.Kill();
					}
					catch(Exception e)
					{
						return e.Message;
					}
				}
			}  
			return "";
		}</code></pre> 
<h3></h3> 
<h3 id="%E6%80%BB%E7%BB%93">总结</h3> 
<p>在实际的应用中，无论是导入的文件格式还是导出的数据源，都是要结合客户的需求进行的。</p> 
<p>在功能实现前，需要约定模板文件的格式，字段内容的意义、长度等。导入到 DataSet 成功后，再根据业务逻辑进行后续操作再加工，或直接导入到规范的数据表里（如 MS SQL SERVER）。</p> 
<p>这些代码我们提供了一些操作WORD相关的关键方法，这里仅作参考，欢迎大家评论指教！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6dd74182ad2d4e167526ae849a223600/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决SpringBoot配置文件项目重启出现乱码的情况</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8a235c5c5b9b8239b1ca5158a75c6faf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">模型微调入门介绍二</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>