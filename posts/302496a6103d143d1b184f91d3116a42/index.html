<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Andriod AOA协议通信总结 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Andriod AOA协议通信总结" />
<meta property="og:description" content="Andriod AOA协议通信总结 Android从3.1版本可开始引进了对 AOA协议 ( Android Open Accessory Protocol) 的支持，这是一种允许外部USB硬件与Android设备进行交互的特殊Accessory模式。
Android 开放配件 (AOA) 支持功能可让外部 USB 硬件（Android USB 配件）与处于配件模式下的 Android 设备进行交互。当某台 Android 设备处于配件模式时，所连接的配件会充当 USB 主机（为总线供电并列举设备），而 Android 设备则充当 USB 配件。
Android USB 配件专门用于和 Android 设备相连。这些配件遵循 AOA 要求，从而能够检测到支持配件模式的 Android 设备，并且必须提供 500 毫安（电压为 5 伏）的充电电流。之前发布的部分 Android 设备只能充当 USB 设备，无法发起与外部 USB 设备的连接。AOA 支持功能打破了这一局限，让您能够构建可以与各种 Android 设备建立连接并与其进行交互的配件。
USB accessory overview USB accessory mode allows users to connect USB host hardware specifically designed for Android-powered devices. The accessories must adhere to the Android accessory protocol outlined in the Android Accessory Development Kit documentation." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/302496a6103d143d1b184f91d3116a42/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-20T17:31:49+08:00" />
<meta property="article:modified_time" content="2019-07-20T17:31:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Andriod AOA协议通信总结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Andriod_AOA_2"></a>Andriod AOA协议通信总结</h2> 
<p>Android从3.1版本可开始引进了对 <a href="https://source.android.google.cn/devices/accessories/protocol" rel="nofollow">AOA协议</a> ( Android Open Accessory Protocol) 的支持，这是一种允许外部USB硬件与Android设备进行交互的特殊Accessory模式。</p> 
<blockquote> 
 <p>Android 开放配件 (AOA) 支持功能可让外部 USB 硬件（Android USB 配件）与处于配件模式下的 Android 设备进行交互。当某台 Android 设备处于配件模式时，所连接的配件会充当 USB 主机（为总线供电并列举设备），而 Android 设备则充当 USB 配件。<br> Android USB 配件专门用于和 Android 设备相连。这些配件遵循 AOA 要求，从而能够检测到支持配件模式的 Android 设备，并且必须提供 500 毫安（电压为 5 伏）的充电电流。之前发布的部分 Android 设备只能充当 USB 设备，无法发起与外部 USB 设备的连接。AOA 支持功能打破了这一局限，让您能够构建可以与各种 Android 设备建立连接并与其进行交互的配件。</p> 
</blockquote> 
<h2><a id="USB_accessory_overviewhttpsdeveloperandroidgooglecnguidetopicsconnectivityusbaccessoryjava_6"></a><a href="https://developer.android.google.cn/guide/topics/connectivity/usb/accessory#java" rel="nofollow">USB accessory overview</a></h2> 
<blockquote> 
 <p>USB accessory mode allows users to connect USB host hardware specifically designed for Android-powered devices. The accessories must adhere to the Android accessory protocol outlined in the Android Accessory Development Kit documentation. This allows Android-powered devices that cannot act as a USB host to still interact with USB hardware. When an Android-powered device is in USB accessory mode, the attached Android USB accessory acts as the host, provides power to the USB bus, and enumerates connected devices. Android 3.1 (API level 12) supports USB accessory mode and the feature is also backported to Android 2.3.4 (API level 10) to enable support for a broader range of devices.</p> 
</blockquote> 
<h2><a id="USB_host_overviewhttpsdeveloperandroidgooglecnguidetopicsconnectivityusbhost_9"></a><a href="https://developer.android.google.cn/guide/topics/connectivity/usb/host" rel="nofollow">USB host overview</a></h2> 
<blockquote> 
 <p>When your Android-powered device is in USB host mode, it acts as the USB host, powers the bus, and enumerates connected USB devices. USB host mode is supported in Android 3.1 and higher.</p> 
</blockquote> 
<p>官网上也有对相应API的说明演示，但是不全，无法使用。实际开发还是要<a href="https://source.android.google.cn/devices/accessories/protocol" rel="nofollow">AOA协议</a>结合API一起使用才行。</p> 
<h3><a id="Host_14"></a>一、Host端流程</h3> 
<div class="mermaid flow-chart"> 
 <svg height="1159.875" version="1.1" width="300.3671875" xmlns="http://www.w3.org/2000/svg" style="overflow: hidden; position: relative;" viewbox="0 0 300.3671875 1159.875" preserveaspectratio="xMidYMid meet"> 
  <desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
    Created with Raphaël 2.2.0 
  </desc> 
  <defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
   <marker id="raphael-marker-endblock33-obj0e2q2" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-obj5sarc" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objsnae1" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-obji3aua" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objzs5n2" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objg791l" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objewt82" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objaowie" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objxuq7j" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
  </defs> 
  <rect x="0" y="0" width="50" height="36" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="st" transform="matrix(1,0,0,1,113.6836,53.3418)"></rect> 
  <text x="10" y="18" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="stt" class="flowchartt" transform="matrix(1,0,0,1,113.6836,53.3418)" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     开始 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="212.359375" height="36" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="op" transform="matrix(1,0,0,1,32.5039,192.6836)"></rect> 
  <text x="10" y="18" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="opt" class="flowchartt" transform="matrix(1,0,0,1,32.5039,192.6836)" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     主机Host与从机Accessory连接 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="175.796875" height="36" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="op1" transform="matrix(1,0,0,1,50.7852,332.0254)"></rect> 
  <text x="10" y="18" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op1t" class="flowchartt" transform="matrix(1,0,0,1,50.7852,332.0254)" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     主机Host检测已连接设备 
   </tspan> 
  </text> 
  <path fill="#ffffff" stroke="#000000" d="M67.341796875,33.6708984375L0,67.341796875L134.68359375,134.68359375L269.3671875,67.341796875L134.68359375,0L0,67.341796875" stroke-width="2" id="cond" class="flowchart" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;" transform="matrix(1,0,0,1,4,422.0254)"></path> 
  <text x="72.341796875" y="67.341796875" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="condt" class="flowchartt" transform="matrix(1,0,0,1,4,422.0254)" stroke-width="1"> 
   <tspan dy="5.005859375" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     检测到Accessory设备？ 
   </tspan> 
  </text> 
  <path fill="#ffffff" stroke="#000000" d="M61.798828125,30.8994140625L0,61.798828125L123.59765625,123.59765625L247.1953125,61.798828125L123.59765625,0L0,61.798828125" stroke-width="2" id="cond1" class="flowchart" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;" transform="matrix(1,0,0,1,15.0859,616.252)"></path> 
  <text x="66.798828125" y="61.798828125" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="cond1t" class="flowchartt" transform="matrix(1,0,0,1,15.0859,616.252)" stroke-width="1"> 
   <tspan dy="4.994140625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     判断是否有USB权限? 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="219.578125" height="36" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="op3" transform="matrix(1,0,0,1,28.8945,843.1914)"></rect> 
  <text x="10" y="18" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op3t" class="flowchartt" transform="matrix(1,0,0,1,28.8945,843.1914)" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     按照AOA协议发生指令建立连接 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="78" height="36" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="op4" transform="matrix(1,0,0,1,99.6836,982.5332)"></rect> 
  <text x="10" y="18" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op4t" class="flowchartt" transform="matrix(1,0,0,1,99.6836,982.5332)" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     发送数据 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="120" height="36" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="e" transform="matrix(1,0,0,1,78.6836,1121.875)"></rect> 
  <text x="10" y="18" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="et" class="flowchartt" transform="matrix(1,0,0,1,78.6836,1121.875)" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     结束并释放资源 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M138.68359375,89.341796875C138.68359375,89.341796875,138.68359375,172.66761041386053,138.68359375,189.67453915372562" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj0e2q2)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M138.68359375,228.68359375C138.68359375,228.68359375,138.68359375,312.00940728886053,138.68359375,329.0163360287256" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj5sarc)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M138.68359375,368.025390625C138.68359375,368.025390625,138.68359375,407.67949056625366,138.68359375,419.02582970960066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objsnae1)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M138.68359375,556.708984375C138.68359375,556.708984375,138.68359375,601.1841027252376,138.68359375,613.2584024336029" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obji3aua)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <text x="143.68359375" y="566.708984375" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" stroke-width="1"> 
   <tspan dy="4.998046875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     yes 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M273.3671875,489.3671875C273.3671875,489.3671875,298.3671875,489.3671875,298.3671875,489.3671875C298.3671875,489.3671875,298.3671875,1096.875,298.3671875,1096.875C298.3671875,1096.875,138.68359375,1096.875,138.68359375,1096.875C138.68359375,1096.875,138.68359375,1112.24844455719,138.68359375,1118.8842477742583" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objzs5n2)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <text x="278.3671875" y="479.3671875" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     no 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M138.68359375,739.849609375C138.68359375,739.849609375,138.68359375,823.1754229138605,138.68359375,840.1823516537256" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objg791l)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <text x="143.68359375" y="749.849609375" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" stroke-width="1"> 
   <tspan dy="4.998046875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     yes 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M262.28125,678.05078125C262.28125,678.05078125,287.28125,678.05078125,287.28125,678.05078125C287.28125,678.05078125,287.28125,1096.875,287.28125,1096.875C287.28125,1096.875,138.68359375,1096.875,138.68359375,1096.875C138.68359375,1096.875,138.68359375,1112.24844455719,138.68359375,1118.8842477742583" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objewt82)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <text x="267.28125" y="668.05078125" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" stroke-width="1"> 
   <tspan dy="4.99609375" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     no 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M138.68359375,879.19140625C138.68359375,879.19140625,138.68359375,962.5172197888605,138.68359375,979.5241485287256" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objaowie)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M138.68359375,1018.533203125C138.68359375,1018.533203125,138.68359375,1101.8590166638605,138.68359375,1118.8659454037256" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objxuq7j)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
 </svg> 
</div> 
<p>host端发送数据总的流程如上图。示例代码如下</p> 
<h4><a id="1AndroidManifestxml_34"></a>1、AndroidManifest.xml配置</h4> 
<p>需要添加如下feature</p> 
<pre><code>&lt;uses-feature android:name="android.hardware.usb.host"/&gt;
</code></pre> 
<p>在对应的activity中添加intent-filter，通过vnd.android.document/root 及 UsbManager.ACTION_USB_ACCESSORY_ATTACHED广播可以监听设备插入自启动</p> 
<pre><code>        &lt;!-- 添加activity自启动，这里采用的是vnd.android.document/root 也可以监听UsbManager.ACTION_USB_ACCESSORY_ATTACHED--&gt;
        &lt;activity android:name=".activity.MainActivity"&gt;
            &lt;intent-filter&gt;
                &lt;action android:name="android.intent.action.MAIN"/&gt;

                &lt;category android:name="android.intent.category.LAUNCHER"/&gt;
            &lt;/intent-filter&gt;
            &lt;intent-filter&gt;
                &lt;action android:name="android.intent.action.VIEW" /&gt;
                &lt;category android:name="android.intent.category.DEFAULT" /&gt;
                &lt;data android:mimeType="vnd.android.document/root" /&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;
</code></pre> 
<h4><a id="2USB_55"></a>2、检测USB权限</h4> 
<p>Activity启动说明检测到设备插入，此时判断应用是否已经被授权。应用如果是system的，系统自带PASS，代码如下</p> 
<pre><code>private UsbManager mUsbManager;
private OpenDevicesReceiver  mOpenDevicesReceiver;

...
private void openDevices() {
    mUsbManager = (UsbManager) getSystemService(Context.USB_SERVICE);

    PendingIntent pendingIntent = PendingIntent.getBroadcast(mContext, 0, new Intent(USB_ACTION), 0);
    IntentFilter intentFilter = new IntentFilter(USB_ACTION);
    mOpenDevicesReceiver = new OpenDevicesReceiver(this);
    registerReceiver(mOpenDevicesReceiver, intentFilter);

    if (mUsbManager.hasPermission(usbDevice)) {
        initAccessory(usbDevice);//已经有权限继续操作
    } else {
        mUsbManager.requestPermission(usbDevice, pendingIntent);//申请权限，结果触发pendingIntent中广播
    }
}

...

// 申请USB权限的广播
class OpenDevicesReceiver extends BroadcastReceiver {

    @Override
    public void onReceive(Context context, Intent intent) {
        UsbDevice usbDevice = intent.getParcelableExtra(UsbManager.EXTRA_DEVICE);
        if (intent.getBooleanExtra(UsbManager.EXTRA_PERMISSION_GRANTED, false)) {
            if (usbDevice != null) {
                 initAccessory(usbDevice);//已获取权限继续操作
            } else {
                //usbDevice 为 null
            }
        } else {
            //未获取权限
        }
    }
}

</code></pre> 
<h4><a id="3Accessory_99"></a>3、与Accessory建立连接</h4> 
<p>根据<a href="https://source.android.google.cn/devices/accessories/aoa" rel="nofollow">AOA协议</a>需要发送三种指令：</p> 
<blockquote> 
 <p>1.发送 51 控制请求（“获取协议”）以确定设备是否支持 Android 配件协议。如果设备支持协议，则返回一个非零数字，代表所支持的协议版本。该控制请求为端点 0 上的请求，具有以下特征：<br> <br> requestType: USB_DIR_IN | USB_TYPE_VENDOR<br> request: 51<br> value: 0<br> index: 0<br> data: protocol version number (16 bits little endian sent from the<br> device to the accessory)</p> 
</blockquote> 
<blockquote> 
 <p>2.如果设备返回所支持的协议版本，则向设备发送含标识字符串信息的控制请求。该信息让设备可以确定适合配件的应用（如果没有适合配件的应用，则向用户呈现一个网址）。该控制请求为端点 0 上的请求（适用每个字符串 ID），具有以下特征：<br> <br> requestType: USB_DIR_OUT | USB_TYPE_VENDOR<br> request: 52<br> value: 0<br> index: string ID<br> data zero terminated UTF8 string sent from accessory to device<br> <br> 支持以下字符串 ID，并且每个字符串的最大值为 256 个字节（必须以零结束，以 \0 结尾）。<br> <br> manufacturer name: 0<br> model name: 1<br> description: 2<br> version: 3<br> URI: 4<br> serial number: 5</p> 
</blockquote> 
<blockquote> 
 <p>3.发送控制请求，要求设备以配件模式启动。该控制请求为端点 0 上的请求，具有以下特征：<br> <br> requestType: USB_DIR_OUT | USB_TYPE_VENDOR<br> request: 53<br> value: 0<br> index: 0<br> data: none</p> 
</blockquote> 
<p>发送代码如下，第一条指令的作用就是获取AOA版本号，可以省略。</p> 
<pre><code>    private void initAccessory(UsbDevice usbDevice) {
        UsbDeviceConnection usbDeviceConnection = mUsbManager.openDevice(usbDevice);
        if (usbDeviceConnection == null) {
            // 建立连接失败
            return;
        }

        // 发送51指令  可以省略
        byte[] bytes = new byte[]{(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,
                (byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,
                (byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,
                (byte)0x00,(byte)0x00,(byte)0x00,(byte)0x02};

        int i = usbDeviceConnection.controlTransfer(0xc0, 51, 0, 0, bytes, 16, 100);
        Log.i(TAG, "i " + i);

        // 发送52指令，MANUFACTURER MODEL  VERSION 对应Accessory端 xml中配置，其余的可自行填补，省略亦可。
        initStringControlTransfer(usbDeviceConnection, 0, "Demo, Inc."); // MANUFACTURER
        initStringControlTransfer(usbDeviceConnection, 1, "AccessoryChat"); // MODEL
        initStringControlTransfer(usbDeviceConnection, 2, "Accessory Demo"); // DESCRIPTION
        initStringControlTransfer(usbDeviceConnection, 3, "1.1"); // VERSION
        initStringControlTransfer(usbDeviceConnection, 4, "http://www.android.com"); // URI
        initStringControlTransfer(usbDeviceConnection, 5, "0123456789"); // SERIAL

        // 发送53指令
        usbDeviceConnection.controlTransfer(0x40, 53, 0, 0, new byte[]{}, 0, 100);

        // 释放资源
        usbDeviceConnection.close();

        // 启动AOA连接后一些参数初始化
        initDevice();
    }

    private void initStringControlTransfer(UsbDeviceConnection deviceConnection, int index, String string) {
        deviceConnection.controlTransfer(0x40, 52, 0, index, string.getBytes(), string.length(), 100);
    }

    private void initDevice() {
        Runnable mRunnable = new Runnable() {
            @Override
            public void run() {

                // 发送过AOA指令后，设备会由MTP,ADB 变成 Android Accessory Interface 状态
                // AOA 当前不支持同时进行 AOA 连接和 MTP 连接。要从 AOA 切换到 MTP，配件必须首先与 USB 设备断开连接（断开物理连接或以电气等效的方式断开），然后使用 MTP 重新连接 USB 设备。
                HashMap&lt;String, UsbDevice&gt; deviceList = mUsbManager.getDeviceList();
                Collection&lt;UsbDevice&gt; values = deviceList.values();
                if (!values.isEmpty()) {
                
                    // 一般都只有一个device，多个需要修改判断
                    for (UsbDevice usbDevice : values) {
                        int productId = usbDevice.getProductId();

                        // 设备ID是否符合要求，正常AOA协议发送成功建立连接后，模式和ID都会改变
                        if (productId == 0x2D00 || productId == 0x2D01) {
                            if (mUsbManager.hasPermission(usbDevice)) {
                                mUsbDeviceConnection = mUsbManager.openDevice(usbDevice);
                                if (mUsbDeviceConnection != null) {
                                    // 正常默认  0 是Android Accessory Interface （配件如果打开usb调试 ）1表示 ADB
                                    // 所以也没必要遍历了，参数直接给0
                                    mUsbInterface = usbDevice.getInterface(0);
                                    int endpointCount = mUsbInterface.getEndpointCount();
                                    for (int i = 0; i &lt; endpointCount; i++) {
                                        UsbEndpoint usbEndpoint = mUsbInterface.getEndpoint(i);
                                        // 获取 mUsbEndpointOut 与 mUsbEndpointIn ，分别表示输出/读取流
                                        if (usbEndpoint.getType() == UsbConstants.USB_ENDPOINT_XFER_BULK) {
                                            if (usbEndpoint.getDirection() == UsbConstants.USB_DIR_OUT) {
                                                mUsbEndpointOut = usbEndpoint;
                                            } else if (usbEndpoint.getDirection() == UsbConstants.USB_DIR_IN) {
                                                mUsbEndpointIn = usbEndpoint;
                                            }
                                        }
                                    }
                                    if (mUsbEndpointOut != null &amp;&amp; mUsbEndpointIn != null) {
                                        // 到这里一切都正常说明连接真正OK，接下来可以使用读写数据了
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
</code></pre> 
<h4><a id="4_223"></a>4、数据流读写方式</h4> 
<p>使用系统API即可，AOA 传输速度会比 MTP/ADB 慢一些，示例代码如下</p> 
<pre><code>                    try {
                        in = new FileInputStream("/storage/emulated/0/test.zip");
                    } catch (FileNotFoundException e) {
					    Log.e(TAG, "FileNotFoundException " + e.toString());
					    return;
                    }

                    // 使用bulkTransfer传输API时，最大 BUFFER SIZE 就是 16384（16k）
                    // 如果设置BUFFER 多大，多余的数据会丢失
                    byte[] bytes = new byte[16 * 1024];
                    int n = 0;
                    try {
                        while ((n = in.read(bytes, 0, bytes.length)) != -1) {

                            // 使用mUsbEndpointOut 表示输出，换成mUsbEndpointIn 即读取
                            i = mUsbDeviceConnection.bulkTransfer(mUsbEndpointOut, bytes, n, 3000);

                            // 数据 发送/读取 成功会返回数据大小byte，返回-1表示数据发送失败
                            if (i &gt; 0) {
                                // 数据 发送/读取 成功
                            }
                    }
                    in.close();
                    } catch (IOException e) {
					    Log.e(TAG, "IOException " + e.toString());
					    return;
                    }
                    Log.e(TAG, "end " + in);
</code></pre> 
<h3><a id="Accessory_255"></a>二、Accessory端流程</h3> 
<div class="mermaid flow-chart"> 
 <svg height="628.5" version="1.1" width="194" xmlns="http://www.w3.org/2000/svg" style="overflow: hidden; position: relative;" viewbox="0 0 194 628.5" preserveaspectratio="xMidYMid meet"> 
  <desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
    Created with Raphaël 2.2.0 
  </desc> 
  <defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
   <marker id="raphael-marker-endblock33-obju2ycm" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objw38ti" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-obj565uq" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objizoq1" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objp4gwa" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objbmseb" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
  </defs> 
  <rect x="0" y="0" width="50" height="36" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="st" transform="matrix(1,0,0,1,67,23.5)"></rect> 
  <text x="10" y="18" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="stt" class="flowchartt" transform="matrix(1,0,0,1,67,23.5)" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     开始 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="169.578125" height="36" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="op" transform="matrix(1,0,0,1,7.2109,133)"></rect> 
  <text x="10" y="18" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="opt" class="flowchartt" transform="matrix(1,0,0,1,7.2109,133)" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     检测到当前为Accessory 
   </tspan> 
  </text> 
  <path fill="#ffffff" stroke="#000000" d="M37.5,18.75L0,37.5L75,75L150,37.5L75,0L0,37.5" stroke-width="2" id="cond" class="flowchart" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;" transform="matrix(1,0,0,1,17,223)"></path> 
  <text x="42.5" y="37.5" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="condt" class="flowchartt" transform="matrix(1,0,0,1,17,223)" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     判断权限？ 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="106.78125" height="36" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="op1" transform="matrix(1,0,0,1,38.6094,371.5)"></rect> 
  <text x="10" y="18" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op1t" class="flowchartt" transform="matrix(1,0,0,1,38.6094,371.5)" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     初始化IO对象 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="176" height="36" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="op2" transform="matrix(1,0,0,1,4,481)"></rect> 
  <text x="10" y="18" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op2t" class="flowchartt" transform="matrix(1,0,0,1,4,481)" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     创建循环读取数据的线程 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="148" height="36" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="e" transform="matrix(1,0,0,1,18,590.5)"></rect> 
  <text x="10" y="18" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="et" class="flowchartt" transform="matrix(1,0,0,1,18,590.5)" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     读取结束并释放资源 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M92,59.5C92,59.5,92,116.21393239498138,92,130.0047225964954" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obju2ycm)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M92,169C92,169,92,208.65409994125366,92,220.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objw38ti)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M92,298C92,298,92,354.7139323949814,92,368.5047225964954" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj565uq)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <text x="97" y="308" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     yes 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M167,260.5C167,260.5,192,260.5,192,260.5C192,260.5,192,565.5,192,565.5C192,565.5,92,565.5,92,565.5C92,565.5,92,580.8734445571899,92,587.5092477742583" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objizoq1)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <text x="172" y="250.5" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" stroke-width="1"> 
   <tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     no 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M92,407.5C92,407.5,92,464.2139323949814,92,478.0047225964954" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objp4gwa)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M92,517C92,517,92,573.7139323949814,92,587.5047225964954" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objbmseb)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
 </svg> 
</div> 
<p>Accessory端接收数据总的流程如上图。示例代码如下</p> 
<h4><a id="1AndroidManifestxml_270"></a>1、AndroidManifest.xml配置</h4> 
<p>添加如下feature</p> 
<pre><code>    &lt;uses-feature android:name="android.hardware.usb.accessory"/&gt;
</code></pre> 
<p>Activity添加 USB_ACCESSORY_ATTACHED action自启动，同时需要添加meta-data，指定resource="@xml/accessory_filter"</p> 
<pre><code>
        &lt;activity android:name=".activity.MainActivity"&gt;
            &lt;intent-filter&gt;
                &lt;action android:name="android.intent.action.MAIN"/&gt;
                &lt;action android:name="android.hardware.usb.action.USB_ACCESSORY_ATTACHED"/&gt;

                &lt;category android:name="android.intent.category.LAUNCHER"/&gt;
            &lt;/intent-filter&gt;

            &lt;meta-data
                android:name="android.hardware.usb.action.USB_ACCESSORY_ATTACHED"
                android:resource="@xml/accessory_filter"/&gt;
        &lt;/activity&gt;
</code></pre> 
<p>accessory_filter.xml 如下，和主机端发送52指令要匹配</p> 
<pre><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;resources&gt;
    &lt;!--&lt;usb-accessory /&gt;--&gt;
    &lt;usb-accessory
        manufacturer="OldSix, Inc."
        model="AccessoryChat"
        version="1.1"/&gt;
&lt;/resources&gt;
</code></pre> 
<h4><a id="2AOA_303"></a>2、系统启动AOA应用</h4> 
<p>接收到主机端发出aoa这个匹配的信息后，在SystemUI中会启动对应Activity：<br> 相关代码目录 frameworks/base/packages/SystemUI/src/com/android/systemui/usb/<br> UsbConfirmActivity.java – 确认启动AOA应用<br> UsbPermissionActivity – AOA应用（非系统应用签名）需要申请权限<br> UsbAccessoryUriActivity – 无对应的AOA应用，如果主机端发送的52指令中URI有效，显示URIUsbResolverActivity – 多个匹配的应用选择器</p> 
<h4><a id="3USB_311"></a>3、检测USB权限</h4> 
<p>检测权限与host端类似，参数不同</p> 
<pre><code>private UsbManager mUsbManager;

    private void initData() {
        mUsbManager = (UsbManager) getSystemService(Context.USB_SERVICE);

        // 这监听ACTION_USB_ACCESSORY_DETACHED广播，当退出AOA状态时需要做一些操作
        mUsbDetachedReceiver = new UsbDetachedReceiver(this);
        IntentFilter filter = new IntentFilter(UsbManager.ACTION_USB_ACCESSORY_DETACHED);
        registerReceiver(mUsbDetachedReceiver, filter);

        // 这监听权限申请广播，USB_ACTION为自定义字段
        mOpenAccessoryReceiver = new OpenAccessoryReceiver(this);
        PendingIntent pendingIntent = PendingIntent.getBroadcast(this, 0, new Intent(USB_ACTION), 0);
        IntentFilter intentFilter = new IntentFilter(USB_ACTION);
        registerReceiver(mOpenAccessoryReceiver, intentFilter);

        UsbAccessory[] accessories = mUsbManager.getAccessoryList();
        UsbAccessory usbAccessory = (accessories == null ? null : accessories[0]);
        if (usbAccessory != null) {
            Log.i(TAG, "usbAccessory " + mUsbManager.hasPermission(usbAccessory));
            if (mUsbManager.hasPermission(usbAccessory)) {
                openAccessory(usbAccessory);
            } else {
                mUsbManager.requestPermission(usbAccessory, pendingIntent);
            }
        }
    }
</code></pre> 
<pre><code>public class OpenAccessoryReceiver extends BroadcastReceiver {

    @Override
    public void onReceive(Context context, Intent intent) {
        UsbAccessory usbAccessory = intent.getParcelableExtra(UsbManager.EXTRA_ACCESSORY);
        if (intent.getBooleanExtra(UsbManager.EXTRA_PERMISSION_GRANTED, false)) {
            if (usbAccessory != null) {
                // 已获取权限
            } else {
                // 异常情况
            }
        } else {
            // 未授予权限
        }
    }
}
</code></pre> 
<h4><a id="4_361"></a>4、读取数据</h4> 
<p>读取数据需要开一个单独的循环线程，不断的去读buffer中数据</p> 
<pre><code>private ParcelFileDescriptor mParcelFileDescriptor;
private FileInputStream mFileInputStream;
private FileOutputStream mFileOutputStream;

    private void openAccessory(UsbAccessory usbAccessory) {
        mParcelFileDescriptor = mUsbManager.openAccessory(usbAccessory);
        Log.i(TAG, "mParcelFileDescriptor " + mParcelFileDescriptor);
        if (mParcelFileDescriptor != null) {
            FileDescriptor fileDescriptor = mParcelFileDescriptor.getFileDescriptor();
            mFileInputStream = new FileInputStream(fileDescriptor);
            mFileOutputStream = new FileOutputStream(fileDescriptor);

            new Thread(new Runnable() {
                @Override
                public void run() {
                    int i = 0;
					// 将读取的数据保存到本地文件
					try {
                        out = new FileOutputStream("/cache/update.zip");
					} catch (FileNotFoundException e) {
					    Log.e(TAG, "FileNotFoundException " + e.toString());
					}
                    while (i &gt;= 0) {
                        try {
                            i = mFileInputStream.read(mBytes);
                        } catch (IOException e) {
                            Log.e(TAG, "IOException " + e.toString());
                            break;
                        }
                        if (i &gt; 0) {
                            try {
                                out.write(mBytes, 0, i);
                            } catch (IOException e) {
                                Log.e(TAG, "write IOException " + e.toString());
                                break;
                            }
                        }
                    }
					try {
					    out.close();
					} catch (IOException e) {
					    Log.e(TAG, "close IOException " + e.toString());
					}
                }
            }).start();
        }
    }
</code></pre> 
<p>如果需要向主机端传数据，需要向buffer中写数据，让主机端去读</p> 
<pre><code>mFileOutputStream.write(byte[] byte);
</code></pre> 
<h2><a id="_419"></a>其他问题</h2> 
<p>1、AOA模式下，数据传输速度太慢了，相对而言MTP&gt;ADB&gt;AOA，实际测算，AOA只有MTP 1/2不到。暂时没啥提升速度的办法，还望有大佬指教。<br> 2、源码中有demo，目录：frameworks\base\libs\usb\tests\AccessoryChat\accessorychat<br> 但是没有accessory端native的demo。看源码，最终accessory端是可以通过 /dev/usb_accessory 节点去读（接收）写（发送），/dev/usb_accessory 节点是主机端先发送52、53指令后有效。</p> 
<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;ctype.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;fcntl.h&gt;

#define DRIVER_NAME "/dev/usb_accessory"

#define MAX_USBFS_BUFFER_SIZE   16384

int open_accessory()
{
    int fd = open(DRIVER_NAME, O_RDWR);
    if (fd &lt; 0) {
        fprintf(stderr, "Error: could not open %s\n", DRIVER_NAME);
        return -1;
    }
    return fd;
}

static void usb_accessory_read(int fd)
{
    char c;
    char buf[MAX_USBFS_BUFFER_SIZE];
    int n;
    while((n = read(fd, buf, MAX_USBFS_BUFFER_SIZE)) &gt;= 0)
    {
        fprintf(stderr, "Error: %d\n", n);
        write(1, buf, n);
        putchar('\n');
    }
}

static void usb_accessory_write(int fd, char* buff, int length)
{
    char write_buff[MAX_USBFS_BUFFER_SIZE + 1] = {0x00};

    length = (length &gt;= MAX_USBFS_BUFFER_SIZE) ? MAX_USBFS_BUFFER_SIZE : length;

    fprintf(stderr, "Error: length %d\n", length);
    memcpy(write_buff, buff, length);
    int result = write(fd, write_buff, length);
    fprintf(stderr, "Error: result %d\n", result);
}

int main()
{
    //usb_accessory_write(open_accessory(), "123456789", 9);
    usb_accessory_read(open_accessory());
    return 0;
}
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e8a972d3942b05ec77baf849bfecbbfa/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PPWOW纯公益性的80级WLK巫妖王之怒怀旧服服务器架构</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6538e0df40800cf81cc0d96a0f014598/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ESXi复制虚拟机步骤和解决“esxi 复制虚拟机 缺少所需的磁盘镜像”的报错</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>