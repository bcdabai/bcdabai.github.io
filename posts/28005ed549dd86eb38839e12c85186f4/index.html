<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpeechSynthesizer/WaveHeader 存在严重的内存泄漏 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpeechSynthesizer/WaveHeader 存在严重的内存泄漏" />
<meta property="og:description" content=".Net Framework 3.0带了个System.Speech.dll，装个语音包，然后就可以实现文字朗读等功能。最近在使用的时候，发现随着程序的运行，程序占用的内存一直在增长，直到程序崩溃。
用WinDbg抓了个Dump，然后看了下，里面一堆没有释放的SPVTEXTFRAG、AudioDeviceOut&#43;InItem、WAVEHDR、WaveHeader对象，于是写了一小段来测试：
1: //happyhippy.cnblogs.com 2: using System.Speech.Synthesis; 3: using (SpeechSynthesizer ss = new SpeechSynthesizer()) 4: { 5: for (int i = 0; i &lt; int.MaxValue; i&#43;&#43;) 6: { 7: ss.Speak(i.ToString()); 8: } 9: } 跑了几个小时，然后抓了个内存，开始干活：
1. 看下内存中有哪些对象
1: 0:000&gt; .load clr20/sos.dll 2: 0:000&gt; !dumpheap -stat 3: PDB symbol for mscorwks.dll not loaded 4: total 275193 objects 5: Statistics: 6: MT Count TotalSize Class Name 7: 70441ff8 1 12 System." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/28005ed549dd86eb38839e12c85186f4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-05T01:03:38+08:00" />
<meta property="article:modified_time" content="2019-07-05T01:03:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpeechSynthesizer/WaveHeader 存在严重的内存泄漏</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="cnblogs_post_body" class="blogpost-body"> 
 <p>    .Net Framework 3.0带了个System.Speech.dll，装个语音包，然后就可以实现文字朗读等功能。最近在使用的时候，发现随着程序的运行，程序占用的内存一直在增长，直到程序崩溃。</p> 
 <p>     用WinDbg抓了个Dump，然后看了下，里面一堆没有释放的SPVTEXTFRAG、AudioDeviceOut+InItem、WAVEHDR、WaveHeader对象，于是写了一小段来测试：</p> 
 <div style="border:1px solid #808080;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;font-size:8pt;"> 
  <div style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   1:</span> <span style="color:#008000;">//happyhippy.cnblogs.com</span></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   2:</span> <span style="color:#0000ff;">using</span> System.Speech.Synthesis;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   3:</span> <span style="color:#0000ff;">using</span> (SpeechSynthesizer ss = <span style="color:#0000ff;">new</span> SpeechSynthesizer())</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   4:</span> {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   5:</span>     <span style="color:#0000ff;">for</span> (<span style="color:#0000ff;">int</span> i = 0; i &lt; <span style="color:#0000ff;">int</span>.MaxValue; i++)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   6:</span>     {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   7:</span>         ss.Speak(i.ToString());</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   8:</span>     }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   9:</span> }</pre> 
  </div> 
 </div> 
 <p>    跑了几个小时，然后抓了个内存，开始干活：</p> 
 <p> </p> 
 <p><strong>1. 看下内存中有哪些对象</strong></p> 
 <div style="border:1px solid #808080;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;font-size:8pt;"> 
  <div style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   1:</span> 0:000&gt; .load clr20/sos.dll</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   2:</span> 0:000&gt; !dumpheap -stat</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   3:</span> PDB symbol <span style="color:#0000ff;">for</span> mscorwks.dll not loaded</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   4:</span> total 275193 objects</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   5:</span> Statistics:</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   6:</span>       MT    Count    TotalSize Class Name</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   7:</span> 70441ff8        1           12 System.RuntimeTypeHandle</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   8:</span> 7043fc7c        1           12 System.__Filters</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   9:</span> <span style="color:#008000;">//。。。。。。。。。。。。中间省略了一堆。。。。。。。。。。。</span></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  10:</span> 704431a8       18         1008 System.Collections.Hashtable</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  11:</span> 7042c938       65         1560 System.Security.Policy.StrongNameMembershipCondition</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  12:</span> 70441cd4       81         1620 System.RuntimeType</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  13:</span> 70441784       16         1820 System.Char[]</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  14:</span> 7042c6e4      232         6496 System.Security.SecurityElement</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  15:</span> 70442b84      278         6672 System.Collections.ArrayList</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  16:</span> 704435c4       17        75056 System.Byte[]</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  17:</span> 5610529c     4297        85940 System.Speech.Internal.AlphabetConverter+PhoneMapData+ConversionUnit</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  18:</span> 704432a4       18       181896 System.Collections.Hashtable+bucket[]</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  19:</span> 70414324      376       319064 System.Object[]</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  20:</span> 70440b54    13185       396696 System.String</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  21:</span> 5610ab38     7538       693496 System.Speech.Synthesis.TtsEngine.SPVTEXTFRAG</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  22:</span> 56105c50    63264      1012224 System.Speech.Internal.Synthesis.AudioDeviceOut+InItem</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  23:</span> 560f2694    65652      2626080 System.Speech.Internal.Synthesis.WAVEHDR</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  24:</span> <strong></strong>    63264      3289728 System.Speech.Internal.Synthesis.</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  25:</span> <strong></strong></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  26:</span> Total 275193 objects</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  27:</span> Fragmented blocks larger than 0.5 MB:</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  28:</span>     Addr     Size      Followed by</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  29:</span> 1228c6d8    0.5MB         12311d7c System.Speech.Synthesis.TtsEngine.SPVTEXTFRAG</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  30:</span> 123293e0    0.6MB         123baa64 System.Speech.Synthesis.TtsEngine.SPVTEXTFRAG</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  31:</span> 124be36c    1.9MB         1269d898 System.Speech.Synthesis.TtsEngine.SPVTEXTFRAG</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  32:</span> 126a39f0    1.3MB         127e6644 System.Speech.Synthesis.TtsEngine.SPVTEXTFRAG</pre> 
  </div> 
 </div> 
 <p> </p> 
 <p>    列表中的第25行，172M的Free状态的内存。</p> 
 <p>    最后4行(29~32)的内存碎片，用DumpObj看了下，都是Free状态。</p> 
 <p> </p> 
 <p><strong>2. 看看终结队列中有哪些对象</strong></p> 
 <div style="border:1px solid #808080;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;font-size:8pt;"> 
  <div style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   1:</span> 0:000&gt; !FinalizeQueue -detail</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   2:</span> SyncBlocks to be cleaned up: 0</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   3:</span> MTA Interfaces to be released: 0</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   4:</span> STA Interfaces to be released: 0</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   5:</span> ----------------------------------</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   6:</span> generation 0 has 2973 finalizable objects (068fdec4-&gt;06900d38)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   7:</span> generation 1 has 11 finalizable objects (068fde98-&gt;068fdec4)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   8:</span> generation 2 has 60304 finalizable objects (068c3058-&gt;068fde98)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   9:</span> Ready <span style="color:#0000ff;">for</span> finalization 0 objects (06900d38-&gt;06900d38)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  10:</span> Statistics:</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  11:</span>       MT    Count    TotalSize Class Name</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  12:</span> 7043a304        1           16 System.WeakReference</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  13:</span> 7002d1c8        1           20 System.ComponentModel.AsyncOperation</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  14:</span> 5610a9c0        1           20 System.Speech.Synthesis.SpeechSynthesizer</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  15:</span> 5610576c        1           20 System.Speech.Internal.ObjectTokens.RegistryDataKey</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  16:</span> 5610581c        1           24 System.Speech.Internal.ObjectTokens.ObjectToken</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  17:</span> 56105ae8        1           56 System.Speech.Internal.Synthesis.AudioDeviceOut</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  18:</span> 70427b90        4           80 Microsoft.Win32.SafeHandles.SafeWaitHandle</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  19:</span> 561092e0        1          176 System.Speech.Internal.Synthesis.VoiceSynthesis</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  20:</span> 7043b370        9          180 Microsoft.Win32.SafeHandles.SafeRegistryHandle</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  21:</span> 70441128        4          224 System.Threading.Thread</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  22:</span> <strong></strong>    63264      3289728 System.Speech.Internal.Synthesis.WaveHeader</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  23:</span> Total 63288 objects</pre> 
  </div> 
 </div> 
 <p>    我靠，内存中3289728个WaveHeader全部挂在终结队列中。一个可能的原因就是：<strong>WaveHeader对象中实现了析构函数</strong>，<strong>并且程序使用完WaveHeader对象后，没有手动释放(Dispose)，而是等着GC来自动回收。</strong></p> 
 <p> </p> 
 <p><strong>3. 用Reflector看WaveHeader的源代码</strong></p> 
 <div style="border:1px solid #808080;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;font-size:8pt;"> 
  <div style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   1:</span> <span style="color:#0000ff;">internal</span> <span style="color:#0000ff;">sealed</span> <span style="color:#0000ff;">class</span> WaveHeader : IDisposable</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   2:</span> {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   3:</span>     <span style="color:#008000;">// Fields</span></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   4:</span>     <span style="color:#0000ff;">internal</span> <span style="color:#0000ff;">int</span> _dwBufferLength;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   5:</span>     <span style="color:#0000ff;">private</span> GCHandle _gcHandle = <span style="color:#0000ff;">new</span> GCHandle();</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   6:</span>     <span style="color:#0000ff;">private</span> GCHandle _gcHandleWaveHdr = <span style="color:#0000ff;">new</span> GCHandle();</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   7:</span>     <span style="color:#0000ff;">private</span> WAVEHDR _waveHdr = <span style="color:#0000ff;">new</span> WAVEHDR();</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   8:</span>     <span style="color:#0000ff;">internal</span> <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">int</span> WAVE_FORMAT_PCM = 1;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   9:</span>     <span style="color:#0000ff;">internal</span> <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">int</span> WHDR_BEGINLOOP = 4;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  10:</span>     <span style="color:#0000ff;">internal</span> <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">int</span> WHDR_DONE = 1;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  11:</span>     <span style="color:#0000ff;">internal</span> <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">int</span> WHDR_ENDLOOP = 8;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  12:</span>     <span style="color:#0000ff;">internal</span> <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">int</span> WHDR_INQUEUE = 0x10;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  13:</span>     <span style="color:#0000ff;">internal</span> <span style="color:#0000ff;">const</span> <span style="color:#0000ff;">int</span> WHDR_PREPARED = 2;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  14:</span>  </pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  15:</span>     <span style="color:#008000;">// Methods</span></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  16:</span>     <span style="color:#0000ff;">internal</span> WaveHeader(<span style="color:#0000ff;">byte</span>[] buffer)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  17:</span>     {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  18:</span>         <span style="color:#0000ff;">this</span>._dwBufferLength = buffer.Length;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  19:</span>         <strong></strong></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  20:</span>     }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  21:</span>  </pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  22:</span>     <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Dispose()</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  23:</span>     {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  24:</span>         <span style="color:#0000ff;">this</span>.Dispose(<span style="color:#0000ff;">true</span>);</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  25:</span>         GC.SuppressFinalize(<span style="color:#0000ff;">this</span>);</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  26:</span>     }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  27:</span>  </pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  28:</span>     <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">void</span> Dispose(<span style="color:#0000ff;">bool</span> disposing)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  29:</span>     {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  30:</span>         <span style="color:#0000ff;">if</span> (disposing)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  31:</span>         {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  32:</span>             <span style="color:#0000ff;">this</span>.ReleaseData();</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  33:</span>             <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>._gcHandleWaveHdr.IsAllocated)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  34:</span>             {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  35:</span>                 <span style="color:#0000ff;">this</span>._gcHandleWaveHdr.Free();</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  36:</span>             }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  37:</span>         }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  38:</span>     }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  39:</span>  </pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  40:</span>     ~WaveHeader()</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  41:</span>     {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  42:</span>         <span style="color:#0000ff;">this</span>.Dispose(<span style="color:#0000ff;">false</span>);</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  43:</span>     }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  44:</span>  </pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  45:</span>     <span style="color:#0000ff;">internal</span> <span style="color:#0000ff;">void</span> ReleaseData()</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  46:</span>     {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  47:</span>         <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>._gcHandle.IsAllocated)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  48:</span>         {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  49:</span>             <span style="color:#0000ff;">this</span>._gcHandle.Free();</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  50:</span>         }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  51:</span>     }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  52:</span>  </pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  53:</span>     <span style="color:#008000;">// Properties</span></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  54:</span>     <span style="color:#0000ff;">internal</span> <span style="color:#0000ff;">int</span> SizeHDR</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  55:</span>     {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  56:</span>         get</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  57:</span>         {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  58:</span>             <span style="color:#0000ff;">return</span> Marshal.SizeOf(<span style="color:#0000ff;">this</span>._waveHdr);</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  59:</span>         }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  60:</span>     }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  61:</span>  </pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  62:</span>     <span style="color:#0000ff;">internal</span> GCHandle WAVEHDR</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  63:</span>     {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  64:</span>         get</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  65:</span>         {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  66:</span>             <span style="color:#0000ff;">if</span> (!<span style="color:#0000ff;">this</span>._gcHandleWaveHdr.IsAllocated)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  67:</span>             {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  68:</span>                 <span style="color:#0000ff;">this</span>._waveHdr.lpData = <span style="color:#0000ff;">this</span>._gcHandle.AddrOfPinnedObject();</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  69:</span>                 <span style="color:#0000ff;">this</span>._waveHdr.dwBufferLength = (<span style="color:#0000ff;">uint</span>) <span style="color:#0000ff;">this</span>._dwBufferLength;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  70:</span>                 <span style="color:#0000ff;">this</span>._waveHdr.dwBytesRecorded = 0;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  71:</span>                 <span style="color:#0000ff;">this</span>._waveHdr.dwUser = 0;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  72:</span>                 <span style="color:#0000ff;">this</span>._waveHdr.dwFlags = 0;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  73:</span>                 <span style="color:#0000ff;">this</span>._waveHdr.dwLoops = 0;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  74:</span>                 <span style="color:#0000ff;">this</span>._waveHdr.lpNext = IntPtr.Zero;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  75:</span>                 <strong></strong></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  76:</span>             }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  77:</span>             <span style="color:#0000ff;">return</span> <span style="color:#0000ff;">this</span>._gcHandleWaveHdr;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  78:</span>         }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  79:</span>     }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  80:</span> }</pre> 
  </div> 
 </div> 
 <p>   如我们所料，的确定义了一个析构函数（~<strong>WaveHeader</strong>()），WaveHealder实现了Dispose模式。</p> 
 <p> </p> 
 <p><strong>4.  进一步分析，看看WaveHeader都申请了啥资源，为啥要实现Dispose模式</strong></p> 
 <p>    WaveHeader的构造函数中，申请了一片Pinned状态的内存<strong>this._gcHandle = GCHandle.Alloc(</strong><strong>buffer</strong><strong>, GCHandleType.Pinned)，</strong>并且其WAVEHDR属性的实现中，也通过延迟加载的方式申请了一片Pinned状态的内存<strong>this._gcHandleWaveHdr = GCHandle.Alloc(this._waveHdr, GCHandleType.Pinned)。</strong></p> 
 <p><strong>    </strong>MSDN对GCHander的阐述如下：(FROM <a href="http://msdn.microsoft.com/zh-cn/library/system.runtime.interopservices.gchandle.aspx" rel="nofollow">MSDN</a>)</p> 
 <div style="border:1px solid #808080;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;font-size:8pt;"> 
  <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">GCHandle 类与 GCHandleType 枚举结合使用以创建对应于任何托管对象的句柄。此句柄可为以下四种类型之一：Weak、WeakTrackResurrection、Normal 或 Pinned。分配了句柄以后，在非托管客户端保留唯一的引用时，可以使用它防止垃圾回收器回收托管对象。如果没有这样的句柄，则在该对象代表非托管客户端完成工作以前，有可能被垃圾回收器回收。 <br><br>用 GCHandle 创建一个固定对象，该对象返回��个内存地址，并防止垃圾回收器在内存中移动该对象。 <br><br><strong></strong>当您释放固定的句柄时，如果没有对关联对象的其他引用，则关联对象将解除固定，并可以被当成垃圾回收。<br><br></pre> 
 </div> 
 <p>    也就是说，通过GCHandler.Alloc申请的内存，必须通过调用GCHandler.Free方法来手动释放。表面上看来，WaveHeader的实现中，的确有手动释放这些申请的内存。</p> 
 <p> </p> 
 <p> </p> 
 <p> </p> 
 <p> </p> 
 <p> </p> 
 <p><strong>5.  WaveHeader在哪儿使用</strong></p> 
 <p>   SpeechSynthesizer封装了一对东西，有点儿绕，我顺着Speak方法找了N久，没有找到使用WaveHeader的地方。</p> 
 <p>   只好换另一个思路：在上面的第1步中，我们可以看到，WaveHeader的MT Address为56105b6c，于是：</p> 
 <div style="border:1px solid #808080;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;font-size:8pt;"> 
  <div style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">0:000&gt; !dumpheap -MT 56105b6c</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#008000;">//。。。省却6万多行。。。  </span></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">127fabdc 56105b6c       52     </pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><strong></strong></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">total 63264 objects</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">Statistics:</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">      MT    Count    TotalSize Class Name</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">56105b6c    63264      3289728 System.Speech.Internal.Synthesis.WaveHeader</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">Total 63264 objects</pre> 
  </div> 
 </div> 
 <p>   然后找到一个还活着的对象(地址为12800a64)，看看它被谁引用了：</p> 
 <div style="border:1px solid #808080;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;font-size:8pt;"> 
  <div style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">0:000&gt; !gcroot 12800a64</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">Note: Roots found on stacks may be <span style="color:#0000ff;">false</span> positives. Run <span style="color:#006080;">"!help gcroot"</span> <span style="color:#0000ff;">for</span></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">more info.</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">Scan Thread 0 OSTHread 3668</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">ESP:1df238:Root:01f67e1c(System.Speech.Internal.Synthesis.VoiceSynthesis)-&gt;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">01f6841c(System.Speech.Internal.Synthesis.AudioDeviceOut)-&gt;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">01f68570(System.Collections.Generic.List`1[[System.Speech.Internal.Synthesis.AudioDeviceOut+InItem, System.Speech]])-&gt;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">02f91c10(System.Object[])-&gt;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">020e4088(System.Speech.Internal.Synthesis.AudioDeviceOut+InItem)-&gt;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">12800a64(System.Speech.Internal.Synthesis.WaveHeader)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">Scan Thread 2 OSTHread 2c5c</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">Scan Thread 3 OSTHread 1160</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">Scan Thread 4 OSTHread 211c</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">Scan Thread 6 OSTHread 22d4</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">Scan Thread 7 OSTHread 2fcc</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;">Scan Thread 8 OSTHread 377c</pre> 
  </div> 
 </div>   这里，我们终于可以看到路径了： 
 <p> </p> 
 <p>SpeechSynthesizer<br>-&gt;VoiceSynthesis<br>-&gt;AudioDeviceOut<br>-&gt; List&lt;AudioDeviceOut + InItem&gt; <br>-&gt; AudioDeviceOut + InItem（内部类）<br>-&gt; WaveHeader<br>    终于找到目标了：AudioDeviceOut。</p> 
 <p> </p> 
 <p><strong>6.  怎么使用WaveHeader</strong></p> 
 <p>    AudioDeviceOut的代码页有点长，这里只截出部分使用WaveHeader的代码：</p> 
 <div style="border:1px solid #808080;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;font-size:8pt;"> 
  <div style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   1:</span> <span style="color:#0000ff;">internal</span> <span style="color:#0000ff;">override</span> <span style="color:#0000ff;">void</span> Play(<span style="color:#0000ff;">byte</span>[] buffer)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   2:</span> {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   3:</span>     <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>._deviceOpen)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   4:</span>     {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   5:</span>         <span style="color:#0000ff;">int</span> length = buffer.Length;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   6:</span>         <span style="color:#0000ff;">this</span>._bytesWritten += length;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   7:</span>         WaveHeader waveHeader = <span style="color:#0000ff;">new</span> WaveHeader(buffer);<strong></strong></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   8:</span>         GCHandle wAVEHDR = waveHeader.WAVEHDR;<strong></strong></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   9:</span>         MMSYSERR errorCode = SafeNativeMethods.waveOutPrepareHeader(<span style="color:#0000ff;">this</span>._hwo, wAVEHDR.AddrOfPinnedObject(), waveHeader.SizeHDR);</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  10:</span>         <span style="color:#0000ff;">if</span> (errorCode != MMSYSERR.NOERROR)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  11:</span>         {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  12:</span>             <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> AudioException(errorCode);</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  13:</span>         }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  14:</span>         <span style="color:#0000ff;">lock</span> (<span style="color:#0000ff;">this</span>._noWriteOutLock)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  15:</span>         {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  16:</span>             <span style="color:#0000ff;">if</span> (!<span style="color:#0000ff;">base</span>._aborted)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  17:</span>             {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  18:</span>                 <span style="color:#0000ff;">lock</span> (<span style="color:#0000ff;">this</span>._queueIn)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  19:</span>                 {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  20:</span>                     InItem item = <span style="color:#0000ff;">new</span> InItem(waveHeader);<strong></strong></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  21:</span>                     <span style="color:#0000ff;">this</span>._queueIn.Add(item); </pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  22:</span>                     <span style="color:#0000ff;">this</span>._evt.Reset();</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  23:</span>                 }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  24:</span>                 errorCode = SafeNativeMethods.waveOutWrite(<span style="color:#0000ff;">this</span>._hwo, wAVEHDR.AddrOfPinnedObject(), waveHeader.SizeHDR);</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  25:</span>                 <span style="color:#0000ff;">if</span> (errorCode != MMSYSERR.NOERROR)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  26:</span>                 {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  27:</span>                     <span style="color:#0000ff;">lock</span> (<span style="color:#0000ff;">this</span>._queueIn)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  28:</span>                     {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  29:</span>                         <span style="color:#0000ff;">this</span>._queueIn.RemoveAt(<span style="color:#0000ff;">this</span>._queueIn.Count - 1);<strong></strong></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  30:</span>                         <span style="color:#0000ff;">throw</span> <span style="color:#0000ff;">new</span> AudioException(errorCode);</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  31:</span>                     }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  32:</span>                 }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  33:</span>             }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  34:</span>         }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  35:</span>     }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  36:</span> }</pre> 
  </div> 
 </div> 
 <p>   在这里，Play方法了面，终于实例化了WaveHeader和WaveHDR(GCHandler)；但是实例化的WaveHeader又被InItem封装了一下，加入到List&lt;InItem&gt; _queueIn中。<br>    Play<strong>方法里面创建了WaveHeader，但是却没有看到释放WaveHeader的代码</strong>。</p> 
 <p>    那我们再来看下，其他地方有没有释放WaveHeader的代码：既然InItem/WaveHeader被加入到_queueIn中了，程序应该还要使用WaveHeader；那么当InItem从该_queueIn中移出的时候，应该就会释放WaveHeader了吧。顺着这个思路继续往下看。。。</p> 
 <p>   很不幸，就在Play方法里面：当判断播放出错的时候，会把InItem从_queueIn中移出(上面第29行)，但是却<font color="#ff0000"><strong>没有释放InItem/WaveHeader</strong></font>。</p> 
 <p>  另一个将InItem从_queueIn中移出的地方是CallBackProc，AudioDeviceOut在构造函数中初始化了一个委托：this._delegate = new SafeNativeMethods.WaveOutProc(this.CallBackProc); 从字面上理解，应该是输出声音完毕后，调用这个回调函数，来释放内存：</p> 
 <div style="border:1px solid #808080;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;font-size:8pt;"> 
  <div style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   1:</span> <span style="color:#0000ff;">private</span> <span style="color:#0000ff;">void</span> CallBackProc(IntPtr hwo, MM_MSG uMsg, IntPtr dwInstance, IntPtr dwParam1, IntPtr dwParam2)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   2:</span> {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   3:</span>     <span style="color:#0000ff;">if</span> (uMsg == MM_MSG.MM_WOM_DONE)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   4:</span>     {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   5:</span>         <span style="color:#0000ff;">lock</span> (<span style="color:#0000ff;">this</span>._queueIn)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   6:</span>         {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   7:</span>             InItem item = <span style="color:#0000ff;">this</span>._queueIn[0];</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   8:</span>             item.ReleaseData();<strong></strong></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   9:</span>             <span style="color:#0000ff;">this</span>._queueIn.RemoveAt(0); <strong></strong></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  10:</span>             <span style="color:#0000ff;">this</span>._queueOut.Add(item);</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  11:</span>             <span style="color:#0000ff;">while</span> (<span style="color:#0000ff;">this</span>._queueIn.Count &gt; 0)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  12:</span>             {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  13:</span>                 item = <span style="color:#0000ff;">this</span>._queueIn[0];</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  14:</span>                 <span style="color:#0000ff;">if</span> (item._waveHeader != <span style="color:#0000ff;">null</span>)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  15:</span>                 {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  16:</span>                     <span style="color:#0000ff;">break</span>;</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  17:</span>                 }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  18:</span>                 <span style="color:#0000ff;">if</span> ((<span style="color:#0000ff;">this</span>._asyncDispatch != <span style="color:#0000ff;">null</span>) &amp;&amp; !<span style="color:#0000ff;">base</span>._aborted)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  19:</span>                 {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  20:</span>                     <span style="color:#0000ff;">this</span>._asyncDispatch.Post(item._userData);</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  21:</span>                 }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  22:</span>                 <span style="color:#0000ff;">this</span>._queueIn.RemoveAt(0);<strong></strong></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  23:</span>             }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  24:</span>         }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  25:</span>         <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>._queueIn.Count == 0)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  26:</span>         {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  27:</span>             <span style="color:#0000ff;">this</span>._evt.Set();</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  28:</span>         }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  29:</span>     }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  30:</span> }</pre> 
  </div> 
 </div> 
 <p>    代码中，可以看到，当uMsg == MM_MSG.MM_WOM_DONE，才会执行释放操作。MM_MSG枚举有三个可选值：MM_WOM_CLOSE = 0x3bc, MM_WOM_DONE = 0x3bd, MM_WOM_OPEN = 0x3bb，暂时不太清楚是回调函数的uMsg参数 否可能会传入其他值；如果传入了其他值，显然<font color="#ff0000"><strong>InItem/WaveHeader有没有被释放。</strong></font></p> 
 <p>    即使uMsg == MM_MSG.MM_WOM_DONE，我们来看下释放的代码，上面第8~9行，从_queueIn中移除InItem/WaveHeader的时候，的确执行了ReleaseData()来释放内存，但是看该方法的源代码：</p> 
 <div style="border:1px solid #808080;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;font-size:8pt;"> 
  <div style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   1:</span> <span style="color:#008000;">//happyhippy.cnblogs.com</span></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   2:</span> <span style="color:#008000;">//InItem</span></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   3:</span> <span style="color:#0000ff;">internal</span> <span style="color:#0000ff;">void</span> ReleaseData()</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   4:</span> {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   5:</span>     <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>._waveHeader != <span style="color:#0000ff;">null</span>)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   6:</span>     {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   7:</span>         <span style="color:#0000ff;">this</span>._waveHeader.ReleaseData();</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   8:</span>     }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">   9:</span> }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  10:</span> <span style="color:#008000;">//WaveHeader</span></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  11:</span> <span style="color:#0000ff;">internal</span> <span style="color:#0000ff;">void</span> ReleaseData()</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  12:</span> {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  13:</span>     <span style="color:#0000ff;">if</span> (<span style="color:#0000ff;">this</span>._gcHandle.IsAllocated)</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  14:</span>     {<!-- --></pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  15:</span>         <span style="color:#0000ff;">this</span>._gcHandle.Free();</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  16:</span>     }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  17:</span> }</pre> 
   <pre style="border-style:none;line-height:12pt;font-family:consolas, 'Courier New', courier, monospace;color:#000000;font-size:8pt;"><span style="color:#606060;">  18:</span>  </pre> 
  </div> 
 </div> 
 <p>   里面调用WaveHeader.ReleaseData()来释放内存，不是调用Dispose来释放内存。上面提到，Play方法中，第8行GCHandle wAVEHDR = waveHeader.WAVEHDR申请了内存，<strong><font color="#ff0000">但是ReleaseData()方法并没有释放该内存。应该调用Dispose来释放内存，而不是调用ReleaseData()。</font></strong></p> 
 <p>   然后在回过头来看CallBackProc方法，从源代码中可以看到，其<strong><font color="#ff0000">只释放了_queueIn中第一个InItem/WaveHeader，后续的InItem/WaveHeader从_queueIn中移除的时候，并没有释放内存</font></strong>。</p> 
 <p><strong><font color="#ff0000">  GCHandler.Alloc申请的内存，必须通过调用Free方法显式释放它；否则，可能会发生内存泄漏。</font></strong></p> 
 <p><strong><font color="#ff0000"></font></strong> </p> 
 <p><strong>7.  解决办法</strong></p> 
 <p>   无解。</p> 
 <p>   那封装的一大坨，都是Internal。</p> 
</div> 
<p>转载于:https://www.cnblogs.com/happyhippy/archive/2010/11/07/1871258.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f9842900e97ded2000f339b05cbafdd4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Date and Time Arithmetic in JScript zz</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/11044aa5d4548f01f7d89730be0d1eb0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">删除Oracle表空间，提示ora－29857引用错误</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>