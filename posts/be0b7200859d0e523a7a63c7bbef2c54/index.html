<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ONVIF客户端搜索设备获取rtsp地址开发笔记(精华篇) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ONVIF客户端搜索设备获取rtsp地址开发笔记(精华篇)" />
<meta property="og:description" content="概要： 目前ONVIF协议家族设备已占据数字监控行业半壁江山以上，亲，作为开发者的你还在犹豫是否了解下吗？本文介绍了ONVIF客户端从设备搜索，鉴权，能力获取，媒体信息获取，URI地址获取的整套流程。文章只讲述了比较重要或其他博文没有讲述的开发点，详细可以参考文末参考文章。最后，能获得rtsp地址之后，然后去做其他功能比如录像，ptz这些就非常得心应手了。本文出自CSDN-固本培元 ，转载注明出自：leolupy@gmail.com。
前言及鸣谢： 感谢guog先生，快活林高先生，onvif全国交流群的的酷夏先生在开发过程中给予的巨大支持，没有你们的帮助开发过程将异常艰难啊。谢谢了！
ONVIF介绍： ONVIF致力于通过全球性的开放接口标准来推进网络视频在安防市场的应用，这一接口标准将确保不同厂商生产的网络视频产品具有互通性。2008年11月，论坛正式发布了ONVIF第一版规范——ONVIF核心规范1.0。随着视频监控的网络化应用，产业链的分工将越来越细。有些厂商专门做摄像头，有些厂商专门做DVS，有些厂商则可能专门做平台等，然后通过集成商进行集成，提供给最终客户。这种产业合作模式，已经迫切的需要行业提供越来越标准化的接口平台。
流程总览： 本文开发环境：Centos6.4 Gsoap:2.8.16 soap:1.2 onvif:2.4 。 注： 本文提供的参考代码其实网上都可以找到，这里做一个整理，供大家交流学习，共同提高。
搜索：Probe： 发现网络摄像头，获取webserver地址：http://192.168.15.240/onvif/device_service能力获取：GetCapabilities：获取设备能力文件，从中识别出媒体信息地址URI： http://192.168.15.240/onvif/Media媒体信息获取：GetProfiles： 获取媒体信息文件，识别主通道、子通道的视频编码分辨率RTSP地址获取：GetStreamUri：获取指定通道的流媒体地址 rtsp://192.168.15.240:554/Streaming/Channels/2?transportmode=unicast Gsoap及开发框架生成： 1. 下载Gsoap 地址： http://sourceforge.net/projects/gsoap2/files/gSOAP/
2. 安装 ./configure &amp;&amp; make &amp;&amp; make install 期间可能会有一些报错，自己解决哦。
3. 离线或者在线生成onvif.h。 如果不需要最新的版本推荐离线方式。笔者使用的是这种方式。离线文件下载地址：http://download.csdn.net/detail/u011597695/5875143（感谢guog先生的共享）
记得拷贝gsoap的typemap文件至生成目录下，wsdl2h命令需要这个。
在线命令：
wsdl2h -o onvif.h -c -s -t ./typemap.dat http://www.onvif.org/onvif/ver10/device/wsdl/devicemgmt.wsdl http://www.onvif.org/onvif/ver10/media/wsdl/media.wsdl http://www.onvif.org/onvif/ver10/event/wsdl/event.wsdl http://www.onvif.org/onvif/ver10/display.wsdl http://www.onvif.org/onvif/ver10/deviceio.wsdl http://www.onvif.org/onvif/ver20/imaging/wsdl/imaging.wsdl http://www.onvif.org/onvif/ver20/ptz/wsdl/ptz.wsdl http://www.onvif.org/onvif/ver10/receiver.wsdl http://www.onvif.org/onvif/ver10/recording.wsdl http://www.onvif.org/onvif/ver10/search.wsdl http://www.onvif.org/onvif/ver10/network/wsdl/remotediscovery.wsdl http://www.onvif.org/onvif/ver10/replay.wsdl http://www.onvif.org/onvif/ver20/analytics/wsdl/analytics.wsdl http://www.onvif.org/onvif/ver10/analyticsdevice.wsdl http://www.onvif.org/ver10/actionengine.wsdl http://www.onvif.org/ver10/pacs/accesscontrol.wsdl http://www.onvif.org/ver10/pacs/doorcontrol.wsdl 离线命令：
wsdl2h -o onvif.h -c -s -t ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/be0b7200859d0e523a7a63c7bbef2c54/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-06T10:34:34+08:00" />
<meta property="article:modified_time" content="2023-03-06T10:34:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ONVIF客户端搜索设备获取rtsp地址开发笔记(精华篇)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>概要：</h2> 
<p>  目前ONVIF协议家族设备已占据数字监控行业半壁江山以上，亲，作为开发者的你还在犹豫是否了解下吗？本文介绍了ONVIF客户端从设备搜索，鉴权，能力获取，媒体信息获取，URI地址获取的整套流程。文章只讲述了比较重要或其他博文没有讲述的开发点，详细可以参考文末参考文章。最后，能获得rtsp地址之后，然后去做其他功能比如录像，ptz这些就非常得心应手了。本文出自CSDN-固本培元 ，转载注明出自：leolupy@gmail.com。</p> 
<h2><a id="_2"></a>前言及鸣谢：</h2> 
<p>  感谢guog先生，快活林高先生，onvif全国交流群的的酷夏先生在开发过程中给予的巨大支持，没有你们的帮助开发过程将异常艰难啊。谢谢了！</p> 
<h2><a id="ONVIF_4"></a>ONVIF介绍：</h2> 
<p>  ONVIF致力于通过全球性的开放接口标准来推进<a href="https://baike.baidu.com/item/%E7%BD%91%E7%BB%9C%E8%A7%86%E9%A2%91" rel="nofollow">网络视频</a>在安防市场的应用，这一接口标准将确保不同厂商生产的网络视频产品具有互通性。2008年11月，论坛正式发布了ONVIF第一版规范——ONVIF核心规范1.0。随着<a href="https://baike.baidu.com/item/%E8%A7%86%E9%A2%91%E7%9B%91%E6%8E%A7" rel="nofollow">视频监控</a>的网络化应用，产业链的分工将越来越细。有些厂商专门做摄像头，有些厂商专门做DVS，有些厂商则可能专门做平台等，然后通过<a href="https://baike.baidu.com/item/%E9%9B%86%E6%88%90%E5%95%86" rel="nofollow">集成商</a>进行集成，提供给最终客户。这种产业合作模式，已经迫切的需要行业提供越来越标准化的接口平台。</p> 
<h2><a id="_6"></a>流程总览：</h2> 
<p>  本文开发环境：Centos6.4 Gsoap:2.8.16 soap:1.2 onvif:2.4 。 <font color="0xff000000"><strong>注： 本文提供的参考代码其实网上都可以找到，这里做一个整理，供大家交流学习，共同提高。</strong></font></p> 
<ul><li><strong>搜索：Probe</strong>： 发现网络摄像头，获取webserver地址：http://192.168.15.240/onvif/device_service</li><li><strong>能力获取：GetCapabilities</strong>：获取设备能力文件，从中识别出媒体信息地址URI： http://192.168.15.240/onvif/Media</li><li><strong>媒体信息获取：GetProfiles</strong>： 获取媒体信息文件，识别主通道、子通道的视频编码分辨率</li><li><strong>RTSP地址获取：GetStreamUri</strong>：获取指定通道的流媒体地址 rtsp://192.168.15.240:554/Streaming/Channels/2?transportmode=unicast</li></ul> 
<h2><a id="Gsoap_12"></a>Gsoap及开发框架生成：</h2> 
<h5><a id="1_Gsoap_13"></a>1. 下载Gsoap</h5> 
<p>  地址： <a href="http://sourceforge.net/projects/gsoap2/files/gSOAP/" rel="nofollow">http://sourceforge.net/projects/gsoap2/files/gSOAP/</a></p> 
<h5><a id="2__15"></a>2. 安装</h5> 
<pre><code class="prism language-bash">./configure <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre> 
<p>  期间可能会有一些报错，自己解决哦。</p> 
<h5><a id="3_onvifh_20"></a>3. 离线或者在线生成onvif.h。</h5> 
<p>  如果不需要最新的版本推荐离线方式。笔者使用的是这种方式。离线文件下载地址：<a href="http://download.csdn.net/detail/u011597695/5875143">http://download.csdn.net/detail/u011597695/5875143</a>（感谢guog先生的共享）</p> 
<p>  <strong>记得拷贝gsoap的typemap文件至生成目录下，wsdl2h命令需要这个。</strong></p> 
<p>  在线命令：</p> 
<pre><code class="prism language-bash">wsdl2h <span class="token parameter variable">-o</span> onvif.h <span class="token parameter variable">-c</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-t</span> ./typemap.dat http://www.onvif.org/onvif/ver10/device/wsdl/devicemgmt.wsdl http://www.onvif.org/onvif/ver10/media/wsdl/media.wsdl http://www.onvif.org/onvif/ver10/event/wsdl/event.wsdl http://www.onvif.org/onvif/ver10/display.wsdl http://www.onvif.org/onvif/ver10/deviceio.wsdl http://www.onvif.org/onvif/ver20/imaging/wsdl/imaging.wsdl http://www.onvif.org/onvif/ver20/ptz/wsdl/ptz.wsdl http://www.onvif.org/onvif/ver10/receiver.wsdl  http://www.onvif.org/onvif/ver10/recording.wsdl http://www.onvif.org/onvif/ver10/search.wsdl http://www.onvif.org/onvif/ver10/network/wsdl/remotediscovery.wsdl http://www.onvif.org/onvif/ver10/replay.wsdl http://www.onvif.org/onvif/ver20/analytics/wsdl/analytics.wsdl http://www.onvif.org/onvif/ver10/analyticsdevice.wsdl http://www.onvif.org/ver10/actionengine.wsdl http://www.onvif.org/ver10/pacs/accesscontrol.wsdl http://www.onvif.org/ver10/pacs/doorcontrol.wsdl
</code></pre> 
<p>  离线命令：</p> 
<pre><code class="prism language-bash">wsdl2h <span class="token parameter variable">-o</span> onvif.h <span class="token parameter variable">-c</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-t</span> ./typemap.dat devicemgmt.wsdl media.wsdl event.wsdl display.wsdl deviceio.wsdl imaging.wsdl ptz.wsdl receiver.wsdl recording.wsdl search.wsdl remotediscovery.wsdl replay.wsdl analytics.wsdl analyticsdevice.wsdl actionengine.wsdl accesscontrol.wsdl doorcontrol.wsdl 
</code></pre> 
<p>  现在可以开始生成了：如下：<br> <img src="https://images2.imgbox.com/86/92/DlYmp9Ad_o.png" alt="在这里插入图片描述"><br>   如果直接生成对应C的库文件会发生重复定义错误，如下：</p> 
<pre><code class="prism language-bash">wsa5.h<span class="token punctuation">(</span><span class="token number">288</span><span class="token punctuation">)</span>: **ERROR**: remote method name clash: struct/class <span class="token string">'SOAP_ENV__Fault'</span> already declared at line <span class="token number">274</span>
</code></pre> 
<p>  可以修改该文件 <strong>gsoap_2.8.16/gsoap-2.8/gsoap/import/ wsa5.h</strong><br>   将277行int SOAP_ENV__Fault修改为int SOAP_ENV__Fault_alex</p> 
<p>  笔者没有使用这种方法，是将这个结构体直接注释的方式，最后的结果是，都可以使用。<br>   同时，上一步生成的onvif.h文件中没有打开wsse.h， 导致最后生成代码中SOAP_ENV__Header 结构体中缺少定义 wsse__Security数据段，无法进行鉴权命令。即：添加对openssl的支持，在上一步生成的onvif.h中添加（可选）</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">import</span> <span class="token string">"wsse.h"</span></span>
</code></pre> 
<p>  随后使用命令生成：</p> 
<pre><code class="prism language-bash">soapcpp2  <span class="token parameter variable">-c</span> onvif.h <span class="token parameter variable">-x</span> -I/root/Tools/Gsoap/gsoap-2.8/gsoap/import -I/root/Tools/Gsoap/gsoap-2.8/gsoap/ -I/root/Tools/Gsoap/gsoap-2.8/gsoap/custom -I/root/Tools/Gsoap/gsoap-2.8/gsoap/extras -I/root/Tools/Gsoap/gsoap-2.8/gsoap/plugin 
</code></pre> 
<p><img src="https://images2.imgbox.com/e5/e4/Z1zpYWZR_o.png" alt="在这里插入图片描述"><br>   到此为止，基于 C 的客户端和服务器的Onvif开发框架及已经搭建完成。</p> 
<h2><a id="_56"></a>设备搜索原理及编程技巧：</h2> 
<p>  搜索发现的基本原理是：设备上服务器监听239.255.255.250的3702端口。所以，如果要实现跨网段搜索onvif设备需要路由的支持。只要组播数据包能收到，设备就能被搜到。原理是这样。参考代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">soap</span><span class="token operator">*</span> <span class="token function">NewSoap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">SOAP_ENV__Header</span> <span class="token operator">*</span>header<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">soap</span><span class="token operator">*</span> soap<span class="token punctuation">,</span>
		wsdd__ProbeType <span class="token operator">*</span>req_<span class="token punctuation">,</span>
		wsdd__ScopesType <span class="token operator">*</span>sScope_<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	soap <span class="token operator">=</span> <span class="token function">soap_new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> soap <span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sopa new error\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	soap<span class="token operator">-&gt;</span>recv_timeout <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
	<span class="token function">soap_set_namespaces</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span> namespaces<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token function">soap_default_SOAP_ENV__Header</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">uuid_t</span> uuid<span class="token punctuation">;</span>
	<span class="token keyword">char</span> guid_string<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">uuid_generate</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">uuid_unparse</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> guid_string<span class="token punctuation">)</span><span class="token punctuation">;</span>

	header<span class="token operator">-&gt;</span>wsa__MessageID <span class="token operator">=</span> guid_string<span class="token punctuation">;</span>
	header<span class="token operator">-&gt;</span>wsa__To <span class="token operator">=</span> <span class="token string">"urn:schemas-xmlsoap-org:ws:2005:04:discovery"</span><span class="token punctuation">;</span>
	header<span class="token operator">-&gt;</span>wsa__Action <span class="token operator">=</span> <span class="token string">"http://schemas.xmlsoap.org/ws/2005/04/discovery/Probe"</span><span class="token punctuation">;</span>
	soap<span class="token operator">-&gt;</span>header <span class="token operator">=</span> header<span class="token punctuation">;</span>

	<span class="token function">soap_default_wsdd__ScopesType</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span> sScope_<span class="token punctuation">)</span><span class="token punctuation">;</span>
	sScope_<span class="token operator">-&gt;</span>__item <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
	<span class="token function">soap_default_wsdd__ProbeType</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span> req_<span class="token punctuation">)</span><span class="token punctuation">;</span>
	req_<span class="token operator">-&gt;</span>Scopes <span class="token operator">=</span> sScope_<span class="token punctuation">;</span>
	req_<span class="token operator">-&gt;</span>Types <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span> <span class="token comment">//"dn:NetworkVideoTransmitter";</span>

	<span class="token keyword">return</span> soap <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  	
result <span class="token operator">=</span> <span class="token function">soap_send___wsdd__Probe</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span> MULTICAST_ADDRESS<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span><span class="token punctuation">(</span>result <span class="token operator">==</span> SOAP_OK<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	result <span class="token operator">=</span> <span class="token function">soap_recv___wsdd__ProbeMatches</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">==</span> SOAP_OK<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>soap<span class="token operator">-&gt;</span>error<span class="token punctuation">)</span>  
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"soap error 1: %d, %s, %s\n"</span><span class="token punctuation">,</span> soap<span class="token operator">-&gt;</span>error<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">soap_faultcode</span><span class="token punctuation">(</span>soap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">soap_faultstring</span><span class="token punctuation">(</span>soap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			result <span class="token operator">=</span> soap<span class="token operator">-&gt;</span>error<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Onvif Device detected *********************************************\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> resp<span class="token punctuation">.</span>wsdd__ProbeMatches<span class="token operator">-&gt;</span>__sizeProbeMatch<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"__sizeProbeMatch        : %d\r\n"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>wsdd__ProbeMatches<span class="token operator">-&gt;</span>__sizeProbeMatch<span class="token punctuation">)</span><span class="token punctuation">;</span>  
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"wsa__EndpointReference       : %p\r\n"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>wsdd__ProbeMatches<span class="token operator">-&gt;</span>ProbeMatch<span class="token operator">-&gt;</span>wsa__EndpointReference<span class="token punctuation">)</span><span class="token punctuation">;</span>  
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Target EP Address       : %s\r\n"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>wsdd__ProbeMatches<span class="token operator">-&gt;</span>ProbeMatch<span class="token operator">-&gt;</span>wsa__EndpointReference<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">;</span>  
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Target Type             : %s\r\n"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>wsdd__ProbeMatches<span class="token operator">-&gt;</span>ProbeMatch<span class="token operator">-&gt;</span>Types<span class="token punctuation">)</span><span class="token punctuation">;</span>  
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Target Service Address  : %s\r\n"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>wsdd__ProbeMatches<span class="token operator">-&gt;</span>ProbeMatch<span class="token operator">-&gt;</span>XAddrs<span class="token punctuation">)</span><span class="token punctuation">;</span>  
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Target Metadata Version : %d\r\n"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>wsdd__ProbeMatches<span class="token operator">-&gt;</span>ProbeMatch<span class="token operator">-&gt;</span>MetadataVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>  
				<span class="token keyword">if</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>wsdd__ProbeMatches<span class="token operator">-&gt;</span>ProbeMatch<span class="token operator">-&gt;</span>Scopes<span class="token punctuation">)</span>  
				<span class="token punctuation">{<!-- --></span>
					<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Target Scopes Address   : %s\r\n"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>wsdd__ProbeMatches<span class="token operator">-&gt;</span>ProbeMatch<span class="token operator">-&gt;</span>Scopes<span class="token operator">-&gt;</span>__item<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>soap<span class="token operator">-&gt;</span>error<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d] soap error 2: %d, %s, %s\n"</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> soap<span class="token operator">-&gt;</span>error<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">soap_faultcode</span><span class="token punctuation">(</span>soap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">soap_faultstring</span><span class="token punctuation">(</span>soap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result <span class="token operator">=</span> soap<span class="token operator">-&gt;</span>error<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  注：搜索到的设备可以加入到自己的设备管理中，这里就不做过多的说明了。</p> 
<h2><a id="_138"></a>设备鉴权：</h2> 
<p>  鉴权的实现可以很简单也可以很难，这里笔者使用的是gsoap提供的方法：直接调用即可：</p> 
<pre><code class="prism language-c"><span class="token function">soap_wsse_add_UsernameTokenDigest</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span><span class="token string">"user"</span><span class="token punctuation">,</span> ONVIF_USER<span class="token punctuation">,</span> ONVIF_PASSWORD<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  原理也很容易明白其实，就是讲http的soap消息加入对应header中xml的元素而已，然后敏感消息digest MD5加密编码。<br>   所以编译过程中需要使用 lcrypto 也就很正常了。</p> 
<h2><a id="_145"></a>获取能力：</h2> 
<p>  soap 的http消息通信，参考代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">UserGetCapabilities</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">soap</span> <span class="token operator">*</span>soap	<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">__wsdd__ProbeMatches</span> <span class="token operator">*</span>resp<span class="token punctuation">,</span>
		<span class="token keyword">struct</span> <span class="token class-name">_tds__GetCapabilities</span> <span class="token operator">*</span>capa_req<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">_tds__GetCapabilitiesResponse</span> <span class="token operator">*</span>capa_resp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    capa_req<span class="token operator">-&gt;</span>Category <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">tt__CapabilityCategory</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">soap_malloc</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    capa_req<span class="token operator">-&gt;</span>__sizeCategory <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>capa_req<span class="token operator">-&gt;</span>Category<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">tt__CapabilityCategory</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tt__CapabilityCategory__Media<span class="token punctuation">)</span><span class="token punctuation">;</span>

    capa_resp<span class="token operator">-&gt;</span>Capabilities <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tt__Capabilities</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">soap_malloc</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tt__Capabilities</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>

	<span class="token function">soap_wsse_add_UsernameTokenDigest</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span><span class="token string">"user"</span><span class="token punctuation">,</span> ONVIF_USER<span class="token punctuation">,</span> ONVIF_PASSWORD<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n--------------------Now Gettting Capabilities NOW --------------------\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">soap_call___tds__GetCapabilities</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span> resp<span class="token operator">-&gt;</span>wsdd__ProbeMatches<span class="token operator">-&gt;</span>ProbeMatch<span class="token operator">-&gt;</span>XAddrs<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> capa_req<span class="token punctuation">,</span> capa_resp<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>soap<span class="token operator">-&gt;</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%s][%d]---&gt;&gt;&gt; soap error: %d, %s, %s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> soap<span class="token operator">-&gt;</span>error<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">soap_faultcode</span><span class="token punctuation">(</span>soap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">soap_faultstring</span><span class="token punctuation">(</span>soap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> retval <span class="token operator">=</span> soap<span class="token operator">-&gt;</span>error<span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" \n--------------------GetCapabilities  OK! result=%d--------------\n \n"</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>capa_resp<span class="token operator">-&gt;</span>Capabilities<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" GetCapabilities  failed!  result=%d \n"</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>

            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" Media-&gt;XAddr=%s \n"</span><span class="token punctuation">,</span> capa_resp<span class="token operator">-&gt;</span>Capabilities<span class="token operator">-&gt;</span>Media<span class="token operator">-&gt;</span>XAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="Profile_183"></a>获取媒体信息Profile：</h2> 
<p>  soap 的http消息通信，参考代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">UserGetProfiles</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">soap</span> <span class="token operator">*</span>soap<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">_trt__GetProfiles</span> <span class="token operator">*</span>trt__GetProfiles<span class="token punctuation">,</span>
		<span class="token keyword">struct</span> <span class="token class-name">_trt__GetProfilesResponse</span> <span class="token operator">*</span>trt__GetProfilesResponse <span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">_tds__GetCapabilitiesResponse</span> <span class="token operator">*</span>capa_resp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> result<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n-------------------Getting Onvif Devices Profiles--------------\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">soap_wsse_add_UsernameTokenDigest</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span><span class="token string">"user"</span><span class="token punctuation">,</span> ONVIF_USER<span class="token punctuation">,</span> ONVIF_PASSWORD<span class="token punctuation">)</span><span class="token punctuation">;</span>
	result <span class="token operator">=</span> <span class="token function">soap_call___trt__GetProfiles</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span> capa_resp<span class="token operator">-&gt;</span>Capabilities<span class="token operator">-&gt;</span>Media<span class="token operator">-&gt;</span>XAddr<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> trt__GetProfiles<span class="token punctuation">,</span> trt__GetProfilesResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token comment">//NOTE: it may be regular if result isn't SOAP_OK.Because some attributes aren't supported by server.</span>
	<span class="token comment">//any question email leoluopy@gmail.com</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"soap error: %d, %s, %s\n"</span><span class="token punctuation">,</span> soap<span class="token operator">-&gt;</span>error<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">soap_faultcode</span><span class="token punctuation">(</span>soap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">soap_faultstring</span><span class="token punctuation">(</span>soap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result <span class="token operator">=</span> soap<span class="token operator">-&gt;</span>error<span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n-------------------Profiles Get OK--------------\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>trt__GetProfilesResponse<span class="token operator">-&gt;</span>Profiles<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>trt__GetProfilesResponse<span class="token operator">-&gt;</span>Profiles<span class="token operator">-&gt;</span>Name<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Profiles Name:%s  \n"</span><span class="token punctuation">,</span>trt__GetProfilesResponse<span class="token operator">-&gt;</span>Profiles<span class="token operator">-&gt;</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>trt__GetProfilesResponse<span class="token operator">-&gt;</span>Profiles<span class="token operator">-&gt;</span>token<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Profiles Taken:%s\n"</span><span class="token punctuation">,</span>trt__GetProfilesResponse<span class="token operator">-&gt;</span>Profiles<span class="token operator">-&gt;</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Profiles Get inner Error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Profiles Get Procedure over\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="RTSPURI_223"></a>获取RTSP的URI：</h2> 
<p>  soap 的http消息通信，参考代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">UserGetUri</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">soap</span> <span class="token operator">*</span>soap<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">_trt__GetStreamUri</span> <span class="token operator">*</span>trt__GetStreamUri<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">_trt__GetStreamUriResponse</span> <span class="token operator">*</span>trt__GetStreamUriResponse<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">_trt__GetProfilesResponse</span> <span class="token operator">*</span>trt__GetProfilesResponse<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">_tds__GetCapabilitiesResponse</span> <span class="token operator">*</span>capa_resp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> result<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">;</span>
	trt__GetStreamUri<span class="token operator">-&gt;</span>StreamSetup <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tt__StreamSetup</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">soap_malloc</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tt__StreamSetup</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化，分配空间</span>
	trt__GetStreamUri<span class="token operator">-&gt;</span>StreamSetup<span class="token operator">-&gt;</span>Stream <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//stream type</span>

	trt__GetStreamUri<span class="token operator">-&gt;</span>StreamSetup<span class="token operator">-&gt;</span>Transport <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tt__Transport</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">soap_malloc</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tt__Transport</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化，分配空间</span>
	trt__GetStreamUri<span class="token operator">-&gt;</span>StreamSetup<span class="token operator">-&gt;</span>Transport<span class="token operator">-&gt;</span>Protocol <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	trt__GetStreamUri<span class="token operator">-&gt;</span>StreamSetup<span class="token operator">-&gt;</span>Transport<span class="token operator">-&gt;</span>Tunnel <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	trt__GetStreamUri<span class="token operator">-&gt;</span>StreamSetup<span class="token operator">-&gt;</span>__size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	trt__GetStreamUri<span class="token operator">-&gt;</span>StreamSetup<span class="token operator">-&gt;</span>__any <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	trt__GetStreamUri<span class="token operator">-&gt;</span>StreamSetup<span class="token operator">-&gt;</span>__anyAttribute <span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>


	trt__GetStreamUri<span class="token operator">-&gt;</span>ProfileToken <span class="token operator">=</span> trt__GetProfilesResponse<span class="token operator">-&gt;</span>Profiles<span class="token operator">-&gt;</span>token <span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\n---------------Getting Uri----------------\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">soap_wsse_add_UsernameTokenDigest</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span><span class="token string">"user"</span><span class="token punctuation">,</span> ONVIF_USER<span class="token punctuation">,</span> ONVIF_PASSWORD<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">soap_call___trt__GetStreamUri</span><span class="token punctuation">(</span>soap<span class="token punctuation">,</span> capa_resp<span class="token operator">-&gt;</span>Capabilities<span class="token operator">-&gt;</span>Media<span class="token operator">-&gt;</span>XAddr<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> trt__GetStreamUri<span class="token punctuation">,</span> trt__GetStreamUriResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token keyword">if</span> <span class="token punctuation">(</span>soap<span class="token operator">-&gt;</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"soap error: %d, %s, %s\n"</span><span class="token punctuation">,</span> soap<span class="token operator">-&gt;</span>error<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">soap_faultcode</span><span class="token punctuation">(</span>soap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">soap_faultstring</span><span class="token punctuation">(</span>soap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	result <span class="token operator">=</span> soap<span class="token operator">-&gt;</span>error<span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
	<span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"!!!!NOTE: RTSP Addr Get Done is :%s \n"</span><span class="token punctuation">,</span>trt__GetStreamUriResponse<span class="token operator">-&gt;</span>MediaUri<span class="token operator">-&gt;</span>Uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  最后贴一个终端截图：<br> <img src="https://images2.imgbox.com/46/bb/tv2srnC1_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_260"></a>开发注意事项：（必读）</h2> 
<p>  soap通信的命名空间如果错误则不能检索到设备：编译好的wsdd.nsmap文件需要修改命名空间，如下：</p> 
<p>  如果要正常开发，被检索到，或者发现其他设备需要nsmap修改如下：1.1换1.2</p> 
<p>以下命名空间表示SOAP1.1版本：</p> 
<p>{“SOAP-ENV”, “http://schemas.xmlsoap.org/soap/envelope/”, “http://www.w3.org/*/soap-envelope”, NULL},</p> 
<p>{“SOAP-ENC”, “http://schemas.xmlsoap.org/soap/encoding/”, “http://www.w3.org/*/soap-encoding”, NULL}, //1.1</p> 
<p>以下命名空间表示SOAP1.2版本：</p> 
<p>{“SOAP-ENV”, “http://www.w3.org/2003/05/soap-envelope”, “http://schemas.xmlsoap.org/soap/envelope/”, NULL},</p> 
<p>{“SOAP-ENC”, “http://www.w3.org/2003/05/soap-encoding”, “http://schemas.xmlsoap.org/soap/encoding/”, NULL}, //1.2</p> 
<h2><a id="_278"></a>另外存在的客户端搜索不到设备情况：</h2> 
<ol><li>是否有vpn，存在的话，本机IP会产生变化导致不能搜到？抓包可以看到，3702端口包的数据源地址改变。</li><li>uuid是否已经赋值。</li><li>有时，windows宿主机装有虚拟机，也可能造成onvif客户端的ip获取错误。故搜索不到。</li></ol> 
<p>  这些问题，在交换机或者路由支持本地局域网跨网段数据UDP交互时，均不会产生。</p> 
<h2><a id="_285"></a>调试技巧：</h2> 
<p>  fsend / frecv 打印出发送和接收到的报文。使用xml编辑器分析。当然也可以直接用浏览器看。<br>   <font color="0x0000ff"><strong>1、打开onvif调试开关，以便让onvif打印一些可用的调试信息。</strong></font><br>   在Makefile中添加调试宏定义如: CC = gcc -DDEBUG</p> 
<p>  <font color="0x0000ff"><strong>2、打开调试宏后，默认在程序运行的目录产生三个文件：</strong></font></p> 
<ul><li><strong>RECV.log</strong>是onvif接收到的SOAP数据，没接收一条，都会在RECV.log中记录</li><li><strong>SENT.log</strong>是onvif发送出去的SOAP数据，没发送一套，也会在SENT.log中生成记录</li><li><strong>TEST.log</strong>，如果说RECV和SENT可以用wireshark工具抓包代替，那么TEST.log是谁也替代不了的，TEST.log记录了onvif的实时的工作状态。</li></ul> 
<p>  尤其当出现segmentation fault错误，TEST.log就成了唯一一个能够定位到具体内存出错的地方了。</p> 
<h2><a id="SOAP_TYPEsoaperror4_296"></a>SOAP_TYPE返回soap-&gt;error=4的错误说明</h2> 
<p>  关于数据正确（抓包可收到数据），但soap返回错误，为4及SOAP_TYPE的问题：GetCapabilities的过程错误时。<br>   多次调试后得出结论，是tt__CapabilityCategory 的设置问题，有的设备不具备全部功能，而请求全部或请求没有的功能就可能造成这种问题，推荐写5（tt__CapabilityCategory__Media） 这是大多数设置有的能力，而且最常用。</p> 
<p>GetProfile时错误：<br>    其实数据在抓包过程中也能完全抓到，多次调试后，发现结构体需要的Name以及token关键字被赋值。其他的没有，说明本点返回与服务器的支持性有很大关系。及，开发过程中需要对应自己的需求，根据实际的需要和返回错误，读取返回结构体数据。</p> 
<h2><a id="_302"></a>资源：</h2> 
<p>  ONVIFDEVICEMANAGER下载地址：<a href="http://pan.baidu.com/share/link?shareid=1967805400&amp;uk=70662920&amp;fid=3981296515" rel="nofollow">http://pan.baidu.com/share/link?shareid=1967805400&amp;uk=70662920&amp;fid=3981296515</a><br>   ONVIFTESTTOOL下载地址：<a href="http://www.cr173.com/soft/66448.html" rel="nofollow">http://www.cr173.com/soft/66448.html</a><br>   官网开发者向导资料下载地址：<a href="http://www.onvif.org/Resources/WhitePapers.aspx" rel="nofollow">http://www.onvif.org/Resources/WhitePapers.aspx</a></p> 
<h2><a id="_306"></a>参考文章：</h2> 
<p>  onvif规范的实现：使用gSOAP创建SOAP调用实例<a href="http://blog.csdn.net/ghostyu/article/details/8162280">http://blog.csdn.net/ghostyu/article/details/8162280</a><br>   Onvif开发之服务端成功对接Rtsp视频流篇<a href="http://blog.csdn.net/max_min_go/article/details/17964643">http://blog.csdn.net/max_min_go/article/details/17964643</a><br>   linux设备上的Onvif 实现10：获取支持通道的RTSP地址<a href="http://gaohtao.blog.163.com/blog/static/58241823201381113214599/" rel="nofollow">http://gaohtao.blog.163.com/blog/static/58241823201381113214599/</a><br>   Onvif开发之客户端鉴权获取参数篇<a href="http://blog.csdn.net/max_min_go/article/details/17617057">http://blog.csdn.net/max_min_go/article/details/17617057</a><br>   ONVIF协议开发资源<a href="http://www.csdn.net/tag/onvif%252520%2525E5%25258D%25258F%2525E8%2525AE%2525AE">http://www.csdn.net/tag/onvif%252520%2525E5%25258D%25258F%2525E8%2525AE%2525AE</a><br>   onvif开发之设备发现功能的实现<a href="https://blog.csdn.net/love_xjhu/article/details/11821037">https://blog.csdn.net/love_xjhu/article/details/11821037</a><br>   Linux设备上的Onvif实现16：实现Onvif鉴权<a href="http://blog.csdn.net/u012084827/article/details/19031969">http://blog.csdn.net/u012084827/article/details/19031969</a><br>   Onvif开发之Linux下gsoap的使用及移植<a href="http://blog.csdn.net/love_xjhu/article/details/9772361">http://blog.csdn.net/love_xjhu/article/details/9772361</a><br>   onvif开发总结<a href="http://blog.csdn.net/zsl461975543/article/details/8971143">http://blog.csdn.net/zsl461975543/article/details/8971143</a><br>   代码框架生成之Onvif开发<a href="http://www.yc-edu.org/C__peixun/6655.html" rel="nofollow">http://www.yc-edu.org/C__peixun/6655.html</a><br>   linux设备上的Onvif 实现4：成功编译gsoap 2.8.15<a href="http://blog.csdn.net/u012084827/article/details/12202133">http://blog.csdn.net/u012084827/article/details/12202133</a><br>   onvif规范的实现：onvif开发常用调试方法 和常见的segmentation fault错误<a href="http://blog.csdn.net/ghostyu/article/details/8432760">http://blog.csdn.net/ghostyu/article/details/8432760</a><br>   linux设备上的Onvif 实现6：获取摄像头的流媒体地址完整流程<a href="http://blog.csdn.net/u012084827/article/details/12201997">http://blog.csdn.net/u012084827/article/details/12201997</a><br>   S​O​A​P​ ​错​误​代​码​表<a href="http://wenku.baidu.com/link?url=rujSmnpjBxjS3mGZrejoVVOShcPu_5Wu_9RKrQ6qWCB12xrZUvVoFkYRepLu0y6oTk6-bB5AnJ_7KxF6s8rXcb1BFko6DbBpXg0_7G0D7cu" rel="nofollow">http://wenku.baidu.com/link?url=rujSmnpjBxjS3mGZrejoVVOShcPu_5Wu_9RKrQ6qWCB12xrZUvVoFkYRepLu0y6oTk6-bB5AnJ_7KxF6s8rXcb1BFko6DbBpXg0_7G0D7cu</a><br>   linux设备上的Onvif 实现8：编写媒体信息获取程序<a href="http://blog.csdn.net/u012084827/article/details/12201897">http://blog.csdn.net/u012084827/article/details/12201897</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/93925e96ed5a558c615923ba99440c94/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue中生成二维码的两种用法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3457638b7da3a6f244c72f2de872d79c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">sftp方式下载、上传、删除</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>