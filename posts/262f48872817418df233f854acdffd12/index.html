<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux设备树 01 ———— 内核笔记 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux设备树 01 ———— 内核笔记" />
<meta property="og:description" content="活动地址：CSDN21天学习挑战赛
本周： 2022-08-01——2202-08-07
计划： 完成 Linux设备树和Pinctrl 的学习
个人的状况：本人现已经大学毕业（2022届毕业生），有过3个多月的实习经历，实习期间主要做的事android 的BSP移植，目前主要工作是做驱动的移植，所以对本节学习的内容是有一定的基础的。
Linux设备树和Pinctrl 一、Linux设备树1.1 Linux设备树概述1.2 设备树1 、dts/dtsi2、dtc3、dtb 1.3 设备树语法1、框架2、设备节点3. 设备节点的标准属性compatible 属性Status 属性![在这里插入图片描述](https://img-blog.csdnimg.cn/77271cdfba8e4906b0c015c31eb23373.png)address-cells、#size-cells和reg (寻址属性)ranges 属性（地址翻译）别名节点和 根节点 4、设备和驱动的匹配方式5、imx415 sensor为实例 本专题的学习：CSDN21天学习挑战赛
1、Linux设备树和Pinctrl
一、Linux设备树 1.1 Linux设备树概述 1、设备树是什么
2、引入设备树的作用
3、什么样的硬件可以用设备树来描述
4、原始硬件信息（没采用设备树的时候）
设备树我把把它理解为对硬件的描述 简化了代码块量 采用了设备树之后，许多硬件的细节可以直接通过它传递给Linux， 而不再需要在内核中进行大量的冗余编码,它通过bootloader将硬件资源传给内核， 使得内核和硬件资源描述相对独立 CPU的数量和类别 内存基地址和大小 总线和桥 外设连接 中断控制器和中断使用情况 GPIO控制器和GPIO使用情况 Clock控制器和Clock使用情况 补充： 设备树对于可热插拔的热备不进行具体描述，它只描述用于控制该热插拔设备的控制器 注：
官网对设备树的描述：
https://www.kernel.org/doc/Documentation/devicetree/usage-model.txt
1.2 设备树 设备树的主要优势：
对于同一SOC的不同主板，只需更换设备树文件.dtb或者.dtbo文件即可实现不同主板的无差异支持，而无需更换内核文件，实现了内核和不同板级硬件数据的拆分。
设备树：
DTC （device tree compiler） DTS/DTSI （device tree source） DTB	（device tree blob） 三者的关系：
dts和dtsi源文件会经过dtc编译器编译成dtb二进制文件，dtb文件最后会被放到系统中被内核解析" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/262f48872817418df233f854acdffd12/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-02T20:04:43+08:00" />
<meta property="article:modified_time" content="2022-08-02T20:04:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux设备树 01 ———— 内核笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>活动地址：<a href="https://marketing.csdn.net/p/bdabfb52c5d56532133df2adc1a728fd">CSDN21天学习挑战赛</a></p> 
</blockquote> 
<p><strong>本周</strong>： 2022-08-01——2202-08-07<br> <strong>计划</strong>： 完成 Linux设备树和Pinctrl 的学习<br> <strong>个人的状况</strong>：本人现已经大学毕业（2022届毕业生），有过3个多月的实习经历，实习期间主要做的事android 的BSP移植，目前主要工作是做驱动的移植，所以对本节学习的内容是有一定的基础的。</p> 
<p></p> 
<div class="toc"> 
 <h4>Linux设备树和Pinctrl</h4> 
 <ul><li><ul><li><a href="#Linux_12" rel="nofollow">一、Linux设备树</a></li><li><ul><li><a href="#11_Linux_13" rel="nofollow">1.1 Linux设备树概述</a></li><li><a href="#12__54" rel="nofollow">1.2 设备树</a></li><li><ul><li><a href="#1_dtsdtsi_70" rel="nofollow">1 、dts/dtsi</a></li><li><a href="#2dtc_83" rel="nofollow">2、dtc</a></li><li><a href="#3dtb_86" rel="nofollow">3、dtb</a></li></ul> 
    </li><li><a href="#13__91" rel="nofollow">1.3 设备树语法</a></li><li><ul><li><a href="#1_93" rel="nofollow">1、框架</a></li><li><a href="#2_112" rel="nofollow">2、设备节点</a></li><li><a href="#3__121" rel="nofollow">3. 设备节点的标准属性</a></li><li><ul><li><a href="#compatible__122" rel="nofollow">compatible 属性</a></li><li><a href="#Status_httpsimgblogcsdnimgcn77271cdfba8e4906b0c015c31eb23373png_128" rel="nofollow">Status 属性![在这里插入图片描述](https://img-blog.csdnimg.cn/77271cdfba8e4906b0c015c31eb23373.png)</a></li><li><a href="#addresscellssizecellsreg___129" rel="nofollow">address-cells、#size-cells和reg (寻址属性)</a></li><li><a href="#ranges__136" rel="nofollow">ranges 属性（地址翻译）</a></li><li><a href="#__147" rel="nofollow">别名节点和 根节点</a></li></ul> 
     </li><li><a href="#4_153" rel="nofollow">4、设备和驱动的匹配方式</a></li><li><a href="#5imx415_sensor_163" rel="nofollow">5、imx415 sensor为实例</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>本专题的学习：CSDN21天学习挑战赛<br> 1、Linux设备树和Pinctrl</p> 
<h3><a id="Linux_12"></a>一、Linux设备树</h3> 
<h4><a id="11_Linux_13"></a>1.1 Linux设备树概述</h4> 
<p>1、设备树是什么<br> 2、引入设备树的作用<br> 3、什么样的硬件可以用设备树来描述<br> 4、原始硬件信息（没采用设备树的时候）</p> 
<pre><code class="prism language-bash">设备树我把把它理解为对硬件的描述
</code></pre> 
<pre><code class="prism language-bash">简化了代码块量
采用了设备树之后，许多硬件的细节可以直接通过它传递给Linux，
而不再需要在内核中进行大量的冗余编码,它通过bootloader将硬件资源传给内核，
使得内核和硬件资源描述相对独立
</code></pre> 
<pre><code class="prism language-bash">CPU的数量和类别

内存基地址和大小

总线和桥

外设连接

中断控制器和中断使用情况

GPIO控制器和GPIO使用情况

Clock控制器和Clock使用情况

补充：

设备树对于可热插拔的热备不进行具体描述，它只描述用于控制该热插拔设备的控制器

</code></pre> 
<p><img src="https://images2.imgbox.com/5e/0b/GdTC2MoQ_o.png" alt="在这里插入图片描述"><br> 注：<br> 官网对设备树的描述：<br> https://www.kernel.org/doc/Documentation/devicetree/usage-model.txt</p> 
<h4><a id="12__54"></a>1.2 设备树</h4> 
<p><strong>设备树的主要优势</strong>：<br> 对于同一SOC的不同主板，只需更换设备树文件.dtb或者.dtbo文件即可实现不同主板的无差异支持，而无需更换内核文件，实现了内核和不同板级硬件数据的拆分。</p> 
<p><strong>设备树</strong>：</p> 
<pre><code class="prism language-bash">DTC  	（device tree compiler）
DTS/DTSI  	（device tree source）
DTB		（device tree blob）
</code></pre> 
<p><strong>三者的关系</strong>：<br> <img src="https://images2.imgbox.com/e2/74/8DnDYXXA_o.png" alt="在这里插入图片描述"><br> dts和dtsi源文件会经过dtc编译器编译成dtb二进制文件，dtb文件最后会被放到系统中被内核解析<br> 例如：<br> <img src="https://images2.imgbox.com/71/2e/A5eJAGgX_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="1_dtsdtsi_70"></a>1 、dts/dtsi</h5> 
<blockquote> 
 <p>DTS： .dts文件是设备树的源文件。<br> 文件.dts是一种ASCII文本格式的设备树描述 ，<br> 一个.dts文件对应一个ARM的设备，<br> 一般放置在内核的arch/arm/boot/dts/目录中</p> 
</blockquote> 
<p>DTSI：<br> 由于一个SoC可能对应多个设备（一个SoC可以对应多个产品和电路板），<br> 这些.dts文件势必须包含许多共同的部分，Linux内核为了简化，<br> 把<code>SoC公用的部分或者多个设备共同的部分一般提炼为.dtsi</code>，<br> 类似于C语言的头文件。其他的设备对应的.dts就包括这个.dtsi</p> 
<h5><a id="2dtc_83"></a>2、dtc</h5> 
<p>不深入了解的话，就是一个编译器</p> 
<h5><a id="3dtb_86"></a>3、dtb</h5> 
<p>.dtb文件是 .dts 被 DTC 编译后的二进制格式的设备树文件，它由<code>Linux内核解析</code>，也可以被<code>bootloader进行解析</code>。通常在我们为电路板制作NAND、SD启动映像时，会为<code>.dtb文件单独留</code>下一个很小的<code>区域</code>以存放之，之后<code>bootloader在引导内核的过程中</code>，会先读取该.dtb到内存。</p> 
<p><img src="https://images2.imgbox.com/d6/ae/gNROrDTW_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="13__91"></a>1.3 设备树语法</h4> 
<h5><a id="1_93"></a>1、框架</h5> 
<p>设备树用树状结构描述设备信息，它有以下几种特性：</p> 
<ul><li>每个设备树文件都有一个根节点，每个设备都是一个节点。</li><li>节点间可以嵌套，形成父子关系，这样就可以方便的描述设备间的关系。</li><li>每个设备的属性都用一组key-value对(键值对)来描述。</li><li>每个属性的描述用‘ ; ’结束</li></ul> 
<pre><code class="prism language-bash">DeviceTree的结构非常简单，由两种元素组成：
Node<span class="token punctuation">(</span>节点<span class="token punctuation">)</span>
Property<span class="token punctuation">(</span>属性<span class="token punctuation">)</span>

<span class="token punctuation">[</span>label:<span class="token punctuation">]</span> node-name<span class="token punctuation">[</span>@unit-address<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span>properties definitions<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>child nodes<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9c/1b/YQ7AsCBl_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2_112"></a>2、设备节点</h5> 
<p>在设备树中节点命名格式如下：</p> 
<blockquote> 
 <p>node-name@unit-address</p> 
 <p>node-name： 是设备节点的名称，为ASCII字符串，节点名字应该能够清晰的描述出节点的功能</p> 
 <p>unit-address： 一般表示设备的地址或寄存器首地址，如果某个节点没有地址或者寄存器的话 “unit-address” 可以不要</p> 
</blockquote> 
<h5><a id="3__121"></a>3. 设备节点的标准属性</h5> 
<h6><a id="compatible__122"></a>compatible 属性</h6> 
<blockquote> 
 <p>compatible 属性也叫做 “兼容性” 属性，这是非常重要的一个属性！<br> compatible 属性的值是一个字符串列表， compatible 属性用于将设备和驱动绑定起来。字符串列表用于选择设备所要使用的驱动程序。<br> compatible 属性值的推荐格式： “manufacturer , model ”<br> ① manufacturer : 表示厂商；② model : 一般是模块对应的驱动名字。</p> 
</blockquote> 
<h6><a id="Status_httpsimgblogcsdnimgcn77271cdfba8e4906b0c015c31eb23373png_128"></a>Status 属性<img src="https://images2.imgbox.com/74/2f/h1npPKfF_o.png" alt="在这里插入图片描述"></h6> 
<h6><a id="addresscellssizecellsreg___129"></a>address-cells、#size-cells和reg (寻址属性)</h6> 
<p>reg 属性的值一般是 <code>(address， length)</code> 对，reg 属性一般用于描述设备地址空间资源信息，一般都是某个外设的寄存器地址范围信息。<br> #address-cells 和 #size-cells的值都是<code>无符号 32 位整型</code>，可以用在任何拥有子节点的设备中，用于描述子节点的地址信息。<br> #address-cells 属性值决定了子节点 reg 属性中<code>地址</code>信息所占用的字长(32 位)， #size-cells 属性值决定了子节点 reg 属性中<code>长度</code>信息所占的字长(32 位)。<br> #address-cells 和 #size-cells 表明了子节点应该如何编写 reg 属性值，一般 reg 属性都是和地址有关的内容，和地址相关的信息有两种：<code>起始地址和地址长度</code><br> <img src="https://images2.imgbox.com/a9/13/QaKqdaVf_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="ranges__136"></a>ranges 属性（地址翻译）</h6> 
<p>ranges属性值可以为空或者按照 (child-bus-address,parent-bus-address,length) 格式编写的数字矩阵， ranges 是一个地址映射/转换表， ranges 属性每个项目由<code>子地址、父地址和地址空间长度</code>这三部分组成：</p> 
<ul><li>child-bus-address： 子总线地址空间的物理地址，由父节点的 #address-cells 确定此物理地址所占用的字长。</li><li>parent-bus-address： 父总线地址空间的物理地址，同样由父节点的 #address-cells<br> 确定此物理地址所占用的字长。</li><li>length： 子地址空间的长度，由父节点的 #size-cells 确定此地址长度所占用的字长。<br> <img src="https://images2.imgbox.com/f7/3f/a7SN3M0F_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1d/32/qHDMVh0e_o.png" alt="在这里插入图片描述"></li></ul> 
<h6><a id="__147"></a>别名节点和 根节点</h6> 
<p>每个设备树文件只有<code>一个根节点</code>，其他所有的设备节点都是它的子节点，它的路径是 /。根节点有以下属性：<br> <img src="https://images2.imgbox.com/fd/c0/22oc0hGH_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/02/fa/72U0Uk4J_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="4_153"></a>4、设备和驱动的匹配方式</h5> 
<blockquote> 
 <p>当设置driver_override时，只绑定匹配的驱动<br> OF 匹配<br> ACPI 匹配<br> id 表匹配<br> 驱动名字匹配</p> 
</blockquote> 
<p>匹配成功之后进入 probe 函数</p> 
<h5><a id="5imx415_sensor_163"></a>5、imx415 sensor为实例</h5> 
<pre><code class="prism language-bash"><span class="token operator">&amp;</span>i2c1 <span class="token punctuation">{<!-- --></span>  //i2c设备
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
	clock-frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">40000</span><span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">;</span> //时钟频率

	imx415: imx415@1a <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"sony,imx415"</span><span class="token punctuation">;</span> //需要与驱动中的匹配字符串一致
		reg <span class="token operator">=</span> <span class="token operator">&lt;</span>0x1a<span class="token operator">&gt;</span><span class="token punctuation">;</span>//寄存器地址，具体可以根据硬件和datasheet（imx415手册）的决定
		clocks <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>cru CLK_MIPICSI_OUT<span class="token operator">&gt;</span><span class="token punctuation">;</span>//sensor clickin配置
		clock-names <span class="token operator">=</span> <span class="token string">"xvclk"</span><span class="token punctuation">;</span>
		
		power-domains <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>power RV1126_PD_VI<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		pinctrl-names <span class="token operator">=</span> <span class="token string">"rockchip,camera_default"</span><span class="token punctuation">;</span>
		pinctrl-0 <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>mipicsi_clk<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">;</span>//pinctl设置
		
		avdd-supply <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>vcc3v3_sys<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		dovdd-supply <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>vcc_1v<span class="token operator"><span class="token file-descriptor important">8</span>&gt;</span><span class="token punctuation">;</span>
		dvdd-supply <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>vcc_dvdd<span class="token operator">&gt;</span><span class="token punctuation">;</span>//供电引脚
		
		//pwd-gpios <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>gpio1 RK_PD4 GPIO_ACTIVE_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		reset-gpios <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>gpio1 RK_PD5 GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span> //复位引脚
		
		rockchip,camera-module-index <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token punctuation">;</span>  模组编号，该编号不要重复
		rockchip,camera-module-facing <span class="token operator">=</span> <span class="token string">"front"</span><span class="token punctuation">;</span>// 模组朝向，有<span class="token string">"back"</span>和<span class="token string">"front"</span>
		rockchip,camera-module-name <span class="token operator">=</span> <span class="token string">"YT10092"</span><span class="token punctuation">;</span>// 模组名
		rockchip,camera-module-lens-name <span class="token operator">=</span> <span class="token string">"IR0147-60IRC-8M-F20"</span><span class="token punctuation">;</span>//<span class="token string">"IR0147-36IRC-8M-F20"</span><span class="token punctuation">;</span>//lens名
		//sensor的效果文件
		
		ir-cut <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>cam_ircut<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">;</span>//ir cut设备
		port <span class="token punctuation">{<!-- --></span>
			ucam_out0: endpoint <span class="token punctuation">{<!-- --></span>
				remote-endpoint <span class="token operator">=</span> <span class="token operator">&lt;&amp;</span>mipi_in_ucam<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token punctuation">;</span> mipi dphy端的port名
				data-lanes <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span><span class="token punctuation">;</span>  mipi lane数，1lane为 <span class="token operator">&lt;</span><span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>, 4lane为 <span class="token operator">&lt;</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>​</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ed387d6865fa7b594de5124f849196a5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【ACWing 算法基础】KMP</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2ab9e48f5dae27818075f64caba5e6d1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Netty粘包拆包、自定义Protostuff编解码器</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>