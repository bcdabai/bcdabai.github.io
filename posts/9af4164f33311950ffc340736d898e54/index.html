<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【大数据】Hive查询、函数 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【大数据】Hive查询、函数" />
<meta property="og:description" content="文章目录 一、查询1. 基础语法2. 基本查询（Select…From）2.1 全表和特定列查询2.2 列别名2.3 Limit语句2.4 Where语句2.5 关系运算函数2.6 逻辑运算函数2.7 聚合函数 3. 分组3.1 Group By语句3.2 Having语句 4. Join语句5.排序5.1 全局排序（Order By）5.2 每个Reduce内部排序（Sort By）5.3 分区（Distribute By）5.4 分区排序（Cluster By） 二、函数1.单行函数1.1 算术运算函数1.2 数值函数1.3 字符串函数1.4 日期函数1.5 流程控制函数 2. 高级聚合函数 一、查询 1. 基础语法 官网地址
查询语句语法：
SELECT [ALL | DISTINCT] select_expr, select_expr, ... FROM table_reference -- 从什么表查 [WHERE where_condition] -- 过滤 [GROUP BY col_list] -- 分组查询 [HAVING col_list] -- 分组后过滤 [ORDER BY col_list] -- 排序 [CLUSTER BY col_list | [DISTRIBUTE BY col_list] [SORT BY col_list] ] [LIMIT number] -- 限制输出的行数 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9af4164f33311950ffc340736d898e54/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-01T13:02:31+08:00" />
<meta property="article:modified_time" content="2023-10-01T13:02:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【大数据】Hive查询、函数</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p></p> 
 <div class="toc"> 
  <h4>文章目录</h4> 
  <ul><li><a href="#_2" rel="nofollow">一、查询</a></li><li><ul><li><a href="#1__3" rel="nofollow">1. 基础语法</a></li><li><a href="#2_SelectFrom_21" rel="nofollow">2. 基本查询（Select…From）</a></li><li><ul><li><a href="#21__83" rel="nofollow">2.1 全表和特定列查询</a></li><li><a href="#22__100" rel="nofollow">2.2 列别名</a></li><li><a href="#23_Limit_111" rel="nofollow">2.3 Limit语句</a></li><li><a href="#24_Where_119" rel="nofollow">2.4 Where语句</a></li><li><a href="#25__129" rel="nofollow">2.5 关系运算函数</a></li><li><a href="#26__146" rel="nofollow">2.6 逻辑运算函数</a></li><li><a href="#27__177" rel="nofollow">2.7 聚合函数</a></li></ul> 
    </li><li><a href="#3__197" rel="nofollow">3. 分组</a></li><li><ul><li><a href="#31_Group_By_198" rel="nofollow">3.1 Group By语句</a></li><li><a href="#32_Having_228" rel="nofollow">3.2 Having语句</a></li></ul> 
    </li><li><a href="#4_Join_250" rel="nofollow">4. Join语句</a></li><li><a href="#5_399" rel="nofollow">5.排序</a></li><li><ul><li><a href="#51_Order_By_400" rel="nofollow">5.1 全局排序（Order By）</a></li><li><a href="#52_ReduceSort_By_420" rel="nofollow">5.2 每个Reduce内部排序（Sort By）</a></li><li><a href="#53_Distribute_By_442" rel="nofollow">5.3 分区（Distribute By）</a></li><li><a href="#54_Cluster_By_466" rel="nofollow">5.4 分区排序（Cluster By）</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_487" rel="nofollow">二、函数</a></li><li><ul><li><a href="#1_506" rel="nofollow">1.单行函数</a></li><li><ul><li><a href="#11__511" rel="nofollow">1.1 算术运算函数</a></li><li><a href="#12__529" rel="nofollow">1.2 数值函数</a></li><li><a href="#13__543" rel="nofollow">1.3 字符串函数</a></li><li><a href="#14__636" rel="nofollow">1.4 日期函数</a></li><li><a href="#15__751" rel="nofollow">1.5 流程控制函数</a></li></ul> 
    </li><li><a href="#2__849" rel="nofollow">2. 高级聚合函数</a></li></ul> 
  </li></ul> 
 </div> 
 <p></p> 
</blockquote> 
<h2><a id="_2"></a>一、查询</h2> 
<h3><a id="1__3"></a>1. 基础语法</h3> 
<p><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Select" rel="nofollow">官网地址</a></p> 
<p>查询语句语法：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token punctuation">[</span><span class="token keyword">ALL</span> <span class="token operator">|</span> <span class="token keyword">DISTINCT</span><span class="token punctuation">]</span> select_expr<span class="token punctuation">,</span> select_expr<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">FROM</span> table_reference       <span class="token comment">-- 从什么表查</span>
  <span class="token punctuation">[</span><span class="token keyword">WHERE</span> where_condition<span class="token punctuation">]</span>   <span class="token comment">-- 过滤</span>
  <span class="token punctuation">[</span><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span>        <span class="token comment">-- 分组查询</span>
   <span class="token punctuation">[</span><span class="token keyword">HAVING</span> col_list<span class="token punctuation">]</span>          <span class="token comment">-- 分组后过滤</span>
  <span class="token punctuation">[</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span>        <span class="token comment">-- 排序</span>
  <span class="token punctuation">[</span>CLUSTER <span class="token keyword">BY</span> col_list
    <span class="token operator">|</span> <span class="token punctuation">[</span>DISTRIBUTE <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span> <span class="token punctuation">[</span>SORT <span class="token keyword">BY</span> col_list<span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
 <span class="token punctuation">[</span><span class="token keyword">LIMIT</span> number<span class="token punctuation">]</span>                <span class="token comment">-- 限制输出的行数</span>
</code></pre> 
<h3><a id="2_SelectFrom_21"></a>2. 基本查询（Select…From）</h3> 
<p>数据准备<br> 在/opt/module/hive/datas/路径上创建dept.txt文件，并赋值如下内容：<br> 部门编号 部门名称 部门位置id</p> 
<pre><code class="prism language-sql">vim dept<span class="token punctuation">.</span>txt

<span class="token number">10</span>	行政部	<span class="token number">1700</span>
<span class="token number">20</span>	财务部	<span class="token number">1800</span>
<span class="token number">30</span>	教学部	<span class="token number">1900</span>
<span class="token number">40</span>	销售部	<span class="token number">1700</span>
</code></pre> 
<p>在/opt/module/hive/datas/路径上创建emp.txt文件，并赋值如下内容：<br> 员工编号 姓名 岗位 薪资 部门</p> 
<pre><code class="prism language-sql">vim emp<span class="token punctuation">.</span>txt

<span class="token number">7369</span>	张三	研发	<span class="token number">800.00</span>	<span class="token number">30</span>
<span class="token number">7499</span>	李四	财务	<span class="token number">1600.00</span>	<span class="token number">20</span>
<span class="token number">7521</span>	王五	行政	<span class="token number">1250.00</span>	<span class="token number">10</span>
<span class="token number">7566</span>	赵六	销售	<span class="token number">2975.00</span>	<span class="token number">40</span>
<span class="token number">7654</span>	侯七	研发	<span class="token number">1250.00</span>	<span class="token number">30</span>
<span class="token number">7698</span>	马八	研发	<span class="token number">2850.00</span>	<span class="token number">30</span>
<span class="token number">7782</span>	金九	\N	<span class="token number">2450.0</span>	<span class="token number">30</span>
<span class="token number">7788</span>	银十	行政	<span class="token number">3000.00</span>	<span class="token number">10</span>
<span class="token number">7839</span>	小芳	销售	<span class="token number">5000.00</span>	<span class="token number">40</span>
<span class="token number">7844</span>	小明	销售	<span class="token number">1500.00</span>	<span class="token number">40</span>
<span class="token number">7876</span>	小李	行政	<span class="token number">1100.00</span>	<span class="token number">10</span>
<span class="token number">7900</span>	小元	讲师	<span class="token number">950.00</span>	<span class="token number">30</span>
<span class="token number">7902</span>	小海	行政	<span class="token number">3000.00</span>	<span class="token number">10</span>
<span class="token number">7934</span>	小红明	讲师	<span class="token number">1300.00</span>	<span class="token number">30</span>
</code></pre> 
<p>创建表</p> 
<pre><code class="prism language-sql"><span class="token comment">--创建部门表</span>
hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> dept<span class="token punctuation">(</span>
    deptno <span class="token keyword">int</span><span class="token punctuation">,</span>    <span class="token comment">-- 部门编号</span>
    dname string<span class="token punctuation">,</span>  <span class="token comment">-- 部门名称</span>
    loc <span class="token keyword">int</span>        <span class="token comment">-- 部门位置</span>
<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>
<span class="token comment">--创建员工表</span>
hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> emp<span class="token punctuation">(</span>
    empno <span class="token keyword">int</span><span class="token punctuation">,</span>      <span class="token comment">-- 员工编号</span>
    ename string<span class="token punctuation">,</span>   <span class="token comment">-- 员工姓名</span>
    job string<span class="token punctuation">,</span>     <span class="token comment">-- 员工岗位（大数据工程师、前端工程师、java工程师）</span>
    sal <span class="token keyword">double</span><span class="token punctuation">,</span>     <span class="token comment">-- 员工薪资</span>
    deptno <span class="token keyword">int</span>      <span class="token comment">-- 部门编号</span>
<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>
<span class="token comment">--导入数据</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/opt/module/hive/datas/dept.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> dept<span class="token punctuation">;</span>
<span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/opt/module/hive/datas/emp.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> emp<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="21__83"></a>2.1 全表和特定列查询</h4> 
<pre><code class="prism language-sql"><span class="token comment">--全表查询</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>

<span class="token comment">--选择特定列查询</span>
<span class="token keyword">select</span> empno<span class="token punctuation">,</span> ename <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>注意：<br> （1）SQL语言大小写不敏感。<br> （2）SQL可以写在一行或者多行。<br> （3）关键字不能被缩写也不能分行。<br> （4）各子句一般要分行写。<br> （5）使用缩进提高语句的可读性。</p> 
</blockquote> 
<h4><a id="22__100"></a>2.2 列别名</h4> 
<p>重命名一个列便于计算，紧跟列名，也可以在列名和别名之间加入关键字‘AS’</p> 
<pre><code class="prism language-sql"><span class="token comment">--查询名称和部门。</span>
<span class="token keyword">select</span> 
    ename <span class="token keyword">AS</span> name<span class="token punctuation">,</span> 
    deptno dn 
<span class="token keyword">from</span> emp<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="23_Limit_111"></a>2.3 Limit语句</h4> 
<p>典型的查询会返回多行数据。limit子句用于限制返回的行数。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">limit</span> <span class="token number">5</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">-- 表示从第2行开始，向下抓取3行</span>
</code></pre> 
<h4><a id="24_Where_119"></a>2.4 Where语句</h4> 
<p>使用where子句，将不满足条件的行过滤掉。where子句紧随from子句</p> 
<pre><code class="prism language-sql"><span class="token comment">--查询出薪水大于1000的所有员工。</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> sal <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>注意：where子句中不能使用字段别名。</p> 
</blockquote> 
<h4><a id="25__129"></a>2.5 关系运算函数</h4> 
<p>如下操作符主要用于where和having语句中。</p> 
<table><thead><tr><th>操作符</th><th>支持的数据类型</th><th>描述</th></tr></thead><tbody><tr><td>A=B</td><td>基本数据类型</td><td>如果A等于B则返回true，反之返回false</td></tr><tr><td>A&lt;=&gt;B</td><td>基本数据类型</td><td>如果A和B都为null或者都不为null，则返回true，如果只有一边为null，返回false</td></tr><tr><td>A&lt;&gt;B, A!=B</td><td>基本数据类型</td><td>A或者B为null则返回null；如果A不等于B，则返回true，反之返回false</td></tr><tr><td>A&lt;B</td><td>基本数据类型</td><td>A或者B为null，则返回null；如果A小于B，则返回true，反之返回false</td></tr><tr><td>A&lt;=B</td><td>基本数据类型</td><td>A或者B为null，则返回null；如果A小于等于B，则返回true，反之返回false</td></tr><tr><td>A&gt;B</td><td>基本数据类型</td><td>A或者B为null，则返回null；如果A大于B，则返回true，反之返回false</td></tr><tr><td>A&gt;=B</td><td>基本数据类型</td><td>A或者B为null，则返回null；如果A大于等于B，则返回true，反之返回false</td></tr><tr><td>A [not] between B and C</td><td>基本数据类型</td><td>如果A，B或者C任一为null，则结果为null。如果A的值大于等于B而且小于或等于C，则结果为true，反之为false。如果使用not关键字则可达到相反的效果。</td></tr><tr><td>A is null</td><td>所有数据类型</td><td>如果A等于null，则返回true，反之返回false</td></tr><tr><td>A is not null</td><td>所有数据类型</td><td>如果A不等于null，则返回true，反之返回false</td></tr><tr><td>in（数值1，数值2）</td><td>所有数据类型</td><td>使用 in运算显示列表中的值</td></tr><tr><td>A [not] like B</td><td>string 类型</td><td>B是一个SQL下的简单正则表达式，也叫通配符模式，如果A与其匹配的话，则返回true；反之返回false。B的表达式说明如下：‘x%’表示A必须以字母‘x’开头，‘%x’表示A必须以字母‘x’结尾，而‘%x%’表示A包含有字母‘x’,可以位于开头，结尾或者字符串中间。如果使用not关键字则可达到相反的效果。</td></tr><tr><td>A rlike B, A regexp B</td><td>string 类型</td><td>B是基于java的正则表达式，如果A与其匹配，则返回true；反之返回false。匹配使用的是JDK中的正则表达式接口实现的，因为正则也依据其中的规则。例如，正则表达式必须和整个字符串A相匹配，而不是只需与其字符串匹配。</td></tr></tbody></table> 
<h4><a id="26__146"></a>2.6 逻辑运算函数</h4> 
<p>（1）基本语法（and/or/not）</p> 
<table><thead><tr><th>操作符</th><th>含义</th></tr></thead><tbody><tr><td>and</td><td>逻辑并</td></tr><tr><td>or</td><td>逻辑或</td></tr><tr><td>not</td><td>逻辑否</td></tr></tbody></table> 
<p>（2）案例实操</p> 
<pre><code class="prism language-sql"><span class="token comment">--查询薪水大于1000，部门是30</span>
<span class="token keyword">select</span> 
    <span class="token operator">*</span> 
<span class="token keyword">from</span> emp 
<span class="token keyword">where</span> sal <span class="token operator">&gt;</span> <span class="token number">1000</span> <span class="token operator">and</span> deptno <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>

<span class="token comment">--查询薪水大于1000，或者部门是30</span>
<span class="token keyword">select</span> 
    <span class="token operator">*</span> 
<span class="token keyword">from</span> emp 
<span class="token keyword">where</span> sal<span class="token operator">&gt;</span><span class="token number">1000</span> <span class="token operator">or</span> deptno<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">;</span>

<span class="token comment">--查询除了20部门和30部门以外的员工信息</span>
hive <span class="token punctuation">(</span><span class="token keyword">default</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> 
<span class="token keyword">select</span> 
    <span class="token operator">*</span> 
<span class="token keyword">from</span> emp 
<span class="token keyword">where</span> deptno <span class="token operator">not</span> <span class="token operator">in</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="27__177"></a>2.7 聚合函数</h4> 
<p>（1）语法</p> 
<table><thead><tr><th>count(*)</th><th>表示统计所有行数，包含null值</th></tr></thead><tbody><tr><td>count(某列)</td><td>表示该列一共有多少行，不包含null值</td></tr><tr><td>max()</td><td>求最大值，不包含null，除非所有值都是null</td></tr><tr><td>min()</td><td>求最小值，不包含null，除非所有值都是null</td></tr><tr><td>sum()</td><td>求和，不包含null</td></tr><tr><td>avg()</td><td>求平均值，不包含null</td></tr></tbody></table> 
<p>（2）案例实操</p> 
<pre><code class="prism language-sql"><span class="token comment">--求总行数（count）</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> cnt <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
</code></pre> 
<p>hive sql执行过程：<br> <img src="https://images2.imgbox.com/f7/1c/V83A9jn7_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3__197"></a>3. 分组</h3> 
<h4><a id="31_Group_By_198"></a>3.1 Group By语句</h4> 
<blockquote> 
 <p>Group By语句通常会和聚合函数一起使用，按照一个或者多个列队结果进行分组，然后对每个组执行聚合操作。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">--计算emp表每个部门的平均工资</span>
<span class="token keyword">select</span> 
    t<span class="token punctuation">.</span>deptno<span class="token punctuation">,</span> 
    <span class="token function">avg</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>sal<span class="token punctuation">)</span> avg_sal 
<span class="token keyword">from</span> emp t 
<span class="token keyword">group</span> <span class="token keyword">by</span> t<span class="token punctuation">.</span>deptno<span class="token punctuation">;</span>
</code></pre> 
<p>hive sql执行过程：<br> <img src="https://images2.imgbox.com/8b/4c/pULxNvPL_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token comment">--计算emp每个部门中每个岗位的最高薪水。</span>
<span class="token keyword">select</span> 
    t<span class="token punctuation">.</span>deptno<span class="token punctuation">,</span> 
    t<span class="token punctuation">.</span>job<span class="token punctuation">,</span> 
    <span class="token function">max</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>sal<span class="token punctuation">)</span> max_sal 
<span class="token keyword">from</span> emp t 
<span class="token keyword">group</span> <span class="token keyword">by</span> t<span class="token punctuation">.</span>deptno<span class="token punctuation">,</span> t<span class="token punctuation">.</span>job<span class="token punctuation">;</span>
</code></pre> 
<p>hive sql执行过程：<br> <img src="https://images2.imgbox.com/82/c0/oRb9XCPG_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="32_Having_228"></a>3.2 Having语句</h4> 
<blockquote> 
 <ul><li>where后面不能写分组聚合函数，而having后面可以使用分组聚合函数。</li><li>having只用于group by分组统计语句。</li></ul> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">--求每个部门的平均薪水大于2000的部门</span>
<span class="token comment">--求每个部门的平均工资。</span>
<span class="token keyword">select</span> 
    deptno<span class="token punctuation">,</span> 
    <span class="token function">avg</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> 
<span class="token keyword">from</span> emp 
<span class="token keyword">group</span> <span class="token keyword">by</span> deptno<span class="token punctuation">;</span>
<span class="token comment">--求每个部门的平均薪水大于2000的部门。</span>
<span class="token keyword">select</span> 
    deptno<span class="token punctuation">,</span> 
    <span class="token function">avg</span><span class="token punctuation">(</span>sal<span class="token punctuation">)</span> avg_sal 
<span class="token keyword">from</span> emp 
<span class="token keyword">group</span> <span class="token keyword">by</span> deptno  
<span class="token keyword">having</span> avg_sal <span class="token operator">&gt;</span> <span class="token number">2000</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="4_Join_250"></a>4. Join语句</h3> 
<p>（1）等值Join</p> 
<blockquote> 
 <p>Hive支持通常的sql join语句，但是只支持等值连接，不支持非等值连接。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">--根据员工表和部门表中的部门编号相等，查询员工编号、员工名称和部门名称。</span>
<span class="token keyword">select</span> 
    e<span class="token punctuation">.</span>empno<span class="token punctuation">,</span> 
    e<span class="token punctuation">.</span>ename<span class="token punctuation">,</span> 
    d<span class="token punctuation">.</span>dname 
<span class="token keyword">from</span> emp e 
<span class="token keyword">join</span> dept d 
<span class="token keyword">on</span> e<span class="token punctuation">.</span>deptno <span class="token operator">=</span> d<span class="token punctuation">.</span>deptno<span class="token punctuation">;</span>
</code></pre> 
<p>hive sql执行过程：<br> <img src="https://images2.imgbox.com/2f/80/VtUmJtDr_o.png" alt="在这里插入图片描述"></p> 
<p>（2）表的别名</p> 
<blockquote> 
 <ul><li>使用别名可以简化查询。</li><li>区分字段的来源。</li></ul> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">--合并员工表和部门表。</span>
<span class="token keyword">select</span> 
    e<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
    d<span class="token punctuation">.</span><span class="token operator">*</span> 
<span class="token keyword">from</span> emp e 
<span class="token keyword">join</span> dept d 
<span class="token keyword">on</span> e<span class="token punctuation">.</span>deptno <span class="token operator">=</span> d<span class="token punctuation">.</span>deptno<span class="token punctuation">;</span>
</code></pre> 
<p>（3）内连接</p> 
<blockquote> 
 <p>内连接：只有进行连接的两个表中都存在与连接条件相匹配的数据才会被保留下来。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> 
    e<span class="token punctuation">.</span>empno<span class="token punctuation">,</span> 
    e<span class="token punctuation">.</span>ename<span class="token punctuation">,</span> 
    d<span class="token punctuation">.</span>deptno 
<span class="token keyword">from</span> emp e 
<span class="token keyword">join</span> dept d 
<span class="token keyword">on</span> e<span class="token punctuation">.</span>deptno <span class="token operator">=</span> d<span class="token punctuation">.</span>deptno<span class="token punctuation">;</span>
</code></pre> 
<p>（4）左外连接</p> 
<blockquote> 
 <p>左外连接：join操作符左边表中符合where子句的所有记录将会被返回。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> 
    e<span class="token punctuation">.</span>empno<span class="token punctuation">,</span> 
    e<span class="token punctuation">.</span>ename<span class="token punctuation">,</span> 
    d<span class="token punctuation">.</span>deptno 
<span class="token keyword">from</span> emp e 
<span class="token keyword">left</span> <span class="token keyword">join</span> dept d 
<span class="token keyword">on</span> e<span class="token punctuation">.</span>deptno <span class="token operator">=</span> d<span class="token punctuation">.</span>deptno<span class="token punctuation">;</span>
</code></pre> 
<p>（5）右外连接</p> 
<blockquote> 
 <p>右外连接：join操作符右边表中符合where子句的所有记录将会被返回。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> 
    e<span class="token punctuation">.</span>empno<span class="token punctuation">,</span> 
    e<span class="token punctuation">.</span>ename<span class="token punctuation">,</span> 
    d<span class="token punctuation">.</span>deptno 
<span class="token keyword">from</span> emp e 
<span class="token keyword">right</span> <span class="token keyword">join</span> dept d 
<span class="token keyword">on</span> e<span class="token punctuation">.</span>deptno <span class="token operator">=</span> d<span class="token punctuation">.</span>deptno<span class="token punctuation">;</span>
</code></pre> 
<p>（6） 满外连接</p> 
<blockquote> 
 <p>满外连接：将会返回所有表中符合where语句条件的所有记录。如果任一表的指定字段没有符合条件的值的话，那么就使用null值替代。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> 
    e<span class="token punctuation">.</span>empno<span class="token punctuation">,</span> 
    e<span class="token punctuation">.</span>ename<span class="token punctuation">,</span> 
    d<span class="token punctuation">.</span>deptno 
<span class="token keyword">from</span> emp e 
<span class="token keyword">full</span> <span class="token keyword">join</span> dept d 
<span class="token keyword">on</span> e<span class="token punctuation">.</span>deptno <span class="token operator">=</span> d<span class="token punctuation">.</span>deptno<span class="token punctuation">;</span>
</code></pre> 
<p>（7）多表连接</p> 
<blockquote> 
 <p>注意：连接n个表，至少需要n-1个连接条件。例如：连接三个表，至少需要两个连接条件。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">--多表连接查询</span>
<span class="token keyword">select</span> 
    e<span class="token punctuation">.</span>ename<span class="token punctuation">,</span> 
    d<span class="token punctuation">.</span>dname<span class="token punctuation">,</span> 
    l<span class="token punctuation">.</span>loc_name
<span class="token keyword">from</span> emp e 
<span class="token keyword">join</span> dept d
<span class="token keyword">on</span> d<span class="token punctuation">.</span>deptno <span class="token operator">=</span> e<span class="token punctuation">.</span>deptno 
<span class="token keyword">join</span> location l
<span class="token keyword">on</span> d<span class="token punctuation">.</span>loc <span class="token operator">=</span> l<span class="token punctuation">.</span>loc<span class="token punctuation">;</span>
</code></pre> 
<p>大多数情况下，Hive会对每对join连接对象启动一个MapReduce任务。本例中会首先启动一个MapReduce job对表e和表d进行连接操作，然后会再启动一个MapReduce job将第一个MapReduce job的输出和表l进行连接操作。</p> 
<blockquote> 
 <p>Hive总是按照从左到右的顺序执行的。</p> 
</blockquote> 
<p>（8）笛卡尔集</p> 
<blockquote> 
 <p>笛卡尔集会在下面条件下产生</p> 
 <ul><li>省略连接条件</li><li>连接条件无效</li><li>所有表中的所有行互相连接</li></ul> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> 
    empno<span class="token punctuation">,</span> 
    dname 
<span class="token keyword">from</span> emp<span class="token punctuation">,</span> dept<span class="token punctuation">;</span>
</code></pre> 
<p>hive sql执行过程：<br> <img src="https://images2.imgbox.com/20/c6/GMEGfTZN_o.png" alt="在这里插入图片描述"></p> 
<p>（9）联合（union &amp; union all）</p> 
<blockquote> 
 <p>union和union all都是上下拼接sql的结果，这点是和join有区别的，join是左右关联，union和union all是上下拼接。union去重，union all不去重。<br> union和union all在上下拼接sql结果时有两个要求：</p> 
 <ul><li>两个sql的结果，列的个数必须相同</li><li>两个sql的结果，上下所对应列的类型必须一致</li></ul> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">--将员工表30部门的员工信息和40部门的员工信息，利用union进行拼接显示。</span>
<span class="token keyword">select</span> 
    <span class="token operator">*</span>
<span class="token keyword">from</span> emp
<span class="token keyword">where</span> deptno<span class="token operator">=</span><span class="token number">30</span>
<span class="token keyword">union</span>
<span class="token keyword">select</span> 
    <span class="token operator">*</span>
<span class="token keyword">from</span> emp
<span class="token keyword">where</span> deptno<span class="token operator">=</span><span class="token number">40</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="5_399"></a>5.排序</h3> 
<h4><a id="51_Order_By_400"></a>5.1 全局排序（Order By）</h4> 
<blockquote> 
 <p>Order By：全局排序，只有一个Reduce。即使在MR中设置了多个Reducer，最后也只有一个Reducer。</p> 
 <ul><li>使用Order By子句排序 asc（ascend）：升序（默认）；desc（descend）：降序</li><li>Order By子句在select语句的结尾</li></ul> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">--查询员工信息按工资升序排列</span>
<span class="token keyword">select</span> 
    <span class="token operator">*</span> 
<span class="token keyword">from</span> emp 
<span class="token keyword">order</span> <span class="token keyword">by</span> sal<span class="token punctuation">;</span>
</code></pre> 
<p>hive sql执行过程：<br> <img src="https://images2.imgbox.com/40/43/JSpkmC3z_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>因为Order By只有一个Reducer，所以数据量比较大时，MR任务会失败，所以一般不会直接写order by语句。</p> 
</blockquote> 
<h4><a id="52_ReduceSort_By_420"></a>5.2 每个Reduce内部排序（Sort By）</h4> 
<blockquote> 
 <ul><li>Sort By：对于大规模的数据集order by的效率非常低。在很多情况下，并不需要全局排序，此时可以使用Sort by。</li><li>Sort by为每个reduce产生一个排序文件。每个Reduce内部进行排序，对全局结果集来说不是排序。</li></ul> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">--设置reduce个数</span>
<span class="token keyword">set</span> mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>reduces<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">--查看设置reduce个数</span>
<span class="token keyword">set</span> mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>reduces<span class="token punctuation">;</span>

<span class="token comment">--根据部门编号降序查看员工信息</span>
<span class="token keyword">select</span> 
    <span class="token operator">*</span> 
<span class="token keyword">from</span> emp 
sort <span class="token keyword">by</span> deptno <span class="token keyword">desc</span><span class="token punctuation">;</span>
</code></pre> 
<p>hive sql执行过程：<br> <img src="https://images2.imgbox.com/80/c0/Ew4u7r2D_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="53_Distribute_By_442"></a>5.3 分区（Distribute By）</h4> 
<blockquote> 
 <ul><li> <p>Distribute By：在有些情况下，我们需要控制某个特定行应该到哪个Reducer，通常是为了进行后续的聚集操作。distribute by子句可以做这件事。distribute by类似MapReduce中partition（自定义分区），进行分区，结合sort by使用。</p> </li><li> <p>对于distribute by进行测试，一定要分配多reduce进行处理，否则无法看到distribute by的效果。</p> </li></ul> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">--先按照部门编号分区，再按照员工编号薪资排序</span>
<span class="token keyword">set</span> mapreduce<span class="token punctuation">.</span>job<span class="token punctuation">.</span>reduces<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> overwrite <span class="token keyword">local</span> directory 
<span class="token string">'/opt/module/hive/datas/distribute-result'</span> 
<span class="token keyword">select</span> 
    <span class="token operator">*</span> 
<span class="token keyword">from</span> emp 
distribute <span class="token keyword">by</span> deptno 
sort <span class="token keyword">by</span> sal <span class="token keyword">desc</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>注意：</p> 
 <ul><li>distribute by的分区规则是根据分区字段的hash码与reduce的个数进行相除后，余数相同的分到一个区。</li><li>Hive要求distribute by语句要写在sort by语句之前。</li><li>演示完以后mapreduce.job.reduces的值要设置回-1，否则下面分区or分桶表load跑MapReduce的时候会报错。</li></ul> 
</blockquote> 
<h4><a id="54_Cluster_By_466"></a>5.4 分区排序（Cluster By）</h4> 
<blockquote> 
 <ul><li>当distribute by和sort by字段相同时，可以使用cluster by方式。</li><li>cluster by除了具有distribute by的功能外还兼具sort by的功能。但是排序只能是升序排序，不能指定排序规则为asc或者desc。</li></ul> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">--写法一</span>
<span class="token keyword">select</span> 
    <span class="token operator">*</span> 
<span class="token keyword">from</span> emp 
cluster <span class="token keyword">by</span> deptno<span class="token punctuation">;</span>

<span class="token comment">--写法二</span>
    <span class="token operator">*</span> 
<span class="token keyword">from</span> emp 
distribute <span class="token keyword">by</span> deptno 
sort <span class="token keyword">by</span> deptno<span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>注意：按照部门编号分区，不一定就是固定死的数值，可以是20号和30号部门分到一个分区里面去。</p> 
</blockquote> 
<h2><a id="_487"></a>二、函数</h2> 
<blockquote> 
 <p>Hive会将常用的逻辑封装成函数给用户进行使用，类似于Java中的函数。</p> 
 <ul><li>好处：避免用户反复写逻辑，可以直接拿来使用。</li><li>重点：用户需要知道函数叫什么，能做什么。</li></ul> 
 <p>Hive提供了大量的内置函数，按照其特点可大致分为如下几类：单行函数、聚合函数、炸裂函数、窗口函数。</p> 
</blockquote> 
<p>以下命令可用于查询所有内置函数的相关信息。</p> 
<pre><code class="prism language-sql"><span class="token comment">--查看系统内置函数</span>
<span class="token keyword">show</span> functions<span class="token punctuation">;</span>
<span class="token comment">--查看内置函数用法</span>
<span class="token keyword">desc</span> <span class="token keyword">function</span> upper<span class="token punctuation">;</span>
<span class="token comment">--查看内置函数详细信息</span>
<span class="token keyword">desc</span> <span class="token keyword">function</span> <span class="token keyword">extended</span> upper<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="1_506"></a>1.单行函数</h3> 
<blockquote> 
 <p>单行函数的特点是一进一出，即输入一行，输出一行。</p> 
</blockquote> 
<p>单行函数按照功能可分为如下几类: 日期函数、字符串函数、集合函数、数学函数、流程控制函数等。</p> 
<h4><a id="11__511"></a>1.1 算术运算函数</h4> 
<table><thead><tr><th>运算符</th><th>描述</th></tr></thead><tbody><tr><td>A+B</td><td>A和B 相加</td></tr><tr><td>A-B</td><td>A减去B</td></tr><tr><td>A*B</td><td>A和B 相乘</td></tr><tr><td>A/B</td><td>A除以B</td></tr><tr><td>A%B</td><td>A对B取余</td></tr><tr><td>A&amp;B</td><td>A和B按位取与</td></tr><tr><td>A|B</td><td>A和B按位取或</td></tr><tr><td>A^B</td><td>A和B按位取异或</td></tr><tr><td>~A</td><td>A按位取反</td></tr></tbody></table> 
<pre><code class="prism language-sql"><span class="token comment">--查询出所有员工的薪水后加1显示。</span>
<span class="token keyword">select</span> sal <span class="token operator">+</span> <span class="token number">1</span> <span class="token keyword">from</span> emp<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="12__529"></a>1.2 数值函数</h4> 
<pre><code class="prism language-sql"><span class="token comment">--round：四舍五入</span>
<span class="token keyword">select</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">3.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token number">3</span>
<span class="token comment">--ceil：向上取整</span>
<span class="token keyword">select</span> ceil<span class="token punctuation">(</span><span class="token number">3.1</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>   
<span class="token number">4</span>
<span class="token comment">--floor：向下取整</span>
<span class="token keyword">select</span> floor<span class="token punctuation">(</span><span class="token number">4.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">4</span>
</code></pre> 
<h4><a id="13__543"></a>1.3 字符串函数</h4> 
<p>（1）substring：截取字符串</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：string ，返回字符串A从start位置到结尾的字符串</span>
substring<span class="token punctuation">(</span>string A<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token keyword">start</span><span class="token punctuation">)</span> 

<span class="token comment">--返回值：string，返回字符串A从start位置开始，长度为len的字符串</span>
substring<span class="token punctuation">(</span>string A<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token keyword">start</span><span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> 
</code></pre> 
<p>（2）replace ：替换</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：string，将字符串A中的子字符串B替换为C</span>
<span class="token keyword">replace</span><span class="token punctuation">(</span>string A<span class="token punctuation">,</span> string B<span class="token punctuation">,</span> string C<span class="token punctuation">)</span> 

<span class="token keyword">select</span> <span class="token keyword">replace</span><span class="token punctuation">(</span><span class="token string">'atguigu'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span>
</code></pre> 
<p>（3）regexp_replace：正则替换</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：string，将字符串A中的符合java正则表达式B的部分替换为C</span>
<span class="token comment">--注意，在有些情况下要使用转义字符</span>
regexp_replace<span class="token punctuation">(</span>string A<span class="token punctuation">,</span> string B<span class="token punctuation">,</span> string C<span class="token punctuation">)</span> 

<span class="token keyword">select</span> regexp_replace<span class="token punctuation">(</span><span class="token string">'100-200'</span><span class="token punctuation">,</span> <span class="token string">'(\\d+)'</span><span class="token punctuation">,</span> <span class="token string">'num'</span><span class="token punctuation">)</span> 
</code></pre> 
<p>（4）regexp：正则匹配</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：boolean，若字符串符合正则表达式，则返回true，否则返回false</span>
<span class="token comment">--正则匹配成功，输出true</span>
<span class="token keyword">select</span> <span class="token string">'dfsaaaa'</span> <span class="token operator">regexp</span> <span class="token string">'dfsa+'</span>
<span class="token boolean">true</span>
<span class="token comment">--正则匹配失败，输出false</span>
<span class="token keyword">select</span> <span class="token string">'dfsaaaa'</span> <span class="token operator">regexp</span> <span class="token string">'dfsb+'</span><span class="token punctuation">;</span>
<span class="token boolean">false</span>
</code></pre> 
<p>（5）repeat：重复字符串</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：string，将字符串A重复n遍</span>
<span class="token keyword">repeat</span><span class="token punctuation">(</span>string A<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span>

<span class="token keyword">select</span> <span class="token keyword">repeat</span><span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>（6）split ：字符串切割</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：array，按照正则表达式pat匹配到的内容分割str，分割后的字符串，以数组的形式返回</span>
split<span class="token punctuation">(</span>string str<span class="token punctuation">,</span> string pat<span class="token punctuation">)</span> 

<span class="token keyword">select</span> split<span class="token punctuation">(</span><span class="token string">'a-b-c-d'</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>（7）nvl ：替换null值</p> 
<pre><code class="prism language-sql"><span class="token comment">--若A的值不为null，则返回A，否则返回B</span>
nvl<span class="token punctuation">(</span>A<span class="token punctuation">,</span>B<span class="token punctuation">)</span> 

<span class="token keyword">select</span> nvl<span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p>（8）concat ：拼接字符串</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回：string，将A,B,C……等字符拼接为一个字符串</span>
concat<span class="token punctuation">(</span>string A<span class="token punctuation">,</span> string B<span class="token punctuation">,</span> string C<span class="token punctuation">,</span> ……<span class="token punctuation">)</span> 

<span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token string">'beijing'</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">,</span><span class="token string">'shanghai'</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">,</span><span class="token string">'shenzhen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>（9）concat_ws：以指定分隔符拼接字符串或者字符串数组</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：string，使用分隔符A拼接多个字符串，或者一个数组的所有元素。</span>
concat_ws<span class="token punctuation">(</span>string A<span class="token punctuation">,</span> string…<span class="token operator">|</span> array<span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">)</span> 

<span class="token keyword">select</span> concat_ws<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">,</span><span class="token string">'beijing'</span><span class="token punctuation">,</span><span class="token string">'shanghai'</span><span class="token punctuation">,</span><span class="token string">'shenzhen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>（10）get_json_object：解析json字符串</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：string，解析json的字符串json_string，返回path指定的内容。如果输入的json字符串无效，那么返回NULL</span>
get_json_object<span class="token punctuation">(</span>string json_string<span class="token punctuation">,</span> string path<span class="token punctuation">)</span> 
</code></pre> 
<h4><a id="14__636"></a>1.4 日期函数</h4> 
<p>（1）unix_timestamp：返回当前或指定时间的时间戳</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：bigint </span>
unix_timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span> 

<span class="token keyword">select</span> unix_timestamp<span class="token punctuation">(</span><span class="token string">'2022/08/08 08-08-08'</span><span class="token punctuation">,</span><span class="token string">'yyyy/MM/dd HH-mm-ss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token comment">--输出：</span>
<span class="token number">1659946088</span>
</code></pre> 
<blockquote> 
 <p>说明：-前面是日期后面是指，日期传进来的具体格式</p> 
</blockquote> 
<p>（2）from_unixtime：转化UNIX时间戳（从 1970-01-01 00:00:00 UTC 到指定时间的秒数）到当前时区的时间格式</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：string </span>
from_unixtime<span class="token punctuation">(</span><span class="token keyword">bigint</span> unixtime<span class="token punctuation">[</span><span class="token punctuation">,</span> string format<span class="token punctuation">]</span><span class="token punctuation">)</span> 

<span class="token keyword">select</span> from_unixtime<span class="token punctuation">(</span><span class="token number">1659946088</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token comment">--输出：</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">08</span>:<span class="token number">08</span>:<span class="token number">08</span>
</code></pre> 
<p>（3）current_date：当前日期</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token keyword">current_date</span><span class="token punctuation">;</span>     
<span class="token comment">--输出：</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">11</span>
</code></pre> 
<p>（4）current_timestamp：当前的日期加时间，并且精确的毫秒</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token keyword">current_timestamp</span><span class="token punctuation">;</span>   
<span class="token comment">--输出：</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">11</span> <span class="token number">15</span>:<span class="token number">32</span>:<span class="token number">22.402</span>
</code></pre> 
<p>（5）month：获取日期中的月</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：int </span>
<span class="token keyword">month</span> <span class="token punctuation">(</span>string <span class="token keyword">date</span><span class="token punctuation">)</span> 

<span class="token keyword">select</span> <span class="token keyword">month</span><span class="token punctuation">(</span><span class="token string">'2022-08-08 08:08:08'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">--输出：</span>
<span class="token number">8</span>
</code></pre> 
<p>（6）day：获取日期中的日</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：int </span>
<span class="token keyword">day</span> <span class="token punctuation">(</span>string <span class="token keyword">date</span><span class="token punctuation">)</span> 

<span class="token keyword">select</span> <span class="token keyword">day</span><span class="token punctuation">(</span><span class="token string">'2022-08-08 08:08:08'</span><span class="token punctuation">)</span>    
<span class="token comment">--输出：</span>
<span class="token number">8</span>
</code></pre> 
<p>（7）hour：获取日期中的小时</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：int </span>
<span class="token keyword">hour</span> <span class="token punctuation">(</span>string <span class="token keyword">date</span><span class="token punctuation">)</span> 

<span class="token keyword">select</span> <span class="token keyword">hour</span><span class="token punctuation">(</span><span class="token string">'2022-08-08 08:08:08'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token comment">--输出：</span>
<span class="token number">8</span>
</code></pre> 
<p>（8）datediff：两个日期相差的天数（结束日期减去开始日期的天数）</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：int </span>
datediff<span class="token punctuation">(</span>string enddate<span class="token punctuation">,</span> string startdate<span class="token punctuation">)</span> 

<span class="token keyword">select</span> datediff<span class="token punctuation">(</span><span class="token string">'2021-08-08'</span><span class="token punctuation">,</span><span class="token string">'2022-10-09'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     
<span class="token comment">--输出：</span>
<span class="token operator">-</span><span class="token number">427</span>
</code></pre> 
<p>（9）date_add：日期加天数</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：string，返回开始日期 startdate 增加 days 天后的日期</span>
date_add<span class="token punctuation">(</span>string startdate<span class="token punctuation">,</span> <span class="token keyword">int</span> days<span class="token punctuation">)</span> 

<span class="token keyword">select</span> date_add<span class="token punctuation">(</span><span class="token string">'2022-08-08'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token comment">--输出：</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">10</span>
</code></pre> 
<p>（10）date_sub：日期减天数</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：string，返回开始日期startdate减少days天后的日期</span>
date_sub <span class="token punctuation">(</span>string startdate<span class="token punctuation">,</span> <span class="token keyword">int</span> days<span class="token punctuation">)</span> 

<span class="token keyword">select</span> date_sub<span class="token punctuation">(</span><span class="token string">'2022-08-08'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token comment">--输出：</span>
<span class="token number">2022</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">06</span>
</code></pre> 
<p>（11）date_format:将标准日期解析成指定格式字符串</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> date_format<span class="token punctuation">(</span><span class="token string">'2022-08-08'</span><span class="token punctuation">,</span><span class="token string">'yyyy年-MM月-dd日'</span><span class="token punctuation">)</span>   
<span class="token comment">--输出：</span>
<span class="token number">2022</span>年<span class="token operator">-</span><span class="token number">08</span>月<span class="token operator">-</span><span class="token number">08</span>日
</code></pre> 
<h4><a id="15__751"></a>1.5 流程控制函数</h4> 
<p>（1）case when：条件判断函数</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：T，如果a为true，则返回b；如果c为true，则返回d；否则返回 e </span>
<span class="token keyword">case</span> <span class="token keyword">when</span> a <span class="token keyword">then</span> b <span class="token punctuation">[</span><span class="token keyword">when</span> c <span class="token keyword">then</span> d<span class="token punctuation">]</span><span class="token operator">*</span> <span class="token punctuation">[</span><span class="token keyword">else</span> e<span class="token punctuation">]</span> <span class="token keyword">end</span> 

<span class="token comment">--返回值: T，如果a等于b，那么返回c；如果a等于d，那么返回e；否则返回f </span>
<span class="token keyword">case</span> a <span class="token keyword">when</span> b <span class="token keyword">then</span> c <span class="token punctuation">[</span><span class="token keyword">when</span> d <span class="token keyword">then</span> e<span class="token punctuation">]</span><span class="token operator">*</span> <span class="token punctuation">[</span><span class="token keyword">else</span> f<span class="token punctuation">]</span> <span class="token keyword">end</span> 
</code></pre> 
<p>（2）if: 条件判断，类似于Java中三元运算符</p> 
<pre><code class="prism language-sql"><span class="token comment">--返回值：T，当条件testCondition为true时，返回valueTrue；否则返回valueFalseOrNull</span>
<span class="token keyword">if</span>（<span class="token keyword">boolean</span> testCondition<span class="token punctuation">,</span> T valueTrue<span class="token punctuation">,</span> T valueFalseOrNull）
</code></pre> 
<p>1.6 集合函数<br> （1）size：集合中元素的个数</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> size<span class="token punctuation">(</span>friends<span class="token punctuation">)</span> <span class="token keyword">from</span> test<span class="token punctuation">;</span> <span class="token comment">--每一行数据中的friends集合里的个数</span>
</code></pre> 
<p>（2）map：创建map集合</p> 
<pre><code class="prism language-sql"><span class="token comment">--根据输入的key和value对构建map类型</span>
map <span class="token punctuation">(</span>key1<span class="token punctuation">,</span> value1<span class="token punctuation">,</span> key2<span class="token punctuation">,</span> value2<span class="token punctuation">,</span> …<span class="token punctuation">)</span> 

<span class="token keyword">select</span> map<span class="token punctuation">(</span><span class="token string">'xiaohai'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'dahai'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token comment">--输出：</span>
{<!-- --><span class="token string">"xiaohai"</span>:<span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"dahai"</span>:<span class="token number">2</span>}
</code></pre> 
<p>（3）map_keys： 返回map中的key</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> map_keys<span class="token punctuation">(</span>map<span class="token punctuation">(</span><span class="token string">'xiaohai'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'dahai'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">--输出：</span>
<span class="token punctuation">[</span><span class="token string">"xiaohai"</span><span class="token punctuation">,</span><span class="token string">"dahai"</span><span class="token punctuation">]</span>
</code></pre> 
<p>（4）map_values: 返回map中的value</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> map_values<span class="token punctuation">(</span>map<span class="token punctuation">(</span><span class="token string">'xiaohai'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'dahai'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">--输出：</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
</code></pre> 
<p>（5）array 声明array集合</p> 
<pre><code class="prism language-sql"><span class="token comment">--根据输入的参数构建数组array类</span>
array<span class="token punctuation">(</span>val1<span class="token punctuation">,</span> val2<span class="token punctuation">,</span> …<span class="token punctuation">)</span> 

<span class="token keyword">select</span> array<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">--输出：</span>
<span class="token punctuation">[</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">,</span><span class="token string">"3"</span><span class="token punctuation">,</span><span class="token string">"4"</span><span class="token punctuation">]</span>
</code></pre> 
<p>（6）array_contains: 判断array中是否包含某个元素</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> array_contains<span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">--输出：</span>
<span class="token boolean">true</span>
</code></pre> 
<p>（7）sort_array：将array中的元素排序</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> sort_array<span class="token punctuation">(</span>array<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'d'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">--输出：</span>
 <span class="token punctuation">[</span><span class="token string">"a"</span><span class="token punctuation">,</span><span class="token string">"c"</span><span class="token punctuation">,</span><span class="token string">"d"</span><span class="token punctuation">]</span>
</code></pre> 
<p>（8）struct声明struct中的各属性</p> 
<pre><code class="prism language-sql"><span class="token comment">--根据输入的参数构建结构体struct类</span>
struct<span class="token punctuation">(</span>val1<span class="token punctuation">,</span> val2<span class="token punctuation">,</span> val3<span class="token punctuation">,</span> …<span class="token punctuation">)</span> 

<span class="token keyword">select</span> struct<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'age'</span><span class="token punctuation">,</span><span class="token string">'weight'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">--输出：</span>
{<!-- --><span class="token string">"col1"</span>:<span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"col2"</span>:<span class="token string">"age"</span><span class="token punctuation">,</span><span class="token string">"col3"</span>:<span class="token string">"weight"</span>}
</code></pre> 
<p>（9）named_struct声明struct的属性和值</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> named_struct<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'xiaosong'</span><span class="token punctuation">,</span><span class="token string">'age'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token string">'weight'</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">--输出：</span>
{<!-- --><span class="token string">"name"</span>:<span class="token string">"xiaosong"</span><span class="token punctuation">,</span><span class="token string">"age"</span>:<span class="token number">18</span><span class="token punctuation">,</span><span class="token string">"weight"</span>:<span class="token number">80</span>}
</code></pre> 
<h3><a id="2__849"></a>2. 高级聚合函数</h3> 
<blockquote> 
 <p>多进一出 （多行传入，一个行输出）。</p> 
</blockquote> 
<p>（1）普通聚合 <code>count/sum.... </code><br> （2）collect_list 收集并形成list集合，结果不去重</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> 
  sex<span class="token punctuation">,</span>
  collect_list<span class="token punctuation">(</span>job<span class="token punctuation">)</span>
<span class="token keyword">from</span>
  employee
<span class="token keyword">group</span> <span class="token keyword">by</span> 
  sex
<span class="token comment">--结果：</span>
女	<span class="token punctuation">[</span><span class="token string">"行政"</span><span class="token punctuation">,</span><span class="token string">"研发"</span><span class="token punctuation">,</span><span class="token string">"行政"</span><span class="token punctuation">,</span><span class="token string">"前台"</span><span class="token punctuation">]</span>
男	<span class="token punctuation">[</span><span class="token string">"销售"</span><span class="token punctuation">,</span><span class="token string">"研发"</span><span class="token punctuation">,</span><span class="token string">"销售"</span><span class="token punctuation">,</span><span class="token string">"前台"</span><span class="token punctuation">]</span>
</code></pre> 
<p>（3）collect_set 收集并形成set集合，结果去重</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> 
  sex<span class="token punctuation">,</span>
  collect_set<span class="token punctuation">(</span>job<span class="token punctuation">)</span>
<span class="token keyword">from</span>
  employee
<span class="token keyword">group</span> <span class="token keyword">by</span> 
  sex
<span class="token comment">--结果：</span>
女	<span class="token punctuation">[</span><span class="token string">"行政"</span><span class="token punctuation">,</span><span class="token string">"研发"</span><span class="token punctuation">,</span><span class="token string">"前台"</span><span class="token punctuation">]</span>
男	<span class="token punctuation">[</span><span class="token string">"销售"</span><span class="token punctuation">,</span><span class="token string">"研发"</span><span class="token punctuation">,</span><span class="token string">"前台"</span><span class="token punctuation">]</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/329c361030048b7dd171d0abb7154bb0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【IC设计】Chisel开发环境搭建</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0c2f5c901591d3d1528487464326cbae/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">用python写一个完整的图书管理系统</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>