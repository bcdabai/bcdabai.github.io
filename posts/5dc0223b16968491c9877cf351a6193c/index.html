<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>间隔分区表merge into报错“-2903: 语句块/包/存储函数中的间隔分区不支持自动扩展” - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="间隔分区表merge into报错“-2903: 语句块/包/存储函数中的间隔分区不支持自动扩展”" />
<meta property="og:description" content="描述 版本： DM V8 --08134283904-20220804-166351-20005 Pack4
初始化参数： 默认
ini参数： 默认
执行间隔分区表上执行merge into语句报错，信息如下：
同样的语句，在Oracle中执行正常。
测试 创建环境：
DROP TABLE IF EXISTS TAB_P001; DROP TABLE IF EXISTS T1; CREATE TABLE T1 AS select USERNAME,USER_ID,CREATED from dba_users; CREATE TABLE TAB_P001 ( C1 VARCHAR2(96), C2 TIMESTAMP(6) NOT NULL, C3 VARCHAR2(32) NOT NULL, PRIMARY KEY(C3)) PARTITION BY RANGE(C2) INTERVAL(NUMTOYMINTERVAL(1, &#39;MONTH&#39;)) ( PARTITION &#34;P_202201&#34; VALUES LESS THAN( to_date(&#39;2022-02-01 00:00:00&#39;,&#39;yyyy-mm-dd hh24:mi:ss&#39;) ), PARTITION &#34;P_202202&#34; VALUES LESS THAN( to_date(&#39;2022-03-01 00:00:00&#39;,&#39;yyyy-mm-dd hh24:mi:ss&#39;)) ); MERGE INTO TAB_P001 a USING t1 b on (a." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5dc0223b16968491c9877cf351a6193c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-27T17:53:47+08:00" />
<meta property="article:modified_time" content="2022-12-27T17:53:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">间隔分区表merge into报错“-2903: 语句块/包/存储函数中的间隔分区不支持自动扩展”</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>描述</h3> 
<p><strong>版本：</strong> DM V8 --08134283904-20220804-166351-20005 Pack4<br> <strong>初始化参数：</strong> 默认<br> <strong>ini参数：</strong> 默认<br> 执行间隔分区表上执行merge into语句报错，信息如下：<br> <img src="https://images2.imgbox.com/34/4b/oNLERRrk_o.png" alt="20221021184018"><br> 同样的语句，在Oracle中执行正常。</p> 
<h3><a id="_7"></a>测试</h3> 
<p>创建环境：</p> 
<pre><code class="prism language-SQL">DROP TABLE IF  EXISTS TAB_P001; 
DROP TABLE IF  EXISTS T1;
CREATE TABLE T1 AS select USERNAME,USER_ID,CREATED from dba_users;

CREATE TABLE TAB_P001
(
C1 VARCHAR2(96),
C2 TIMESTAMP(6) NOT NULL,
C3 VARCHAR2(32) NOT NULL,
 PRIMARY KEY(C3))
PARTITION BY RANGE(C2)
INTERVAL(NUMTOYMINTERVAL(1, 'MONTH'))
(
PARTITION  "P_202201"  VALUES LESS THAN( to_date('2022-02-01 00:00:00','yyyy-mm-dd hh24:mi:ss') ),
PARTITION  "P_202202"  VALUES LESS THAN( to_date('2022-03-01 00:00:00','yyyy-mm-dd hh24:mi:ss'))
);  

MERGE INTO TAB_P001 a USING t1 b
on (a.C3=b.user_id)
WHEN MATCHED THEN
   UPDATE SET a.C1='UPDATED'
WHEN NOT MATCHED THEN
   INSERT (C1,C2,C3) values(b.username,b.created,b.user_id); 

COMMIT;
</code></pre> 
<p>DM中测试情况，默认会报错：<br> <img src="https://images2.imgbox.com/48/f3/sVhtSYZi_o.png" alt="20221021185054"></p> 
<p>Oracle中测试正常：<br> <img src="https://images2.imgbox.com/ad/ed/2PoEel28_o.png" alt="20221021185931"></p> 
<h3><a id="_43"></a>问题处理</h3> 
<p>通过查询对应版本的DBA手册，搜索相关报错关键字（比如：分区表、间隔分区、自动扩展等），查找相关对应的INI参数，最终可以找到与DEL_HP_OPT_FLAG参数可能相关。该参数取值如下：</p> 
<pre><code>该参数为动态、会话级参数，默认为0
控制分区表的操作优化
0：不优化；
1：打开分区表DELETE优化；
2：控制范围分区表创建的优化处理，转换为数据流方式实现；
4：允许语句块中的间隔分区表自动扩展；
8：开启对TRUNCATE分区表的优化处理；
16：完全刷新时删除老数据使用DELETE方式。
支持使用上述有效值的组合值，如7表示同时进行1、2、4的优化
</code></pre> 
<p>从取值发现，取值为4时，允许语句块中的间隔分区表自动扩展。进行验证测试：</p> 
<pre><code class="prism language-sql"><span class="token comment">---修改DEL_HP_OPT_FLAG参数值为4</span>
SP_SET_PARA_VALUE<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'DEL_HP_OPT_FLAG'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">---执行merge into语句</span>
<span class="token keyword">MERGE</span> <span class="token keyword">INTO</span> TAB_P001 a <span class="token keyword">USING</span> t1 b
<span class="token keyword">on</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>C3<span class="token operator">=</span>b<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
<span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> <span class="token keyword">THEN</span>
   <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span> a<span class="token punctuation">.</span>C1<span class="token operator">=</span><span class="token string">'UPDATED'</span>
<span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">THEN</span>
   <span class="token keyword">INSERT</span> <span class="token punctuation">(</span>C1<span class="token punctuation">,</span>C2<span class="token punctuation">,</span>C3<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>username<span class="token punctuation">,</span>b<span class="token punctuation">.</span>created<span class="token punctuation">,</span>b<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p><img src="https://images2.imgbox.com/7d/63/YGj3lmHg_o.png" alt="20221021190915"></p> 
<p>通过验证可以发现，将DEL_HP_OPT_FLAG参数值设置为4后，间隔分区表上merge into语句执行正常。</p> 
<p>另外，根据报错信息以及参数说明，该参数默认为0时，语句块、存储过程里面涉及到间隔分区表的相关操作也会失败，修改为4后才能执行成功。测试验证如下：</p> 
<pre><code class="prism language-sql"><span class="token comment">---设置DEL_HP_OPT_FLAG参数值为0</span>
SP_SET_PARA_VALUE<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'DEL_HP_OPT_FLAG'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">---创建存储过程并测试</span>
<span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">procedure</span> p_test
<span class="token keyword">as</span>
<span class="token keyword">begin</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> TAB_P001 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'AAAAA'</span><span class="token punctuation">,</span>to_date<span class="token punctuation">(</span><span class="token string">'2023-3-30'</span><span class="token punctuation">,</span><span class="token string">'yyyy-mm-dd'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'66666'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token comment">---执行存储过程</span>
<span class="token keyword">call</span> p_test<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">---设置DEL_HP_OPT_FLAG参数值为4</span>
SP_SET_PARA_VALUE<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'DEL_HP_OPT_FLAG'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">---执行存储过程</span>
<span class="token keyword">call</span> p_test<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/32/eb/t8cOOctb_o.png" alt="20221021192351"></p> 
<h3><a id="_96"></a>小结</h3> 
<p>默认情况下DEL_HP_OPT_FLAG参数值为0时，语句块（包括merge into）、包、存储过程中的间隔分区表不支持分区自动扩展。将参数DEL_HP_OPT_FLAG的值为4后执行正常。<br> DEL_HP_OPT_FLAG参数属于动态、会话级参数，可直接在线修改生效，命令如下：</p> 
<pre><code class="prism language-SQL">SP_SET_PARA_VALUE(1,'DEL_HP_OPT_FLAG',4);
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/aec3d0fa7d787d6b02370c94a4013e1b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C语言零基础项目：2D 赛车游戏，详细思路&#43;源码分享</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9af1c88bdf6f942cda25eaa78ee3a406/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">达梦数据库日常使用语句01</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>