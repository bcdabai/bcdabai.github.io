<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用LVS-NAT搭建集群 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用LVS-NAT搭建集群" />
<meta property="og:description" content="一、 集群概述 1、 什么是集群 一组各自相互独立且又相互依赖的,通过高速网络互联的计算机组成的一个计算机组, 以单一的系统模式加以管理, 为用户提供服务, 对用户来说, 用户只会认为对方是一个服务. 这个里面, 一组计算机的一台计算机就是集群的一个节点
2、 集群的特性 可伸缩性, 可靠性, 可管理性
3、 应用场景 例：
一台服务器，如果能够响应10000个并发，返回的状态码全部是200
如果现在有20000个并发 返回的状态码[ 200 304 301 500 404 ]
由以上例子说明，web服务已经达到瓶颈
解决这个问题的办法:
加配置: 加CPU, 加内存, 加带宽, 加SSD 这种解决方法称为“向上扩展”, 能够解决一时, 却不能持久一世[单台服务器上做动作]。
加服务器: 一台==&gt;两台, 两台==&gt;四台 四台==&gt;8台 使用多台服务器同时为用户提供服务，而这一种解决方法则称为“横向扩展”或“向外扩展”。
向外扩展：就是集群。
4、 集群的种类 集群系统主要分为
负载均衡(Load Balance)集群，简称LB。
高可用(High Availability)集群，简称 HA 集群。
高性能计算(High Perfermance Computing)集群，简称 HPC 集群。
二、 LVS集群 1、 LVS LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统。本项目在1998年5月由章文嵩博士成立，是中国国内最早出现的自由软件项目之一，是根据iptables的实现来开发的，所以使用时候会和iptables相当类似
官网：http://www.linuxvirtualserver.org/
中文站点： http://zh.linuxvirtualserver.org/
2、 LVS集群工作结构图 负载调度器,：分发器(Load Balancer, Director): 整个集群对外的最前端机, 负责接收用户请求, 并且根据自己的调度算法, 将请求转发到后端真实服务器上的动作，而客户认为服务是来自一个IP地址（我们可称之为VIP虚拟IP地址）上的。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/263806a4dffc890ce819eaa866451245/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-14T14:34:03+08:00" />
<meta property="article:modified_time" content="2019-07-14T14:34:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用LVS-NAT搭建集群</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="	_0"></a>一、 集群概述</h2> 
<h2><a id="1	_1"></a>1、 什么是集群</h2> 
<p>一组各自相互独立且又相互依赖的,通过高速网络互联的计算机组成的一个计算机组, 以单一的系统模式加以管理, 为用户提供服务, 对用户来说, 用户只会认为对方是一个服务. 这个里面, 一组计算机的一台计算机就是集群的一个节点</p> 
<h2><a id="2	_4"></a>2、 集群的特性</h2> 
<p>可伸缩性, 可靠性, 可管理性</p> 
<h2><a id="3	_7"></a>3、 应用场景</h2> 
<p>例：<br> 一台服务器，如果能够响应10000个并发，返回的状态码全部是200<br> 如果现在有20000个并发 返回的状态码[ 200 304 301 500 404 ]<br> 由以上例子说明，web服务已经达到瓶颈</p> 
<p>解决这个问题的办法:<br> 加配置: 加CPU, 加内存, 加带宽, 加SSD 这种解决方法称为“向上扩展”, 能够解决一时, 却不能持久一世[单台服务器上做动作]。<br> 加服务器: 一台==&gt;两台, 两台==&gt;四台 四台==&gt;8台 使用多台服务器同时为用户提供服务，而这一种解决方法则称为“横向扩展”或“向外扩展”。</p> 
<p>向外扩展：就是集群。</p> 
<h2><a id="4	_19"></a>4、 集群的种类</h2> 
<p>集群系统主要分为<br> 负载均衡(Load Balance)集群，简称LB。<br> 高可用(High Availability)集群，简称 HA 集群。<br> 高性能计算(High Perfermance Computing)集群，简称 HPC 集群。</p> 
<h2><a id="	LVS_25"></a>二、 LVS集群</h2> 
<h2><a id="1	LVS_26"></a>1、 LVS</h2> 
<p>LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统。本项目在1998年5月由章文嵩博士成立，是中国国内最早出现的自由软件项目之一，是根据iptables的实现来开发的，所以使用时候会和iptables相当类似<br> 官网：<a href="http://www.linuxvirtualserver.org/" rel="nofollow">http://www.linuxvirtualserver.org/</a><br> 中文站点： <a href="http://zh.linuxvirtualserver.org/" rel="nofollow">http://zh.linuxvirtualserver.org/</a></p> 
<h2><a id="2	LVS_31"></a>2、 LVS集群工作结构图</h2> 
<p><img src="https://images2.imgbox.com/2a/2e/bNbKw8pd_o.png" alt="在这里插入图片描述"><br> 负载调度器,：分发器(Load Balancer, Director): 整个集群对外的最前端机, 负责接收用户请求, 并且根据自己的调度算法, 将请求转发到后端真实服务器上的动作，而客户认为服务是来自一个IP地址（我们可称之为VIP虚拟IP地址）上的。</p> 
<p>服务器池: Server Pool 真正为用户提供服务的服务器, 每一台服务器就是一台RS[RealServer]，执行的服务有WEB、MAIL、FTP和DNS等。</p> 
<p>共享存储: Shared Storaged 为RS保持相同内容, 提供数据的一致性，也就是说，它为服务器池提供一个共享的存储区，这样很容易使得服务器池拥有相同的内容，提供相同的服务。</p> 
<h2><a id="3	LVS_39"></a>3、 LVS模式及工作原理</h2> 
<p>3.1 LVS（4层）模式<br> LVS/NAT<br> LVS-VS/DR<br> LVS/TUN</p> 
<p>3.2 LVS负载均衡的三种转发方式<br> LVS提供了三种包转发方式：NAT(网络地址映射)、IP Tunneling(IP隧道)、Direct Routing(直接路由)。不同的转发模式决定了不同的cluster的网络结构</p> 
<p>3.3 NAT（网络地址转换）<br> NAT: 网络地址转换<br> DNAT: 目标地址转换 改变的是目标地址<br> SNAT: 原地址转换 改变的是原地址<br> LVS-NAT 就是使用的SNAT和DNAT完成报的转发<br> NAT方式可支持任何的操作系统，以及私有网络，并且只需一个Internet IP地址，但是整个系统的性能受到限制。因为执行NAT每次需要重写包，有一定的延迟；另外，大部分应用有80%的数据是从服务器流向客户机，也就是用户的请求非常短，而服务器的回应非常大，对负载均衡器形成很大压力，成为了新的瓶颈。</p> 
<p>3.4 IP Tunneling（IP隧道）<br> director（分发器）分配请求到不同的real server。real server处理请求后直接回应给用户，这样director负载均衡器仅处理客户机与服务器的一半连接。IP Tunneling技术极大地提高了director的调度处理能力，同时也极大地提高了系统能容纳的最大节点数，可以超过100个节点。real server可以在任何LAN或WAN上运行，这意味着允许地理上的分布，这在灾难恢复中有重要意义。服务器必须拥有正式的IP地址用于与客户机直接通信，并且所有服务器必须支持IP隧道协议。</p> 
<p>3.5 LNS-NAT模式的工作原理<br> 客户端访问调度器时，调度器通过网络地址转换，调度器重写请求报文的目标地址，根据预设的调度算法，将请求分派给后端的真实服务器；真实服务器的响应报文通过调度器时，报文的源地址被重写，再返回给客户，完成整个负载调度过程。</p> 
<p>如图：<br> 步骤1：客户端访问VIP1的网站<br> <img src="https://images2.imgbox.com/35/30/njeTNOfV_o.png" alt="在这里插入图片描述"><br> 图上各IP注解：<br> CIP 客户端的IP<br> VIP 是域名解析的IP, 是集群对外的公网IP<br> DIP 用来和后端服务器进行数据交互的IP, 请求报文转发给后端服务器从此口出去<br> RIP 真实服务器的IP</p> 
<p>步骤2：客户端访问调度器时，调度器通过网络地址转换，调度器重写请求报文的目标地址，根据预设的调度算法，将请求分派给后端的真实服务器；<br> <img src="https://images2.imgbox.com/6f/5c/3TN2MNp9_o.png" alt="在这里插入图片描述"></p> 
<p>步骤3：真实服务器的响应报文通过调度器时，报文的源地址被重写，再返回给客户，完成整个负载调度过程。<br> <img src="https://images2.imgbox.com/9a/59/aP8e1ZaL_o.png" alt="在这里插入图片描述"><br> 步骤总结及过程地址变化：<br> 1: <a href="http://xn--www-kg0fp40a0upnhy203amoa463f.example.com" rel="nofollow">客户端请求访问www.example.com</a>[<a href="http://www.example.com" rel="nofollow">www.example.com</a> ===&gt; VIP]<br> 源地址: CIP 目标地址: VIP</p> 
<pre><code>	2: 请求报文到达负载均衡器
		源地址: CIP   目标地址: RIP
		
	3: RealServer收到报文处理, 响应
		源地址: RIP		目标地址: CIP
		
	4: 负载调度器收到报文, 根据自身之前的转发修改记录, 还原报文
		源地址: VIP		目标地址: CIP
</code></pre> 
<h2><a id="4	LVSNAT_88"></a>4、 实战：配置LVS-NAT</h2> 
<p>4.1 LVS-NAT模式<br> 环境介绍:<br> 准备三台机器，关闭防火墙、selinux，清空防火墙规则<br> <img src="https://images2.imgbox.com/ff/4b/O0iSdgsM_o.png" alt="在这里插入图片描述"><br> 4.2 拓扑图<br> <img src="https://images2.imgbox.com/2a/86/y6oYmA2w_o.png" alt="在这里插入图片描述"><br> 4.3 集群各节点IP说明<br> 客户端计算机的IP（CIP）：<br> 可能是一个本地的、与VIP在同一网络的私有ip地址，或者是一个因特网上的公共ip地址。用作向集群发送请求的源ip地址</p> 
<p>虚拟IP（VIP）：<br> Director用于向客户端提供服务的ip地址<br> Director的IP（DIP）：<br> 在Director的VIP上接收访问集群服务的请求，这些请求通过DIP转发出去抵达各个集群节点</p> 
<p>真实real server IP（RIP）：<br> 在LVS术语中，向外部世界提供服务的节点叫做真实服务器，因此在真实服务器上使用的IP地址叫做真实IP地址（RIP）。</p> 
<p>4.4 配置LVS-xuegod110<br> xuegod110配置为分发器：<br> 4.4.1 开启路由转发功能<br> [root@xuegod110 ~]# vim /etc/sysctl.conf<br> net.ipv4.ip_forward = 1 #追加一行</p> 
<p>4.4.2 让配置生效<br> [root@xuegod110 ~]# sysctl -p<br> net.ipv4.ip_forward = 1</p> 
<p>4.4.3 配置网络环境<br> xuegod110需要两张网站，VIP对应的网卡模拟公网地址，通过NAT模式和客户端连接，自动获取IP地址；DIP地址和内网连接，设置为LAN1和两台真实的server连接，配置192.168.1.110<br> 具体配置不详细说明</p> 
<p>4.4.4 安装LVS管理工具<br> [root@xuegod110 ~]# yum -y install ipvsadm</p> 
<p>4.4.5 使用ipvsadm设置规则<br> [root@xuegod110 ~]# ipvsadm -A -t 192.168.174.128:80 -s rr #这里的IP地址是VIP地址<br> 参数说明：<br> -A ：添加虚拟服务器（设置分发器）<br> -t ：表示TCP服务器，后加端口号<br> -s ：指定调度的算法。rr表示round-robin轮循</p> 
<p>[root@xuegod110 ~]# ipvsadm -a -t 192.168.174.128:80 -r 192.168.1.120 -m<br> [root@xuegod110 ~]# ipvsadm -a -t 192.168.174.128:80 -r 192.168.1.130 –m<br> 参数说明：<br> -a ：表示添加real server的地址<br> -r ： 表示制定real server的地址<br> -m ：表示masquerade 也就是NAT的方式LVS</p> 
<p>4.4.6 查看<br> Ipvsadm命令，用于配置及查看内核IPVS表和算法的工具，类似于iptables<br> [root@xuegod110 ~]# ipvsadm -L –n<br> <img src="https://images2.imgbox.com/74/b5/hNcE0Zv1_o.png" alt="在这里插入图片描述"></p> 
<p>4.4.7 保存配置或规则<br> 注意：<br> 在保存规则并实现规则在开机自动生效时，前提一定需要把ipvsadm设置为开机自动启动，否则将无法实现规则开机自动生效。<br> [root@xuegod110 ~]# systemctl enable ipvsadm.service<br> [root@xuegod110 ~]# ipvsadm --save &gt; /etc/sysconfig/ipvsadm<br> 或者<br> [root@xuegod110 ~]# ipvsadm –S<br> <img src="https://images2.imgbox.com/c6/e7/8uzseaMP_o.png" alt="在这里插入图片描述"></p> 
<p>4.5 配置真实服务器<br> 4.5.1 配置网络环境<br> 两台服务器的IP地址，分别配置对应的IP地址，网关需要指定到DIP地址，这里不详细说明</p> 
<p>4.5.2 分别安装httpd服务<br> [root@xuegod120 ~]# yum -y install httpd<br> [root@xuegod130 ~]# yum -y install httpd</p> 
<p>分别在两台真实服务器中编写一个网页文件，内容不同，方便区分<br> <img src="https://images2.imgbox.com/09/b1/p74yJio9_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/fa/3e/R1Bedio7_o.png" alt="在这里插入图片描述"></p> 
<p>4.5.3 测试<br> 在分发器上使用elinks测试，先安装elinks<br> [root@xuegod110 ~]# yum -y install elinks</p> 
<p>测试真实服务器的IP地址：<br> [root@xuegod110 ~]# elinks 192.168.1.120 --dump<br> 192.168.1.120<br> [root@xuegod110 ~]# elinks 192.168.1.130 --dump<br> 192.168.1.130</p> 
<p>测试VIP地址：<br> <img src="https://images2.imgbox.com/e9/14/5xwdqUcU_o.png" alt="在这里插入图片描述"><br> 在客户端上访问测试<br> <img src="https://images2.imgbox.com/49/d9/guy8qvVx_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1a/4a/kqmnJGCo_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="	ipvsadm_180"></a>三、 扩展ipvsadm</h2> 
<p>-L -n ==&gt; 查看规则，显示内核虚拟服务器表<br> -L -n -c ==&gt; 查看客户端连接分发器和real server 的情况<br> 例1：<br> [root@xuegod110 ~]# ipvsadm -L -n -c<br> IPVS connection entries<br> pro expire state source virtual destination<br> TCP 01:36 FIN_WAIT 192.168.1.105:50082 192.168.1.63:80 192.168.2.62:80<br> TCP 01:35 TIME_WAIT 192.168.1.63:53816 192.168.1.63:80 192.168.2.64:80<br> TCP 01:27 TIME_WAIT 192.168.1.105:49978 192.168.1.63:80 192.168.2.64:80<br> TCP 01:34 TIME_WAIT 192.168.1.63:53814 192.168.1.63:80 192.168.2.62:80</p> 
<p>选项：<br> -L -n --stats ==&gt; 查看分发情况<br> -L -n --rate ==&gt; 查看速率<br> -Z --zero 虚拟服务表计数器清零（清空当前的连接数量等）</p> 
<p>例2：<br> [root@xuegod110 ~]# ipvsadm -Z<br> [root@xuegod110 ~]# ipvsadm -L -n --stats<br> IP Virtual Server version 1.2.1 (size=4096)<br> 选项：<br> -Z --clear 清空IPVS的数据、等信息</p> 
<p>例3：<br> [root@xuegod110 ~]# ipvsadm -C<br> 选项：<br> -C 清空所有规则</p> 
<p>LVS的规则配置文件：/etc/sysconfig/ipvsadm</p> 
<p>附录：ipvsadm命令选项解释：<br> -A --add-service 在内核的虚拟服务器表中添加一条新的虚拟服务器记录。也就是增加一台新的虚拟服务器。<br> -E --edit-service 编辑内核虚拟服务器表中的一条虚拟服务器记录。<br> -D --delete-service 删除内核虚拟服务器表中的一条虚拟服务器记录。<br> -C --clear 清除内核虚拟服务器表中的所有记录。<br> -R --restore 恢复虚拟服务器规则<br> -S --save 保存虚拟服务器规则，输出为-R 选项可读的格式<br> -a --add-server 在内核虚拟服务器表的一条记录里添加一条新的真实服务器记录。也就是在一个虚拟服务器中增加一台新的真实服务器<br> -e --edit-server 编辑一条虚拟服务器记录中的某条真实服务器记录<br> -d --delete-server 删除一条虚拟服务器记录中的某条真实服务器记录<br> -L|-l --list 显示内核虚拟服务器表<br> -Z --zero 虚拟服务表计数器清零（清空当前的连接数量等）<br> –set tcp tcpfin udp 设置连接超时值<br> –start-daemon 启动同步守护进程。他后面可以是master 或backup，用来说明LVS Router 是master 或是backup。在这个功能上也可以采用keepalived的VRRP 功能。<br> –stop-daemon 停止同步守护进程<br> -h --help 显示帮助信息<br> 其他的选项:<br> -t --tcp-service service-address 说明虚拟服务器提供的是tcp 的服务[vip:port] or [real-server-ip:port]<br> -u --udp-service service-address 说明虚拟服务器提供的是udp 的服务[vip:port] or [real-server-ip:port]<br> -f --fwmark-service fwmark 说明是经过iptables 标记过的服务类型。<br> -s --scheduler scheduler 使用的调度算法，有这样几个选项rr|wrr|lc|wlc|lblc|lblcr|dh|sh|sed|nq,默认的调度算法是： wlc.<br> -p --persistent [timeout] 持久稳固的服务。这个选项的意思是来自同一个客户的多次请求，将被同一台真实的服务器处理。timeout 的默认值为300 秒。<br> -M --netmask netmask persistent granularity mask<br> -r --real-server server-address 真实的服务器[Real-Server:port]<br> -g --gatewaying 指定LVS 的工作模式为直接路由模式（也是LVS 默认的模式）<br> -i --ipip 指定LVS 的工作模式为隧道模式<br> -m --masquerading 指定LVS 的工作模式为NAT 模式<br> -w --weight weight 真实服务器的权值<br> –mcast-interface interface 指定组播的同步接口<br> -c --connection 显示LVS 目前的连接 如：ipvsadm -L -c<br> –timeout 显示tcp tcpfin udp 的timeout 值 如：ipvsadm -L --timeout<br> –daemon 显示同步守护进程状态<br> –stats 显示统计信息<br> –rate 显示速率信息<br> –sort 对虚拟服务器和真实服务器排序输出<br> –numeric -n 输出IP 地址和端口的数字形式</p> 
<p>超时时间用ipvsadm --set tcp tcpfin udp设置，比如<br> #ipvsadm --set 120 20 100<br> 表示tcp空闲等待时间为120 秒<br> 客户端关闭链接等待时间为20秒<br> udp空闲等待为100秒</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a85263f9af2e3ee06b1f5c4729ca158e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">OfficeWord2007图片编辑功能使用教程(转)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cb78f9e389d26182d60307687b6afa02/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">为什么list输出是数组类型的字符串而数组却是内存地址?</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>