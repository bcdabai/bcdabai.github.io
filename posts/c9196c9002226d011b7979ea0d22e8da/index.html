<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>UNIX环境高级编程-第三版 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="UNIX环境高级编程-第三版" />
<meta property="og:description" content="Unix环境高级编程-第三版 之前学习了《Linux系统编程》对于常见的概念和函数都有了基础的认知，这里准备通过这本书，深入学习系统API相关内容。笔记内容会有所倾向，不会严格反应书本内容。
基础概念 &#43;----------&#43; |应用程序 | &#43;------&#43; | | Shell| | &#43;------&#43; | | 内核 | | &#43;------&#43; | | Libs | | &#43;------&#43;---&#43; 内核的接口称为系统调用(system call)。公用函数库(libs)建立在系统调用基础上，应用程序既可以使用公共函数库，也可以系统调用。Shell是比较特殊的应用程序，为其他程序提供一个接口。Linux是GNU操作系统使用的内核，一般称为GNU/Linux操作系统，更常见的叫法为Linux。
登陆 用户在登陆Unix系统时，输入用户名和口令，系统在口令文件/etc/passwd中查看。口令文件是由7个冒号分割的字段组成，依次是：登录名、加密口令、用户ID、数字组ID、注释字段、起始目录、Shell程序。
如：sar:x:205:105:Stephen Rago:/home/sar:/bin/ksh.目前，所有系统的加密口令移动到单独文件中了。
Shell是一个命令行解释权，它读取用户输入，然后执行命令。sh是Unix默认shell, csh是BSD默认shell, bash是sh的改进，支持csh的特色，所有Linux都有。
文件和目录 文件名的最大长度是255个字符(characters)，文件路径的最大长度是4096字符(characters)， 即可以包含16级的最大文件长度的路径。
API说明
#include &lt;sys/types.h&gt; #include &lt;dirent.h&gt; DIR *opendir(const char *name); DIR *fdopendir(int fd); struct dirent { ino_t d_ino; /* Inode number */ off_t d_off; /* Not an offset; see below */ unsigned short d_reclen; /* Length of this record */ unsigned char d_type; /* Type of file; not supported by all filesystem types */ char d_name[256]; /* Null-terminated filename */ }; struct dirent *readdir(DIR *dirp); #include &lt;unistd." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c9196c9002226d011b7979ea0d22e8da/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-12-22T16:33:15+08:00" />
<meta property="article:modified_time" content="2018-12-22T16:33:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">UNIX环境高级编程-第三版</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Unix_0"></a>Unix环境高级编程-第三版</h2> 
<p>之前学习了《Linux系统编程》对于常见的概念和函数都有了基础的认知，这里准备通过这本书，深入学习系统API相关内容。笔记内容会有所倾向，不会严格反应书本内容。</p> 
<h3><a id="_3"></a>基础概念</h3> 
<pre><code class="prism language-sh">+----------+
|应用程序   |
+------+   |
| Shell|   |
+------+   |
| 内核  |   |
+------+   |
| Libs |   |
+------+---+
</code></pre> 
<p>内核的接口称为系统调用(system call)。公用函数库(libs)建立在系统调用基础上，应用程序既可以使用公共函数库，也可以系统调用。Shell是比较特殊的应用程序，为其他程序提供一个接口。Linux是GNU操作系统使用的内核，一般称为GNU/Linux操作系统，更常见的叫法为Linux。</p> 
<h4><a id="_17"></a>登陆</h4> 
<p>用户在登陆Unix系统时，输入用户名和口令，系统在口令文件<code>/etc/passwd</code>中查看。口令文件是由7个冒号分割的字段组成，依次是：登录名、加密口令、用户ID、数字组ID、注释字段、起始目录、Shell程序。<br> 如：<code>sar:x:205:105:Stephen Rago:/home/sar:/bin/ksh</code>.目前，所有系统的加密口令移动到单独文件中了。</p> 
<p>Shell是一个命令行解释权，它读取用户输入，然后执行命令。sh是Unix默认shell, csh是BSD默认shell, bash是sh的改进，支持csh的特色，所有Linux都有。</p> 
<h4><a id="_23"></a>文件和目录</h4> 
<p>文件名的最大长度是255个字符(characters)，文件路径的最大长度是4096字符(characters)， 即可以包含16级的最大文件长度的路径。</p> 
<p>API说明</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>

DIR <span class="token operator">*</span><span class="token function">opendir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
DIR <span class="token operator">*</span><span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> dirent <span class="token punctuation">{<!-- --></span>
    ino_t          d_ino<span class="token punctuation">;</span>       <span class="token comment">/* Inode number */</span>
    off_t          d_off<span class="token punctuation">;</span>       <span class="token comment">/* Not an offset; see below */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> d_reclen<span class="token punctuation">;</span>    <span class="token comment">/* Length of this record */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  d_type<span class="token punctuation">;</span>      <span class="token comment">/* Type of file; not supported
                                    by all filesystem types */</span>
    <span class="token keyword">char</span>           d_name<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">/* Null-terminated filename */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> dirent <span class="token operator">*</span><span class="token function">readdir</span><span class="token punctuation">(</span>DIR <span class="token operator">*</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

pid_t <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pid_t <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pid_t <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>environ<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">execl</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">/* (char  *) NULL */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">/* (char  *) NULL */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">execle</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">/*, (char *) NULL, char * const envp[] */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">execv</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">execvp</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">execvpe</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">fgetc</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">fgets</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">getc</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">ungetc</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token comment">// 这一类的api都是为了让父进程等待子进程，并且获取子进程状态变化</span>
pid_t <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>wstatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
pid_t <span class="token function">waitpid</span><span class="token punctuation">(</span>pid_t pid<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>wstatus<span class="token punctuation">,</span> <span class="token keyword">int</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token keyword">int</span> errnum<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 映射消息的文本信息</span>
<span class="token keyword">void</span> <span class="token function">perror</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出一条出错消息，然后返回</span>
</code></pre> 
<p>模仿的Demo：</p> 
<pre><code class="prism language-c"><span class="token comment">/* 模拟ls */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"apue.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    DIR <span class="token operator">*</span>dp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> dirent <span class="token operator">*</span>dirp<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> argc <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">err_quit</span><span class="token punctuation">(</span><span class="token string">"usage: ls &lt;path&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>dp <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"can't open %s"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>dirp <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s -&gt; %d %d\n"</span><span class="token punctuation">,</span> dirp<span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span> dirp<span class="token operator">-&gt;</span>d_reclen<span class="token punctuation">,</span> dirp<span class="token operator">-&gt;</span>d_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">closedir</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// xls ./</span>

<span class="token comment">/* 无缓冲IO */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"apue.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> BUFFSIZE 4096</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFFSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>n<span class="token operator">=</span><span class="token function">read</span><span class="token punctuation">(</span>STDIN_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> BUFFSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token operator">!=</span>n <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"write error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>n<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"read error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// xcp &lt; in.txt &gt; out.txt</span>

<span class="token comment">/* 标准IO */</span>
<span class="token comment">// 库提供缓冲管理</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"apue.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> c<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>c<span class="token operator">=</span><span class="token function">getc</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">EOF</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">putc</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"output error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">ferror</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"input error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// xcp2 &lt; in.txt &gt; out.txt</span>

<span class="token comment">/* 类似shell功能 */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"apue.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    pid_t pid<span class="token punctuation">;</span>
    <span class="token keyword">int</span> status<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%% "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> MAXLINE<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> buf<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\n'</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            buf<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"fork_error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> pid <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// child</span>
            <span class="token function">execlp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这个实现不是很完美</span>
            <span class="token function">err_ret</span><span class="token punctuation">(</span><span class="token string">"couldn't execute: %s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// parent</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"waitpid error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>  
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%% "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_168"></a>用户组</h4> 
<p>除了用户ID和组ID，大多数Unix还允许用户属于另外其他的组，这个功能从4.2BSD开始，最多允许用户属于16个其他组。<br> 查询用户属于的组<code>cat /etc/group | grep root</code>, 分别为用户组name，用户组口令，用户组ID，用户。使用指令<code>groups</code>可获取到当前用户所在的组。</p> 
<h4><a id="_172"></a>头文件标准</h4> 
<p><strong>ISO C标准定义</strong></p> 
<table><thead><tr><th>头文件</th><th>说明</th></tr></thead><tbody><tr><td>&lt;assert.h&gt;</td><td>验证程序断言</td></tr><tr><td>&lt;complex.h&gt;</td><td>复数算术运算支持</td></tr><tr><td>&lt;ctype.h&gt;</td><td>字符分类和映射支持</td></tr><tr><td>&lt;errno.h&gt;</td><td>出错码</td></tr><tr><td>&lt;fenv.h&gt;</td><td>浮点环境</td></tr><tr><td>&lt;float.h&gt;</td><td>浮点常量及特性</td></tr><tr><td>&lt;inttypes.h&gt;</td><td>整形格式变换</td></tr><tr><td>&lt;iso646.h&gt;</td><td>赋值、关系、一元操作宏</td></tr><tr><td>&lt;limits.h&gt;</td><td>实现常量</td></tr><tr><td>&lt;locale.h&gt;</td><td>本地化类别及定义</td></tr><tr><td>&lt;math.h&gt;</td><td>数学函数、类型、常量</td></tr><tr><td>&lt;setjmp.h&gt;</td><td>非局部goto</td></tr><tr><td>&lt;signal.h&gt;</td><td>信号</td></tr><tr><td>&lt;stdarg.h&gt;</td><td>可变长度参数表</td></tr><tr><td>&lt;stdbool.h&gt;</td><td>布尔类型和值</td></tr><tr><td>&lt;stddef.h&gt;</td><td>标准定义</td></tr><tr><td>&lt;stdint.h&gt;</td><td>整形</td></tr><tr><td>&lt;stdio.h&gt;</td><td>标准IO库</td></tr><tr><td>&lt;stdlib.h&gt;</td><td>实用函数</td></tr><tr><td>&lt;string.h&gt;</td><td>字符串操作</td></tr><tr><td>&lt;tgmath.h&gt;</td><td>通用类型数学宏</td></tr><tr><td>&lt;time.h&gt;</td><td>时间和日期</td></tr><tr><td>&lt;wchar.h&gt;</td><td>扩充的多字符和宽字符支持</td></tr><tr><td>&lt;wctype.h&gt;</td><td>宽字符分类和映射支持</td></tr></tbody></table> 
<p><strong>POSIX.1标准</strong> 包含了iso c标准库</p> 
<table><thead><tr><th>头文件</th><th>说明</th></tr></thead><tbody><tr><td>&lt;aio.h&gt;</td><td>异步IO</td></tr><tr><td>&lt;cpio.h&gt;</td><td>cpio归档值</td></tr><tr><td>&lt;dirent.h&gt;</td><td>目录项</td></tr><tr><td>&lt;dlfcn.h&gt;</td><td>动态链接库</td></tr><tr><td>&lt;fcntl.h&gt;</td><td>文件控制</td></tr><tr><td>&lt;fnmatch.h&gt;</td><td>文件名匹配类型</td></tr><tr><td>&lt;glob.h&gt;</td><td>路径名模式匹配与生成</td></tr><tr><td>&lt;grp.h&gt;</td><td>组文件</td></tr><tr><td>&lt;iconv.h&gt;</td><td>代码集变换实用程序</td></tr><tr><td>&lt;langinfo.h&gt;</td><td>语言信息常量</td></tr><tr><td>&lt;monetary.h&gt;</td><td>货币类型与函数</td></tr><tr><td>&lt;netdb.h&gt;</td><td>网络数据库操作</td></tr><tr><td>&lt;nl_types.h&gt;</td><td>消息类</td></tr><tr><td>&lt;poll.h&gt;</td><td>投票函数</td></tr><tr><td>&lt;pthread.h&gt;</td><td>线程</td></tr><tr><td>&lt;pwd.h&gt;</td><td>口令文件</td></tr><tr><td>&lt;regex.h&gt;</td><td>正则表达式</td></tr><tr><td>&lt;sched.h&gt;</td><td>执行调度</td></tr><tr><td>&lt;semaphore.h&gt;</td><td>信号量</td></tr><tr><td>&lt;strings.h&gt;</td><td>字符串操作</td></tr><tr><td>&lt;tar.h&gt;</td><td>tar归档</td></tr><tr><td>&lt;termios.h&gt;</td><td>终端IO</td></tr><tr><td>&lt;unistd.h&gt;</td><td>符号常量</td></tr><tr><td>&lt;wordexp.h&gt;</td><td>字扩充类型</td></tr><tr><td>&lt;arpa/inet.h&gt;</td><td>因特网定义</td></tr><tr><td>&lt;net/if.h&gt;</td><td>套接字本地接口</td></tr><tr><td>&lt;netinet/in.h&gt;</td><td>因特网地址族</td></tr><tr><td>&lt;netinet/tcp.h&gt;</td><td>传输协议定义</td></tr><tr><td>&lt;sys/mman.h&gt;</td><td>存储管理</td></tr><tr><td>&lt;sys/select.h&gt;</td><td>select函数</td></tr><tr><td>&lt;sys/socket.h&gt;</td><td>套接字接口</td></tr><tr><td>&lt;sys/stat.h&gt;</td><td>文件状态</td></tr><tr><td>&lt;sys/statvfs.h&gt;</td><td>文件系统信息</td></tr><tr><td>&lt;sys/times.h&gt;</td><td>进程时间</td></tr><tr><td>&lt;sys/types.h&gt;</td><td>基本系统数据类型</td></tr><tr><td>&lt;sys/un.h&gt;</td><td>UNIX套接字定义</td></tr><tr><td>&lt;sys/utsname.h&gt;</td><td>系统名</td></tr><tr><td>&lt;sys/wait.h&gt;</td><td>进程控制</td></tr></tbody></table> 
<p><strong>POSIX.1 2008 可选头文件</strong></p> 
<table><thead><tr><th>头文件</th><th>说明</th></tr></thead><tbody><tr><td>&lt;fmtmsg.h&gt;</td><td>消息显示结构</td></tr><tr><td>&lt;ftw.h&gt;</td><td>文件树漫游</td></tr><tr><td>&lt;libgen.h&gt;</td><td>路径名管理函数</td></tr><tr><td>&lt;ndbm.h&gt;</td><td>数据库操作</td></tr><tr><td>&lt;search.h&gt;</td><td>搜索表</td></tr><tr><td>&lt;syslog.h&gt;</td><td>系统出错日志记录</td></tr><tr><td>&lt;utmpx.h&gt;</td><td>用户账户数据库</td></tr><tr><td>&lt;sys/ipc.h&gt;</td><td>IPC</td></tr><tr><td>&lt;sys/msg.h&gt;</td><td>XSI消息队列</td></tr><tr><td>&lt;sys/resource.h&gt;</td><td>资源操作</td></tr><tr><td>&lt;sys/sem.h&gt;</td><td>XSI信号量</td></tr><tr><td>&lt;sys/shm.h&gt;</td><td>XSI共享存储</td></tr><tr><td>&lt;sys/time.h&gt;</td><td>时间类型</td></tr><tr><td>&lt;sys/uio.h&gt;</td><td>矢量IO操作</td></tr><tr><td>&lt;mqueue.h&gt;</td><td>消息队列</td></tr><tr><td>&lt;spawn.h&gt;</td><td>实时spawn接口</td></tr></tbody></table> 
<h3><a id="IO_264"></a>IO</h3> 
<p>IO操作是所有操作中最常用的一个，一般只需要5个函数<code>open/read/write/lseek/close</code>，这些函数都是不带缓冲的IO。实际使用时，更多时候需要使用<code>dup/fcntl/sync/fsync/ioctl</code>配合使用。</p> 
<p>文件IO基础操作比较简单，不做说明。</p> 
<p>特殊的，当fork等手段产生多个进程读写同一文件时，会导致数据丢失或者异常，为此，设计了原子性操作函数：<code>pread/pwrite</code>，作用等同lseek然后read/write，但是这个过程不会被打断。</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">dup</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">dup2</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 等效于 dcntl(fd, F_DUPFD, 0), dup是原子操作</span>

<span class="token comment">// sync/fsync/fdatasync </span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* arg */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 改变fd的属性</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">ioctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> request<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// IO杂物箱，其他函数不能做的都要它来做</span>

</code></pre> 
<p>因为大部分情况下，针对串口、摄像头等设备，都需要使用ioctl设置参数，所以，这里需要注意ioctl的request参数，它根据设备不同，参数也不同。</p> 
<table><thead><tr><th>类别</th><th>常量名</th><th>头文件</th><th>ioctl数</th></tr></thead><tbody><tr><td>盘标号</td><td>DIOxxx</td><td>&lt;sys/disklabel.h&gt;</td><td>4</td></tr><tr><td>文件IO</td><td>FIOxxx</td><td>&lt;sys/fileio.h&gt;</td><td>14</td></tr><tr><td>磁带IO</td><td>MTIOxxx</td><td>&lt;sys/mtio.h&gt;</td><td>11</td></tr><tr><td>套接字IO</td><td>SIOxxx</td><td>&lt;sys/sockio.h&gt;</td><td>73</td></tr><tr><td>终端IO</td><td>TIOxxx</td><td>&lt;sys/ttycom.h&gt;</td><td>43</td></tr></tbody></table> 
<p><code>/dev/fd/x</code>等价与复制描述符n。</p> 
<h4><a id="_299"></a>文件和目录</h4> 
<p>之前了解了基础的IO操作，这里主要关注文件系统和文件的性质。</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">stat</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">struct</span> stat <span class="token operator">*</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">fstat</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> stat <span class="token operator">*</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">lstat</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">struct</span> stat <span class="token operator">*</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span>           </span><span class="token comment">/* Definition of AT_* constants */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">fstatat</span><span class="token punctuation">(</span><span class="token keyword">int</span> dirfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">struct</span> stat <span class="token operator">*</span>statbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> stat <span class="token punctuation">{<!-- --></span>
    dev_t     st_dev<span class="token punctuation">;</span>         <span class="token comment">/* ID of device containing file */</span>
    ino_t     st_ino<span class="token punctuation">;</span>         <span class="token comment">/* Inode number */</span>
    mode_t    st_mode<span class="token punctuation">;</span>        <span class="token comment">/* File type and mode */</span>
    nlink_t   st_nlink<span class="token punctuation">;</span>       <span class="token comment">/* Number of hard links */</span>
    uid_t     st_uid<span class="token punctuation">;</span>         <span class="token comment">/* User ID of owner */</span>
    gid_t     st_gid<span class="token punctuation">;</span>         <span class="token comment">/* Group ID of owner */</span>
    dev_t     st_rdev<span class="token punctuation">;</span>        <span class="token comment">/* Device ID (if special file) */</span>
    off_t     st_size<span class="token punctuation">;</span>        <span class="token comment">/* Total size, in bytes */</span>
    blksize_t st_blksize<span class="token punctuation">;</span>     <span class="token comment">/* Block size for filesystem I/O */</span>
    blkcnt_t  st_blocks<span class="token punctuation">;</span>      <span class="token comment">/* Number of 512B blocks allocated */</span>

    <span class="token comment">/* Since Linux 2.6, the kernel supports nanosecond
        precision for the following timestamp fields.
        For the details before Linux 2.6, see NOTES. */</span>

    <span class="token keyword">struct</span> timespec st_atim<span class="token punctuation">;</span>  <span class="token comment">/* Time of last access */</span>
    <span class="token keyword">struct</span> timespec st_mtim<span class="token punctuation">;</span>  <span class="token comment">/* Time of last modification */</span>
    <span class="token keyword">struct</span> timespec st_ctim<span class="token punctuation">;</span>  <span class="token comment">/* Time of last status change */</span>

<span class="token macro property">#<span class="token directive keyword">define</span> st_atime st_atim.tv_sec      </span><span class="token comment">/* Backward compatibility */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> st_mtime st_mtim.tv_sec</span>
<span class="token macro property">#<span class="token directive keyword">define</span> st_ctime st_ctim.tv_sec</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>这类函数都返回文件的信息结构。其中，文件类型可以通过对st_mode宏<code>S_ISREG/S_ISDIR/S_ISCHR/S_ISBLK/S_ISFIFO/S_ISLNK/S_ISSOCK</code> 判断文件类型。在IPC中对整个结构体判断IPC对象类型<code>S_TYPEISMQ/S_TYPEISSEM/S_TYPEISSHM</code>.</p> 
<p>st_mode中也保存了对文件的访问权限位。除了常见的权限，其实每个文件都有9个访问权限。</p> 
<table><thead><tr><th>st_mode屏蔽</th><th>含义</th></tr></thead><tbody><tr><td>S_IRUSR</td><td>用户读</td></tr><tr><td>S_IWUSR</td><td>用户写</td></tr><tr><td>S_IXUSR</td><td>用户执行</td></tr><tr><td>S_IRGRP</td><td>组读</td></tr><tr><td>S_IWGRP</td><td>组写</td></tr><tr><td>S_IXGRP</td><td>组执行</td></tr><tr><td>S_IROTH</td><td>其他读</td></tr><tr><td>S_IWOTH</td><td>其他写</td></tr><tr><td>S_IXOTH</td><td>其他执行</td></tr></tbody></table> 
<p>当create文件或者目录时，默认使用进程的有效用户ID和组ID，如果想要测试是否有权限，如下：</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">access</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 如果需要改变权限，如下</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">chmod</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> mode_t mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">fchmod</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> mode_t mode<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 改变用户ID或者组ID</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">chown</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> uid_t owner<span class="token punctuation">,</span> gid_t group<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">fchown</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> uid_t owner<span class="token punctuation">,</span> gid_t group<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">lchown</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> uid_t owner<span class="token punctuation">,</span> gid_t group<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 文件截断</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">truncate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> off_t length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">ftruncate</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> off_t length<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 链接</span>
<span class="token keyword">int</span> <span class="token function">link</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>oldpath<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>newpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通用文件与文件夹</span>

<span class="token keyword">int</span> <span class="token function">rename</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>oldpath<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>newpath<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">symlink</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>target<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>linkpath<span class="token punctuation">)</span><span class="token punctuation">;</span>

ssize_t <span class="token function">readlink</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t bufsiz<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 文件</span>
<span class="token comment">// st_atim 访问时间/st_mtim 内容修改时间/st_ctim 属性更改时间</span>
<span class="token keyword">int</span> <span class="token function">futimens</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> timespec times<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">utimensat</span><span class="token punctuation">(</span><span class="token keyword">int</span> dirfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> timespec times<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 目录</span>
<span class="token keyword">int</span> <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> mode_t mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">rmdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;dirent.h&gt;</span></span>
DIR <span class="token operator">*</span><span class="token function">opendir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
DIR <span class="token operator">*</span><span class="token function">fdopendir</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> dirent <span class="token operator">*</span><span class="token function">readdir</span><span class="token punctuation">(</span>DIR <span class="token operator">*</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">rewinddir</span><span class="token punctuation">(</span>DIR <span class="token operator">*</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">closedir</span><span class="token punctuation">(</span>DIR <span class="token operator">*</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> <span class="token function">telldir</span><span class="token punctuation">(</span>DIR <span class="token operator">*</span>dirp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">seekdir</span><span class="token punctuation">(</span>DIR <span class="token operator">*</span>dirp<span class="token punctuation">,</span> <span class="token keyword">long</span> loc<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">fchdir</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getwd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">get_current_dir_name</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h4><a id="FILE_415"></a>流和FILE对象</h4> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;wchar.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">fwide</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置流的定向，决定是单字符还是宽字符模式</span>
<span class="token keyword">void</span> <span class="token function">setbuf</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>restrict stream<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>restrict buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改缓冲机制</span>
<span class="token keyword">int</span> <span class="token function">setvbuf</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>restrict stream<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>restrict buf<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">fflush</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 强制冲洗一个流</span>
fopen<span class="token operator">/</span>freopen<span class="token operator">/</span>fdopen <span class="token comment">// 打开、重新打开、获取描述符</span>
<span class="token keyword">int</span> <span class="token function">fclose</span><span class="token punctuation">(</span>FILE<span class="token operator">*</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭一个流</span>

getc<span class="token operator">/</span>fgetc<span class="token operator">/</span>getchar <span class="token comment">// 一次读取一个字节</span>
ferror<span class="token operator">/</span>feof <span class="token comment">// 获取流错误码</span>
clearerr <span class="token comment">// 清除错误码</span>
ungetc <span class="token comment">// 将字符压回流</span>
putc<span class="token operator">/</span>fputc<span class="token operator">/</span>putchar <span class="token comment">// 输出一个字符</span>

fgets<span class="token operator">/</span>gets <span class="token comment">// 读取一行</span>
fputs<span class="token operator">/</span>puts <span class="token comment">// 写入一串数据，不一定是一行</span>

fread<span class="token operator">/</span>fwrite <span class="token comment">// 读写二进制数据</span>

ftell<span class="token operator">/</span>fseek<span class="token operator">/</span>rwind<span class="token operator">/</span>fgetpos<span class="token operator">/</span>fsetpos <span class="token comment">// 读、写指针位置</span>

printf<span class="token operator">/</span>sprintf<span class="token operator">/</span>fprintf<span class="token operator">/</span>dpintf<span class="token operator">/</span>snprintf <span class="token comment">// 格式化io</span>
vprintf<span class="token operator">/</span>vfprintf<span class="token operator">/</span>vdprintf<span class="token operator">/</span>vsprintf<span class="token operator">/</span>vsnprintf <span class="token comment">// 可变参数的</span>
<span class="token comment">// %[flags][fldwidth][precision][lenmodifier]convtype</span>

<span class="token comment">// 百分号后跟随字符意义 flags</span>
<span class="token comment">// , 整数按照千分位分组</span>
<span class="token comment">// - 左对齐</span>
<span class="token comment">// + 总是显示正负号</span>
<span class="token comment">//   如果第一个字符不是正负号，则添加一个空格</span>
<span class="token comment">// # 指定另一种转换形式，比如16进制加0x</span>
<span class="token comment">// 0 添加前导0填充，不使用空格</span>

<span class="token comment">// lenmodifier 参数长度</span>
<span class="token comment">// hh (u)char 类型长度</span>
<span class="token comment">// h  (u)short</span>
<span class="token comment">// l  (u)long</span>
<span class="token comment">// ll  (u)long long</span>
<span class="token comment">// j  (u)intmax_t</span>
<span class="token comment">// z  size_t</span>
<span class="token comment">// t  ptrdiff_t</span>
<span class="token comment">// L  long double</span>

<span class="token comment">// convtype 如何解释参数</span>
<span class="token comment">// d,i  有符号10进制</span>
<span class="token comment">// o  无符号八进制</span>
<span class="token comment">// u  无符号十进制</span>
<span class="token comment">// x,X  无符号16进制</span>
<span class="token comment">// f,F  双精度浮点</span>
<span class="token comment">// e,E  指数格式双精度</span>
<span class="token comment">// g,G  解释为f/F/e/E</span>
<span class="token comment">// a,A  16进制指数格式双精度</span>
<span class="token comment">// c  字符，lc是宽字符</span>
<span class="token comment">// s  字符串，ls是宽字符串</span>
<span class="token comment">// p  void指针</span>
<span class="token comment">// n  printf输出字符数目写入到带符号整数中</span>
<span class="token comment">// %  %自身</span>
<span class="token comment">// C  宽字符，=lc</span>
<span class="token comment">// S  宽字符串，=ls</span>

<span class="token comment">// convtype 还存在显式指定第n个参数的格式化，%n$,与上面的不能同时使用</span>

scanf<span class="token operator">/</span>fscanf<span class="token operator">/</span>sscanf <span class="token comment">// 格式化输入</span>
<span class="token comment">// %[*][fldwidth][m][lenmodifier]convtype</span>
<span class="token comment">// d  有符号10进制</span>
<span class="token comment">// i  有符号10进制,基数由输入格式确定</span>
<span class="token comment">// o  无符号八进制</span>
<span class="token comment">// u  有符号十进制，基数10</span>
<span class="token comment">// x,X  无符号16进制</span>
<span class="token comment">// f,F  双精度浮点</span>
<span class="token comment">// e,E  指数格式双精度</span>
<span class="token comment">// g,G  解释为f/F/e/E</span>
<span class="token comment">// a,A  16进制指数格式双精度</span>
<span class="token comment">// c  字符，lc是宽字符</span>
<span class="token comment">// s  字符串，ls是宽字符串</span>
<span class="token comment">// p  void指针</span>
<span class="token comment">// n  printf输出字符数目写入到带符号整数中</span>
<span class="token comment">// %  %自身</span>
<span class="token comment">// C  宽字符，=lc</span>
<span class="token comment">// S  宽字符串，=ls</span>
<span class="token comment">// [ 匹配列出的字符序列，以]结束</span>
<span class="token comment">// [^ 匹配列出字符以外的序列，以]终止</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%2$.2f %1$4.2d -%3$n\n"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3.2567</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%*s%d\n"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// %n$ 从1开始，指明第几个参数</span>
<span class="token comment">// %n 指定一个uint地址，存储%n所在位置的序号</span>
<span class="token comment">// %*s 需要2个参数，第一个是类似fildwidth,第二个是%s的值，效果与%.2f类似</span>

<span class="token keyword">int</span> <span class="token function">fileno</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">tmpnam</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 产生一个与现有文件名不同的有效路径名字符串，最多TMP_MAX</span>
FILE <span class="token operator">*</span><span class="token function">tmpfile</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 产生一个临时二进制文件(wb+)，关闭或程序结束是自动删除</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">mkdtemp</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 与上述不同的是，产生的临时文件不会主动删除，需要自己unlink</span>
<span class="token keyword">int</span> <span class="token function">mkstemp</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">mkostemp</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>template<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">mkstemps</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>template<span class="token punctuation">,</span> <span class="token keyword">int</span> suffixlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">mkostemps</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>template<span class="token punctuation">,</span> <span class="token keyword">int</span> suffixlen<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 内存流</span>
FILE <span class="token operator">*</span><span class="token function">fmemopen</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>

FILE <span class="token operator">*</span><span class="token function">open_memstream</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>ptr<span class="token punctuation">,</span> size_t <span class="token operator">*</span>sizeloc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;wchar.h&gt;</span></span>
FILE <span class="token operator">*</span><span class="token function">open_wmemstream</span><span class="token punctuation">(</span>wchar_t <span class="token operator">*</span><span class="token operator">*</span>ptr<span class="token punctuation">,</span> size_t <span class="token operator">*</span>sizeloc<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_535"></a>系统数据文件</h4> 
<pre><code class="prism language-c"><span class="token comment">// /etc/passwd</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pwd.h&gt;</span></span>
<span class="token keyword">struct</span> passwd <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span>   <span class="token operator">*</span>pw_name<span class="token punctuation">;</span>       <span class="token comment">/* username */</span>
    <span class="token keyword">char</span>   <span class="token operator">*</span>pw_passwd<span class="token punctuation">;</span>     <span class="token comment">/* user password */</span>
    uid_t   pw_uid<span class="token punctuation">;</span>        <span class="token comment">/* user ID */</span>
    gid_t   pw_gid<span class="token punctuation">;</span>        <span class="token comment">/* group ID */</span>
    <span class="token keyword">char</span>   <span class="token operator">*</span>pw_gecos<span class="token punctuation">;</span>      <span class="token comment">/* user information */</span>
    <span class="token keyword">char</span>   <span class="token operator">*</span>pw_dir<span class="token punctuation">;</span>        <span class="token comment">/* home directory */</span>
    <span class="token keyword">char</span>   <span class="token operator">*</span>pw_shell<span class="token punctuation">;</span>      <span class="token comment">/* shell program */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> passwd <span class="token operator">*</span><span class="token function">getpwnam</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> passwd <span class="token operator">*</span><span class="token function">getpwuid</span><span class="token punctuation">(</span>uid_t uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> passwd <span class="token operator">*</span><span class="token function">getpwent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">setpwent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">endpwent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// demo</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pwd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> passwd<span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>ptr <span class="token operator">=</span> <span class="token function">getpwent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"U/P:%s %s \nID:%d %d \nI:%s \nDIR:%s \nSHELL:%s\n"</span><span class="token punctuation">,</span>
			ptr<span class="token operator">-&gt;</span>pw_name<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>pw_passwd<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>pw_uid<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>pw_gid<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>pw_gecos<span class="token punctuation">,</span>
			ptr<span class="token operator">-&gt;</span>pw_dir<span class="token punctuation">,</span> ptr<span class="token operator">-&gt;</span>pw_shell<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-----------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">endpwent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在.etc/passwd 中，用户密码都是x，因为它被移到单独的文件/etc/shadow中，并且加密了，阴影口令文件</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;shadow.h&gt;</span></span>
<span class="token keyword">struct</span> spwd <span class="token punctuation">{<!-- --></span>                                                  
    <span class="token keyword">char</span> <span class="token operator">*</span>sp_namp<span class="token punctuation">;</span>     <span class="token comment">/* Login name */</span>                        
    <span class="token keyword">char</span> <span class="token operator">*</span>sp_pwdp<span class="token punctuation">;</span>     <span class="token comment">/* Encrypted password */</span>                
    <span class="token keyword">long</span>  sp_lstchg<span class="token punctuation">;</span>   <span class="token comment">/* Date of last change                  
                          (measured in days since              
                          1970-01-01 00:00:00 +0000 (UTC)) */</span>  
    <span class="token keyword">long</span>  sp_min<span class="token punctuation">;</span>      <span class="token comment">/* Min # of days between changes */</span>     
    <span class="token keyword">long</span>  sp_max<span class="token punctuation">;</span>      <span class="token comment">/* Max # of days between changes */</span>     
    <span class="token keyword">long</span>  sp_warn<span class="token punctuation">;</span>     <span class="token comment">/* # of days before password expires    
                          to warn user to change it */</span>         
    <span class="token keyword">long</span>  sp_inact<span class="token punctuation">;</span>    <span class="token comment">/* # of days after password expires     
                          until account is disabled */</span>         
    <span class="token keyword">long</span>  sp_expire<span class="token punctuation">;</span>   <span class="token comment">/* Date when account expires            
                          (measured in days since              
                          1970-01-01 00:00:00 +0000 (UTC)) */</span>  
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sp_flag<span class="token punctuation">;</span>  <span class="token comment">/* Reserved */</span>                     
<span class="token punctuation">}</span><span class="token punctuation">;</span>                                                             
<span class="token keyword">struct</span> spwd <span class="token operator">*</span><span class="token function">getspnam</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> spwd <span class="token operator">*</span><span class="token function">getspent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">setspent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">endspent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> spwd <span class="token operator">*</span><span class="token function">fgetspent</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> spwd <span class="token operator">*</span><span class="token function">sgetspent</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">putspent</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> spwd <span class="token operator">*</span>p<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">lckpwdf</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">ulckpwdf</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">crypt</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>salt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 密码hash, -lcrypt</span>
<span class="token comment">// demo, 可以验证自己的密码</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _GNU_SOURCE</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;crypt.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span><span class="token operator">*</span> pT1 <span class="token operator">=</span> <span class="token function">crypt</span><span class="token punctuation">(</span><span class="token string">"my_pwd"</span><span class="token punctuation">,</span> <span class="token string">"$6$tFoDYuJAMie9hU/s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> pT1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 组文件 /etc/group</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;grp.h&gt;</span></span>
<span class="token keyword">struct</span> group <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span>   <span class="token operator">*</span>gr_name<span class="token punctuation">;</span>        <span class="token comment">/* group name */</span>
    <span class="token keyword">char</span>   <span class="token operator">*</span>gr_passwd<span class="token punctuation">;</span>      <span class="token comment">/* group password */</span>
    gid_t   gr_gid<span class="token punctuation">;</span>         <span class="token comment">/* group ID */</span>
    <span class="token keyword">char</span>  <span class="token operator">*</span><span class="token operator">*</span>gr_mem<span class="token punctuation">;</span>         <span class="token comment">/* NULL-terminated array of pointers
                                to names of group members */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> group <span class="token operator">*</span><span class="token function">getgrnam</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> group <span class="token operator">*</span><span class="token function">getgrgid</span><span class="token punctuation">(</span>gid_t gid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> group <span class="token operator">*</span><span class="token function">getgrent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">setgrent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">endgrent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 4.2BSD 开始，用户有附属组ID</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;grp.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">getgroups</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">,</span> gid_t list<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">setgroups</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">,</span> <span class="token keyword">const</span> gid_t <span class="token operator">*</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">initgroups</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>user<span class="token punctuation">,</span> gid_t group<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>其他数据文件：<br> BSD各网络服务器提供服务的数据文件<code>/etc/services</code>,记录协议信息的<code>/etc/protocols</code>,记录网络信息的<code>/etc/networks</code>…</p> 
<p>系统标志：</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/utsname.h&gt;</span></span>
<span class="token keyword">struct</span> utsname <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">char</span> sysname<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* Operating system name (e.g., "Linux") */</span>
   <span class="token keyword">char</span> nodename<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">/* Name within "some implementation-defined
                           network" */</span>
   <span class="token keyword">char</span> release<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* Operating system release (e.g., "2.6.28") */</span>
   <span class="token keyword">char</span> version<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* Operating system version */</span>
   <span class="token keyword">char</span> machine<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* Hardware identifier */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">uname</span><span class="token punctuation">(</span><span class="token keyword">struct</span> utsname <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// cat /etc/lsb-release</span>
<span class="token comment">/*
Linux 
xinvm
4.15.0-39-generic
#42-Ubuntu SMP Tue Oct 23 15:48:01 UTC 2018
x86_64
*/</span>
<span class="token keyword">int</span> <span class="token function">gethostname</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sethostname</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>时间：</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token keyword">struct</span> tm <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> tm_sec<span class="token punctuation">;</span>    <span class="token comment">/* Seconds (0-60) */</span>
    <span class="token keyword">int</span> tm_min<span class="token punctuation">;</span>    <span class="token comment">/* Minutes (0-59) */</span>
    <span class="token keyword">int</span> tm_hour<span class="token punctuation">;</span>   <span class="token comment">/* Hours (0-23) */</span>
    <span class="token keyword">int</span> tm_mday<span class="token punctuation">;</span>   <span class="token comment">/* Day of the month (1-31) */</span>
    <span class="token keyword">int</span> tm_mon<span class="token punctuation">;</span>    <span class="token comment">/* Month (0-11) */</span>
    <span class="token keyword">int</span> tm_year<span class="token punctuation">;</span>   <span class="token comment">/* Year - 1900 */</span>
    <span class="token keyword">int</span> tm_wday<span class="token punctuation">;</span>   <span class="token comment">/* Day of the week (0-6, Sunday = 0) */</span>
    <span class="token keyword">int</span> tm_yday<span class="token punctuation">;</span>   <span class="token comment">/* Day in the year (0-365, 1 Jan = 0) */</span>
    <span class="token keyword">int</span> tm_isdst<span class="token punctuation">;</span>  <span class="token comment">/* Daylight saving time */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">asctime</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> tm <span class="token operator">*</span>tm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">asctime_r</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> tm <span class="token operator">*</span>tm<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">ctime</span><span class="token punctuation">(</span><span class="token keyword">const</span> time_t <span class="token operator">*</span>timep<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">ctime_r</span><span class="token punctuation">(</span><span class="token keyword">const</span> time_t <span class="token operator">*</span>timep<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> tm <span class="token operator">*</span><span class="token function">gmtime</span><span class="token punctuation">(</span><span class="token keyword">const</span> time_t <span class="token operator">*</span>timep<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> tm <span class="token operator">*</span><span class="token function">gmtime_r</span><span class="token punctuation">(</span><span class="token keyword">const</span> time_t <span class="token operator">*</span>timep<span class="token punctuation">,</span> <span class="token keyword">struct</span> tm <span class="token operator">*</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> tm <span class="token operator">*</span><span class="token function">localtime</span><span class="token punctuation">(</span><span class="token keyword">const</span> time_t <span class="token operator">*</span>timep<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> tm <span class="token operator">*</span><span class="token function">localtime_r</span><span class="token punctuation">(</span><span class="token keyword">const</span> time_t <span class="token operator">*</span>timep<span class="token punctuation">,</span> <span class="token keyword">struct</span> tm <span class="token operator">*</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

time_t <span class="token function">mktime</span><span class="token punctuation">(</span><span class="token keyword">struct</span> tm <span class="token operator">*</span>tm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 将时间格式化为字符串，把字符串转化为time_t</span>
size_t <span class="token function">strftime</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> size_t max<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> tm <span class="token operator">*</span>tm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">strptime</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token keyword">struct</span> tm <span class="token operator">*</span>tm<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_695"></a>进程</h3> 
<p>进程终止有5中正常行为：</p> 
<ul><li>main返回</li><li>exit调用</li><li>_exit/_Exit调用</li><li>最后一个线程返回</li><li>最后一个线程调用pthread_exit</li></ul> 
<p>异常终止有3中方式：</p> 
<ul><li>abort调用</li><li>接到一个信号</li><li>最后一个线程读取消请求做出相应</li></ul> 
<p>一个进程可以最多登记32个函数，当exit时自动调用，这些函数称之为终止处理程序，他们通过<code>atexit</code>函数注册。调用与登记的顺序相反。</p> 
<p>参数表：<code>int main(int argc, char* argv[])</code>（一般第一个是自身，第二个开始正常使用，最后一个是NULL）<br> 环境表：<code>extern char **environ;</code> 最后一个字符串指针是NULL。name=value形式存储.</p> 
<pre><code class="prism language-c"><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">putenv</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">,</span> <span class="token keyword">int</span> overwrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">unsetenv</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">clearenv</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>存储空间分配：</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">malloc</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">calloc</span><span class="token punctuation">(</span>size_t nmemb<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">realloc</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">reallocarray</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> size_t nmemb<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>C语言中，goto是不能跨越函数的，所以有了<code>setjmp/longjmp</code>.</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;setjmp.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">setjmp</span><span class="token punctuation">(</span>jmp_buf env<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置跳转点环境</span>
<span class="token keyword">int</span> <span class="token function">sigsetjmp</span><span class="token punctuation">(</span>sigjmp_buf env<span class="token punctuation">,</span> <span class="token keyword">int</span> savesigs<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">longjmp</span><span class="token punctuation">(</span>jmp_buf env<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 跳转，全局、静态、易逝变量保持不变</span>
<span class="token keyword">void</span> <span class="token function">siglongjmp</span><span class="token punctuation">(</span>sigjmp_buf env<span class="token punctuation">,</span> <span class="token keyword">int</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>资源限制：<code>getrlimit/setrlimit</code></p> 
<p>exec系列函数</p> 
<p>解释器文件(interpreter file)：<br> 文本文件起始行：<code>#! pathname [optional-args]</code></p> 
<p><code>int system(const char *command);</code> // 内部实现了fork/exec/waitpid</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">getlogin</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">getlogin_r</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t bufsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">cuserid</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">nice</span><span class="token punctuation">(</span><span class="token keyword">int</span> inc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调整nice值</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/resource.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">getpriority</span><span class="token punctuation">(</span><span class="token keyword">int</span> which<span class="token punctuation">,</span> id_t who<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">setpriority</span><span class="token punctuation">(</span><span class="token keyword">int</span> which<span class="token punctuation">,</span> id_t who<span class="token punctuation">,</span> <span class="token keyword">int</span> prio<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/times.h&gt;</span></span>
clock_t <span class="token function">times</span><span class="token punctuation">(</span><span class="token keyword">struct</span> tms <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进程时间</span>
</code></pre> 
<p>进程组，每个进程除了有进程ID还有一个进程组。同一进程组中的各个进程接收来自同一终端的各种信号。</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">setpgid</span><span class="token punctuation">(</span>pid_t pid<span class="token punctuation">,</span> pid_t pgid<span class="token punctuation">)</span><span class="token punctuation">;</span>
pid_t <span class="token function">getpgid</span><span class="token punctuation">(</span>pid_t pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

pid_t <span class="token function">getpgrp</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">/* POSIX.1 version */</span>
pid_t <span class="token function">getpgrp</span><span class="token punctuation">(</span>pid_t pid<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">/* BSD version */</span>

<span class="token keyword">int</span> <span class="token function">setpgrp</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">/* System V version */</span>
<span class="token keyword">int</span> <span class="token function">setpgrp</span><span class="token punctuation">(</span>pid_t pid<span class="token punctuation">,</span> pid_t pgid<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* BSD version */</span>
</code></pre> 
<p>会话是多个进程组的集合。使用<code>setsid</code>创建一个新的会话。</p> 
<p>会话和进程组还有一些其他特性：</p> 
<ul><li>一个会话可以有一个控制终端，它通常是终端设备或者伪终端设备。</li><li>建立与终端连接会话的首进程称为控制进程。</li><li>一个会话中的几个进程组可分为一个前台进程组以及多个后台进程组。</li><li>如果会话有一个控制终端，则它由一个前台进程组，其他的都为后台进程组。</li><li>无论何时键入终端中断键（Delete/Ctrl+C），都会中断信号发送到前台进程组所有进程。</li><li>如果终端检测到网络或者连接断开，则挂断信号发送到所有控制进程。</li></ul> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
pid_t <span class="token function">tcgetpgrp</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">tcsetpgrp</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> pid_t pgrp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> _XOPEN_SOURCE 500        </span><span class="token comment">/* See feature_test_macros(7) */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;termios.h&gt;</span></span>
pid_t <span class="token function">tcgetsid</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>信号：</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>sighandler_t<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sighandler_t <span class="token function">signal</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">,</span> sighandler_t handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">kill</span><span class="token punctuation">(</span>pid_t pid<span class="token punctuation">,</span> <span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送信号给pid， &lt;0 是发送给进程组</span>
<span class="token keyword">int</span> <span class="token function">raise</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送信号给自身</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送定时器信息,由内核产生信号</span>
<span class="token keyword">int</span> <span class="token function">pause</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 进程挂起，直到收到一个信号，并且执行了信号处理函数并返回</span>

<span class="token keyword">int</span> <span class="token function">sigemptyset</span><span class="token punctuation">(</span>sigset_t <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sigfillset</span><span class="token punctuation">(</span>sigset_t <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sigaddset</span><span class="token punctuation">(</span>sigset_t <span class="token operator">*</span>set<span class="token punctuation">,</span> <span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sigdelset</span><span class="token punctuation">(</span>sigset_t <span class="token operator">*</span>set<span class="token punctuation">,</span> <span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sigismember</span><span class="token punctuation">(</span><span class="token keyword">const</span> sigset_t <span class="token operator">*</span>set<span class="token punctuation">,</span> <span class="token keyword">int</span> signum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sigprocmask</span><span class="token punctuation">(</span><span class="token keyword">int</span> how<span class="token punctuation">,</span> <span class="token keyword">const</span> sigset_t <span class="token operator">*</span>set<span class="token punctuation">,</span> sigset_t <span class="token operator">*</span>oldset<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token keyword">int</span> <span class="token function">sigpending</span><span class="token punctuation">(</span>sigset_t <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sigsuspend</span><span class="token punctuation">(</span><span class="token keyword">const</span> sigset_t <span class="token operator">*</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sigaction</span><span class="token punctuation">(</span><span class="token keyword">int</span> signum<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> sigaction <span class="token operator">*</span>act<span class="token punctuation">,</span> <span class="token keyword">struct</span> sigaction <span class="token operator">*</span>oldact<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">nanosleep</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> timespec <span class="token operator">*</span>req<span class="token punctuation">,</span> <span class="token keyword">struct</span> timespec <span class="token operator">*</span>rem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">clock_nanosleep</span><span class="token punctuation">(</span>clockid_t clock_id<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">struct</span> timespec <span class="token operator">*</span>request<span class="token punctuation">,</span> <span class="token keyword">struct</span> timespec <span class="token operator">*</span>remain<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">psignal</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// print signal info</span>
<span class="token keyword">void</span> <span class="token function">psiginfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> siginfo_t <span class="token operator">*</span>pinfo<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// print signal info</span>

<span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> sys_siglist<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 信号名称与编号的映射数组</span>
</code></pre> 
<h3><a id="_839"></a>线程</h3> 
<p>线程接口也称之为<code>pthread</code>或者<code>POSIX线程</code>。</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span> </span><span class="token comment">// link with -pthread</span>

<span class="token keyword">int</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span>pthread_t <span class="token operator">*</span>thread<span class="token punctuation">,</span> <span class="token keyword">const</span> pthread_attr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>start_routine<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
pthread_t <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_equal</span><span class="token punctuation">(</span>pthread_t t1<span class="token punctuation">,</span> pthread_t t2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>pthread_t thread<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_cancel</span><span class="token punctuation">(</span>pthread_t thread<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送取消指令，不等待完成</span>
<span class="token keyword">void</span> <span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>routine<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 退出时清理函数</span>
<span class="token keyword">void</span> <span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token keyword">int</span> execute<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_detach</span><span class="token punctuation">(</span>pthread_t thread<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 清理，之后不能使用join</span>

<span class="token comment">// demo1 </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

pthread_t ntid<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">printids</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> s<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    pid_t pid<span class="token punctuation">;</span>
    pthread_t tid<span class="token punctuation">;</span>
    pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tid <span class="token operator">=</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s pid %u tid %lu (0x%lx) \n"</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>pid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>tid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thr_fn</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">printids</span><span class="token punctuation">(</span><span class="token string">"new thread:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ntid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> thr_fn<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> err <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"can't create thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printids</span><span class="token punctuation">(</span><span class="token string">"main thread:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Demo 2</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;ctype.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> handle_error_en(en, msg) \
    do { errno = en; perror(msg); exit(EXIT_FAILURE); } while (0)</span>

<span class="token macro property">#<span class="token directive keyword">define</span> handle_error(msg) \
    do { perror(msg); exit(EXIT_FAILURE); } while (0)</span>

<span class="token keyword">struct</span> thread_info <span class="token punctuation">{<!-- --></span>    <span class="token comment">/* Used as argument to thread_start() */</span>
    pthread_t thread_id<span class="token punctuation">;</span>        <span class="token comment">/* ID returned by pthread_create() */</span>
    <span class="token keyword">int</span>       thread_num<span class="token punctuation">;</span>       <span class="token comment">/* Application-defined thread # */</span>
    <span class="token keyword">char</span>     <span class="token operator">*</span>argv_string<span class="token punctuation">;</span>      <span class="token comment">/* From command-line argument */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* Thread start function: display address near top of our stack,
  and return upper-cased copy of argv_string */</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_start</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> thread_info <span class="token operator">*</span>tinfo <span class="token operator">=</span> arg<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>uargv<span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread %d: top of stack near %p; argv_string=%s\n"</span><span class="token punctuation">,</span>
           tinfo<span class="token operator">-&gt;</span>thread_num<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token punctuation">,</span> tinfo<span class="token operator">-&gt;</span>argv_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    uargv <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>tinfo<span class="token operator">-&gt;</span>argv_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>uargv <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token function">handle_error</span><span class="token punctuation">(</span><span class="token string">"strdup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> uargv<span class="token punctuation">;</span> <span class="token operator">*</span>p <span class="token operator">!=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">toupper</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> uargv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> s<span class="token punctuation">,</span> tnum<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> num_threads<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> thread_info <span class="token operator">*</span>tinfo<span class="token punctuation">;</span>
    pthread_attr_t attr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> stack_size<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
    
    <span class="token comment">/* The "-s" option specifies a stack size for our threads */</span>
    
    stack_size <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>opt <span class="token operator">=</span> <span class="token function">getopt</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"s:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>opt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token string">'s'</span><span class="token punctuation">:</span>
            stack_size <span class="token operator">=</span> <span class="token function">strtoul</span><span class="token punctuation">(</span>optarg<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
            
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Usage: %s [-s stack-size] arg...\n"</span><span class="token punctuation">,</span>
                    argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    num_threads <span class="token operator">=</span> argc <span class="token operator">-</span> optind<span class="token punctuation">;</span>
    
    <span class="token comment">/* Initialize thread creation attributes */</span>
    
    s <span class="token operator">=</span> <span class="token function">pthread_attr_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">handle_error_en</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"pthread_attr_init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stack_size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        s <span class="token operator">=</span> <span class="token function">pthread_attr_setstacksize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">,</span> stack_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">handle_error_en</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"pthread_attr_setstacksize"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* Allocate memory for pthread_create() arguments */</span>
    
    tinfo <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span>num_threads<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> thread_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tinfo <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token function">handle_error</span><span class="token punctuation">(</span><span class="token string">"calloc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* Create one thread for each command-line argument */</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span>tnum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tnum <span class="token operator">&lt;</span> num_threads<span class="token punctuation">;</span> tnum<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        tinfo<span class="token punctuation">[</span>tnum<span class="token punctuation">]</span><span class="token punctuation">.</span>thread_num <span class="token operator">=</span> tnum <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        tinfo<span class="token punctuation">[</span>tnum<span class="token punctuation">]</span><span class="token punctuation">.</span>argv_string <span class="token operator">=</span> argv<span class="token punctuation">[</span>optind <span class="token operator">+</span> tnum<span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token comment">/* The pthread_create() call stores the thread ID into
          corresponding element of tinfo[] */</span>
        
        s <span class="token operator">=</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tinfo<span class="token punctuation">[</span>tnum<span class="token punctuation">]</span><span class="token punctuation">.</span>thread_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr<span class="token punctuation">,</span>
                           <span class="token operator">&amp;</span>thread_start<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tinfo<span class="token punctuation">[</span>tnum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">handle_error_en</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"pthread_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* Destroy the thread attributes object, since it is no
      longer needed */</span>
    
    s <span class="token operator">=</span> <span class="token function">pthread_attr_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">handle_error_en</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"pthread_attr_destroy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* Now join with each thread, and display its returned value */</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span>tnum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tnum <span class="token operator">&lt;</span> num_threads<span class="token punctuation">;</span> tnum<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        s <span class="token operator">=</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span>tinfo<span class="token punctuation">[</span>tnum<span class="token punctuation">]</span><span class="token punctuation">.</span>thread_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">handle_error_en</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"pthread_join"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Joined with thread %d; returned value was %s\n"</span><span class="token punctuation">,</span>
               tinfo<span class="token punctuation">[</span>tnum<span class="token punctuation">]</span><span class="token punctuation">.</span>thread_num<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">/* Free memory allocated by thread */</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">free</span><span class="token punctuation">(</span>tinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>进程原语与线程原语十分相似，这里做一个对比：</p> 
<table><thead><tr><th>进程原语</th><th>线程原语</th><th>描述</th></tr></thead><tbody><tr><td>fork</td><td>pthread_create</td><td>创建新的控制流</td></tr><tr><td>exit</td><td>pthread_exit</td><td>从现有的控制流退出</td></tr><tr><td>waitpid</td><td>pthread_join</td><td>从控制流中得到退出状态</td></tr><tr><td>atexit</td><td>pthread_cleanup_push</td><td>注册退出控制流时的函数</td></tr><tr><td>getpid</td><td>pthread_self</td><td>获取控制流ID</td></tr><tr><td>abort</td><td>pthread_cancel</td><td>请求控制流的非正常退出</td></tr></tbody></table> 
<p>线程同步：</p> 
<pre><code class="prism language-c"><span class="token comment">// 互斥锁</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span>pthread_mutex_t <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 动态分配必须destroy</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span>pthread_mutex_t <span class="token operator">*</span>restrict mutex<span class="token punctuation">,</span> <span class="token keyword">const</span> pthread_mutexattr_t <span class="token operator">*</span>restrict attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
pthread_mutex_t mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span> <span class="token comment">// 静态分配</span>

<span class="token keyword">int</span> <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>pthread_mutex_t <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutex_trylock</span><span class="token punctuation">(</span>pthread_mutex_t <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>pthread_mutex_t <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">pthread_mutex_timedlock</span><span class="token punctuation">(</span>pthread_mutex_t <span class="token operator">*</span>restrict mutex<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> timespec <span class="token operator">*</span>restrict abstime<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 读写锁</span>
<span class="token keyword">int</span> <span class="token function">pthread_rwlock_init</span><span class="token punctuation">(</span>pthread_rwlock_t <span class="token operator">*</span>rwlock<span class="token punctuation">,</span> <span class="token keyword">const</span> pthread_rwlockattr_t <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_rwlock_destroy</span><span class="token punctuation">(</span>pthread_rwlock_t <span class="token operator">*</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
pthread_rwlock_t rwlock<span class="token operator">=</span>PTHREAD_RWLOCK_INITIALIZER<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">pthread_rwlock_rdlock</span><span class="token punctuation">(</span>pthread_rwlock_t <span class="token operator">*</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_rwlock_tryrdlock</span><span class="token punctuation">(</span>pthread_rwlock_t <span class="token operator">*</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_rwlock_wrlock</span><span class="token punctuation">(</span>pthread_rwlock_t <span class="token operator">*</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_rwlock_unlock</span><span class="token punctuation">(</span>pthread_rwlock_t <span class="token operator">*</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">pthread_rwlock_timedrdlock</span><span class="token punctuation">(</span>pthread_rwlock_t <span class="token operator">*</span>restrict rwlock<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> timespec <span class="token operator">*</span>restrict abstime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_rwlock_timedwrlock</span><span class="token punctuation">(</span>pthread_rwlock_t <span class="token operator">*</span>restrict rwlock<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> timespec <span class="token operator">*</span>restrict abstime<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 条件变量</span>
<span class="token keyword">int</span> <span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span>pthread_cond_t <span class="token operator">*</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span>pthread_cond_t <span class="token operator">*</span>restrict cond<span class="token punctuation">,</span> <span class="token keyword">const</span> pthread_condattr_t <span class="token operator">*</span>restrict attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
pthread_cond_t cond <span class="token operator">=</span> PTHREAD_COND_INITIALIZER<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">pthread_cond_timedwait</span><span class="token punctuation">(</span>pthread_cond_t <span class="token operator">*</span>restrict cond<span class="token punctuation">,</span> pthread_mutex_t <span class="token operator">*</span>restrict mutex<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> timespec <span class="token operator">*</span>restrict abstime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span>pthread_cond_t <span class="token operator">*</span>restrict cond<span class="token punctuation">,</span> pthread_mutex_t <span class="token operator">*</span>restrict mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span>pthread_cond_t <span class="token operator">*</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span>pthread_cond_t <span class="token operator">*</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 自旋锁</span>
<span class="token comment">// 自旋锁与互斥量类似，但是不通过休眠阻塞，而是在获取锁之前一直处于忙等（自旋）阻塞状态，它一般用于：锁持有时间短，而且线程不想再重新调度上花太多成本。</span>
pthread_spin_init<span class="token operator">/</span>destroy<span class="token operator">/</span>lock<span class="token operator">/</span>trylock<span class="token operator">/</span>unlock

<span class="token comment">// 屏蔽</span>
<span class="token comment">// 屏蔽barrier是用户协调多个线程并行工作的同步机制，屏蔽允许每个线程等待，直到所有线程到达某个点。</span>
pthread_barrier_init<span class="token operator">/</span>destroy<span class="token operator">/</span>wait
</code></pre> 
<p>线程中的属性：</p> 
<pre><code class="prism language-c"><span class="token comment">// 线程属性</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_init</span><span class="token punctuation">(</span>pthread_attr_t <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_destroy</span><span class="token punctuation">(</span>pthread_attr_t <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_setdetachstate</span><span class="token punctuation">(</span>pthread_attr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">int</span> detachstate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_getdetachstate</span><span class="token punctuation">(</span><span class="token keyword">const</span> pthread_attr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>detachstate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_setstack</span><span class="token punctuation">(</span>pthread_attr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>stackaddr<span class="token punctuation">,</span> size_t stacksize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_getstack</span><span class="token punctuation">(</span><span class="token keyword">const</span> pthread_attr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>stackaddr<span class="token punctuation">,</span> size_t <span class="token operator">*</span>stacksize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_setstacksize</span><span class="token punctuation">(</span>pthread_attr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> size_t stacksize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_getstacksize</span><span class="token punctuation">(</span><span class="token keyword">const</span> pthread_attr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> size_t <span class="token operator">*</span>stacksize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_setguardsize</span><span class="token punctuation">(</span>pthread_attr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> size_t guardsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_attr_getguardsize</span><span class="token punctuation">(</span><span class="token keyword">const</span> pthread_attr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> size_t <span class="token operator">*</span>guardsize<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 同步属性</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutexattr_destroy</span><span class="token punctuation">(</span>pthread_mutexattr_t <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutexattr_init</span><span class="token punctuation">(</span>pthread_mutexattr_t <span class="token operator">*</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutexattr_getpshared</span><span class="token punctuation">(</span><span class="token keyword">const</span> pthread_mutexattr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>pshared<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutexattr_setpshared</span><span class="token punctuation">(</span>pthread_mutexattr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">int</span> pshared<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutexattr_getrobust</span><span class="token punctuation">(</span><span class="token keyword">const</span> pthread_mutexattr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>robustness<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutexattr_setrobust</span><span class="token punctuation">(</span><span class="token keyword">const</span> pthread_mutexattr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">int</span> robustness<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">pthread_mutexattr_gettype</span><span class="token punctuation">(</span><span class="token keyword">const</span> pthread_mutexattr_t <span class="token operator">*</span>restrict attr<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>restrict type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutexattr_settype</span><span class="token punctuation">(</span>pthread_mutexattr_t <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 更改锁状态</span>

<span class="token comment">// 读写锁属性</span>
pthread_rwlockattr_init<span class="token operator">/</span>destory<span class="token operator">/</span>setpshared<span class="token operator">/</span>getpshared

<span class="token comment">// 条件变量属性</span>
pthread_condattr_init<span class="token operator">/</span>destory<span class="token operator">/</span>setpshared<span class="token operator">/</span>getpshared<span class="token operator">/</span>setclock<span class="token operator">/</span>getclock

<span class="token comment">// 屏蔽属性</span>
pthread_barrierattr_init<span class="token operator">/</span>destory<span class="token operator">/</span>setpshared<span class="token operator">/</span>getpshared


<span class="token comment">// 线程安全方式管理FILE对象</span>
<span class="token keyword">void</span> <span class="token function">flockfile</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>filehandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">ftrylockfile</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>filehandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">funlockfile</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>filehandle<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">getc_unlocked</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">getchar_unlocked</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">putc_unlocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">putchar_unlocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">clearerr_unlocked</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">feof_unlocked</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">ferror_unlocked</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">fileno_unlocked</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">fflush_unlocked</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">fgetc_unlocked</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">fputc_unlocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
size_t <span class="token function">fread_unlocked</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> size_t n<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
size_t <span class="token function">fwrite_unlocked</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> size_t n<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">fgets_unlocked</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">fputs_unlocked</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// wchar版本省略</span>
</code></pre> 
<p>线程特定数据：<br> 默认情况下，所有的数据是共享的，我们期望没个线程改变自己特定的数据而不影响其他线程。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">pthread_key_create</span><span class="token punctuation">(</span>pthread_key_t <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>destructor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_key_delete</span><span class="token punctuation">(</span>pthread_key_t key<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pthread_getspecific</span><span class="token punctuation">(</span>pthread_key_t key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_setspecific</span><span class="token punctuation">(</span>pthread_key_t key<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
       
<span class="token keyword">int</span> <span class="token function">pthread_once</span><span class="token punctuation">(</span>pthread_once_t <span class="token operator">*</span>once_control<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>init_routine<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pthread_once_t once_control <span class="token operator">=</span> PTHREAD_ONCE_INIT<span class="token punctuation">;</span>
</code></pre> 
<p>创建的键存储在keyp指向的内存中，这个键可以被进程中的所有线程使用，但是每个线程把这个键与不同的线程特定数据地址关联。通过specific函数设置关联内容。<br> 如果每个线程都调用<code>pthread_once</code>,系统就能保证对<code>init_routine</code>只调用一次。</p> 
<p><strong>线程与信号</strong><br> 每个线程都有自己的信号屏蔽字，但是信号的处理是进程中所有线程共享的。进程的信号是投递到单个线程的，如果一个信号与硬件故障有关，则该信号会被发送到引起该事件的线程中，而其他信号被发送到任意线程中。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">pthread_sigmask</span><span class="token punctuation">(</span><span class="token keyword">int</span> how<span class="token punctuation">,</span> <span class="token keyword">const</span> sigset_t <span class="token operator">*</span>set<span class="token punctuation">,</span> sigset_t <span class="token operator">*</span>oldset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sigwait</span><span class="token punctuation">(</span><span class="token keyword">const</span> sigset_t <span class="token operator">*</span>set<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>sig<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 多个线程同时等待则由操作系统决定</span>
<span class="token keyword">int</span> <span class="token function">pthread_kill</span><span class="token punctuation">(</span>pthread_t thread<span class="token punctuation">,</span> <span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>线程与Fork</strong><br> 当线程调用fork，则为子进程创建了整个进程地址空间的副本，在子进程内部只存在一个线程，它是由父进程中调用fork的线程副本构成的。<br> fork后的子线程与父线程共享锁等内容，为避免死锁等，子进程fork后可以立即调用exec函数中一个，这样旧的地址空间会被丢弃。<br> 在多线程中，为避免不一致的问题，POSIX声明，在fork返回和子进程调用exec函数之间，子进程只能带哦用一部信号安全的函数。<br> 要清除锁状态，可以通过<code>pthread_atfork</code>函数处理fork后程序。</p> 
<p><strong>线程与IO</strong><br> 多线程环境下，<code>pread/pwrite</code>函数是很有用的，因为进程公用相同的文件描述符，多线程同时读写就可以变为原子操作。</p> 
<h3><a id="_1160"></a>守护进程</h3> 
<p>守护进程是生存周期长的一种进程，常在系统引导时启动，系统关闭时终止，他们没有终端，只在后台运行。<br> <code>ps -axj</code></p> 
<ul><li>父进程ID为0的是内核进程，系统引导时启动。他们放在方括号名字中。</li><li>进程ID=1通常是init，它是系统守护进程，主要负责启动特定的系统服务。</li><li>rpcbind是提供rpc服务，将程序号映射为网络端口号的服务。</li><li>inetd侦听系统网络接口，取得来自网络的对各种网络服务进程的请求。</li><li>nfsd,nfsiod,lockd,rpciod,rpc.idmapd,rpc.statd,rpc.mountd提供NFS文件系统支持。</li><li>cron是定期安排命令执行。</li><li>cupsd是打印假脱机服务</li><li>sshd是远程登陆和执行服务</li></ul> 
<p>创建一个守护进程：</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;syslog.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/resource.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span>fd0<span class="token punctuation">,</span>fd1<span class="token punctuation">,</span>fd2<span class="token punctuation">;</span>
    pid_t pid<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> rlimit r1<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sigaction sa<span class="token punctuation">;</span>
    <span class="token comment">// 1. clear file creation mask</span>
    <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. Get Maximum number of file description</span>
    <span class="token function">getrlimit</span><span class="token punctuation">(</span>RLIMIT_NOFILE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. Become a seesion leader to lose tty</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span> pid <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// parent process exit</span>
    <span class="token punctuation">}</span>
    <span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* ensure future opens won't allocate controlling ttys */</span>
	
    <span class="token comment">// 4. change current working directory</span>
    <span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. close all opened file description</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> rl<span class="token punctuation">.</span>rlim_max <span class="token operator">==</span> RLIM_INFINITY <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        rl<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rl<span class="token punctuation">.</span>rlim_max<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token punctuation">}</span>
    <span class="token comment">// 6. attach 0,1,2 to /dev/null</span>
    fd0 <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/null"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fd1 <span class="token operator">=</span> <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fd2 <span class="token operator">=</span> <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 7. init log file</span>
    <span class="token function">openlog</span><span class="token punctuation">(</span><span class="token string">"xxxx"</span><span class="token punctuation">,</span>LOG_CONS<span class="token punctuation">,</span> LOG_DAEMON<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>单例守护进程：<br> 每个守护进程创建一个固定名字的文件，并且在这个文件上加锁，那么只允许创建一个这样的锁。其他进程再尝试都会失败，这就可以保证只有一个副本运行。</p> 
<p>一些遵循的惯例：</p> 
<ul><li>若使用锁文件，一般在<code>/var/run/xxx.pid</code>。</li><li>若支持配置文件，一般在<code>/etc/xxx.conf</code>.</li><li>守护进程可使用命令行启动，它脚本一般在<code>/etc/rc*或/etc/init.d/*</code></li><li>守护进程启动时读取配置，中途配置改变时，一般不处理。一般使用SIGHUP重读配置。</li></ul> 
<p>系统日志：</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;syslog.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">openlog</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ident<span class="token punctuation">,</span> <span class="token keyword">int</span> option<span class="token punctuation">,</span> <span class="token keyword">int</span> facility<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">syslog</span><span class="token punctuation">(</span><span class="token keyword">int</span> priority<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">closelog</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="IO_1239"></a>高级IO</h3> 
<p>非阻塞IO、记录锁、IO多路转接(select/poll)，异步IO、readv/writev、存储映射IO(mmap)。</p> 
<p>非阻塞IO： <code>flags = fcntl(fd,F_GETFL,0); flags |= O_NONBLOCK; fcntl(fd,F_SETFL,flags);</code><br> 记录锁：当程序使用文件某部分时，阻止其他进程修改同一区域。 <code>fcntl F_RDLCK/F_WRLCLK/F_UNLCK</code><br> IO多路转接：</p> 
<ul><li>select/pselect 告诉内核我们关心的描述符和条件，等待select返回，告诉我们哪个描述符哪个条件好了。</li></ul> 
<pre><code class="prism language-c"><span class="token comment">/* According to POSIX.1-2001, POSIX.1-2008 */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>

<span class="token comment">/* According to earlier standards */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> nfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> timeval <span class="token operator">*</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">FD_CLR</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>  <span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">FD_SET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">FD_ZERO</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">pselect</span><span class="token punctuation">(</span><span class="token keyword">int</span> nfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> timespec <span class="token operator">*</span>timeout<span class="token punctuation">,</span> <span class="token keyword">const</span> sigset_t <span class="token operator">*</span>sigmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>poll与select类似，但是将条件聚合为数组，每个元素指明我们感兴趣的文件描述符和条件</li></ul> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> pollfd <span class="token operator">*</span>fds<span class="token punctuation">,</span> nfds_t nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> _GNU_SOURCE         </span><span class="token comment">/* See feature_test_macros(7) */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">ppoll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> pollfd <span class="token operator">*</span>fds<span class="token punctuation">,</span> nfds_t nfds<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> timespec <span class="token operator">*</span>tmo_p<span class="token punctuation">,</span> <span class="token keyword">const</span> sigset_t <span class="token operator">*</span>sigmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>异步IO：系统不告诉我们描述符的状态，需要我们主动查询。</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;aio.h&gt;</span> </span><span class="token comment">// Link with -lrt</span>
<span class="token keyword">int</span> <span class="token function">aio_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> aiocb <span class="token operator">*</span>aiocbp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">aio_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> aiocb <span class="token operator">*</span>aiocbp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">aio_fsync</span><span class="token punctuation">(</span><span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">struct</span> aiocb <span class="token operator">*</span>aiocbp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">aio_error</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> aiocb <span class="token operator">*</span>aiocbp<span class="token punctuation">)</span><span class="token punctuation">;</span>
aio_return<span class="token operator">/</span>suspend<span class="token operator">/</span>cancel<span class="token operator">/</span>listio
</code></pre> 
<p>readv/writev: 散步度、聚集写</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/uio.h&gt;</span></span>
ssize_t <span class="token function">readv</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> iovec <span class="token operator">*</span>iov<span class="token punctuation">,</span> <span class="token keyword">int</span> iovcnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t <span class="token function">writev</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> iovec <span class="token operator">*</span>iov<span class="token punctuation">,</span> <span class="token keyword">int</span> iovcnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t <span class="token function">preadv</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> iovec <span class="token operator">*</span>iov<span class="token punctuation">,</span> <span class="token keyword">int</span> iovcnt<span class="token punctuation">,</span> off_t offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t <span class="token function">pwritev</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> iovec <span class="token operator">*</span>iov<span class="token punctuation">,</span> <span class="token keyword">int</span> iovcnt<span class="token punctuation">,</span> off_t offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t <span class="token function">preadv2</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> iovec <span class="token operator">*</span>iov<span class="token punctuation">,</span> <span class="token keyword">int</span> iovcnt<span class="token punctuation">,</span> off_t offset<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t <span class="token function">pwritev2</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> iovec <span class="token operator">*</span>iov<span class="token punctuation">,</span> <span class="token keyword">int</span> iovcnt<span class="token punctuation">,</span> off_t offset<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>存储映射IO：将磁盘文件映射到缓冲上，读写缓冲就相当于读写文件。</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> size_t length<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> off_t offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">munmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> size_t length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">mprotect</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> size_t len<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 更改映射权限</span>
<span class="token keyword">int</span> <span class="token function">pkey_mprotect</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> size_t len<span class="token punctuation">,</span> <span class="token keyword">int</span> prot<span class="token punctuation">,</span> <span class="token keyword">int</span> pkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">msync</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> size_t length<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 刷洗缓冲区到文件</span>
</code></pre> 
<h3><a id="IPC_1305"></a>IPC</h3> 
<p>管道、FIFO、XSI、消息队列、共享存储、套接字<br> 管道：<br> 历史上是半双工的，只能在由公共父进程的之间使用。</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">pipe</span><span class="token punctuation">(</span><span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> _GNU_SOURCE             </span><span class="token comment">/* See feature_test_macros(7) */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span>              </span><span class="token comment">/* Obtain O_* constant definitions */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">pipe2</span><span class="token punctuation">(</span><span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

FILE <span class="token operator">*</span><span class="token function">popen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个pipe然后fork执行cmdstring</span>
<span class="token keyword">int</span> <span class="token function">pclose</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>FIFO:<br> 命名管道，未命名的管道只能在相关进程中使用，但是FIFO可以在不相关的进程中使用。</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> mode_t mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>XSI: (消息队列、信号量、共享存储)<br> <code>msgget/msgctl/msgsnd/msgrcv/semget/semctl/semop/shmget/shmctl/shmat/shmdt/sem_open/sem_close/sem_unlink/sem_wait/set_post/sem_init/sem_getvalue/</code></p> 
<p>Socket:<br> 只有socket在进程间通信模型中可以跨计算机和网络。</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> how<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Name                Purpose                          Man page</span>
<span class="token comment">// AF_UNIX, AF_LOCAL   Local communication              unix(7)</span>
<span class="token comment">// AF_INET             IPv4 Internet protocols          ip(7)</span>
<span class="token comment">// AF_INET6            IPv6 Internet protocols          ipv6(7)</span>
<span class="token comment">// AF_IPX              IPX - Novell protocols</span>
<span class="token comment">// AF_NETLINK          Kernel user interface device     netlink(7)</span>
<span class="token comment">// AF_X25              ITU-T X.25 / ISO-8208 protocol   x25(7)</span>
<span class="token comment">// AF_AX25             Amateur radio AX.25 protocol</span>
<span class="token comment">// AF_ATMPVC           Access to raw ATM PVCs</span>
<span class="token comment">// AF_APPLETALK        AppleTalk                        ddp(7)</span>
<span class="token comment">// AF_PACKET           Low level packet interface       packet(7)</span>
<span class="token comment">// AF_ALG              Interface to kernel crypto API</span>

<span class="token comment">// SOCK_STREAM     Provides sequenced, reliable, two-way, connection-based byte streams.   An  out-</span>
<span class="token comment">//                of-band data transmission mechanism may be supported.</span>
<span class="token comment">// </span>
<span class="token comment">// SOCK_DGRAM      Supports  datagrams  (connectionless,  unreliable  messages  of  a fixed maximum</span>
<span class="token comment">//                length).</span>
<span class="token comment">// </span>
<span class="token comment">// SOCK_SEQPACKET  Provides a sequenced, reliable, two-way connection-based data transmission  path</span>
<span class="token comment">//                for  datagrams of fixed maximum length; a consumer is required to read an entire</span>
<span class="token comment">//                packet with each input system call.</span>
<span class="token comment">// </span>
<span class="token comment">// SOCK_RAW        Provides raw network protocol access.</span>
<span class="token comment">// </span>
<span class="token comment">// SOCK_RDM        Provides a reliable datagram layer that does not guarantee ordering.</span>
<span class="token comment">// </span>
<span class="token comment">// SOCK_PACKET     Obsolete and should not be used in new programs; see packet(7).</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
uint32_t <span class="token function">htonl</span><span class="token punctuation">(</span>uint32_t hostlong<span class="token punctuation">)</span><span class="token punctuation">;</span>
uint16_t <span class="token function">htons</span><span class="token punctuation">(</span>uint16_t hostshort<span class="token punctuation">)</span><span class="token punctuation">;</span>
uint32_t <span class="token function">ntohl</span><span class="token punctuation">(</span>uint32_t netlong<span class="token punctuation">)</span><span class="token punctuation">;</span>
uint16_t <span class="token function">ntohs</span><span class="token punctuation">(</span>uint16_t netshort<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntop</span><span class="token punctuation">(</span><span class="token keyword">int</span> af<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> socklen_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span><span class="token keyword">int</span> af<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 地址查询，主机数据库</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> h_errno<span class="token punctuation">;</span>
<span class="token keyword">struct</span> hostent <span class="token operator">*</span><span class="token function">gethostbyname</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span>       </span><span class="token comment">/* for AF_INET */</span>
<span class="token keyword">struct</span> hostent <span class="token operator">*</span><span class="token function">gethostbyaddr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> socklen_t len<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">sethostent</span><span class="token punctuation">(</span><span class="token keyword">int</span> stayopen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">endhostent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">herror</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">hstrerror</span><span class="token punctuation">(</span><span class="token keyword">int</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//host相关函数认为过时了，使用net替代</span>
<span class="token keyword">int</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>hints<span class="token punctuation">,</span> <span class="token keyword">struct</span> addrinfo <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">struct</span> addrinfo <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">getnameinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>addr<span class="token punctuation">,</span> socklen_t addrlen<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> socklen_t hostlen<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>serv<span class="token punctuation">,</span> socklen_t servlen<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> netent <span class="token operator">*</span><span class="token function">getnetent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> netent <span class="token operator">*</span><span class="token function">getnetbyname</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> netent <span class="token operator">*</span><span class="token function">getnetbyaddr</span><span class="token punctuation">(</span>uint32_t net<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">setnetent</span><span class="token punctuation">(</span><span class="token keyword">int</span> stayopen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">endnetent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> protoent <span class="token operator">*</span><span class="token function">getprotoent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> protoent <span class="token operator">*</span><span class="token function">getprotobyname</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> protoent <span class="token operator">*</span><span class="token function">getprotobynumber</span><span class="token punctuation">(</span><span class="token keyword">int</span> proto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">setprotoent</span><span class="token punctuation">(</span><span class="token keyword">int</span> stayopen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">endprotoent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> servent <span class="token operator">*</span><span class="token function">getservent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> servent <span class="token operator">*</span><span class="token function">getservbyname</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>proto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> servent <span class="token operator">*</span><span class="token function">getservbyport</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>proto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">setservent</span><span class="token punctuation">(</span><span class="token keyword">int</span> stayopen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">endservent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 端口号小于1024需要sudo权限</span>
<span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>my_addr<span class="token punctuation">,</span> socklen_t addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">getsockname</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>addr<span class="token punctuation">,</span> socklen_t <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 本机地址</span>
<span class="token keyword">int</span> <span class="token function">getpeername</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>addr<span class="token punctuation">,</span> socklen_t <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对方地址</span>
<span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>addr<span class="token punctuation">,</span> socklen_t addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>addr<span class="token punctuation">,</span> socklen_t <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> size_t len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 仅用于tcp</span>
<span class="token keyword">int</span> <span class="token function">sendto</span><span class="token punctuation">(</span><span class="token keyword">int</span>  s<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> size_t len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>to<span class="token punctuation">,</span> socklen_t tolen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sendmsg</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> msghdr <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t <span class="token function">recv</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t <span class="token function">recvfrom</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>src_addr<span class="token punctuation">,</span> socklen_t <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t <span class="token function">recvmsg</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> msghdr <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">getsockopt</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">int</span> optname<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>optval<span class="token punctuation">,</span> socklen_t <span class="token operator">*</span>optlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">int</span> optname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>optval<span class="token punctuation">,</span> socklen_t optlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>UNIX域套接字：<br> UNIX域套接字用于在同一台计算机上运行的进程间通信。它比Socket效率更高。它提供流和数据报表两种接口，就像是Socket与Pipe的混合。</p> 
<pre><code class="prism language-c"><span class="token function">socket</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">socketpair</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">,</span> <span class="token keyword">int</span> sv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="IOTTY_1437"></a>终端IO（TTY）</h3> 
<p><code>termios.h</code></p> 
<table><thead><tr><th>函数</th><th>说明</th></tr></thead><tbody><tr><td>isatty</td><td>是否是TTY</td></tr><tr><td>tcgetattr</td><td>获取属性</td></tr><tr><td>tcsetattr</td><td>设置属性</td></tr><tr><td>cfgetispeed</td><td>获取输入速度(波特率)</td></tr><tr><td>cfgetospeed</td><td>获取输出速度(波特率)</td></tr><tr><td>cfsetispeed</td><td>设置输入速度</td></tr><tr><td>cfsetospeed</td><td>设置输出速度</td></tr><tr><td>tcdrain</td><td>等待所有输出都被传输</td></tr><tr><td>tcflow</td><td>挂起传输或者接收</td></tr><tr><td>tcflush</td><td>冲洗未决输入输出</td></tr><tr><td>tcsendbreak</td><td>发送break字符</td></tr><tr><td>tcgetpgrp</td><td>获取前台进程组ID</td></tr><tr><td>tcsetpgrp</td><td>设置前台进程组ID</td></tr><tr><td>tcgetsid</td><td>得到控制TTY会话进程组ID</td></tr></tbody></table> 
<pre><code class="prism language-c">getpass <span class="token comment">// 读入用户在终端上键入的口令</span>
<span class="token function">ioctl</span><span class="token punctuation">(</span>TIOCGWINSZ<span class="token punctuation">)</span> <span class="token comment">// 终端大小， TIOCSWINSZ 设置大小</span>
</code></pre> 
<p><strong>伪终端</strong><br> 网络登陆服务器、窗口系统终端模拟、script程序、expect程序、运行协同进程…<br> <code>posix_openpt/grantpt/ptsname/unlockpt</code><br> ``</p> 
<h3><a id="_1465"></a>数据库</h3> 
<p>dbm在Unix系统中很流行，BSD扩充为ndbm。4.4BSD提供了一个新的库db。</p> 
<h3><a id="_1468"></a>网络打印机</h3> 
<p>IPP是网络打印机的通信规则。IPP建立在HTTP上。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/27900843c721f92f618f0e2bcdb0b5fc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Slf4j获取日志对象(Logger)的实现分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5fe0c653fd3ab055a5003f318b09ee1d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">nginx中部署vue前端项目</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>