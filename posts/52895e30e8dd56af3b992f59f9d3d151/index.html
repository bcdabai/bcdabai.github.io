<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringCloudAlibaba 2021.0.1.0 版本整合分布式事务Seata - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringCloudAlibaba 2021.0.1.0 版本整合分布式事务Seata" />
<meta property="og:description" content="事务简介 事务（Transaction）是访问并可能更新数据库中各种数据项的一个程序执行单元。在关系数据库中，一个事务由一组SQL语句组成。事务应该具有四个属性：原子性、一致性、隔离性、持久性。这四个属性通常称为ACID特性。
原子性（atomicity）：一个事务是一个不可分割的工作单位，事务中包括各种操作，要么都做，要么都不做。
一致性（consistency）：事务必须是使数据库从一个一致性状态变到另一个一致性状态，事务的中间状态不能被观察到的。
隔离性（isolation）：一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发其他事务是隔离的，并发执行的各个事务之间不能互相干扰。隔离性又分为四个级别：读未提交（read uncommitted）、读已提交（read committed，解决脏读）、可重复读（repeatable read，解决幻读）、串行化（serializable，解决幻读）。
持久性（durability）：持久性也成为永久性（permanence），指一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。接下来其他操作或故障不应该对其他有任何影响。
任何事务机制在实现时，都应该考虑事务的ACID特性，包括：本地事务、分布式事务，及时不能都很好的满足，也要考虑支持到什么程度。
本地事务 @Transational
大多数据场景下，我的应用都只需要操作单一的数据库，这种情况下的事务成为本地事务（Local Transaction）。本地事务的ACID特性是数据库直接提供支持的。
1.Seata是什么？ Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。
官网：https://seata.io/zh-cn/docs/overview/what-is-seata.html
源码：https://github.com/seata/seata
GitHub - seata/seata-samples: seata-samples
1.1 Seata的三大角色 在Seata的架构中，一共有三个角色：
TC（Transaction Coordinator）- 事务协调者
维护全局和分支事务的状态，驱动全局事务提交和回滚。
TM（Transaction Manager）- 事务管理器
定义全局的事务的范围：开始全局事务、提交或回滚全局事务。
RM（Resource Manager）- 资源管理器
管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。
其中，TC为单独部署的Server服务端，TM和RM为嵌入到应用中的Client客户端。
1.2常用分布式事务解决方案 Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。
seata 阿里分布式事务框架消息队列sagaXA 四种分布式事务
Seata AT 模式（auto transaction）
AT模式是一种无侵入的分布式事务解决方案
●一阶段：
在一阶段，Seata会拦截“业务SQL”，首先解析SQL语义，找到“业务SQL”要更新的业务数据，在业务数据被更新前，将其保存成“before image”，然后执行“业务SQL”更新业务数据，在业务数据更新之后，再将其保存“afger image”，最后生成行锁。以上操作全部再一个数据库事务内完成，这样保证了一阶段操作的原子性。
●二阶段提交
二阶段如果是提交的话，因为“业务SQL”在一阶段已经提交至数据库，所以Seata框架只需将一阶段保存的快照数据和行锁删掉，完成数据清理。
●二阶段回滚
二阶段如果是回滚的话，Seata就需要回滚一阶段已经执行的“业务SQL”，还原业务数据。回滚方式是使用“before image”还原业务数据；但在还原前首先要校验脏写，对比“数据库当前业务数据”和“after image”，如果两份数据完全一致就说明没有脏写，可以还原业务数据，如果不一致就说明有脏写，出现脏写就需要人工处理。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/52895e30e8dd56af3b992f59f9d3d151/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-19T17:23:27+08:00" />
<meta property="article:modified_time" content="2022-07-19T17:23:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringCloudAlibaba 2021.0.1.0 版本整合分布式事务Seata</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2></h2> 
<h2>事务简介</h2> 
<p>事务（Transaction）是访问并可能更新数据库中各种数据项的一个程序执行单元。在关系数据库中，一个事务由一组SQL语句组成。事务应该具有四个属性：原子性、一致性、隔离性、持久性。这四个属性通常称为ACID特性。</p> 
<p><strong>原子性（atomicity）：</strong>一个事务是一个不可分割的工作单位，事务中包括各种操作，要么都做，要么都不做。</p> 
<p><strong>一致性（consistency）：</strong>事务必须是使数据库从一个一致性状态变到另一个一致性状态，事务的中间状态不能被观察到的。</p> 
<p><strong>隔离性（isolation）：</strong>一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发其他事务是隔离的，并发执行的各个事务之间不能互相干扰。隔离性又分为四个级别：读未提交（read uncommitted）、读已提交（read committed，解决脏读）、可重复读（repeatable read，解决幻读）、串行化（serializable，解决幻读）。</p> 
<p><strong>持久性（durability）：</strong>持久性也成为永久性（permanence），指一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。接下来其他操作或故障不应该对其他有任何影响。</p> 
<p>任何事务机制在实现时，都应该考虑事务的ACID特性，包括：本地事务、分布式事务，及时不能都很好的满足，也要考虑支持到什么程度。</p> 
<h2>本地事务 </h2> 
<p>@Transational</p> 
<p>大多数据场景下，我的应用都只需要操作单一的数据库，这种情况下的事务成为本地事务（Local Transaction）。本地事务的ACID特性是数据库直接提供支持的。</p> 
<h2>1.Seata是什么？</h2> 
<p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。</p> 
<p>官网：<a href="https://seata.io/zh-cn/docs/overview/what-is-seata.html" rel="nofollow" title="https://seata.io/zh-cn/docs/overview/what-is-seata.html">https://seata.io/zh-cn/docs/overview/what-is-seata.html</a></p> 
<p>源码：<a href="https://github.com/seata/seata" title="https://github.com/seata/seata">https://github.com/seata/seata</a></p> 
<p><a href="https://github.com/seata/seata-samples" title="GitHub - seata/seata-samples: seata-samples">GitHub - seata/seata-samples: seata-samples</a></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/61/bb/hEV5vv5i_o.png"></p> 
<h3>1.1 Seata的三大角色</h3> 
<p>在Seata的架构中，一共有三个角色：</p> 
<p><strong>TC（Transaction Coordinator）- 事务协调者</strong></p> 
<p>维护全局和分支事务的状态，驱动全局事务提交和回滚。</p> 
<p><strong>TM（Transaction Manager）- 事务管理器</strong></p> 
<p>定义全局的事务的范围：开始全局事务、提交或回滚全局事务。</p> 
<p><strong>RM（Resource Manager）- 资源管理器</strong></p> 
<p>管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</p> 
<p><span style="color:#e6b223;">其中，TC为单独部署的Server服务端，TM和RM为嵌入到应用中的Client客户端。</span></p> 
<h3><strong>1.2常用分布式事务解决方案</strong></h3> 
<p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。</p> 
<ol><li>seata 阿里分布式事务框架</li><li>消息队列</li><li>saga</li><li>XA</li></ol> 
<p>四种分布式事务</p> 
<p><strong>Seata AT 模式（auto transaction）</strong></p> 
<p>AT模式是一种无侵入的分布式事务解决方案<br> ●一阶段：<br> 在一阶段，Seata会拦截“业务SQL”，首先解析SQL语义，找到“业务SQL”要更新的业务数据，在业务数据被更新前，将其保存成“before image”，然后执行“业务SQL”更新业务数据，在业务数据更新之后，再将其保存“afger image”，最后生成行锁。以上操作全部再一个数据库事务内完成，这样保证了一阶段操作的原子性。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/53/bf/FhLckL84_o.png"></p> 
<p><br> ●二阶段提交<br> 二阶段如果是提交的话，因为“业务SQL”在一阶段已经提交至数据库，所以Seata框架只需将一阶段保存的快照数据和行锁删掉，完成数据清理。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/ce/8a/dzTUHBbN_o.png"></p> 
<p><br> ●二阶段回滚<br> 二阶段如果是回滚的话，Seata就需要回滚一阶段已经执行的“业务SQL”，还原业务数据。回滚方式是使用“before image”还原业务数据；但在还原前首先要校验脏写，对比“数据库当前业务数据”和“after image”，如果两份数据完全一致就说明没有脏写，可以还原业务数据，如果不一致就说明有脏写，出现脏写就需要人工处理。</p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/41/2d/iKyIUF6Y_o.png"></p> 
<h2>Seata TCC 模式</h2> 
<p>一个分布式的全局事务，整体是 <strong>两阶段提交</strong> 的模型。全局事务是由若干分支事务组成的，分支事务要满足 <strong>两阶段提交</strong> 的模型要求，即需要每个分支事务都具备自己的：</p> 
<ul><li>一阶段 prepare 行为</li><li>二阶段 commit 或 rollback 行为</li></ul> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/c9/60/m8wNtoBl_o.png"></p> 
<p>根据两阶段行为模式的不同，我们将分支事务划分为 <strong>Automatic (Branch) Transaction Mode</strong> 和 <strong>TCC (Branch) Transaction Mode</strong>.</p> 
<p>AT 模式（<a href="https://seata.io/zh-cn/docs/dev/mode/tcc-mode.html" rel="nofollow" title="参考链接 TBD">参考链接 TBD</a>）基于 <strong>支持本地 ACID 事务</strong> 的 <strong>关系型数据库</strong>：</p> 
<ul><li>一阶段 prepare 行为：在本地事务中，一并提交业务数据更新和相应回滚日志记录。</li><li>二阶段 commit 行为：马上成功结束，<strong>自动</strong> 异步批量清理回滚日志。</li><li>二阶段 rollback 行为：通过回滚日志，<strong>自动</strong> 生成补偿操作，完成数据回滚。</li></ul> 
<p>相应的，TCC 模式，不依赖于底层数据资源的事务支持：</p> 
<ul><li>一阶段 prepare 行为：调用 <strong>自定义</strong> 的 prepare 逻辑。</li><li>二阶段 commit 行为：调用 <strong>自定义</strong> 的 commit 逻辑。</li><li>二阶段 rollback 行为：调用 <strong>自定义</strong> 的 rollback 逻辑。</li></ul> 
<p>所谓 TCC 模式，是指支持把 <strong>自定义</strong> 的分支事务纳入到全局事务的管理中。</p> 
<h2>2.Seata快速开始</h2> 
<h3>2.1 Seata Server （TC）环境搭建</h3> 
<p><a href="https://seata.io/zh-cn/docs/ops/deploy-guide-beginner.html" rel="nofollow" title="https://seata.io/zh-cn/docs/ops/deploy-guide-beginner.html">https://seata.io/zh-cn/docs/ops/deploy-guide-beginner.html</a></p> 
<p>Server端存储模式（store.mode）支持三种：</p> 
<ul><li>file模式为单机模式，全局事务会话信息内存中读写并持久化本地文件root.data，性能较高;</li><li>db模式为高可用模式，全局事务会话信息通过db共享，相应性能差些;</li><li>redis模式Seata-Server 1.3及以上版本支持,性能较高,存在事务信息丢失风险,请提前配置合适当前场景的redis持久化配置.</li></ul> 
<p>资源目录：</p> 
<p><a href="https://github.com/seata/seata/tree/1.4.0/script" title="https://github.com/seata/seata/tree/1.4.0/script">https://github.com/seata/seata/tree/1.4.0/script</a> </p> 
<ul><li>client</li></ul> 
<p>存放client端sql脚本 (包含 undo_log表) ，参数配置 </p> 
<ul><li>config-center</li></ul> 
<p>各个配置中心参数导入脚本，config.txt(包含server和client，原名nacos-config.txt)为通用参数文件</p> 
<ul><li>server</li></ul> 
<p>server端数据库脚本 (包含 lock_table、branch_table 与 global_table) 及各个容器配置</p> 
<p><strong>db存储模式+Nacos（注册&amp;配置中心）部署</strong></p> 
<p><strong>步骤一：下载安装包</strong></p> 
<p>seata安装包：<a href="https://github.com/seata/seata/releases" title="https://github.com/seata/seata/releases">https://github.com/seata/seata/releases</a></p> 
<p>版本对应：<a class="link-info" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E" title="官方版本说明">官方版本说明</a></p> 
<p> 本文使用的是SpringCloudAlibaba 2021.0.1.0，对应的Seata版本下载1.4.2</p> 
<table><thead><tr><th>Spring Cloud Alibaba Version</th><th>Spring Cloud Version</th><th>Spring Boot Version</th></tr></thead><tbody><tr><td> <p>2021.0.1.0</p> </td><td> <p>Spring Cloud 2021.0.1</p> </td><td> <p>2.6.3</p> </td></tr></tbody></table> 
<table><thead><tr><th>Spring Cloud Alibaba Version</th><th>Sentinel Version</th><th>Nacos Version</th><th>RocketMQ Version</th><th>Dubbo Version</th><th>Seata Version</th></tr></thead><tbody><tr><td> <p>2021.0.1.0</p> </td><td> <p>1.8.3</p> </td><td> <p>1.4.2</p> </td><td> <p>4.9.2</p> </td><td> <p>~</p> </td><td> <p>1.4.2</p> </td></tr></tbody></table> 
<p><img alt="" height="193" src="https://images2.imgbox.com/d8/39/zwpN2YOm_o.png" width="929"></p> 
<p><img alt="" height="386" src="https://images2.imgbox.com/d8/fd/qhGctjb4_o.png" width="882"></p> 
<p><strong>步骤二：配置Seata文件</strong></p> 
<p>1、file.conf（seata-server-1.4.2\conf 修改标红的地方，其他的不用改）</p> 
<p><img alt="" height="896" src="https://images2.imgbox.com/62/05/Qbp3UA0G_o.png" width="1200"></p> 
<p> 2、创建seata数据库（SQL脚本从seata资源源码中获取​​​​​​​）</p> 
<p> 资源源码：<a href="https://github.com/seata/seata/tree/1.4.0/script" title="https://github.com/seata/seata/tree/1.4.0/script">https://github.com/seata/seata/tree/1.4.0/script</a><img alt="" height="353" src="https://images2.imgbox.com/87/9a/WtPg4cJe_o.png" width="601"></p> 
<p> 3、registry.conf（seata-server-1.4.2\conf）注册中心、配置中心</p> 
<p><img alt="" height="450" src="https://images2.imgbox.com/59/4b/IhiFoIn6_o.png" width="722"></p> 
<p><img alt="" height="688" src="https://images2.imgbox.com/51/88/sd5ZTo1y_o.png" width="815"> </p> 
<p> 4、修改资源源码中的config.txt</p> 
<p><img alt="" height="515" src="https://images2.imgbox.com/a4/61/0kzLuGsX_o.png" width="757"></p> 
<p> <img alt="" height="847" src="https://images2.imgbox.com/96/47/IjDhQMZs_o.png" width="1200"></p> 
<p><strong>步骤三：启动nacos</strong></p> 
<p><strong>步骤四：执行nacos-config.sh（只要装了git就可以运行）</strong></p> 
<p><img alt="" height="378" src="https://images2.imgbox.com/10/b2/GjoQHh8r_o.png" width="861"></p> 
<p> 运行过程会很慢的，执行后会自动注册到nacos中</p> 
<p><img alt="" height="842" src="https://images2.imgbox.com/82/36/sZmeMkq7_o.png" width="1200"></p> 
<p><strong>步骤五：启动seata</strong></p> 
<p>在 Linux/Mac 下</p> 
<pre><code>$ sh ./bin/seata-server.sh
</code></pre> 
<p>在 Windows 下</p> 
<pre><code>bin\seata-server.bat</code></pre> 
<h4>支持的启动参数</h4> 
<table><thead><tr><th>参数</th><th>全写</th><th>作用</th><th>备注</th></tr></thead><tbody><tr><td>-h</td><td>--host</td><td>指定在注册中心注册的 IP</td><td>不指定时获取当前的 IP，外部访问部署在云环境和容器中的 server 建议指定</td></tr><tr><td>-p</td><td>--port</td><td>指定 server 启动的端口</td><td>默认为 8091</td></tr><tr><td>-m</td><td>--storeMode</td><td>事务日志存储方式</td><td>支持<code>file</code>,<code>db</code>,<code>redis</code>，默认为 <code>file</code> 注:redis需seata-server 1.3版本及以上</td></tr><tr><td>-n</td><td>--serverNode</td><td>用于指定seata-server节点ID</td><td>如 <code>1</code>,<code>2</code>,<code>3</code>..., 默认为 <code>1</code></td></tr><tr><td>-e</td><td>--seataEnv</td><td>指定 seata-server 运行环境</td><td>如 <code>dev</code>, <code>test</code> 等, 服务启动时会使用 <code>registry-dev.conf</code> 这样的配置</td></tr></tbody></table> 
<p>如：</p> 
<pre><code>$ sh ./bin/seata-server.sh -p 8091 -h 127.0.0.1 -m file</code></pre> 
<p> <img alt="" height="384" src="https://images2.imgbox.com/55/79/G2s9bQQR_o.png" width="1200"></p> 
<h2>3、SpringCloudAlibaba集成Seata </h2> 
<p>本文使用的是提前搭建好的分布式项目，订单服务和库存服务</p> 
<p><img alt="" height="232" src="https://images2.imgbox.com/1b/e9/PnWX9T58_o.png" width="468"> </p> 
<p>3.1 依赖</p> 
<pre><code class="language-XML">&lt;dependency&gt;
  &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre> 
<p> 3.2 aplication.yml</p> 
<pre><code class="language-XML">#分布式事务
seata:
  tx-service-group: default_tx_group  #配置事务分组  service.vgroupMapping.default_tx_group=default
  registry:
    #配置seata配置中心,告诉seata client 怎么去访问 seata server（TC）
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848  # seata server 所在的nacoas服务地址
      application: seata-server    # 默认名称：seata-server 没有修改可以不配置
      group: SEATA_GROUP # 默认分组：SEATA_GROUP 没有修改可以不配置
      username: nacos
      password: nacos
  config:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      username: nacos
      password: nacos
      group: SEATA_GROUP</code></pre> 
<p>核心代码 </p> 
<p><img alt="" height="472" src="https://images2.imgbox.com/99/c3/3yYuqtZj_o.png" width="1167"> </p> 
<p> 发生异常后，订单表数据回滚，库存表数据回滚。</p> 
<p>源码：<a href="https://gitee.com/zqingcpu/springcloudalibaba-seata.git" rel="nofollow" title="https://gitee.com/zqingcpu/springcloudalibaba-seata.git">https://gitee.com/zqingcpu/springcloudalibaba-seata.git</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d36647412d846f7d590b979bdd4f18ce/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【模型评估】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b9f228d83c7a2881a42a93f461c80358/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【自动化办公】python批量替换word中的内容</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>