<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>黑马点评--用户签到 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="黑马点评--用户签到" />
<meta property="og:description" content="用户签到 BitMap用法签到功能签到统计 BitMap用法：
我们按月来统计用户签到信息，签到记录为1，未签到则记录为0.（布隆过滤器就是采用这种结构）
把每一个bit位对应当月的每一天，形成了映射关系。用0和1标示业务状态，这种思路就称为位图（BitMap）。
Redis是利用string类型数据结构实现BitMap，因此最大上限512M，转换为bit则是2^32个bit位。
BitMap的操作命令有：‘
SETBIT：向指定位置（offset）存入一个0或1
GETBIT：获取指定位置（offset）的bit值
BITCOUNT：统计BitMap中值为1的bit位
BITFIELD：操作（查询，修改，自增）BitMap中bit数组中的指定位置（offset）的值
BITFIELD_RD：获取BitMap中bit数组，并以十进制形式返回
BITOP：将多个BitMap的结果做位运算（与，或，异或）
BITPOS：查找bit数组中指定范围内第一个0或1出现的位置
签到功能
需求：实现签到接口，将当前用户当天签到信息保存到Redis中
提示：因为BitMap底层是基于String数据结构，因此其操作也都封装在字符串相关操作中了。
代码实现
public Result sign() { //1.获取当前登录的用户 Long userId = UserHolder.getUser().getId(); //2.获取日期 LocalDateTime now = LocalDateTime.now(); //3.拼接key String keySuffix = now.format(DateTimeFormatter.ofPattern(&#34;:yyyy-MM&#34;)); String key=USER_SIGN_KEY&#43;userId&#43;keySuffix; //4.获取今天是本月的第几天 int dayOfMonth = now.getDayOfMonth(); //5.写入Redis SETBIT key offset 1 stringRedisTemplate.opsForValue().setBit(key,dayOfMonth-1,true); return Result.ok(); } 统计连续签到
什么叫连续签到天数？
从最后一次签到开始向前统计，直到遇到第一次未签到为止，计算总的签到次数，就是连续签到天数。
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-BTQliNoL-1669736765623)(C:\Users\20745\AppData\Roaming\Typora\typora-user-images\image-20221129225245656.png)]
如何得到本月到今天为止的所有签到数据？
BITFELD key GET u[dayOfMonth]0 如何从后向前遍历每一个bit位？
与1做运算，就能得到最后一个bit位
随后右移1位，下一个bit为就成为最后一个bit为。
代码实现：
public Result signCount() { //1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2bd216fdcd6dfaf25099d791ba23a43d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-29T23:47:34+08:00" />
<meta property="article:modified_time" content="2022-11-29T23:47:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">黑马点评--用户签到</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a><strong>用户签到</strong></h3> 
<ul><li>BitMap用法</li><li>签到功能</li><li>签到统计</li></ul> 
<p><strong>BitMap用法：</strong></p> 
<p>我们按月来统计用户签到信息，签到记录为1，未签到则记录为0.（布隆过滤器就是采用这种结构）</p> 
<p><img src="https://images2.imgbox.com/24/d8/xNZLYc9y_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-RsaZg9D6-1669736765619)(C:\Users\20745\AppData\Roaming\Typora\typora-user-images\image-20221129181234928.png)]"></p> 
<p>把每一个bit位对应当月的每一天，形成了映射关系。用0和1标示业务状态，这种思路就称为位图（BitMap）。</p> 
<p>Redis是利用string类型数据结构实现BitMap，因此最大上限512M，转换为bit则是2^32个bit位。</p> 
<p>BitMap的操作命令有：‘</p> 
<p>SETBIT：向指定位置（offset）存入一个0或1</p> 
<p>GETBIT：获取指定位置（offset）的bit值</p> 
<p>BITCOUNT：统计BitMap中值为1的bit位</p> 
<p>BITFIELD：操作（查询，修改，自增）BitMap中bit数组中的指定位置（offset）的值</p> 
<p>BITFIELD_RD：获取BitMap中bit数组，并以十进制形式返回</p> 
<p>BITOP：将多个BitMap的结果做位运算（与，或，异或）</p> 
<p>BITPOS：查找bit数组中指定范围内第一个0或1出现的位置</p> 
<p><strong>签到功能</strong></p> 
<p>需求：实现签到接口，将当前用户当天签到信息保存到Redis中</p> 
<p><img src="https://images2.imgbox.com/8b/37/z0WWj9db_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-9vsPG5i8-1669736765621)(C:\Users\20745\AppData\Roaming\Typora\typora-user-images\image-20221129212906306.png)]"></p> 
<p>提示：因为BitMap底层是基于String数据结构，因此其操作也都封装在字符串相关操作中了。</p> 
<p><img src="https://images2.imgbox.com/3f/f5/x4xJZl1K_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Q0TxiynJ-1669736765622)(C:\Users\20745\AppData\Roaming\Typora\typora-user-images\image-20221129213015824.png)]"></p> 
<p><strong>代码实现</strong></p> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.获取当前登录的用户</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.获取日期</span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.拼接key</span>
        <span class="token class-name">String</span> keySuffix <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">":yyyy-MM"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key<span class="token operator">=</span><span class="token constant">USER_SIGN_KEY</span><span class="token operator">+</span>userId<span class="token operator">+</span>keySuffix<span class="token punctuation">;</span>
        <span class="token comment">//4.获取今天是本月的第几天</span>
        <span class="token keyword">int</span> dayOfMonth <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getDayOfMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5.写入Redis SETBIT key offset 1</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBit</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>dayOfMonth<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><strong>统计连续签到</strong></p> 
<p>什么叫连续签到天数？</p> 
<p>从最后一次签到开始向前统计，直到遇到第一次未签到为止，计算总的签到次数，就是连续签到天数。</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-BTQliNoL-1669736765623)(C:\Users\20745\AppData\Roaming\Typora\typora-user-images\image-20221129225245656.png)]</p> 
<p>如何得到本月到今天为止的所有签到数据？</p> 
<pre><code class="prism language-shell">BITFELD key GET u<span class="token punctuation">[</span>dayOfMonth<span class="token punctuation">]</span><span class="token number">0</span>
</code></pre> 
<p>如何从后向前遍历每一个bit位？</p> 
<p>与1做运算，就能得到最后一个bit位</p> 
<p>随后右移1位，下一个bit为就成为最后一个bit为。</p> 
<p><strong>代码实现：</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">signCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.获取当前登录的用户</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.获取日期</span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.拼接key</span>
        <span class="token class-name">String</span> keySuffix <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">":yyyy-MM"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key<span class="token operator">=</span><span class="token constant">USER_SIGN_KEY</span><span class="token operator">+</span>userId<span class="token operator">+</span>keySuffix<span class="token punctuation">;</span>
        <span class="token comment">//4.获取今天是本月的第几天</span>
        <span class="token keyword">int</span> dayOfMonth <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getDayOfMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5.获取本月截止今天为止的所有的签到记录，返回的是一个十进制的数字</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bitField</span><span class="token punctuation">(</span>
                key<span class="token punctuation">,</span> <span class="token class-name">BitFieldSubCommands</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">BitFieldSubCommands<span class="token punctuation">.</span>BitFieldType</span><span class="token punctuation">.</span><span class="token function">unsigned</span><span class="token punctuation">(</span>dayOfMonth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> result<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//没有任何签到结果</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Long</span> num <span class="token operator">=</span>result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> num<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//6.循环遍历</span>
        <span class="token keyword">int</span> count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//6.1让这个数字与1做与运算，得到数字的最后一个bit位//判断这个bit是否为0</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>num <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果为0,说明未签到，结束</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果不为0，说明已签到，计数器+1</span>
                count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">//把数字右移一位，抛弃最后一个bit位，继续下一个bit位</span>
            num<span class="token operator">=</span>num <span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5a79a0c2e1ee2dc8faad8913bcd70a9b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">RtspServer之LibRtsp解决闪退 新增鉴权（用户名密码登录）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d3388ee2fd9cac67a854a50df5d17e00/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在C#中使用Halcon开发视觉检测程序</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>