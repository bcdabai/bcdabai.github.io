<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于 Spring Boot 支付宝沙箱支付（Java 版本） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于 Spring Boot 支付宝沙箱支付（Java 版本）" />
<meta property="og:description" content="基于 Spring Boot 支付宝沙箱支付（Java 版本） 步骤第一步：使用支付宝账户登录，打开控制台，进入沙箱环境第二步：配置内网穿透账号第三步：引入支付宝 SDK第四步： 配置 SpringBoot第五步： AliPayConfig.java 读取配置第六步： AliPayController 步骤 第一步：使用支付宝账户登录，打开控制台，进入沙箱环境 打开沙箱地址：https://open.alipay.com/develop/sandbox/app
需要获取：AppId、支付宝网关地址、应用私钥、支付宝公钥
第二步：配置内网穿透账号 注册 https://natapp.cn/
购买免费隧道
注意：需要记住这个 authtoken，配置文件用得到
配置隧道
文件 config 配置
#将本文件放置于natapp同级目录 程序将读取 [default] 段 #在命令行参数模式如 natapp -authtoken=xxx 等相同参数将会覆盖掉此配置 #命令行参数 -config= 可以指定任意config.ini文件 [default] authtoken= 将隧道的authtoken填进去 #对应一条隧道的authtoken clienttoken= #对应客户端的clienttoken,将会忽略authtoken,若无请留空, log=none #log 日志文件,可指定本地文件, none=不做记录,stdout=直接屏幕输出 ,默认为none loglevel=ERROR #日志等级 DEBUG, INFO, WARNING, ERROR 默认为 DEBUG http_proxy= #代理设置 如 http://10.123.10.10:3128 非代理上网用户请务必留空 配置文件需要与 natapp 放在同级目录下
启动 natapp
为什么要使用 NATAPP？
因为要把本地的服务暴露到公网，让支付宝可以调用我们的接口给我们传递数据" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2fb2fe588eb4442c4782341507a37ec2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-11T16:04:55+08:00" />
<meta property="article:modified_time" content="2024-01-11T16:04:55+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于 Spring Boot 支付宝沙箱支付（Java 版本）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>基于 Spring Boot 支付宝沙箱支付（Java 版本）</h4> 
 <ul><li><a href="#_2" rel="nofollow">步骤</a></li><li><ul><li><a href="#_3" rel="nofollow">第一步：使用支付宝账户登录，打开控制台，进入沙箱环境</a></li><li><a href="#_12" rel="nofollow">第二步：配置内网穿透账号</a></li><li><a href="#_SDK_40" rel="nofollow">第三步：引入支付宝 SDK</a></li><li><a href="#__SpringBoot_52" rel="nofollow">第四步： 配置 SpringBoot</a></li><li><a href="#_AliPayConfigjava__70" rel="nofollow">第五步： AliPayConfig.java 读取配置</a></li><li><a href="#_AliPayController_123" rel="nofollow">第六步： AliPayController</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>步骤</h2> 
<h3><a id="_3"></a>第一步：使用支付宝账户登录，打开控制台，进入沙箱环境</h3> 
<p>打开沙箱地址：<a href="https://open.alipay.com/develop/sandbox/app" rel="nofollow">https://open.alipay.com/develop/sandbox/app</a><br> <img src="https://images2.imgbox.com/60/f3/v3QJtyVA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/66/56/zy6UGoBl_o.png" alt="在这里插入图片描述"><strong>需要获取</strong>：AppId、支付宝网关地址、应用私钥、支付宝公钥</p> 
<h3><a id="_12"></a>第二步：配置内网穿透账号</h3> 
<ol><li> <p>注册 <a href="https://natapp.cn/" rel="nofollow">https://natapp.cn/</a></p> </li><li> <p>购买免费隧道<br> <img src="https://images2.imgbox.com/49/88/NTsLpjxE_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/30/c7/zIgHcSJ1_o.png" alt="在这里插入图片描述"><mark>注意：需要记住这个 authtoken，配置文件用得到</mark></p> </li><li> <p>配置隧道<br> <img src="https://images2.imgbox.com/5a/e4/vecQ0umY_o.png" alt="在这里插入图片描述"></p> </li><li> <p>文件 config 配置</p> </li></ol> 
<pre><code class="prism language-properties">#将本文件放置于natapp同级目录 程序将读取 [default] 段
#在命令行参数模式如 natapp -authtoken=xxx 等相同参数将会覆盖掉此配置
#命令行参数 -config= 可以指定任意config.ini文件
[default]
authtoken= 将隧道的authtoken填进去               #对应一条隧道的authtoken
clienttoken=                    #对应客户端的clienttoken,将会忽略authtoken,若无请留空,
log=none                        #log 日志文件,可指定本地文件, none=不做记录,stdout=直接屏幕输出 ,默认为none
loglevel=ERROR                  #日志等级 DEBUG, INFO, WARNING, ERROR 默认为 DEBUG
http_proxy=                     #代理设置 如 http://10.123.10.10:3128 非代理上网用户请务必留空
</code></pre> 
<ol start="5"><li>配置文件需要与 natapp 放在同级目录下<br> <img src="https://images2.imgbox.com/67/9d/7S2XxWeg_o.png" alt="在这里插入图片描述"></li><li>启动 natapp<br> <img src="https://images2.imgbox.com/73/5d/q5BRh7vs_o.png" alt="在这里插入图片描述"></li></ol> 
<blockquote> 
 <p>为什么要使用 NATAPP？<br> 因为要把本地的服务暴露到公网，让支付宝可以调用我们的接口给我们传递数据</p> 
</blockquote> 
<h3><a id="_SDK_40"></a>第三步：引入支付宝 SDK</h3> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
<span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>sdk<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>alipay<span class="token operator">-</span>sdk<span class="token operator">-</span>java<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">4.35</span><span class="token number">.79</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<h3><a id="__SpringBoot_52"></a>第四步： 配置 SpringBoot</h3> 
<pre><code class="prism language-java">alipay<span class="token operator">:</span>
  appId<span class="token operator">:</span> xxx
  #  应用私钥
  appPrivateKey<span class="token operator">:</span> xxx
  # 支付宝公钥
  alipayPublicKey<span class="token operator">:</span>xxx
  #  每次重启会变化
  notifyUrl<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>ju2jpk<span class="token punctuation">.</span>natappfree<span class="token punctuation">.</span>cc<span class="token operator">/</span>api<span class="token operator">/</span>notify
  #natapp 代 理 的 url <span class="token operator">+</span><span class="token operator">/</span>alipay<span class="token operator">/</span>notify，这个是用于启动支付宝回调函数 notify 的接口
</code></pre> 
<p><mark>应用私钥和支付宝公钥可以用默认的，也可以自己配置，若自己配置的话需要使用支付宝开放平台密钥工具</mark><br> <img src="https://images2.imgbox.com/22/46/GWeAxWQO_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_AliPayConfigjava__70"></a>第五步： AliPayConfig.java 读取配置</h3> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>projects<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"alipay"</span><span class="token punctuation">)</span> <span class="token comment">//读取配置文件中的alipay</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AliPayConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> appId<span class="token punctuation">;</span> <span class="token comment">//支付宝APPID</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appPrivateKey<span class="token punctuation">;</span> <span class="token comment">//应用私钥</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> alipayPublicKey<span class="token punctuation">;</span> <span class="token comment">//支付宝公钥</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> notifyUrl<span class="token punctuation">;</span> <span class="token comment">//支付宝通知本地接口完整地址</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAppId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> appId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAppId</span><span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>appId <span class="token operator">=</span> appId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAppPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> appPrivateKey<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAppPrivateKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> appPrivateKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>appPrivateKey <span class="token operator">=</span> appPrivateKey<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAlipayPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> alipayPublicKey<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAlipayPublicKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> alipayPublicKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>alipayPublicKey <span class="token operator">=</span> alipayPublicKey<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getNotifyUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> notifyUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNotifyUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> notifyUrl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notifyUrl <span class="token operator">=</span> notifyUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="_AliPayController_123"></a>第六步： AliPayController</h3> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>json<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">AlipayApiException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">AlipayClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DefaultAlipayClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AlipaySignature</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">AlipayTradePagePayRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">AliPayConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Orders</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">OrdersService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token comment">//  https://natapp.cn/</span>
<span class="token comment">// ekihat7647@sandbox.com</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/alipay"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AliPayController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 支付宝沙箱网关地址</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">GATEWAY_URL</span> <span class="token operator">=</span> <span class="token string">"https://openapi-sandbox.dl.alipaydev.com/gateway.do"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">FORMAT</span> <span class="token operator">=</span> <span class="token string">"JSON"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CHARSET</span> <span class="token operator">=</span> <span class="token string">"UTF-8"</span><span class="token punctuation">;</span>
    <span class="token comment">//签名方式</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SIGN_TYPE</span> <span class="token operator">=</span> <span class="token string">"RSA2"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">AliPayConfig</span> aliPayConfig<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">OrdersService</span> ordersService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/pay"</span><span class="token punctuation">)</span>  <span class="token comment">//  /alipay/pay?orderNo=xxx</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 查询订单信息</span>
        <span class="token class-name">Orders</span> orders <span class="token operator">=</span> ordersService<span class="token punctuation">.</span><span class="token function">selectByOrderNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>orders <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 1. 创建Client，通用SDK提供的Client，负责调用支付宝的API</span>
        <span class="token class-name">AlipayClient</span> alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span><span class="token constant">GATEWAY_URL</span><span class="token punctuation">,</span> aliPayConfig<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                aliPayConfig<span class="token punctuation">.</span><span class="token function">getAppPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">FORMAT</span><span class="token punctuation">,</span> <span class="token constant">CHARSET</span><span class="token punctuation">,</span> aliPayConfig<span class="token punctuation">.</span><span class="token function">getAlipayPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">SIGN_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 创建 Request并设置Request参数</span>
        <span class="token class-name">AlipayTradePagePayRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradePagePayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 发送请求的 Request类</span>
        request<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span>aliPayConfig<span class="token punctuation">.</span><span class="token function">getNotifyUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> bizContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">,</span> orders<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 我们自己生成的订单编号</span>
        bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"total_amount"</span><span class="token punctuation">,</span> orders<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订单的总金额</span>
        bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"subject"</span><span class="token punctuation">,</span> orders<span class="token punctuation">.</span><span class="token function">getGoodsName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 支付的名称</span>
        bizContent<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"product_code"</span><span class="token punctuation">,</span> <span class="token string">"FAST_INSTANT_TRADE_PAY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 固定配置</span>
        request<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span>bizContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setReturnUrl</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/orders"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 支付完成后自动跳转到本地页面的路径</span>
        <span class="token comment">// 执行请求，拿到响应的结果，返回给浏览器</span>
        <span class="token class-name">String</span> form <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            form <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">pageExecute</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用SDK生成表单</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AlipayApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/html;charset="</span> <span class="token operator">+</span> <span class="token constant">CHARSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 直接将完整的表单html输出到页面</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/notify"</span><span class="token punctuation">)</span>  <span class="token comment">// 注意这里必须是POST接口</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">payNotify</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"trade_status"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"TRADE_SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=========支付宝异步回调========"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> name <span class="token operator">:</span> requestParams<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">String</span> sign <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"sign"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">AlipaySignature</span><span class="token punctuation">.</span><span class="token function">getSignCheckContentV1</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> checkSignature <span class="token operator">=</span> <span class="token class-name">AlipaySignature</span><span class="token punctuation">.</span><span class="token function">rsa256CheckContent</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> sign<span class="token punctuation">,</span> aliPayConfig<span class="token punctuation">.</span><span class="token function">getAlipayPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 验证签名</span>
            <span class="token comment">// 支付宝验签</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>checkSignature<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 验签通过</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"交易名称: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"subject"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"交易状态: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"trade_status"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"支付宝交易凭证号: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"商户订单号: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"交易金额: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"total_amount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"买家在支付宝唯一id: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"buyer_id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"买家付款时间: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"gmt_payment"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"买家付款金额: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"buyer_pay_amount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


                <span class="token class-name">String</span> tradeNo <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> gmtPayment <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"gmt_payment"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> alipayTradeNo <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 更新订单状态为已支付，设置支付信息</span>
                <span class="token class-name">Orders</span> orders <span class="token operator">=</span> ordersService<span class="token punctuation">.</span><span class="token function">selectByOrderNo</span><span class="token punctuation">(</span>tradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                orders<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">"已支付"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                orders<span class="token punctuation">.</span><span class="token function">setPayTime</span><span class="token punctuation">(</span>gmtPayment<span class="token punctuation">)</span><span class="token punctuation">;</span>
                orders<span class="token punctuation">.</span><span class="token function">setPayNo</span><span class="token punctuation">(</span>alipayTradeNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ordersService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/52/07/p5ATSKFO_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/1d/7a/ZH02KFvE_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/91/a5/kwHQ06BU_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/85/31/wqfF7IGo_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/99/e6/ICsfkGhD_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/068b7c3d7e4f04a35bbcb8a724d4555f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何使用vite框架封装一个js库，并发布npm包</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/83c732db554e5e84619c8b0694216717/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">高级交换学习试题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>