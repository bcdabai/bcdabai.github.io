<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>WebLogic反序列化之CVE-2015-4852、CVE-2016-0638、CVE-2016-3510 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="WebLogic反序列化之CVE-2015-4852、CVE-2016-0638、CVE-2016-3510" />
<meta property="og:description" content="WebLogic反序列化之CVE-2015-4852、CVE-2016-0638、CVE-2016-3510 CVE-2015-4852、CVE-2016-0638、CVE-2016-3510这3个CVE常常被拿到一起来讲，因为后2个CVE都是以CVE-2015-4852利用链为基础建立的。
按照我对反序列化利用链的理解，包含2个部分：
承担恶意代码的荷载Class启动荷载Class的启动Class或者启动机制 CVE-2015-4852的荷载Class就是较为熟知的Apache CC利用链，关于CC利用链的分析文章很多，就不在这里写了。放一篇我关于CC1的文章ysoserial gadget Commons-Collections1保姆级分析，核心就是ChainedTransformer、ConstantTransformer、InvokerTransformer。
关于承担恶意代码的荷载Class就到此为止，而怎么启动荷载，就需要先了解WebLogic的T3协议。因为WebLogic通过读取数据包里T3协议格式的序列化数据然后将其反序列化得到Object。
T3协议是WebLogic RMI使用的协议，是JRMP的强化版。
T3协议 WebLogic RMI就是WebLogic对Java RMI的实现，在功能和实现方式上稍有不同。我们来细数一下WebLogic RMI和Java RMI的不同之处。
WebLogic RMI支持集群部署和负载均衡。 因为WebLogic本身就是为分布式系统设计的，因此WebLogic RMI支持集群部署和负载均衡也不难理解了。
WebLogic RMI的服务端会使用字节码生成(Hot Code Generation)功能生成代理对象。 WebLogic的字节码生成功能会自动生成服务端的字节码到内存。不再生成Skeleton骨架对象，也不需要使用UnicastRemoteObject对象。
WebLogic RMI客户端使用动态代理。 在WebLogic RMI客户端中，字节码生成功能会自动为客户端生成代理对象，因此Stub也不再需要。
WebLogic RMI主要使用T3协议（还有基于CORBA的IIOP协议）进行客户端到服务端的数据传输。 T3传输协议是WebLogic的自有协议，它有如下特点：
服务端可以持续追踪监控客户端是否存活（心跳机制），通常心跳的间隔为60秒，服务端在超过240秒未收到心跳即判定与客户端的连接丢失。通过建立一次连接可以将全部数据包传输完成，优化了数据包大小和网络消耗。 关于T3协议我本来想找一下有没有详细的定义，但是百度Google都没有找到，直到看到SeeBug里有篇文章说因为WebLogic闭源的原因就没有T3协议规则这方面的资料。不过网上对应Poc利用部分的T3协议分析倒是有。
具体分析参考漏洞原理和weblogic t3 协议利用与防御
发现每个数据包里不止包含一个序列化魔术头。(0xac 0xed 0x00 0x05)每个序列化数据包前面都有相同的二进制串。(0xfe 0x01 0x00 0x00)每个数据包上面都包含了一个T3协议头。仔细看协议头部分，发现数据包的前4个字节正好对应着数据包长度。以及我们也能发现包长度后面的01代表请求，02代表返回。 这些点说明了T3协议由协议头包裹，且数据包中包含多个序列化的对象。
现在知道了T3协议的格式，那么接下来有2种思路
替换数据包中多个序列化对象任意一个为恶意序列化数据。
weblogic发送的JAVA序列化数据的第一部分与恶意序列化数据进行拼接。
其实在我看来是一个意思，无非是选择替换第几个正常序列化部分。
网上的payload都是直接替换第1个序列化对象，我参考的Poc是这个Weblogic_direct_T3_Rces。
搞清楚怎么在T3协议数据流中加入恶意序列化数据后，接下来就可以说一说服务端是如何反序列化恶意数据并启动CC链。
从数据流到Object Weblogic通过7001端口，获取到流量中T3协议的java反序列化数据。
通过调用栈，可以发现Weblogic最后通过ObjectInputStream读入序列化数据，并在readClassDesc(boolean unshared)方法中拿到类描述符来确定字节流中传递数据的类型，并交给对应的方法进行处理。
//ObjectInputStream.java /** * Reads in and returns (possibly null) class descriptor. Sets passHandle * to class descriptor&#39;s assigned handle." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/754b546fbf44fd2e400b4e6782caa921/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-14T21:29:01+08:00" />
<meta property="article:modified_time" content="2022-07-14T21:29:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">WebLogic反序列化之CVE-2015-4852、CVE-2016-0638、CVE-2016-3510</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="WebLogicCVE20154852CVE20160638CVE20163510_0"></a>WebLogic反序列化之CVE-2015-4852、CVE-2016-0638、CVE-2016-3510</h2> 
<p><code>CVE-2015-4852</code>、<code>CVE-2016-0638</code>、<code>CVE-2016-3510</code>这3个<strong>CVE</strong>常常被拿到一起来讲，因为后2个<strong>CVE</strong>都是以<code>CVE-2015-4852</code>利用链为基础建立的。</p> 
<p>按照我对<strong>反序列化利用链</strong>的理解，包含2个部分：</p> 
<ol><li>承担恶意代码的荷载<strong>Class</strong></li><li>启动荷载<strong>Class</strong>的<code>启动Class</code>或者<code>启动机制</code></li></ol> 
<p><code>CVE-2015-4852</code>的荷载<strong>Class</strong>就是较为熟知的<strong>Apache CC</strong>利用链，关于<strong>CC</strong>利用链的分析文章很多，就不在这里写了。放一篇我关于<strong>CC1</strong>的文章<a href="https://www.freebuf.com/sectool/320360.html" rel="nofollow">ysoserial gadget Commons-Collections1保姆级分析</a>，核心就是<strong>ChainedTransformer</strong>、<strong>ConstantTransformer</strong>、<strong>InvokerTransformer</strong>。</p> 
<p>关于承担恶意代码的荷载<strong>Class</strong>就到此为止，而怎么启动荷载，就需要先了解<strong>WebLogic</strong>的<strong>T3</strong>协议。因为<strong>WebLogic</strong>通过读取数据包里<strong>T3</strong>协议格式的<strong>序列化数据</strong>然后将其<strong>反序列化</strong>得到<strong>Object</strong>。</p> 
<p><strong>T3</strong>协议是<strong>WebLogic RMI</strong>使用的协议，是<strong>JRMP</strong>的强化版。</p> 
<h3><a id="T3_15"></a>T3协议</h3> 
<p><strong>WebLogic RMI就是WebLogic对Java RMI的实现</strong>，在功能和实现方式上稍有不同。我们来细数一下<strong>WebLogic RMI</strong>和<strong>Java RMI</strong>的不同之处。</p> 
<ul><li><strong>WebLogic RMI</strong>支持集群部署和负载均衡。</li></ul> 
<p>因为<strong>WebLogic</strong>本身就是为分布式系统设计的，因此<strong>WebLogic RMI</strong>支持集群部署和负载均衡也不难理解了。</p> 
<ul><li><strong>WebLogic RMI</strong>的服务端会使用字节码生成<code>(Hot Code Generation)</code>功能生成代理对象。</li></ul> 
<p>WebLogic的字节码生成功能会自动生成服务端的字节码到内存。不再生成<strong>Skeleton</strong>骨架对象，也不需要使用<code>UnicastRemoteObject</code>对象。</p> 
<ul><li><strong>WebLogic RMI</strong>客户端使用动态代理。</li></ul> 
<p>在<strong>WebLogic RMI</strong>客户端中，字节码生成功能会自动为客户端生成代理对象，因此<code>Stub</code>也不再需要。</p> 
<ul><li><strong>WebLogic RMI</strong>主要使用<strong>T3</strong>协议（还有基于<strong>CORBA</strong>的<strong>IIOP</strong>协议）进行客户端到服务端的数据传输。</li></ul> 
<p><strong>T3</strong>传输协议是<strong>WebLogic</strong>的自有协议，它有如下特点：</p> 
<ol><li>服务端可以持续追踪监控客户端是否存活（心跳机制），通常心跳的间隔为<strong>60</strong>秒，服务端在超过<strong>240</strong>秒未收到心跳即判定与客户端的连接丢失。</li><li>通过建立一次连接可以将全部数据包传输完成，优化了数据包大小和网络消耗。</li></ol> 
<p>关于<strong>T3</strong>协议我本来想找一下有没有详细的定义，但是百度<strong>Google</strong>都没有找到，直到看到<strong>SeeBug</strong>里有篇文章说因为<strong>WebLogic</strong>闭源的原因就没有<strong>T3协议规则</strong>这方面的资料。不过网上对应<strong>Poc</strong>利用部分的<strong>T3</strong>协议分析倒是有。</p> 
<p>具体分析参考<a href="https://paper.seebug.org/1012/#_6" rel="nofollow">漏洞原理</a>和<a href="https://cert.360.cn/report/detail?id=0de94a3cd4c71debe397e2c1a036436f" rel="nofollow">weblogic t3 协议利用与防御</a></p> 
<ul><li>发现每个数据包里不止包含一个序列化魔术头。<code>(0xac 0xed 0x00 0x05)</code></li><li>每个序列化数据包前面都有相同的二进制串。<code>(0xfe 0x01 0x00 0x00)</code></li><li>每个数据包上面都包含了一个<strong>T3</strong>协议头。</li><li>仔细看协议头部分，发现数据包的<strong>前4个字节</strong>正好对应着<strong>数据包长度</strong>。</li><li>以及我们也能发现包长度后面的<code>01</code>代表请求，<code>02</code>代表返回。</li></ul> 
<p>这些点说明了<strong>T3</strong>协议由协议头包裹，且数据包中<strong>包含</strong>多个序列化的对象。</p> 
<p>现在知道了<strong>T3</strong>协议的格式，那么接下来有2种思路</p> 
<ol><li> <p>替换数据包中多个<strong>序列化对象</strong>任意一个为<strong>恶意序列化数据</strong>。</p> </li><li> <p><strong>weblogic</strong>发送的<strong>JAVA</strong>序列化数据的第一部分与<strong>恶意序列化数据</strong>进行拼接。</p> </li></ol> 
<p>其实在我看来是一个意思，无非是选择替换第几个<strong>正常序列化部分</strong>。</p> 
<p>网上的<strong>payload</strong>都是直接替换第1个<strong>序列化对象</strong>，我参考的<strong>Poc</strong>是这个<a href="https://github.com/minhangxiaohui/Weblogic_direct_T3_Rces">Weblogic_direct_T3_Rces</a>。</p> 
<p>搞清楚怎么在<strong>T3</strong>协议数据流中加入<strong>恶意序列化数据</strong>后，接下来就可以说一说服务端是如何反序列化<strong>恶意数据</strong>并启动<strong>CC</strong>链。</p> 
<h3><a id="Object_62"></a>从数据流到Object</h3> 
<p><strong>Weblogic</strong>通过<code>7001</code>端口，获取到流量中<strong>T3</strong>协议的<strong>java</strong>反序列化数据。</p> 
<p>通过调用栈，可以发现<strong>Weblogic</strong>最后通过<strong>ObjectInputStream</strong>读入序列化数据，并在<code>readClassDesc(boolean unshared)</code>方法中拿到<strong>类描述符</strong>来确定字节流中传递数据的类型，并交给对应的方法进行处理。</p> 
<pre><code class="prism language-java"><span class="token comment">//ObjectInputStream.java</span>
<span class="token comment">/**
 * Reads in and returns (possibly null) class descriptor.  Sets passHandle
 * to class descriptor's assigned handle.  If class descriptor cannot be
 * resolved to a class in the local VM, a ClassNotFoundException is
 * associated with the class descriptor's handle.
 */</span>
<span class="token keyword">private</span> <span class="token class-name">ObjectStreamClass</span> <span class="token function">readClassDesc</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> unshared<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">byte</span> tc <span class="token operator">=</span> bin<span class="token punctuation">.</span><span class="token function">peekByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ObjectStreamClass</span> descriptor<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>tc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> TC_NULL<span class="token operator">:</span>
            descriptor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ObjectStreamClass</span><span class="token punctuation">)</span> <span class="token function">readNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> TC_REFERENCE<span class="token operator">:</span>
            descriptor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ObjectStreamClass</span><span class="token punctuation">)</span> <span class="token function">readHandle</span><span class="token punctuation">(</span>unshared<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> TC_PROXYCLASSDESC<span class="token operator">:</span>
            descriptor <span class="token operator">=</span> <span class="token function">readProxyDesc</span><span class="token punctuation">(</span>unshared<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> TC_CLASSDESC<span class="token operator">:</span>
            descriptor <span class="token operator">=</span> <span class="token function">readNonProxyDesc</span><span class="token punctuation">(</span>unshared<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//进这里</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">StreamCorruptedException</span><span class="token punctuation">(</span>
                <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"invalid type code: %02X"</span><span class="token punctuation">,</span> tc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">validateDescriptor</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> descriptor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里会走<code>case TC_CLASSDES</code>，在<code>readNonProxyDesc()</code>里通过<code>readClassDescriptor()</code>拿到描述符并作为参数传给<code>resolveClass(readDesc)</code>方法拿到相对应的<strong>Class</strong>对象，最后通过<code>desc.initNonProxy()</code>初始化。</p> 
<pre><code class="prism language-java"><span class="token comment">//ObjectInputStream.java</span>
<span class="token comment">/**
 * Reads in and returns class descriptor for a class that is not a dynamic
 * proxy class.  Sets passHandle to class descriptor's assigned handle.  If
 * class descriptor cannot be resolved to a class in the local VM, a
 * ClassNotFoundException is associated with the descriptor's handle.
 */</span>
<span class="token keyword">private</span> <span class="token class-name">ObjectStreamClass</span> <span class="token function">readNonProxyDesc</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> unshared<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token class-name">ObjectStreamClass</span> desc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectStreamClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ObjectStreamClass</span> readDesc <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    readDesc <span class="token operator">=</span> <span class="token function">readClassDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cl <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cl <span class="token operator">=</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span>readDesc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            resolveEx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span><span class="token string">"null class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>checksRequired<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    desc<span class="token punctuation">.</span><span class="token function">initNonProxy</span><span class="token punctuation">(</span>readDesc<span class="token punctuation">,</span> cl<span class="token punctuation">,</span> resolveEx<span class="token punctuation">,</span> <span class="token function">readClassDesc</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> desc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//InboundMsgAbbrev$ServerChannelInputStream.java</span>
<span class="token keyword">protected</span> <span class="token class-name">Class</span> <span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token class-name">ObjectStreamClass</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token class-name">Class</span> var2 <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> var2<span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p><code>resolveClass()</code>方法通过<code>super.resolveClass(var1)</code>拿到对应<strong>Class</strong>并返回。到此如何获得<strong>Class</strong>就分析结束了，接下来从<code>ObjectInputStream.readClassDesc(boolean unshared)</code>往上分析看看是如何通过<strong>Class</strong>得到<strong>Object</strong>的？</p> 
<p>根据调用栈往上一层的是<code>ObjectInputStream.readOrdinaryObject(boolean unshared)</code></p> 
<pre><code class="prism language-java"><span class="token comment">//ObjectInputStream.java</span>
<span class="token comment">/**
 * Reads and returns "ordinary" (i.e., not a String, Class,
 * ObjectStreamClass, array, or enum constant) object, or null if object's
 * class is unresolvable (in which case a ClassNotFoundException will be
 * associated with object's handle).  Sets passHandle to object's assigned
 * handle.
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">readOrdinaryObject</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> unshared<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token class-name">ObjectStreamClass</span> desc <span class="token operator">=</span> <span class="token function">readClassDesc</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Object</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        obj <span class="token operator">=</span> desc<span class="token punctuation">.</span><span class="token function">isInstantiable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> desc<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token punctuation">.</span><span class="token function">isExternalizable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">readExternalData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Externalizable</span><span class="token punctuation">)</span> obj<span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">readSerialData</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    handles<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span>passHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
        handles<span class="token punctuation">.</span><span class="token function">lookupException</span><span class="token punctuation">(</span>passHandle<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
        desc<span class="token punctuation">.</span><span class="token function">hasReadResolveMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> rep <span class="token operator">=</span> desc<span class="token punctuation">.</span><span class="token function">invokeReadResolve</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在<code>readOrdinaryObject()</code>中得到<code>readClassDesc(false)</code>返回的<strong>Class</strong>后<code>desc.newInstance()</code>将其实例化，</p> 
<p>并且随后会调用<strong>Class</strong>对象相应的<code>readObject()</code>、<code>readExternal</code>、<code>readResolve()</code>方法。</p> 
<p>这一部分参考<a href="https://xz.aliyun.com/t/8443#toc-0" rel="nofollow">从Weblogic原理上探究CVE-2015-4852、CVE-2016-0638、CVE-2016-3510究竟怎么一回事</a>，非常精彩的一篇文章。</p> 
<h3><a id="CVE20154852_196"></a>CVE-2015-4852</h3> 
<p><code>CVE-2015-4852</code>利用的就是<strong>CC</strong>链，<strong>CC</strong>链的启动方法在上面也说了是<code>readObject()</code>方法，而如何触发<code>readObject()</code>方法也同样在上一部分的结尾说明了就是<code>ObjectInputStream.readOrdinaryObject(boolean unshared)</code>，关注如下分支</p> 
<pre><code class="prism language-java"><span class="token comment">//ObjectInputStream.java</span>
<span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">readOrdinaryObject</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> unshared<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token punctuation">.</span><span class="token function">isExternalizable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">readExternalData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Externalizable</span><span class="token punctuation">)</span> obj<span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">readSerialData</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>会判断一下是否实现<strong>Externalizable</strong>接口，<code>AnnotationInvocationHandler</code>只实现了<strong>Serializable</strong>接口所以进入<code>readSerialData(obj, desc)</code>，并关注<code>invokeReadObject()</code>方法。</p> 
<pre><code class="prism language-java"><span class="token comment">//ObjectInputStream.java</span>
<span class="token comment">/**
 * Reads (or attempts to skip, if obj is null or is tagged with a
 * ClassNotFoundException) instance data for each serializable class of
 * object in stream, from superclass to subclass.  Expects that passHandle
 * is set to obj's handle before this method is called.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readSerialData</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">ObjectStreamClass</span> desc<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
<span class="token punctuation">{<!-- --></span>
    slotDesc<span class="token punctuation">.</span><span class="token function">invokeReadObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>进入<code>invokeReadObject()</code>方法，通过注释就知道是调用该<strong>Class</strong>对象的<code>readObject()</code>方法，在这里<strong>Class</strong>就是<code>sun.reflect.annotation.AnnotationInvocationHandler</code>。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Invokes the readObject method of the represented serializable class.
 * Throws UnsupportedOperationException if this class descriptor is not
 * associated with a class, or if the class is externalizable,
 * non-serializable or does not define readObject.
 */</span>
<span class="token keyword">void</span> <span class="token function">invokeReadObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">ObjectInputStream</span> in<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span>
           <span class="token class-name">UnsupportedOperationException</span>
           <span class="token punctuation">{<!-- --></span>
               
           <span class="token punctuation">}</span>
</code></pre> 
<p>🆗触发利用链，<code>CVE-2015-4852</code>结束。</p> 
<h3><a id="CVE20160638_249"></a>CVE-2016-0638</h3> 
<p>正如最开始所说<code>CVE-2016-0638</code>建立在<code>CVE-2015-4852</code>的基础之上而来。为了防御<code>CVE-2015-4852</code> <strong>WebLogic</strong>采用了黑名单把如下<strong>ban</strong>掉的方式。</p> 
<pre><code class="prism language-java"><span class="token class-name"><span class="token namespace">weblogic<span class="token punctuation">.</span>rjvm<span class="token punctuation">.</span></span>InboundMsgAbbrev</span><span class="token punctuation">.</span><span class="token keyword">class</span>$<span class="token class-name">ServerChannelInputStream</span>
<span class="token class-name"><span class="token namespace">weblogic<span class="token punctuation">.</span>rjvm<span class="token punctuation">.</span></span>MsgAbbrevInputStream</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token class-name"><span class="token namespace">weblogic<span class="token punctuation">.</span>iiop<span class="token punctuation">.</span></span>Utils</span><span class="token punctuation">.</span><span class="token keyword">class</span>
</code></pre> 
<p>但是<code>CVE-2016-0638</code>找到了黑名单之外的<code>weblogic.jms.common.StreamMessageImpl</code>实现了<strong>Externalizable</strong>接口，所以在如下分支中会进入<code>readExternalData()</code>。</p> 
<pre><code class="prism language-java"><span class="token comment">//ObjectInputStream.java</span>
<span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">readOrdinaryObject</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> unshared<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token punctuation">.</span><span class="token function">isExternalizable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">readExternalData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Externalizable</span><span class="token punctuation">)</span> obj<span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">readSerialData</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这回不需要看注释了，非常直接。</p> 
<pre><code class="prism language-java"><span class="token comment">//ObjectInputStream.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readExternalData</span><span class="token punctuation">(</span><span class="token class-name">Externalizable</span> obj<span class="token punctuation">,</span> <span class="token class-name">ObjectStreamClass</span> desc<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
<span class="token punctuation">{<!-- --></span>
    obj<span class="token punctuation">.</span><span class="token function">readExternal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>而<code>StreamMessageImpl</code>因为实现了<strong>Externalizable</strong>接口，所以需要实现<code>readExternal()</code>方法。</p> 
<pre><code class="prism language-java"><span class="token comment">//StreamMessageImpl.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readExternal</span><span class="token punctuation">(</span><span class="token class-name">ObjectInput</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">readExternal</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span> var2 <span class="token operator">=</span> var1<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>var3 <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> var3 <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>var3<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> var1<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
                var1<span class="token punctuation">.</span><span class="token function">readFully</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ByteArrayInputStream</span> var4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ObjectInputStream</span> var5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>var4<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>var5<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在<code>readExternal()</code>方法里会调用<code>var5.readObject()</code>，而<strong>var5</strong>就是<code>AnnotationInvocationHandler</code>，再次<strong>RCE</strong>成功。</p> 
<h3><a id="CVE20163510_313"></a>CVE-2016-3510</h3> 
<p><code>CVE-2016-3510</code>的思路跟上一个一模一样。这回找到的是在黑名单之外的<code>weblogic.corba.utils.MarshalledObject</code>。而<code>MarshalledObject</code>利用的则是<code>readResolve()</code>方法，首先看看<code>MarshalledObject</code>的构造器。</p> 
<pre><code class="prism language-java"><span class="token comment">//MarshalledObject.java</span>
<span class="token keyword">public</span> <span class="token class-name">MarshalledObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>var1 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ByteArrayOutputStream</span> var2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MarshalledObjectOutputStream</span> var3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MarshalledObjectOutputStream</span><span class="token punctuation">(</span>var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        var3<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        var3<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>objBytes <span class="token operator">=</span> var2<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到构造器会将<strong>var1</strong>写入<code>ByteArrayOutputStream</code>然后<code>toByteArray()</code>转换为<strong>Byte</strong>数组并赋值给<code>this.objBytes</code>，接下来分析一下<code>MarshalledObject</code>的。</p> 
<pre><code class="prism language-java"><span class="token comment">//MarshalledObject.java</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">readResolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">ObjectStreamException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>objBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ByteArrayInputStream</span> var1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>objBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> var2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> var3 <span class="token operator">=</span> var2<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var2<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> var3<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到在<code>readResolve()</code>方法中，会把<code>this.objBytes</code>反序列化并调用其<code>readObject()</code>方法。那么就很明了了，我们只要把<strong>CC</strong>利用链作为<strong>var1</strong>把<strong>MarshalledObject new</strong>出来然后调用<code>readResolve()</code>就好了。</p> 
<p>重新看回<code>readOrdinaryObject()</code>。·<code>hasReadResolveMethod()</code>方法判断<strong>desc</strong>的<strong>readResolveMethod</strong>是否为<strong>null</strong>，如果为<strong>null</strong>则不进入<strong>if</strong>语句块。</p> 
<pre><code class="prism language-java"><span class="token comment">//ObjectInputStream.java</span>
<span class="token comment">/**
 * Reads and returns "ordinary" (i.e., not a String, Class,
 * ObjectStreamClass, array, or enum constant) object, or null if object's
 * class is unresolvable (in which case a ClassNotFoundException will be
 * associated with object's handle).  Sets passHandle to object's assigned
 * handle.
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">readOrdinaryObject</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> unshared<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
        handles<span class="token punctuation">.</span><span class="token function">lookupException</span><span class="token punctuation">(</span>passHandle<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
        desc<span class="token punctuation">.</span><span class="token function">hasReadResolveMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> rep <span class="token operator">=</span> desc<span class="token punctuation">.</span><span class="token function">invokeReadResolve</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这回关注的是<code>invokeReadResolve(obj)</code>方法，跟进去看注释就好了。能进入就说明<strong>desc</strong>的<strong>readResolveMethod</strong>不为空，而且可以看到在<code>invokeReadResolve(obj)</code>方法中会通过<code>readResolveMethod.invoke()</code>来调用<code>readResolve()</code>方法。</p> 
<pre><code class="prism language-java"><span class="token comment">//ObjectInputStream.java</span>
<span class="token comment">/**
 * Invokes the readResolve method of the represented serializable class and
 * returns the result.  Throws UnsupportedOperationException if this class
 * descriptor is not associated with a class, or if the class is
 * non-serializable or does not define readResolve.
 */</span>
<span class="token class-name">Object</span> <span class="token function">invokeReadResolve</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">UnsupportedOperationException</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ObjectStreamClass</span> desc <span class="token operator">=</span> <span class="token function">readClassDesc</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">requireInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>readResolveMethod <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> readResolveMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>那么<strong>readResolveMethod</strong>属性为什么就是<code>readResolve()</code>方法呢？把目光放到<code>java.io.ObjectStreamClass</code>的构造器上</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectStreamClass</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">/** class-defined readResolve method, or null if none */</span>
    <span class="token keyword">private</span> <span class="token class-name">Method</span> readResolveMethod<span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * Creates local class descriptor representing given class.
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">ObjectStreamClass</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cl <span class="token operator">=</span> cl<span class="token punctuation">;</span>
        <span class="token comment">//...</span>
        readResolveMethod <span class="token operator">=</span> <span class="token function">getInheritableMethod</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> <span class="token string">"readResolve"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p>也就是说在构造<code>ObjectStreamClass</code>时会把<strong>cl</strong>的<code>readResolve()</code>方法赋值到<strong>readResolveMethod</strong>属性上。而<strong>cl</strong>自然就是<code>MarshalledObject</code>。</p> 
<p>到此3个<strong>CVE</strong>都分析完了，可以说都不是很难。</p> 
<p>参考文章：</p> 
<ul><li><a href="https://paper.seebug.org/1012/#_6" rel="nofollow">WebLogic 安全研究报告</a></li><li><a href="https://cert.360.cn/report/detail?id=0de94a3cd4c71debe397e2c1a036436f" rel="nofollow">weblogic t3 协议利用与防御</a></li><li><a href="https://xz.aliyun.com/t/8443#toc-7" rel="nofollow">从Weblogic原理上探究CVE-2015-4852、CVE-2016-0638、CVE-2016-3510究竟怎么一回事</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/255c0e19a2237f4d681f468f60e7c179/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">高并发内存池(学习tcmalloc)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/be19494372074e2ed14817b716e56f00/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">oracledb_exporter监控Oracle，一个入侵性极低的监控方案。</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>