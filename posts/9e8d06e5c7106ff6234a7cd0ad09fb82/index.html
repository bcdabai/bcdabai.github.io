<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>4【Android 12】【WCT的同步】BLASTSyncEngine - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="4【Android 12】【WCT的同步】BLASTSyncEngine" />
<meta property="og:description" content="一、BLASTSyncEngine定义 /** * Utility class for collecting WindowContainers that will merge transactions. * For example to use to synchronously resize all the children of a window container * 1. Open a new sync set, and pass the listener that will be invoked * int id startSyncSet(TransactionReadyListener) * the returned ID will be eventually passed to the TransactionReadyListener in combination * with a set of WindowContainers that are ready, meaning onTransactionReady was called for * those WindowContainers." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9e8d06e5c7106ff6234a7cd0ad09fb82/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-07T22:54:59+08:00" />
<meta property="article:modified_time" content="2022-09-07T22:54:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">4【Android 12】【WCT的同步】BLASTSyncEngine</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/38/92/uLSc3oWA_o.jpg" alt="在这里插入图片描述"></p> 
<h2><a id="BLASTSyncEngine_3"></a>一、BLASTSyncEngine定义</h2> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Utility class for collecting WindowContainers that will merge transactions.
 * For example to use to synchronously resize all the children of a window container
 *   1. Open a new sync set, and pass the listener that will be invoked
 *        int id startSyncSet(TransactionReadyListener)
 *      the returned ID will be eventually passed to the TransactionReadyListener in combination
 *      with a set of WindowContainers that are ready, meaning onTransactionReady was called for
 *      those WindowContainers. You also use it to refer to the operation in future steps.
 *   2. Ask each child to participate:
 *       addToSyncSet(int id, WindowContainer wc)
 *      if the child thinks it will be affected by a configuration change (a.k.a. has a visible
 *      window in its sub hierarchy, then we wi`ll increment a counter of expected callbacks
 *      At this point the containers hierarchy will redirect pendingTransaction and sub hierarchy
 *      updates in to the sync engine.
 *   3. Apply your configuration changes to the window containers.
 *   4. Tell the engine that the sync set is ready
 *       setReady(int id)
 *   5. If there were no sub windows anywhere in the hierarchy to wait on, then
 *      transactionReady is immediately invoked, otherwise all the windows are poked
 *      to redraw and to deliver a buffer to {@link WindowState#finishDrawing}.
 *      Once all this drawing is complete, all the transactions will be merged and delivered
 *      to TransactionReadyListener.
 *
 * This works primarily by setting-up state and then watching/waiting for the registered subtrees
 * to enter into a "finished" state (either by receiving drawn content or by disappearing). This
 * checks the subtrees during surface-placement.
 */</span>
<span class="token keyword">class</span> <span class="token class-name">BLASTSyncEngine</span>
</code></pre> 
<p>渣翻：</p> 
<p>用于收集将merge transactions的WindowContainers 的工具类。</p> 
<p>例如用于同步调整一个WindowContainer下的所有子WindowContainer的尺寸 ：</p> 
<p>1)、打开一个新的同步集，并传递将被调用的listener：</p> 
<pre><code class="prism language-java"><span class="token keyword">int</span> id <span class="token function">startSyncSet</span><span class="token punctuation">(</span><span class="token class-name">TransactionReadyListener</span><span class="token punctuation">)</span> 
</code></pre> 
<p>返回的ID最终会与一组准备好的WindowContainers一起传递给TransactionReadyListener，这意味那些WindowContainers已经调用了onTransactionReady。您还可以使用它来指代以后步骤中的操作。</p> 
<p>2)、 要求每个子容器参与：</p> 
<pre><code class="prism language-java"> <span class="token function">addToSyncSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token class-name">WindowContainer</span> wc<span class="token punctuation">)</span>
</code></pre> 
<p>如果子容器认为它会受到Configuration更改的影响（也就是在其子层次结构中有一个可见的窗口，那么我们将增加一个预期的计数器回调）。此时，容器层次结构会将 pendingTransaction 和子层次结构更新重定向到同步引擎。</p> 
<p>3)、将configurationchanges应用到WindowContainers。</p> 
<p>4)、告诉BLASTSyncEngine同步集已准备好：</p> 
<pre><code class="prism language-java"><span class="token function">setReady</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span>
</code></pre> 
<p>5)、如果层次结构中的任何地方都没有子窗口等待，则立即调用transactionReady，否则所有窗口都将被推动去重绘和去给WindowState#finishDrawing传送缓冲区。一旦所有这些绘制完成，所有transaction将被合并并且交付给 TransactionReadyListener。</p> 
<p>这主要通过设置状态然后观察/等待注册的子树进入“完成”状态（通过接收绘制的内容或消失）来工作。这会在surface-placement期间检查子树。</p> 
<p>根据WindowOrganizerController的情况看下1-5条的执行情况。</p> 
<h2><a id="_72"></a>二、同步流程分析</h2> 
<p>在分析WindowContainerTransaction的应用时，关于WindowContainerTransaction#applySyncTransaction方法，当时是跳过了很多内容直接去分析WindowContainerTransaction是如何应用到WindowContainer上了，那些跳过的内容也就是和同步机制相关的，这次就来跟踪下同步的流程。</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">applySyncTransaction</span><span class="token punctuation">(</span><span class="token class-name">WindowContainerTransaction</span> t<span class="token punctuation">,</span>
            <span class="token class-name">IWindowContainerTransactionCallback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">enforceTaskPermission</span><span class="token punctuation">(</span><span class="token string">"applySyncTransaction()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Null transaction passed to applySyncTransaction"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> ident <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGlobalLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/**
                 * If callback is non-null we are looking to synchronize this transaction by
                 * collecting all the results in to a SurfaceFlinger transaction and then delivering
                 * that to the given transaction ready callback. See {@link BLASTSyncEngine} for the
                 * details of the operation. But at a high level we create a sync operation with a
                 * given ID and an associated callback. Then we notify each WindowContainer in this
                 * WindowContainer transaction that it is participating in a sync operation with
                 * that ID. Once everything is notified we tell the BLASTSyncEngine "setSyncReady"
                 * which means that we have added everything to the set. At any point after this,
                 * all the WindowContainers will eventually finish applying their changes and notify
                 * the BLASTSyncEngine which will deliver the Transaction to the callback.
                 */</span>
                <span class="token keyword">int</span> syncId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    syncId <span class="token operator">=</span> <span class="token function">startSyncWithOrganizer</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">applyTransaction</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> syncId<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/*transition*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>syncId <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">setSyncReady</span><span class="token punctuation">(</span>syncId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> syncId<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="1_BLASTSyncEnginestartSyncSetSyncGroup_115"></a>1 调用BLASTSyncEngine#startSyncSet创建SyncGroup</h3> 
<p>WindowOrganizerController#applyTransaction的根据之前的分析，已经知道了，就是为WindowContainer应用WindowContainerTransaction中的设置。</p> 
<p>在applyTransaction之前，有这样一个操作：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">applySyncTransaction</span><span class="token punctuation">(</span><span class="token class-name">WindowContainerTransaction</span> t<span class="token punctuation">,</span>
            <span class="token class-name">IWindowContainerTransactionCallback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGlobalLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/**
                 * If callback is non-null we are looking to synchronize this transaction by
                 * collecting all the results in to a SurfaceFlinger transaction and then delivering
                 * that to the given transaction ready callback. See {@link BLASTSyncEngine} for the
                 * details of the operation. But at a high level we create a sync operation with a
                 * given ID and an associated callback. Then we notify each WindowContainer in this
                 * WindowContainer transaction that it is participating in a sync operation with
                 * that ID. Once everything is notified we tell the BLASTSyncEngine "setSyncReady"
                 * which means that we have added everything to the set. At any point after this,
                 * all the WindowContainers will eventually finish applying their changes and notify
                 * the BLASTSyncEngine which will deliver the Transaction to the callback.
                 */</span>
                <span class="token keyword">int</span> syncId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    syncId <span class="token operator">=</span> <span class="token function">startSyncWithOrganizer</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">applyTransaction</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> syncId<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/*transition*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里，如果是通过WindowOrganizer#applyTransaction，那么这里传入callback的就是null。</p> 
<p>如果是WindowOrganizer#applySyncTransaction，就会传入一个callback，之前分析WCT的发送的时候，知道这里的callback是一个SyncCallback类型的回调。接下来看下callback不为空的情况。</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token keyword">int</span> <span class="token function">startSyncWithOrganizer</span><span class="token punctuation">(</span><span class="token class-name">IWindowContainerTransactionCallback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> id <span class="token operator">=</span> mService<span class="token punctuation">.</span>mWindowManager<span class="token punctuation">.</span>mSyncEngine<span class="token punctuation">.</span><span class="token function">startSyncSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mTransactionCallbacksByPendingSyncId<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里调用了BLASTSyncEngine#startSyncSet，BLASTSyncEngine#startSyncSet返回了一个唯一的ID，接着把这个ID和callback存储到HashMp类型的mTransactionCallbacksByPendingSyncId中去，那么可以知道ID和callback应该是一一对应的关系。后续当WM端的transaction完成后，在WindowOrganizerController#onTransactionReady中会根据ID再取回callback。</p> 
<p>接着看下BLASTSyncEngine#startSyncSet都干了什么。</p> 
<pre><code class="prism language-java">    <span class="token keyword">int</span> <span class="token function">startSyncSet</span><span class="token punctuation">(</span><span class="token class-name">TransactionReadyListener</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> id <span class="token operator">=</span> mNextSyncId<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">SyncGroup</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncGroup</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mActiveSyncs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>WM_DEBUG_SYNC_ENGINE<span class="token punctuation">,</span> <span class="token string">"SyncGroup %d: Started for listener: %s"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>1)、将mNextSyncId赋值给id，然后自增1。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> mNextSyncId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里看到，mNextSyncId是BLASTSyncEngine的成员变量，由于BLASTSyncEngine只在WMS的构造器中创建了一次，唯一实例由WMS持有，那么可以知道mNextSyncId也是全局唯一一份，每次BLASTSyncEngine#startSyncSet都会自增1，保证了ID的唯一性。</p> 
<p>2)、以这个唯一ID和传入的WindowOrganizerController对象为基础，创建了一个SyncGroup对象。</p> 
<pre><code class="prism language-java">        <span class="token keyword">private</span> <span class="token class-name">SyncGroup</span><span class="token punctuation">(</span><span class="token class-name">TransactionReadyListener</span> listener<span class="token punctuation">,</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mSyncId <span class="token operator">=</span> id<span class="token punctuation">;</span>
            mListener <span class="token operator">=</span> listener<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>SyncGroup是BLASTSyncEngine的内部类，创建的唯一位置便是在BLASTSyncEngine#startSyncSet。</p> 
<p>3)、将ID和创建的SyncGroup对象加入到mActiveSyncs队列中。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SparseArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SyncGroup</span><span class="token punctuation">&gt;</span></span> mActiveSyncs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparseArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>mActiveSyncs是BLASTSyncEngine的成员变量。</p> 
<p>4)、最后，将这个具有唯一性的ID返回。</p> 
<p>那么这个ID的值是唯一的，对应了一个SyncGroup对象，也对应了一个callback。</p> 
<h3><a id="2_BLASTSyncEngineaddToSyncSetWindowContainerSyncGroup_211"></a>2 调用BLASTSyncEngine#addToSyncSet将所有参与同步的WindowContainer添加到SyncGroup中</h3> 
<p>在WindowOrganizerController#startSyncWithOrganizer之后，便是调用WindowOrganizerController#applyTransaction来为WindowContainer应用WindowContainerTransaction设置的修改（即Configuration更改，层级调整之类的）：</p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * @param syncId If non-null, this will be a sync-transaction.
     * @param transition A transition to collect changes into.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applyTransaction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">WindowContainerTransaction</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> syncId<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Transition</span> transition<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&lt;</span><span class="token class-name">IBinder</span><span class="token punctuation">,</span> <span class="token class-name">WindowContainerTransaction<span class="token punctuation">.</span>Change</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entries <span class="token operator">=</span>
                    t<span class="token punctuation">.</span><span class="token function">getChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token comment">// Make sure we add to the syncSet before performing</span>
                <span class="token comment">// operations so we don't end up splitting effects between the WM</span>
                <span class="token comment">// pending transaction and the BLASTSync transaction.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>syncId <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">addToSyncSet</span><span class="token punctuation">(</span>syncId<span class="token punctuation">,</span> wc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>transition <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> transition<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>wc<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> containerEffect <span class="token operator">=</span> <span class="token function">applyWindowContainerChange</span><span class="token punctuation">(</span>wc<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            mService<span class="token punctuation">.</span><span class="token function">continueWindowLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>然而在调用WindowOrganizerController#applyWindowContainerChange方法应用之前修改之前，还有一个重要的步骤：</p> 
<pre><code class="prism language-java">                <span class="token comment">// Make sure we add to the syncSet before performing</span>
                <span class="token comment">// operations so we don't end up splitting effects between the WM</span>
                <span class="token comment">// pending transaction and the BLASTSync transaction.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>syncId <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">addToSyncSet</span><span class="token punctuation">(</span>syncId<span class="token punctuation">,</span> wc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
</code></pre> 
<p>这个方法目前看到有三处需要执行，一是在WindowOrganizerController#applyWindowContainerChange之前，二是在WindowOrganizerController#reparentChildrenTasksHierarchyOp之前，三是在WindowOrganizerController#sanitizeAndApplyHierarchyOp之前。</p> 
<p>接下来分析WindowOrganzierController#addToSyncSet的内容：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token keyword">void</span> <span class="token function">addToSyncSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> syncId<span class="token punctuation">,</span> <span class="token class-name">WindowContainer</span> wc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mService<span class="token punctuation">.</span>mWindowManager<span class="token punctuation">.</span>mSyncEngine<span class="token punctuation">.</span><span class="token function">addToSyncSet</span><span class="token punctuation">(</span>syncId<span class="token punctuation">,</span> wc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>WindowOrganizerController#addToSyncSet调用了BLASTSyncEngine#addToSyncSet。</p> 
<pre><code class="prism language-java">    <span class="token keyword">void</span> <span class="token function">addToSyncSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token class-name">WindowContainer</span> wc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mActiveSyncs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addToSync</span><span class="token punctuation">(</span>wc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>在第一小节中我们创建了SyncGroup对象，并且和ID是一一对应，保存在了BLASTSyncEngine的成员变量mActiveSyncs中，所以这里就可以通过ID从mActiveSyncs中拿到对应的SyncGroup。</p> 
<p>那么这里调用的就是SyncGroup#addToSyncSet：</p> 
<pre><code class="prism language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addToSync</span><span class="token punctuation">(</span><span class="token class-name">WindowContainer</span> wc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mRootMembers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>WM_DEBUG_SYNC_ENGINE<span class="token punctuation">,</span> <span class="token string">"SyncGroup %d: Adding to group: %s"</span><span class="token punctuation">,</span> mSyncId<span class="token punctuation">,</span> wc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            wc<span class="token punctuation">.</span><span class="token function">setSyncGroup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wc<span class="token punctuation">.</span><span class="token function">prepareSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mWm<span class="token punctuation">.</span>mWindowPlacerLocked<span class="token punctuation">.</span><span class="token function">requestTraversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>接下来的内容就是，之前BLASTSyncEngine注释中所提到的，将所有参与同步的WindowContainer都加入到同步集中，参与同步的WindowContainer，也就是WindowContainerTransaction中保存的那些客户端指定的WindowContainer。</p> 
<p>逐步分析SyncGroup#addToSync的内容。</p> 
<h4><a id="21_WindowContainerSyncGroupmRootMembers_297"></a>2.1 将传入的WindowContainer加入到SyncGroup的mRootMembers队列</h4> 
<pre><code class="prism language-java">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mRootMembers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre> 
<p>mRootMembers是SyncGroup的成员变量：</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token class-name">ArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WindowContainer</span><span class="token punctuation">&gt;</span></span> mRootMembers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里使用ArraySet保证WindowContainer只会被添加一次，毕竟我们上面看到，入口有三处。</p> 
<p>后续SyncGroup通过遍历mRootMembers队列来判断所有参与同步的WindowContainer是否完成同步。</p> 
<h4><a id="22_WindowContainersetSyncGroup_315"></a>2.2 WindowContainer#setSyncGroup</h4> 
<pre><code class="prism language-java">    <span class="token keyword">void</span> <span class="token function">setSyncGroup</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">BLASTSyncEngine<span class="token punctuation">.</span>SyncGroup</span> group<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>WM_DEBUG_SYNC_ENGINE<span class="token punctuation">,</span> <span class="token string">"setSyncGroup #%d on %s"</span><span class="token punctuation">,</span> group<span class="token punctuation">.</span>mSyncId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>group <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSyncGroup <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mSyncGroup <span class="token operator">!=</span> group<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Can't sync on 2 engines simultaneously"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        mSyncGroup <span class="token operator">=</span> group<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>很简单，将WindowContainer.mSyncGroup指向当前SyncGroup。</p> 
<p>WindowContainer的成员变量mSyncGroup的定义是：</p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * If non-null, references the sync-group directly waiting on this container. Otherwise, this
     * container is only being waited-on by its parents (if in a sync-group). This has implications
     * on how this container is handled during parent changes.
     */</span>
    <span class="token class-name">BLASTSyncEngine<span class="token punctuation">.</span>SyncGroup</span> mSyncGroup <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre> 
<p>如果非空，说明其SyncGroup正在等待此WindowContainer。否则，这个WindowCOntainer只会被它的父WindowContainer等待（如果在SyncGroup中）。这会影响在父WindowContainer更改期间这个WindowContainer要如何被处理。</p> 
<h4><a id="23_WindowContainerprepareSync_344"></a>2.3 WindowContainer#prepareSync</h4> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * Prepares this container for participation in a sync-group. This includes preparing all its
     * children.
     *
     * @return {@code true} if something changed (eg. this wasn't already in the sync group).
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">prepareSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSyncState <span class="token operator">!=</span> SYNC_STATE_NONE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Already part of sync</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">WindowContainer</span> child <span class="token operator">=</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            child<span class="token punctuation">.</span><span class="token function">prepareSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mSyncState <span class="token operator">=</span> SYNC_STATE_READY<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里新增了一个WindowContainer.mSyncState的概念：</p> 
<pre><code class="prism language-java">    <span class="token comment">/** This isn't participating in a sync. */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SYNC_STATE_NONE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/** This is currently waiting for itself to finish drawing. */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SYNC_STATE_WAITING_FOR_DRAW <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">/** This container is ready, but it might still have unfinished children. */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SYNC_STATE_READY <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@IntDef</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"SYNC_STATE_"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            SYNC_STATE_NONE<span class="token punctuation">,</span>
            SYNC_STATE_WAITING_FOR_DRAW<span class="token punctuation">,</span>
            SYNC_STATE_READY<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@interface</span> <span class="token class-name">SyncState</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<p>SYNC_STATE_NONE表示当前WindowContainer没有参与到一次同步操作中。</p> 
<p>SYNC_STATE_WAITING_FOR_DRAW表示当前WindowContainer正在等待自身绘制完成。</p> 
<p>SYNC_STATE_READY表示当前WindowContainer已经绘制完成，但是其子WindowContainer中可能还有没有完成同步的。</p> 
<p>可以看到，在同步之前，需要将mSyncState置为SYNC_STATE_READY。如果mSyncState不是SYNC_STATE_NONE，表示当前WindowContainer仍然处于同步过程中。并且这里还调用了子容器的prepareSync方法，这一步将使得所有子容器的mSyncState都被置为SYNC_STATE_READY。</p> 
<p>这里可能会比较疑惑，为什么直接就把WindowContainer的mSyncState的状态设置为SYNC_STATE_READY了，同步不是才刚开始？我们看到，除了WindowContainer有prepareSync方法之外，WindowState也重写了这个方法：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">boolean</span> <span class="token function">prepareSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">prepareSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// In the WindowContainer implementation we immediately mark ready</span>
        <span class="token comment">// since a generic WindowContainer only needs to wait for its</span>
        <span class="token comment">// children to finish and is immediately ready from its own</span>
        <span class="token comment">// perspective but at the WindowState level we need to wait for ourselves</span>
        <span class="token comment">// to draw even if the children draw first our don't need to sync, so we start</span>
        <span class="token comment">// in WAITING state rather than READY.</span>
        mSyncState <span class="token operator">=</span> SYNC_STATE_WAITING_FOR_DRAW<span class="token punctuation">;</span>
        <span class="token function">requestRedrawForSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mWmService<span class="token punctuation">.</span>mH<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>WINDOW_STATE_BLAST_SYNC_TIMEOUT<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWmService<span class="token punctuation">.</span>mH<span class="token punctuation">.</span><span class="token function">sendNewMessageDelayed</span><span class="token punctuation">(</span>WINDOW_STATE_BLAST_SYNC_TIMEOUT<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
            BLAST_TIMEOUT_DURATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里的注释也可以解答我们刚刚的疑问：</p> 
<p>在WindowContainer的实现中，我们直接将mSyncState置为SYNC_STATE_READY，因为对于一个通用的WindowContainer而言，它只需要等待它的子WindowContainer完成同步，如果它有子WindowContainer完成同步，那么对它自己而言它也就完成同步处于就绪状态了。</p> 
<p>但是在WindowState这一层，每一个WindowState都需要等待自己绘制完成，即使子窗口先绘制完成。所以对于WindowState，是以SYNC_STATE_WAITING_FOR_DRAW状态开始而不是SYNC_STATE_READY状态。</p> 
<h3><a id="3_WindowContainerTransactionWindowContainer_426"></a>3 将WindowContainerTransaction应用到WindowContainer</h3> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">applySyncTransaction</span><span class="token punctuation">(</span><span class="token class-name">WindowContainerTransaction</span> t<span class="token punctuation">,</span>
            <span class="token class-name">IWindowContainerTransactionCallback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGlobalLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token function">applyTransaction</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> syncId<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/*transition*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这一步的具体内容在分析WCT的应用的时候有比较系统的介绍过了。</p> 
<h3><a id="4_BLASTSyncTransactionsetReadySyncGroup_447"></a>4 BLASTSyncTransaction#setReady标记SyncGroup已经准备就绪</h3> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">applySyncTransaction</span><span class="token punctuation">(</span><span class="token class-name">WindowContainerTransaction</span> t<span class="token punctuation">,</span>
            <span class="token class-name">IWindowContainerTransactionCallback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGlobalLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token function">applyTransaction</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> syncId<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/*transition*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>syncId <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">setSyncReady</span><span class="token punctuation">(</span>syncId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> syncId<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这一步发生在WindowOrganizerController#applyTransaction之后，即WindowContainerTransaction中的设置都已经应用到WindowContainer上了。</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token keyword">void</span> <span class="token function">setSyncReady</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>WM_DEBUG_WINDOW_ORGANIZER<span class="token punctuation">,</span> <span class="token string">"Set sync ready, syncId=%d"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mService<span class="token punctuation">.</span>mWindowManager<span class="token punctuation">.</span>mSyncEngine<span class="token punctuation">.</span><span class="token function">setReady</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token keyword">void</span> <span class="token function">addToSyncSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> syncId<span class="token punctuation">,</span> <span class="token class-name">WindowContainer</span> wc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mService<span class="token punctuation">.</span>mWindowManager<span class="token punctuation">.</span>mSyncEngine<span class="token punctuation">.</span><span class="token function">addToSyncSet</span><span class="token punctuation">(</span>syncId<span class="token punctuation">,</span> wc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>WindowOrganizerController#setSyncReady调用BLASTSyncEngine#setReady。</p> 
<pre><code class="prism language-java">    <span class="token keyword">void</span> <span class="token function">setReady</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ready<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mActiveSyncs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setReady</span><span class="token punctuation">(</span>ready<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">setReady</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">setReady</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>BLASTSyncEngine#setReady调用SyncGroup#setReady。</p> 
<pre><code class="prism language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setReady</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> ready<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>WM_DEBUG_SYNC_ENGINE<span class="token punctuation">,</span> <span class="token string">"SyncGroup %d: Set ready"</span><span class="token punctuation">,</span> mSyncId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mReady <span class="token operator">=</span> ready<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ready<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            mWm<span class="token punctuation">.</span>mWindowPlacerLocked<span class="token punctuation">.</span><span class="token function">requestTraversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>将SyncGroup的成员变量mReady置为true，表示所有WindowContainerTransaction都已经应用完成，然后请求一次界面刷新。</p> 
<h3><a id="5_transactionReady_508"></a>5 等待窗口绘制完成后调用transactionReady</h3> 
<p>每次刷新界面的时候，RootWindowContainer#performSurfacePlacementNoTrace会调用BLASTSyncEngine#onSurfacePlacement。</p> 
<pre><code class="prism language-java">    <span class="token keyword">void</span> <span class="token function">onSurfacePlacement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// backwards since each state can remove itself if finished</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mActiveSyncs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mActiveSyncs<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onSurfacePlacement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里又调用了SyncGroup#onSurfacePlacement。</p> 
<pre><code class="prism language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onSurfacePlacement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mReady<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>WM_DEBUG_SYNC_ENGINE<span class="token punctuation">,</span> <span class="token string">"SyncGroup %d: onSurfacePlacement checking %s"</span><span class="token punctuation">,</span>
                    mSyncId<span class="token punctuation">,</span> mRootMembers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mRootMembers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token class-name">WindowContainer</span> wc <span class="token operator">=</span> mRootMembers<span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wc<span class="token punctuation">.</span><span class="token function">isSyncFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>WM_DEBUG_SYNC_ENGINE<span class="token punctuation">,</span> <span class="token string">"SyncGroup %d:  Unfinished container: %s"</span><span class="token punctuation">,</span>
                            mSyncId<span class="token punctuation">,</span> wc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token function">finishNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>这里会对加入到mRootMembers的WindowContainer进行遍历，mRootMembers里的数据是之前调用addToSync的时候填充的。WindowContainer#isSyncFinished返回true表示当前WindowContainer同步完成。只有当mRootMembers中所有的WindowContainer都同步完成，本次同步才算结束，才可以调用SyncGroup#finishNow。</p> 
<p>由于这个方法在每次界面刷新的时候都会调用，所以这里的工作就是不断检查当前SyncGroup中的所有WindowContainer是否同步完成，一旦同步完成，就去调用SyncGroup#finishNow。</p> 
<p>这里先跳过WindowContainer#isSyncFinished，看下SyncGroup#finishNow：</p> 
<pre><code class="prism language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">finishNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>WM_DEBUG_SYNC_ENGINE<span class="token punctuation">,</span> <span class="token string">"SyncGroup %d: Finished!"</span><span class="token punctuation">,</span> mSyncId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SurfaceControl<span class="token punctuation">.</span>Transaction</span> merged <span class="token operator">=</span> mWm<span class="token punctuation">.</span>mTransactionFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mOrphanTransaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                merged<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>mOrphanTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">WindowContainer</span> wc <span class="token operator">:</span> mRootMembers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                wc<span class="token punctuation">.</span><span class="token function">finishSync</span><span class="token punctuation">(</span>merged<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* cancel */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mListener<span class="token punctuation">.</span><span class="token function">onTransactionReady</span><span class="token punctuation">(</span>mSyncId<span class="token punctuation">,</span> merged<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mActiveSyncs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>mSyncId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>SyncGroup#finishNow做了以下几件事：</p> 
<h4><a id="51_Transaction_563"></a>5.1 取得一个存放最终结果的Transaction</h4> 
<pre><code class="prism language-java">            <span class="token class-name">SurfaceControl<span class="token punctuation">.</span>Transaction</span> merged <span class="token operator">=</span> mWm<span class="token punctuation">.</span>mTransactionFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mOrphanTransaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                merged<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>mOrphanTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre> 
<p>将mOrphanTransaction合并到此Transaction中，mOrphanTransactionon从调用的地方来看，当SyncGroup中的WindowContainer的父WindowContainer发生变化时，会将该WindowContainer的mSyncTransaction合入到mOrphanTransactionon，避免该WindowContainer的mSyncTransaction保存的修改在parent更改的时候丢失。</p> 
<h4><a id="52_WindowContainerfinishSync_574"></a>5.2 调用WindowContainer#finishSync</h4> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * Recursively finishes/cleans-up sync state of this subtree and collects all the sync
     * transactions into `outMergedTransaction`.
     * @param outMergedTransaction A transaction to merge all the recorded sync operations into.
     * @param cancel If true, this is being finished because it is leaving the sync group rather
     *               than due to the sync group completing.
     */</span>
    <span class="token keyword">void</span> <span class="token function">finishSync</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span> outMergedTransaction<span class="token punctuation">,</span> <span class="token keyword">boolean</span> cancel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSyncState <span class="token operator">==</span> SYNC_STATE_NONE<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>WM_DEBUG_SYNC_ENGINE<span class="token punctuation">,</span> <span class="token string">"finishSync cancel=%b for %s"</span><span class="token punctuation">,</span> cancel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        outMergedTransaction<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>mSyncTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finishSync</span><span class="token punctuation">(</span>outMergedTransaction<span class="token punctuation">,</span> cancel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mSyncState <span class="token operator">=</span> SYNC_STATE_NONE<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cancel <span class="token operator">&amp;&amp;</span> mSyncGroup <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> mSyncGroup<span class="token punctuation">.</span><span class="token function">onCancelSync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSyncGroup <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这里传入的5.1中创建的存放最终结果的outMergedTransaction。</p> 
<p>1)、将当前WindowContainer自身的mSyncTransaction合入到outMergedTransaction。</p> 
<p>2)、WindowContainer#finishSync递归调用所有子WindowContainer#finishSync，最终将WindowContainerTransaction带来的所有Transaction变化全部都合并到outMergedTransaction。</p> 
<p>3)、将mSyncState重置为同步前的状态SYNC_STATE_NONE，mSyncGroup置空。</p> 
<h4><a id="53_TransactionReadyListeneronTransactionReady_605"></a>5.3 调用TransactionReadyListener#onTransactionReady</h4> 
<pre><code class="prism language-java">mListener<span class="token punctuation">.</span><span class="token function">onTransactionReady</span><span class="token punctuation">(</span>mSyncId<span class="token punctuation">,</span> merged<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里的TransactionReadyListener就是WindowOrganizerController，是在WindowOrganizerController调用startSyncSet创建SyncGroup的时候传入的，所以这里调用的是WindowOrganizerController#onTransactionReady：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTransactionReady</span><span class="token punctuation">(</span><span class="token keyword">int</span> syncId<span class="token punctuation">,</span> <span class="token class-name">SurfaceControl<span class="token punctuation">.</span>Transaction</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>WM_DEBUG_WINDOW_ORGANIZER<span class="token punctuation">,</span> <span class="token string">"Transaction ready, syncId=%d"</span><span class="token punctuation">,</span> syncId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">IWindowContainerTransactionCallback</span> callback <span class="token operator">=</span>
                mTransactionCallbacksByPendingSyncId<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>syncId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            callback<span class="token punctuation">.</span><span class="token function">onTransactionReady</span><span class="token punctuation">(</span>syncId<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// If there's an exception when trying to send the mergedTransaction to the client, we</span>
            <span class="token comment">// should immediately apply it here so the transactions aren't lost.</span>
            t<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mTransactionCallbacksByPendingSyncId<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>syncId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>所有参与到此次同步的WindowContainer都完成同步后，会由WindowOrganizerController根据syncId从mTransactionCallbacksByPendingSyncId中找到对应的回调对象，即SyncCallback，然后调用SyncCallback#onTransactionReady，并且传入存放了最终同步结果的Transaction。</p> 
<h4><a id="54_IDmActiveSyncs_634"></a>5.4 将ID从mActiveSyncs中移除。</h4> 
<pre><code class="prism language-java">mActiveSyncs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>mSyncId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>直到这里，本次同步操作在WM端的部分才算完成了，所有configuration更改引起的Transaction变化全部都合并到了一个Transaction中，并且传给了SystemUI，后续需要SystemUI的SyncTransactionQueue那边进行apply，之前对SyncTransactionQueue的分析中也有讲过。</p> 
<h4><a id="55_WindowContainer_642"></a>5.5 WindowContainer何时被视为同步完成</h4> 
<p>上面跳过了一个重要环节，在BLASTSyncEngine#onSurfacePlacement中，会对参与本次同步的所有WindowContainer调用WindowContainer#isSyncFinished判断其是否同步完成。只有SyncGroup中的所有WindowContainer都同步完成，才会调用SyncGroup#finishNow。</p> 
<p>当时跳过了WindowContainer#isSyncFinished的分析，这一节来详细分析一下。</p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * Checks if the subtree rooted at this container is finished syncing (everything is ready or
     * not visible). NOTE, this is not const: it will cancel/prepare itself depending on its state
     * in the hierarchy.
     *
     * @return {@code true} if this subtree is finished waiting for sync participants.
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">isSyncFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isVisibleRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSyncState <span class="token operator">==</span> SYNC_STATE_NONE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">prepareSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSyncState <span class="token operator">==</span> SYNC_STATE_WAITING_FOR_DRAW<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// READY</span>
        <span class="token comment">// Loop from top-down.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">WindowContainer</span> child <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> childFinished <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">isSyncFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>childFinished <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span><span class="token function">isVisibleRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span><span class="token function">fillsParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Any lower children will be covered-up, so we can consider this finished.</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>childFinished<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>判断一个WindowContainer是否完成同步，不仅当前WindowContainer的mSyncState得是SYNC_STATE_READY，它的子WindowContainer也要有完成同步的。</p> 
<p>根据之前对WindowContaIner#prepareSync的分析，非WindowState类型的容器，在同步开始的时候都已经在WindowContainer#prepareSync中设置其mSyncState为SYNC_STATE_READY了，所以这里只需要看WindowState类型的子容器有没有就绪就好了，其它类型的WIndowContainer都不需要关注。</p> 
<p>另外WindowState类型的容器一开始在WindowState#prepareSync中将mSyncState设置为SYNC_STATE_WAITING_FOR_DRAW，那么对于WindowState来说，isSyncFinished方法能够返回true，首要条件就是，mSyncState必须在后续被设置为SYNC_STATE_READY，这一步只能在WindowContainer#onSyncFinishedDrawing：</p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * Call this when this container finishes drawing content.
     *
     * @return {@code true} if consumed (this container is part of a sync group).
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">onSyncFinishedDrawing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSyncState <span class="token operator">==</span> SYNC_STATE_NONE<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        mSyncState <span class="token operator">=</span> SYNC_STATE_READY<span class="token punctuation">;</span>
        mWmService<span class="token punctuation">.</span>mWindowPlacerLocked<span class="token punctuation">.</span><span class="token function">requestTraversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>WM_DEBUG_SYNC_ENGINE<span class="token punctuation">,</span> <span class="token string">"onSyncFinishedDrawing %s"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>WindowContainer#onSyncFinishedDrawing唯一调用的地方又在WindowState#finishDrawing：</p> 
<pre><code class="prism language-java">    <span class="token keyword">boolean</span> <span class="token function">finishDrawing</span><span class="token punctuation">(</span><span class="token class-name">SurfaceControl<span class="token punctuation">.</span>Transaction</span> postDrawTransaction<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOrientationChangeRedrawRequestTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> duration <span class="token operator">=</span>
                    <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> mOrientationChangeRedrawRequestTime<span class="token punctuation">;</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"finishDrawing of orientation change: "</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> duration <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mOrientationChangeRedrawRequestTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mActivityRecord <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mActivityRecord<span class="token punctuation">.</span>mRelaunchStartTime <span class="token operator">!=</span> <span class="token number">0</span>
                <span class="token operator">&amp;&amp;</span> mActivityRecord<span class="token punctuation">.</span><span class="token function">findMainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> duration <span class="token operator">=</span>
                    <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> mActivityRecord<span class="token punctuation">.</span>mRelaunchStartTime<span class="token punctuation">;</span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"finishDrawing of relaunch: "</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> duration <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mActivityRecord<span class="token punctuation">.</span>mRelaunchStartTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">executeDrawHandlers</span><span class="token punctuation">(</span>postDrawTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">onSyncFinishedDrawing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mWinAnimator<span class="token punctuation">.</span><span class="token function">finishDrawingLocked</span><span class="token punctuation">(</span>postDrawTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>postDrawTransaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mSyncTransaction<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>postDrawTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mWinAnimator<span class="token punctuation">.</span><span class="token function">finishDrawingLocked</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// We always want to force a traversal after a finish draw for blast sync.</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这个方法唯一的调用栈是从APP端调过来的：</p> 
<p>ViewRootImpl#reportedDrawFinished</p> 
<pre><code>-&gt; Session#finishDrawing

	（跨进程）

	-&gt; WMS#finishDrawingWindow

		-&gt; WindowState#finishDrawing

			-&gt; WindowContainer#onSyncFinishedDrawing
</code></pre> 
<p>那么也就是说，只有APP端完成了界面绘制并且通知到了WM端，当前WindowState才能设置其mSyncState为SYNC_STATE_READY。</p> 
<p>然而这个还是条件之一，判断一个WindowContainer是否完成同步，还有其他限制：</p> 
<pre><code class="prism language-java">        <span class="token comment">// READY</span>
        <span class="token comment">// Loop from top-down.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">WindowContainer</span> child <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> childFinished <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">isSyncFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>childFinished <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span><span class="token function">isVisibleRequested</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span><span class="token function">fillsParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Any lower children will be covered-up, so we can consider this finished.</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>childFinished<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre> 
<p>1)、如果我们能先找到一个已经完成绘制的子窗口，并且该子窗口后续要显示，且能够覆盖的了它下面的所有子窗口，那么可以认为当前WindowContainer绘制完成。</p> 
<p>2)、如果我们找不到一个满足条件1的子窗口，但是所有窗口都已经绘制完成，那么也可以认为当前WindowContainer绘制完成；</p> 
<p>3)、如果我们在找到一个满足条件1的子窗口之前，先找到一个没有完成绘制的子窗口，那么就认为当前WindowContainer没有绘制完成。</p> 
<h2><a id="_777"></a>三、总结</h2> 
<h3><a id="1_BLASTSyncEngine_779"></a>1 BLASTSyncEngine机制流程</h3> 
<p>1)、在WindowOrganizerController#applyTransaction之前，调用BLASTSyncEngine#startSyncSet，创建一个拥有唯一ID的SyncGroup对象：</p> 
<p>WindowOrganizerController#startSyncWithOrganizer</p> 
<pre><code>-&gt; BLASTSyncEngine#startSyncSet
</code></pre> 
<p>2)、在WindowContainerTransaction中的设置应用到各个WindowContainer之前，调用BLASTSyncEngine#addToSyncSet将这些要应用WindowContainerTransaction的WindowContainer加入到SyncGroup中，并且调用WindowContainer#prepareSync为这些WindowContainer设置初始状态：</p> 
<p>WindowOrganizerController#addToSyncSet</p> 
<pre><code>-&gt; BLASTSyncEngine#addToSyncSet 

	-&gt; SyncGroup#addToSync 

		-&gt; WindowContainer#prepareSync
</code></pre> 
<p>3)、所有参与同步的WindowContainer应用WindowContainerTransaction。</p> 
<p>4)、所有参与同步的WindowContainer应用WindowContainerTransaction之后，通知BLASTSyncEngineSyncGroup已经准备就绪，可以开始请求绘制。</p> 
<p>WindowOrganizerController#setSyncReady</p> 
<pre><code>-&gt; BLASTSyncEngine#setReady 

	-&gt; BLASTSyncEngine#setReady 

		-&gt; SyncGroup#setReady
</code></pre> 
<p>随后在每次界面刷新时，都会调用BLASTSyncEngine#onSurfacePlacement，不断去检查本次SyncGroup中的所有WindowContainer是否已经全部完成同步：</p> 
<p>RootWindowContainer#performSurfacePlacementNoTrace</p> 
<pre><code>-&gt; BLASTSyncEngine#onSurfacePlacement 

	-&gt; SyncGroup#onSurfacePlacement
</code></pre> 
<p>5)、一旦所有的容器都已经同步完成，那么调用WindowContainer#finishSync将所有参与同步WindowContainer的有关于Transaction改动，即WindowContainer的成员变量mSyncTransaction和SyncGroup的成员变量mOrphanTransaction，合入到一个Transaction中，再将该Transaction传给WindowOrganizerController，最终发送给客户端（这里就是SyncCallback）：</p> 
<p>SyncGroup#onSurfacePlacement</p> 
<pre><code>-&gt; SyncGroup#finishNow 

	-&gt; WindowOrganizerController#onTransactionReady 

		（跨进程）

		-&gt; SyncCallback#onTransactionReady
</code></pre> 
<h3><a id="2_WindowContainermSyncState_829"></a>2 WindowContainer同步状态mSyncState</h3> 
<p>有三种状态：SYNC_STATE_NONE、SYNC_STATE_WAITING_FOR_DRAW和SYNC_STATE_READY，看下都是在什么时候设置的。</p> 
<p>1)、同步开始，所有非WindowState类型的WindowContainer的mSyncState会被设置为SYNC_STATE_READY：</p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * Prepares this container for participation in a sync-group. This includes preparing all its
     * children.
     *
     * @return {@code true} if something changed (eg. this wasn't already in the sync group).
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">prepareSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSyncState <span class="token operator">!=</span> SYNC_STATE_NONE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Already part of sync</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">WindowContainer</span> child <span class="token operator">=</span> <span class="token function">getChildAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            child<span class="token punctuation">.</span><span class="token function">prepareSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mSyncState <span class="token operator">=</span> SYNC_STATE_READY<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>WindowState类型的容器mSyncState会被设置为SYNC_STATE_WAITING_FOR_DRAW：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">boolean</span> <span class="token function">prepareSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">prepareSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// In the WindowContainer implementation we immediately mark ready</span>
        <span class="token comment">// since a generic WindowContainer only needs to wait for its</span>
        <span class="token comment">// children to finish and is immediately ready from its own</span>
        <span class="token comment">// perspective but at the WindowState level we need to wait for ourselves</span>
        <span class="token comment">// to draw even if the children draw first our don't need to sync, so we start</span>
        <span class="token comment">// in WAITING state rather than READY.</span>
        mSyncState <span class="token operator">=</span> SYNC_STATE_WAITING_FOR_DRAW<span class="token punctuation">;</span>
        <span class="token function">requestRedrawForSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mWmService<span class="token punctuation">.</span>mH<span class="token punctuation">.</span><span class="token function">removeMessages</span><span class="token punctuation">(</span>WINDOW_STATE_BLAST_SYNC_TIMEOUT<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mWmService<span class="token punctuation">.</span>mH<span class="token punctuation">.</span><span class="token function">sendNewMessageDelayed</span><span class="token punctuation">(</span>WINDOW_STATE_BLAST_SYNC_TIMEOUT<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
            BLAST_TIMEOUT_DURATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>2)、窗口绘制完成，对于WindowState，mSyncState被设置为SYNC_STATE_READY：</p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * Call this when this container finishes drawing content.
     *
     * @return {@code true} if consumed (this container is part of a sync group).
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">onSyncFinishedDrawing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSyncState <span class="token operator">==</span> SYNC_STATE_NONE<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        mSyncState <span class="token operator">=</span> SYNC_STATE_READY<span class="token punctuation">;</span>
        mWmService<span class="token punctuation">.</span>mWindowPlacerLocked<span class="token punctuation">.</span><span class="token function">requestTraversal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>WM_DEBUG_SYNC_ENGINE<span class="token punctuation">,</span> <span class="token string">"onSyncFinishedDrawing %s"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>3)、同步结束，所有WindowContainer的mSyncState被重置为SYNC_STATE_NONE：</p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * Recursively finishes/cleans-up sync state of this subtree and collects all the sync
     * transactions into `outMergedTransaction`.
     * @param outMergedTransaction A transaction to merge all the recorded sync operations into.
     * @param cancel If true, this is being finished because it is leaving the sync group rather
     *               than due to the sync group completing.
     */</span>
    <span class="token keyword">void</span> <span class="token function">finishSync</span><span class="token punctuation">(</span><span class="token class-name">Transaction</span> outMergedTransaction<span class="token punctuation">,</span> <span class="token keyword">boolean</span> cancel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSyncState <span class="token operator">==</span> SYNC_STATE_NONE<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>WM_DEBUG_SYNC_ENGINE<span class="token punctuation">,</span> <span class="token string">"finishSync cancel=%b for %s"</span><span class="token punctuation">,</span> cancel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        outMergedTransaction<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>mSyncTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finishSync</span><span class="token punctuation">(</span>outMergedTransaction<span class="token punctuation">,</span> cancel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mSyncState <span class="token operator">=</span> SYNC_STATE_NONE<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cancel <span class="token operator">&amp;&amp;</span> mSyncGroup <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> mSyncGroup<span class="token punctuation">.</span><span class="token function">onCancelSync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mSyncGroup <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3__920"></a>3 同步完成的本质</h3> 
<p>要看一个WindowContainer（一般是Task）是否同步完成，其实是看它包含的ActivityRecord对应的窗口是否绘制完成：</p> 
<p>ViewRootImpl#reportedDrawFinished</p> 
<pre><code>-&gt; Session#finishDrawing

	（跨进程）

	-&gt; WMS#finishDrawingWindow

		-&gt; WindowState#finishDrawing

			-&gt; WindowContainer#onSyncFinishedDrawing
</code></pre> 
<p>这个依赖于APP端界面的绘制情况。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/df7cb3d58f2e061008b7c9d56acb63b0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">双色球双色球杀号公式,双色球杀号公式汇总</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9727be5c6fcba0f061ac5a6f5ca3e677/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">电量计量芯片HLWＷ8110的前端电路设计与误差分析校正</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>