<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>23.STM32 I2C实验 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="23.STM32 I2C实验" />
<meta property="og:description" content="1.I2C的通信协议 它是由数据线SDA和时钟SCL构成的串行总线，可发送和接收数据。在CPU与被控IC之间、IC与IC之间进行双向传送，高速IIC总线一般可达400kbps以上。
IIC是半双工通信方式。
1.空闲状态
SDA与SCL同时处于高电平状态时候为空闲状态
2.开始信号
当SCL为高电平期间，SDA由高电平到低电平的跳变，启动信号是一种电平跳变时序信号，而不是一个电平信号。
3.停止信号
当SCL为高电平期间，SDA由低电平到高电平的跳变。
4.应答信号
发送器每次发送一个字节，就在时钟脉冲9期间释放数据线，接收器会发送一个应答，高电平为无效应答，低电平为有效应答。
注意：在第9个信号时SDA需要拉低，而且确保在该时钟的高电平期间为稳定的低电平。
5.数据有效性
I2C总线进行数据转送时，时钟信号为高电平期间，数据线上的数据必须保持稳定，只有在时钟信号上的信号为低电平期间，数据线上的高电平或低电平在允许变化。
数据在SCL与上下降沿的时候需要已经稳定了
6.数据转输
在I2C总线上传送的每一位数据都有一个时钟脉冲相对应，即在SCL串行时钟的配合下，在SDA上逐位地串行传送每一位数据。数据位的传输是边沿触发。
2.I2C底层代码 1.初始化
void IIC_Init(void) { GPIO_InitTypeDef GPIO_Initure; __HAL_RCC_GPIOH_CLK_ENABLE(); //使能GPIOH时钟 //PH4,5初始化设置 GPIO_Initure.Pin=GPIO_PIN_4|GPIO_PIN_5; GPIO_Initure.Mode=GPIO_MODE_OUTPUT_PP; //推挽输出 GPIO_Initure.Pull=GPIO_PULLUP; //上拉 GPIO_Initure.Speed=GPIO_SPEED_FAST; //快速 HAL_GPIO_Init(GPIOH,&amp;GPIO_Initure); IIC_SDA=1; //空闲的时候需要高电平 IIC_SCL=1; } 2.起始信号
当SCL为高电平期间，SDA由高电平到低电平的跳变，启动信号是一种电平跳变时序信号，而不是一个电平信号。
void IIC_Start(void) { SDA_OUT(); //sda线输出 IIC_SDA=1;	IIC_SCL=1; delay_us(4); IIC_SDA=0;//START:when CLK is high,DATA change form high to low delay_us(4); IIC_SCL=0;//钳住I2C总线，准备发送或接收数据 }	3.停止信号
当SCL为高电平期间，SDA由低电平到高电平的跳变。
void IIC_Stop(void) { SDA_OUT();//sda线输出 IIC_SCL=0; IIC_SDA=0;//STOP:when CLK is high DATA change form low to high delay_us(4); IIC_SCL=1; delay_us(4);	IIC_SDA=1;//发送I2C总线结束信号	} 4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/748ed4af95fb4703458cdf2853da2251/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-23T09:56:30+08:00" />
<meta property="article:modified_time" content="2022-09-23T09:56:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">23.STM32 I2C实验</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1I2C_0"></a>1.I2C的通信协议</h3> 
<p>它是由数据线SDA和时钟SCL构成的串行总线，可发送和接收数据。在CPU与被控IC之间、IC与IC之间进行双向传送，高速IIC总线一般可达400kbps以上。<br> IIC是半双工通信方式。<br> <strong>1.空闲状态</strong><br> SDA与SCL同时处于高电平状态时候为空闲状态<br> <strong>2.开始信号</strong><br> 当SCL为高电平期间，SDA由高电平到低电平的跳变，启动信号是一种电平跳变时序信号，而不是一个电平信号。<br> <strong>3.停止信号</strong><br> 当SCL为高电平期间，SDA由低电平到高电平的跳变。<br> <img src="https://images2.imgbox.com/5f/b2/WwmuAB8j_o.png" alt="请添加图片描述"></p> 
<p><strong>4.应答信号</strong><br> 发送器每次发送一个字节，就在时钟脉冲9期间释放数据线，接收器会发送一个应答，高电平为无效应答，低电平为有效应答。<br> 注意：在第9个信号时SDA需要拉低，而且确保在该时钟的高电平期间为稳定的低电平。<br> <strong>5.数据有效性</strong><br> I2C总线进行数据转送时，时钟信号为高电平期间，数据线上的数据必须保持稳定，只有在时钟信号上的信号为低电平期间，数据线上的高电平或低电平在允许变化。<br> 数据在SCL与上下降沿的时候需要已经稳定了<br> <img src="https://images2.imgbox.com/1e/08/V8FoeSu9_o.png" alt="请添加图片描述"></p> 
<p><strong>6.数据转输</strong><br> 在I2C总线上传送的每一位数据都有一个时钟脉冲相对应，即在SCL串行时钟的配合下，在SDA上逐位地串行传送每一位数据。数据位的传输是边沿触发。</p> 
<h3><a id="2I2C_22"></a>2.I2C底层代码</h3> 
<p><strong>1.初始化</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">IIC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    GPIO_InitTypeDef GPIO_Initure<span class="token punctuation">;</span>
    
    <span class="token function">__HAL_RCC_GPIOH_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//使能GPIOH时钟</span>
    
    <span class="token comment">//PH4,5初始化设置</span>
    GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_4<span class="token operator">|</span>GPIO_PIN_5<span class="token punctuation">;</span>
    GPIO_Initure<span class="token punctuation">.</span>Mode<span class="token operator">=</span>GPIO_MODE_OUTPUT_PP<span class="token punctuation">;</span>  <span class="token comment">//推挽输出</span>
    GPIO_Initure<span class="token punctuation">.</span>Pull<span class="token operator">=</span>GPIO_PULLUP<span class="token punctuation">;</span>          <span class="token comment">//上拉</span>
    GPIO_Initure<span class="token punctuation">.</span>Speed<span class="token operator">=</span>GPIO_SPEED_FAST<span class="token punctuation">;</span>     <span class="token comment">//快速</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOH<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//空闲的时候需要高电平</span>
    IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>2.起始信号</strong><br> 当SCL为高电平期间，SDA由高电平到低电平的跳变，启动信号是一种电平跳变时序信号，而不是一个电平信号。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//sda线输出</span>
	IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	  	  
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 	IIC_SDA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//START:when CLK is high,DATA change form high to low </span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//钳住I2C总线，准备发送或接收数据 </span>
<span class="token punctuation">}</span>	
</code></pre> 
<p><strong>3.停止信号</strong><br> 当SCL为高电平期间，SDA由低电平到高电平的跳变。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//sda线输出</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	IIC_SDA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//STOP:when CLK is high DATA change form low to high</span>
 	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			
	IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//发送I2C总线结束信号				   	</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>4.应答信号</strong><br> 发送器每次发送一个字节，就在时钟脉冲9期间释放数据线，接收器会发送一个应答，高电平为无效应答，低电平为有效应答。<br> 产生应答</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">IIC_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SDA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//不产生ACK应答		    </span>
<span class="token keyword">void</span> <span class="token function">IIC_NAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>	
</code></pre> 
<p>等待应答</p> 
<pre><code class="prism language-c">u8 <span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 ucErrTime<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//SDA设置为输入  </span>
	IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
	<span class="token keyword">while</span><span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		ucErrTime<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>ucErrTime<span class="token operator">&gt;</span><span class="token number">250</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//时钟输出0 	   </span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>5.发送数据</strong><br> 发送数据</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>u8 txd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>                        
    u8 t<span class="token punctuation">;</span>   
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	    
    IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//拉低时钟开始数据传输</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>              
        IIC_SDA<span class="token operator">=</span><span class="token punctuation">(</span>txd<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span>
        txd<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span> 	  
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//对TEA5767这三个延时都是必须的，拉高期间发送数据</span>
		IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	 
<span class="token punctuation">}</span> 
</code></pre> 
<p>接收数据</p> 
<pre><code class="prism language-c">u8 <span class="token function">IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> ack<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span>receive<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SDA设置为输入</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
        IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        receive<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span>receive<span class="token operator">++</span><span class="token punctuation">;</span>   
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>					 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ack<span class="token punctuation">)</span>
        <span class="token function">IIC_NAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送nACK</span>
    <span class="token keyword">else</span>
        <span class="token function">IIC_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//发送ACK   </span>
    <span class="token keyword">return</span> receive<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3I2Chttpsimgblogcsdnimgcna9fab69782ef4683b3214e079c631601png_162"></a>3.I2C硬件连接<img src="https://images2.imgbox.com/9d/44/kGYnNDTT_o.png" alt="请添加图片描述"></h3> 
<h3><a id="4EEPROM_163"></a>4.EEPROM存储</h3> 
<p>A0,A1,A2地址线,WP使能位，SCL，SDA数据转输线<br> <img src="https://images2.imgbox.com/45/d6/mbCbj1k8_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/d9/cd/0DpiaMti_o.png" alt="请添加图片描述"><br> 写数据操作<br> 进入写模式，写地址，写date<br> <img src="https://images2.imgbox.com/57/5d/IyMlHA69_o.png" alt="请添加图片描述"><br> 读数据操作<br> 进入写模式，写读的地址，进入读模式，读数据<br> <img src="https://images2.imgbox.com/84/ab/ShzpKu4m_o.png" alt="请添加图片描述"></p> 
<h3><a id="5EEPROM_174"></a>5.EEPROM操作代码</h3> 
<p><strong>写操作</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">AT24CXX_WriteOneByte</span><span class="token punctuation">(</span>u16 WriteAddr<span class="token punctuation">,</span>u8 DataToWrite<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>				   	  	    																 
    <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>EE_TYPE<span class="token operator">&gt;</span>AT24C16<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token number">0XA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	    <span class="token comment">//发送写命令</span>
		<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>WriteAddr<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送高地址	  </span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token number">0XA0</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WriteAddr<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//发送器件地址0XA0,写数据 	 </span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   
    <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>WriteAddr<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//发送低地址</span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	 										  		   
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>DataToWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//发送字节							   </span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  		    	   
    <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//产生一个停止条件 </span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
<span class="token punctuation">}</span>
</code></pre> 
<p>读操作</p> 
<pre><code class="prism language-c">u8 <span class="token function">AT24CXX_ReadOneByte</span><span class="token punctuation">(</span>u16 ReadAddr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>				  
	u8 temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>		  	    																 
    <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>EE_TYPE<span class="token operator">&gt;</span>AT24C16<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token number">0XA0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">//发送写命令</span>
		<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>ReadAddr<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送高地址	    </span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token number">0XA0</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ReadAddr<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//发送器件地址0XA0,写数据</span>
	
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>ReadAddr<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//发送低地址</span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	    
	<span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  	 	   
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span><span class="token number">0XA1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//进入接收模式			   </span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
    temp<span class="token operator">=</span><span class="token function">IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		   
    <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//产生一个停止条件	    </span>
	<span class="token keyword">return</span> temp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="6_222"></a>6.实验程序</h3> 
<p>通过I2C想EEPROM写入程序，并读取出来<br> main.c</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"key.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lcd.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sdram.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"24cxx.h"</span></span>


<span class="token comment">//要写入到24c02的字符串数组</span>
<span class="token keyword">const</span> u8 TEXT_Buffer<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"Apollo STM32F4 IIC TEST"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIZE</span> <span class="token expression"><span class="token keyword">sizeof</span><span class="token punctuation">(</span>TEXT_Buffer<span class="token punctuation">)</span></span></span>
    
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 key<span class="token punctuation">;</span>
	u16 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 datatemp<span class="token punctuation">[</span>SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>	
    <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//初始化HAL库   </span>
    <span class="token function">Stm32_Clock_Init</span><span class="token punctuation">(</span><span class="token number">360</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//设置时钟,180Mhz</span>
    <span class="token function">delay_init</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//初始化延时函数</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//初始化USART	</span>
    <span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//初始化LED </span>
    <span class="token function">KEY_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//初始化按键</span>
    <span class="token function">SDRAM_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">//初始化SDRAM</span>
    <span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//初始化LCD</span>
	<span class="token function">AT24CXX_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				    <span class="token comment">//初始化IIC  </span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">AT24CXX_Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//检测不到24c02</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		LED0<span class="token operator">=</span><span class="token operator">!</span>LED0<span class="token punctuation">;</span><span class="token comment">//DS0闪烁</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		key<span class="token operator">=</span><span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span>KEY1_PRES<span class="token punctuation">)</span><span class="token comment">//KEY1按下,写入24C02</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">LCD_Fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">170</span><span class="token punctuation">,</span><span class="token number">239</span><span class="token punctuation">,</span><span class="token number">319</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清除半屏    </span>
			<span class="token function">AT24CXX_Write</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span>TEXT_Buffer<span class="token punctuation">,</span>SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"写入完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span>KEY0_PRES<span class="token punctuation">)</span><span class="token comment">//KEY0按下,读取字符串并显示</span>
		<span class="token punctuation">{<!-- --></span>
		
			<span class="token function">AT24CXX_Read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>datatemp<span class="token punctuation">,</span>SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>datatemp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">20</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			LED0<span class="token operator">=</span><span class="token operator">!</span>LED0<span class="token punctuation">;</span><span class="token comment">//提示系统正在运行	</span>
			i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>		   
		<span class="token punctuation">}</span> 	    
	<span class="token punctuation">}</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7a9770ac6a46b3a4b0f620eb8df839f5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue生命周期、vue请求、动画</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7587586742e4fde82810c33b5187b70e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux守护进程的启动方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>