<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Django全文搜索 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Django全文搜索" />
<meta property="og:description" content="Django ORM允许你执行简单的匹配操作，例如contains过滤器（或者不区分大小写的icontains）。
比如查询正文中包含django的文章
from blog.models import Post Post.objects.filter(body__contains=&#39;framework&#39;) 但是如果希望执行复杂的搜索查询，通过相似度或加权项检索结果，则需要更强大的搜索功能。
📌虽然Django是一个与数据库无关的web框架，但它提供了一个模块，该模块支持PostgreSQL提供的部分丰富特性，不支持非PostgreSQL数据库。
Django.contrib.postgres模块提供了由PostgreSQL专享的功能。
简单查询 INSTALLED_APPS = [ #... &#34;django.contrib.postgres&#34;, ] 对单个字段进行搜索
from blog.models import Post Post.objects.filter(body__search=&#39;django&#39;) 对多个字段进行查询 搜索Post模型的标题和正文字段
from django.contrib.postgres.search import SearchVector from blog.models import Post Post.objects.annotate( search=SearchVector(&#39;title&#39;, &#39;body&#39;), ).filter(search=&#39;django&#39;) 使用annotate并使用两个字段定义SearchVector(文章标题和正文)。
构建查询视图 创建一个自定义视图，首先需要一个搜索表单
编辑form.py，新建SearchForm表单类
from django import forms from .models import Comment class EmailPostForm(forms.Form): name = forms.CharField(max_length=25) email = forms.EmailField() to = forms.EmailField() comments = forms.CharField(required=False,widget=forms.Textarea) class CommentForm(forms.ModelForm): class Meta: model = Comment fields = (&#39;name&#39;,&#39;email&#39;,&#39;body&#39;) class SearchForm(forms." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/6f015682bf132b588e13e27b78838da1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-09T09:56:34+08:00" />
<meta property="article:modified_time" content="2024-01-09T09:56:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Django全文搜索</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>Django ORM允许你执行简单的匹配操作，例如contains过滤器（或者不区分大小写的icontains）。<br> 比如查询正文中包含django的文章</p> 
<pre><code class="language-python">from blog.models import Post
Post.objects.filter(body__contains='framework')</code></pre> 
<p>但是如果希望执行复杂的搜索查询，通过相似度或加权项检索结果，则需要更强大的搜索功能。</p> 
<blockquote> 
 <p>📌虽然Django是一个与数据库无关的web框架，但它提供了一个模块，该模块支持PostgreSQL提供的部分丰富特性，不支持非PostgreSQL数据库。</p> 
</blockquote> 
<p>Django.contrib.postgres模块提供了由PostgreSQL专享的功能。</p> 
<h2>简单查询</h2> 
<pre><code class="language-python">INSTALLED_APPS = [
	#...
    "django.contrib.postgres",

]</code></pre> 
<p>对单个字段进行搜索</p> 
<pre><code class="language-python">from blog.models import Post
Post.objects.filter(body__search='django')</code></pre> 
<h2>对多个字段进行查询</h2> 
<p>搜索Post模型的标题和正文字段</p> 
<pre><code class="language-python">from django.contrib.postgres.search import SearchVector
from blog.models import Post

Post.objects.annotate(
		search=SearchVector('title', 'body'),
	).filter(search='django')</code></pre> 
<p><br> 使用annotate并使用两个字段定义SearchVector(文章标题和正文)。</p> 
<h2>构建查询视图</h2> 
<p>创建一个自定义视图，首先需要一个搜索表单<br> 编辑form.py，新建SearchForm表单类</p> 
<pre><code class="language-python">from django import forms
from .models import Comment

class EmailPostForm(forms.Form):
	name = forms.CharField(max_length=25)
	email = forms.EmailField()
	to = forms.EmailField()
	comments = forms.CharField(required=False,widget=forms.Textarea)

class CommentForm(forms.ModelForm):
	class Meta:
		model = Comment
		fields = ('name','email','body')

class SearchForm(forms.Form):
	query = forms.CharField()</code></pre> 
<p>使用query字段让用户引入搜索词。</p> 
<p>关于EmailPostForm和CommentForm表单的更多内容，请查看</p> 
<p><a href="https://blog.csdn.net/Q1780020/article/details/135337037?spm=1001.2014.3001.5501" title="Django发送QQ邮件-CSDN博客">Django发送QQ邮件-CSDN博客</a></p> 
<p><a href="https://blog.csdn.net/Q1780020/article/details/135356568?spm=1001.2014.3001.5501" title="Django评论系统-CSDN博客">Django评论系统-CSDN博客</a></p> 
<blockquote> 
 <p>📌注意forms.CharField后面的括号，如果没有括号不会报错</p> 
</blockquote> 
<p>编辑views.py</p> 
<pre><code class="language-python">from .forms import EmailPostForm,CommentForm,SearchForm
from django.contrib.postgres.search import SearchVector

def post_search(request):
    form = SearchForm()
    query = None
    results = []
    if 'query' in request.GET:
        form = SearchForm(request.Get)
        if form.is_valid():
            query = form.cleaned_data['query']
            results = Post.objects.annotate(
                search = SearchVector('title','body'),
            ).filter(search=query)
    template = "blog/post/search.html"
    context={
        'form':form,
        'query':query,
        'results':results,
    }

    return render(request,template,context)</code></pre> 
<ul><li>首先实例化一个表单。</li><li>使用GET方法提交表单，以便生成包含查询参数URL</li><li>在请求中查找query参数，检验是否提交了表单</li><li>提交表单时，使用提交的GET数据实例化，并验证表单数据是否有效</li><li>如果表单有效，使用自定义SearchVector实例搜索包含标题和正文字段</li></ul> 
<h2>构建查询模版</h2> 
<p>搜索视图准备好后，创一个模版，在用户执行搜索时显示表单和结果。</p> 
<p>在blog/post/template目录下创建search.html</p> 
<pre><code class="language-html">```html
{% extends "blog/base.html" %}
{% block title %}Search{% endblock %}
{% block content %}
    {% if query %}
        &lt;h1&gt;Posts containing "{<!-- -->{ query }}"&lt;/h1&gt;
        &lt;h3&gt;
            {% with result.cont as total_results %}
                Found {<!-- -->{ total_results }} result {<!-- -->{ total_results|pluralize }}
            {% endwith %}

        &lt;/h3&gt;

        {% for post in results %}

            &lt;h4&gt;
                &lt;a href="{<!-- -->{ post.get_absolute_url }}"&gt;{<!-- -->{post.title}}&lt;/a&gt;
            &lt;/h4&gt;
            {<!-- -->{ post.body|truncatewords:5 }}

        {% empty %}

            &lt;p&gt;There are no results for your query.&lt;/p&gt;

        {% endfor%}

        &lt;p&gt;
            &lt;a href="{% url 'blog:post_search' %}"&gt;Search again&lt;/a&gt;
        &lt;/p&gt;

    {% else %}

        &lt;h1&gt;Search for posts&lt;/h1&gt;
        &lt;form action="." method="get"&gt;{<!-- -->{ form.as_p }}
            &lt;input type="submit" value="Search"&gt;
        &lt;/form&gt;

    {% endif %}

{% endblock%}</code></pre> 
<ul><li>与搜索视图一样，通过查询query参数区分表单是否已提交</li><li>提交前，显示表单和提交按钮</li><li>提交后，显示查询查询结果总数和文章列表</li></ul> 
<p>post.get_absolute_url 是使用年月日为每个文章构建的URL，更多信息请查看</p> 
<p><a href="https://blog.csdn.net/Q1780020/article/details/135318486?spm=1001.2014.3001.5501" title="Django用日期URL定位详情-CSDN博客">Django用日期URL定位详情-CSDN博客</a></p> 
<h2>构建查询路径</h2> 
<p>编辑urls.py</p> 
<pre><code class="language-python">urlpatterns = [

	#...
    path('search/',views.post_search, name='post_search')

]</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e274422d03f769f9eebdaac5644121b8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL 递归 CTE(公共表表达式) -___MySQL 教程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f5e6dc34245d5cd0534925348e9041bc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MySQL总结__狂神说Java</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>