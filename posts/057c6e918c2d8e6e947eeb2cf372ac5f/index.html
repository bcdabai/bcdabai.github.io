<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Javaä¸­çš„ä»£ç†æ¨¡å¼ï¼ˆäºŒï¼‰JDKåŠ¨æ€ä»£ç† - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Javaä¸­çš„ä»£ç†æ¨¡å¼ï¼ˆäºŒï¼‰JDKåŠ¨æ€ä»£ç†" />
<meta property="og:description" content="å¤§å®¶å¥½ğŸ‘‹ï¼Œæˆ‘æ˜¯æå®¢æ¶›ğŸ˜ï¼Œä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬å¯¹ä»£ç†æ¨¡å¼æœ‰ä¸¤å¤§ç±»ï¼Œé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ï¼Œå¯¹äºé™æ€ä»£ç†ç›¸ä¿¡å¤§å®¶éƒ½ä¿¡æ‰‹æ‹ˆæ¥ã€‚å¯¹äºåŠ¨æ€ä»£ç†è¿˜æœ‰ä¸¤ç§å®ç°ï¼Œä¸€ç§æ˜¯javaåŸç”Ÿçš„Jdkä»£ç†ï¼Œä¸€ç§æ˜¯Cglibæ–¹å¼ã€‚å› ä¸ºæ¶‰åŠåˆ°æºç è§£è¯»ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿå°†åˆ†ä¸¤æœŸå®Œæˆï¼Œæœ¬æœŸä¸»è¦è®²è®²JDKåŠ¨æ€ä»£ç†çš„å®ç°æ–¹å¼
ç¤ºä¾‹ å…ˆä¸¾ä¸ªå°ä¾‹å­ï¼Œåˆ›å»ºæ¥å£
public interface Father { void eat(); } åˆ›å»ºå®ç°ç±»
public class Son implements Father{ @Override public void eat() { System.out.println(&#34;åƒé¥­&#34;); } } æµ‹è¯•
public class ProxyTest { public static void main(String[] args) { ProxyTest test = new ProxyTest(); test.jdkProxy(); } private void jdkProxy(){ Father son = new Son(); Father proxySon = (Father) Proxy.newProxyInstance(son.getClass().getClassLoader(), son.getClass().getInterfaces(), new InvocationHandler() { @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { System." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/057c6e918c2d8e6e947eeb2cf372ac5f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-21T15:49:10+08:00" />
<meta property="article:modified_time" content="2024-01-21T15:49:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Javaä¸­çš„ä»£ç†æ¨¡å¼ï¼ˆäºŒï¼‰JDKåŠ¨æ€ä»£ç†</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>å¤§å®¶å¥½ğŸ‘‹ï¼Œæˆ‘æ˜¯æå®¢æ¶›ğŸ˜ï¼Œä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬å¯¹ä»£ç†æ¨¡å¼æœ‰ä¸¤å¤§ç±»ï¼Œé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ï¼Œå¯¹äºé™æ€ä»£ç†ç›¸ä¿¡å¤§å®¶éƒ½ä¿¡æ‰‹æ‹ˆæ¥ã€‚å¯¹äºåŠ¨æ€ä»£ç†è¿˜æœ‰ä¸¤ç§å®ç°ï¼Œä¸€ç§æ˜¯javaåŸç”Ÿçš„Jdkä»£ç†ï¼Œä¸€ç§æ˜¯Cglibæ–¹å¼ã€‚å› ä¸ºæ¶‰åŠåˆ°æºç è§£è¯»ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿå°†åˆ†ä¸¤æœŸå®Œæˆï¼Œæœ¬æœŸä¸»è¦è®²è®²JDKåŠ¨æ€ä»£ç†çš„å®ç°æ–¹å¼</p> 
</blockquote> 
<h3><a id="_2"></a>ç¤ºä¾‹</h3> 
<p>å…ˆä¸¾ä¸ªå°ä¾‹å­ï¼Œåˆ›å»ºæ¥å£</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Father</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>åˆ›å»ºå®ç°ç±»</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Son</span> <span class="token keyword">implements</span> <span class="token class-name">Father</span><span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"åƒé¥­"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>æµ‹è¯•</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProxyTest</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ProxyTest</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxyTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        test<span class="token punctuation">.</span><span class="token function">jdkProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">jdkProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Father</span> son <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">Father</span> proxySon <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Father</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>son<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> son<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"åšé¥­"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">Object</span> invoke <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>son<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ´—ç¢—"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> invoke<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        proxySon<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>è¾“å‡ºç»“æœ</p> 
<pre><code class="prism language-java">åšé¥­
åƒé¥­
æ´—ç¢—
</code></pre> 
<p>å¦‚ä¸Šï¼Œæ˜¯ä¸€ä¸ªä½¿ç”¨JDKåŠ¨æ€ä»£ç†çš„ç®€å•ä¾‹å­ï¼Œé€šè¿‡Proxyç±»çš„é™æ€æ–¹æ³•newProxyInstanceå¯ä»¥ç”Ÿæˆç›®æ ‡ç±»çš„ä»£ç†ç±»ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªç–‘é—®ï¼š</p> 
<ul><li>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å®ä¾‹å¯¹è±¡çš„ClassLoaderå’ŒInterfacesï¼Œä½¿ç”¨å…¶å®ä¾‹å¯¹è±¡çš„è¡Œä¸è¡Œï¼Œä½¿ç”¨ç±»çš„è¡Œä¸è¡Œ</li><li>ä¸ºä»€ä¹ˆè¢«ä»£ç†ç±»éè¦å®ç°æ¥å£</li><li>newProxyInstanceè¿”å›çš„ä»£ç†ç±»æ˜¯ä»€ä¹ˆç±»å‹ï¼Œå¼ºè½¬æˆå®ç°ç±»ï¼ˆFather proxySon = (Son) Proxy.newProxyInstance(â€¦)ï¼‰ä¼šä¸ä¼šæŠ¥é”™</li></ul> 
<p>æˆ‘ä»¬å¸¦ç€è¿™å‡ ä¸ªé—®é¢˜çœ‹çœ‹æºç </p> 
<h3><a id="_70"></a>æºç </h3> 
<h4><a id="javalangreflectProxy_72"></a>java.lang.reflect.Proxy</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span>
                                      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">,</span>
                                      <span class="token class-name">InvocationHandler</span> h<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å…‹éš†è¢«ä»£ç†ç±»çš„æ¥å£Classå¯¹è±¡</span>
    <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> intfs <span class="token operator">=</span> interfaces<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä½¿ç”¨Javaå®‰å…¨ç®¡ç†å™¨æ ¡éªŒç¨‹åºï¼Œé˜²æ­¢æ¶å¿ƒä»£ç </span>
    <span class="token keyword">final</span> <span class="token class-name">SecurityManager</span> sm <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">checkProxyAccess</span><span class="token punctuation">(</span><span class="token class-name">Reflection</span><span class="token punctuation">.</span><span class="token function">getCallerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loader<span class="token punctuation">,</span> intfs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * Look up or generate the designated proxy class.
     * æŸ¥æ‰¾æˆ–ç”ŸæˆæŒ‡å®šçš„ä»£ç†ç±»ã€‚è¿™é‡Œä¼šä½¿ç”¨ç¼“å­˜ï¼Œç¼“å­˜é‡Œæ²¡æœ‰å°±åˆ›å»ºä»£ç†ç±»ï¼Œæ”¾æ”¾åˆ°ç¼“å­˜ä¸­
     * æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥è¿™ä¸ªæ–¹æ³•çœ‹çœ‹
     */</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cl <span class="token operator">=</span> <span class="token function">getProxyClass0</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> intfs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     * Invoke its constructor with the designated invocation handler.
     * ä½¿ç”¨æŒ‡å®šçš„è°ƒç”¨å¤„ç†ç¨‹åºè°ƒç”¨å…¶æ„é€ å‡½æ•°ã€‚
     */</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">checkNewProxyPermission</span><span class="token punctuation">(</span><span class="token class-name">Reflection</span><span class="token punctuation">.</span><span class="token function">getCallerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è·å–ä»£ç†ç±»çš„æ„é€ å™¨ï¼Œè¿™é‡Œä¼šç”Ÿæˆä¸€ä¸ªå…¥å‚ä¸ºInvocationHandler.classçš„æ„é€ å™¨</span>
        <span class="token keyword">final</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cons <span class="token operator">=</span> cl<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>constructorParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">InvocationHandler</span> ih <span class="token operator">=</span> h<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>cl<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">public</span> <span class="token class-name">Void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    cons<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// é€šè¿‡åå°„ä½¿ç”¨æ„é€ æ–¹æ³•ï¼ˆå¸¦æœ‰InvocationHandlerå…¥å‚çš„æ„é€ æ–¹æ³•ï¼‰åˆ›å»ºä»£ç†ç±»çš„å®ä¾‹å¯¹è±¡</span>
        <span class="token keyword">return</span> cons<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span><span class="token operator">|</span><span class="token class-name">InstantiationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Throwable</span> t <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getProxyClass0</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span>
                                           <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> interfaces<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯65535ï¼Ÿ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interfaces<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">65535</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"interface limit exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// If the proxy class defined by the given loader implementing</span>
        <span class="token comment">// the given interfaces exists, this will simply return the cached copy;</span>
        <span class="token comment">// otherwise, it will create the proxy class via the ProxyClassFactory</span>
    	<span class="token comment">/**
    	* å¦‚æœç»™å®šåŠ è½½å™¨å®šä¹‰çš„ä»£ç†ç±»å®ç°,ç»™å®šçš„æ¥å£å­˜åœ¨ï¼Œè¿™å°†ç®€å•åœ°è¿”å›ç¼“å­˜çš„å‰¯æœ¬ï¼›å¦åˆ™ï¼Œå®ƒå°†é€šè¿‡ ProxyClassFactory åˆ›å»ºä»£ç†ç±»
    	* åœ¨è¿›å…¥è¿™ä¸ªæ–¹æ³•çœ‹çœ‹
		/
        return proxyClassCache.get(loader, interfaces);
    }
</span></code></pre> 
<h4><a id="javalangreflectWeakCache_152"></a>java.lang.reflect.WeakCache</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">P</span> parameter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">expungeStaleEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token class-name">CacheKey</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> refQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// lazily install the 2nd level valuesMap for the particular cacheKey</span>
        <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Supplier</span><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> valuesMap <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>valuesMap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Supplier</span><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> oldValuesMap
                <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span>
                                  valuesMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValuesMap <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                valuesMap <span class="token operator">=</span> oldValuesMap<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// create subKey and retrieve the possible Supplier&lt;V&gt; stored by that</span>
        <span class="token comment">// subKey from valuesMap</span>
    	<span class="token comment">// å…¶å®ƒä»£ç å…ˆä¸å…³æ³¨ï¼Œè¿™é‡Œçš„applyæ–¹æ³•ä¼šè°ƒç”¨$ProxyClassFactoryçš„applyæ–¹æ³•</span>
        <span class="token class-name">Object</span> subKey <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>subKeyFactory<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> supplier <span class="token operator">=</span> valuesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>subKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Factory</span> factory <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="javalangreflectProxy_184"></a>java.lang.reflect.Proxy</h4> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ProxyClassFactory</span>
        <span class="token keyword">implements</span> <span class="token class-name">BiFunction</span><span class="token operator">&lt;</span><span class="token class-name">ClassLoader</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// prefix for all proxy class names</span>
    	<span class="token comment">// ä»£ç†ç±»åå‰ç¼€</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> proxyClassNamePrefix <span class="token operator">=</span> <span class="token string">"$Proxy"</span><span class="token punctuation">;</span>

        <span class="token comment">// next number to use for generation of unique proxy class names</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> nextUniqueNumber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> interfaceSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IdentityHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>interfaces<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> intf <span class="token operator">:</span> interfaces<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/*
                 * Verify that the class loader resolves the name of this
                 * interface to the same Class object.
                 */</span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> interfaceClass <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// å¾ªç¯è·å–è¢«ä»£ç†ç±»çš„æ¥å£ç»“åˆçš„Classå¯¹è±¡</span>
                    interfaceClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>intf<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> loader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>interfaceClass <span class="token operator">!=</span> intf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                        intf <span class="token operator">+</span> <span class="token string">" is not visible from class loader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">/*
                 * Verify that the Class object actually represents an
                 * interface.
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>interfaceClass<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                        interfaceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is not an interface"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">/*
                 * Verify that this interface is not a duplicate.
                 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>interfaceSet<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                        <span class="token string">"repeated interface: "</span> <span class="token operator">+</span> interfaceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">String</span> proxyPkg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>     <span class="token comment">// package to define proxy class in</span>
            <span class="token keyword">int</span> accessFlags <span class="token operator">=</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token constant">PUBLIC</span> <span class="token operator">|</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token constant">FINAL</span><span class="token punctuation">;</span>

            <span class="token comment">/*
             * Record the package of a non-public proxy interface so that the
             * proxy class will be defined in the same package.  Verify that
             * all non-public proxy interfaces are in the same package.
             */</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> intf <span class="token operator">:</span> interfaces<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> flags <span class="token operator">=</span> intf<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    accessFlags <span class="token operator">=</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token constant">FINAL</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> name <span class="token operator">=</span> intf<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> n <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> pkg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>proxyPkg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        proxyPkg <span class="token operator">=</span> pkg<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkg<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>proxyPkg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                            <span class="token string">"non-public interfaces from different packages"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>proxyPkg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// if no non-public proxy interfaces, use com.sun.proxy package</span>
                proxyPkg <span class="token operator">=</span> <span class="token class-name">ReflectUtil</span><span class="token punctuation">.</span><span class="token constant">PROXY_PACKAGE</span> <span class="token operator">+</span> <span class="token string">"."</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/*
             * Choose a name for the proxy class to generate.
             */</span>
            <span class="token keyword">long</span> num <span class="token operator">=</span> nextUniqueNumber<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// com.sun.proxy.  +  $Proxy   + 0</span>
            <span class="token class-name">String</span> proxyName <span class="token operator">=</span> proxyPkg <span class="token operator">+</span> proxyClassNamePrefix <span class="token operator">+</span> num<span class="token punctuation">;</span>

            <span class="token comment">/*
             * Generate the specified proxy class.
             * ç”ŸæˆæŒ‡å®šçš„ä»£ç†ç±»æ–‡ä»¶ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦æŒä¹…åŒ–ï¼Œè¿™é‡Œåªæ˜¯æ™®é€šçš„æ–‡ä»¶å­—èŠ‚æ•°ç»„ï¼Œjvmå¹¶ä¸è®¤è¯†
             */</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> proxyClassFile <span class="token operator">=</span> <span class="token class-name">ProxyGenerator</span><span class="token punctuation">.</span><span class="token function">generateProxyClass</span><span class="token punctuation">(</span>
                proxyName<span class="token punctuation">,</span> interfaces<span class="token punctuation">,</span> accessFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// å®šä¹‰ä»£ç†ç±»ï¼ŒåŠ è½½åˆ°jvmä¸­ï¼Œç”ŸæˆçœŸæ­£å¯ä»¥ä½¿ç”¨çš„è¿è¡Œæ—¶ä»£ç†ç±»çš„Classå¯¹è±¡ï¼Œ</span>
                <span class="token keyword">return</span> <span class="token function">defineClass0</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> proxyName<span class="token punctuation">,</span>
                                    proxyClassFile<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> proxyClassFile<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassFormatError</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/*
                 * A ClassFormatError here means that (barring bugs in the
                 * proxy class generation code) there was some other
                 * invalid aspect of the arguments supplied to the proxy
                 * class creation (such as virtual machine limitations
                 * exceeded).
                 */</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_293"></a>åˆ†æ</h3> 
<p>byte[] proxyClassFile = ProxyGenerator.generateProxyClass(proxyName, interfaces, accessFlags);è¿™å—ä»£ç å¯ä»¥ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚æ•°ç»„ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥çœ‹çœ‹ç”Ÿæˆçš„ä»£ç†ç±»åˆ°åº•é•¿ä»€ä¹ˆæ ·å‘¢ï¼Ÿå†™ä¸ªæµ‹è¯•æ–¹æ³•çœ‹çœ‹</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Father</span> father <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> proxyArr <span class="token operator">=</span> <span class="token class-name">ProxyGenerator</span><span class="token punctuation">.</span><span class="token function">generateProxyClass</span><span class="token punctuation">(</span><span class="token string">"$Proxy0"</span><span class="token punctuation">,</span> father<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"C:\\Users\\wxt\\Desktop\\test.class"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proxyArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>æ–‡ä»¶å†…å®¹</p> 
<pre><code class="prism language-java"><span class="token comment">// ä»£ç†ç±»é»˜è®¤ç»§æ‰¿äº†Proxyç±»ï¼Œå®ç°äº†è¢«ä»£ç†ç±»çš„æ¥å£</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> $<span class="token class-name">Proxy0</span> <span class="token keyword">extends</span> <span class="token class-name">Proxy</span> <span class="token keyword">implements</span> <span class="token class-name">Father</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Method</span> m1<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Method</span> m3<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Method</span> m2<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Method</span> m0<span class="token punctuation">;</span>
    
    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// è¿™é‡Œåˆå§‹åŒ–4ä¸ªæˆå‘˜å˜é‡</span>
            m1 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Object"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"equals"</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Object"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            m3 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.wangxt.wxt.design.patterns.proxy.dynamic.Father"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"eat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            m2 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Object"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"toString"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            m0 <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Object"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"hashCode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> var2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchMethodError</span><span class="token punctuation">(</span>var2<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoClassDefFoundError</span><span class="token punctuation">(</span>var3<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> $<span class="token class-name">Proxy0</span><span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span>  <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// è¿™é‡Œä¼šè°ƒç”¨çˆ¶ç±»çš„æ„é€ ï¼Œå¹¶æŠŠInvocationHandlerä¼ é€’</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// è¿™é‡Œæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„æ–¹æ³•ï¼Œå…¶å®ƒæ–¹æ³•é“ç†ç›¸åŒ</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span>  <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ä»£ç†ç±»çš„æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šä¼šè°ƒç”¨çˆ¶ç±»çš„h(InvocationHandler)çš„invokeæ–¹æ³•</span>
            <span class="token comment">// @Override</span>
            <span class="token comment">// public Object invoke(Object proxy, Method method, Object[] args) throws Throwable</span>
            <span class="token comment">// æ‰€ä»¥æˆ‘ä»¬é‡å†™InvocationHandlerçš„invokeæ–¹æ³•æ—¶ä¼ å…¥çš„å°±æ˜¯è¿™å‡ ä¸ªå‚æ•°</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span>h<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> m3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> var2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> var2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UndeclaredThrowableException</span><span class="token punctuation">(</span>var3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>å¥½äº†ï¼Œåˆ°è¿™é‡ŒåŸºæœ¬ä¿¡æ¯éƒ½çœ‹å®Œäº†ï¼Œæˆ‘ä»¬åšä¸ªæ€»ç»“</p> 
<ul><li> <p>å‡†å¤‡ä»£ç†ç±»çš„æè¿°æ•°æ®</p> </li><li> <p>åˆ›å»ºä»£ç†ç±»ï¼ˆå®ç°æ¥å£ï¼‰çš„å­—èŠ‚ç æ–‡ä»¶</p> </li><li> <p>é€šè¿‡ClassLoaderå°†ä»£ç†ç±»çš„å­—èŠ‚æ•°ç»„åŠ è½½åˆ°JVMä¸­</p> </li><li> <p>åˆ›å»ºä»£ç†ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œæ‰§è¡Œå¯¹è±¡çš„ç›®æ ‡æ–¹æ³•</p> </li></ul> 
<p>æˆ‘ä»¬å›è¿‡å¤´æ¥ï¼Œåœ¨æƒ³æƒ³æœ€å¼€å§‹çš„3ä¸ªé—®é¢˜ï¼š</p> 
<ul><li>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å®ä¾‹å¯¹è±¡çš„ClassLoaderå’ŒInterfacesï¼Œä½¿ç”¨å…¶å®ä¾‹å¯¹è±¡çš„è¡Œä¸è¡Œï¼Œä½¿ç”¨ç±»çš„è¡Œä¸è¡Œ 
  <ul><li>å› ä¸ºæˆ‘ä»¬è¦ä»£ç†çš„æ¥å£æ˜¯åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œæ‰€ä»¥ç†è®ºä¸Šåªè¦åº”ç”¨ç±»åŠ è½½å™¨åŠ çš„ç±»éƒ½å¯ä»¥</li><li>ä½†æ˜¯interfaceè‚¯å®šæ˜¯éœ€è¦å®ä¾‹å¯¹è±¡(son.getClass())æˆ–è€…ä»£ç†ç±»(Son.class)ï¼Œå› ä¸ºæˆ‘ä»¬è¦å¯¹å…¶çš„æ¥å£è¿›è¡Œä»£ç†</li></ul> </li><li>ä¸ºä»€ä¹ˆè¢«ä»£ç†ç±»éè¦å®ç°æ¥å£ 
  <ul><li>å› ä¸ºä»£ç†ç±»å·²ç»ç»§æ‰¿äº†Proxyç±»ï¼Œæ‰€ä»¥åªèƒ½å®ç°æ¥å£</li></ul> </li><li>newProxyInstanceè¿”å›çš„ä»£ç†ç±»æ˜¯ä»€ä¹ˆç±»å‹ï¼Œå¼ºè½¬æˆå®ç°ç±»ï¼ˆFather proxySon = (Son) Proxy.newProxyInstance(â€¦)ï¼‰ä¼šä¸ä¼šæŠ¥é”™ 
  <ul><li>è¿”å›çš„æ˜¯å®ç°äº†æ¥å£ç»§æ‰¿äº†Proxyçš„ä»£ç†ç±»ï¼Œæ‰€ä»¥å¼ºè½¬æˆSonä¼šæŠ¥é”™</li></ul> </li></ul> 
<h3><a id="_377"></a>æ€»ç»“</h3> 
<p>å› ä¸ºJDKåŠ¨æ€ä»£ç†ç”Ÿæˆçš„ä»£ç†å¯¹è±¡é»˜è®¤ç»§æ‰¿äº†<strong>Proxy</strong>ç±»ï¼Œåˆå› ä¸ºJavaä¸­æ˜¯<strong>å•ç»§æ‰¿å¤šå®ç°</strong>ï¼Œæ‰€ä»¥å¯¼è‡´äº†JDKåŠ¨æ€ä»£ç†æ— æ³•ä»£ç†å®ç°ç±»ï¼Œåªèƒ½ä»£ç†æ¥å£ï¼›è€Œä¸”æˆ‘ä»¬é€šè¿‡è§‚å¯ŸProxyç±»ï¼Œç»´æŠ¤äº†<strong>InvocationHandler h</strong>æˆå‘˜å˜é‡å¹¶æä¾›äº†ç›¸åº”çš„æ–¹æ³•ï¼Œç„¶åé€šè¿‡å­ç±»å¯¹InvocationHandlerè¿›è¡Œé€ä¼ ï¼ŒProxyå¯¹å…¶è¿›è¡Œæ–¹æ³•æ‰§è¡Œã€‚<code>å…¶å®ç†è®ºä¸Šåªè¦æˆ‘ä»¬æŠŠInvocationHandleræå‡ºæ¥ï¼Œä¸ç”±Proxyè¿›è¡Œç»´æŠ¤ï¼Œä¹Ÿå°±ä¸éœ€è¦ç»§æ‰¿Proxyç±»ï¼Œå°±å¯ä»¥å¯¹å®ç°ç±»è¿›è¡Œä»£ç†ï¼Œå¯èƒ½ä½œè€…åŸºäºé¢å‘æ¥å£å¼€å‘çš„å®é™…åœºæ™¯ï¼Œä»¥åŠæŠ½è±¡æ€ç»´æ‰è¿™ä¹ˆè¿›è¡Œè®¾è®¡çš„å§ã€‚</code></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1b4b7208b011f8bfd35ceb15ca3bae11/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">SpringMvcä¸­æ‹¦æˆªå™¨çš„é…ç½®åŠåº”ç”¨</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ea93ccdef8c27b855ff3b85b0b4c6326/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">ä»0å¼€å§‹å­¦C&#43;&#43; ç¬¬åå…«è¯¾ï¼šç»§æ‰¿</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>