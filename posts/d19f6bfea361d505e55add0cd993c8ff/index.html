<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>12.React Native数据本地存储-Realm封装 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="12.React Native数据本地存储-Realm封装" />
<meta property="og:description" content="目录
1.创建Schema数据模型对象
2.创建数据迁移模型(默认数据数组)
3.Realm管理
4.批量数据插入处理
5.完整代码示例
1.创建Schema数据模型对象 const MoviesSchema={ name:&#39;Movies&#39;, primaryKey:&#39;id&#39;, properties:{ id:&#39;string&#39;, title:&#39;string&#39;, year:&#39;int&#39;, // newTitle:&#39;string&#39;, //版本2新增字段 // testTitle:&#39;string&#39;, //版本3新增字段 mpaa_rating:&#39;string&#39;, test1:&#39;string&#39;, test2:&#39;string&#39;, test3:&#39;string&#39;, newtest3:&#39;string&#39; } }; 2.创建数据迁移模型(默认数据数组) 版本2将title和test1合并为newTitle，title和test1直接去掉即可，在migration:(oldRealm, newRealm)方法中查询旧版本数据将旧版本数据迁移到新版本的数据库中，完成版本数据库结构升级；
const MoviesSchema={ name:&#39;Movies&#39;, primaryKey:&#39;id&#39;, properties:{ id:&#39;string&#39;, //title:&#39;string&#39;, year:&#39;int&#39;, newTitle:&#39;string&#39;, //版本2新增字段 // testTitle:&#39;string&#39;, //版本3新增字段 mpaa_rating:&#39;string&#39;, //test1:&#39;string&#39;, test2:&#39;string&#39;, test3:&#39;string&#39;, newtest3:&#39;string&#39; } }; 版本3将newTitle和test2合并为testTitle，newTitle和test2直接去掉即可，在migration:(oldRealm, newRealm)方法中查询旧版本数据将旧版本数据迁移到新版本的数据库中，完成版本数据库结构升级；
const MoviesSchema={ name:&#39;Movies&#39;, primaryKey:&#39;id&#39;, properties:{ id:&#39;string&#39;, //title:&#39;string&#39;, year:&#39;int&#39;, //newTitle:&#39;string&#39;, //版本2新增字段 // testTitle:&#39;string&#39;, //版本3新增字段 mpaa_rating:&#39;string&#39;, //test1:&#39;string&#39;, //test2:&#39;string&#39;, test3:&#39;string&#39;, newtest3:&#39;string&#39; } }; 每个数据库版本的升级迁移模型" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/d19f6bfea361d505e55add0cd993c8ff/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-03T15:43:13+08:00" />
<meta property="article:modified_time" content="2019-07-03T15:43:13+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">12.React Native数据本地存储-Realm封装</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:0px;"> </p> 
<p id="1.%E5%88%9B%E5%BB%BASchema%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%B1%A1-toc" style="margin-left:0px;"><a href="#1.%E5%88%9B%E5%BB%BASchema%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%B1%A1" rel="nofollow">1.创建Schema数据模型对象</a></p> 
<p id="2.%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E6%A8%A1%E5%9E%8B(%E9%BB%98%E8%AE%A4%E6%95%B0%E6%8D%AE%E6%95%B0%E7%BB%84)-toc" style="margin-left:0px;"><a href="#2.%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E6%A8%A1%E5%9E%8B%28%E9%BB%98%E8%AE%A4%E6%95%B0%E6%8D%AE%E6%95%B0%E7%BB%84%29" rel="nofollow">2.创建数据迁移模型(默认数据数组)</a></p> 
<p id="3.Realm%E7%AE%A1%E7%90%86-toc" style="margin-left:0px;"><a href="#3.Realm%E7%AE%A1%E7%90%86" rel="nofollow">3.Realm管理</a></p> 
<p id="4.%E6%89%B9%E9%87%8F%E6%95%B0%E6%8D%AE%E6%8F%92%E5%85%A5%E5%A4%84%E7%90%86-toc" style="margin-left:0px;"><a href="#4.%E6%89%B9%E9%87%8F%E6%95%B0%E6%8D%AE%E6%8F%92%E5%85%A5%E5%A4%84%E7%90%86" rel="nofollow">4.批量数据插入处理</a></p> 
<p id="5.%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-toc" style="margin-left:0px;"><a href="#5.%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B" rel="nofollow">5.完整代码示例</a></p> 
<hr id="hr-toc"> 
<h2 id="1.%E5%88%9B%E5%BB%BASchema%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%B1%A1">1.创建Schema数据模型对象</h2> 
<pre class="has"><code>const MoviesSchema={
    name:'Movies',
    primaryKey:'id',
    properties:{
        id:'string',
        title:'string',
        year:'int',
        // newTitle:'string',  //版本2新增字段
        // testTitle:'string',    //版本3新增字段
        mpaa_rating:'string',
        test1:'string',
        test2:'string',
        test3:'string',
        newtest3:'string'
    }
};</code></pre> 
<h2 id="2.%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E6%A8%A1%E5%9E%8B(%E9%BB%98%E8%AE%A4%E6%95%B0%E6%8D%AE%E6%95%B0%E7%BB%84)">2.创建数据迁移模型(默认数据数组)</h2> 
<p>版本2将title和test1合并为newTitle，title和test1直接去掉即可，在migration:(oldRealm, newRealm)方法中查询旧版本数据将旧版本数据迁移到新版本的数据库中，完成版本数据库结构升级；</p> 
<pre class="has"><code>const MoviesSchema={
    name:'Movies',
    primaryKey:'id',
    properties:{
        id:'string',
        //title:'string',
        year:'int',
        newTitle:'string',  //版本2新增字段
        // testTitle:'string',    //版本3新增字段
        mpaa_rating:'string',
        //test1:'string',
        test2:'string',
        test3:'string',
        newtest3:'string'
    }
};</code></pre> 
<p>版本3将newTitle和test2合并为testTitle，newTitle和test2直接去掉即可，在migration:(oldRealm, newRealm)方法中查询旧版本数据将旧版本数据迁移到新版本的数据库中，完成版本数据库结构升级；</p> 
<pre class="has"><code>const MoviesSchema={
    name:'Movies',
    primaryKey:'id',
    properties:{
        id:'string',
        //title:'string',
        year:'int',
        //newTitle:'string',  //版本2新增字段
        // testTitle:'string',    //版本3新增字段
        mpaa_rating:'string',
        //test1:'string',
        //test2:'string',
        test3:'string',
        newtest3:'string'
    }
};</code></pre> 
<p>每个数据库版本的升级迁移模型</p> 
<pre class="has"><code>let UpgradeMigrations = [
    {
        schema:[
            MoviesSchema
        ],
        path:'movies.realm',
        schemaVersion:1,
        migration:(oldRealm, newRealm)=&gt;{

        }
    }
    ,{
        schema:[
            MoviesSchema
        ],
        path:'movies.realm',
        schemaVersion:2,
        migration:(oldRealm, newRealm)=&gt;{
            // 只有当schemaVersion小于1的时候才会执行if中代码
            if(oldRealm.schemaVersion &lt; 2){
                const oldObjects = oldRealm.objects('Movies');
                const newObjects = newRealm.objects('Movies');

                // 遍历所有对象，并将新的模型中设置属性
                for (let i = 0; i &lt; oldObjects.length; i++) {
                    newObjects[i].newTitle = oldObjects[i].title + oldObjects[i].test1;
                    // Alert.alert('ssss',  newObjects[i].newTitle);
                }
            }
        }
    },
    {
        schema:[
            MoviesSchema
        ],
        path:'movies.realm',
        schemaVersion:3,
        migration:(oldRealm, newRealm)=&gt;{
            // 只有当schemaVersion小于3的时候才会执行if中代码
            if(oldRealm.schemaVersion &lt; 3){
                const oldObjects = oldRealm.objects('Movies');
                const newObjects = newRealm.objects('Movies');

                // 遍历所有对象，并将新的模型中设置属性
                for (let i = 0; i &lt; oldObjects.length; i++) {
                    newObjects[i].testTitle = oldObjects[i].newTitle+oldObjects[i].test2;
                    // Alert.alert('ssss',  newObjects[i].testTitle);
                }
            }
        }
    }
];</code></pre> 
<h2 id="3.Realm%E7%AE%A1%E7%90%86">3.Realm管理</h2> 
<pre class="has"><code>//获取被给予路径的Realm的版本号
let nextSchemaIndex = Realm.schemaVersion('movies.realm');

//保证不同版本Realm升级，执行不同Realm版本迁移升级
if (nextSchemaIndex != -1) {
    while (nextSchemaIndex &lt; UpgradeMigrations.length) {
        //  var migratedRealm = new Realm(schemas[nextSchemaIndex++]);
        //   migratedRealm.close();
        // const migratedRealm = new Realm({...UpgradeMigrations[nextSchemaIndex] });
        const migratedRealm = new Realm(UpgradeMigrations[nextSchemaIndex++]);
        // nextSchemaIndex += 1;
        migratedRealm.close();
    }
}

//获取当前版本的Realm
let realm = new Realm(UpgradeMigrations[UpgradeMigrations.length-1]);</code></pre> 
<h2 id="4.%E6%89%B9%E9%87%8F%E6%95%B0%E6%8D%AE%E6%8F%92%E5%85%A5%E5%A4%84%E7%90%86">4.批量数据插入处理</h2> 
<p>将批量数据放在一个事务(realm.write())中执行数据插入或更新；</p> 
<p>//在一个事务中循环插入数据</p> 
<p>movies.forEach(obj =&gt; {<!-- --><br>                 realm.create('Movies', obj, Realm.UpdateMode.Modified);<br>             });</p> 
<pre class="has"><code>const insertMovies=(movies)=&gt;{
    try{
        realm.write(()=&gt;{
            movies.forEach(obj =&gt; {
                realm.create('Movies', obj, Realm.UpdateMode.Modified);
            });
        });
    }catch (error) {
        console.log(error);
    }
};</code></pre> 
<p>调用执行批量数据插入</p> 
<pre class="has"><code>let movies = [];
        for(let i=0; i&lt;1000; i++) {
            movies[i] = {
                id: i + 'a000000',
                title: '展昭1234567890',
                year: 1978,
                mpaa_rating: 'mpaa_rating1',
                test1: 'testha1',
                test2: 'testha2',
                test3: 'testha3'
            };
        }
insertMovies(movies);</code></pre> 
<p><span style="color:#f33b45;">导入包含50000个实体的JSON字符串大约需要10秒。（每个实体都有ID、标题和年属性）。一个技巧是调试模式比在真实应用程序上运行要慢得多。</span></p> 
<p>数据查询</p> 
<pre class="has"><code>//查询
const queryMovies = () =&gt;{
    return realm.objects('Movies');
};</code></pre> 
<p>删除数据</p> 
<pre class="has"><code>//删除
const deleteMovies = () =&gt;{
    try {
        realm.write(() =&gt; {
            realm.delete(realm.objects('Movies'));
        })
    }
    catch (error){
        console.log(error)
    }
}</code></pre> 
<h2 id="5.%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B">5.完整代码示例</h2> 
<pre class="has"><code>/**
 * Realm管理类
 */
import Realm from 'realm'
import {Alert} from 'react-native';
// import {MoviesSchema} from 'public/realm/Schemeas'
// import Migrations from 'Migrations'
const MoviesSchema={
    name:'Movies',
    primaryKey:'id',
    properties:{
        id:'string',
        title:'string',
        year:'int',
        // newTitle:'string',  //版本2新增字段
        // testTitle:'string',    //版本3新增字段
        mpaa_rating:'string',
        test1:'string',
        test2:'string',
        test3:'string',
        newtest3:'string'
    }
};
let UpgradeMigrations = [
    {
        schema:[
            MoviesSchema
        ],
        path:'movies.realm',
        schemaVersion:1,
        migration:(oldRealm, newRealm)=&gt;{

        }
    }
    ,{
        schema:[
            MoviesSchema
        ],
        path:'movies.realm',
        schemaVersion:2,
        migration:(oldRealm, newRealm)=&gt;{
            // 只有当schemaVersion小于1的时候才会执行if中代码
            if(oldRealm.schemaVersion &lt; 2){
                const oldObjects = oldRealm.objects('Movies');
                const newObjects = newRealm.objects('Movies');

                // 遍历所有对象，并将新的模型中设置属性
                for (let i = 0; i &lt; oldObjects.length; i++) {
                    newObjects[i].newTitle = oldObjects[i].title + oldObjects[i].test1;
                    // Alert.alert('ssss',  newObjects[i].newTitle);
                }
            }
        }
    },
    {
        schema:[
            MoviesSchema
        ],
        path:'movies.realm',
        schemaVersion:3,
        migration:(oldRealm, newRealm)=&gt;{
            // 只有当schemaVersion小于3的时候才会执行if中代码
            if(oldRealm.schemaVersion &lt; 3){
                const oldObjects = oldRealm.objects('Movies');
                const newObjects = newRealm.objects('Movies');

                // 遍历所有对象，并将新的模型中设置属性
                for (let i = 0; i &lt; oldObjects.length; i++) {
                    newObjects[i].testTitle = oldObjects[i].newTitle+oldObjects[i].test2;
                    // Alert.alert('ssss',  newObjects[i].testTitle);
                }
            }
        }
    },
    // {
    //     schema:[
    //         MoviesSchema
    //     ],
    //     path:'movies.realm',
    //     schemaVersion:4,
    //     migration:(oldRealm, newRealm)=&gt;{
    //         // 只有当schemaVersion小于3的时候才会执行if中代码
    //         if(oldRealm.schemaVersion &lt; 3){
    //             const oldObjects = oldRealm.objects('Movies');
    //             const newObjects = newRealm.objects('Movies');
    //
    //             // 遍历所有对象，并将新的模型中设置属性
    //             for (let i = 0; i &lt; oldObjects.length; i++) {
    //                 newObjects[i].newtest3 = oldObjects[i].testTitle + oldObjects[i].mpaa_rating;
    //                 // Alert.alert('ssss',  newObjects[i].testTitle);
    //             }
    //         }
    //     }
    // }
];

let nextSchemaIndex = Realm.schemaVersion('movies.realm');

//保证不同版本数据库升级
if (nextSchemaIndex != -1) {
    while (nextSchemaIndex &lt; UpgradeMigrations.length) {
        //  var migratedRealm = new Realm(schemas[nextSchemaIndex++]);
        //   migratedRealm.close();
        // const migratedRealm = new Realm({...UpgradeMigrations[nextSchemaIndex] });
        const migratedRealm = new Realm(UpgradeMigrations[nextSchemaIndex++]);
        // nextSchemaIndex += 1;
        migratedRealm.close();
    }
}

let realm = new Realm(UpgradeMigrations[UpgradeMigrations.length-1]);

const insertMovies=(movies)=&gt;{
    try{
        realm.write(()=&gt;{
            // let oldMovies = realm.objects('Movies');
            // let count = oldMovies.length;
            // if(oldMovies = null || count == 0){
            //     realm.create('Movies', movies, Realm.UpdateMode.Modified);
            // }else{
                // oldMovies[count - 1].id = movies.id;
                // oldMovies[count - 1].title = movies.title;
                // oldMovies[count - 1].year = movies.year;
                // oldMovies[count - 1].mpaa_rating = movies.mpaa_rating;
                // oldMovies[count - 1].test1 = movies.test1;
                // oldMovies[count - 1].test2 = movies.test2;
                // oldMovies[count - 1].test3 = movies.test3;

            movies.forEach(obj =&gt; {
                realm.create('Movies', obj, Realm.UpdateMode.Modified);
            });
            // }


        });
    }catch (error) {
        console.log(error);
    }
};

//查询
const queryMovies = () =&gt;{
    return realm.objects('Movies');
};

export {
    insertMovies,
    queryMovies
}</code></pre> 
<p> </p> 
<p>参考：</p> 
<p>react-native Realm的使用</p> 
<p><a href="https://juejin.im/post/5a4b477b51882506e50d0175#heading-5" rel="nofollow">https://juejin.im/post/5a4b477b51882506e50d0175#heading-5</a></p> 
<p>How to fast insert a JSON into Realm Database for a React Native App</p> 
<p><a href="https://stackoverflow.com/questions/50937202/how-to-fast-insert-a-json-into-realm-database-for-a-react-native-app" rel="nofollow">https://stackoverflow.com/questions/50937202/how-to-fast-insert-a-json-into-realm-database-for-a-react-native-app</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/50ff2090c23fe79a59bcf148fb418971/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">为 magento 配置varnish cache</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/649a39400393e93720366fed41be8c1b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">jq&#43;swiper 实现今日头条App的选项卡效果</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>