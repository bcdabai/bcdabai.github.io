<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>NanoPi M1 Plus OpenWRT挂载NFS rootfs - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="NanoPi M1 Plus OpenWRT挂载NFS rootfs" />
<meta property="og:description" content="学习了韦东山老师的视频才知道可以通过设置内核启动参数来从NFS 挂载rootfs ，于是我在NanoPi M1 Plus 开发板上实际试了下，过程中也终于到一些问题，这里整理一下：
1.服务端要安装 nfs-kernel-server 并开启服务 apt-get install nfs-kernel-server /etc/init.d/nfs-kernel-server start 可以在 /etc/exports 里修改可挂载的目录 ，修改后记得重启服务
/home *(rw,sync,no_subtree_check) 如上表示/home 可挂载，* 表示所有ip 都可以挂载
2.内核要开启对NFS 的支持 Location:
-&gt; Kernel modules
–&gt; Filesystems
—&gt; kmod-fs-nfs &lt;y&gt;
—&gt; kmod-fs-nfs-v3 &lt;y&gt;
—&gt; kmod-fs-nfs-v4 &lt;y&gt;
3.内核要开启对KERNEL_ROOT_NFS 的支持 已看出KERNEL_ROOT_NFS 依赖于KERNEL_IP_PNP
所以 在Global build settings -&gt; Kernel build options 里选中 Compile the kernel with rootfs on NFS 即可。
4.设置内核启动参数 因为OpenWRT里会根据 openwrt\package\boot\uboot-sunxi\uEnv-default.txt 生成boot.scr ，所以内核启动参数在这里修改。
修改openwrt\package\boot\uboot-sunxi\uEnv-default.txt
root=/dev/mmcblk0p2 rootwait" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/04491501d4cd7c2860f6e6a0b928153c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-01-28T12:21:30+08:00" />
<meta property="article:modified_time" content="2019-01-28T12:21:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">NanoPi M1 Plus OpenWRT挂载NFS rootfs</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>学习了韦东山老师的视频才知道可以通过设置内核启动参数来从NFS 挂载rootfs ，于是我在NanoPi M1 Plus 开发板上实际试了下，过程中也终于到一些问题，这里整理一下：</p> 
<h3><a id="1_nfskernelserver__2"></a>1.服务端要安装 nfs-kernel-server 并开启服务</h3> 
<pre><code class="prism language-sh">apt-get install nfs-kernel-server
/etc/init.d/nfs-kernel-server start
</code></pre> 
<p>可以在 /etc/exports 里修改可挂载的目录 ，修改后记得重启服务</p> 
<pre><code class="prism language-sh">/home *(rw,sync,no_subtree_check)
</code></pre> 
<p>如上表示/home 可挂载，* 表示所有ip 都可以挂载</p> 
<h3><a id="2NFS__13"></a>2.内核要开启对NFS 的支持</h3> 
<p>Location:<br> -&gt; Kernel modules<br> –&gt; Filesystems<br> —&gt; kmod-fs-nfs &lt;y&gt;<br> —&gt; kmod-fs-nfs-v3 &lt;y&gt;<br> —&gt; kmod-fs-nfs-v4 &lt;y&gt;</p> 
<h3><a id="3KERNEL_ROOT_NFS__21"></a>3.内核要开启对KERNEL_ROOT_NFS 的支持</h3> 
<p><img src="https://images2.imgbox.com/19/d6/YnI8tnXb_o.png" alt="K1"><br> 已看出KERNEL_ROOT_NFS 依赖于KERNEL_IP_PNP<br> <img src="https://images2.imgbox.com/c8/6e/mGJan7Sn_o.png" alt="K2"><br> 所以 在Global build settings -&gt; Kernel build options 里选中 Compile the kernel with rootfs on NFS 即可。</p> 
<h3><a id="4_27"></a>4.设置内核启动参数</h3> 
<p>因为OpenWRT里会根据 openwrt\package\boot\uboot-sunxi\uEnv-default.txt 生成boot.scr ，所以内核启动参数在这里修改。</p> 
<p>修改openwrt\package\boot\uboot-sunxi\uEnv-default.txt<br> root=/dev/mmcblk0p2 rootwait<br> 改为<br> root=/dev/nfs nfsroot=172.16.10.67:/home/lql/my_rootfs/rootfs ip=172.16.10.69:172.16.10.67:172.16.0.1:255.255.0.0::eth0:off rootwait</p> 
<p>这里的172.16.10.67:/home/lql/my_rootfs/rootfs 是我从 build_dir/target-arm_cortex-a7+neon-vfpv4_musl_eabi/root-sunxi 里copy过来</p> 
<p>参考：linux/Documentation/filesystems/nfs/nfsroot.txt 里面有对nfsroot 的参数说明</p> 
<blockquote> 
 <p>root=/dev/nfs<br> This is necessary to enable the pseudo-NFS-device. Note that it’s not a<br> real device but just a synonym to tell the kernel to use NFS instead of<br> a real device.<br> nfsroot=[&lt;server-ip&gt;:]&lt;root-dir&gt;[,&lt;nfs-options&gt;]<br> ip=&lt;client-ip&gt;:&lt;server-ip&gt;:&lt;gw-ip&gt;:&lt;netmask&gt;:&lt;hostname&gt;:&lt;device&gt;:&lt;autoconf&gt;:&lt;dns0-ip&gt;:&lt;dns1-ip&gt;</p> 
</blockquote> 
<h3><a id="5_45"></a>5.编译后测试</h3> 
<pre><code class="prism language-sh">[    6.408050] dwmac-sun8i 1c30000.ethernet eth0: Link is Up - 100Mbps/Full - flow control rx/tx
[    6.437281] IPv6: ADDRCONF(NETDEV_CHANGE): eth0: link becomes ready
[    6.467345] IP-Config: Complete:
[    6.470578]      device=eth0, hwaddr=00:00:00:f0:08:80, ipaddr=172.16.10.69, mask=255.255.0.0, gw=172.16.0.1
[    6.480414]      host=172.16.10.69, domain=, nis-domain=(none)
[    6.486240]      bootserver=172.16.10.67, rootserver=172.16.10.67, rootpath=
[    6.493634] vcc3v0: disabling
[    6.496605] vcc5v0: disabling
[    6.499592] ALSA device list:
[    6.502555]   No soundcards found.
[    6.507254] NOHZ: local_softirq_pending 80
[    6.511363] NOHZ: local_softirq_pending 88
[    6.520386] VFS: Mounted root (nfs filesystem) readonly on device 0:10.
[    6.529150] Freeing unused kernel memory: 2048K
[    6.537255] NOHZ: local_softirq_pending 80
[    6.541361] NOHZ: local_softirq_pending 88
[    6.547269] NOHZ: local_softirq_pending 08
[    6.557257] NOHZ: local_softirq_pending 80
[    6.567261] NOHZ: local_softirq_pending 08
[    6.577251] NOHZ: local_softirq_pending 82
[    6.583300] random: fast init done
[    6.597265] NOHZ: local_softirq_pending 82
[    6.617266] NOHZ: local_softirq_pending 08
[    6.652067] init: Console is alive
[    6.655694] init: - watchdog -
[    6.828851] kmodloader: loading kernel modules from /etc/modules-boot.d/*
[    6.850805] JFS: nTxBlock = 8049, nTxLock = 64399
[    6.866231] kmodloader: done loading kernel modules from /etc/modules-boot.d/*
[    6.882747] init: - preinit -
[    7.058118] random: jshn: uninitialized urandom read (4 bytes read)
[    7.094100] random: jshn: uninitialized urandom read (4 bytes read)
[    7.118780] random: jshn: uninitialized urandom read (4 bytes read)
ip: RTNETLINK answers: File exists
Press the [f] key and hit [enter] to enter failsafe mode
Press the [1], [2], [3] or [4] key and hit [enter] to select the debug level
[   10.269838] mount_root: mounting /dev/root
[   10.283215] urandom-seed: Seed file not found (/etc/urandom.seed)
[   19.447267] nfs: server 172.16.10.67 not responding, still trying
</code></pre> 
<p>坑1：nfs: server 172.16.10.67 not responding, still trying<br> 原因分析：<br> 设备ip配置的是172.16.10.69，ping 172.16.10.69 结果</p> 
<pre><code class="prism language-sh">root@localhost:~# ping 172.16.10.69
PING 172.16.10.69 (172.16.10.69) 56(84) bytes of data.
From 172.16.6.128 icmp_seq=1 Destination Host Unreachable
From 172.16.6.128 icmp_seq=2 Destination Host Unreachable
From 172.16.6.128 icmp_seq=3 Destination Host Unreachable
From 172.16.6.128 icmp_seq=4 Destination Host Unreachable
From 172.16.6.128 icmp_seq=5 Destination Host Unreachable
From 172.16.6.128 icmp_seq=6 Destination Host Unreachable
From 172.16.6.128 icmp_seq=7 Destination Host Unreachable
From 172.16.6.128 icmp_seq=8 Destination Host Unreachable
From 172.16.6.128 icmp_seq=9 Destination Host Unreachable
64 bytes from 172.16.10.69: icmp_seq=10 ttl=64 time=972 ms
64 bytes from 172.16.10.69: icmp_seq=11 ttl=64 time=0.657 ms
64 bytes from 172.16.10.69: icmp_seq=12 ttl=64 time=0.546 ms
64 bytes from 172.16.10.69: icmp_seq=13 ttl=64 time=0.653 ms
64 bytes from 172.16.10.69: icmp_seq=14 ttl=64 time=0.646 ms
From 172.16.6.128 icmp_seq=66 Destination Host Unreachable
From 172.16.6.128 icmp_seq=67 Destination Host Unreachable
</code></pre> 
<p>发现中途连接成功了，后面又断开了，猜测是设备ip 变更导致。<br> 结合前面打印，init: - preinit - 之后开始感觉不太对劲。<br> 跟踪一下 preinit ，就是个启动脚本，位于<br> 172.16.10.67:/home/lql/my_rootfs/rootfs/etc/preinit<br> 首行添加 set -xv ，这样可以展开命令行，方便跟踪.<br> 从新上电后，发现卡在这里。</p> 
<pre><code class="prism language-sh">install_bin() {
        local src files
        src=$1
        files=$1
        [ -x "$src" ] &amp;&amp; files="$src $(libs $src)"
        install_file + '[' -e  ]
+ return 1
+ boot_hook_shift preinit_mount_root fu+ return
+ uci -q get 'system.@system[0].urandom_seed'
+ SEED=
+ '['  '==' / -a  '!=' /etc/urandom.seed ]
+ boot_hook_shift preinit_main func
+ local 'hook=preinit_main_hook'
+ local 'rv+ local netdev vid
+ netdev=eth0
+ vid=eth0
+ '[' eth0 '=' et+ ip link set dev eth0 down
[   20.480996] nfs: server 172.16.10.67 not responding, still trying
</code></pre> 
<pre><code class="prism language-sh">root@debian:rootfs# grep "ip link set dev" . -rn 
./lib/netifd/wireless/mac80211.sh:513:          ip link set dev "$ifname" address "$macaddr"
./lib/netifd/wireless/mac80211.sh:670:  ip link set dev "$ifname" up || {
./lib/netifd/wireless/mac80211.sh:729:          ip link set dev "$wdev" down 2&gt;/dev/null
./lib/preinit/10_indicate_preinit:21:   ip link set dev $netdev up
./lib/preinit/10_indicate_preinit:133:          ip link set dev $netdev down
</code></pre> 
<p>查看rootfs/lib/preinit/10_indicate_preinit 发现里面确实对eth0 有down 操作。这里需要修改<br> 我修改后的 rootfs/lib/preinit/10_indicate_preinit</p> 
<pre><code class="prism language-c"><span class="token number">118</span> 
<span class="token number">119</span> <span class="token function">preinit_ip_deconfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">120</span>         #boot from NFS<span class="token punctuation">,</span>should <span class="token keyword">return</span> here
<span class="token number">121</span>         <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token number">122</span>         <span class="token punctuation">[</span> <span class="token operator">-</span>n <span class="token string">"$pi_ifname"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> grep <span class="token operator">-</span>q <span class="token string">"$pi_ifname"</span> <span class="token operator">/</span>proc<span class="token operator">/</span>net<span class="token operator">/</span>dev <span class="token operator">&amp;&amp;</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">123</span>                 local netdev vid
<span class="token number">124</span> 
<span class="token number">125</span>                 netdev<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>pi_ifname<span class="token operator">%</span>\<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">}</span>
<span class="token number">126</span>                 vid<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>pi_ifname#<span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">}</span>
<span class="token number">127</span> 
<span class="token number">128</span>                 <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"$vid"</span> <span class="token operator">=</span> <span class="token string">"$netdev"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> then
<span class="token number">129</span>                         vid<span class="token operator">=</span>
<span class="token number">130</span>                 fi
<span class="token number">131</span> 
<span class="token number">132</span>                 ip <span class="token operator">-</span><span class="token number">4</span> address flush dev $pi_ifname
<span class="token number">133</span>                 ip link set dev $netdev down
<span class="token number">134</span> 
<span class="token number">135</span>                 <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>n <span class="token string">"$vid"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> then
<span class="token number">136</span>                         ip link delete $pi_ifname
<span class="token number">137</span>                 fi
<span class="token number">138</span>         <span class="token punctuation">}</span>
<span class="token number">139</span> <span class="token punctuation">}</span>
</code></pre> 
<p>重新上电，运行OK。</p> 
<pre><code class="prism language-sh">BusyBox v1.28.3 () built-in shell (ash)

  _______                     ________        __
 |       |.-----.-----.-----.|  |  |  |.----.|  |_
 |   -   ||  _  |  -__|     ||  |  |  ||   _||   _|
 |_______||   __|_____|__|__||________||__|  |____|
          |__| W I R E L E S S   F R E E D O M
 -----------------------------------------------------
 OpenWrt 18.06.1, r7258-5eb055306f
 -----------------------------------------------------
root@172:/# 
root@172:/# 
root@172:/# ifconfig -a
eth0      Link encap:Ethernet  HWaddr xx:xx:xx:35:4A:71  
          inet addr:172.16.10.69  Bcast:172.16.255.255  Mask:255.255.0.0
          inet6 addr: fd45:3a5d:aef5::d813:14ff:fe35:4a71/64 Scope:Global
          inet6 addr: fe80::d813:14ff:fe35:4a71/64 Scope:Link
          inet6 addr: fdd0:b256:b6ca::d813:14ff:fe35:4a71/64 Scope:Global
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:2616 errors:0 dropped:5 overruns:0 frame:0
          TX packets:1268 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:2470844 (2.3 MiB)  TX bytes:196349 (191.7 KiB)
          Interrupt:34 

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

root@172:/# [  190.176558] random: crng init done
[  190.179978] random: 4 urandom warning(s) missed due to ratelimiting

root@172:/# 
root@172:/# 
</code></pre> 
<h3><a id="_216"></a>遇到过的坑：</h3> 
<h4><a id="1failed_Protocol_not_supported_218"></a>坑1：failed: Protocol not supported</h4> 
<pre><code class="prism language-c">root@OpenWrt<span class="token punctuation">:</span><span class="token operator">/</span># mount <span class="token operator">-</span>t nfs <span class="token operator">-</span>o nolock <span class="token number">172.16</span><span class="token number">.10</span><span class="token number">.67</span><span class="token punctuation">:</span><span class="token operator">/</span>home <span class="token operator">/</span>mnt<span class="token operator">/</span>nfs<span class="token operator">/</span>
mount<span class="token punctuation">:</span> mounting <span class="token number">172.16</span><span class="token number">.10</span><span class="token number">.67</span><span class="token punctuation">:</span><span class="token operator">/</span>home on <span class="token operator">/</span>mnt<span class="token operator">/</span>nfs<span class="token operator">/</span> failed<span class="token punctuation">:</span> Protocol not supported
</code></pre> 
<p>原因分析：nfs 有多种协议 nfs-v3 nfs-v4 等，内核支持的协议不匹配<br> 解决办法：配置内核时，增加 kmod-fs-nfs-v3 kmod-fs-nfs-v4 的支持</p> 
<h4><a id="2VFS_Unable_to_mount_root_fs_via_NFS_trying_floppy_226"></a>坑2：VFS: Unable to mount root fs via NFS, trying floppy</h4> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>  <span class="token number">110.565339</span><span class="token punctuation">]</span> VFS<span class="token punctuation">:</span> Unable to mount root fs via NFS<span class="token punctuation">,</span> trying floppy<span class="token punctuation">.</span>
<span class="token punctuation">[</span>  <span class="token number">110.571675</span><span class="token punctuation">]</span> VFS<span class="token punctuation">:</span> Cannot open root device <span class="token string">"nfs"</span> or unknown<span class="token operator">-</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span> error <span class="token operator">-</span><span class="token number">6</span>
</code></pre> 
<p>解决办法：配置内核时，开启对KERNEL_ROOT_NFS 的支持<br> 已经KERNEL_ROOT_NFS =y ? 仍有上述问题？ 需要制定 nfs version</p> 
<pre><code class="prism language-sh">root=/dev/nfs nfsroot=172.16.10.67:/home/lql/my_rootfs/rootfs,vers=3   xxxx
</code></pre> 
<h3><a id="_238"></a>总结：</h3> 
<p>挂载NFS 根文件系统必须要使用静态ip，挂载成功后也不允许ip 发生更改，否则就会报nfs: server 172.16.10.67 not responding 的错误。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/89ea762e2311732dbfe9d90b2efc794d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Ubantu安装搜狗输入法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/79874c9c6cd411475254f842a202b791/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">solr搜索引擎</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>