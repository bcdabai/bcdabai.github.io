<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>设计模式⑧ ：管理状态 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="设计模式⑧ ：管理状态" />
<meta property="og:description" content="文章目录 一、前言二、Observer 模式1. 介绍2. 应用3. 总结 三、Memento 模式1. 介绍2. 应用3. 总结 四、State 模式1. 介绍2. 应用3. 总结 参考文章 一、前言 有时候不想动脑子，就懒得看源码又不像浪费时间所以会看看书，但是又记不住，所以决定开始写&#34;抄书&#34;系列。本系列大部分内容都是来源于《 图解设计模式》（【日】结城浩 著）。该系列文章可随意转载。
二、Observer 模式 Observer 模式 ： 发送状态变化通知
1. 介绍 Observer 即 “观察者”，在 Observer 模式中，当观察对象的状态发生变化时，会通知给观察者。 Observer 模式适用于根据对象状态进行相应处理的场景。
Observer 模式 中出场的角色：
Subject （观察对象）：Subject 角色表示观察对象。Subject 角色定义了注册观察者和删除观察者的方法。此外，他还声明了 “获取现在的状态” 的方法。ConcreteSubject （具体的观察对象）：ConcreteSubject 角色表示具体的被观察的对象。当自身状态发生变化后，他会通知所有已经注册的 Observer 角色。Observer（观察者）：Observer 角色负责接收来着Subject 角色的状态变化的通知。为此，它声明了 update 方法。ConcreteObserver（具体的观察者）：ConcreteObserver 角色负责具体的 Observer。当他的 update 方法被调用后，会去获取要观察的对象的最新状态。 类图如下：
Demo 如下
// 监听者接口 public interface Observer { void update(NumberGenerator generator); } // 监听者实现类 public class NumberObserver implements Observer{ @Override public void update(NumberGenerator generator) { System." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/6ec9568294555febeb4d3b3329769549/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-24T16:43:44+08:00" />
<meta property="article:modified_time" content="2024-01-24T16:43:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">设计模式⑧ ：管理状态</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">一、前言</a></li><li><a href="#Observer__3" rel="nofollow">二、Observer 模式</a></li><li><ul><li><a href="#1__5" rel="nofollow">1. 介绍</a></li><li><a href="#2__81" rel="nofollow">2. 应用</a></li><li><a href="#3__119" rel="nofollow">3. 总结</a></li></ul> 
  </li><li><a href="#Memento__136" rel="nofollow">三、Memento 模式</a></li><li><ul><li><a href="#1__139" rel="nofollow">1. 介绍</a></li><li><a href="#2__328" rel="nofollow">2. 应用</a></li><li><a href="#3__340" rel="nofollow">3. 总结</a></li></ul> 
  </li><li><a href="#State__363" rel="nofollow">四、State 模式</a></li><li><ul><li><a href="#1__366" rel="nofollow">1. 介绍</a></li><li><a href="#2__557" rel="nofollow">2. 应用</a></li><li><a href="#3__831" rel="nofollow">3. 总结</a></li></ul> 
  </li><li><a href="#_850" rel="nofollow">参考文章</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一、前言</h2> 
<p>有时候不想动脑子，就懒得看源码又不像浪费时间所以会看看书，但是又记不住，所以决定开始写"抄书"系列。本系列大部分内容都是来源于《 图解设计模式》（【日】结城浩 著）。该系列文章可随意转载。</p> 
<h2><a id="Observer__3"></a>二、Observer 模式</h2> 
<p><strong>Observer 模式 ： 发送状态变化通知</strong></p> 
<h3><a id="1__5"></a>1. 介绍</h3> 
<p>Observer 即 “观察者”，在 Observer 模式中，当观察对象的状态发生变化时，会通知给观察者。 Observer 模式适用于根据对象状态进行相应处理的场景。</p> 
<hr> 
<p><strong>Observer 模式 中出场的角色：</strong></p> 
<ul><li>Subject （观察对象）：Subject 角色表示观察对象。Subject 角色定义了注册观察者和删除观察者的方法。此外，他还声明了 “获取现在的状态” 的方法。</li><li>ConcreteSubject （具体的观察对象）：ConcreteSubject 角色表示具体的被观察的对象。当自身状态发生变化后，他会通知所有已经注册的 Observer 角色。</li><li>Observer（观察者）：Observer 角色负责接收来着Subject 角色的状态变化的通知。为此，它声明了 update 方法。</li><li>ConcreteObserver（具体的观察者）：ConcreteObserver 角色负责具体的 Observer。当他的 update 方法被调用后，会去获取要观察的对象的最新状态。</li></ul> 
<hr> 
<p><strong>类图如下：</strong><br> <img src="https://images2.imgbox.com/11/66/GAe68gDu_o.png" alt="在这里插入图片描述"></p> 
<p><strong>Demo 如下</strong></p> 
<pre><code class="prism language-java"><span class="token comment">// 监听者接口</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Observer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">NumberGenerator</span> generator<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听者实现类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NumberObserver</span> <span class="token keyword">implements</span> <span class="token class-name">Observer</span><span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">NumberGenerator</span> generator<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"number = "</span> <span class="token operator">+</span> generator<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 数字生成器</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NumberGenerator</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Observer</span><span class="token punctuation">&gt;</span></span> observers <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Getter</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> number<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 执行某个操作
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            number <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 通知监听者动作执行</span>
            <span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 添加监听者</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token class-name">Observer</span> observer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        observers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 通知所有监听者
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        observers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>observer <span class="token operator">-&gt;</span> observer<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObserverDemoMain</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">NumberGenerator</span> generator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NumberGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">NumberObserver</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NumberObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加监听者</span>
        generator<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行某个操作</span>
        generator<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<hr> 
<h3><a id="2__81"></a>2. 应用</h3> 
<ul><li> <p>诸如 MQ 中的消费者也是订阅了相关的 Queue，当相关的 Queue有消息进入后，会推送给消费者得知，消费者可以处理对应消息。</p> </li><li> <p>Spring 中向事务管理器TransactionSynchronizationManager注册事务某个阶段执行的监听事件，如下：</p> <pre><code class="prism language-java">    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// step1 : 在 sys_role 表中插入一条 role_id = 1 的记录</span>
        <span class="token function">addRole</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// step2 : 在 sys_role 表中插入一条 role_id = 2 的记录</span>
        <span class="token function">addRole</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 向事务同步管理器注册一个 TransactionSynchronization 匿名实现类，作用是当前事务提交后，执行 addPermission 方法。</span>
        <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">registerSynchronization</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransactionSynchronizationAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 当前事务提交后触发该方法</span>
        	<span class="token comment">// step3 : 在 sys_rermission 表中插入一条 permission_id = id 的记录。</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">addPermission</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> </li><li> <p>Spring 中典型的监听器模式：即我们通过自定义 ApplicationEvent 同时通过实现 ApplicationListener 来监听指定事件的发生。如下，在 SpringBoot 启动时会调用如下几个方法，发送容器初始化、容器初始化结束等相关消息，监听对应事件的监听器会监听到该消息并可以做特定的处理。<br> <img src="https://images2.imgbox.com/48/b2/GB1NuyDJ_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<hr> 
<hr> 
<p><strong>个人使用：该部分内容是写给自己看的，帮助自身理解，因此就不交代项目背景了，读者请自行忽略（◐ˍ◑）</strong>：</p> 
<ul><li>项目 A 中，对于订单状态的刷新可以有两个触发点：用户点击刷新或接收到 MQ 推送消息后刷新。因此这里做了一个统一，无论是 MQ 还是用户点击刷新，都会触发一个 RefreshEvent 事件，而存在一个 RefreshEvent 事件的监听器来监听该事件。当事件触发时会调用监听器的指定方法来完成刷新操作。</li></ul> 
<hr> 
<h3><a id="3__119"></a>3. 总结</h3> 
<p><strong>扩展思路</strong></p> 
<ul><li>可替换性：使用设计模式的目的之一就是一使类成为可复用的组件。在 Observer 模式中，有连接的仅仅是 Subject 角色 和 Observer 角色，而 ConcreteSubject 和 ConcreteObserver 角色并没有直接联系，可以随意替换。</li><li>当 Observer 的行为会对 Subject 产生影响时 ：当 Subject 触发 update 操作时会调用 Observer 方法，但是需要注意如果 Observer 角色中如果再调用 Subject 的 update 方法可能就会造成循环调用。</li><li>传递更新信息的方式：有时我们可以在 Subject 触发时将需要更新的信息传递过去，这样就省去了 Observer 自己获取数据的麻烦，不过如此Subject 就知道了 Observer 中要进行的操作了，在复杂程序中这样的操作会使程序缺少灵活性，所以需要根据程序的复杂度来考虑在触发时数据传递的方式。</li><li>从“观察”变为“通知”：Observer 本意是 观察者，但实际上 Observer 角色并非主动的去观察，而是被动的接受来自 Subject 角色的通知。因此 Observer 模式也被称为 Publish-Subscribe （发布-订阅）模式。</li></ul> 
<hr> 
<p><strong>相关设计模式：</strong></p> 
<ul><li> <p>Mediator 模式：在 Mediator 模式中，有时会使用 Observer 模式来实现 Mediator 角色与 Colleague 角色之间的通信。就“发送状态变化通知”这一点而已，Mediator 模式与 Observer 模式是类似的。不过这两种模式中通知的目的和视角不同。</p> <p>在Mediator 模式中，虽然也会发送通知，不过那只是为了对 Colleague 角色进行仲裁而已，而在 Observer 模式中，将 Subject 角色的状态变化通知给 Observer 角色的目的则主要是为了使 Subject 角色与 Observer 角色同步。</p> </li></ul> 
<hr> 
<h2><a id="Memento__136"></a>三、Memento 模式</h2> 
<p><strong>Memento 模式 ：保存对象状态</strong></p> 
<h3><a id="1__139"></a>1. 介绍</h3> 
<p>我们在文本编辑器编辑时，如果不小心误操作，可以通过撤回（undo）功能将内容恢复到之前的状态。而面对对象编程的方式实现撤销功能时，需要事先保存实例的相关状态信息，然后再撤销时，还需要根据所保存的信息将实例恢复到原先的状态。</p> 
<p>想要恢复实例，需要一个可以自由访问实例内部结构的权限，但是如果稍微不注意又可能会将依赖于实例内部结构的代码分散到编写在程序的各个地方，导致程序变的难以维护。这种情况叫做“破坏了封装性”。</p> 
<p>而通过引入表示实例状态的角色，可以在保存和回复实例时有效地方志对象的封装性遭到破坏，即 Memento 模式。</p> 
<hr> 
<p><strong>Memento 模式 中出场的角色</strong>：</p> 
<ul><li> <p>Originator（生成者）: Originator角色会在保存自己的最新状态时生成 Memento角色。当把以前保存的 Memento 角色传递给 Originator 角色时，他会将自己恢复至生成该Memento角色时的状态。</p> </li><li> <p>Memento（纪念品）：Memento 角色会将 Originator 角色的内部信息整合在一起，在Memento角色中虽然保存了 Originator 角色的信息，但是他不会向外部公开这些信息。Memento 角色有以下两种接口：</p> 
  <ul><li>wide interface（宽接口）：Memento 角色提供的宽接口是指所有用于获取回复对象状态信息的方法的集合。由于宽接口会暴露所有 Memento 角色的内部信息，因此能够使用宽接口的只有 Originator 角色。</li><li>narrow interface (窄接口) ：Memento角色为外部的 Caretaker 角色提供了窄接口。可以通过窄接口获取的 Memento 角色的内部信息非常有限，因此可以有效防止信息泄漏。</li></ul> <p>通过对外提供这两种接口，可由有效防止对象的封装性被破坏。</p> </li><li> <p>Caretaker（负责人）：当Caretaker 角色想要保存当前的 Originator 角色状态时，会通过 Originator 角色。Originator角色在接收到通知后会生成 Memento 角色的实力并将其返回给 Caretaker 角色。由于以后可能会用 Memento 实例来将 Originator 恢复至原来的状态，所以 Caretaker 角色会一直保存Memento 实例。</p> <p>不过由于 Caretaker 角色只能使用Memento 角色的两种接口中的窄接口，也就是说它无法访问 Memento 角色内部的所有信息。它只是将 Originator 角色生成的Memento角色当做一个黑盒保存起来。</p> <p>虽然 Originator 角色和 Memento 角色之前是强关联，但是Caretaker 角色和 Memento 角色之前是弱关联关系。Memento 角色对 Caretaker 角色因此了自身的内部信息。</p> </li></ul> 
<hr> 
<p><strong>类图如下：</strong><br> <img src="https://images2.imgbox.com/e8/a2/J5IArhMj_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<p><strong>Demo 如下：</strong> 游戏自动进行，通过掷骰子来决定下一个状态，点数为1时增加金钱，2时减少，6时得到水果，而如果金钱减少则通过 Memento 对象回滚到上一轮的状态。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Memento</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 当前持有金钱
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> money<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 当前持有水果
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fruits <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Memento</span><span class="token punctuation">(</span><span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>money <span class="token operator">=</span> money<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取当前金钱
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> money<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 添加水果
     * @param fruit
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addFruit</span><span class="token punctuation">(</span><span class="token class-name">String</span> fruit<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        fruits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fruit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取持有水果
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFruits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> fruits<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Gamer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 当前持有金钱
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> money<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 当前持有水鬼
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fruits <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 水果列表
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fruitsName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token string">"苹果"</span><span class="token punctuation">,</span> <span class="token string">"橘子"</span><span class="token punctuation">,</span> <span class="token string">"香蕉"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 随机数
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Gamer</span><span class="token punctuation">(</span><span class="token keyword">int</span> money<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>money <span class="token operator">=</span> money<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> money<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getFruits</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> fruits<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> dice <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dice <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            money <span class="token operator">+=</span> <span class="token number">100</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"所持有的金钱增加了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dice <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            money <span class="token operator">/=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"所持有的金钱减半了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dice <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> fruit <span class="token operator">=</span> <span class="token function">getFruit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fruits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fruit<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"获得了水果 "</span> <span class="token operator">+</span> fruit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"什么都没发生"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 创建快照
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Memento</span> <span class="token function">createMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Memento</span> memento <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Memento</span><span class="token punctuation">(</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fruits<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"好吃的"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>memento<span class="token operator">::</span><span class="token function">addFruit</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> memento<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 快照还原
     * @param memento
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">restoreMemento</span><span class="token punctuation">(</span><span class="token class-name">Memento</span> memento<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>money <span class="token operator">=</span> memento<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fruits <span class="token operator">=</span> memento<span class="token punctuation">.</span><span class="token function">getFruits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取奖励水果
     *
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getFruit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> prefix <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"好吃的"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> prefix <span class="token operator">+</span> fruitsName<span class="token punctuation">[</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>fruitsName<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MementoDemoMain</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Gamer</span> gamer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gamer</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Memento</span> memento <span class="token operator">=</span> gamer<span class="token punctuation">.</span><span class="token function">createMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"i = "</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">": 当前金钱 = "</span> <span class="token operator">+</span> gamer<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"; 当前水果 = "</span> <span class="token operator">+</span> gamer<span class="token punctuation">.</span><span class="token function">getFruits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            gamer<span class="token punctuation">.</span><span class="token function">bet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前持有金钱 money = "</span> <span class="token operator">+</span> gamer<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>gamer<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> memento<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前持有金钱增加, 继续游戏"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                memento <span class="token operator">=</span> gamer<span class="token punctuation">.</span><span class="token function">createMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前持有金钱减少, 恢复快照状态"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                gamer<span class="token punctuation">.</span><span class="token function">restoreMemento</span><span class="token punctuation">(</span>memento<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>输出如下：<br> <img src="https://images2.imgbox.com/5d/13/NdNGiY1E_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h3><a id="2__328"></a>2. 应用</h3> 
<ul><li>想到了数据库中的事务回滚，效果表现与 Memento 模式有些类似，表象为事务执行失败后将数据回滚到事务开启前的快照版本，但是这并不是简单的回滚快照，而是通过 Undo 版本链（如有需要可参阅 <a href="https://blog.csdn.net/filling_l/article/details/112854716">https://blog.csdn.net/filling_l/article/details/112854716</a>）来实现的，因此不能直接带入 State 模式，<s>只是突然想到了而已</s> 。</li><li>除此之外又突然想到了 MySQL 中的 SavePoint 的内容（与本文无关，想到了就记录下）：即 MySQL 中的事务中存在一个 SavePoint 的概念：即一个事务中可以创建一个或多个 SavePoint，当设置SavePoint 时 当事务只会回滚到 SavePoint，而 SavePoint 之前的内容不会回滚。如一个事务中，先增加两条记录，然后设置一个 SavePoint， 再删除两条记录，此时出现了某种异常，事务进行回滚时则只会回滚删除语句的操作，插入语句则不会回滚。</li></ul> 
<hr> 
<hr> 
<p><strong>个人使用：该部分内容是写给自己看的，帮助自身理解，因此就不交代项目背景了，读者请自行忽略（◐ˍ◑）</strong>：</p> 
<ul><li>在项目A中对单证会进行多次修改并保存，而相关的操作人员经常会不小心修改某个参数并保存，而在后续过程中会被其他人员发现数据错误，而修改后操作人员并不承认自己曾经修改过数据。因此可以通过 Memento 模式记录人员的每次修改内容，以便追溯修改人员以及数据回滚。</li></ul> 
<h3><a id="3__340"></a>3. 总结</h3> 
<p><strong>扩展思路</strong></p> 
<ul><li>需要多少个 Memento ：根据实际业务的不同，可以保存多个 Memento 实例，就可以是实现保存的各个时间点的对象的状态。</li><li>Memento 的有效期限是多久：如果将 Memento 永远保存在文件中，就可能会出现有效期限的问题。因为可能在后续的某个时间点将 Memento 保存在文件中之后升级了程序版本，导致保存的 Memento 与当前程勋内部不匹配。</li><li>划分 Caretaker 角色 和 Originator 角色的意义：如果要实现撤销功能，为什么不直接在 Originator 角色中实现？这是因为 Caretaker 角色的职责是觉得何时拍摄快照、何时撤销以及保存 Memento 角色。另一方面 Originator 角色的职责是生成 Memento 角色和使用接收到的 Memento 角色来恢复自己的状态。以上是 Caretaker 角色和 Originator 角色的职责分担，有了这样的职责分担，当我们需要对应一下需求变更时，就可以完全不修改 Originator 角色。 
  <ul><li>变更为可以多次撤销。</li><li>变更为不仅可以撤销，还可以将现在的状态保存在文件中。</li></ul> </li></ul> 
<hr> 
<p><strong>相关设计模式</strong></p> 
<ul><li>Command 模式：在使用 Command 模式处理命令是，可以使用 Memento 模式实现撤销功能。</li><li>Protype 模式：在 Memento 模式中，为了能够实现快照和撤销功能，保存了对象当前的状态。保存的信息只是在恢复状态时所需要的那部分信息。而在 Protype 模式中，会生成一个与当前实例完全相同的另外一个实例。这两个实例的内容完全一样。</li><li>State 模式：在 Memento 模式中，是用实例来表示状态，而在 State 模式中，则是用类表示状态。</li></ul> 
<hr> 
<p><strong>一时的小想法，仅仅个人理解，无需在意 ：</strong></p> 
<ul><li>在实际保存快照的过程中，要考虑到保存时效的问题，时效过长则会占用空间并且可能会跟不上版本。另外还需要考虑到存储的方式，如果快照内容非常大，就不适合存到数据库中，因为快照一般都不需要搜索，所以可以将内容写入到文件中，数据库中保存文件地址即可。</li></ul> 
<hr> 
<h2><a id="State__363"></a>四、State 模式</h2> 
<p><strong>State 模式 ：用类表示状态</strong></p> 
<h3><a id="1__366"></a>1. 介绍</h3> 
<p>在面向对象编程中，是用类表示对象的。而在 State 模式中，我们可以用类来表示状态。</p> 
<hr> 
<p><strong>State 模式 中出场的角色</strong>：</p> 
<ul><li>State （状态）: State 角色表示状态，定义了根据不同状态进行不同处理的接口。该接口是那些处理内容依赖于状态的方法的集合。</li><li>ConcreteState（具体状态）：ConcreteState角色表示各个具体的状态，它实现了State接口。</li><li>Context（状况、前后关系、上下文）：Context 角色持有当前状态的 ConcreteState 角色。此外它还定义了供外部调用者调用 State 模式的接口。</li></ul> 
<hr> 
<p><strong>类图如下</strong><br> <img src="https://images2.imgbox.com/57/5d/v42BS5jH_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<p><strong>Demo如下</strong> ： 一个金库系统，分为白天和晚上两个状态，每小时使用一次金库，同步一次警局。</p> 
<pre><code class="prism language-java"><span class="token comment">// 状态接口</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">State</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 设置时间
     * @param context
     * @param hour
     */</span>
    <span class="token keyword">void</span> <span class="token function">doClock</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token keyword">int</span> hour<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 使用金库
     * @param context
     */</span>
    <span class="token keyword">void</span> <span class="token function">doUse</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * 正常通话
     * @param context
     */</span>
    <span class="token keyword">void</span> <span class="token function">doPhone</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 白天状态</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DayState</span> <span class="token keyword">implements</span> <span class="token class-name">State</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DayState</span> INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DayState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">DayState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 单例模式获取实例
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DayState</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doClock</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token keyword">int</span> hour<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hour <span class="token operator">&lt;</span> <span class="token number">9</span> <span class="token operator">||</span> hour <span class="token operator">&gt;=</span> <span class="token number">17</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            context<span class="token punctuation">.</span><span class="token function">changeState</span><span class="token punctuation">(</span><span class="token class-name">NightState</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doUse</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"白天使用金库"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doPhone</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"白天正常通话"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"白天"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 晚上状态</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NightState</span> <span class="token keyword">implements</span> <span class="token class-name">State</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">NightState</span> INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NightState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">NightState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 单例模式获取实例
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">NightState</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doClock</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token keyword">int</span> hour<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hour <span class="token operator">&gt;=</span> <span class="token number">9</span> <span class="token operator">&amp;&amp;</span> hour <span class="token operator">&lt;</span> <span class="token number">17</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            context<span class="token punctuation">.</span><span class="token function">changeState</span><span class="token punctuation">(</span><span class="token class-name">DayState</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doUse</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"晚上使用金库"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doPhone</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"晚上通话录音"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"晚上"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 上下文</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">State</span> state<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token class-name">State</span> state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 设置时间
     *
     * @param hour
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setClock</span><span class="token punctuation">(</span><span class="token keyword">int</span> hour<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"现在时间是 : "</span> <span class="token operator">+</span> hour <span class="token operator">+</span> <span class="token string">":00"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        state<span class="token punctuation">.</span><span class="token function">doClock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> hour<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 改变状态
     *
     * @param state
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeState</span><span class="token punctuation">(</span><span class="token class-name">State</span> state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"状态变更 : "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">+</span> <span class="token string">" -&gt; "</span> <span class="token operator">+</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 使用金库
     *
     * @param msg
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doUse</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">doUse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 联系报警中心
     *
     * @param msg
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callSecurityCenter</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">doPhone</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Main 方法</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StateDemoMain</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 执行状态，每小时使用一次金库, 拨打警局电话确认安全</span>
        <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token class-name">DayState</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">24</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            context<span class="token punctuation">.</span><span class="token function">setClock</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">doUse</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">callSecurityCenter</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>输出如下：<br> <img src="https://images2.imgbox.com/a5/59/n6W15EgR_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h3><a id="2__557"></a>2. 应用</h3> 
<ul><li><s>没想到</s></li></ul> 
<hr> 
<hr> 
<p><strong>个人使用：该部分内容是写给自己看的，帮助自身理解，因此就不交代项目背景了，读者请自行忽略（◐ˍ◑）</strong>：</p> 
<ul><li> <p>在 Memento 模式中举例的项目A中，实际上对于单证的处理不仅仅时修改，还存在多个环节状态的流转，而每个环节状态并非单独字段的判断，因此可以通过 State 模式来管控各个状态之间的流转，并且结合 Memento 模式，可以对每个环节状态做一个快照备份。</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BillInfo</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 表头信息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> head<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 表体信息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> details<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"BillInfo{"</span> <span class="token operator">+</span>
                <span class="token string">"head='"</span> <span class="token operator">+</span> head <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", details="</span> <span class="token operator">+</span> details <span class="token operator">+</span>
                <span class="token string">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BillState</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MementoContext</span> MEMENTO_CONTEXT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MementoContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * 编辑操作
     *
     * @param billInfo
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">edit</span><span class="token punctuation">(</span><span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"not support this operation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 发送操作
     *
     * @param billInfo
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"not support this operation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除操作
     *
     * @param billInfo
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"not support this operation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BillMemento</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 表头信息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> head<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 表体信息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> details<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 创建时间
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 快照版本号
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> version<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 上一个版本号
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> lastVersion<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeleteBillState</span> <span class="token keyword">extends</span> <span class="token class-name">BillState</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"单证状态已被删除"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendBillState</span> <span class="token keyword">extends</span> <span class="token class-name">BillState</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"单证已发送"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"单证状态无法删除"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EditBillState</span> <span class="token keyword">extends</span> <span class="token class-name">BillState</span> <span class="token punctuation">{<!-- --></span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">edit</span><span class="token punctuation">(</span><span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"单证被编辑"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"单证被删除"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BillStateProxy</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">BillState</span> EDIT_STATE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EditBillState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">BillState</span> DELETE_STATE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteBillState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">BillState</span> SEND_STATE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SendBillState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 当前状态
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BillState</span> billState <span class="token operator">=</span> EDIT_STATE<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 编辑操作
     *
     * @param billInfo
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">edit</span><span class="token punctuation">(</span><span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">,</span> <span class="token class-name">String</span> version<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        billState<span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span>billInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> MEMENTO_CONTEXT<span class="token punctuation">.</span><span class="token function">createMemento</span><span class="token punctuation">(</span>version<span class="token punctuation">,</span> billInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 发送操作
     *
     * @param billInfo
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        billState <span class="token operator">=</span> SEND_STATE<span class="token punctuation">;</span>
        billState<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>billInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除操作
     *
     * @param billInfo
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        billState <span class="token operator">=</span> DELETE_STATE<span class="token punctuation">;</span>
        billState<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>billInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 快照恢复
     * @param billInfo
     * @param version
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">restoreBillInfo</span><span class="token punctuation">(</span><span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">,</span> <span class="token class-name">String</span> version<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        MEMENTO_CONTEXT<span class="token punctuation">.</span><span class="token function">restoreMemento</span><span class="token punctuation">(</span>billInfo<span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MementoContext</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 快照存储
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BillMemento</span><span class="token punctuation">&gt;</span></span> store <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 创建快照
     *
     * @param billInfo
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createMemento</span><span class="token punctuation">(</span><span class="token class-name">String</span> laseVersion<span class="token punctuation">,</span> <span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BillMemento</span> memento <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BillMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        memento<span class="token punctuation">.</span><span class="token function">setHead</span><span class="token punctuation">(</span>billInfo<span class="token punctuation">.</span><span class="token function">getHead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        memento<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>billInfo<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        memento<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        memento<span class="token punctuation">.</span><span class="token function">setLastVersion</span><span class="token punctuation">(</span>laseVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">storeMemento</span><span class="token punctuation">(</span>memento<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> memento<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 快照回滚
     *
     * @param billInfo
     * @param version
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">restoreMemento</span><span class="token punctuation">(</span><span class="token class-name">BillInfo</span> billInfo<span class="token punctuation">,</span> <span class="token class-name">String</span> version<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">BillMemento</span> memento <span class="token operator">=</span> <span class="token function">getMemento</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
        billInfo<span class="token punctuation">.</span><span class="token function">setHead</span><span class="token punctuation">(</span>memento<span class="token punctuation">.</span><span class="token function">getHead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        billInfo<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span>memento<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 存储快照， 可以重写该方法以改变快照的存储方式
     *
     * @param memento
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">storeMemento</span><span class="token punctuation">(</span><span class="token class-name">BillMemento</span> memento<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>memento<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memento<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取快照
     *
     * @param version
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">BillMemento</span> <span class="token function">getMemento</span><span class="token punctuation">(</span><span class="token class-name">String</span> version<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoMain</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BillInfo</span> billInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BillInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        billInfo<span class="token punctuation">.</span><span class="token function">setHead</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        billInfo<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">BillStateProxy</span> billState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BillStateProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 快照版本记录</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> versions <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> currVersion <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token comment">// 单证初始编辑状态，编辑状态不允许发送</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            billInfo<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            currVersion <span class="token operator">=</span> billState<span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span>billInfo<span class="token punctuation">,</span> currVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
            versions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>currVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 单证发送后变成已发送状态</span>
        billState<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>billInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 已发送状态单证无法删除</span>
        billState<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>billInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"操作结束后结果 ："</span> <span class="token operator">+</span> billInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 利用快照回滚单证内容</span>
        billState<span class="token punctuation">.</span><span class="token function">restoreBillInfo</span><span class="token punctuation">(</span>billInfo<span class="token punctuation">,</span> versions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"回滚后结果 ："</span> <span class="token operator">+</span> billInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>输入如下：<br> <img src="https://images2.imgbox.com/bc/7a/TIbIEUwr_o.png" alt="在这里插入图片描述"></p> </li><li> <p>突然想到 播放器的倍速播放似乎可以使用 State 模式？</p> </li></ul> 
<h3><a id="3__831"></a>3. 总结</h3> 
<p><strong>扩展思路</strong></p> 
<ul><li>分而治之：当遇到庞大且复杂的问题时，我们一般都会将问题分解为多个小问题逐个解决。而在 State 模式中，我们可以用类来表示状态，并且可以为每种具体的都定义一个相应的类，这样问题就被分解了。对于每种状态在对应的实例中实现对应的操作，而无需考虑其他因素，更为重要的是无需通过 if 判断多种情况，从而导致分支过多的情况。</li><li>依赖于状态的处理：在 State 接口中声明的所有方法都是“依赖于状态的处理”，都是“状态不同处理也不同”。</li><li>谁来管理状态迁移：用类来表示状态，将依赖于状态的处理分散在每个 ConcreteState 角色中，这里需要注意应该是谁来管理状态迁移，除了通过代码配置实现，还可以通过状态迁移表来实现，这种实现即根据 “输入和内部状态” 得到 “输出和下一个状态”。</li><li>不会自相矛盾：如果不使用 State 模式，我们需要用使用多个变量的值的集合来表示系统的状态，这时则需要注意不能让变量之间互相矛盾。而在 State 模式中使用类来表示状态，这样只需要一个表示系统状态的变量即可。</li><li>易于增加新的状态：在 State模式中增加新的状态很简单，编写一个实现 State 接口的实例即可，但是在 State 模式中增加其他“依赖状态的处理”则很困难，因为我们需要再 State 接口中增加新的方法，并且让所有子类实现它。</li></ul> 
<hr> 
<p><strong>相关设计模式</strong></p> 
<ul><li>Singleton 模式： Singleton 模式常常会出现在 ConcreteState角色中。</li><li>Flyweight 模式：在表示状态的类中并没有定义任何实例字段，因此有时我们可以使用 Flyweight 模式在多个 Context 角色之间共享 ConcreteState 角色。</li></ul> 
<hr> 
<h2><a id="_850"></a>参考文章</h2> 
<p><a href="https://mp.weixin.qq.com/s/fc8AB6MnYtCyp5jWvVgCjw" rel="nofollow">https://mp.weixin.qq.com/s/fc8AB6MnYtCyp5jWvVgCjw</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/24b63eb58d326c02ea13ab83903c11d6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">设计模式-工厂方法模式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f255ef8fbfa9b0c547c168f75eeefa40/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【前端小点】Vue3中的IP输入框组件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>