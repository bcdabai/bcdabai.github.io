<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Fastadmin 后台上传视频 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Fastadmin 后台上传视频" />
<meta property="og:description" content="在FastAdmin官网中，【文档-组件-文件上传】中传介绍了文件的上传（本文围绕上传50M的视频文件进行说明），在阅读以下内容前，建议先了解关于文件上传中的data-mimetype和data-maxsize两个属性。
一、在html文件中，添加2个属性data-mimetype和data-maxsize。 &lt;div class=&#34;form-group&#34;&gt; &lt;label class=&#34;control-label col-xs-12 col-sm-2&#34;&gt;{:__(&#39;Vediofile&#39;)}:&lt;/label&gt; &lt;div class=&#34;col-xs-12 col-sm-8&#34;&gt; &lt;div class=&#34;input-group&#34;&gt; &lt;input id=&#34;c-vediofile&#34; class=&#34;form-control&#34; size=&#34;50&#34; name=&#34;row[vediofile]&#34; type=&#34;text&#34;&gt; &lt;div class=&#34;input-group-addon no-border no-padding&#34;&gt; &lt;span&gt;&lt;button type=&#34;button&#34; id=&#34;plupload-vediofile&#34; class=&#34;btn btn-danger plupload&#34; data-input-id=&#34;c-vediofile&#34; data-mimetype=&#34;mp4,mp3,avi,flv,wmv&#34; data-multiple=&#34;false&#34; data-maxsize=&#34;50M&#34;&gt;&lt;i class=&#34;fa fa-upload&#34;&gt;&lt;/i&gt; {:__(&#39;Upload&#39;)}&lt;/button&gt;&lt;/span&gt; &lt;span&gt;&lt;button type=&#34;button&#34; id=&#34;fachoose-vediofile&#34; class=&#34;btn btn-primary fachoose&#34; data-input-id=&#34;c-vediofile&#34; data-mimetype=&#34;mp4,mp3,avi,flv,wmv&#34; data-multiple=&#34;false&#34;&gt;&lt;i class=&#34;fa fa-list&#34;&gt;&lt;/i&gt; {:__(&#39;Choose&#39;)}&lt;/button&gt;&lt;/span&gt; &lt;/div&gt; &lt;span class=&#34;msg-box n-right&#34; for=&#34;c-vediofile&#34;&gt;&lt;/span&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; 二、修改application/extra/upload.php中的maxsize配置： &lt;?php //上传配置 return [ // .... /** * 最大可上传大小 */ &#39;maxsize&#39; =&gt; &#39;50mb&#39;, /** * 可上传的文件类型(新增mp4,mp3,avi,flv,wmv视频文件后缀) */ &#39;mimetype&#39; =&gt; &#39;jpg,png,bmp,jpeg,gif,zip,rar,xls,xlsx,mp4,mp3,avi,flv,wmv&#39;, // ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/0bebe82147cac73a509ac0124c200e98/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-09-16T10:30:04+08:00" />
<meta property="article:modified_time" content="2019-09-16T10:30:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Fastadmin 后台上传视频</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>在<a href="https://www.fastadmin.net/" rel="nofollow">FastAdmin官网</a>中，【<a href="https://doc.fastadmin.net/" rel="nofollow">文档</a>-<a href="https://doc.fastadmin.net/docs/component.html" rel="nofollow">组件</a>-<a href="https://doc.fastadmin.net/docs/component.html#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0-1" rel="nofollow">文件上传</a>】中传介绍了文件的上传（本文围绕上传50M的视频文件进行说明），在阅读以下内容前，建议先了解关于文件上传中的data-mimetype和data-maxsize两个属性。</p> 
<h4><span style="color:#3399ea;">一、在html文件中，添加2个属性data-mimetype和data-maxsize。</span></h4> 
<pre class="has"><code class="language-html">&lt;div class="form-group"&gt;
    &lt;label class="control-label col-xs-12 col-sm-2"&gt;{:__('Vediofile')}:&lt;/label&gt;
    &lt;div class="col-xs-12 col-sm-8"&gt;
        &lt;div class="input-group"&gt;
            &lt;input id="c-vediofile" class="form-control" size="50" name="row[vediofile]" type="text"&gt;
            &lt;div class="input-group-addon no-border no-padding"&gt;
                &lt;span&gt;&lt;button type="button" id="plupload-vediofile" class="btn btn-danger plupload" data-input-id="c-vediofile" data-mimetype="mp4,mp3,avi,flv,wmv" data-multiple="false" data-maxsize="50M"&gt;&lt;i class="fa fa-upload"&gt;&lt;/i&gt; {:__('Upload')}&lt;/button&gt;&lt;/span&gt;
                &lt;span&gt;&lt;button type="button" id="fachoose-vediofile" class="btn btn-primary fachoose" data-input-id="c-vediofile" data-mimetype="mp4,mp3,avi,flv,wmv" data-multiple="false"&gt;&lt;i class="fa fa-list"&gt;&lt;/i&gt; {:__('Choose')}&lt;/button&gt;&lt;/span&gt;
            &lt;/div&gt;
            &lt;span class="msg-box n-right" for="c-vediofile"&gt;&lt;/span&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre> 
<h4><span style="color:#3399ea;">二、修改application/extra/upload.php中的maxsize配置：</span></h4> 
<pre class="has"><code class="language-php">&lt;?php

//上传配置
return [
    // ....

    /**
     * 最大可上传大小
     */
    'maxsize'   =&gt; '50mb',
    /**
     * 可上传的文件类型(新增mp4,mp3,avi,flv,wmv视频文件后缀)
     */
    'mimetype'  =&gt; 'jpg,png,bmp,jpeg,gif,zip,rar,xls,xlsx,mp4,mp3,avi,flv,wmv',
    
    // ....
];
</code></pre> 
<h4><span style="color:#3399ea;">三、修改php.ini配置文件后，并重新启动php.</span></h4> 
<pre class="has"><code class="language-bash">file_uploads = On ;是否允许通过HTTP上传文件的开关。默认为On即是开
upload_tmp_dir ;文件上传至服务器上存储临时文件的地方，如果没指定就会用系统默认的临时文件夹
upload_max_filesize = 8M ;望文生意，即允许上传文件大小的最大值。默认为2M
post_max_size = 8M ;指通过表单POST给PHP的所能接收的最大值，包括表单里的所有值。默认为8M</code></pre> 
<p>一般地，设置好上述四个参数后，在网络正常的情况下，上传&lt;=8M的文件是不成问题。<br> 但如果要上传&gt;8M的大体积文件（例如50M的），除了需配置以上<span style="color:#e579b6;">upload_max_filesize = 50M</span>及<span style="color:#e579b6;">post_max_size = 100M</span>外，需进一步配置以下的参数。</p> 
<pre class="has"><code class="language-bash">max_execution_time = 600 ;每个PHP页面运行的最大时间值(秒)
max_input_time = 600 ;每个PHP页面接收数据所需的最大时间
memory_limit = 128M ;单个php脚本所能申请到的最大内存空间</code></pre> 
<p>把上述参数修改后，在网络所允许的正常情况下，就可以上传大体积文件了。</p> 
<h4><span style="color:#3399ea;">4、配置nginx.conf</span></h4> 
<p>用 nginx 作代理服务器，上传大文件时（本人测试上传50m的文件），提示上传超时或文件过大。这是因为nginx 对上传文件大小有限制，而且默认是 1M。另外，若上传文件很大，还要适当调整上传超时时间。<br> 在nginx.conf文件中的http{}片段下添加如下配置：单位秒</p> 
<pre class="has"><code class="language-bash"># 限制请求体的大小，若超过所设定的大小，返回413错误
client_max_body_size        50m;
# http请求无法立即被容器(tomcat, netty等)处理，被放在nginx的待处理池中等待被处理。此参数为等待的最长时间，默认为60秒，官方推荐最长不要超过75秒
proxy_connect_timeout       600;
# http请求被服务器处理完后，把数据传返回给Nginx的用时，默认60秒
proxy_send_timeout          600;
# http请求被容器(tomcat, netty等)处理后，nginx会等待处理结果，也就是容器返回的response。此参数即为服务器响应时间，默认60秒
proxy_read_timeout          600;

send_timeout                600;</code></pre> 
<p>若重启nginx后上传文件，还是超时添加或修改以下配置项：</p> 
<pre class="has"><code class="language-bash">sendfile on; # 上传加速
keepalive_timeout 1800; # 默认链接时间是65s</code></pre> 
<p>若按照以上配置，上传文件时，Nginx返回：<span style="color:#e579b6;">502 Bad Gateway</span>或<span style="color:#e579b6;">504 Gateway Time-out</span>错误。那么请了解一下内容并更改配置：</p> 
<blockquote> 
 <p>Nginx 502 Bad Gateway的含义是请求的PHP-CGI已经执行，但是由于某种原因(一般是读取资源的问题)没有执行完毕而导致PHP-CGI进程终止。<br> Nginx 504 Gateway Time-out的含义是所请求的网关没有请求到，简单来说就是没有请求到可以执行的PHP-CGI。</p> 
 <p>解决这两个问题其实是需要综合思考的，一般来说Nginx 502 Bad Gateway和php-fpm.conf的设置有关，而Nginx 504 Gateway Time-out则是与nginx.conf的设置有关。而正确的设置需要考虑服务器自身的性能和访客的数量等多重因素。</p> 
</blockquote> 
<p><br> 以我目前的服务器为例子CPU是奔四1.5G的，内存1GB，Centos的系统，访客大概是50人左右同时在线。<br> 但是在线的人大都需要请求PHP-CGI进行大量的信息处理，因此我将nginx.conf设置为：</p> 
<pre class="has"><code class="language-bash">fastcgi_connect_timeout 300s;
fastcgi_send_timeout 300s;
fastcgi_read_timeout 300s;
fastcgi_buffer_size 128k;
fastcgi_buffers 8 128k;
fastcgi_busy_buffers_size 256k;
fastcgi_temp_file_write_size 256k;
fastcgi_intercept_errors on;</code></pre> 
<p>这里最主要的设置是前三条，这里规定了PHP-CGI的连接、发送和读取的时间，300秒足够用了，因此我的服务器很少出现504 Gateway Time-out这个错误。</p> 
<h4><span style="color:#3399ea;">五、一般情况下，做了以上配置后，上传50M文件没大问题，但仍出现：</span><span style="color:#e579b6;">502 Bad Gateway</span><span style="color:#3399ea;">和</span><span style="color:#e579b6;">504 Gateway Time-out</span><span style="color:#3399ea;">错误，那么请了解php-fpm.conf的设置。</span></h4> 
<p>php-fpm.conf有两个至关重要的参数，一个是"<span style="color:#f33b45;">max_children</span>",另一个是"<span style="color:#f33b45;">request_terminate_timeout</span>"<br> 我的两个设置的值一个是”40″，一个是”900″，但是这个值不是通用的，而是需要自己计算的。</p> 
<blockquote> 
 <p>计算的方式如下：<br> 　　如果你的服务器性能足够好，且宽带资源足够充足，PHP脚本没有系循环或BUG的话你可以直接将”request_terminate_timeout”设置成0s。0s的含义是让PHP-CGI一直执行下去而没有时间限制。而如果你做不到这一点，也就是说你的PHP-CGI可能出现某个BUG，或者你的宽带不够充足或者其他的原因导致你的PHP-CGI能够假死那么就建议你给”request_terminate_timeout”赋一个值，这个值可以根据你服务器的性能进行设定。一般来说性能越好你可以设置越高，20分钟-30分钟都可以。由于我的服务器PHP脚本需要长时间运行，有的可能会超过10分钟因此我设置了900秒，这样不会导致PHP-CGI死掉而出现502 Bad gateway这个错误。<br> 　　而”max_children”这个值又是怎么计算出来的呢?这个值原则上是越大越好，php-cgi的进程多了就会处理的很快，排队的请求就会很少。设置”max_children”也需要根据服务器的性能进行设定，一般来说一台服务器正常情况下每一个php-cgi所耗费的内存在20M左右，因此我的”max_children”我设置成40个，20M*40=800M也就是说在峰值的时候所有PHP-CGI所耗内存在800M以内，低于我的有效内存1Gb。而如果我的”max_children”设置的较小，比如5-10个，那么php-cgi就会“很累”，处理速度也很慢，等待的时间也较长。如果长时间没有得到处理的请求就会出现504 Gateway Time-out这个错误，而正在处理的很累的那几个php-cgi如果遇到了问题就会出现502 Bad gateway这个错误。</p> 
</blockquote> 
<p>FastAdmin上传文件教程及文件上传服务器相关配置至此结束。</p> 
<blockquote> 
 <p>[结语]  个人水平有限，仍在努力学习。</p> 
 <p>文章参考：<a href="https://www.cnblogs.com/xiamidong/p/4105583.html" rel="nofollow" id="cb_post_title_url">nginx 504 Gateway Time-out错误解决办法</a></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b9fd0e7c747f49cfed61e18379bc4144/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">搭建开发环境</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/922f1c63175283ab1f5a33ab357014d9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">golang读取文件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>