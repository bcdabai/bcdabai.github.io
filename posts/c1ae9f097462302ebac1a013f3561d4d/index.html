<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于Docker配置Mysql主从同步 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于Docker配置Mysql主从同步" />
<meta property="og:description" content="前言 该方式只能在主库同步到从库，不支持从库同步到主库
所以写的操作应该在主库进行，读的操作在从库执行
一、创建Mysql挂载目录 主库和从库目录如下
conf：mysql配置文件目录data：存储数据的目录 二、主从配置 分别在主从挂载目录conf创建my.cnf文件，启动容器时将配置文件挂载到容器中
1.主库配置 server-id：服务节点的唯一标识。需要给集群中的每个服务分配一个单独的ID。
log_bin：打开Binlog日志记录，并指定文件名。
log_bin-index：Binlog日志文件
[mysqld] server-id=99 #开启binlog log_bin=master-bin log_bin-index=master-bin.index skip-name-resolve # 设置连接端口 port=3306 # 允许最大连接数 max_connections=200 # 允许连接失败的次数。 max_connect_errors=10 # 服务端使用的字符集默认为UTF8 character-set-server=utf8 # 创建新表时将使用的默认存储引擎 default-storage-engine=INNODB # 默认使用“mysql_native_password”插件认证 #mysql_native_password default_authentication_plugin=mysql_native_password 2.从库配置 server-id：服务节点的唯一标识
relay-log：打开从服务的relay-log日志。
log-bin：打开从服务的bin-log日志记录。
[mysqld] #主库和从库需要不一致 server-id=88 #打开MySQL中继日志 relay-log-index=slave-relay-bin.index relay-log=slave-relay-bin #打开从服务二进制日志 log-bin=mysql-bin #使得更新的数据写进二进制日志中 log-slave-updates=1 # 设置3306端口 port=3306 # 允许最大连接数 max_connections=200 # 允许连接失败的次数。 max_connect_errors=10 # 服务端使用的字符集默认为UTF8 character-set-server=utf8 # 创建新表时将使用的默认存储引擎 default-storage-engine=INNODB # 默认使用“mysql_native_password”插件认证 #mysql_native_password default_authentication_plugin=mysql_native_password 三、拉取Mysql镜像（ mysql5." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c1ae9f097462302ebac1a013f3561d4d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-15T15:15:36+08:00" />
<meta property="article:modified_time" content="2023-08-15T15:15:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于Docker配置Mysql主从同步</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<blockquote> 
 <p>该方式只能在主库同步到从库，不支持从库同步到主库<br> 所以<code>写</code>的操作应该在<code>主库</code>进行，<code>读</code>的操作在<code>从库</code>执行</p> 
</blockquote> 
<hr> 
<h2><a id="Mysql_8"></a>一、创建Mysql挂载目录</h2> 
<blockquote> 
 <p>主库和从库目录如下</p> 
 <ul><li>conf：mysql配置文件目录</li><li>data：存储数据的目录</li></ul> 
</blockquote> 
<p><img src="https://images2.imgbox.com/d6/1c/xzc7gKxE_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h2><a id="_18"></a>二、主从配置</h2> 
<p><code>分别在主从挂载目录conf创建my.cnf文件，启动容器时将配置文件挂载到容器中</code></p> 
<h4><a id="1_20"></a>1.主库配置</h4> 
<blockquote> 
 <p>server-id：服务节点的唯一标识。需要给集群中的每个服务分配一个单独的ID。<br> log_bin：打开Binlog日志记录，并指定文件名。<br> log_bin-index：Binlog日志文件</p> 
</blockquote> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
server-id<span class="token operator">=</span><span class="token number">99</span>
<span class="token comment">#开启binlog</span>
<span class="token assign-left variable">log_bin</span><span class="token operator">=</span>master-bin
log_bin-index<span class="token operator">=</span>master-bin.index
skip-name-resolve
<span class="token comment"># 设置连接端口</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>
<span class="token comment"># 允许最大连接数</span>
<span class="token assign-left variable">max_connections</span><span class="token operator">=</span><span class="token number">200</span>
<span class="token comment"># 允许连接失败的次数。</span>
<span class="token assign-left variable">max_connect_errors</span><span class="token operator">=</span><span class="token number">10</span>
<span class="token comment"># 服务端使用的字符集默认为UTF8</span>
character-set-server<span class="token operator">=</span>utf8
<span class="token comment"># 创建新表时将使用的默认存储引擎</span>
default-storage-engine<span class="token operator">=</span>INNODB
<span class="token comment"># 默认使用“mysql_native_password”插件认证</span>
<span class="token comment">#mysql_native_password</span>
<span class="token assign-left variable">default_authentication_plugin</span><span class="token operator">=</span>mysql_native_password

</code></pre> 
<h3><a id="2_47"></a>2.从库配置</h3> 
<blockquote> 
 <p>server-id：服务节点的唯一标识<br> relay-log：打开从服务的relay-log日志。<br> log-bin：打开从服务的bin-log日志记录。</p> 
</blockquote> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
<span class="token comment">#主库和从库需要不一致</span>
server-id<span class="token operator">=</span><span class="token number">88</span>
<span class="token comment">#打开MySQL中继日志</span>
relay-log-index<span class="token operator">=</span>slave-relay-bin.index
relay-log<span class="token operator">=</span>slave-relay-bin
<span class="token comment">#打开从服务二进制日志</span>
log-bin<span class="token operator">=</span>mysql-bin
<span class="token comment">#使得更新的数据写进二进制日志中</span>
log-slave-updates<span class="token operator">=</span><span class="token number">1</span>
<span class="token comment"># 设置3306端口</span>
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">3306</span>
<span class="token comment"># 允许最大连接数</span>
<span class="token assign-left variable">max_connections</span><span class="token operator">=</span><span class="token number">200</span>
<span class="token comment"># 允许连接失败的次数。</span>
<span class="token assign-left variable">max_connect_errors</span><span class="token operator">=</span><span class="token number">10</span>
<span class="token comment"># 服务端使用的字符集默认为UTF8</span>
character-set-server<span class="token operator">=</span>utf8
<span class="token comment"># 创建新表时将使用的默认存储引擎</span>
default-storage-engine<span class="token operator">=</span>INNODB
<span class="token comment"># 默认使用“mysql_native_password”插件认证</span>
<span class="token comment">#mysql_native_password</span>
<span class="token assign-left variable">default_authentication_plugin</span><span class="token operator">=</span>mysql_native_password
</code></pre> 
<hr> 
<h2><a id="Mysql_mysql57__78"></a>三、拉取Mysql镜像（ mysql5.7版本 ）</h2> 
<p><code>命令： docker pull mysql:5.7.43</code></p> 
<h4><a id="_81"></a>启动主库</h4> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run  <span class="token parameter variable">--privileged</span> <span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token parameter variable">--name</span> mysql-master <span class="token parameter variable">-v</span> /home/mysql/master/conf:/etc/mysql/conf.d <span class="token parameter variable">-v</span> /home/mysql/master/data:/var/lib/mysql <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token parameter variable">-d</span> docker.io/mysql:5.7.43
</code></pre> 
<h4><a id="_86"></a>启动从库</h4> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run  <span class="token parameter variable">--privileged</span> <span class="token parameter variable">-p</span> <span class="token number">3307</span>:3306 <span class="token parameter variable">--name</span> mysql-slave <span class="token parameter variable">-v</span> /home/mysql/slave/conf:/etc/mysql/conf.d <span class="token parameter variable">-v</span> /home/mysql/slave/data:/var/lib/mysql <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token parameter variable">-d</span> docker.io/mysql:5.7.43
</code></pre> 
<h4><a id="IP_92"></a>获取容器IP</h4> 
<p><code>因为是通过Docker容器启动的，创建用户时需要指定从库ip</code></p> 
<pre><code class="prism language-bash"><span class="token comment"># 获取当前所有Docker容器的名称和IP地址</span>
<span class="token function">docker</span> inspect <span class="token parameter variable">--format</span><span class="token operator">=</span><span class="token string">'{<!-- -->{.Name}} - {<!-- -->{range .NetworkSettings.Networks}}{<!-- -->{.IPAddress}}{<!-- -->{end}}'</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-aq</span><span class="token variable">)</span></span>
</code></pre> 
<p><img src="https://images2.imgbox.com/55/53/bg3EXAOM_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_101"></a>【主库配置】</h4> 
<p><strong>1、进入主库容器并在主库上创建一个从库用来读取数据的账号</strong></p> 
<pre><code class="prism language-bash"><span class="token comment"># 进入容器</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mysql-master /bin/bash
</code></pre> 
<p><strong>2、创建用户</strong></p> 
<pre><code class="prism language-bash"><span class="token comment"># 登录mysql</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
Enter password: <span class="token number">123456</span>（此处输入密码是看不见的，回车即可）
<span class="token comment"># 创建用户并授予复制从库的权限</span>
GRANT REPLICATION SLAVE ON *.* to <span class="token string">'mysql_user'</span>@<span class="token string">'172.17.0.4'</span> identified by <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token comment"># 刷新MySQL数据库的权限表，使最近的更改生效</span>
flush privileges<span class="token punctuation">;</span>
</code></pre> 
<p><strong>3、查看当前主服务器（master server）的复制状态信息</strong><br> <code>File 和 Position列的值在从库配置需要</code></p> 
<pre><code class="prism language-bash">show master status<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/82/3c/d6UxnY8F_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p><strong>File</strong>：正在使用的二进制日志文件的名称。<br> <strong>Position</strong>：当前正在写入的二进制日志文件的位置。<br> <strong>Binlog_Do_DB</strong>：当前正在写入的二进制日志文件的位置。<br> <strong>Binlog_Ignore_DB</strong>：忽略复制的数据库列表，这些数据库的更改将不会被复制。</p> 
</blockquote> 
<p><strong>操作完成后退出主库容器。</strong></p> 
<h4><a id="_132"></a>【从库配置】</h4> 
<p><strong>1、进入容器</strong></p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mysql-slave /bin/bash
</code></pre> 
<p><strong>2、登录mysql</strong></p> 
<pre><code class="prism language-bash"><span class="token comment"># 登录mysql</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>
Enter password: <span class="token number">123456</span>（此处输入密码是看不见的，回车即可）
</code></pre> 
<p><strong>3、配置从服务器连接到主服务器进行复制</strong></p> 
<pre><code class="prism language-bash">CHANGE MASTER TO
<span class="token assign-left variable">MASTER_HOST</span><span class="token operator">=</span><span class="token string">'172.17.0.2'</span>,
<span class="token assign-left variable">MASTER_USER</span><span class="token operator">=</span><span class="token string">'mysql_user'</span>,
<span class="token assign-left variable">MASTER_PASSWORD</span><span class="token operator">=</span><span class="token string">'123456'</span>,
<span class="token assign-left variable">MASTER_LOG_FILE</span><span class="token operator">=</span><span class="token string">'master-bin.000001'</span>,
<span class="token assign-left variable">MASTER_LOG_POS</span><span class="token operator">=</span><span class="token number">604</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p><strong>MASTER_HOST=‘172.17.0.2’</strong>：设置主服务器的IP地址为 ‘172.17.0.2’。从服务器将连接到该地址的主服务器。<br> <strong>MASTER_USER=‘mysql_user’：</strong> 指定用于连接主服务器的用户名为 ‘mysql_user’。从服务器将使用该用户名进行连接。<br> <strong>MASTER_PASSWORD=‘123456’</strong>：指定连接主服务器时使用的密码为 ‘123456’。从服务器将使用该密码进行连接验证。<br> <strong>MASTER_LOG_FILE=‘master-bin.000001’：</strong> 设置主服务器正在写入的二进制日志文件名为 ‘master-bin.000001’。从服务器将从该日志文件开始复制。<br> <strong>MASTER_LOG_FILE=‘master-bin.000001’</strong>：设置主服务器正在写入的二进制日志文件名为 ‘master-bin.000001’。从服务器将从该日志文件开始复制。</p> 
</blockquote> 
<p><strong>4、开启主从同步</strong></p> 
<pre><code class="prism language-bash"><span class="token comment"># 开启主从同步</span>
start slave<span class="token punctuation">;</span>
</code></pre> 
<p>出现异常：ERROR 1872 (HY000): Slave failed to initialize relay log info structure from the repository<br> 则重置配置，然后再执行上方命令：</p> 
<pre><code class="prism language-bash">reset slave<span class="token punctuation">;</span>
</code></pre> 
<p><strong>5、校验是否开启</strong><br> Slave_IO_Running: Yes<br> Slave_SQL_Running: Yes<br> <code>以上两个状态为Yes时标识成功</code><br> <img src="https://images2.imgbox.com/c3/3d/BiR5OMXi_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_176"></a>四、测试</h4> 
<p><strong>主库（3306端口）</strong><br> <strong>从库（3307端口）</strong><br> <strong>用工具连接主从服务</strong><br> <img src="https://images2.imgbox.com/20/c8/ah6VqWKS_o.png" alt="在这里插入图片描述"><br> <strong>在主库创建一个test数据库，从库会同步更新操作</strong><br> <code>3307端口从库进行刷新操作，发现同步test数据库</code></p> 
<p><img src="https://images2.imgbox.com/6c/89/j8b8mTqC_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h2><a id="_187"></a>结束</h2>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/07a482430da1f27246cf227a5a9d485f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Postman通用接口加密解决方案</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/60c63408df1a1bfb12bc096450a4a389/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ART-Pi程序下载</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>