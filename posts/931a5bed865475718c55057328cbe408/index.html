<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Springcloud 网关篇-Gateway断言工厂和过滤器详讲及跨域问题配置 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Springcloud 网关篇-Gateway断言工厂和过滤器详讲及跨域问题配置" />
<meta property="og:description" content="Springcloud -网关篇Gateway断言工厂和过滤器详讲及跨域问题配置 3.3 路由断言工厂Route Predicate Factory 3.3.1 Spring提供的十一种基本的Predicate工厂（可查阅官方文档，无需死记硬背） 3.3.2 以After为例演示断言工厂 配置orderservice的路由断言，After即在规定的时候才可访问
- id: order-service #路由id 可自定义但要保证唯一性 uri: lb://orderservice #路由的目标地址 predicates: #判断请求是否符合路由规则的条件 - Path=/order/** - After=2031-04-13T15:14:47.433&#43;08:00[Asia/Shanghai] 设置断言工厂之后，不符合断言规则，通过网关访问orderservice报404
将After设置为before即可成功访问
Before=2031-04-13T15:14:47.433&#43;08:00[Asia/Shanghai] 3.4 路由过滤器GatewayFilter 3.4.1 用户在请求网关服务时候，先进入路由，再经过一系列过滤器链（如图所示） 3.4.2 以AddRequestHeader 为例演示 给所有进入userservice的请求添加一个请求头：Springcloud 666
1.在gateway中修改application.yml文件，给userservice的路由添加过滤器
- id: user-service #路由id 可自定义但要保证唯一性 uri: lb://userservice #路由的目标地址 predicates: #判断请求是否符合路由规则的条件 - Path=/user/** filters: - AddRequestHeader=Truth,springcloud 666 2.springmvc获取请求头
@GetMapping(&#34;/{id}&#34;) public User queryById(@PathVariable(&#34;id&#34;) Long id , @RequestHeader (value = &#34;Truth&#34;,required = false)String truth) { System." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/931a5bed865475718c55057328cbe408/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-21T20:46:02+08:00" />
<meta property="article:modified_time" content="2023-04-21T20:46:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Springcloud 网关篇-Gateway断言工厂和过滤器详讲及跨域问题配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Springcloud_Gateway_1"></a>Springcloud -网关篇Gateway断言工厂和过滤器详讲及跨域问题配置</h2> 
<h3><a id="33_Route_Predicate_Factory_4"></a>3.3 路由断言工厂Route Predicate Factory</h3> 
<h5><a id="331_SpringPredicate_6"></a>3.3.1 Spring提供的十一种基本的Predicate工厂（可查阅官方文档，无需死记硬背）</h5> 
<p><img src="https://images2.imgbox.com/ce/38/cqVhQZnK_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="332__After_11"></a>3.3.2 以After为例演示断言工厂</h5> 
<p><strong>配置orderservice的路由断言，After即在规定的时候才可访问</strong></p> 
<pre><code class="prism language-yml"><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service <span class="token comment">#路由id 可自定义但要保证唯一性</span>
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//orderservice <span class="token comment">#路由的目标地址</span>
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment">#判断请求是否符合路由规则的条件</span>
    <span class="token punctuation">-</span> Path=/order/**
    <span class="token punctuation">-</span> After=2031<span class="token punctuation">-</span>04<span class="token punctuation">-</span>13T15<span class="token punctuation">:</span>14<span class="token punctuation">:</span>47.433+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
</code></pre> 
<p><strong>设置断言工厂之后，不符合断言规则，通过网关访问orderservice报404</strong><br> <img src="https://images2.imgbox.com/db/16/rn5rh0k2_o.png" alt="在这里插入图片描述"></p> 
<p><strong>将After设置为before即可成功访问</strong></p> 
<pre><code class="prism language-yml">Before=2031<span class="token punctuation">-</span>04<span class="token punctuation">-</span>13T15<span class="token punctuation">:</span>14<span class="token punctuation">:</span>47.433+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/37/05/MKM9ehK1_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="34_GatewayFilter_36"></a>3.4 路由过滤器GatewayFilter</h4> 
<h5><a id="341__38"></a>3.4.1 用户在请求网关服务时候，先进入路由，再经过一系列过滤器链（如图所示）</h5> 
<p><img src="https://images2.imgbox.com/11/e2/hIJ83D5Y_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="342_AddRequestHeader__43"></a>3.4.2 以AddRequestHeader 为例演示</h5> 
<p><strong>给所有进入userservice的请求添加一个请求头：Springcloud 666</strong></p> 
<p><strong>1.在gateway中修改application.yml文件，给userservice的路由添加过滤器</strong></p> 
<pre><code class="prism language-yml"><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service <span class="token comment">#路由id 可自定义但要保证唯一性</span>
  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment">#路由的目标地址</span>
  <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment">#判断请求是否符合路由规则的条件</span>
   <span class="token punctuation">-</span> Path=/user/**
  <span class="token key atrule">filters</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> AddRequestHeader=Truth<span class="token punctuation">,</span>springcloud 666
</code></pre> 
<p><strong>2.springmvc获取请求头</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> User <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> Long id <span class="token punctuation">,</span>
                      <span class="token annotation punctuation">@RequestHeader</span> <span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"Truth"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>String truth<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>truth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">queryById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>3.成功获取请求头</strong></p> 
<p><img src="https://images2.imgbox.com/e1/6c/kheJvtjR_o.png" alt="在这里插入图片描述"></p> 
<p><strong>4.给所有微服务配置相同的过滤器，可采用default-filters(注意此时已经将先前的过滤器注释了)</strong></p> 
<pre><code class="prism language-yml">  <span class="token key atrule">routes</span><span class="token punctuation">:</span> <span class="token comment">#网关的路由配置</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service <span class="token comment">#路由id 可自定义但要保证唯一性</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//userservice <span class="token comment">#路由的目标地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment">#判断请求是否符合路由规则的条件</span>
           <span class="token punctuation">-</span> Path=/user/**
<span class="token comment">#          filters:</span>
<span class="token comment">#            - AddRequestHeader=Truth,springcloud 666</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service <span class="token comment">#路由id 可自定义但要保证唯一性</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//orderservice <span class="token comment">#路由的目标地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> <span class="token comment">#判断请求是否符合路由规则的条件</span>
            <span class="token punctuation">-</span> Path=/order/**
            <span class="token punctuation">-</span> Before=2031<span class="token punctuation">-</span>04<span class="token punctuation">-</span>13T15<span class="token punctuation">:</span>14<span class="token punctuation">:</span>47.433+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
      <span class="token key atrule">default-filters</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> AddRequestHeader=Truth<span class="token punctuation">,</span>springcloud 666!
</code></pre> 
<p><strong>5.仍能成功获取请求头，说明默认过滤器也生效</strong></p> 
<p><img src="https://images2.imgbox.com/01/7b/ZsfN3BPj_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="343_GlobalFilter_97"></a>3.4.3 全局过滤器GlobalFilter</h5> 
<p><strong>1.全局过滤器的作用也是处理一切进入网关的请求和微服务响应，与GatewayFilter的作用相同，但两者之间也有区别，区别在于</strong></p> 
<p><strong>GatewayFilter通过配置文件的方式来定义，适合处理一些逻辑固定的响应，而GlobalFilter的逻辑需要自己写代码实现，比较灵活</strong></p> 
<p><strong>2.自定义方式，通过实现GlobalFilter 接口来实现全局过滤器实现一个简单的登录认证</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizeFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Mono<span class="token generics function"><span class="token punctuation">&lt;</span>Void<span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span>ServerWebExchange exchange<span class="token punctuation">,</span> GatewayFilterChain chain<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取请求参数</span>
        ServerHttpRequest request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MultiValueMap<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> queryParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取参数中的authorization参数</span>
        String authorization <span class="token operator">=</span> queryParams<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">"authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断参数值是否等于admin</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//是就放行</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//设置响应状态码401表示用户未登录</span>
        exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span>HttpStatus<span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//拦截</span>
        <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>3.当没有请求参数时，报了401状态码，表示未登录</strong></p> 
<p><img src="https://images2.imgbox.com/8f/fc/mdhQEyOs_o.png" alt="在这里插入图片描述"></p> 
<p><strong>4.有请求参数时，成功获取数据</strong></p> 
<p><img src="https://images2.imgbox.com/fc/9d/BgpWihTR_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="344__140"></a>3.4.4 过滤器的执行顺序</h5> 
<h6><a id="3441_142"></a>3.4.4.1路由过滤器的类型</h6> 
<p><strong>请求进入网关会碰到三类过滤器分别是：当前路由的过滤器、DefaultFilter、GlobalFilter</strong></p> 
<p><strong>请求路由后，会将当前路由过滤器和DefaultFilter、GlobalFilter，合并到一个过滤器链（即集合）中，排序后依次执行每个过滤器</strong></p> 
<p><img src="https://images2.imgbox.com/84/dc/XCnP5Ou1_o.png" alt="在这里插入图片描述"></p> 
<p>3.4.4.2执行顺序</p> 
<p><strong>每一个过滤器都必须指定一个int类型的order值，order值越小，优先级越高，执行顺序越靠前。</strong></p> 
<p><strong>GlobalFilter通过实现Ordered接口，或者添加@Order注解来指定order值，由我们自己指定</strong></p> 
<p><strong>路由过滤器和defaultFilter的order由Spring指定，默认是按照声明顺序从1递增。</strong></p> 
<p><strong>当过滤器的order值一样时，会按照 defaultFilter &gt; 路由过滤器 &gt; GlobalFilter的顺序执行。</strong></p> 
<h4><a id="35__160"></a>3.5 跨域问题解决</h4> 
<h5><a id="351_162"></a>3.5.1跨域的定义</h5> 
<p><strong>域名不一致就是跨域，主要包括：</strong></p> 
<p><strong>域名不同： www.taobao.com 和 www.taobao.org 和 www.jd.com 和 miaosha.jd.com</strong></p> 
<p><strong>域名相同，端口不同：localhost:8080和localhost8081</strong></p> 
<p><strong>跨域问题：浏览器禁止请求的发起者与服务端发生跨域ajax请求，请求被浏览器拦截的问题</strong></p> 
<p><strong>（注意此时浏览器的ajax请求是正常发送到服务端，但服务端未能给出响应）</strong></p> 
<p><strong>解决方案：CORS配置</strong></p> 
<pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span> <span class="token comment"># 全局的跨域处理</span>
        <span class="token key atrule">add-to-simple-url-handler-mapping</span><span class="token punctuation">:</span> <span class="token boolean important">true </span><span class="token comment"># 解决options请求被拦截问题</span>
        <span class="token key atrule">corsConfigurations</span><span class="token punctuation">:</span>
          '<span class="token punctuation">[</span>/**<span class="token punctuation">]</span>'<span class="token punctuation">:</span>
            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span> <span class="token comment"># 允许哪些网站的跨域请求</span>
              <span class="token punctuation">-</span> <span class="token string">"http://localhost:8090"</span>
              <span class="token punctuation">-</span> <span class="token string">"http://www.leyou.com"</span>
            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span> <span class="token comment"># 允许的跨域ajax的请求方式</span>
              <span class="token punctuation">-</span> <span class="token string">"GET"</span>
              <span class="token punctuation">-</span> <span class="token string">"POST"</span>
              <span class="token punctuation">-</span> <span class="token string">"DELETE"</span>
              <span class="token punctuation">-</span> <span class="token string">"PUT"</span>
              <span class="token punctuation">-</span> <span class="token string">"OPTIONS"</span>
            <span class="token key atrule">allowedHeaders</span><span class="token punctuation">:</span> "*" <span class="token comment"># 允许在请求中携带的头信息</span>
            <span class="token key atrule">allowCredentials</span><span class="token punctuation">:</span> <span class="token boolean important">true </span><span class="token comment"># 是否允许携带cookie</span>
            <span class="token key atrule">maxAge</span><span class="token punctuation">:</span> <span class="token number">360000 </span><span class="token comment"># 这次跨域检测的有效期</span>

</code></pre> 
<pre><code>




















































</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ea7b458b74189908a4373edbbe2e2abc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">openEuler-linux下部署zabbix-超级详细</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5e2fd06850392bfd04f985fc476bd88e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">（一）hadoop的安装</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>