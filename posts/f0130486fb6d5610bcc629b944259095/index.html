<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ClickHouse常见问题排查与解决（一） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ClickHouse常见问题排查与解决（一）" />
<meta property="og:description" content="文章目录 1、Table is in readonly mode (zookeeper path: /clickhouse/tables/iov/t_fault/2)2、Replica /clickhouse/tables/s1/dwd/xxxx/replicas/dt_fault already exists3、数据写入成功，但是数据库并不存在数据4、查询时（非MergeTree表引擎），查出多条重复数据 1、Table is in readonly mode (zookeeper path: /clickhouse/tables/iov/t_fault/2) 异常说明
表示Zookeeper压力过大，表处于只读状态，导致插入失败
分析问题
Zookeeper压力过大原因分析：
写入数据以及频率过高集群中出现Zookeeper节点挂掉，导致压力过大 解决方案：
在zookeeper中将dataLogDir存放目录应该与dataDir分开，可单独采用一套存储设备来存放ZK日志。做好zookeeper集群和clickhouse集群的规划，可以多套zookeeper集群服务一套clickhouse集群。保证Zookeeper集群高可用 2、Replica /clickhouse/tables/s1/dwd/xxxx/replicas/dt_fault already exists 异常说明
删除表 ZK replicas未同步
分析问题
表的元信息会保存到Zookeeper节点上，删除副本以及本地表后，客户端未显示表，但是Zookeeper中的元信息未同步删除，即会出现异常。
解决方案
删除本地表后等待若干时间（根据经验得大概5分钟），再删除副本（分布式表）可以登录ClickHouse服务器进行删除 3、数据写入成功，但是数据库并不存在数据 问题说明
表引擎是MergeTree或者ReplicateMergeTree，所以不存在数据被合并掉。
order by字段包括四个，并且时间在中间，比如：id,name,time,type
分析问题
根据Arthas（是一个Java诊断工具，由阿里巴巴中间件团队开源。它在开发人员中被广泛采用和流行。）一些手段查询到方法的入参以及方法栈的执行情况得知，数据确实入库。
比如同一时刻入参有三条数据进行入库，查询表只有两条数据。
第一种猜测
数据重复导致ClickHouse对重复数据进行幂等性操作，进而把重复数据删除。或者会被ClickH忽略掉此次insert
大概意思是说已经有一个一模一样的数据块了。另外ck没有事务概念，但是为了保证重复插入的insert的幂等性，会检测重复，如果重复则跳过。 本地测验重复数据会部分保留在数据库，部分被删除。 - 第二种猜测 怀疑order by排序字段位置不合理 解决方案 如果想保存重复数据，两种解决办法
关闭幂等性校验。SET insert_deduplicate=0增加一个或者多个冗余字段，保证每条数据不相同 创建表时，order by字段是必须的，但是合理安排order by字段，时间放在所有字段的后边
比如：name,code,type,time等。
4、查询时（非MergeTree表引擎），查出多条重复数据 问题说明
表引擎为：ReplicatedReplacingMergeTree
select * from A join B A." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f0130486fb6d5610bcc629b944259095/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-24T16:36:43+08:00" />
<meta property="article:modified_time" content="2022-02-24T16:36:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ClickHouse常见问题排查与解决（一）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/30/b2/JYSe13h7_o.png" alt=""></p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1Table_is_in_readonly_mode_zookeeper_path_clickhousetablesiovt_fault2_4" rel="nofollow">1、Table is in readonly mode (zookeeper path: /clickhouse/tables/iov/t_fault/2)</a></li><li><a href="#2Replica_clickhousetabless1dwdxxxxreplicasdt_fault_already_exists_20" rel="nofollow">2、Replica /clickhouse/tables/s1/dwd/xxxx/replicas/dt_fault already exists</a></li><li><a href="#3_34" rel="nofollow">3、数据写入成功，但是数据库并不存在数据</a></li><li><a href="#4MergeTree_71" rel="nofollow">4、查询时（非MergeTree表引擎），查出多条重复数据</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1Table_is_in_readonly_mode_zookeeper_path_clickhousetablesiovt_fault2_4"></a>1、Table is in readonly mode (zookeeper path: /clickhouse/tables/iov/t_fault/2)</h2> 
<ul><li> <p>异常说明</p> <p>表示Zookeeper压力过大，表处于只读状态，导致插入失败</p> </li><li> <p>分析问题</p> <p>Zookeeper压力过大原因分析：</p> 
  <ul><li>写入数据以及频率过高</li><li>集群中出现Zookeeper节点挂掉，导致压力过大</li></ul> </li><li> <p>解决方案：</p> 
  <ul><li>在zookeeper中将dataLogDir存放目录应该与dataDir分开，可单独采用一套存储设备来存放ZK日志。</li><li>做好zookeeper集群和clickhouse集群的规划，可以多套zookeeper集群服务一套clickhouse集群。保证Zookeeper集群高可用</li></ul> </li></ul> 
<h2><a id="2Replica_clickhousetabless1dwdxxxxreplicasdt_fault_already_exists_20"></a>2、Replica /clickhouse/tables/s1/dwd/xxxx/replicas/dt_fault already exists</h2> 
<ul><li> <p>异常说明</p> <p>删除表 ZK replicas未同步</p> </li><li> <p>分析问题</p> <p>表的元信息会保存到Zookeeper节点上，删除副本以及本地表后，客户端未显示表，但是Zookeeper中的元信息未同步删除，即会出现异常。</p> </li><li> <p>解决方案</p> 
  <ul><li>删除本地表后等待若干时间（根据经验得大概5分钟），再删除副本（分布式表）</li><li>可以登录ClickHouse服务器进行删除</li></ul> </li></ul> 
<h2><a id="3_34"></a>3、数据写入成功，但是数据库并不存在数据</h2> 
<ul><li> <p>问题说明</p> <p>表引擎是MergeTree或者ReplicateMergeTree，所以不存在数据被合并掉。</p> <p>order by字段包括四个，并且时间在中间，比如：id,name,time,type</p> </li><li> <p>分析问题</p> <p>根据Arthas（是一个Java诊断工具，由阿里巴巴中间件团队开源。它在开发人员中被广泛采用和流行。）一些手段查询到方法的入参以及方法栈的执行情况得知，数据确实入库。</p> <p>比如同一时刻入参有三条数据进行入库，查询表只有两条数据。</p> 
  <ul><li> <p>第一种猜测</p> <p>数据重复导致ClickHouse对重复数据进行幂等性操作，进而把重复数据删除。或者会被ClickH忽略掉此次insert</p> </li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/86/31/ByMWrNJf_o.png" alt="在这里插入图片描述"></p> 
<pre><code>    大概意思是说已经有一个一模一样的数据块了。另外ck没有事务概念，但是为了保证重复插入的insert的幂等性，会检测重复，如果重复则跳过。
    
    本地测验重复数据会部分保留在数据库，部分被删除。
    
- 第二种猜测
    
    怀疑order by排序字段位置不合理
</code></pre> 
<ul><li>解决方案 
  <ol><li> <p>如果想保存重复数据，两种解决办法</p> 
    <ol><li>关闭幂等性校验。SET insert_deduplicate=0</li><li>增加一个或者多个冗余字段，保证每条数据不相同</li></ol> </li><li> <p>创建表时，order by字段是必须的，但是合理安排order by字段，时间放在所有字段的后边</p> <p>比如：name,code,type,time等。</p> </li></ol> </li></ul> 
<h2><a id="4MergeTree_71"></a>4、查询时（非MergeTree表引擎），查出多条重复数据</h2> 
<ul><li> <p>问题说明</p> <p>表引擎为：ReplicatedReplacingMergeTree</p> <p>select * from A join B A.id=B.id</p> </li><li> <p>分析问题</p> <p>表引擎ReplacingMergeTree一个特性就是：去重；但是不保证过程的数据一致性，只能保证数据最终的一致性。如果数据出现更新的话，查询的时候可能会查询出来多条重复数据。</p> </li><li> <p>解决方案</p> </li></ul> 
<p>查询数据时，在表名后边加上关键字<code>final</code> ，保证数据唯一性。</p> 
<p><img src="https://images2.imgbox.com/35/7d/ebyTseEL_o.png" alt="在这里插入图片描述"><br> <a href="https://cuizb.top/myblog/article/1642654909" rel="nofollow">JVM内存泄漏和内存溢出的原因</a><br> <a href="https://cuizb.top/myblog/article/1642656309" rel="nofollow">JVM常用监控工具解释以及使用</a><br> <a href="https://cuizb.top/myblog/article/1641991849" rel="nofollow">Redis 常见面试题（一）</a><br> <a href="https://cuizb.top/myblog/article/1640446661" rel="nofollow">ClickHouse之MaterializeMySQL引擎（十）</a><br> <a href="https://cuizb.top/myblog/article/1638283998" rel="nofollow">三种实现分布式锁的实现与区别</a><br> <a href="https://cuizb.top/myblog/article/1638890023" rel="nofollow">线程池的理解以及使用</a></p> 
<p><strong>号外！号外！</strong></p> 
<p><em>最近面试BAT，整理一份面试资料，覆盖了Java核心技术、JVM、Java并发、SSM、微服务、数据库、数据结构等等。想获取吗？如果你想提升自己，并且想和优秀的人一起进步，感兴趣的朋友，可以在扫码关注下方公众号。资料在公众号里静静的躺着呢。。。</em></p> 
<p><img src="https://images2.imgbox.com/0c/01/XTWO3hcT_o.png" alt=""></p> 
<ul><li><strong>喜欢就收藏</strong></li><li><strong>认同就点赞</strong></li><li><strong>支持就关注</strong></li><li><strong>疑问就评论</strong></li></ul> 
<p><strong>一键四连，你的offer也四连</strong></p> 
<p>————————————————————————————————————————————————————————————————</p> 
<blockquote> 
 <p>本文作者：Java技术债务<br> 原文链接：<a href="https://www.cuizb.top/myblog/article/1645691702" rel="nofollow">https://www.cuizb.top/myblog/article/1645691702</a><br> 版权声明： 本博客所有文章除特别声明外，均采用 CC BY 3.0 CN协议进行许可。转载请署名作者且注明文章出处。</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e47546fa1b5414710077106e95daccff/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【机器视觉】基础知识---相机篇</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3fbc95ec8900c8de77eb381f9f8152e4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">STM32F103 实例应用（3.1）——GPIO(增加深度)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>