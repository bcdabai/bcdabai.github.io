<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux服务启动报：Address already in use 解决方法：预留端口避免占用ip_local_reserved_ports - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux服务启动报：Address already in use 解决方法：预留端口避免占用ip_local_reserved_ports" />
<meta property="og:description" content="问题描述： 业务遇到这个情况，在重启服务时，出现50020端口被占用而无法启动，
非得等该端口释放后才启动成功。
问题分析： 50020端口被该服务器上的客户端 随机选取源端口给占用掉了。
解决方案： 使用net.ipv4.ip_local_port_range参数，规划出一段端口段预留作为服务的端口，
这种方法是可以解决当前问题，但是会有个问题，端口使用量减少了，
当服务器需要消耗大量的端口号的话，比如反代服务器，就存在瓶颈了。 最好的做法是将服务监听的端口以逗号分隔全部添加到ip_local_reserved_ports中，
TCP/IP协议栈从ip_local_port_range中随机选取源端口时，
会排除ip_local_reserved_ports中定义的端口，
因此就不会出现端口被占用了服务无法启动。
ip_local_reserved_ports解释如下： ip_local_reserved_ports - list of comma separated ranges Specify the ports which are reserved for known third-party applications. These ports will not be used by automatic port assignments (e.g. when calling connect() or bind() with port number 0). Explicit port allocation behavior is unchanged.
The format used for both input and output is a comma separated list of ranges (e." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/523b78b6a10573add8db5326ab20e171/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-02-25T08:29:45+08:00" />
<meta property="article:modified_time" content="2016-02-25T08:29:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux服务启动报：Address already in use 解决方法：预留端口避免占用ip_local_reserved_ports</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> <span style="border:0px; font-family:inherit; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline">问题描述：</span><br style=""> 业务遇到这个情况，在重启服务时，出现50020端口被占用而无法启动，</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> 非得等该端口释放后才启动成功。</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> <span style="border:0px; font-family:inherit; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline"><br> </span></p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> <span style="border:0px; font-family:inherit; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline">问题分析：</span><br style=""> 50020端口被该服务器上的客户端 随机选取源端口给占用掉了。</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> <br> </p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> <span style="border:0px; font-family:inherit; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline">解决方案：</span><br style=""> 使用net.ipv4.ip_local_port_range参数，规划出一段端口段预留作为服务的端口，</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> 这种方法是可以解决当前问题，但是会有个问题，端口使用量减少了，</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> 当服务器需要消耗大量的端口号的话，比如反代服务器，就存在瓶颈了。<br style=""> <br> </p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> 最好的做法是将服务监听的端口以逗号分隔全部添加到ip_local_reserved_ports中，</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> TCP/IP协议栈从ip_local_port_range中随机选取源端口时，</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> 会排除ip_local_reserved_ports中定义的端口，</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> 因此就不会出现端口被占用了服务无法启动。</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> <br> </p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> ip_local_reserved_ports解释如下：<br style=""> ip_local_reserved_ports - list of comma separated ranges<br style=""> Specify the ports which are reserved for known third-party<br style=""> applications. These ports will not be used by automatic port<br style=""> assignments (e.g. when calling connect() or bind() with port<br style=""> number 0). Explicit port allocation behavior is unchanged.</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> The format used for both input and output is a comma separated<br style=""> list of ranges (e.g. "1,2-4,10-10" for ports 1, 2, 3, 4 and<br style=""> 10). Writing to the file will clear all previously reserved<br style=""> ports and update the current list with the one given in the<br style=""> input.</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> Note that ip_local_port_range and ip_local_reserved_ports<br style=""> settings are independent and both are considered by the kernel<br style=""> when determining which ports are available for automatic port<br style=""> assignments.</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> You can reserve ports which are not in the current<br style=""> ip_local_port_range, e.g.:</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> $ cat /proc/sys/net/ipv4/ip_local_port_range<br style=""> 32000 61000<br style=""> $ cat /proc/sys/net/ipv4/ip_local_reserved_ports<br style=""> 8080,9148</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> although this is redundant. However such a setting is useful<br style=""> if later the port range is changed to a value that will<br style=""> include the reserved ports.</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> Default: Empty<br style=""> https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt</p> 
<div id="crayon-56cdbc75aec61150886541" class="crayon-syntax crayon-theme-visual-assist crayon-font-monaco crayon-os-pc print-yes notranslate" style="font-family:Monaco,MonacoRegular,'Courier New',monospace; margin:12px 0px; outline:0px; padding:0px; vertical-align:baseline; width:718.312px; color:rgb(68,68,68); height:auto; border:1px rgb(48,48,48)!important; overflow:hidden!important; position:relative!important; direction:ltr!important; line-height:15px!important; background:rgb(50,50,50)!important"> 
 <div class="crayon-plain-wrap" style="border:0px; font-style:inherit; outline:0px; vertical-align:baseline; margin:0px!important; padding:0px!important; height:auto!important; background:0px 50%"> 
  <textarea class="crayon-plain print-no" style="color:rgb(0,0,0); width:718.312px; overflow:hidden; padding:0px 5px; margin:0px; height:45px; position:absolute; border-width:0px; border-style:initial; white-space:pre; word-wrap:normal; z-index:0; font-size:12px!important; font-family:Monaco,MonacoRegular,'Courier New',monospace!important; line-height:15px!important"></textarea> 
 </div> 
 <div class="crayon-main" style="border:0px; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; width:718.312px; overflow:hidden; position:relative; z-index:1; background:0px 50%"> 
  <table class="crayon-table    " style="font-size:12px; font-style:inherit; margin-left:-19px; outline:0px; vertical-align:baseline; border:none!important; margin-top:0px!important; margin-right:0px!important; margin-bottom:0px!important; padding:0px!important; border-collapse:collapse!important; border-spacing:0px!important; width:auto!important; table-layout:auto!important; background:none!important"><tbody style="border:0px; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline"><tr class="crayon-row" style="font-style:inherit; outline:0px; border:none!important; margin:0px!important; padding:0px!important; vertical-align:top!important; background:0px 50%"><td class="crayon-nums " style="border-top-width:0px; border-bottom-width:0px; border-left-width:0px; font-style:inherit; outline:0px; border-right-width:1px!important; border-right-style:solid!important; border-right-color:rgb(140,141,143)!important; font-family:Monaco,MonacoRegular,'Courier New',monospace!important; margin:0px!important; padding:0px!important; vertical-align:top!important; color:rgb(194,194,194)!important; background:rgb(48,48,48)!important"> 
      <div class="crayon-nums-content" style="border:0px; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; white-space:nowrap; line-height:15px!important; background:0px 50%"> 
       <div class="crayon-num" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px 5px; vertical-align:baseline; text-align:center; height:inherit; line-height:inherit!important; font-weight:inherit!important; background:0px 50%">
         1 
       </div> 
       <div class="crayon-num crayon-striped-num" style="border:0px; font-family:inherit; font-style:inherit; margin:0px; outline:0px; padding:0px 5px; vertical-align:baseline; text-align:center; height:inherit; font-size:inherit!important; line-height:inherit!important; font-weight:inherit!important; background:rgb(53,53,53)!important">
         2 
       </div> 
       <div class="crayon-num" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px 5px; vertical-align:baseline; text-align:center; height:inherit; line-height:inherit!important; font-weight:inherit!important; background:0px 50%">
         3 
       </div> 
      </div> </td><td class="crayon-code" style="border:0px; font-style:inherit; outline:0px; width:719px; font-family:Monaco,MonacoRegular,'Courier New',monospace!important; margin:0px!important; padding:0px!important; vertical-align:top!important; background:0px 50%"> 
      <div class="crayon-pre" style="font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; white-space:pre; overflow:visible; border:none!important; line-height:15px!important; background:none!important"> 
       <div class="crayon-line" id="crayon-56cdbc75aec61150886541-1" style="border:0px; font-family:inherit; font-style:inherit; margin:0px; outline:0px; padding:0px 5px; vertical-align:baseline; height:inherit; font-size:inherit!important; line-height:inherit!important; font-weight:inherit!important; background:0px 50%"> 
        <span class="crayon-p" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; line-height:inherit!important; font-weight:inherit!important; color:rgb(155,155,139)!important"># vim /etc/sysctl.conf</span> 
       </div> 
       <div class="crayon-line crayon-striped-line" id="crayon-56cdbc75aec61150886541-2" style="border:0px; font-family:inherit; font-style:inherit; margin:0px; outline:0px; padding:0px 5px; vertical-align:baseline; height:inherit; font-size:inherit!important; line-height:inherit!important; font-weight:inherit!important; background:rgb(53,53,53)!important"> 
        <span class="crayon-v" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; line-height:inherit!important; font-weight:inherit!important; color:rgb(189,183,107)!important">net</span> 
        <span class="crayon-sy" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; line-height:inherit!important; font-weight:inherit!important; color:rgb(216,216,216)!important">.</span> 
        <span class="crayon-v" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; line-height:inherit!important; font-weight:inherit!important; color:rgb(189,183,107)!important">ipv4</span> 
        <span class="crayon-sy" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; line-height:inherit!important; font-weight:inherit!important; color:rgb(216,216,216)!important">.</span> 
        <span class="crayon-v" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; line-height:inherit!important; font-weight:inherit!important; color:rgb(189,183,107)!important">ip_local_reserved_ports</span> 
        <span class="crayon-h" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; line-height:inherit!important; font-weight:inherit!important; color:rgb(0,111,224)!important"></span> 
        <span class="crayon-o" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; line-height:inherit!important; font-weight:inherit!important; color:rgb(218,218,218)!important">=</span> 
        <span class="crayon-h" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; line-height:inherit!important; font-weight:inherit!important; color:rgb(0,111,224)!important"></span> 
        <span class="crayon-h" style="border:0px; font-family:inherit; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; font-size:inherit!important; line-height:inherit!important; font-weight:inherit!important"><span style="color:#e7a37a">50020</span></span> 
        <span class="crayon-sy" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; line-height:inherit!important; font-weight:inherit!important; color:rgb(216,216,216)!important">,</span> 
        <span class="crayon-h" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; line-height:inherit!important; font-weight:inherit!important; color:rgb(0,111,224)!important"></span> 
        <span class="crayon-h" style="border:0px; font-family:inherit; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; font-size:inherit!important; line-height:inherit!important; font-weight:inherit!important"><span style="color:#e7a37a">3000</span></span> 
        <span class="crayon-o" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; line-height:inherit!important; font-weight:inherit!important; color:rgb(218,218,218)!important">-</span> 
        <span class="crayon-o" style="border:0px; font-family:inherit; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; font-size:inherit!important; line-height:inherit!important; font-weight:inherit!important"><span style="color:#e7a37a">4000</span></span> 
       </div> 
       <div class="crayon-line" id="crayon-56cdbc75aec61150886541-3" style="border:0px; font-family:inherit; font-style:inherit; margin:0px; outline:0px; padding:0px 5px; vertical-align:baseline; height:inherit; font-size:inherit!important; line-height:inherit!important; font-weight:inherit!important; background:0px 50%"> 
        <span class="crayon-p" style="border:0px; font-family:inherit; font-size:inherit!important; font-style:inherit; margin:0px; outline:0px; padding:0px; vertical-align:baseline; height:inherit; line-height:inherit!important; font-weight:inherit!important; color:rgb(155,155,139)!important"># sysctl -p</span> 
       </div> 
      </div> </td></tr></tbody></table> 
 </div> 
</div> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> [warning]注意：内核版本要大于2.6.18-164，否则不支持该参数。[/warning]</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> <br> </p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> <br> </p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> <br> </p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> refer to： http://www.ttlsa.com/linux/reserved-port-to-avoid-occupying-ip_local_reserved_ports/</p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> <br> </p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> <br> </p> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> </p> 
<h2 class="section" style="font-family:Times"><br> </h2> 
<div>
  please refer to : http://www.tldp.org/LDP/solrhe/Securing-Optimizing-Linux-RH-Edition-v1.3/chap6sec70.html 
</div> 
<p></p> 
<p style="font-family:Times; font-size:14px"></p> 6.7. The ip_local_port_range parameters 
<p style="font-family:Times; font-size:14px">The <tt class="filename">/proc/sys/net/ipv4/ip_local_port_range</tt> defines the local port range that is used by <span class="acronym">TCP</span> and <span class="acronym">UDP</span> traffic to choose the local port. You will see in the parameters of this file two numbers: The first number is the first local port allowed for <span class="acronym">TCP</span> and <span class="acronym">UDP</span> traffic on the server, the second is the last local port number. For high-usage systems you may change its default parameters to 32768-61000 -first-last.</p> 
<p style="font-family:Times; font-size:14px">The default setup for the ip_local_port_range parameters under Red Hat Linux is: <tt class="computeroutput">"1024 4999"</tt></p> 
<div class="mediaobject" style="font-family:Times; font-size:14px"> 
 <p><img src="https://images2.imgbox.com/7b/52/HulEXX42_o.gif" alt="Version 6.1 only"></p> 
</div> 
<span style="font-family:Times; font-size:14px">To change the values of ip_local_port_range, type the following command on your terminal:</span> 
<table border="0" bgcolor="#E0E0E0" width="100%" style="font-family:Times"><tbody><tr><td> <pre class="screen">            [root@deep] /# <span class="command" style="font-weight:bold">echo</span> "32768 61000" &gt;/proc/sys/net/ipv4/ip_local_port_range
            </pre> </td></tr></tbody></table> 
<span style="font-family:Times; font-size:14px">Add the above commands to the </span> 
<tt class="filename">/etc/rc.d/rc.local</tt> 
<span style="font-family:Times; font-size:14px"> script file and you'll not have to type it again the next time you reboot your system.</span> 
<p style="font-family:Times; font-size:14px"></p> 
<p style="font-family:Times; font-size:14px"></p> 
<div class="mediaobject" style="font-family:Times; font-size:14px"> 
 <p><img src="https://images2.imgbox.com/b5/f6/Y6yV2dfw_o.gif" alt="Version 6.2 only"></p> 
</div> 
<span style="font-family:Times; font-size:14px">Edit the </span> 
<tt class="filename">/etc/sysctl.conf</tt> 
<span style="font-family:Times; font-size:14px"> file and add the following line:</span> 
<table border="0" bgcolor="#E0E0E0" width="100%" style="font-family:Times"><tbody><tr><td> <pre class="screen">            # Allowed local port range
            net.ipv4.ip_local_port_range = 32768 61000
            </pre> </td></tr></tbody></table> 
<span style="font-family:Times; font-size:14px"><br> </span> 
<p style="border:0px; font-family:'Microsoft YaHei',Helvetica,Arial,'Lucida Grande',Tahoma,sans-serif; font-size:15px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> <span style="font-family:Times; font-size:14px">You must restart your network for the change to take effect. The command to manually restart the network is the following:</span></p> 
<p style="border:0px; margin-top:0px; margin-bottom:5px; outline:0px; padding-top:0px; padding-bottom:0px; vertical-align:baseline; word-wrap:break-word; color:rgb(68,68,68); line-height:27px"> <span style="font-family:Times; font-size:14px">don't do it in your product environment: <br> </span> </p> 
<table border="0" bgcolor="#E0E0E0" width="100%" style="font-family:Times; font-size:15px"><tbody><tr><td> <pre class="screen">            [root@deep] /# /etc/rc.d/init.d/network <span class="command" style="font-weight:bold">restart</span>
            </pre> </td></tr></tbody></table> 
<p></p> 
<p class="literallayout" style="font-family:Times; font-size:14px"><tt class="computeroutput">Setting network parameters [ OK ] Bringing up interface lo [ OK ] Bringing up interface eth0 [ OK ] Bringing up interface eth1 [ OK ] </tt></p> 
<p class="literallayout" style="font-family:Times; font-size:14px"><tt class="computeroutput">using ： #/sbin/sysctl -p</tt></p> 
<p><br> </p> 
<p><br> </p> 
<p><br> </p> 
<p></p> 
<h2 class="title single-title" style="margin:0px 0px 5px; padding:0px; border:0px; font-style:inherit; font-variant:inherit; font-size:30px; line-height:32px; font-family:Gudea,sans-serif; vertical-align:baseline; color:rgb(85,85,85); float:left"> Linux increase ip_local_port_range TCP port range</h2> 
<div class="tablePost" style="margin:10px 0px 0px; padding:5px 0px 0px; border-width:1px 0px 0px; border-top-style:solid; border-top-color:rgb(226,226,226); font-style:inherit; font-variant:inherit; font-weight:inherit; font-size:undefined; line-height:inherit; font-family:inherit; vertical-align:baseline; width:861.844px; clear:both; color:rgb(153,153,153); text-transform:capitalize">
  Author:  
 <a target="_blank" href="https://ma.ttias.be/author/admin/" rel="author noopener noreferrer" title="Posts by Mattias Geniar" style="">Mattias Geniar</a>  
 <span class="metadate" style="margin:0px; padding:10px; border:0px; font-style:inherit; font-variant:inherit; font-weight:bold; font-size:18px; line-height:24px; font-family:Gudea,sans-serif; vertical-align:baseline; position:absolute; left:-57px; color:rgb(255,255,255); text-align:center; z-index:100; background:rgb(106,190,216)"></span> 
 <div class="post_date" style="margin:0px; padding:0px; border:0px; font-style:inherit; font-variant:inherit; font-weight:inherit; font-size:undefined; line-height:inherit; font-family:inherit; vertical-align:baseline"> 
  <div class="month" style="margin:0px; padding:0px; border:0px; font-style:inherit; font-variant:inherit; font-weight:inherit; font-size:undefined; line-height:inherit; font-family:inherit; vertical-align:baseline">
    Nov 
  </div> 
  <div class="day" style="margin:0px; padding:0px; border:0px; font-style:inherit; font-variant:inherit; font-weight:inherit; font-size:undefined; line-height:inherit; font-family:inherit; vertical-align:baseline">
    02 
  </div> 
  <div class="year" style="margin:0px; padding:0px; border:0px; font-style:inherit; font-variant:inherit; font-weight:inherit; font-size:undefined; line-height:inherit; font-family:inherit; vertical-align:baseline">
    2015 
  </div> 
 </div> 
 <span class="thecomment" style="margin:0px; padding:0px; border:0px; font-style:inherit; font-variant:inherit; font-weight:inherit; font-size:undefined; line-height:inherit; font-family:inherit; vertical-align:baseline"><a target="_blank" href="https://ma.ttias.be/linux-increase-ip_local_port_range-tcp-port-range/#comments" rel="nofollow noopener noreferrer" style=""> 1 Comment</a></span> 
</div> 
<div id="post-7098" class="g post post-7098 type-post status-publish format-standard has-post-thumbnail hentry category-linux tag-linux tag-networking tag-performance tag-tcp cat-845-id has_thumb" style="margin:0px; padding:0px; border:0px; font-style:inherit; font-variant:inherit; font-weight:inherit; font-size:undefined; line-height:inherit; font-family:inherit; vertical-align:baseline"> 
 <div class="post-single-content box mark-links" style="margin:0px; padding:0px; border:0px; font-style:inherit; font-variant:inherit; font-weight:inherit; font-size:undefined; line-height:inherit; font-family:inherit; vertical-align:baseline; overflow:hidden"> 
  <p style="margin-top:0px; margin-bottom:20px; padding-top:0px; padding-bottom:0px; border:0px; font-size:14px; line-height:28px; font-family:'Open Sans',sans-serif; vertical-align:baseline; color:rgb(58,57,57)"> For heavy traffic network servers, like proxy servers or load balancers, you may need to increase the networking port range.<span id="more-7098" style="margin:0px; padding:0px; border:0px; font-style:inherit; font-variant:inherit; font-weight:inherit; font-size:undefined; line-height:inherit; font-family:inherit; vertical-align:baseline"></span></p> 
  <p style="margin-top:0px; margin-bottom:20px; padding-top:0px; padding-bottom:0px; border:0px; font-size:14px; line-height:28px; font-family:'Open Sans',sans-serif; vertical-align:baseline; color:rgb(58,57,57)"> On Linux, there is a sysctl parameter called <code style="margin:0px; padding:0px 8px; border:1px solid rgb(204,204,204); font-size:14px; line-height:normal; font-family:Monaco,Consolas,'Andale Mono','DejaVu Sans Mono',monospace; vertical-align:baseline; color:rgb(221,17,68); background:rgb(238,238,238)">ip_local_port_range</code> that defines the minimum and maximum port a networking connection can use as its source (local) port. This applies to both TCP and UDP connections.</p> 
  <p style="margin-top:0px; margin-bottom:20px; padding-top:0px; padding-bottom:0px; border:0px; font-size:14px; line-height:28px; font-family:'Open Sans',sans-serif; vertical-align:baseline; color:rgb(58,57,57)"> To find out the current IP range, use the following commands:</p> 
  <pre style="">$ cat /proc/sys/net/ipv4/ip_local_port_range
32768	61000
</pre> 
  <p style="margin-top:0px; margin-bottom:20px; padding-top:0px; padding-bottom:0px; border:0px; font-size:14px; line-height:28px; font-family:'Open Sans',sans-serif; vertical-align:baseline; color:rgb(58,57,57)"> or:</p> 
  <pre style="">$ sysctl net.ipv4.ip_local_port_range
net.ipv4.ip_local_port_range = 32768	61000
</pre> 
  <p style="margin-top:0px; margin-bottom:20px; padding-top:0px; padding-bottom:0px; border:0px; font-size:14px; line-height:28px; font-family:'Open Sans',sans-serif; vertical-align:baseline; color:rgb(58,57,57)"> The value is shown as "<span style="margin:0px; padding:0px; border:0px; font-variant:inherit; font-weight:inherit; font-size:undefined; line-height:inherit; font-family:georgia; vertical-align:baseline">minimum maximum</span>" value, so the local port for new connections will be between 32.768 and 61.000, by default that's a 28.232 range of ports. Sounds plenty, but heavy traffic servers can easily reach this limit.</p> 
  <p style="margin-top:0px; margin-bottom:20px; padding-top:0px; padding-bottom:0px; border:0px; font-size:14px; line-height:28px; font-family:'Open Sans',sans-serif; vertical-align:baseline; color:rgb(58,57,57)"> For heavy traffic servers, you can increase the total port range like this.</p> 
  <pre style="">$ sysctl -w net.ipv4.ip_local_port_range="15000 64000"
net.ipv4.ip_local_port_range = 15000 64000
</pre> 
  <p style="margin-top:0px; margin-bottom:20px; padding-top:0px; padding-bottom:0px; border:0px; font-size:14px; line-height:28px; font-family:'Open Sans',sans-serif; vertical-align:baseline; color:rgb(58,57,57)"> Or, by using <code style="margin:0px; padding:0px 8px; border:1px solid rgb(204,204,204); font-size:14px; line-height:normal; font-family:Monaco,Consolas,'Andale Mono','DejaVu Sans Mono',monospace; vertical-align:baseline; color:rgb(221,17,68); background:rgb(238,238,238)">echo</code> to pass a value directly into <code style="margin:0px; padding:0px 8px; border:1px solid rgb(204,204,204); font-size:14px; line-height:normal; font-family:Monaco,Consolas,'Andale Mono','DejaVu Sans Mono',monospace; vertical-align:baseline; color:rgb(221,17,68); background:rgb(238,238,238)">/proc</code>.</p> 
  <pre style="">$ echo 15000 64000 &gt; /proc/sys/net/ipv4/ip_local_port_range</pre> 
  <p style="margin-top:0px; margin-bottom:20px; padding-top:0px; padding-bottom:0px; border:0px; font-size:14px; line-height:28px; font-family:'Open Sans',sans-serif; vertical-align:baseline; color:rgb(58,57,57)"> To make the changes persistent on boot, save your config in either <code style="margin:0px; padding:0px 8px; border:1px solid rgb(204,204,204); font-size:14px; line-height:normal; font-family:Monaco,Consolas,'Andale Mono','DejaVu Sans Mono',monospace; vertical-align:baseline; color:rgb(221,17,68); background:rgb(238,238,238)">/etc/sysctl.conf</code> or in a custom file that gets included in your main configs.</p> 
  <pre style="">$ cat /etc/sysctl.d/net.ipv4.ip_local_port_range.conf
net.ipv4.ip_local_port_range = 15000 65000
</pre> 
  <p style="margin-top:0px; margin-bottom:20px; padding-top:0px; padding-bottom:0px; border:0px; font-size:14px; line-height:28px; font-family:'Open Sans',sans-serif; vertical-align:baseline; color:rgb(58,57,57)"> To find out how many sessions your server is currently handling, use the following commands:</p> 
  <pre style="">$ ss -s
Total: 2933 (kernel 3131)
TCP:   43915 (estab 2655, closed 41080, orphaned 159, synrecv 0, timewait 41080/0), ports 30347

Transport Total     IP        IPv6
*	  3131      -         -
RAW	  0         0         0
UDP	  17        11        6
TCP	  2835      2832      3
INET	  2852      2843      9
FRAG	  0         0         0

$ netstat -anp | more
...
tcp        0      0 10.50.1.6:41205        10.50.1.10:80           TIME_WAIT   -
tcp        0      0 10.50.1.6:42515        10.50.1.10:80           TIME_WAIT   -
tcp        0      0 10.50.1.6:59845        10.50.1.10:80           TIME_WAIT   -
</pre> 
  <p style="margin-top:0px; margin-bottom:20px; padding-top:0px; padding-bottom:0px; border:0px; font-size:14px; line-height:28px; font-family:'Open Sans',sans-serif; vertical-align:baseline; color:rgb(58,57,57)"> Please be careful with increasing the TCP port range though, there are limits!</p> refer to: https://ma.ttias.be/linux-increase-ip_local_port_range-tcp-port-range/ 
 </div> 
</div> 
<br> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2ab6c7d6626490b0c506335f4e952d67/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">java 对象克隆</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/47fff2df9c65c8853439e37d804cb5c5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SQL 判断年份是否为润年</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>