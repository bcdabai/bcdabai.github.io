<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ffmpeg学习 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ffmpeg学习" />
<meta property="og:description" content="ffmpeg初学 ffmpeg ffmpeg 相关原理参考
AVFormatContext：解封装功能的结构体，包含文件名、音视频流、时长、比特率等信息；
AVCodecContext：编解码器上下文，编码和解码时必须用到的结构体，包含编解码器类型、视频宽高、音频通道数和采样率等信息；
AVCodec：存储编解码器信息的结构体；
AVStream：存储音频或视频流信息的结构体；
AVPacket：存储音频或视频编码数据；
AVFrame：存储音频或视频解码数据（原始数据）；
代码参考
#include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;math.h&gt; #include &lt;libavutil/avassert.h&gt; #include &lt;libavutil/channel_layout.h&gt; #include &lt;libavutil/opt.h&gt; #include &lt;libavutil/mathematics.h&gt; #include &lt;libavutil/timestamp.h&gt; #include &lt;libavformat/avformat.h&gt; #include &lt;libswscale/swscale.h&gt; #include &lt;libswresample/swresample.h&gt; #define STREAM_DURATION 50.0 /*录制视频的持续时间 秒*/ #define STREAM_FRAME_RATE 5 /* images/s 这里可以根据摄像头的采集速度来设置帧率 */ #define STREAM_PIX_FMT AV_PIX_FMT_YUV420P /* default pix_fmt */ #define SCALE_FLAGS SWS_BICUBIC //存放视频的宽度和高度 int video_width; int video_height; // 单个输出AVStream的包装器 typedef struct OutputStream { AVStream *st; AVCodecContext *enc; /*下一帧的点数*/ int64_t next_pts; int samples_count; AVFrame *frame; AVFrame *tmp_frame; float t, tincr, tincr2; struct SwsContext *sws_ctx; struct SwrContext *swr_ctx; }OutputStream; typedef struct IntputDev { AVCodecContext *pCodecCtx; AVCodec *pCodec; AVFormatContext *v_ifmtCtx; int videoindex; struct SwsContext *img_convert_ctx; AVPacket *in_packet; AVFrame *pFrame,*pFrameYUV; }IntputDev; static void log_packet(const AVFormatContext *fmt_ctx, const AVPacket *pkt) { AVRational *time_base = &amp;fmt_ctx-&gt;streams[pkt-&gt;stream_index]-&gt;time_base; printf(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/451e5b8d94f3c840f5ebf9fdf0535fbc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-19T13:15:34+08:00" />
<meta property="article:modified_time" content="2022-08-19T13:15:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ffmpeg学习</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>ffmpeg初学</h4> 
 <ul><li><a href="#ffmpeg_1" rel="nofollow">ffmpeg</a></li></ul> 
</div> 
<p></p> 
<h2><a id="ffmpeg_1"></a>ffmpeg</h2> 
<p><a href="https://zhuanlan.zhihu.com/p/486293658" rel="nofollow">相关原理参考</a></p> 
<p>AVFormatContext：解封装功能的结构体，包含文件名、音视频流、时长、比特率等信息；<br> AVCodecContext：编解码器上下文，编码和解码时必须用到的结构体，包含编解码器类型、视频宽高、音频通道数和采样率等信息；<br> AVCodec：存储编解码器信息的结构体；<br> AVStream：存储音频或视频流信息的结构体；<br> AVPacket：存储音频或视频编码数据；<br> AVFrame：存储音频或视频解码数据（原始数据）；<br> <img src="https://images2.imgbox.com/07/ef/WNUMVRNG_o.png" alt="在这里插入图片描述"><br> <a href="https://blog.csdn.net/xiaolong1126626497/article/details/105446774">代码参考</a></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavutil/avassert.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavutil/channel_layout.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavutil/opt.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavutil/mathematics.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavutil/timestamp.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libavformat/avformat.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libswscale/swscale.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;libswresample/swresample.h&gt;</span>  </span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STREAM_DURATION</span>   <span class="token expression"><span class="token number">50.0</span> </span><span class="token comment">/*录制视频的持续时间  秒*/</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STREAM_FRAME_RATE</span> <span class="token expression"><span class="token number">5</span> 	</span><span class="token comment">/* images/s  这里可以根据摄像头的采集速度来设置帧率 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STREAM_PIX_FMT</span>    <span class="token expression">AV_PIX_FMT_YUV420P </span><span class="token comment">/* default pix_fmt */</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCALE_FLAGS</span> <span class="token expression">SWS_BICUBIC  </span></span>
 
<span class="token comment">//存放视频的宽度和高度</span>
<span class="token keyword">int</span> video_width<span class="token punctuation">;</span>
<span class="token keyword">int</span> video_height<span class="token punctuation">;</span>
 
<span class="token comment">// 单个输出AVStream的包装器 </span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">OutputStream</span>
<span class="token punctuation">{<!-- --></span>  
	AVStream <span class="token operator">*</span>st<span class="token punctuation">;</span>  
	AVCodecContext <span class="token operator">*</span>enc<span class="token punctuation">;</span>  
	<span class="token comment">/*下一帧的点数*/</span>  
	<span class="token keyword">int64_t</span> next_pts<span class="token punctuation">;</span>  
	<span class="token keyword">int</span> samples_count<span class="token punctuation">;</span>  
	AVFrame <span class="token operator">*</span>frame<span class="token punctuation">;</span>  
	AVFrame <span class="token operator">*</span>tmp_frame<span class="token punctuation">;</span>  
	<span class="token keyword">float</span> t<span class="token punctuation">,</span> tincr<span class="token punctuation">,</span> tincr2<span class="token punctuation">;</span>  
	<span class="token keyword">struct</span> <span class="token class-name">SwsContext</span> <span class="token operator">*</span>sws_ctx<span class="token punctuation">;</span>  
	<span class="token keyword">struct</span> <span class="token class-name">SwrContext</span> <span class="token operator">*</span>swr_ctx<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>OutputStream<span class="token punctuation">;</span>  
 
 
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">IntputDev</span>
<span class="token punctuation">{<!-- --></span>  
	AVCodecContext  <span class="token operator">*</span>pCodecCtx<span class="token punctuation">;</span>  
	AVCodec         <span class="token operator">*</span>pCodec<span class="token punctuation">;</span>  
	AVFormatContext <span class="token operator">*</span>v_ifmtCtx<span class="token punctuation">;</span>  
	<span class="token keyword">int</span>  videoindex<span class="token punctuation">;</span>  
	<span class="token keyword">struct</span> <span class="token class-name">SwsContext</span> <span class="token operator">*</span>img_convert_ctx<span class="token punctuation">;</span>  
	AVPacket <span class="token operator">*</span>in_packet<span class="token punctuation">;</span>  
	AVFrame <span class="token operator">*</span>pFrame<span class="token punctuation">,</span><span class="token operator">*</span>pFrameYUV<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>IntputDev<span class="token punctuation">;</span>  
 
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">log_packet</span><span class="token punctuation">(</span><span class="token keyword">const</span> AVFormatContext <span class="token operator">*</span>fmt_ctx<span class="token punctuation">,</span> <span class="token keyword">const</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
	AVRational <span class="token operator">*</span>time_base <span class="token operator">=</span> <span class="token operator">&amp;</span>fmt_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>time_base<span class="token punctuation">;</span>  
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pts:%s pts_time:%s dts:%s dts_time:%s duration:%s duration_time:%s stream_index:%d\n"</span><span class="token punctuation">,</span>  
		   <span class="token function">av_ts2str</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">av_ts2timestr</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>pts<span class="token punctuation">,</span> time_base<span class="token punctuation">)</span><span class="token punctuation">,</span>  
		   <span class="token function">av_ts2str</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">av_ts2timestr</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>dts<span class="token punctuation">,</span> time_base<span class="token punctuation">)</span><span class="token punctuation">,</span>  
		   <span class="token function">av_ts2str</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>duration<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">av_ts2timestr</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>duration<span class="token punctuation">,</span> time_base<span class="token punctuation">)</span><span class="token punctuation">,</span>  
		   pkt<span class="token operator">-&gt;</span>stream_index<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
 
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">write_frame</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>fmt_ctx<span class="token punctuation">,</span> <span class="token keyword">const</span> AVRational <span class="token operator">*</span>time_base<span class="token punctuation">,</span> AVStream <span class="token operator">*</span>st<span class="token punctuation">,</span> AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
	<span class="token comment">/* 将输出数据包时间戳值从编解码器重新调整为流时基 */</span>  
	<span class="token function">av_packet_rescale_ts</span><span class="token punctuation">(</span>pkt<span class="token punctuation">,</span> <span class="token operator">*</span>time_base<span class="token punctuation">,</span> st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	pkt<span class="token operator">-&gt;</span>stream_index <span class="token operator">=</span> st<span class="token operator">-&gt;</span>index<span class="token punctuation">;</span>  
 
	<span class="token comment">/*将压缩的帧写入媒体文件。*/</span>  
	<span class="token function">log_packet</span><span class="token punctuation">(</span>fmt_ctx<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">return</span> <span class="token function">av_interleaved_write_frame</span><span class="token punctuation">(</span>fmt_ctx<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
 
<span class="token comment">/*添加输出流。 */</span>  
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add_stream</span><span class="token punctuation">(</span>OutputStream <span class="token operator">*</span>ost<span class="token punctuation">,</span> AVFormatContext <span class="token operator">*</span>oc<span class="token punctuation">,</span>AVCodec <span class="token operator">*</span><span class="token operator">*</span>codec<span class="token punctuation">,</span><span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> codec_id<span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
	AVCodecContext <span class="token operator">*</span>c<span class="token punctuation">;</span>  
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>  
	<span class="token comment">/* find the encoder */</span> 
 
	<span class="token operator">*</span>codec <span class="token operator">=</span> <span class="token function">avcodec_find_encoder</span><span class="token punctuation">(</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not find encoder for '%s'\n"</span><span class="token punctuation">,</span>  
				<span class="token function">avcodec_get_name</span><span class="token punctuation">(</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	ost<span class="token operator">-&gt;</span>st <span class="token operator">=</span> <span class="token function">avformat_new_stream</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ost<span class="token operator">-&gt;</span>st<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not allocate stream\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	ost<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>id <span class="token operator">=</span> oc<span class="token operator">-&gt;</span>nb_streams<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
	c <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not alloc an encoding context\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	ost<span class="token operator">-&gt;</span>enc <span class="token operator">=</span> c<span class="token punctuation">;</span> 	
	<span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token operator">-&gt;</span>type<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token keyword">case</span> AVMEDIA_TYPE_AUDIO<span class="token operator">:</span>  
			c<span class="token operator">-&gt;</span>sample_fmt  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sample_fmts <span class="token operator">?</span>  
				<span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token operator">-&gt;</span>sample_fmts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> AV_SAMPLE_FMT_FLTP<span class="token punctuation">;</span>  
			c<span class="token operator">-&gt;</span>bit_rate    <span class="token operator">=</span> <span class="token number">64000</span><span class="token punctuation">;</span>  
			c<span class="token operator">-&gt;</span>sample_rate <span class="token operator">=</span> <span class="token number">44100</span><span class="token punctuation">;</span>  
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token operator">-&gt;</span>supported_samplerates<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
				c<span class="token operator">-&gt;</span>sample_rate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token operator">-&gt;</span>supported_samplerates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
				<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token operator">-&gt;</span>supported_samplerates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token operator">-&gt;</span>supported_samplerates<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">44100</span><span class="token punctuation">)</span>  
						c<span class="token operator">-&gt;</span>sample_rate <span class="token operator">=</span> <span class="token number">44100</span><span class="token punctuation">;</span>  
				<span class="token punctuation">}</span>  
			<span class="token punctuation">}</span>  
			c<span class="token operator">-&gt;</span>channels        <span class="token operator">=</span> <span class="token function">av_get_channel_layout_nb_channels</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>channel_layout<span class="token punctuation">)</span><span class="token punctuation">;</span>  
			c<span class="token operator">-&gt;</span>channel_layout <span class="token operator">=</span> AV_CH_LAYOUT_STEREO<span class="token punctuation">;</span>  
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token operator">-&gt;</span>channel_layouts<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
				c<span class="token operator">-&gt;</span>channel_layout <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token operator">-&gt;</span>channel_layouts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
				<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token operator">-&gt;</span>channel_layouts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>codec<span class="token punctuation">)</span><span class="token operator">-&gt;</span>channel_layouts<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> AV_CH_LAYOUT_STEREO<span class="token punctuation">)</span>  
						c<span class="token operator">-&gt;</span>channel_layout <span class="token operator">=</span> AV_CH_LAYOUT_STEREO<span class="token punctuation">;</span>  
				<span class="token punctuation">}</span>  
			<span class="token punctuation">}</span>  
			c<span class="token operator">-&gt;</span>channels        <span class="token operator">=</span> <span class="token function">av_get_channel_layout_nb_channels</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>channel_layout<span class="token punctuation">)</span><span class="token punctuation">;</span>  
			ost<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>time_base <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token number">1</span><span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>sample_rate <span class="token punctuation">}</span><span class="token punctuation">;</span>  
			<span class="token keyword">break</span><span class="token punctuation">;</span>  
	  
		<span class="token keyword">case</span> AVMEDIA_TYPE_VIDEO<span class="token operator">:</span>  
			c<span class="token operator">-&gt;</span>codec_id <span class="token operator">=</span> codec_id<span class="token punctuation">;</span>  
			c<span class="token operator">-&gt;</span>bit_rate <span class="token operator">=</span> <span class="token number">2500000</span><span class="token punctuation">;</span>  <span class="token comment">//平均比特率,例子代码默认值是400000</span>
			<span class="token comment">/* 分辨率必须是2的倍数。*/</span>  
			c<span class="token operator">-&gt;</span>width<span class="token operator">=</span>video_width<span class="token punctuation">;</span>  
			c<span class="token operator">-&gt;</span>height<span class="token operator">=</span>video_height<span class="token punctuation">;</span>  
			<span class="token comment">/*时基：这是基本的时间单位（以秒为单位）
			 *表示其中的帧时间戳。 对于固定fps内容，
			 *时基应为1 /framerate，时间戳增量应为
			 *等于1。*/</span>  
			ost<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>time_base <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span>STREAM_FRAME_RATE<span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment">//帧率设置</span>
			c<span class="token operator">-&gt;</span>time_base       <span class="token operator">=</span> ost<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">;</span>  
			c<span class="token operator">-&gt;</span>gop_size      <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token comment">/* 最多每十二帧发射一帧内帧 */</span>  
			c<span class="token operator">-&gt;</span>pix_fmt       <span class="token operator">=</span> STREAM_PIX_FMT<span class="token punctuation">;</span>  
			<span class="token keyword">if</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>codec_id <span class="token operator">==</span> AV_CODEC_ID_MPEG2VIDEO<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>  
				<span class="token comment">/* 只是为了测试，我们还添加了B帧 */</span>  
				c<span class="token operator">-&gt;</span>max_b_frames <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  
			<span class="token punctuation">}</span>  
			<span class="token keyword">if</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>codec_id <span class="token operator">==</span> AV_CODEC_ID_MPEG1VIDEO<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>  
				<span class="token comment">/*需要避免使用其中一些系数溢出的宏块。
				 *普通视频不会发生这种情况，因为
				 *色度平面的运动与亮度平面不匹配。 */</span> 
				c<span class="token operator">-&gt;</span>mb_decision <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  
			<span class="token punctuation">}</span>	
		<span class="token keyword">break</span><span class="token punctuation">;</span>  
	  
		<span class="token keyword">default</span><span class="token operator">:</span>  
			<span class="token keyword">break</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
  
	<span class="token comment">/* 某些格式希望流头分开。 */</span>  
	<span class="token keyword">if</span> <span class="token punctuation">(</span>oc<span class="token operator">-&gt;</span>oformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_GLOBALHEADER<span class="token punctuation">)</span>  
		c<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> AV_CODEC_FLAG_GLOBAL_HEADER<span class="token punctuation">;</span>    
<span class="token punctuation">}</span>  
 
<span class="token keyword">static</span> AVFrame <span class="token operator">*</span><span class="token function">alloc_picture</span><span class="token punctuation">(</span><span class="token keyword">enum</span> <span class="token class-name">AVPixelFormat</span> pix_fmt<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
	AVFrame <span class="token operator">*</span>picture<span class="token punctuation">;</span>  
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>  
	picture <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>picture<span class="token punctuation">)</span>  
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
	picture<span class="token operator">-&gt;</span>format <span class="token operator">=</span> pix_fmt<span class="token punctuation">;</span>  
	picture<span class="token operator">-&gt;</span>width  <span class="token operator">=</span> width<span class="token punctuation">;</span>  
	picture<span class="token operator">-&gt;</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>  
  
	<span class="token comment">/* 为帧数据分配缓冲区 */</span>  
	ret <span class="token operator">=</span> <span class="token function">av_frame_get_buffer</span><span class="token punctuation">(</span>picture<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not allocate frame data.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	<span class="token keyword">return</span> picture<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">open_video</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>oc<span class="token punctuation">,</span> AVCodec <span class="token operator">*</span>codec<span class="token punctuation">,</span> OutputStream <span class="token operator">*</span>ost<span class="token punctuation">,</span> AVDictionary <span class="token operator">*</span>opt_arg<span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>  
	AVCodecContext <span class="token operator">*</span>c <span class="token operator">=</span> ost<span class="token operator">-&gt;</span>enc<span class="token punctuation">;</span>  
	AVDictionary <span class="token operator">*</span>opt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
  
	<span class="token function">av_dict_copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>opt<span class="token punctuation">,</span> opt_arg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
	<span class="token comment">/* open the codec */</span>  
	ret <span class="token operator">=</span> <span class="token function">avcodec_open2</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> codec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>opt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">av_dict_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>opt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not open video codec: %s\n"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
  
	<span class="token comment">/* 分配并初始化可重用框架 */</span>  
	ost<span class="token operator">-&gt;</span>frame <span class="token operator">=</span> <span class="token function">alloc_picture</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ost<span class="token operator">-&gt;</span>frame<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not allocate video frame\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ost-&gt;frame alloc success fmt=%d w=%d h=%d\n"</span><span class="token punctuation">,</span>c<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">,</span>c<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  
	<span class="token comment">/*如果输出格式不是YUV420P，则为临时YUV420P
	*也需要图片。 然后将其转换为所需的
	*输出格式。 */</span>
	ost<span class="token operator">-&gt;</span>tmp_frame <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>pix_fmt <span class="token operator">!=</span> AV_PIX_FMT_YUV420P<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		ost<span class="token operator">-&gt;</span>tmp_frame <span class="token operator">=</span> <span class="token function">alloc_picture</span><span class="token punctuation">(</span>AV_PIX_FMT_YUV420P<span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ost<span class="token operator">-&gt;</span>tmp_frame<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>  
			<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not allocate temporary picture\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token punctuation">}</span>  
	<span class="token punctuation">}</span>  
  
	<span class="token comment">/* 将流参数复制到多路复用器*/</span>  
	ret<span class="token operator">=</span><span class="token function">avcodec_parameters_from_context</span><span class="token punctuation">(</span>ost<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not copy the stream parameters\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
 
<span class="token comment">/*
  *编码一个视频帧
  *编码完成后返回1，否则返回0
  */</span>  
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">write_video_frame</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>oc<span class="token punctuation">,</span> OutputStream <span class="token operator">*</span>ost<span class="token punctuation">,</span>AVFrame <span class="token operator">*</span>frame<span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>  
	AVCodecContext <span class="token operator">*</span>c<span class="token punctuation">;</span>  
	<span class="token keyword">int</span> got_packet<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>  
	AVPacket pkt<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>frame<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>  
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  
	c <span class="token operator">=</span> ost<span class="token operator">-&gt;</span>enc<span class="token punctuation">;</span>  
	<span class="token function">av_init_packet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token comment">/* 编码图像*/</span>  
	ret <span class="token operator">=</span> <span class="token function">avcodec_encode_video2</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> <span class="token operator">&amp;</span>got_packet<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error encoding video frame: %s\n"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"--------------video- pkt.pts=%s\n"</span><span class="token punctuation">,</span><span class="token function">av_ts2str</span><span class="token punctuation">(</span>pkt<span class="token punctuation">.</span>pts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"----st.num=%d st.den=%d codec.num=%d codec.den=%d---------\n"</span><span class="token punctuation">,</span>ost<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>num<span class="token punctuation">,</span>ost<span class="token operator">-&gt;</span>st<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den<span class="token punctuation">,</span>  
			c<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>num<span class="token punctuation">,</span>c<span class="token operator">-&gt;</span>time_base<span class="token punctuation">.</span>den<span class="token punctuation">)</span><span class="token punctuation">;</span>  		
	<span class="token keyword">if</span><span class="token punctuation">(</span>got_packet<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		ret <span class="token operator">=</span> <span class="token function">write_frame</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span> ost<span class="token operator">-&gt;</span>st<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span><span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>  
		ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error while writing video frame: %s\n"</span><span class="token punctuation">,</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	<span class="token keyword">return</span> <span class="token punctuation">(</span>frame <span class="token operator">||</span> got_packet<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
  
<span class="token keyword">static</span> AVFrame <span class="token operator">*</span><span class="token function">get_video_frame</span><span class="token punctuation">(</span>OutputStream <span class="token operator">*</span>ost<span class="token punctuation">,</span>IntputDev<span class="token operator">*</span> input<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>got_pic<span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
	<span class="token keyword">int</span> ret<span class="token punctuation">,</span> got_picture<span class="token punctuation">;</span>  
	AVCodecContext <span class="token operator">*</span>c <span class="token operator">=</span> ost<span class="token operator">-&gt;</span>enc<span class="token punctuation">;</span>  
	AVFrame <span class="token operator">*</span> ret_frame<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">av_compare_ts</span><span class="token punctuation">(</span>ost<span class="token operator">-&gt;</span>next_pts<span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span>STREAM_DURATION<span class="token punctuation">,</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span>  
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
  
	<span class="token comment">/*当我们将帧传递给编码器时，它可能会保留对它的引用
	*内部,确保我们在这里不覆盖它*/</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">av_frame_make_writable</span><span class="token punctuation">(</span>ost<span class="token operator">-&gt;</span>frame<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>  
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">av_read_frame</span><span class="token punctuation">(</span>input<span class="token operator">-&gt;</span>v_ifmtCtx<span class="token punctuation">,</span> input<span class="token operator">-&gt;</span>in_packet<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token keyword">if</span><span class="token punctuation">(</span>input<span class="token operator">-&gt;</span>in_packet<span class="token operator">-&gt;</span>stream_index<span class="token operator">==</span>input<span class="token operator">-&gt;</span>videoindex<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>  
			ret <span class="token operator">=</span> <span class="token function">avcodec_decode_video2</span><span class="token punctuation">(</span>input<span class="token operator">-&gt;</span>pCodecCtx<span class="token punctuation">,</span> input<span class="token operator">-&gt;</span>pFrame<span class="token punctuation">,</span> <span class="token operator">&amp;</span>got_picture<span class="token punctuation">,</span> input<span class="token operator">-&gt;</span>in_packet<span class="token punctuation">)</span><span class="token punctuation">;</span>  
			<span class="token operator">*</span>got_pic<span class="token operator">=</span>got_picture<span class="token punctuation">;</span>  
			<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>  
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Decode Error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
				<span class="token function">av_packet_unref</span><span class="token punctuation">(</span>input<span class="token operator">-&gt;</span>in_packet<span class="token punctuation">)</span><span class="token punctuation">;</span>  
				<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
			<span class="token punctuation">}</span>  
			<span class="token keyword">if</span><span class="token punctuation">(</span>got_picture<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>  
				<span class="token function">sws_scale</span><span class="token punctuation">(</span>input<span class="token operator">-&gt;</span>img_convert_ctx<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span><span class="token operator">*</span><span class="token punctuation">)</span>input<span class="token operator">-&gt;</span>pFrame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> input<span class="token operator">-&gt;</span>pFrame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> input<span class="token operator">-&gt;</span>pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> ost<span class="token operator">-&gt;</span>frame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span>  ost<span class="token operator">-&gt;</span>frame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">)</span><span class="token punctuation">;</span>  
				ost<span class="token operator">-&gt;</span>frame<span class="token operator">-&gt;</span>pts <span class="token operator">=</span>ost<span class="token operator">-&gt;</span>next_pts<span class="token operator">++</span><span class="token punctuation">;</span>  
				ret_frame<span class="token operator">=</span> ost<span class="token operator">-&gt;</span>frame<span class="token punctuation">;</span>    
			<span class="token punctuation">}</span>  
		<span class="token punctuation">}</span>  
		<span class="token function">av_packet_unref</span><span class="token punctuation">(</span>input<span class="token operator">-&gt;</span>in_packet<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	<span class="token keyword">return</span> ret_frame<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">close_stream</span><span class="token punctuation">(</span>AVFormatContext <span class="token operator">*</span>oc<span class="token punctuation">,</span> OutputStream <span class="token operator">*</span>ost<span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
	<span class="token function">avcodec_free_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ost<span class="token operator">-&gt;</span>enc<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ost<span class="token operator">-&gt;</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ost<span class="token operator">-&gt;</span>tmp_frame<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">sws_freeContext</span><span class="token punctuation">(</span>ost<span class="token operator">-&gt;</span>sws_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">swr_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ost<span class="token operator">-&gt;</span>swr_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
 
<span class="token comment">/*
采集摄像头数据编码成MP4视频
*/</span>  
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
	OutputStream video_st <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> audio_st <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">;</span>  
	AVOutputFormat <span class="token operator">*</span>fmt<span class="token punctuation">;</span>  
	AVFormatContext <span class="token operator">*</span>oc<span class="token punctuation">;</span>  
	AVCodec <span class="token operator">*</span>audio_codec<span class="token punctuation">,</span> <span class="token operator">*</span>video_codec<span class="token punctuation">;</span>  
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>  
	<span class="token keyword">int</span> have_video <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> have_audio <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
	<span class="token keyword">int</span> encode_video <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> encode_audio <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
	AVDictionary <span class="token operator">*</span>opt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>  
  
	<span class="token keyword">if</span><span class="token punctuation">(</span>argc<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token comment">//./app /dev/video0 123.mp4</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"用法: %s &lt;摄像头设备节点&gt; &lt;文件名称&gt; \n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
  
	filename <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"当前存储的视频文件名称:%s\n"</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*分配输出媒体环境*/</span>
	<span class="token function">avformat_alloc_output_context2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oc<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>oc<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"无法从文件扩展名推断出输出格式：使用MPEG。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token function">avformat_alloc_output_context2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oc<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"mpeg"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>oc<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  
	<span class="token comment">//添加摄像头----------------------------------</span>
	IntputDev video_input<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  
	AVCodecContext  <span class="token operator">*</span>pCodecCtx<span class="token punctuation">;</span>  
	AVCodec         <span class="token operator">*</span>pCodec<span class="token punctuation">;</span>  
	AVFormatContext <span class="token operator">*</span>v_ifmtCtx<span class="token punctuation">;</span>  
	<span class="token function">avdevice_register_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	v_ifmtCtx <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token comment">//Linux下指定摄像头信息  </span>
	AVInputFormat <span class="token operator">*</span>ifmt<span class="token operator">=</span><span class="token function">av_find_input_format</span><span class="token punctuation">(</span><span class="token string">"video4linux2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v_ifmtCtx<span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ifmt<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"无法打开输入流.%s\n"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>v_ifmtCtx<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>  
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"找不到流信息.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>
	<span class="token keyword">int</span> videoindex<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>v_ifmtCtx<span class="token operator">-&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>   
	<span class="token keyword">if</span><span class="token punctuation">(</span>v_ifmtCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codec<span class="token operator">-&gt;</span>codec_type<span class="token operator">==</span>AVMEDIA_TYPE_VIDEO<span class="token punctuation">)</span>  
	<span class="token punctuation">{<!-- --></span>  
		videoindex<span class="token operator">=</span>i<span class="token punctuation">;</span>  
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"videoindex=%d\n"</span><span class="token punctuation">,</span>videoindex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>videoindex<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"找不到视频流。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	pCodecCtx<span class="token operator">=</span>v_ifmtCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>videoindex<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codec<span class="token punctuation">;</span> 
	pCodec<span class="token operator">=</span><span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>pCodecCtx<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>pCodec<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>  
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"找不到编解码器。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>pCodecCtx<span class="token punctuation">,</span> pCodec<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>  
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"无法打开编解码器。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
  
	AVFrame <span class="token operator">*</span>pFrame<span class="token punctuation">,</span><span class="token operator">*</span>pFrameYUV<span class="token punctuation">;</span>  
	pFrame<span class="token operator">=</span><span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	pFrameYUV<span class="token operator">=</span><span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>out_buffer<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token function">av_image_get_buffer_size</span><span class="token punctuation">(</span>AV_PIX_FMT_YUV420P<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">av_image_fill_arrays</span><span class="token punctuation">(</span><span class="token punctuation">(</span>AVPicture <span class="token operator">*</span><span class="token punctuation">)</span>pFrameYUV<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span><span class="token punctuation">(</span>AVPicture <span class="token operator">*</span><span class="token punctuation">)</span>pFrameYUV<span class="token operator">-&gt;</span>linesize<span class="token punctuation">,</span> out_buffer<span class="token punctuation">,</span> AV_PIX_FMT_YUV420P<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"摄像头尺寸(WxH): %d x %d \n"</span><span class="token punctuation">,</span>pCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	video_width<span class="token operator">=</span>pCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
	video_height<span class="token operator">=</span>pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">SwsContext</span> <span class="token operator">*</span>img_convert_ctx<span class="token punctuation">;</span>  
	img_convert_ctx <span class="token operator">=</span> <span class="token function">sws_getContext</span><span class="token punctuation">(</span>pCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> AV_PIX_FMT_YUV420P<span class="token punctuation">,</span> SWS_BICUBIC<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
	AVPacket <span class="token operator">*</span>in_packet<span class="token operator">=</span><span class="token punctuation">(</span>AVPacket <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>AVPacket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	video_input<span class="token punctuation">.</span>img_convert_ctx<span class="token operator">=</span>img_convert_ctx<span class="token punctuation">;</span>  
	video_input<span class="token punctuation">.</span>in_packet<span class="token operator">=</span>in_packet<span class="token punctuation">;</span>  
	video_input<span class="token punctuation">.</span>pCodecCtx<span class="token operator">=</span>pCodecCtx<span class="token punctuation">;</span>  
	video_input<span class="token punctuation">.</span>pCodec<span class="token operator">=</span>pCodec<span class="token punctuation">;</span>  
	video_input<span class="token punctuation">.</span>v_ifmtCtx<span class="token operator">=</span>v_ifmtCtx<span class="token punctuation">;</span>  
	video_input<span class="token punctuation">.</span>videoindex<span class="token operator">=</span>videoindex<span class="token punctuation">;</span>  
	video_input<span class="token punctuation">.</span>pFrame<span class="token operator">=</span>pFrame<span class="token punctuation">;</span>  
	video_input<span class="token punctuation">.</span>pFrameYUV<span class="token operator">=</span>pFrameYUV<span class="token punctuation">;</span>  
    <span class="token comment">//-----------------------------添加摄像头结束</span>
	fmt<span class="token operator">=</span>oc<span class="token operator">-&gt;</span>oformat<span class="token punctuation">;</span>  
	<span class="token comment">/*使用默认格式的编解码器添加音频和视频流并初始化编解码器。*/</span> 
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fmt-&gt;video_codec = %d\n"</span><span class="token punctuation">,</span> fmt<span class="token operator">-&gt;</span>video_codec<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>fmt<span class="token operator">-&gt;</span>video_codec <span class="token operator">!=</span> AV_CODEC_ID_NONE<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">add_stream</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video_st<span class="token punctuation">,</span>oc<span class="token punctuation">,</span><span class="token operator">&amp;</span>video_codec<span class="token punctuation">,</span>fmt<span class="token operator">-&gt;</span>video_codec<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		have_video<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>  
		encode_video<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	<span class="token comment">/*现在已经设置了所有参数，可以打开音频并视频编解码器，并分配必要的编码缓冲区。*/</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>have_video<span class="token punctuation">)</span><span class="token function">open_video</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span> video_codec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>video_st<span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">av_dump_format</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>filename<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token comment">/* 打开输出文件(如果需要) */</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>fmt<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NOFILE<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		ret<span class="token operator">=</span><span class="token function">avio_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oc<span class="token operator">-&gt;</span>pb<span class="token punctuation">,</span>filename<span class="token punctuation">,</span>AVIO_FLAG_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>  
			<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"打不开'%s': %s\n"</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span><span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  
		<span class="token punctuation">}</span>  
	<span class="token punctuation">}</span>  
	<span class="token comment">/* 编写流头(如果有)*/</span>  
	ret<span class="token operator">=</span><span class="token function">avformat_write_header</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>opt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"打开输出文件时发生错误: %s\n"</span><span class="token punctuation">,</span><span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	<span class="token keyword">int</span> got_pic<span class="token punctuation">;</span>  
	<span class="token keyword">while</span><span class="token punctuation">(</span>encode_video<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>  
		<span class="token comment">/*选择要编码的流*/</span>    
		AVFrame <span class="token operator">*</span>frame<span class="token operator">=</span><span class="token function">get_video_frame</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video_st<span class="token punctuation">,</span><span class="token operator">&amp;</span>video_input<span class="token punctuation">,</span><span class="token operator">&amp;</span>got_pic<span class="token punctuation">)</span><span class="token punctuation">;</span>  
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>got_pic<span class="token punctuation">)</span>  
		<span class="token punctuation">{<!-- --></span>  
			<span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
			<span class="token keyword">continue</span><span class="token punctuation">;</span>  
		<span class="token punctuation">}</span>
		encode_video<span class="token operator">=</span><span class="token operator">!</span><span class="token function">write_video_frame</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span><span class="token operator">&amp;</span>video_st<span class="token punctuation">,</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>  
	<span class="token function">av_write_trailer</span><span class="token punctuation">(</span>oc<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">sws_freeContext</span><span class="token punctuation">(</span>video_input<span class="token punctuation">.</span>img_convert_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">avcodec_close</span><span class="token punctuation">(</span>video_input<span class="token punctuation">.</span>pCodecCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">av_free</span><span class="token punctuation">(</span>video_input<span class="token punctuation">.</span>pFrameYUV<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token function">av_free</span><span class="token punctuation">(</span>video_input<span class="token punctuation">.</span>pFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>      
	<span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video_input<span class="token punctuation">.</span>v_ifmtCtx<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token comment">/*关闭每个编解码器*/</span>  
	<span class="token keyword">if</span> <span class="token punctuation">(</span>have_video<span class="token punctuation">)</span><span class="token function">close_stream</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>video_st<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*关闭输出文件*/</span> 
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>fmt<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NOFILE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">avio_closep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oc<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token comment">/*释放流*/</span>  
	<span class="token function">avformat_free_context</span><span class="token punctuation">(</span>oc<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>```

## 二级目录
### 三级目录
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/852bd87f48b304ece39e0a98e9e9211a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vscode 安装</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80ba8c0eb07e70431d069e4a3bc9509f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">人工智能笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>