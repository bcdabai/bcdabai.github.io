<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kafka Consumer auto.offset.reset 理解 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kafka Consumer auto.offset.reset 理解" />
<meta property="og:description" content="先来一下 kafka 官网对于 auto.offset.reset 的解释：
上面的描述挺准确的，但如果没有相关背景会感觉很懵逼。网上也有很多文章讲这个东西并给了很多例子，看了之后总感觉没有理解清楚。
先来看一下怎么查看消费者 group 的 offset 情况：
每个 consumer group 会为每个消费的 partition 保存 offsets，这些 offsets 被保存在 kafka 的内部 topic：__consumer_offsets。
假设有一个 group：demo-consumer-group 和一个 topic：demo-topic，并且只有一个分区，先向其中发送两条消息。
运行 kafka 的管理脚本：
bin/kafka-consumer-groups.sh --describe --bootstrap-server 127.0.0.1:9092 --group demo-consumer-group 重点：下面的描述都是针对一个消费者 group 的，不同消费者 group 的 CURRENT-OFFSET、LOG-END-OFFSET、LAG 将会重新计算。
这个 partition 有两条消息，所以 LOG-END-OFFSET 是 2。
当有消费者 A 来消费这个分区的时候，auto.offset.reset 被设置成 latest，因为还没有正确设置 offset，这个消费者不会消费之前的消息，从 CURRENT-OFFSET 可以看出来。LAG 表示当前消费者还剩多少消息没有消费。
这里有个数据丢失的场景， 当这个消费者 A 收到第三条消息的时候，如果处理失败没有提交 offset，LOG-END-OFFSET 变成了 3，但是 CURRENT-OFFSET 还是未设置。这个时候发生重平衡，消费者 B 被分配到来消费这个分区的消息，消费者 B 也是消费不到第三个消息的。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ce6092ed136c7ae551a2a5884d96f9e7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-26T23:59:40+08:00" />
<meta property="article:modified_time" content="2022-12-26T23:59:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kafka Consumer auto.offset.reset 理解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>先来一下 kafka 官网对于 auto.offset.reset 的解释：<br> <img src="https://images2.imgbox.com/4b/91/SjVB1U3r_o.png" alt="在这里插入图片描述"><br> 上面的描述挺准确的，但如果没有相关背景会感觉很懵逼。网上也有很多文章讲这个东西并给了很多例子，看了之后总感觉没有理解清楚。</p> 
<p>先来看一下怎么查看消费者 group 的 offset 情况：<br> 每个 consumer group 会为每个消费的 partition 保存 offsets，这些 offsets 被保存在 kafka 的内部 topic：__consumer_offsets。<br> 假设有一个 group：demo-consumer-group 和一个 topic：demo-topic，并且只有一个分区，先向其中发送两条消息。</p> 
<p>运行 kafka 的管理脚本：</p> 
<pre><code class="prism language-bash">bin/kafka-consumer-groups.sh <span class="token parameter variable">--describe</span> --bootstrap-server <span class="token number">127.0</span>.0.1:9092 <span class="token parameter variable">--group</span> demo-consumer-group
</code></pre> 
<p><img src="https://images2.imgbox.com/4e/7a/Iv73arLj_o.png" alt="在这里插入图片描述"><br> <strong>重点</strong>：下面的描述都是针对一个消费者 group 的，不同消费者 group 的 CURRENT-OFFSET、LOG-END-OFFSET、LAG 将会重新计算。</p> 
<p>这个 partition 有两条消息，所以 LOG-END-OFFSET 是 2。<br> 当有消费者 A 来消费这个分区的时候，auto.offset.reset 被设置成 latest，因为还没有正确设置 offset，这个消费者不会消费之前的消息，从 CURRENT-OFFSET 可以看出来。LAG 表示当前消费者还剩多少消息没有消费。</p> 
<p>这里有个数据丢失的场景， 当这个消费者 A 收到第三条消息的时候，如果处理失败没有提交 offset，LOG-END-OFFSET 变成了 3，但是 CURRENT-OFFSET 还是未设置。这个时候发生重平衡，消费者 B 被分配到来消费这个分区的消息，消费者 B 也是消费不到第三个消息的。</p> 
<p>当消费者正常消费消息后，CURRENT-OFFSET 将会被设置，即使消费者停了也是有这个记录的。当有新的消费者重新启动开始消费的时候，如果 CURRENT-OFFSET 有值，auto.offset.reset 设置成什么已经不重要了，都将会从 CURRENT-OFFSET 的下一个 offset 进行消费。</p> 
<p>所以 auto.offset.reset 这个配置的设置是跟 CURRENT-OFFSET 是有关系的，如果 CURRENT-OFFSET 没有设置值，那 earliest 就从这个 partition 从头到尾开始消费，latest 不会消费消息，如果 CURRENT-OFFSET 有值，就是 CURRENT-OFFSET 指向的下一个 offset 开始消费。</p> 
<p>有了这个知识点，应该可以看懂这篇博客了：<br> <a href="https://blog.csdn.net/lishuangzhe7047/article/details/74530417">Kafka auto.offset.reset值详解</a></p> 
<p>所以当新开一个 消费者组的时候如果使用了 earliest 的话，会消费那个 partition 之前的所有消息，那就需要考虑数据的容量和消费资源是否足够的影响了。</p> 
<p>参考：<br> <a href="https://medium.com/lydtech-consulting/kafka-consumer-auto-offset-reset-d3962bad2665#:~:text=The%20auto%20offset%20reset%20consumer%20configuration%20defines%20how%20a%20consumer,topic%20for%20the%20first%20time." rel="nofollow">Kafka Consumer Auto Offset Reset</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/325009ea82104da00d8271fd8c241c1c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">HTML标签之段落＜p＞、换行＜br＞、水平线＜hr＞</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2e96e188b1925f4779734b30049d1fcd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">2023最新大数据毕设题目推荐100例</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>