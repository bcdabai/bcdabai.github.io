<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>7ã€Linuxé©±åŠ¨å¼€å‘ï¼šè®¾å¤‡-è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="7ã€Linuxé©±åŠ¨å¼€å‘ï¼šè®¾å¤‡-è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹" />
<meta property="og:description" content="ç›®å½• ğŸ…ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹æ‰€æœ‰åšæ–‡
éšç€è‡ªå·±å·¥ä½œçš„è¿›è¡Œï¼Œæ¥è§¦åˆ°çš„æŠ€æœ¯æ ˆä¹Ÿè¶Šæ¥è¶Šå¤šã€‚ç»™æˆ‘ä¸€ä¸ªå¾ˆç›´è§‚çš„æ„Ÿå—å°±æ˜¯ï¼ŒæŸä¸€é¡¹æŠ€æœ¯/ç»éªŒåœ¨åˆšå¼€å§‹æ¥è§¦çš„æ—¶å€™éƒ½è®°å¾—å¾ˆæ¸…æ¥šã€‚å¾€å¾€è¿‡äº†å‡ ä¸ªæœˆéƒ½ä¼šå¿˜è®°çš„å·®ä¸å¤šäº†ï¼Œåªæœ‰ç»å¸¸ä¼šç”¨åˆ°çš„ä¸œè¥¿æ‰æœ‰å¯èƒ½çœŸæ­£è®°ä¸‹æ¥ã€‚å­˜åœ¨å¾ˆå¤šåœ¨ç‰¹æ®Šæƒ…å†µä¸‹æœ‰ä¸€ç‚¹ç”¨å¤„çš„æŠ€å·§ï¼Œç”¨çš„ä¸å¤šçš„æŠ€å·§å¯èƒ½ä¸€ä¸ªæ˜ŸæœŸå°±å¿˜äº†ã€‚
æƒ³äº†å¾ˆä¹…æƒ³é€šè¿‡ä¸€äº›æ‰‹æ®µæŠŠè¿™äº›äº‹æƒ…è®°å½•ä¸‹æ¥ã€‚ä¹Ÿå°è¯•è¿‡åœ¨ä¹¦ä¸Šè®°ç¬”è®°ï¼Œè¿™ä¹Ÿåªæ˜¯ä¸€æ—¶çš„ï¼Œä¹¦ä¸åœ¨æ‰‹è¾¹çš„æ—¶å€™é‚£äº›ç¬”è®°å°±å’Œæ²¡è®°ä¸€æ ·ï¼Œä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚
å¾ˆå¤šæ—¶å€™æˆ‘ä»¬é‡åˆ°äº†é—®é¢˜ï¼Œä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯é€‰æ‹©åœ¨æœç´¢å¼•æ“æ£€ç´¢ç›¸å…³å†…å®¹ï¼Œè¿™æ ·æ¥çš„ä¹Ÿæ›´å¿«ä¸€ç‚¹ï¼Œé™¤éçœŸçš„æ‰¾ä¸åˆ°æ‰ä¼šå»é€‰æ‹©ç¿»ä¹¦ã€‚åæ¥å°±æƒ³åˆ°äº†å†™åšå®¢ï¼Œåšå®¢ä½œä¸ºè‡ªå·±çš„ä¸€ä¸ªç¬”è®°å¹³å°å€’æ˜¯æŒºåˆé€‚çš„ã€‚éšæ—¶å¯ä»¥æŸ¥é˜…ï¼Œä¸ç”¨éšèº«æºå¸¦ã€‚
åŒæ—¶ç”±äºå†™åšå®¢æ˜¯å¯¹å¤–çš„ï¼Œæ—¢ç„¶æ˜¯å¯¹å¤–çš„å°±ä¸èƒ½éšä¾¿å†™ï¼Œä»»ä½•äººéƒ½å¯ä»¥çœ‹åˆ°ã€‚ç»éªŒå¯¹äºæˆ‘æ¥è¯´é‚£å°±åªæ˜¯ç»éªŒè€Œå·²ï¼Œå…¬å¸ƒå‡ºæ¥è¯´ä¸ä¸€å®šæˆ‘çš„ä¸€äº›ç»éªŒå¯ä»¥å¸®åŠ©åˆ°å…¶ä»–çš„äººã€‚é‡åˆ°å’Œæˆ‘ç›¸åŒé—®é¢˜æ—¶å¯ä»¥å°‘èµ°ä¸€äº›å¼¯è·¯ã€‚
æ—¢ç„¶å†³å®šäº†è¦å†™åšå®¢ï¼Œé‚£å°±åªèƒ½è®¤çœŸå»å†™ã€‚ä¸ç®¡å†™çš„å¥½ä¸å¥½ï¼Œå°½åŠ›å°±è¡Œã€‚åƒé‡Œä¹‹è¡Œå§‹äºè¶³ä¸‹ï¼Œä¸€æ­¥ä¸€ä¸ªè„šå°ï¼Œæ…¢æ…¢æ¥ ï¼Œå†™çš„å¤šäº†æ…¢æ…¢ä¹Ÿä¼šå˜å¥½çš„ã€‚æƒå½“æ˜¯è®°å½•è‡ªå·±çš„æˆé•¿çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œç­‰åˆ°ä»¥åå†å¾€å›çœ‹æ—¶ï¼Œå°±ä¼šå‘ç°è‡ªå·±ä»¥å‰åŸæ¥è¿™ä¹ˆèœğŸ˜‚ã€‚
æœ¬ç³»åˆ—åšå®¢æ‰€è¿°èµ„æ–™å‡æ¥è‡ªäº’è”ç½‘èµ„æ–™ï¼Œå¹¶ä¸æ˜¯æœ¬äººåŸåˆ›ï¼ˆåªæœ‰åšå®¢æ˜¯è‡ªå·±å†™çš„ï¼‰ã€‚å‡ºäºçƒ­å¿ƒï¼Œæœ¬äººå°†è‡ªå·±çš„æ‰€å­¦ç¬”è®°æ•´ç†å¹¶æ¨å‡ºç›¸å¯¹åº”çš„ä½¿ç”¨æ•™ç¨‹ï¼Œæ–¹é¢å…¶ä»–äººå­¦ä¹ ã€‚ä¸ºå›½å†…çš„ç‰©è”ç½‘äº‹ä¸šå‘å±•å°½è‡ªå·±çš„ä¸€ä»½ç»µè–„ä¹‹åŠ›ï¼Œæ²¡æœ‰ä¸ºè‡ªå·±è°‹å–ç§åˆ©çš„æƒ³æ³•ã€‚è‹¥å‡ºç°ä¾µæƒç°è±¡ï¼Œè¯·å‘ŠçŸ¥æœ¬äººï¼Œæœ¬äººä¼šç«‹å³åœæ­¢æ›´æ–°ï¼Œå¹¶åˆ é™¤ç›¸åº”çš„æ–‡ç« å’Œä»£ç ã€‚
å‰è¨€ åœ¨å‰é¢ä¸¤å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ åˆ°äº†è®¾å¤‡æ³¨å†Œã€‚å¯ä»¥å°†ä¸€ä¸ªè®¾å¤‡é©±åŠ¨æ³¨å†Œåˆ°å†…æ ¸ä¸­ã€‚è®¾å¤‡æ³¨å†Œå®Œæˆåï¼Œè¿˜éœ€è¦é€šè¿‡mknodæŒ‡ä»¤åœ¨ç”¨æˆ·ç©ºé—´ä¸­æ‰‹åŠ¨åˆ›å»ºè¯¥é©±åŠ¨å¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹ã€‚
root@ubuntu:# mknod /dev/hello_test0 c 237 0 è¯¥å‘½ä»¤åœ¨æ‰§è¡Œæ˜¯ä¸ä¼šæ£€æŸ¥å‚æ•°çš„åˆæ³•æ€§ã€‚ä¹Ÿä¸ä¼šæ£€æŸ¥è®¾å¤‡é©±åŠ¨æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœç³»ç»Ÿä¸­æ‰€æœ‰çš„é©±åŠ¨éƒ½é€šè¿‡è¯¥æ–¹æ³•åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ï¼Œå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ã€‚å½“è®¾å¤‡æœªæ¥å…¥æ—¶ï¼Œå°±å¯èƒ½ä¼šå‡ºç°å¾ˆå¤šçš„è®¾å¤‡èŠ‚ç‚¹ã€‚
å®é™…ä¸ŠLinuxå†…æ ¸ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç»„å‡½æ•°ï¼Œå¯ä»¥åœ¨æ¨¡å—åŠ è½½çš„æ—¶å€™è‡ªåŠ¨åœ¨/devç›®å½•ä¸‹åˆ›å»ºç›¸åº”è®¾å¤‡èŠ‚ç‚¹ï¼Œå¹¶åœ¨å¸è½½æ¨¡å—æ—¶åˆ é™¤è¯¥èŠ‚ç‚¹ï¼Œå½“ç„¶å‰ææ¡ä»¶æ˜¯ç”¨æˆ·ç©ºé—´ç§»æ¤äº†udevã€‚
udev udevæ˜¯ä¸€ä¸ªå·¥ä½œåœ¨ç”¨æˆ·ç©ºé—´çš„å·¥å…·ï¼Œå®ƒèƒ½æ ¹æ®ç³»ç»Ÿä¸­ç¡¬ä»¶è®¾å¤‡çš„çŠ¶æ€åŠ¨æ€çš„æ›´æ–°è®¾å¤‡æ–‡ä»¶ï¼ŒåŒ…æ‹¬è®¾å¤‡æ–‡ä»¶çš„åˆ›å»ºï¼Œåˆ é™¤ï¼Œæƒé™ç­‰ã€‚è¿™äº›æ–‡ä»¶é€šå¸¸éƒ½å®šä¹‰åœ¨/dev ç›®å½•ä¸‹ï¼Œä½†ä¹Ÿå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šã€‚
å½“æ’å…¥æ–°è®¾å¤‡â€”&gt;åŠ å…¥é©±åŠ¨æ¨¡å—â€”&gt;åœ¨sysfsä¸Šæ³¨å†Œæ–°çš„æ•°æ®åï¼Œudevä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„è®¾å¤‡èŠ‚ç‚¹ã€‚udevè¿è¡Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸­ï¼Œè€Œå¹¶éå†…æ ¸ä¸­ã€‚
æ¥å£ å†…æ ¸ä¸­å®šä¹‰äº†struct classç»“æ„ä½“ï¼Œé¡¾åæ€ä¹‰ï¼Œä¸€ä¸ªstruct classç»“æ„ä½“ç±»å‹å˜é‡å¯¹åº”ä¸€ä¸ªç±»ã€‚ä»£ç ä¸­å‡ºç°çš„classæŒ‡çš„æ˜¯ è®¾å¤‡ç±»ï¼ˆdevice classesï¼‰ï¼Œæ˜¯å¯¹äºè®¾å¤‡çš„é«˜çº§æŠ½è±¡ã€‚ä½† å®é™…ä¸Šclassä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œåªä¸è¿‡classç»“æ„ä½“åœ¨å£°æ˜æ—¶æ˜¯æŒ‰ç…§ç±»çš„æ€æƒ³æ¥ç»„ç»‡å…¶æˆå‘˜çš„ã€‚
/** * struct class - device classes * @name:	Name of the class. * @owner:	The module owner. * @class_attrs: Default attributes of this class. * @dev_groups:	Default attributes of the devices that belong to the class. * @dev_kobj:	The kobject that represents this class and links it into the hierarchy." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/cd985fd4c959f8473c616ac5ad666666/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-18T15:48:34+08:00" />
<meta property="article:modified_time" content="2023-10-18T15:48:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">7ã€Linuxé©±åŠ¨å¼€å‘ï¼šè®¾å¤‡-è‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_1"></a>ç›®å½•</h2> 
<p><a href="https://blog.csdn.net/weixin_44570083/article/details/104285283">ğŸ…ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹æ‰€æœ‰åšæ–‡</a></p> 
<p>â€ƒâ€ƒéšç€è‡ªå·±å·¥ä½œçš„è¿›è¡Œï¼Œæ¥è§¦åˆ°çš„æŠ€æœ¯æ ˆä¹Ÿè¶Šæ¥è¶Šå¤šã€‚ç»™æˆ‘ä¸€ä¸ªå¾ˆç›´è§‚çš„æ„Ÿå—å°±æ˜¯ï¼ŒæŸä¸€é¡¹æŠ€æœ¯/ç»éªŒåœ¨åˆšå¼€å§‹æ¥è§¦çš„æ—¶å€™éƒ½è®°å¾—å¾ˆæ¸…æ¥šã€‚å¾€å¾€è¿‡äº†å‡ ä¸ªæœˆéƒ½ä¼šå¿˜è®°çš„å·®ä¸å¤šäº†ï¼Œåªæœ‰ç»å¸¸ä¼šç”¨åˆ°çš„ä¸œè¥¿æ‰æœ‰å¯èƒ½çœŸæ­£è®°ä¸‹æ¥ã€‚å­˜åœ¨å¾ˆå¤šåœ¨ç‰¹æ®Šæƒ…å†µä¸‹æœ‰ä¸€ç‚¹ç”¨å¤„çš„æŠ€å·§ï¼Œç”¨çš„ä¸å¤šçš„æŠ€å·§å¯èƒ½ä¸€ä¸ªæ˜ŸæœŸå°±å¿˜äº†ã€‚</p> 
<p>â€ƒâ€ƒæƒ³äº†å¾ˆä¹…æƒ³é€šè¿‡ä¸€äº›æ‰‹æ®µæŠŠè¿™äº›äº‹æƒ…è®°å½•ä¸‹æ¥ã€‚ä¹Ÿå°è¯•è¿‡åœ¨ä¹¦ä¸Šè®°ç¬”è®°ï¼Œè¿™ä¹Ÿåªæ˜¯ä¸€æ—¶çš„ï¼Œä¹¦ä¸åœ¨æ‰‹è¾¹çš„æ—¶å€™é‚£äº›ç¬”è®°å°±å’Œæ²¡è®°ä¸€æ ·ï¼Œä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚</p> 
<p>â€ƒâ€ƒå¾ˆå¤šæ—¶å€™æˆ‘ä»¬é‡åˆ°äº†é—®é¢˜ï¼Œä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯é€‰æ‹©åœ¨æœç´¢å¼•æ“æ£€ç´¢ç›¸å…³å†…å®¹ï¼Œè¿™æ ·æ¥çš„ä¹Ÿæ›´å¿«ä¸€ç‚¹ï¼Œé™¤éçœŸçš„æ‰¾ä¸åˆ°æ‰ä¼šå»é€‰æ‹©ç¿»ä¹¦ã€‚åæ¥å°±æƒ³åˆ°äº†å†™åšå®¢ï¼Œåšå®¢ä½œä¸ºè‡ªå·±çš„ä¸€ä¸ªç¬”è®°å¹³å°å€’æ˜¯æŒºåˆé€‚çš„ã€‚éšæ—¶å¯ä»¥æŸ¥é˜…ï¼Œä¸ç”¨éšèº«æºå¸¦ã€‚</p> 
<p>â€ƒâ€ƒåŒæ—¶ç”±äºå†™åšå®¢æ˜¯å¯¹å¤–çš„ï¼Œæ—¢ç„¶æ˜¯å¯¹å¤–çš„å°±ä¸èƒ½éšä¾¿å†™ï¼Œä»»ä½•äººéƒ½å¯ä»¥çœ‹åˆ°ã€‚ç»éªŒå¯¹äºæˆ‘æ¥è¯´é‚£å°±åªæ˜¯ç»éªŒè€Œå·²ï¼Œå…¬å¸ƒå‡ºæ¥è¯´ä¸ä¸€å®šæˆ‘çš„ä¸€äº›ç»éªŒå¯ä»¥å¸®åŠ©åˆ°å…¶ä»–çš„äººã€‚é‡åˆ°å’Œæˆ‘ç›¸åŒé—®é¢˜æ—¶å¯ä»¥å°‘èµ°ä¸€äº›å¼¯è·¯ã€‚</p> 
<p>â€ƒâ€ƒæ—¢ç„¶å†³å®šäº†è¦å†™åšå®¢ï¼Œé‚£å°±åªèƒ½è®¤çœŸå»å†™ã€‚ä¸ç®¡å†™çš„å¥½ä¸å¥½ï¼Œå°½åŠ›å°±è¡Œã€‚<code>åƒé‡Œä¹‹è¡Œå§‹äºè¶³ä¸‹ï¼Œä¸€æ­¥ä¸€ä¸ªè„šå°ï¼Œæ…¢æ…¢æ¥</code> ï¼Œå†™çš„å¤šäº†æ…¢æ…¢ä¹Ÿä¼šå˜å¥½çš„ã€‚æƒå½“æ˜¯è®°å½•è‡ªå·±çš„æˆé•¿çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œç­‰åˆ°ä»¥åå†å¾€å›çœ‹æ—¶ï¼Œå°±ä¼šå‘ç°è‡ªå·±ä»¥å‰åŸæ¥è¿™ä¹ˆèœğŸ˜‚ã€‚</p> 
<p>â€ƒâ€ƒæœ¬ç³»åˆ—åšå®¢æ‰€è¿°èµ„æ–™<code>å‡æ¥è‡ªäº’è”ç½‘èµ„æ–™</code>ï¼Œå¹¶ä¸æ˜¯æœ¬äººåŸåˆ›ï¼ˆåªæœ‰åšå®¢æ˜¯è‡ªå·±å†™çš„ï¼‰ã€‚å‡ºäºçƒ­å¿ƒï¼Œæœ¬äººå°†è‡ªå·±çš„æ‰€å­¦ç¬”è®°æ•´ç†å¹¶æ¨å‡ºç›¸å¯¹åº”çš„ä½¿ç”¨æ•™ç¨‹ï¼Œæ–¹é¢å…¶ä»–äººå­¦ä¹ ã€‚ä¸ºå›½å†…çš„ç‰©è”ç½‘äº‹ä¸šå‘å±•å°½è‡ªå·±çš„ä¸€ä»½ç»µè–„ä¹‹åŠ›ï¼Œ<code>æ²¡æœ‰ä¸ºè‡ªå·±è°‹å–ç§åˆ©çš„æƒ³æ³•</code>ã€‚è‹¥å‡ºç°ä¾µæƒç°è±¡ï¼Œè¯·å‘ŠçŸ¥æœ¬äººï¼Œæœ¬äººä¼šç«‹å³åœæ­¢æ›´æ–°ï¼Œå¹¶åˆ é™¤ç›¸åº”çš„æ–‡ç« å’Œä»£ç ã€‚</p> 
<h2><a id="_17"></a>å‰è¨€</h2> 
<p>â€ƒâ€ƒåœ¨å‰é¢ä¸¤å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ åˆ°äº†è®¾å¤‡æ³¨å†Œã€‚å¯ä»¥å°†ä¸€ä¸ªè®¾å¤‡é©±åŠ¨æ³¨å†Œåˆ°å†…æ ¸ä¸­ã€‚è®¾å¤‡æ³¨å†Œå®Œæˆåï¼Œè¿˜éœ€è¦é€šè¿‡mknodæŒ‡ä»¤åœ¨ç”¨æˆ·ç©ºé—´ä¸­æ‰‹åŠ¨åˆ›å»ºè¯¥é©±åŠ¨å¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹ã€‚</p> 
<pre><code class="prism language-shell">root@ubuntu:<span class="token comment"># mknod /dev/hello_test0 c 237 0</span>
</code></pre> 
<p>â€ƒâ€ƒè¯¥å‘½ä»¤åœ¨æ‰§è¡Œæ˜¯ä¸ä¼šæ£€æŸ¥å‚æ•°çš„åˆæ³•æ€§ã€‚ä¹Ÿä¸ä¼šæ£€æŸ¥è®¾å¤‡é©±åŠ¨æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœç³»ç»Ÿä¸­æ‰€æœ‰çš„é©±åŠ¨éƒ½é€šè¿‡è¯¥æ–¹æ³•åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ï¼Œå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ã€‚å½“è®¾å¤‡æœªæ¥å…¥æ—¶ï¼Œå°±å¯èƒ½ä¼šå‡ºç°å¾ˆå¤šçš„è®¾å¤‡èŠ‚ç‚¹ã€‚</p> 
<p>â€ƒâ€ƒå®é™…ä¸ŠLinuxå†…æ ¸ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç»„å‡½æ•°ï¼Œå¯ä»¥åœ¨æ¨¡å—åŠ è½½çš„æ—¶å€™è‡ªåŠ¨åœ¨<code>/dev</code>ç›®å½•ä¸‹åˆ›å»ºç›¸åº”è®¾å¤‡èŠ‚ç‚¹ï¼Œå¹¶åœ¨å¸è½½æ¨¡å—æ—¶åˆ é™¤è¯¥èŠ‚ç‚¹ï¼Œå½“ç„¶å‰ææ¡ä»¶æ˜¯ç”¨æˆ·ç©ºé—´ç§»æ¤äº†<strong>udev</strong>ã€‚</p> 
<h2><a id="udev_29"></a>udev</h2> 
<p>â€ƒâ€ƒ<strong>udev</strong>æ˜¯ä¸€ä¸ªå·¥ä½œåœ¨ç”¨æˆ·ç©ºé—´çš„å·¥å…·ï¼Œå®ƒèƒ½æ ¹æ®ç³»ç»Ÿä¸­ç¡¬ä»¶è®¾å¤‡çš„çŠ¶æ€åŠ¨æ€çš„æ›´æ–°è®¾å¤‡æ–‡ä»¶ï¼ŒåŒ…æ‹¬è®¾å¤‡æ–‡ä»¶çš„åˆ›å»ºï¼Œåˆ é™¤ï¼Œæƒé™ç­‰ã€‚è¿™äº›æ–‡ä»¶é€šå¸¸éƒ½å®šä¹‰åœ¨<code>/dev</code> ç›®å½•ä¸‹ï¼Œä½†ä¹Ÿå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šã€‚</p> 
<p>â€ƒâ€ƒå½“æ’å…¥æ–°è®¾å¤‡â€”&gt;åŠ å…¥é©±åŠ¨æ¨¡å—â€”&gt;åœ¨sysfsä¸Šæ³¨å†Œæ–°çš„æ•°æ®åï¼Œudevä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„è®¾å¤‡èŠ‚ç‚¹ã€‚udevè¿è¡Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸­ï¼Œè€Œå¹¶éå†…æ ¸ä¸­ã€‚</p> 
<p><img src="https://images2.imgbox.com/f4/4d/01mdkyww_o.png" alt="è¾“å…¥å›¾ç‰‡è¯´æ˜"></p> 
<h2><a id="_38"></a>æ¥å£</h2> 
<p>â€ƒâ€ƒå†…æ ¸ä¸­å®šä¹‰äº†<strong>struct class</strong>ç»“æ„ä½“ï¼Œé¡¾åæ€ä¹‰ï¼Œä¸€ä¸ª<strong>struct class</strong>ç»“æ„ä½“ç±»å‹å˜é‡å¯¹åº”ä¸€ä¸ªç±»ã€‚ä»£ç ä¸­å‡ºç°çš„<strong>class</strong>æŒ‡çš„æ˜¯ è®¾å¤‡ç±»ï¼ˆ<strong>device classes</strong>ï¼‰ï¼Œæ˜¯å¯¹äºè®¾å¤‡çš„é«˜çº§æŠ½è±¡ã€‚ä½† å®é™…ä¸Š<strong>class</strong>ä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œåªä¸è¿‡<strong>class</strong>ç»“æ„ä½“åœ¨å£°æ˜æ—¶æ˜¯æŒ‰ç…§ç±»çš„æ€æƒ³æ¥ç»„ç»‡å…¶æˆå‘˜çš„ã€‚</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * struct class - device classes
 * @name:	Name of the class.
 * @owner:	The module owner.
 * @class_attrs: Default attributes of this class.
 * @dev_groups:	Default attributes of the devices that belong to the class.
 * @dev_kobj:	The kobject that represents this class and links it into the hierarchy.
 * @dev_uevent:	Called when a device is added, removed from this class, or a
 *		few other things that generate uevents to add the environment
 *		variables.
 * @devnode:	Callback to provide the devtmpfs.
 * @class_release: Called to release this class.
 * @dev_release: Called to release the device.
 * @suspend:	Used to put the device to sleep mode, usually to a low power
 *		state.
 * @resume:	Used to bring the device from the sleep mode.
 * @ns_type:	Callbacks so sysfs can detemine namespaces.
 * @namespace:	Namespace of the device belongs to this class.
 * @pm:		The default device power management operations of this class.
 * @p:		The private data of the driver core, no one other than the
 *		driver core can touch this.
 *
 * A class is a higher-level view of a device that abstracts out low-level
 * implementation details. Drivers may see a SCSI disk or an ATA disk, but,
 * at the class level, they are all simply disks. Classes allow user space
 * to work with devices based on what they do, rather than how they are
 * connected or how they work.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">const</span> <span class="token keyword">char</span>		<span class="token operator">*</span>name<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">module</span>		<span class="token operator">*</span>owner<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">class_attribute</span>		<span class="token operator">*</span>class_attrs<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">attribute_group</span>	<span class="token operator">*</span><span class="token operator">*</span>dev_groups<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">kobject</span>			<span class="token operator">*</span>dev_kobj<span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>dev_uevent<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_uevent_env</span> <span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>devnode<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token class-name">umode_t</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>class_release<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dev_release<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>suspend<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token class-name">pm_message_t</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>resume<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">kobj_ns_type_operations</span> <span class="token operator">*</span>ns_type<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>namespace<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dev_pm_ops</span> <span class="token operator">*</span>pm<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">subsys_private</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>â€ƒâ€ƒå†…æ ¸åŒæ—¶æä¾›äº†<strong>class_create</strong>å®ã€‚ç”¨äºåŠ¨æ€åˆ›å»ºè®¾å¤‡çš„é€»è¾‘ç±»ï¼Œå¹¶å®Œæˆéƒ¨åˆ†å­—æ®µçš„åˆå§‹åŒ–ï¼Œç„¶åå°†å…¶æ·»åŠ è¿›Linuxå†…æ ¸ç³»ç»Ÿä¸­ã€‚æ­¤å‡½æ•°çš„æ‰§è¡Œæ•ˆæœå°±æ˜¯åœ¨**/sys/class/**ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹ï¼Œæ­¤æ–‡ä»¶å¤¹çš„åå­—ä¸ºæ­¤å‡½æ•°çš„ç¬¬äºŒä¸ªè¾“å…¥å‚æ•°ã€‚</p> 
<p>â€ƒâ€ƒ<strong>class_create</strong> ä¸€å…±æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå‚æ•° <strong>owner</strong> ä¸€èˆ¬ä¸º <strong>THIS_MODULE</strong>ï¼Œå‚æ•° <strong>name</strong> æ˜¯ç±»åå­—ã€‚è¿”å›å€¼æ˜¯ä¸ªæŒ‡å‘ç»“æ„ä½“ <strong>class</strong> çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºçš„ç±»ã€‚</p> 
<pre><code class="prism language-c"><span class="token comment">/* This is a #define to keep the compiler from merging different
 * instances of the __key variable */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">class_create</span><span class="token expression"><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> name<span class="token punctuation">)</span>		</span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>						</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">lock_class_key</span> __key<span class="token punctuation">;</span>	</span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token function">__class_create</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>__key<span class="token punctuation">)</span><span class="token punctuation">;</span>	</span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/**
 * class_create - create a struct class structure
 * @owner: pointer to the module that is to "own" this struct class
 * @name: pointer to a string for the name of this class.
 * @key: the lock_class_key for this class; used by mutex lock debugging
 *
 * This is used to create a struct class pointer that can then be used
 * in calls to device_create().
 *
 * Returns &amp;struct class pointer on success, or ERR_PTR() on error.
 *
 * Note, the pointer created here is to be destroyed when finished by
 * making a call to class_destroy().
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span><span class="token function">__class_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span>
			     <span class="token keyword">struct</span> <span class="token class-name">lock_class_key</span> <span class="token operator">*</span>key<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>cls<span class="token punctuation">;</span>
	<span class="token keyword">int</span> retval<span class="token punctuation">;</span>
	cls <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>cls<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cls<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		retval <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> error<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	cls<span class="token operator">-&gt;</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
	cls<span class="token operator">-&gt;</span>owner <span class="token operator">=</span> owner<span class="token punctuation">;</span>
	cls<span class="token operator">-&gt;</span>class_release <span class="token operator">=</span> class_create_release<span class="token punctuation">;</span>
	retval <span class="token operator">=</span> <span class="token function">__class_register</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>retval<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> error<span class="token punctuation">;</span>
	<span class="token keyword">return</span> cls<span class="token punctuation">;</span>
error<span class="token operator">:</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>â€ƒâ€ƒå‡½æ•°<strong>device_create</strong>ç”¨äºåŠ¨æ€åˆ›å»ºé€»è¾‘è®¾å¤‡ï¼Œå¯¹æ–°çš„é€»è¾‘è®¾å¤‡è¿›è¡Œç›¸åº”åˆå§‹åŒ–ï¼Œç„¶åå°†æ­¤é€»è¾‘è®¾å¤‡åŠ å…¥åˆ°Linuxå†…æ ¸ç³»ç»Ÿçš„è®¾å¤‡é©±åŠ¨ç¨‹åºæ¨¡å‹ä¸­ã€‚</p> 
<p>â€ƒâ€ƒ<strong>device_create</strong>æ˜¯ä¸ªå¯å˜å‚æ•°å‡½æ•°ï¼Œå‚æ•° <strong>class</strong> å°±æ˜¯è®¾å¤‡è¦åˆ›å»ºåœ¨å“ªä¸ªç±»ä¸‹é¢ã€‚å‚æ•° <strong>parent</strong> æ˜¯çˆ¶è®¾å¤‡ï¼Œä¸€èˆ¬ä¸º NULLï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰çˆ¶è®¾å¤‡ã€‚å‚æ•° <strong>devt</strong> æ˜¯è®¾å¤‡å·ã€‚å‚æ•° <strong>drvdata</strong> æ˜¯è®¾å¤‡å¯èƒ½ä¼šä½¿ç”¨çš„ä¸€äº›æ•°æ®ï¼Œä¸€èˆ¬ä¸º NULLã€‚å‚æ•° <strong>fmt</strong> æ˜¯è®¾å¤‡åå­—ï¼Œå¦‚æœè®¾ç½® fmt=xxx çš„è¯ï¼Œå°±ä¼šç”Ÿæˆ/dev/xxxè¿™ä¸ªè®¾å¤‡æ–‡ä»¶ã€‚è¿”å›å€¼å°±æ˜¯åˆ›å»ºå¥½çš„è®¾å¤‡ã€‚</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * device_create - creates a device and registers it with sysfs
 * @class: pointer to the struct class that this device should be registered to
 * @parent: pointer to the parent struct device of this new device, if any
 * @devt: the dev_t for the char device to be added
 * @drvdata: the data to be added to the device for callbacks
 * @fmt: string for the device's name
 *
 * This function can be used by char device classes.  A struct device
 * will be created in sysfs, registered to the specified class.
 *
 * A "dev" file will be created, showing the dev_t for the device, if
 * the dev_t is not 0,0.
 * If a pointer to a parent struct device is passed in, the newly created
 * struct device will be a child of that device in sysfs.
 * The pointer to the struct device will be returned from the call.
 * Any further sysfs files that might be required can be created using this
 * pointer.
 *
 * Returns &amp;struct device pointer on success, or ERR_PTR() on error.
 *
 * Note: the struct class passed to this function must have previously
 * been created with a call to class_create().
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span><span class="token function">device_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span>
			     <span class="token class-name">dev_t</span> devt<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>drvdata<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	va_list vargs<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
	<span class="token function">va_start</span><span class="token punctuation">(</span>vargs<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dev <span class="token operator">=</span> <span class="token function">device_create_vargs</span><span class="token punctuation">(</span>class<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> devt<span class="token punctuation">,</span> drvdata<span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> vargs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">va_end</span><span class="token punctuation">(</span>vargs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> dev<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>â€ƒâ€ƒè¯¥å‡½æ•°ä¼šè‡ªåŠ¨åœ°åœ¨<code>/sys/devices/virtual</code>ç›®å½•ä¸‹åˆ›å»ºæ–°çš„é€»è¾‘è®¾å¤‡ç›®å½•ã€‚å¹¶å°†å…¶è½¯è¿æ¥åˆ°<code>/sys/class/</code>ç›®å½•ä¸­å¯¹åº”çš„ç±»ä¸‹ã€‚åŒæ—¶è¿˜ä¼šåœ¨<code>/dev</code>ç›®å½•ä¸‹åˆ›å»ºä¸é€»è¾‘ç±»å¯¹åº”åœ°è®¾å¤‡æ–‡ä»¶ã€‚</p> 
<pre><code class="prism language-shell">root@ubuntu:<span class="token comment"># ll /sys/class/hellocls/</span>
total <span class="token number">0</span>
lrwxrwxrwx <span class="token number">1</span> root root <span class="token number">0</span> Sep <span class="token number">17</span> 06:11 hellodev -<span class="token operator">&gt;</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/devices/virtual/hellocls/hellodev

root@ubuntu:<span class="token comment"># ll /dev/hellodev </span>
crw------- <span class="token number">1</span> root root <span class="token number">237</span>, <span class="token number">0</span> Sep <span class="token number">17</span> 06:11 /dev/hellodev
</code></pre> 
<h2><a id="_193"></a>ä»£ç å®ç°</h2> 
<p>â€ƒâ€ƒç¤ºä¾‹ä»£ç å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå®Œæˆè®¾å¤‡çš„æ³¨å†Œåã€‚<strong>class_create</strong>åˆ›å»ºä¸€ä¸ª<code>hellocls</code>çš„ç±»ï¼Œè¯¥å‡½æ•°æœ€ç»ˆä¼šåœ¨<code>/sys/class</code>ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º<code>hellocls</code>çš„æ–‡ä»¶å¤¹ã€‚<strong>device_create</strong>å‡½æ•°å°†è®¾å¤‡é©±åŠ¨å­˜æ”¾åˆ°<code>hellocls</code>ç±»ä¸­ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„è®¾å¤‡æ–‡ä»¶ã€‚</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hello_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> result<span class="token punctuation">;</span>	
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"hello_init \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	result <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span> major<span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hello_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"register_chrdev fail \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	cls <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span> <span class="token string">"hellocls"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printk</span><span class="token punctuation">(</span>KERN_ERR <span class="token string">"class_create() failed for cls\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out_err_1<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	devno <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span> minor<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	class_dev <span class="token operator">=</span> <span class="token function">device_create</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> devno<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"hellodev"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>class_dev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		result <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>class_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> out_err_2<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
out_err_2<span class="token operator">:</span>
	<span class="token function">class_destroy</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
out_err_1<span class="token operator">:</span>
	<span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> 	result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hello_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"hello_exit \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">device_destroy</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> devno<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">class_destroy</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>major<span class="token punctuation">,</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_239"></a>å®éªŒç»“æœ</h2> 
<p>â€ƒâ€ƒæµ‹è¯•ç¨‹åºå¦‚ä¸‹ï¼Œæ‰“å¼€<code>/dev/hellodev</code>å­—ç¬¦è®¾å¤‡ã€‚ç´§æ¥ç€å…³é—­æ‰ã€‚</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> fd<span class="token punctuation">;</span>
	fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/hellodev"</span><span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open fail \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open ok \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"close ok \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>â€ƒâ€ƒåŠ è½½æ¨¡å—ï¼Œç”¨æˆ·ç©ºé—´ç¼–è¯‘æµ‹è¯•ç¨‹åºã€‚è¿è¡Œæµ‹è¯•ç¨‹åºå¯¹é©±åŠ¨è¿›è¡Œæ‰“å¼€å’Œå…³é—­çš„æ“ä½œã€‚æ—¥å¿—å¯ä»¥çœ‹åˆ°é©±åŠ¨ä¸­çš„<strong>hello_open</strong>ï¼Œ<strong>hello_release</strong>éƒ½è¢«æ­£å¸¸è°ƒç”¨ã€‚</p> 
<pre><code class="prism language-shell">root@ubuntu:<span class="token comment"># insmod ./hello.ko</span>
root@ubuntu:<span class="token comment"># gcc ./test.c </span>
root@ubuntu:<span class="token comment"># ./a.out </span>
<span class="token function">open</span> ok 
close ok 
root@ubuntu:<span class="token comment"># dmesg</span>
<span class="token punctuation">[</span><span class="token number">170236.680298</span><span class="token punctuation">]</span> hello_exit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">170280.990839</span><span class="token punctuation">]</span> hello_init 
<span class="token punctuation">[</span><span class="token number">222202.880295</span><span class="token punctuation">]</span> hello_open<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">222202.880418</span><span class="token punctuation">]</span> hello_release<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>â€ƒâ€ƒè¿›å…¥åˆ°ç³»ç»Ÿçš„ç±»ç›®å½•ï¼ŒæŸ¥çœ‹devæ–‡ä»¶å’Œueventæ–‡ä»¶ã€‚å…¶ä¸­è®°å½•çš„å°±æ˜¯é©±åŠ¨æ¨¡å—ä¸­æ³¨å†Œçš„è®¾å¤‡å·ã€‚</p> 
<pre><code class="prism language-shell">root@ubuntu:<span class="token comment"># cd /sys/class//hellocls/hellodev</span>
root@ubuntu:<span class="token comment"># $ cat dev</span>
<span class="token number">237</span>:0
root@ubuntu:<span class="token comment"># cat uevent </span>
<span class="token assign-left variable">MAJOR</span><span class="token operator">=</span><span class="token number">237</span>
<span class="token assign-left variable">MINOR</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">DEVNAME</span><span class="token operator">=</span>hellodev
root@ubuntu:<span class="token comment"># ll /dev/hellodev </span>
crw------- <span class="token number">1</span> root root <span class="token number">237</span>, <span class="token number">0</span> Sep <span class="token number">17</span> 06:11 /dev/hellodev
</code></pre> 
<p>â€ƒâ€ƒé‚£ä¹ˆæœ¬ç¯‡åšå®¢å°±åˆ°æ­¤ç»“æŸäº†ï¼Œè¿™é‡Œåªæ˜¯è®°å½•äº†ä¸€äº›æˆ‘ä¸ªäººçš„å­¦ä¹ ç¬”è®°ï¼Œå…¶ä¸­å­˜åœ¨å¤§é‡æˆ‘è‡ªå·±çš„ç†è§£ã€‚æ–‡ä¸­æ‰€è¿°ä¸ä¸€å®šæ˜¯å®Œå…¨æ­£ç¡®çš„ï¼Œå¯èƒ½æœ‰çš„åœ°æ–¹æˆ‘è‡ªå·±ä¹Ÿç†è§£é”™äº†ã€‚å¦‚æœæœ‰äº›é”™çš„åœ°æ–¹ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£ã€‚å¦‚æœ‰é—®é¢˜ç›´æ¥åœ¨å¯¹åº”çš„åšå®¢è¯„è®ºåŒºæŒ‡å‡ºå³å¯ï¼Œä¸éœ€è¦ç§èŠæˆ‘ã€‚æˆ‘ä»¬äº¤æµçš„å†…å®¹ç•™ä¸‹æ¥ä¹Ÿæœ‰åŠ©äºå…¶ä»–äººæŸ¥çœ‹ï¼Œè¯´ä¸ä¸€å®šä¹Ÿæœ‰å…¶ä»–äººé‡åˆ°äº†åŒæ ·çš„é—®é¢˜å‘¢ğŸ˜‚ã€‚</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ff1f8b19e1e1b0fd47f25fb029f9dfb0/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">STM32cubeMxç³»åˆ—å°ç™½å­¦ä¹ æ•™ç¨‹ï¼ˆä¸‰ï¼‰â€”â€”å¤–éƒ¨ä¸­æ–­</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/94289864a923497a463a8840cd7c71d6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">web ç«¯ vite é…ç½® px è½¬ rem</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>