<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python脚本实战【大麦网】抢票程序，我终于可以去看我杰哥的演唱会啦！ - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Python脚本实战【大麦网】抢票程序，我终于可以去看我杰哥的演唱会啦！" />
<meta property="og:description" content="前言 大麦网，是中国综合类现场娱乐票务营销平台，业务覆盖演唱会、 话剧、音乐剧、体育赛事等领域。
但是因为票数有限，还有黄牛们不能丢了饭碗，所以导致了，很多人都抢不到票
那么，今天带大家用Python来制作一个自动抢票的脚本小程序
知识点： 面向对象编程selenium 操作浏览器pickle 保存和读取Cookie实现免登陆time 做延时操作os 创建文件，判断文件是否存在 开发环境： 版 本：anaconda5.2.0（python3.6.5）编辑器：pycharm 先导入本次所需的模块 import os import time import pickle from time import sleep from selenium import webdriver 第一步，实现免登录 确定目标，设置全局变量
# 大麦网主页 damai_url = &#34;https://www.damai.cn/&#34; # 登录页 login_url = &#34;https://passport.damai.cn/login?ru=https%3A%2F%2Fwww.damai.cn%2F&#34; # 抢票目标页 target_url = &#39;https://detail.damai.cn/item.htm?spm=a2oeg.search_category.0.0.77f24d15RWgT4o&amp;id=654534889506&amp;clicktitle=%E5%A4%A7%E4%BC%97%E7 初始化加载
class Concert: def __init__(self): self.status = 0 # 状态,表示如今进行到何种程度 self.login_method = 1 # {0:模拟登录,1:Cookie登录}自行选择登录方式 self.driver = webdriver.Chrome(executable_path=&#39;chromedriver.exe&#39;) # 默认Chrome浏览器 登录调用设置cookie
~~~python def set_cookie(self): self." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5da097fb06efe1758fcdeadc2bb6d4d7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-18T11:47:21+08:00" />
<meta property="article:modified_time" content="2023-05-18T11:47:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python脚本实战【大麦网】抢票程序，我终于可以去看我杰哥的演唱会啦！</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>前言</h3> 
<p>大麦网，是中国综合类现场娱乐票务营销平台，业务覆盖演唱会、 话剧、音乐剧、体育赛事等领域。</p> 
<p>但是因为票数有限，还有黄牛们不能丢了饭碗，所以导致了，很多人都抢不到票</p> 
<p>那么，今天带大家用Python来制作一个自动抢票的脚本小程序</p> 
<h3>知识点：</h3> 
<ul><li>面向对象编程</li><li>selenium 操作浏览器</li><li>pickle 保存和读取Cookie实现免登陆</li><li>time 做延时操作</li><li>os 创建文件，判断文件是否存在</li></ul> 
<p></p> 
<h3>开发环境：</h3> 
<ul><li>版 本：anaconda5.2.0（python3.6.5）</li><li>编辑器：pycharm</li></ul> 
<h3>先导入本次所需的模块</h3> 
<pre><code>import os
import time
import pickle
from time import sleep
from selenium import webdriver</code></pre> 
<h3>第一步，实现免登录</h3> 
<p><strong>确定目标，设置全局变量</strong></p> 
<pre><code># 大麦网主页
damai_url = "https://www.damai.cn/"
# 登录页
login_url = "https://passport.damai.cn/login?ru=https%3A%2F%2Fwww.damai.cn%2F"
# 抢票目标页
target_url = 'https://detail.damai.cn/item.htm?spm=a2oeg.search_category.0.0.77f24d15RWgT4o&amp;id=654534889506&amp;clicktitle=%E5%A4%A7%E4%BC%97%E7</code></pre> 
<p><strong>初始化加载</strong></p> 
<pre><code>class Concert:
    def __init__(self):
        self.status = 0         # 状态,表示如今进行到何种程度
        self.login_method = 1   # {0:模拟登录,1:Cookie登录}自行选择登录方式
        self.driver = webdriver.Chrome(executable_path='chromedriver.exe')        # 默认Chrome浏览器</code></pre> 
<p><strong>登录调用设置cookie</strong></p> 
<pre><code>~~~python
def set_cookie(self):
    self.driver.get(damai_url)
    print("###请点击登录###")
    while self.driver.title.find('大麦网-全球演出赛事官方购票平台') != -1:
        sleep(1)
    print('###请扫码登录###')

    while self.driver.title != '大麦网-全球演出赛事官方购票平台-100%正品、先付先抢、在线选座！':
       sleep(1)
    print("###扫码成功###")
    pickle.dump(self.driver.get_cookies(), open("cookies.pkl", "wb"))
    print("###Cookie保存成功###")
    self.driver.get(target_url)
~~~</code></pre> 
<p><strong>获取cookie</strong></p> 
<pre><code>~~~python
def get_cookie(self):
    try:
        cookies = pickle.load(open("cookies.pkl", "rb"))  # 载入cookie
        for cookie in cookies:
            cookie_dict = {
                'domain':'.damai.cn',  # 必须有，不然就是假登录
                'name': cookie.get('name'),
                'value': cookie.get('value')
            }
            self.driver.add_cookie(cookie_dict)
        print('###载入Cookie###')
    except Exception as e:
        print(e)
~~~</code></pre> 
<p><strong>登录</strong></p> 
<pre><code>    def login(self):
        if self.login_method==0:
            self.driver.get(login_url)                                
            # 载入登录界面
            print('###开始登录###')

        elif self.login_method==1:
            if not os.path.exists('cookies.pkl'):                     
            # 如果不存在cookie.pkl,就获取一下
                self.set_cookie()
            else:
                self.driver.get(target_url)
                self.get_cookie()</code></pre> 
<p><strong>打开浏览器</strong></p> 
<pre><code>def enter_concert(self):
    """打开浏览器"""
    print('###打开浏览器，进入大麦网###')
    # self.driver.maximize_window()           # 最大化窗口
    # 调用登陆
    self.login()                            # 先登录再说
    self.driver.refresh()                   # 刷新页面
    self.status = 2                         # 登录成功标识
    print("###登录成功###")
    # 后续德云社可以讲
    if self.isElementExist('/html/body/div[2]/div[2]/div/div/div[3]/div[2]'):
        self.driver.find_element_by_xpath('/html/body/div[2]/div[2]/div/div/div[3]/div[2]').click()</code></pre> 
<h3>第二步，抢票并下单</h3> 
<p><strong>判断元素是否存在</strong></p> 
<pre><code>def isElementExist(self, element):
    flag = True
    browser = self.driver
    try:
        browser.find_element_by_xpath(element)
        return flag

    except:
        flag = False
        return flag</code></pre> 
<p><strong>选票操作</strong></p> 
<pre><code>def choose_ticket(self):
    if self.status == 2:                  #登录成功入口
        print("="*30)
        print("###开始进行日期及票价选择###")
        while self.driver.title.find('确认订单') == -1:           # 如果跳转到了订单结算界面就算这步成功了，否则继续执行此步
            try:
                buybutton = self.driver.find_element_by_class_name('buybtn').text
                if buybutton == "提交缺货登记":
                    # 改变现有状态
                    self.status=2
                    self.driver.get(target_url)
                    print('###抢票未开始，刷新等待开始###')
                    continue
                elif buybutton == "立即预定":
                    self.driver.find_element_by_class_name('buybtn').click()
                    # 改变现有状态
                    self.status = 3
                elif buybutton == "立即购买":
                    self.driver.find_element_by_class_name('buybtn').click()
                    # 改变现有状态
                    self.status = 4
                # 选座购买暂时无法完成自动化
                elif buybutton == "选座购买":
                    self.driver.find_element_by_class_name('buybtn').click()
                    self.status = 5
            except:
                print('###未跳转到订单结算界面###')
            title = self.driver.title
            if title == '选座购买':
                # 实现选座位购买的逻辑
                self.choice_seats()
            elif title == '确认订单':
                while True:
                    # 如果标题为确认订单
                    print('waiting ......')
                    if self.isElementExist('//*[@id="container"]/div/div[9]/button'):
                        self.check_order()
                        break</code></pre> 
<p><strong>选择座位</strong></p> 
<pre><code>    def choice_seats(self):
        while self.driver.title == '选座购买':
            while self.isElementExist('//*[@id="app"]/div[2]/div[2]/div[1]/div[2]/img'):
                # 座位手动选择 选中座位之后//*[@id="app"]/div[2]/div[2]/div[1]/div[2]/img 就会消失
                print('请快速的选择您的座位！！！')
            # 消失之后就会出现 //*[@id="app"]/div[2]/div[2]/div[2]/div
            while self.isElementExist('//*[@id="app"]/div[2]/div[2]/div[2]/div'):
                # 找到之后进行点击确认选座
                self.driver.find_element_by_xpath('//*[@id="app"]/div[2]/div[2]/div[2]/button').click()</code></pre> 
<p><strong>下单操作</strong></p> 
<pre><code>def check_order(self):
    if self.status in [3,4,5]:
        print('###开始确认订单###')
        try:
            # 默认选第一个购票人信息
            self.driver.find_element_by_xpath('//*[@id="container"]/div/div[2]/div[2]/div[1]/div/label').click()
        except Exception as e:
            print("###购票人信息选中失败，自行查看元素位置###")
            print(e)
        # 最后一步提交订单
        time.sleep(0.5)  # 太快会影响加载，导致按钮点击无效
        self.driver.find_element_by_xpath('//div[@class = "w1200"]//div[2]//div//div[9]//button[1]').click()</code></pre> 
<p><strong>抢票完成，退出</strong></p> 
<pre><code>def finish(self):
    self.driver.quit()</code></pre> 
<p><strong>测试代码是否成功</strong></p> 
<pre><code>if __name__ == '__main__':
    try:
        con = Concert()             # 具体如果填写请查看类中的初始化函数
        con.enter_concert()         # 打开浏览器
        con.choose_ticket()         # 开始抢票

    except Exception as e:
        print(e)
        con.finish()</code></pre> 
<h3>最后看下效果如何</h3> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/5c/36/pw5vwZ1n_o.jpg"></p> 
<p></p> 
<h3>  知道你对python感兴趣，所以给你准备了下面的资料~</h3> 
<p> 这份完整版的Python完整源码已经上传，朋友们如果需要可以点击链接免费领取或者滑到最后扫描二v码加我耗油【<strong><code>保证100%免费</code></strong>】</p> 
<p><img alt="" src="https://images2.imgbox.com/e0/66/GOtMdDtZ_o.jpg"></p> 
<p></p> 
<h3><strong>如果你是零基础需要python学习资源我也可以免费分享，保证100%免费！！！</strong></h3> 
<p>需要的话可以点击这里<strong>👉</strong><a href="https://mp.weixin.qq.com/s/UVxw0daFCgAMFhz9cfrjAQ" rel="nofollow" title="Python学习路线（2023修正版）附涉及资料">Python学习路线（2023修正版）附涉及资料</a> （安全链接，放心点击）</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e12dfd70ecb9b922ad523c803f090b8a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Jetson TX2 NX(Ubuntu 18.04) &#43; ROS melodic &#43; turtlebot功能包 &#43; realsense d455 &#43; ORB-SLAM2</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5bc34e5bf4ee0cd84ebda2bd3c9f7cfe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ChatGPT得到Kubernetes一些概念</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>