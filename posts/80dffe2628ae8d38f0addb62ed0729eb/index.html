<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32驱动HC-SR04超声波模块 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32驱动HC-SR04超声波模块" />
<meta property="og:description" content="STM32学习笔记——HC-SR04超声波测距模块 碰巧学校老师要求做个HC-SR04超声波的实验，笔者在完成实验报告的同时，也顺带完成一篇STM32驱动超声波模块记录。
HC-SR04模块使用 STM32学习笔记——HC-SR04超声波测距模块前言一、HC-SR04介绍二、使用步骤1.接口定义2.阅读时序图3.原理4.代码 前言 HC-SR04作为简单的外设模块，广泛应用于简单的课设项目中，十分适合入门STM32。
一、HC-SR04介绍 HC-SR04的介绍，这里就不做累述了，大家可以上某宝上找店家要下用户手册，或者到其他博主的博客中看个大概的介绍。
二、使用步骤 1.接口定义 VCC -------&gt; 5V TRIG -------&gt;	PA6 ECHO -------&gt;	PA7 GND -------&gt;	GND TRIG和ECHO两个接口也可以使用其他的IO口继续驱动，在这篇文章中，博主用的是PA6和PA7。当然也可以使用其他的IO口，只需要所使用的IO口可以输出输入高低电平即可。
2.阅读时序图 如图，驱动HC-SR04需要先向TRIG口输入一段超过10us的高电平。此时模块会自动输出脉冲信号来检测是否接收到了信号的返回。若接收到了返回信号，则会将ECHO段拉高并持续一段时间，而持续的时间便是超声波信号发出到接收到返回的超声波信号的时间。
3.原理 原理：IO口发送触发信号拉高Trig，延迟超过10us之后，再拉低Trig，作为超声波模块的启动信号，此时模块不断自动发出一段40khz的信号，当收到返回的超声波信号时，ECHO口则输出回响信号 。回响信号的脉冲宽度与所测的距离成正比。由此通过发射信号到收到的回响信号时间间隔可以计算得到距离.
4.代码 hscr.c下的代码：
#include &#34;hcsr.h&#34; void TIM2_Count_Configuration(void) { TIM_TimeBaseInitTypeDef TIM_TimeBaseStructure; RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE); TIM_TimeBaseStructure.TIM_Period = 0xFFFF; //999&#43;1 =1000 TIM_TimeBaseStructure.TIM_Prescaler = 71; //71&#43;1= 72分频 //TIM_TimeBaseStructure.TIM_ClockDivision = 0x0; TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up; TIM_TimeBaseInit(TIM2, &amp;TIM_TimeBaseStructure); TIM_Cmd(TIM2, ENABLE); //暂时先关闭TIM2时钟，等全部初始化结束后正式使用定时器前再开启 RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, DISABLE); } //PB6(output):TRIG PB7(input):ECHO void HCSR04_GPIO_Configuration(void) { GPIO_InitTypeDef GPIO_InitStructure; RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB, ENABLE); GPIO_InitStructure." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/80dffe2628ae8d38f0addb62ed0729eb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-24T15:11:47+08:00" />
<meta property="article:modified_time" content="2021-10-24T15:11:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32驱动HC-SR04超声波模块</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="STM32HCSR04_0"></a>STM32学习笔记——HC-SR04超声波测距模块</h2> 
<p>碰巧学校老师要求做个HC-SR04超声波的实验，笔者在完成实验报告的同时，也顺带完成一篇STM32驱动超声波模块记录。<br> </p> 
<div class="toc"> 
 <h4>HC-SR04模块使用</h4> 
 <ul><li><a href="#STM32HCSR04_0" rel="nofollow">STM32学习笔记——HC-SR04超声波测距模块</a></li><li><a href="#_9" rel="nofollow">前言</a></li><li><a href="#HCSR04_13" rel="nofollow">一、HC-SR04介绍</a></li><li><a href="#_19" rel="nofollow">二、使用步骤</a></li><li><ul><li><a href="#1_20" rel="nofollow">1.接口定义</a></li><li><a href="#2_32" rel="nofollow">2.阅读时序图</a></li><li><a href="#3_37" rel="nofollow">3.原理</a></li><li><a href="#4_48" rel="nofollow">4.代码</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<h2><a id="_9"></a>前言</h2> 
<p><font color="4" size="4">HC-SR04作为简单的外设模块，广泛应用于简单的课设项目中，十分适合入门STM32。</font></p> 
<h2><a id="HCSR04_13"></a>一、HC-SR04介绍</h2> 
<p><font color="4" size="4">HC-SR04的介绍，这里就不做累述了，大家可以上某宝上找店家要下用户手册，或者到其他博主的博客中看个大概的介绍。</font></p> 
<h2><a id="_19"></a>二、使用步骤</h2> 
<h3><a id="1_20"></a>1.接口定义</h3> 
<pre><code class="prism language-c">VCC      <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>      <span class="token number">5</span>V
TRIG      <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>		PA6
ECHO      <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>		PA7
GND      <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>		GND
</code></pre> 
<p><font color="4" size="4">TRIG和ECHO两个接口也可以使用其他的IO口继续驱动，在这篇文章中，博主用的是PA6和PA7。当然也可以使用其他的IO口，只需要所使用的IO口可以输出输入高低电平即可。</font></p> 
<h3><a id="2_32"></a>2.阅读时序图</h3> 
<p><img src="https://images2.imgbox.com/18/d0/nPAIPIX8_o.png" alt="在这里插入图片描述"><br> <font color="4" size="4">如图，驱动HC-SR04需要先向TRIG口输入一段超过10us的高电平。此时模块会自动输出脉冲信号来检测是否接收到了信号的返回。若接收到了返回信号，则会将ECHO段拉高并持续一段时间，而持续的时间便是超声波信号发出到接收到返回的超声波信号的时间。</font></p> 
<h3><a id="3_37"></a>3.原理</h3> 
<p><img src="https://images2.imgbox.com/bb/c9/gWO6Oryp_o.png" alt="在这里插入图片描述"></p> 
<p><font color="4" size="4">原理：IO口发送触发信号拉高Trig，延迟超过10us之后，再拉低Trig，作为超声波模块的启动信号，此时模块不断自动发出一段40khz的信号，当收到返回的超声波信号时，ECHO口则输出回响信号 。回响信号的脉冲宽度与所测的距离成正比。由此通过发射信号到收到的回响信号时间间隔可以计算得到距离.</font></p> 
<h3><a id="4_48"></a>4.代码</h3> 
<p><font color="4" size="4">hscr.c下的代码：</font></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"hcsr.h"</span></span>

<span class="token keyword">void</span> <span class="token function">TIM2_Count_Configuration</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TIM_TimeBaseInitTypeDef TIM_TimeBaseStructure<span class="token punctuation">;</span>
	
	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_TIM2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_Period <span class="token operator">=</span> <span class="token number">0xFFFF</span><span class="token punctuation">;</span>  <span class="token comment">//999+1 =1000</span>
	TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_Prescaler <span class="token operator">=</span> <span class="token number">71</span><span class="token punctuation">;</span>  <span class="token comment">//71+1= 72分频</span>
	<span class="token comment">//TIM_TimeBaseStructure.TIM_ClockDivision = 0x0;</span>
	TIM_TimeBaseStructure<span class="token punctuation">.</span>TIM_CounterMode <span class="token operator">=</span> TIM_CounterMode_Up<span class="token punctuation">;</span>
	<span class="token function">TIM_TimeBaseInit</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_TimeBaseStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//暂时先关闭TIM2时钟，等全部初始化结束后正式使用定时器前再开启</span>
	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_TIM2<span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//PB6(output):TRIG   PB7(input):ECHO</span>
<span class="token keyword">void</span> <span class="token function">HCSR04_GPIO_Configuration</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>

	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOB<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_6<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_7<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN_FLOATING<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



</code></pre> 
<p><font color="4" size="4">代码分析：该段代码初始化HC-SR04所使用到的IO口和时钟。并没有什么难度。</font></p> 
<p><font color="4" size="4">main. c的代码如下：</font></p> 
<pre><code class="prism language-c">  	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>	

		<span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		TRIG_H<span class="token punctuation">;</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		TRIG_L<span class="token punctuation">;</span>
		<span class="token comment">//printf("HERE");</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>ECHO <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">TIM_SetCounter</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token keyword">while</span><span class="token punctuation">(</span>ECHO <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		time <span class="token operator">=</span> <span class="token function">TIM_GetCounter</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//printf("time = ",time);</span>
		distance <span class="token operator">=</span> time <span class="token operator">*</span> <span class="token number">0.017</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Distance = %.2fcm\n"</span><span class="token punctuation">,</span> distance<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p><font color="4" size="4">代码分析：此段代码的重点在于两个while循环，两个while循环都是为了检查ECHO的输出以及查询其高电平持续的时间，通过持续时间算出测量距离。</font></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7f3ba2575206b2146ffbee239773c56a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">HDU 1998 奇数阶魔方（规律）【1024打卡】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/05f4352dfe8198914e1deac780910a83/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">solidworks路径配合如何使用？七步教会你</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>