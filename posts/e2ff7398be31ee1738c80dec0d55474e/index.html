<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>OpenCV DNN模块推理YOLOv5 ONNX模型方法 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="OpenCV DNN模块推理YOLOv5 ONNX模型方法" />
<meta property="og:description" content="文章目录 概述1. 环境部署`YOLOv5`算法`ONNX`模型获取`opencv-python`模块安装 2.关键代码2.1 模型加载2.2 图片数据预处理2.3 模型推理2.4 推理结果后处理2.4.1 NMS2.4.2 score_threshold过滤2.4.3 bbox坐标转换与还原 3. 示例代码(可运行)3.1 未封装3.2 封装成类调用 概述 本文档主要描述python平台，使用opencv-python深度神经网络模块dnn,推理YOLOv5模型的方法。
文档主要包含以下内容：
opencv-python模块的安装YOLOv5模型格式的说明ONNX格式模型的加载图片数据的预处理模型推理推理结果后处理，包括NMS,cxcywh坐标转换为xyxy坐标等关键方法的调用与参数说明完整的示例代码 1. 环境部署 YOLOv5算法ONNX模型获取 可通过官方链接下载YOLOv5的官方预训练模型，模型格式为pt.下载链接
YOLOv5官方项目提供了pt格式模型转换为ONNX格式模型的脚本，项目链接
模型导出指令：
python export --weights yolov5s.pt --include onnx 注：导出文件执行指令所需环境安装配置参考官方项目README文档即可，不在赘述。
opencv-python模块安装 创建虚拟环境并激活
conda create -n opencv python=3.8 -y conda activate opencv pip安装opencv-python模块
pip install opencv-python 注: 通过pip安装opencv-python模块时，默认安装仅支持CPU推理，如需支持GPU推理，需从源码编译安装，具体安装方法较复杂，这里不在赘述。
2.关键代码 2.1 模型加载 opencv-python模块提供了readNetFromONNX方法，用于加载ONNX格式模型。
import cv2 cv2.dnn.readNetFromONNX(model_path) 2.2 图片数据预处理 数据预处理步骤包括resize，归一化，颜色通道转换，NCWH维度转换等。
resize之前，有一个非常常用的trick来处理非方形的图片，即计算图形的最长边，以此最长边为基础，创建一个正方形，并将原图形放置到左上角，剩余部分用黑色填充，这样做的好处是，不会改变原图形的长宽比，同时也不会改变原图形的内容。
# image preprocessing, the trick is to make the frame to be a square but not twist the image row, col, _ = frame." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/e2ff7398be31ee1738c80dec0d55474e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-25T21:06:21+08:00" />
<meta property="article:modified_time" content="2023-07-25T21:06:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">OpenCV DNN模块推理YOLOv5 ONNX模型方法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">概述</a></li><li><a href="#1__17" rel="nofollow">1. 环境部署</a></li><li><ul><li><a href="#YOLOv5ONNX_19" rel="nofollow">`YOLOv5`算法`ONNX`模型获取</a></li><li><a href="#opencvpython_31" rel="nofollow">`opencv-python`模块安装</a></li></ul> 
  </li><li><a href="#2_47" rel="nofollow">2.关键代码</a></li><li><ul><li><a href="#21__49" rel="nofollow">2.1 模型加载</a></li><li><a href="#22__59" rel="nofollow">2.2 图片数据预处理</a></li><li><a href="#23__86" rel="nofollow">2.3 模型推理</a></li><li><a href="#24__127" rel="nofollow">2.4 推理结果后处理</a></li><li><ul><li><a href="#241_NMS_131" rel="nofollow">2.4.1 NMS</a></li><li><a href="#242_score_threshold_146" rel="nofollow">2.4.2 score_threshold过滤</a></li><li><a href="#243_bbox_150" rel="nofollow">2.4.3 bbox坐标转换与还原</a></li></ul> 
  </li></ul> 
  </li><li><a href="#3__173" rel="nofollow">3. 示例代码(可运行)</a></li><li><ul><li><a href="#31__177" rel="nofollow">3.1 未封装</a></li><li><a href="#32__413" rel="nofollow">3.2 封装成类调用</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>概述</h2> 
<p>本文档主要描述<code>python</code>平台，使用<code>opencv-python</code>深度神经网络模块<code>dnn</code>,推理<code>YOLOv5</code>模型的方法。</p> 
<p>文档主要包含以下内容：</p> 
<ul><li><code>opencv-python</code>模块的安装</li><li><code>YOLOv5</code>模型格式的说明</li><li><code>ONNX</code>格式模型的加载</li><li>图片数据的预处理</li><li>模型推理</li><li>推理结果后处理，包括<code>NMS</code>,<code>cxcywh</code>坐标转换为<code>xyxy</code>坐标等</li><li>关键方法的调用与参数说明</li><li>完整的示例代码</li></ul> 
<h2><a id="1__17"></a>1. 环境部署</h2> 
<h3><a id="YOLOv5ONNX_19"></a><code>YOLOv5</code>算法<code>ONNX</code>模型获取</h3> 
<p>可通过官方链接下载YOLOv5的官方预训练模型，模型格式为<code>pt</code>.<a href="https://github.com/ultralytics/yolov5/releases/download/v6.1/yolov5s.pt">下载链接</a><br> <code>YOLOv5</code>官方项目提供了<code>pt</code>格式模型转换为<code>ONNX</code>格式模型的脚本，<a href="https://github.com/ultralytics/yolov5">项目链接</a></p> 
<p>模型导出指令：</p> 
<pre><code class="prism language-bash">python <span class="token builtin class-name">export</span> <span class="token parameter variable">--weights</span> yolov5s.pt <span class="token parameter variable">--include</span> onnx
</code></pre> 
<blockquote> 
 <p>注：导出文件执行指令所需环境安装配置参考官方项目<code>README</code>文档即可，不在赘述。</p> 
</blockquote> 
<h3><a id="opencvpython_31"></a><code>opencv-python</code>模块安装</h3> 
<ol><li> <p>创建虚拟环境并激活</p> <pre><code class="prism language-bash">conda create <span class="token parameter variable">-n</span> opencv <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.8</span> <span class="token parameter variable">-y</span>
conda activate opencv
</code></pre> </li><li> <p><code>pip</code>安装<code>opencv-python</code>模块</p> <pre><code class="prism language-bash">pip <span class="token function">install</span> opencv-python
</code></pre> 
  <blockquote> 
   <p>注: 通过<code>pip</code>安装<code>opencv-python</code>模块时，默认安装仅支持<code>CPU</code>推理，如需支持<code>GPU</code>推理，需从源码编译安装，具体安装方法较复杂，这里不在赘述。</p> 
  </blockquote> </li></ol> 
<h2><a id="2_47"></a>2.关键代码</h2> 
<h3><a id="21__49"></a>2.1 模型加载</h3> 
<p><code>opencv-python</code>模块提供了<code>readNetFromONNX</code>方法，用于加载<code>ONNX</code>格式模型。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>readNetFromONNX<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="22__59"></a>2.2 图片数据预处理</h3> 
<p>数据预处理步骤包括resize，归一化，颜色通道转换，NCWH维度转换等。</p> 
<p><code>resize</code>之前，有一个非常常用的trick来处理非方形的图片，即计算图形的最长边，以此最长边为基础，创建一个正方形，并将原图形放置到左上角，剩余部分用黑色填充，这样做的好处是，不会改变原图形的长宽比，同时也不会改变原图形的内容。</p> 
<pre><code class="prism language-python"> <span class="token comment"># image preprocessing, the trick is to make the frame to be a square but not twist the image</span>
row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> _ <span class="token operator">=</span> frame<span class="token punctuation">.</span>shape  <span class="token comment"># get the row and column of the origin frame array</span>
_max <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col<span class="token punctuation">)</span>  <span class="token comment"># get the max value of row and column</span>
input_image <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>_max<span class="token punctuation">,</span> _max<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  <span class="token comment"># create a new array with the max value</span>
input_image<span class="token punctuation">[</span><span class="token punctuation">:</span>row<span class="token punctuation">,</span> <span class="token punctuation">:</span>col<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> frame  <span class="token comment"># paste the original frame  to make the input_image to be a square</span>
</code></pre> 
<p>完成图片的填充后,继续执行resize，归一化，颜色通道转换等操作。</p> 
<pre><code class="prism language-python">blob <span class="token operator">=</span> cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>blobFromImage<span class="token punctuation">(</span>image<span class="token punctuation">,</span> scalefactor<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">640</span><span class="token punctuation">,</span><span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">,</span> swapRB<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> crop<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><code>image</code>: 输入图片数据,<code>numpy.ndarray</code>格式,<code>shape</code>为<code>(H,W,C)</code>,Channel顺序为<code>BGR</code>。</li><li><code>scalefactor</code>: 图片数据归一化系数，一般为<code>1/255.0</code>。</li><li><code>size</code>: 图片resize尺寸，以模型的输入要求为准，这里是<code>(640,640)</code>。</li><li><code>swapRB</code>: 是否交换颜色通道，即转换<code>BGR</code>为<code>RGB</code> <code>True</code>表示交换，<code>False</code>表示不交换，由于<code>opencv</code>读取图片数据的颜色通道顺序为<code>BGR</code>，而<code>YOLOv5</code>模型的输入要求为<code>RGB</code>，所以这里需要交换颜色通道。</li><li><code>crop</code>: 是否裁剪图片，<code>False</code>表示不裁剪。</li></ul> 
<p><code>blobFromImage</code>函数返回四维Mat对象(NCHW dimensions order),数据的shape为<code>(1,3,640,640)</code></p> 
<h3><a id="23__86"></a>2.3 模型推理</h3> 
<ol><li> <p>设置推理Backend和Target</p> <pre><code class="prism language-python">model<span class="token punctuation">.</span>setPreferableBackend<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_BACKEND_OPENCV<span class="token punctuation">)</span>
model<span class="token punctuation">.</span>setPreferableTarget<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_TARGET_CPU<span class="token punctuation">)</span>
</code></pre> <p>模型加载完成后，需要设置推理时的设备，一般情况下，推理设备为<code>CPU</code>，设置方法如下：</p> <pre><code class="prism language-python">model<span class="token punctuation">.</span>setPreferableBackend<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_BACKEND_OPENCV<span class="token punctuation">)</span>
model<span class="token punctuation">.</span>setPreferableTarget<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_TARGET_CPU<span class="token punctuation">)</span>
</code></pre> <p>当然，若此时环境中的<code>opencv-python</code>模块支持<code>GPU</code>推理，也可以设置为<code>GPU</code>推理，设置方法如下：</p> <pre><code class="prism language-python">model<span class="token punctuation">.</span>setPreferableBackend<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_BACKEND_CUDA<span class="token punctuation">)</span>
model<span class="token punctuation">.</span>setPreferableTarget<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_TARGET_CUDA<span class="token punctuation">)</span>
</code></pre> 
  <blockquote> 
   <p>注: 判断<code>opencv-python</code>模块是否支持<code>GPU</code>推理的方法如下：<code>cv2.cuda.getCudaEnabledDeviceCount()</code>,返回值大于0表示支持<code>GPU</code>推理，否则表示不支持。</p> 
  </blockquote> </li><li> <p>设置模型输入数据</p> <pre><code class="prism language-python">model<span class="token punctuation">.</span>setInput<span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
</code></pre> <p><code>blob</code>为上一步数据预处理得到的数据。</p> </li><li> <p>调用模型前向传播<code>forward</code>方法</p> <pre><code>outputs = model.forward()
</code></pre> <p><code>outputs</code>为模型推理的输出，输出格式为(1,25200,5+nc),<code>25200</code>为模型输出的网格数量，<code>5+nc</code>为每个网格预测的<code>5+nc</code>个值，<code>5</code>为<code>x,y,w,h,conf</code>，<code>nc</code>为类别数量。</p> </li></ol> 
<h3><a id="24__127"></a>2.4 推理结果后处理</h3> 
<p>由于推理结果存在大量重叠的<code>bbox</code>，需要进行<code>NMS</code>处理，后续根据每个<code>bbox</code>的置信度和用户设定的置信度阈值进行过滤，最终得到最终的<code>bbox</code>，和对应的类别、置信度。</p> 
<h4><a id="241_NMS_131"></a>2.4.1 NMS</h4> 
<p><code>opencv-python</code>模块提供了<code>NMSBoxes</code>方法，用于进行<code>NMS</code>处理。</p> 
<pre><code class="prism language-python">cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>NMSBoxes<span class="token punctuation">(</span>bboxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> score_threshold<span class="token punctuation">,</span> nms_threshold<span class="token punctuation">,</span> eta<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> top_k<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><code>bboxes</code>: <code>bbox</code>列表，<code>shape</code>为<code>(N,4)</code>，<code>N</code>为<code>bbox</code>数量，<code>4</code>为<code>bbox</code>的<code>x,y,w,h</code>。</li><li><code>scores</code>: <code>bbox</code>对应的置信度列表，<code>shape</code>为<code>(N,1)</code>，<code>N</code>为<code>bbox</code>数量。</li><li><code>score_threshold</code>: 置信度阈值，小于该阈值的<code>bbox</code>将被过滤。</li><li><code>nms_threshold</code>: <code>NMS</code>阈值</li></ul> 
<p><code>NMSBoxes</code>函数返回值为<code>bbox</code>索引列表，<code>shape</code>为<code>(M,)</code>，<code>M</code>为<code>bbox</code>数量.</p> 
<h4><a id="242_score_threshold_146"></a>2.4.2 score_threshold过滤</h4> 
<p>根据<code>NMS</code>处理后的<code>bbox</code>索引列表，过滤置信度小于<code>score_threshold</code>的<code>bbox</code>。</p> 
<h4><a id="243_bbox_150"></a>2.4.3 bbox坐标转换与还原</h4> 
<p><code>YOLOv5</code>模型输出的<code>bbox</code>坐标为<code>cxcywh</code>格式，需要转换为<code>xyxy</code>格式，此外，由于之前对图片进行了<code>resize</code>操作，所以需要将<code>bbox</code>坐标还原到原始图片的尺寸。<br> 转换方法如下：</p> 
<pre><code class="prism language-python"><span class="token comment"># 获取原始图片的尺寸(填充后)</span>
image_width<span class="token punctuation">,</span> image_height<span class="token punctuation">,</span> _ <span class="token operator">=</span> input_image<span class="token punctuation">.</span>shape
<span class="token comment"># 计算缩放比</span>
x_factor <span class="token operator">=</span> image_width <span class="token operator">/</span> INPUT_WIDTH  <span class="token comment">#  640</span>
y_factor <span class="token operator">=</span> image_height <span class="token operator">/</span> INPUT_HEIGHT <span class="token comment">#  640 </span>

<span class="token comment"># 将cxcywh坐标转换为xyxy坐标</span>
x1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">-</span> w <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> x_factor<span class="token punctuation">)</span>
y1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">-</span> h <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> y_factor<span class="token punctuation">)</span>
w <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>w <span class="token operator">*</span> x_factor<span class="token punctuation">)</span>
h <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> y_factor<span class="token punctuation">)</span>
x2 <span class="token operator">=</span> x1 <span class="token operator">+</span> w
y2 <span class="token operator">=</span> y1 <span class="token operator">+</span> h
</code></pre> 
<p><code>x1</code>,<code>y1</code>,<code>x2</code>,<code>y2</code>即为<code>bbox</code>的<code>xyxy</code>坐标。</p> 
<h2><a id="3__173"></a>3. 示例代码(可运行)</h2> 
<p>源代码一共有两份，其中一份是函数的拼接与调用，比较方便调试，另一份是封装成类，方便集成到其他项目中。</p> 
<h3><a id="31__177"></a>3.1 未封装</h3> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">"""
running the onnx model inference with opencv dnn module

"""</span>
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List

<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> time
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path


<span class="token keyword">def</span> <span class="token function">build_model</span><span class="token punctuation">(</span>model_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> cv2<span class="token punctuation">.</span>dnn_Net<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    build the model with opencv dnn module
    Args:
        model_path: the path of the model, the model should be in onnx format

    Returns:
        the model object
    """</span>
    <span class="token comment"># check if the model file exists</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> Path<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> FileNotFoundError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"model file </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_path<span class="token punctuation">}</span></span><span class="token string"> not found"</span></span><span class="token punctuation">)</span>
    model <span class="token operator">=</span> cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>readNetFromONNX<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>

    <span class="token comment"># check if the opencv-python in your environment supports cuda</span>
    cuda_available <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>getCudaEnabledDeviceCount<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>

    <span class="token keyword">if</span> cuda_available<span class="token punctuation">:</span>  <span class="token comment"># if cuda is available, use cuda</span>
        model<span class="token punctuation">.</span>setPreferableBackend<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_BACKEND_CUDA<span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>setPreferableTarget<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_TARGET_CUDA<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># if cuda is not available, use cpu</span>
        model<span class="token punctuation">.</span>setPreferableBackend<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_BACKEND_OPENCV<span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>setPreferableTarget<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_TARGET_CPU<span class="token punctuation">)</span>
    <span class="token keyword">return</span> model


<span class="token keyword">def</span> <span class="token function">inference</span><span class="token punctuation">(</span>image<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">,</span> model<span class="token punctuation">:</span> cv2<span class="token punctuation">.</span>dnn_Net<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    inference the model with the input image
    Args:
        image: the input image in numpy array format, the shape should be (height, width, channel),
        the color channels should be in GBR order, like the original opencv image format
        model: the model object

    Returns:
        the output data of the model, the shape should be (1, 25200, nc+5), nc is the number of classes
    """</span>
    <span class="token comment"># image preprocessing, include resize, normalization, channel swap like BGR to RGB, and convert to blob format</span>
    <span class="token comment"># get a 4-dimensional Mat with NCHW dimensions order.</span>
    blob <span class="token operator">=</span> cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>blobFromImage<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>INPUT_WIDTH<span class="token punctuation">,</span> INPUT_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">,</span> swapRB<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> crop<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token comment"># the alternative way to get the blob</span>
    <span class="token comment"># rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)</span>
    <span class="token comment"># input_image = cv2.resize(src=rgb, dsize=(INPUT_WIDTH, INPUT_HEIGHT))</span>
    <span class="token comment"># blob_img = np.float32(input_image) / 255.0</span>
    <span class="token comment"># input_x = blob_img.transpose((2, 0, 1))</span>
    <span class="token comment"># blob = np.expand_dims(input_x, 0)</span>

    <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>getCudaEnabledDeviceCount<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        model<span class="token punctuation">.</span>setPreferableBackend<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_BACKEND_CUDA<span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>setPreferableTarget<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_TARGET_CUDA<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        model<span class="token punctuation">.</span>setPreferableBackend<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_BACKEND_OPENCV<span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>setPreferableTarget<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_TARGET_CPU<span class="token punctuation">)</span>

    <span class="token comment"># set the input data</span>
    model<span class="token punctuation">.</span>setInput<span class="token punctuation">(</span>blob<span class="token punctuation">)</span>

    start <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># inference</span>
    outs <span class="token operator">=</span> model<span class="token punctuation">.</span>forward<span class="token punctuation">(</span><span class="token punctuation">)</span>

    end <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"inference time: "</span><span class="token punctuation">,</span> end <span class="token operator">-</span> start<span class="token punctuation">)</span>

    <span class="token comment"># the shape of the output data is (1, 25200, nc+5), nc is the number of classes</span>
    <span class="token keyword">return</span> outs


<span class="token keyword">def</span> <span class="token function">xywh_to_xyxy</span><span class="token punctuation">(</span>bbox_xywh<span class="token punctuation">,</span> image_width<span class="token punctuation">,</span> image_height<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Convert bounding box coordinates from (center_x, center_y, width, height) to (x_min, y_min, x_max, y_max) format.

    Parameters:
        bbox_xywh (list or tuple): Bounding box coordinates in (center_x, center_y, width, height) format.
        image_width (int): Width of the image.
        image_height (int): Height of the image.

    Returns:
        tuple: Bounding box coordinates in (x_min, y_min, x_max, y_max) format.
    """</span>
    center_x<span class="token punctuation">,</span> center_y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token operator">=</span> bbox_xywh
    x_min <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>center_x <span class="token operator">-</span> width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    y_min <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>center_y <span class="token operator">-</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    x_max <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>image_width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>center_x <span class="token operator">+</span> width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    y_max <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>image_height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>center_y <span class="token operator">+</span> height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> x_min<span class="token punctuation">,</span> y_min<span class="token punctuation">,</span> x_max<span class="token punctuation">,</span> y_max


<span class="token keyword">def</span> <span class="token function">wrap_detection</span><span class="token punctuation">(</span>
        input_image<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">,</span>
        output_data<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">,</span>
        labels<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        confidence_threshold<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.6</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>List<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># the shape of the output_data is (25200,5+nc),</span>
    <span class="token comment"># the first 5 elements are [x, y, w, h, confidence], the rest are prediction scores of each class</span>

    image_width<span class="token punctuation">,</span> image_height<span class="token punctuation">,</span> _ <span class="token operator">=</span> input_image<span class="token punctuation">.</span>shape
    x_factor <span class="token operator">=</span> image_width <span class="token operator">/</span> INPUT_WIDTH
    y_factor <span class="token operator">=</span> image_height <span class="token operator">/</span> INPUT_HEIGHT

    <span class="token comment"># transform the output_data[:, 0:4] from (x, y, w, h) to (x_min, y_min, x_max, y_max)</span>

    indices <span class="token operator">=</span> cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>NMSBoxes<span class="token punctuation">(</span>output_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> output_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span>

    raw_boxes <span class="token operator">=</span> output_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span>indices<span class="token punctuation">]</span>
    raw_confidences <span class="token operator">=</span> output_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span>indices<span class="token punctuation">]</span>
    raw_class_prediction_probabilities <span class="token operator">=</span> output_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">[</span>indices<span class="token punctuation">]</span>

    criteria <span class="token operator">=</span> raw_confidences <span class="token operator">&gt;</span> confidence_threshold
    raw_class_prediction_probabilities <span class="token operator">=</span> raw_class_prediction_probabilities<span class="token punctuation">[</span>criteria<span class="token punctuation">]</span>
    raw_boxes <span class="token operator">=</span> raw_boxes<span class="token punctuation">[</span>criteria<span class="token punctuation">]</span>
    raw_confidences <span class="token operator">=</span> raw_confidences<span class="token punctuation">[</span>criteria<span class="token punctuation">]</span>

    bounding_boxes<span class="token punctuation">,</span> confidences<span class="token punctuation">,</span> class_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> class_prediction_probability<span class="token punctuation">,</span> box<span class="token punctuation">,</span> confidence <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>raw_class_prediction_probabilities<span class="token punctuation">,</span> raw_boxes<span class="token punctuation">,</span>
                                                             raw_confidences<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#</span>
        <span class="token comment"># find the least and most probable classes' indices and their probabilities</span>
        <span class="token comment"># min_val, max_val, min_loc, mac_loc = cv2.minMaxLoc(class_prediction_probability)</span>
        most_probable_class_index <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>class_prediction_probability<span class="token punctuation">)</span>
        label <span class="token operator">=</span> labels<span class="token punctuation">[</span>most_probable_class_index<span class="token punctuation">]</span>
        confidence <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>confidence<span class="token punctuation">)</span>

        <span class="token comment"># bounding_boxes.append(box)</span>
        <span class="token comment"># confidences.append(confidence)</span>
        <span class="token comment"># class_ids.append(most_probable_class_index)</span>

        x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> box
        left <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> w<span class="token punctuation">)</span> <span class="token operator">*</span> x_factor<span class="token punctuation">)</span>
        top <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> h<span class="token punctuation">)</span> <span class="token operator">*</span> y_factor<span class="token punctuation">)</span>
        width <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>w <span class="token operator">*</span> x_factor<span class="token punctuation">)</span>
        height <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> y_factor<span class="token punctuation">)</span>
        bounding_box <span class="token operator">=</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">]</span>
        bounding_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>bounding_box<span class="token punctuation">)</span>
        confidences<span class="token punctuation">.</span>append<span class="token punctuation">(</span>confidence<span class="token punctuation">)</span>
        class_ids<span class="token punctuation">.</span>append<span class="token punctuation">(</span>most_probable_class_index<span class="token punctuation">)</span>

    <span class="token keyword">return</span> class_ids<span class="token punctuation">,</span> confidences<span class="token punctuation">,</span> bounding_boxes

coco_class_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"person"</span><span class="token punctuation">,</span> <span class="token string">"bicycle"</span><span class="token punctuation">,</span> <span class="token string">"car"</span><span class="token punctuation">,</span> <span class="token string">"motorcycle"</span><span class="token punctuation">,</span> <span class="token string">"airplane"</span><span class="token punctuation">,</span> <span class="token string">"bus"</span><span class="token punctuation">,</span> <span class="token string">"train"</span><span class="token punctuation">,</span> <span class="token string">"truck"</span><span class="token punctuation">,</span> <span class="token string">"boat"</span><span class="token punctuation">,</span>
                    <span class="token string">"traffic light"</span><span class="token punctuation">,</span> <span class="token string">"fire hydrant"</span><span class="token punctuation">,</span> <span class="token string">"stop sign"</span><span class="token punctuation">,</span> <span class="token string">"parking meter"</span><span class="token punctuation">,</span> <span class="token string">"bench"</span><span class="token punctuation">,</span> <span class="token string">"bird"</span><span class="token punctuation">,</span> <span class="token string">"cat"</span><span class="token punctuation">,</span>
                    <span class="token string">"dog"</span><span class="token punctuation">,</span> <span class="token string">"horse"</span><span class="token punctuation">,</span> <span class="token string">"sheep"</span><span class="token punctuation">,</span> <span class="token string">"cow"</span><span class="token punctuation">,</span> <span class="token string">"elephant"</span><span class="token punctuation">,</span> <span class="token string">"bear"</span><span class="token punctuation">,</span> <span class="token string">"zebra"</span><span class="token punctuation">,</span> <span class="token string">"giraffe"</span><span class="token punctuation">,</span> <span class="token string">"backpack"</span><span class="token punctuation">,</span>
                    <span class="token string">"umbrella"</span><span class="token punctuation">,</span> <span class="token string">"handbag"</span><span class="token punctuation">,</span> <span class="token string">"tie"</span><span class="token punctuation">,</span> <span class="token string">"suitcase"</span><span class="token punctuation">,</span> <span class="token string">"frisbee"</span><span class="token punctuation">,</span> <span class="token string">"skis"</span><span class="token punctuation">,</span> <span class="token string">"snowboard"</span><span class="token punctuation">,</span> <span class="token string">"sports ball"</span><span class="token punctuation">,</span>
                    <span class="token string">"kite"</span><span class="token punctuation">,</span> <span class="token string">"baseball bat"</span><span class="token punctuation">,</span> <span class="token string">"baseball glove"</span><span class="token punctuation">,</span> <span class="token string">"skateboard"</span><span class="token punctuation">,</span> <span class="token string">"surfboard"</span><span class="token punctuation">,</span> <span class="token string">"tennis racket"</span><span class="token punctuation">,</span>
                    <span class="token string">"bottle"</span><span class="token punctuation">,</span> <span class="token string">"wine glass"</span><span class="token punctuation">,</span> <span class="token string">"cup"</span><span class="token punctuation">,</span> <span class="token string">"fork"</span><span class="token punctuation">,</span> <span class="token string">"knife"</span><span class="token punctuation">,</span> <span class="token string">"spoon"</span><span class="token punctuation">,</span> <span class="token string">"bowl"</span><span class="token punctuation">,</span> <span class="token string">"banana"</span><span class="token punctuation">,</span> <span class="token string">"apple"</span><span class="token punctuation">,</span>
                    <span class="token string">"sandwich"</span><span class="token punctuation">,</span> <span class="token string">"orange"</span><span class="token punctuation">,</span> <span class="token string">"broccoli"</span><span class="token punctuation">,</span> <span class="token string">"carrot"</span><span class="token punctuation">,</span> <span class="token string">"hot dog"</span><span class="token punctuation">,</span> <span class="token string">"pizza"</span><span class="token punctuation">,</span> <span class="token string">"donut"</span><span class="token punctuation">,</span> <span class="token string">"cake"</span><span class="token punctuation">,</span> <span class="token string">"chair"</span><span class="token punctuation">,</span>
                    <span class="token string">"couch"</span><span class="token punctuation">,</span> <span class="token string">"potted plant"</span><span class="token punctuation">,</span> <span class="token string">"bed"</span><span class="token punctuation">,</span> <span class="token string">"dining table"</span><span class="token punctuation">,</span> <span class="token string">"toilet"</span><span class="token punctuation">,</span> <span class="token string">"tv"</span><span class="token punctuation">,</span> <span class="token string">"laptop"</span><span class="token punctuation">,</span> <span class="token string">"mouse"</span><span class="token punctuation">,</span>
                    <span class="token string">"remote"</span><span class="token punctuation">,</span> <span class="token string">"keyboard"</span><span class="token punctuation">,</span> <span class="token string">"cell phone"</span><span class="token punctuation">,</span> <span class="token string">"microwave"</span><span class="token punctuation">,</span> <span class="token string">"oven"</span><span class="token punctuation">,</span> <span class="token string">"toaster"</span><span class="token punctuation">,</span> <span class="token string">"sink"</span><span class="token punctuation">,</span>
                    <span class="token string">"refrigerator"</span><span class="token punctuation">,</span> <span class="token string">"book"</span><span class="token punctuation">,</span> <span class="token string">"clock"</span><span class="token punctuation">,</span> <span class="token string">"vase"</span><span class="token punctuation">,</span> <span class="token string">"scissors"</span><span class="token punctuation">,</span> <span class="token string">"teddy bear"</span><span class="token punctuation">,</span> <span class="token string">"hair drier"</span><span class="token punctuation">,</span>
                    <span class="token string">"toothbrush"</span><span class="token punctuation">]</span>
<span class="token comment"># generate different colors for coco classes</span>
colors <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>coco_class_names<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

INPUT_WIDTH <span class="token operator">=</span> <span class="token number">640</span>
INPUT_HEIGHT <span class="token operator">=</span> <span class="token number">640</span>
CONFIDENCE_THRESHOLD <span class="token operator">=</span> <span class="token number">0.7</span>
NMS_THRESHOLD <span class="token operator">=</span> <span class="token number">0.45</span>

<span class="token keyword">def</span> <span class="token function">video_detector</span><span class="token punctuation">(</span>video_src<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>video_src<span class="token punctuation">)</span>

    <span class="token comment"># 3. inference and show the result in a loop</span>
    <span class="token keyword">while</span> cap<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        success<span class="token punctuation">,</span> frame <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        start <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> success<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token comment"># image preprocessing, the trick is to make the frame to be a square but not twist the image</span>
        row<span class="token punctuation">,</span> col<span class="token punctuation">,</span> _ <span class="token operator">=</span> frame<span class="token punctuation">.</span>shape  <span class="token comment"># get the row and column of the origin frame array</span>
        _max <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col<span class="token punctuation">)</span>  <span class="token comment"># get the max value of row and column</span>
        input_image <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>_max<span class="token punctuation">,</span> _max<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  <span class="token comment"># create a new array with the max value</span>
        input_image<span class="token punctuation">[</span><span class="token punctuation">:</span>row<span class="token punctuation">,</span> <span class="token punctuation">:</span>col<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> frame  <span class="token comment"># paste the original frame  to make the input_image to be a square</span>
        <span class="token comment"># inference</span>
        output_data <span class="token operator">=</span> inference<span class="token punctuation">(</span>input_image<span class="token punctuation">,</span> net<span class="token punctuation">)</span>  <span class="token comment"># the shape of output_data is (1, 25200, 85)</span>

        <span class="token comment"># 4. wrap the detection result</span>
        class_ids<span class="token punctuation">,</span> confidences<span class="token punctuation">,</span> boxes <span class="token operator">=</span> wrap_detection<span class="token punctuation">(</span>input_image<span class="token punctuation">,</span> output_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> coco_class_names<span class="token punctuation">)</span>

        <span class="token comment"># 5. draw the detection result on the frame</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>class_id<span class="token punctuation">,</span> confidence<span class="token punctuation">,</span> box<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>class_ids<span class="token punctuation">,</span> confidences<span class="token punctuation">,</span> boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
            color <span class="token operator">=</span> colors<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>class_id<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span><span class="token punctuation">]</span>
            label <span class="token operator">=</span> coco_class_names<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>class_id<span class="token punctuation">)</span><span class="token punctuation">]</span>

            xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height <span class="token operator">=</span> box
            cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span>xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>xmin <span class="token operator">+</span> width<span class="token punctuation">,</span> ymin <span class="token operator">+</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token comment"># cv2.rectangle(frame, box, color, 2)</span>
            <span class="token comment"># cv2.rectangle(frame, [box[0], box[1], box[2], box[3]], color, thickness=2)</span>

            <span class="token comment"># cv2.rectangle(frame, (box[0], box[1] - 20), (box[0] + 100, box[1]), color, -1)</span>
            cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        finish <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        FPS <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>finish <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>FPS<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment"># 6. show the frame</span>
        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"frame"</span><span class="token punctuation">,</span> frame<span class="token punctuation">)</span>

        <span class="token comment"># 7. press 'q' to exit</span>
        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>

    <span class="token comment"># 8. release the capture and destroy all windows</span>
    cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># there are 4 steps to use opencv dnn module to inference onnx model exported by yolov5 and show the result</span>

    <span class="token comment"># 1. load the model</span>
    model_path <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token string">"weights/yolov5s.onnx"</span><span class="token punctuation">)</span>
    net <span class="token operator">=</span> build_model<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>model_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 2. load the video capture</span>
    <span class="token comment"># video_source = 0</span>
    video_source <span class="token operator">=</span> <span class="token string">'rtsp://admin:aoto12345@192.168.8.204:554/h264/ch1/main/av_stream'</span>
    video_detector<span class="token punctuation">(</span>video_source<span class="token punctuation">)</span>

    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="32__413"></a>3.2 封装成类调用</h3> 
<pre><code class="prism language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> List

<span class="token keyword">import</span> onnx
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms

<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>ops <span class="token keyword">import</span> nms<span class="token punctuation">,</span>box_convert
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> time
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> onnxruntime <span class="token keyword">as</span> ort
<span class="token keyword">import</span> torch

INPUT_WIDTH <span class="token operator">=</span> <span class="token number">640</span>
INPUT_HEIGHT <span class="token operator">=</span> <span class="token number">640</span>

<span class="token keyword">def</span> <span class="token function">wrap_detection</span><span class="token punctuation">(</span>
        input_image<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">,</span>
        output_data<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">,</span>
        labels<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        confidence_threshold<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.6</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>List<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># the shape of the output_data is (25200,5+nc),</span>
    <span class="token comment"># the first 5 elements are [x, y, w, h, confidence], the rest are prediction scores of each class</span>

    image_width<span class="token punctuation">,</span> image_height<span class="token punctuation">,</span> _ <span class="token operator">=</span> input_image<span class="token punctuation">.</span>shape
    x_factor <span class="token operator">=</span> image_width <span class="token operator">/</span> INPUT_WIDTH
    y_factor <span class="token operator">=</span> image_height <span class="token operator">/</span> INPUT_HEIGHT

    <span class="token comment"># transform the output_data[:, 0:4] from (x, y, w, h) to (x_min, y_min, x_max, y_max)</span>
    <span class="token comment"># output_data[:, 0:4] = np.apply_along_axis(xywh_to_xyxy, 1, output_data[:, 0:4], image_width, image_height)</span>

    nms_start <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    indices <span class="token operator">=</span> cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>NMSBoxes<span class="token punctuation">(</span>output_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> output_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span>
    nms_finish <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"nms time: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>nms_finish <span class="token operator">-</span> nms_start<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token comment"># print(indices)</span>
    raw_boxes <span class="token operator">=</span> output_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span>indices<span class="token punctuation">]</span>
    raw_confidences <span class="token operator">=</span> output_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span>indices<span class="token punctuation">]</span>
    raw_class_prediction_probabilities <span class="token operator">=</span> output_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">[</span>indices<span class="token punctuation">]</span>

    criteria <span class="token operator">=</span> raw_confidences <span class="token operator">&gt;</span> confidence_threshold
    raw_class_prediction_probabilities <span class="token operator">=</span> raw_class_prediction_probabilities<span class="token punctuation">[</span>criteria<span class="token punctuation">]</span>
    raw_boxes <span class="token operator">=</span> raw_boxes<span class="token punctuation">[</span>criteria<span class="token punctuation">]</span>
    raw_confidences <span class="token operator">=</span> raw_confidences<span class="token punctuation">[</span>criteria<span class="token punctuation">]</span>

    bounding_boxes<span class="token punctuation">,</span> confidences<span class="token punctuation">,</span> class_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> class_prediction_probability<span class="token punctuation">,</span> box<span class="token punctuation">,</span> confidence <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>raw_class_prediction_probabilities<span class="token punctuation">,</span> raw_boxes<span class="token punctuation">,</span>
                                                             raw_confidences<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#</span>
        <span class="token comment"># find the least and most probable classes' indices and their probabilities</span>
        <span class="token comment"># min_val, max_val, min_loc, mac_loc = cv2.minMaxLoc(class_prediction_probability)</span>
        most_probable_class_index <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>class_prediction_probability<span class="token punctuation">)</span>
        label <span class="token operator">=</span> labels<span class="token punctuation">[</span>most_probable_class_index<span class="token punctuation">]</span>
        confidence <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>confidence<span class="token punctuation">)</span>

        <span class="token comment"># bounding_boxes.append(box)</span>
        <span class="token comment"># confidences.append(confidence)</span>
        <span class="token comment"># class_ids.append(most_probable_class_index)</span>

        x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> box
        left <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> w<span class="token punctuation">)</span> <span class="token operator">*</span> x_factor<span class="token punctuation">)</span>
        top <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> h<span class="token punctuation">)</span> <span class="token operator">*</span> y_factor<span class="token punctuation">)</span>
        width <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>w <span class="token operator">*</span> x_factor<span class="token punctuation">)</span>
        height <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> y_factor<span class="token punctuation">)</span>
        bounding_box <span class="token operator">=</span> <span class="token punctuation">[</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">]</span>
        bounding_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>bounding_box<span class="token punctuation">)</span>
        confidences<span class="token punctuation">.</span>append<span class="token punctuation">(</span>confidence<span class="token punctuation">)</span>
        class_ids<span class="token punctuation">.</span>append<span class="token punctuation">(</span>most_probable_class_index<span class="token punctuation">)</span>

    <span class="token keyword">return</span> class_ids<span class="token punctuation">,</span> confidences<span class="token punctuation">,</span> bounding_boxes


coco_class_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"person"</span><span class="token punctuation">,</span> <span class="token string">"bicycle"</span><span class="token punctuation">,</span> <span class="token string">"car"</span><span class="token punctuation">,</span> <span class="token string">"motorcycle"</span><span class="token punctuation">,</span> <span class="token string">"airplane"</span><span class="token punctuation">,</span> <span class="token string">"bus"</span><span class="token punctuation">,</span> <span class="token string">"train"</span><span class="token punctuation">,</span> <span class="token string">"truck"</span><span class="token punctuation">,</span> <span class="token string">"boat"</span><span class="token punctuation">,</span>
                    <span class="token string">"traffic light"</span><span class="token punctuation">,</span> <span class="token string">"fire hydrant"</span><span class="token punctuation">,</span> <span class="token string">"stop sign"</span><span class="token punctuation">,</span> <span class="token string">"parking meter"</span><span class="token punctuation">,</span> <span class="token string">"bench"</span><span class="token punctuation">,</span> <span class="token string">"bird"</span><span class="token punctuation">,</span> <span class="token string">"cat"</span><span class="token punctuation">,</span>
                    <span class="token string">"dog"</span><span class="token punctuation">,</span> <span class="token string">"horse"</span><span class="token punctuation">,</span> <span class="token string">"sheep"</span><span class="token punctuation">,</span> <span class="token string">"cow"</span><span class="token punctuation">,</span> <span class="token string">"elephant"</span><span class="token punctuation">,</span> <span class="token string">"bear"</span><span class="token punctuation">,</span> <span class="token string">"zebra"</span><span class="token punctuation">,</span> <span class="token string">"giraffe"</span><span class="token punctuation">,</span> <span class="token string">"backpack"</span><span class="token punctuation">,</span>
                    <span class="token string">"umbrella"</span><span class="token punctuation">,</span> <span class="token string">"handbag"</span><span class="token punctuation">,</span> <span class="token string">"tie"</span><span class="token punctuation">,</span> <span class="token string">"suitcase"</span><span class="token punctuation">,</span> <span class="token string">"frisbee"</span><span class="token punctuation">,</span> <span class="token string">"skis"</span><span class="token punctuation">,</span> <span class="token string">"snowboard"</span><span class="token punctuation">,</span> <span class="token string">"sports ball"</span><span class="token punctuation">,</span>
                    <span class="token string">"kite"</span><span class="token punctuation">,</span> <span class="token string">"baseball bat"</span><span class="token punctuation">,</span> <span class="token string">"baseball glove"</span><span class="token punctuation">,</span> <span class="token string">"skateboard"</span><span class="token punctuation">,</span> <span class="token string">"surfboard"</span><span class="token punctuation">,</span> <span class="token string">"tennis racket"</span><span class="token punctuation">,</span>
                    <span class="token string">"bottle"</span><span class="token punctuation">,</span> <span class="token string">"wine glass"</span><span class="token punctuation">,</span> <span class="token string">"cup"</span><span class="token punctuation">,</span> <span class="token string">"fork"</span><span class="token punctuation">,</span> <span class="token string">"knife"</span><span class="token punctuation">,</span> <span class="token string">"spoon"</span><span class="token punctuation">,</span> <span class="token string">"bowl"</span><span class="token punctuation">,</span> <span class="token string">"banana"</span><span class="token punctuation">,</span> <span class="token string">"apple"</span><span class="token punctuation">,</span>
                    <span class="token string">"sandwich"</span><span class="token punctuation">,</span> <span class="token string">"orange"</span><span class="token punctuation">,</span> <span class="token string">"broccoli"</span><span class="token punctuation">,</span> <span class="token string">"carrot"</span><span class="token punctuation">,</span> <span class="token string">"hot dog"</span><span class="token punctuation">,</span> <span class="token string">"pizza"</span><span class="token punctuation">,</span> <span class="token string">"donut"</span><span class="token punctuation">,</span> <span class="token string">"cake"</span><span class="token punctuation">,</span> <span class="token string">"chair"</span><span class="token punctuation">,</span>
                    <span class="token string">"couch"</span><span class="token punctuation">,</span> <span class="token string">"potted plant"</span><span class="token punctuation">,</span> <span class="token string">"bed"</span><span class="token punctuation">,</span> <span class="token string">"dining table"</span><span class="token punctuation">,</span> <span class="token string">"toilet"</span><span class="token punctuation">,</span> <span class="token string">"tv"</span><span class="token punctuation">,</span> <span class="token string">"laptop"</span><span class="token punctuation">,</span> <span class="token string">"mouse"</span><span class="token punctuation">,</span>
                    <span class="token string">"remote"</span><span class="token punctuation">,</span> <span class="token string">"keyboard"</span><span class="token punctuation">,</span> <span class="token string">"cell phone"</span><span class="token punctuation">,</span> <span class="token string">"microwave"</span><span class="token punctuation">,</span> <span class="token string">"oven"</span><span class="token punctuation">,</span> <span class="token string">"toaster"</span><span class="token punctuation">,</span> <span class="token string">"sink"</span><span class="token punctuation">,</span>
                    <span class="token string">"refrigerator"</span><span class="token punctuation">,</span> <span class="token string">"book"</span><span class="token punctuation">,</span> <span class="token string">"clock"</span><span class="token punctuation">,</span> <span class="token string">"vase"</span><span class="token punctuation">,</span> <span class="token string">"scissors"</span><span class="token punctuation">,</span> <span class="token string">"teddy bear"</span><span class="token punctuation">,</span> <span class="token string">"hair drier"</span><span class="token punctuation">,</span>
                    <span class="token string">"toothbrush"</span><span class="token punctuation">]</span>

colors <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>coco_class_names<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># Load the model</span>
    model_path <span class="token operator">=</span> <span class="token string">"weights/yolov5s.onnx"</span>
    onnx_model <span class="token operator">=</span> onnx<span class="token punctuation">.</span>load<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>
    onnx<span class="token punctuation">.</span>checker<span class="token punctuation">.</span>check_model<span class="token punctuation">(</span>onnx_model<span class="token punctuation">)</span>
    session <span class="token operator">=</span> ort<span class="token punctuation">.</span>InferenceSession<span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> providers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'CUDAExecutionProvider'</span><span class="token punctuation">,</span><span class="token string">"CPUExecutionProvider"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    capture <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    trans <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image

    <span class="token keyword">while</span> capture<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        success<span class="token punctuation">,</span> frame <span class="token operator">=</span> capture<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        start <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> success<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        rows<span class="token punctuation">,</span> cols<span class="token punctuation">,</span> channels <span class="token operator">=</span> frame<span class="token punctuation">.</span>shape
        <span class="token comment"># Preprocessing</span>
        max_size <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>rows<span class="token punctuation">,</span> cols<span class="token punctuation">)</span>
        input_image <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>max_size<span class="token punctuation">,</span> max_size<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
        input_image<span class="token punctuation">[</span><span class="token punctuation">:</span>rows<span class="token punctuation">,</span> <span class="token punctuation">:</span>cols<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> frame
        input_image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>input_image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>

        inputs <span class="token operator">=</span> trans<span class="token punctuation">(</span>Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>input_image<span class="token punctuation">)</span><span class="token punctuation">)</span>
        inputs <span class="token operator">=</span> inputs<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>inputs<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
        <span class="token comment"># inputs.to('cuda')</span>
        ort_inputs <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>session<span class="token punctuation">.</span>get_inputs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">:</span> inputs<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        ort_outs <span class="token operator">=</span> session<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> ort_inputs<span class="token punctuation">)</span>
        out_prob <span class="token operator">=</span> ort_outs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>out_prob<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

        scores <span class="token operator">=</span> out_prob<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token comment"># Confidence scores are in the 5th column (0-indexed)</span>
        class_ids <span class="token operator">=</span> out_prob<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># Class labels are from the 6th column onwards</span>
        bounding_boxes_xywh <span class="token operator">=</span> out_prob<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment"># Bounding boxes in cxcywh format</span>

        <span class="token comment"># Filter out boxes based on confidence threshold</span>
        confidence_threshold <span class="token operator">=</span> <span class="token number">0.7</span>
        mask <span class="token operator">=</span> scores <span class="token operator">&gt;=</span> confidence_threshold
        class_ids <span class="token operator">=</span> class_ids<span class="token punctuation">[</span>mask<span class="token punctuation">]</span>
        bounding_boxes_xywh <span class="token operator">=</span> bounding_boxes_xywh<span class="token punctuation">[</span>mask<span class="token punctuation">]</span>
        scores <span class="token operator">=</span> scores<span class="token punctuation">[</span>mask<span class="token punctuation">]</span>

        bounding_boxes_xywh <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>bounding_boxes_xywh<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

        <span class="token comment"># Convert bounding boxes from xywh to xyxy format</span>
        bounding_boxes_xyxy <span class="token operator">=</span> box_convert<span class="token punctuation">(</span>bounding_boxes_xywh<span class="token punctuation">,</span> in_fmt<span class="token operator">=</span><span class="token string">'cxcywh'</span><span class="token punctuation">,</span> out_fmt<span class="token operator">=</span><span class="token string">'xyxy'</span><span class="token punctuation">)</span>

        <span class="token comment"># Perform Non-Maximum Suppression to filter candidate boxes</span>


        scores <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>scores<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        bounding_boxes_xyxy<span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">'cuda'</span><span class="token punctuation">)</span>
        scores<span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">'cuda'</span><span class="token punctuation">)</span>
        nms_start <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        keep_indices <span class="token operator">=</span> nms<span class="token punctuation">(</span>bounding_boxes_xyxy<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span>
        nms_end <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"NMS took </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>nms_end <span class="token operator">-</span> nms_start<span class="token punctuation">}</span></span><span class="token string"> seconds"</span></span><span class="token punctuation">)</span>
        class_ids <span class="token operator">=</span> class_ids<span class="token punctuation">[</span>keep_indices<span class="token punctuation">]</span>
        confidences <span class="token operator">=</span> scores<span class="token punctuation">[</span>keep_indices<span class="token punctuation">]</span>
        bounding_boxes <span class="token operator">=</span> bounding_boxes_xyxy<span class="token punctuation">[</span>keep_indices<span class="token punctuation">]</span>

        <span class="token comment"># class_ids, confidences, bounding_boxes = wrap_detection(input_image, out_prob[0], coco_class_names, 0.6)</span>
        <span class="token comment"># break</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>keep_indices<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                class_id <span class="token operator">=</span> class_ids<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">except</span> IndexError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>class_ids<span class="token punctuation">,</span>i<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>keep_indices<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            confidence <span class="token operator">=</span> confidences<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            box <span class="token operator">=</span> bounding_boxes<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            color <span class="token operator">=</span> colors<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>class_id<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>colors<span class="token punctuation">)</span><span class="token punctuation">]</span>
            label <span class="token operator">=</span> coco_class_names<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>class_id<span class="token punctuation">)</span><span class="token punctuation">]</span>

            <span class="token comment"># cv2.rectangle(frame, box, color, 2)</span>

            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">)</span>
            xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span>xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>xmax<span class="token punctuation">,</span> ymax<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token comment"># cv2.rectangle(frame, box, color, 2)</span>
            <span class="token comment"># cv2.rectangle(frame, [box[0], box[1], box[2], box[3]], color, thickness=2)</span>

            cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span>xmin<span class="token punctuation">,</span> ymin <span class="token operator">-</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>xmin <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">,</span> ymin<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>xmin<span class="token punctuation">,</span> ymin <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

        finish <span class="token operator">=</span> time<span class="token punctuation">.</span>perf_counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
        FPS <span class="token operator">=</span> <span class="token builtin">round</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>finish <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"FPS: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>FPS<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment"># 6. show the frame</span>
        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"frame"</span><span class="token punctuation">,</span> frame<span class="token punctuation">)</span>

        <span class="token comment"># 7. press 'q' to exit</span>
        <span class="token keyword">if</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">ord</span><span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>

    <span class="token comment"># 8. release the capture and destroy all windows</span>
    capture<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>

    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/31c6009aa80a3a8d6d7239d30d4e189b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">centos更改磁盘格式ext4--＞xfs</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/076c1887aa53f63eb5bb5c49973a1e3b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python-字典、集合</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>