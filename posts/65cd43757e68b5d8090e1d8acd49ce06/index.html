<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>策略路由（Policy Route） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="策略路由（Policy Route）" />
<meta property="og:description" content="目录 什么叫策略路由？策略路由优点策略路由流程route-map概念定义route-map格式route-map特征 相关配置基于源地址的策略路由基于目的地址的策略路由基于报文长度的策略路由 什么叫策略路由？ 所谓策略路由，顾名思义，即是根据一定的策略进行报文转发，因此策略路由是一种比目的路由更灵活的路由机制。在路由器转发一个数据报文时，首先根据配置的规则对报文进行过滤，匹配成功则按照一定的转发策略进行报文转发。这种规则可以是基于标准和扩展访问控制列表，也可以基于报文的长度；而转发策略则是控制报文按照指定的策略路由表进行转发，也可以修改报文的IP优先字段。因此，策略路由是对传统IP路由机制的有效增强。
策略路由优点 可以实现不同的用户选择不同的ISP（比如电信，网通的互联互通）使用route-map及策略路由可以根据数据包的特征修改相关QoS项，进而为QoS服务负载均衡。通过设置数据包的行为如下一跳，使用不同的链路，从而提供高效的负载均衡能力。 策略路由流程 使用Route-map来配置策略路由的流程，策略路由只对入口数据包有效。
应用策略路由，必须要指定策略路由使用的路由映射，并且要创建路由映射。一个路由映射由很多条策略组成，每个策略都定义了1个或多个的匹配规则和对应操作。一个接口应用策略路由后，将对该接口接收到的所有包进行检查，不符合路由映射任何策略的数据包将按照通常的路由转发进行处理，符合路由映射中某个策略的数据包就按照该策略中定义的操作进行处理。
route-map概念 route-map即路由映射表，是由一组match字句和set字句构成，他实际上是访问控制列表的一个超集。主要功能包括路由控制和策略路由等。
类似于复杂的Access-list
自顶向下地处理，一旦有一条匹配，则立刻结束route-map查找Route-map每个条目都被赋予编号，可以任意地插入或删除条目
定义route-map格式 定义路由映射表：
route-map map-tag [permit | deny] [sequence-number] 条件匹配：
macth（常用的匹配条件包括IP地址、接口、度量值、tag、路由类型以及数据包长度等） 如果格式为：match ip address a b c 表示逻辑或，只要有一个条件满足即可 如果格式为：match ip address a match ip address b match ip address c 表示逻辑与，必须同时满足所有条件 定义行为：set
Set行为描述set ip next hop设定数据包的下一跳地址set interface设定数据包出接口set ip default next hop设置默认的下一跳地址，用于当路由表里没有达到目的地址路由条目的时候set ip tos设定IP数据包的TOS值set ip precedence设定IP数据包的优先级Set metric设置路由的度量值set tag设定路由的标记值 route-map特征 A.一个route map末尾默认行为是“deny any”
如执行策略路由时，没有匹配则正常转发
如路由重分时，没有匹配则被过滤掉
B.一个route map可以包含多个route map陈述，从上到下被执行，如route map陈述中没有math，则匹配所有。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/65cd43757e68b5d8090e1d8acd49ce06/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-12-22T18:58:11+08:00" />
<meta property="article:modified_time" content="2019-12-22T18:58:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">策略路由（Policy Route）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">什么叫策略路由？</a></li><li><a href="#_6" rel="nofollow">策略路由优点</a></li><li><a href="#_13" rel="nofollow">策略路由流程</a></li><li><a href="#routemap_19" rel="nofollow">route-map概念</a></li><li><ul><li><a href="#routemap_25" rel="nofollow">定义route-map格式</a></li><li><a href="#routemap_51" rel="nofollow">route-map特征</a></li></ul> 
  </li><li><a href="#_61" rel="nofollow">相关配置</a></li><li><ul><li><a href="#_63" rel="nofollow">基于源地址的策略路由</a></li><li><a href="#_77" rel="nofollow">基于目的地址的策略路由</a></li><li><a href="#_91" rel="nofollow">基于报文长度的策略路由</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>什么叫策略路由？</h2> 
<p>所谓策略路由，顾名思义，即是根据一定的策略进行报文转发，因此策略路由是一种比目的路由更灵活的路由机制。在路由器转发一个数据报文时，首先根据配置的规则对报文进行过滤，匹配成功则按照一定的转发策略进行报文转发。这种规则可以是基于标准和扩展访问控制列表，也可以基于报文的长度；而转发策略则是控制报文按照指定的策略路由表进行转发，也可以修改报文的IP优先字段。因此，策略路由是对传统IP路由机制的有效增强。</p> 
<h2><a id="_6"></a>策略路由优点</h2> 
<ol><li>可以实现不同的用户选择不同的ISP（比如电信，网通的互联互通）</li><li>使用route-map及策略路由可以根据数据包的特征修改相关QoS项，进而为QoS服务</li><li>负载均衡。通过设置数据包的行为如下一跳，使用不同的链路，从而提供高效的负载均衡能力。</li></ol> 
<h2><a id="_13"></a>策略路由流程</h2> 
<p><img src="https://images2.imgbox.com/d5/4b/LXboRIjA_o.png" alt="在这里插入图片描述">使用Route-map来配置策略路由的流程，策略路由只对入口数据包有效。</p> 
<p>应用策略路由，必须要指定策略路由使用的路由映射，并且要创建路由映射。一个路由映射由很多条策略组成，每个策略都定义了1个或多个的匹配规则和对应操作。一个接口应用策略路由后，将对该接口接收到的所有包进行检查，不符合路由映射任何策略的数据包将按照通常的路由转发进行处理，符合路由映射中某个策略的数据包就按照该策略中定义的操作进行处理。</p> 
<h2><a id="routemap_19"></a>route-map概念</h2> 
<p>route-map即路由映射表，是由一组match字句和set字句构成，他实际上是访问控制列表的一个超集。主要功能包括路由控制和策略路由等。<br> 类似于复杂的Access-list<br> 自顶向下地处理，一旦有一条匹配，则立刻结束route-map查找Route-map每个条目都被赋予编号，可以任意地插入或删除条目</p> 
<h3><a id="routemap_25"></a>定义route-map格式</h3> 
<p>定义路由映射表：</p> 
<pre><code>route-map map-tag [permit | deny] [sequence-number]
</code></pre> 
<p>条件匹配：</p> 
<pre><code>macth（常用的匹配条件包括IP地址、接口、度量值、tag、路由类型以及数据包长度等）
     如果格式为：match ip address a b c     表示逻辑或，只要有一个条件满足即可
     如果格式为：match ip address a  
                match ip address b  
                match ip address c         表示逻辑与，必须同时满足所有条件
</code></pre> 
<p>定义行为：set</p> 
<table><thead><tr><th>Set行为</th><th>描述</th></tr></thead><tbody><tr><td>set ip next hop</td><td>设定数据包的下一跳地址</td></tr><tr><td>set interface</td><td>设定数据包出接口</td></tr><tr><td>set ip default next hop</td><td>设置默认的下一跳地址，用于当路由表里没有达到目的地址路由条目的时候</td></tr><tr><td>set ip tos</td><td>设定IP数据包的TOS值</td></tr><tr><td>set ip precedence</td><td>设定IP数据包的优先级</td></tr><tr><td>Set metric</td><td>设置路由的度量值</td></tr><tr><td>set tag</td><td>设定路由的标记值</td></tr></tbody></table> 
<h3><a id="routemap_51"></a>route-map特征</h3> 
<p>A.一个route map末尾默认行为是“deny any”<br> 如执行策略路由时，没有匹配则正常转发<br> 如路由重分时，没有匹配则被过滤掉<br> B.一个route map可以包含多个route map陈述，从上到下被执行，如route map陈述中没有math，则匹配所有。<br> C.序列号指定了条件执行的顺序，不写默认为10，不会自动递增<br> D.route map中不写permit deny默认为permit<br> E.在删除route map时，没写编号则删除整个route map</p> 
<h2><a id="_61"></a>相关配置</h2> 
<h3><a id="_63"></a>基于源地址的策略路由</h3> 
<pre><code>access-list 1 permit host 192.168.1.2 用acl标出策略有路由允许通过的主机地址（也可以是一个网段）
access-list 2 permit host 192.168.1.3
route-map boy permit 10 创建路由表并命名标上编号
match ip address 1 关联acl 1 的ip地址
set ip next-hop 192.168.2.2 符合上面acl中的ip地址经过这个路由器之后下一跳的ip地址为192.168.2.2
route-map boy permit 20
match ip address 2
set ip next-hop 192.168.3.2
完成 效果：ip为192.168.1.2则走192.168.2.2的路由 ip为192.168.1.3则走192168.3.2 的路由
</code></pre> 
<h3><a id="_77"></a>基于目的地址的策略路由</h3> 
<pre><code>access-list 111 permit tcp any host 192.168.200.1
用扩展acl（100-199）标出所有ip到主机192.168.200.1的数据流
access-list 112 permit tcp any host 192.168.201.1
route-map boy permit 10 创建路由表并命名标上编号
match ip address 111 关联acl111
set ip next-hop 192.168.2.6 目的地址符合acl 111 的数据流下一跳为192.168.2.6
route-map boy permit 20
match ip address 112
set ip next-hop 192.168.3.6 目的地址符合acl 112 的数据流下一跳为192.168.3.6
</code></pre> 
<h3><a id="_91"></a>基于报文长度的策略路由</h3> 
<pre><code>route-map boy permit 10 创建路由表并命名，标上序号
match length 0 100 表示报文大小在0-100之内的数据流
set ip next-hop 192.168.1.1 下一跳的ip地址为192.168.1.1
route-map boy permit 20
match length 100 200
set ip next-hop 192.168.2.1
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/05137ee657013b99d4fb51f9910740dc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">GFS基础配置安装</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3e8e091456e5e421ef63355abbf19120/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">点到点传输协议（PPP）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>