<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[消息传递之五]－NSMatchPort练习 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[消息传递之五]－NSMatchPort练习" />
<meta property="og:description" content="#import &lt;UIKit/UIKit.h&gt; @interface ViewController : UIViewController&lt;NSMachPortDelegate&gt; @property (nonatomic) NSMutableArray* NotArray; @property (nonatomic) NSLock* NotLock; @property (nonatomic) NSMachPort* NotPort; @end #import &#34;ViewController.h&#34; @interface ViewController () @end @implementation ViewController - (void)viewDidLoad { [super viewDidLoad]; self.NotArray = [[NSMutableArray alloc] init]; self.NotLock = [[NSLock alloc] init]; self.NotPort = [[NSMachPort alloc] init]; self.NotPort.delegate = self; //注意点1:kCFRunLoopCommonModes 将输入源加入此模式意味着在Common Modes中包含的所有模式下都可以处理 //注意点2:NSRunLoop主要是用于oc程序，而CFRunLoop主要用于C/C&#43;&#43;程序，这是因为C/C&#43;&#43;程序无法使用oc对象而创建的一个类 //注意点3:所有线程都自动创建一个RunLoop, 在线程内通过 [NSRunLoop currentRunLoop] 获得当前线程的RunLoop. [[NSRunLoop currentRunLoop] addPort:self.NotPort forMode:NSDefaultRunLoopMode]; [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(ProcessNotification:) name:@&#34;ObserverName&#34; object:nil]; dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{ NSMutableDictionary* dic = [[NSMutableDictionary alloc] init]; [dic setObject:[NSNumber numberWithInteger:80] forKey:@&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9d63602368224793d7d717ede8aa0c76/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-01-10T10:55:44+08:00" />
<meta property="article:modified_time" content="2016-01-10T10:55:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[消息传递之五]－NSMatchPort练习</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <pre><code class="language-objc">#import &lt;UIKit/UIKit.h&gt;

@interface ViewController : UIViewController&lt;NSMachPortDelegate&gt;
@property (nonatomic) NSMutableArray* NotArray;
@property (nonatomic) NSLock*         NotLock;
@property (nonatomic) NSMachPort*     NotPort;
@end</code></pre> 
<p style="margin-top:0px; margin-bottom:0px; font-size:11px; font-family:Menlo; color:rgb(228,68,72)"> </p> 
<pre><code class="language-objc">#import "ViewController.h"

@interface ViewController ()

@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    self.NotArray = [[NSMutableArray alloc] init];
    self.NotLock = [[NSLock alloc] init];
    self.NotPort = [[NSMachPort alloc] init];
    self.NotPort.delegate = self;
    //注意点1:kCFRunLoopCommonModes 将输入源加入此模式意味着在Common Modes中包含的所有模式下都可以处理
    //注意点2:NSRunLoop主要是用于oc程序，而CFRunLoop主要用于C/C++程序，这是因为C/C++程序无法使用oc对象而创建的一个类
    //注意点3:所有线程都自动创建一个RunLoop, 在线程内通过 [NSRunLoop currentRunLoop] 获得当前线程的RunLoop.
    [[NSRunLoop currentRunLoop] addPort:self.NotPort forMode:NSDefaultRunLoopMode];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(ProcessNotification:) name:@"ObserverName" object:nil];
     dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
         NSMutableDictionary* dic = [[NSMutableDictionary alloc] init];
         [dic setObject:[NSNumber numberWithInteger:80] forKey:@"param1"];
        [[NSNotificationCenter defaultCenter] postNotificationName:@"ObserverName" object:self userInfo:dic];
    });
}

-(void)handleMachMessage:(void *)msg
{
    [self.NotLock lock];
    //msg应该是NSPortMessage＊但NSPortMessage* m = (__bridge NSPortMessage*)msg;这样写不可以，不清楚原因。
    NSNotification* ns= [self.NotArray objectAtIndex:0];
    while ([self.NotArray count]) {
        [self.NotArray removeObjectAtIndex:0];
        [self.NotLock unlock];
        [self ProcessNotification:ns];
        [self.NotLock lock];
    }
    [self.NotLock unlock];
}

-(void) ProcessNotification:(NSNotification*) Notification
{
    NSLog(@"%@",[NSThread currentThread]);
    NSLog(@"%@",[Notification userInfo]);
    if ([NSThread currentThread] != [NSThread mainThread]) {
        [self.NotLock lock];
        [self.NotArray addObject:Notification];
        [self.NotLock unlock];
        //sendBeforeDate 函数没理解怎么使用，也许这几个参数就是NSPortMessage的组成部分，哎～～
        [self.NotPort sendBeforeDate:[NSDate date] components:nil from:0 reserved:100];
    };
}
- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

@end</code></pre>1，实现了用指定线程处理了通知notification. 
<p></p> 
<p style="margin-top:0px; margin-bottom:0px; font-size:11px; font-family:Menlo; color:rgb(228,68,72)"> 2，这个方式如果找不到指定的线程（port线程和发起notification的线程），那么就进入了死循环，后果很严重。</p> 
<p style="margin-top:0px; margin-bottom:0px; font-size:11px; font-family:Menlo; color:rgb(228,68,72)"> 3，nsrunloop与自定义的main,有无联系，现在还没有弄清楚，哎～～</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a0a9c65844c9a83a05458345b85f7ee2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Javascript判断一个数字是否在一个区间内</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5d9b64e5c41cead306e5ac960cfc5633/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">noi 2729:Blah数集——单调队列</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>