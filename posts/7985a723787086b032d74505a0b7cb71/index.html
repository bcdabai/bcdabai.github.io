<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>如何在win10&#43;VS2017环境下新建一个简单的WDF示例程序 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="如何在win10&#43;VS2017环境下新建一个简单的WDF示例程序" />
<meta property="og:description" content="上一课我们在win10系统&#43;VS2017开发环境下搭建了WDK驱动程序开发环境的搭建，详见我的博客【如何在win10&#43;VS2017环境下安装USB驱动开发套件WDK】，今天我们来尝试建立一个最简单的KDM示例工程。
提前说明：本博客所建立的示例工程的源码，我上传在了CSDN里【https://download.csdn.net/download/leon1741/10957680】，大家可以自行去下载。不过遗憾的是，现在CSDN资源的下载积分规则改了，不能由上传者来设置该资源的下载积分，而是由系统自动适配的。因此，这个资源的下载积分目前需要5分，有点多，我其实想设置成免费或者最多1分的，可是系统不让我改。希望各位的积分值够用，或者希望系统过段时间自动把下载积分值降下来吧…
第一步：新建工程 记得要选择WDF模型下的空KMD驱动项目，项目名我输的是KMD_Test，大家可以自己更改。
第二步、输入代码 在源代码文件夹上右击，选择新建一个空白文件。
输入文件名为Drive.c。请注意，不是Drive.cpp，而是Drive.c！
在文件中输入以下内容：
#include &lt;ntddk.h&gt; #include &lt;wdf.h&gt; DRIVER_INITIALIZE DriverEntry; EVT_WDF_DRIVER_DEVICE_ADD KmdfHelloWorldEvtDeviceAdd; NTSTATUS DriverEntry( _In_ PDRIVER_OBJECT DriverObject, _In_ PUNICODE_STRING RegistryPath ) { // NTSTATUS variable to record success or failure NTSTATUS status = STATUS_SUCCESS; // Allocate the driver configuration object WDF_DRIVER_CONFIG config; // Print &#34;Hello World&#34; for DriverEntry KdPrintEx((DPFLTR_IHVDRIVER_ID, DPFLTR_INFO_LEVEL, &#34;KmdfHelloWorld: DriverEntry\n&#34;)); // Initialize the driver configuration object to register the // entry point for the EvtDeviceAdd callback, KmdfHelloWorldEvtDeviceAdd WDF_DRIVER_CONFIG_INIT(&amp;config, KmdfHelloWorldEvtDeviceAdd ); // Finally, create the driver object status = WdfDriverCreate(DriverObject, RegistryPath, WDF_NO_OBJECT_ATTRIBUTES, &amp;config, WDF_NO_HANDLE ); return status; } NTSTATUS KmdfHelloWorldEvtDeviceAdd( _In_ WDFDRIVER Driver, _Inout_ PWDFDEVICE_INIT DeviceInit ) { // We&#39;re not using the driver object, // so we need to mark it as unreferenced UNREFERENCED_PARAMETER(Driver); NTSTATUS status; // Allocate the device object WDFDEVICE hDevice; // Print &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/7985a723787086b032d74505a0b7cb71/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-02-14T19:12:25+08:00" />
<meta property="article:modified_time" content="2019-02-14T19:12:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">如何在win10&#43;VS2017环境下新建一个简单的WDF示例程序</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>上一课我们在win10系统+VS2017开发环境下搭建了WDK驱动程序开发环境的搭建，详见我的博客【<a href="https://blog.csdn.net/LEON1741/article/details/87258599">如何在win10+VS2017环境下安装USB驱动开发套件WDK</a>】，今天我们来尝试建立一个最简单的KDM示例工程。</p> 
<p><strong>提前说明</strong>：本博客所建立的示例工程的源码，我上传在了CSDN里【<a href="https://download.csdn.net/download/leon1741/10957680">https://download.csdn.net/download/leon1741/10957680</a>】，大家可以自行去下载。不过遗憾的是，现在CSDN资源的下载积分规则改了，不能由上传者来设置该资源的下载积分，而是由系统自动适配的。因此，这个资源的下载积分目前需要5分，有点多，我其实想设置成免费或者最多1分的，可是系统不让我改。希望各位的积分值够用，或者希望系统过段时间自动把下载积分值降下来吧…</p> 
<h3><a id="_4"></a>第一步：新建工程</h3> 
<p><img src="https://images2.imgbox.com/85/1e/Tx1fUHSQ_o.jpg" alt="在这里插入图片描述"><br> 记得要选择WDF模型下的空KMD驱动项目，项目名我输的是KMD_Test，大家可以自己更改。<br> <img src="https://images2.imgbox.com/47/f3/ObIv1nGf_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="_8"></a>第二步、输入代码</h3> 
<p>在源代码文件夹上右击，选择新建一个空白文件。<br> <img src="https://images2.imgbox.com/2d/93/cERdUjTb_o.jpg" alt="在这里插入图片描述"><br> 输入文件名为Drive.c。<strong>请注意，不是Drive.cpp，而是Drive.c</strong>！</p> 
<p>在文件中输入以下内容：</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;ntddk.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;wdf.h&gt;</span></span>

DRIVER_INITIALIZE DriverEntry<span class="token punctuation">;</span>
EVT_WDF_DRIVER_DEVICE_ADD KmdfHelloWorldEvtDeviceAdd<span class="token punctuation">;</span>

NTSTATUS
<span class="token function">DriverEntry</span><span class="token punctuation">(</span>
    _In_ PDRIVER_OBJECT     DriverObject<span class="token punctuation">,</span>
    _In_ PUNICODE_STRING    RegistryPath
<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// NTSTATUS variable to record success or failure</span>
    NTSTATUS status <span class="token operator">=</span> STATUS_SUCCESS<span class="token punctuation">;</span>

    <span class="token comment">// Allocate the driver configuration object</span>
    WDF_DRIVER_CONFIG config<span class="token punctuation">;</span>

    <span class="token comment">// Print "Hello World" for DriverEntry</span>
    <span class="token function">KdPrintEx</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DPFLTR_IHVDRIVER_ID<span class="token punctuation">,</span> DPFLTR_INFO_LEVEL<span class="token punctuation">,</span> <span class="token string">"KmdfHelloWorld: DriverEntry\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Initialize the driver configuration object to register the</span>
    <span class="token comment">// entry point for the EvtDeviceAdd callback, KmdfHelloWorldEvtDeviceAdd</span>
    <span class="token function">WDF_DRIVER_CONFIG_INIT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">,</span>
        KmdfHelloWorldEvtDeviceAdd
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Finally, create the driver object</span>
    status <span class="token operator">=</span> <span class="token function">WdfDriverCreate</span><span class="token punctuation">(</span>DriverObject<span class="token punctuation">,</span>
        RegistryPath<span class="token punctuation">,</span>
        WDF_NO_OBJECT_ATTRIBUTES<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>config<span class="token punctuation">,</span>
        WDF_NO_HANDLE
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

NTSTATUS
<span class="token function">KmdfHelloWorldEvtDeviceAdd</span><span class="token punctuation">(</span>
    _In_    WDFDRIVER       Driver<span class="token punctuation">,</span>
    _Inout_ PWDFDEVICE_INIT DeviceInit
<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// We're not using the driver object,</span>
    <span class="token comment">// so we need to mark it as unreferenced</span>
    <span class="token function">UNREFERENCED_PARAMETER</span><span class="token punctuation">(</span>Driver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    NTSTATUS status<span class="token punctuation">;</span>

    <span class="token comment">// Allocate the device object</span>
    WDFDEVICE hDevice<span class="token punctuation">;</span>

    <span class="token comment">// Print "Hello World"</span>
    <span class="token function">KdPrintEx</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DPFLTR_IHVDRIVER_ID<span class="token punctuation">,</span> DPFLTR_INFO_LEVEL<span class="token punctuation">,</span> <span class="token string">"KmdfHelloWorld: KmdfHelloWorldEvtDeviceAdd\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create the device object</span>
    status <span class="token operator">=</span> <span class="token function">WdfDeviceCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>DeviceInit<span class="token punctuation">,</span>
        WDF_NO_OBJECT_ATTRIBUTES<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>hDevice
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_81"></a>第三步：项目配置</h3> 
<p>首先切换到x64平台下，选择debug模式。<br> <img src="https://images2.imgbox.com/fe/c3/Kxo9unbP_o.jpg" alt="在这里插入图片描述"><br> 然后打开项目属性的窗口，完成以下设置：<br> <img src="https://images2.imgbox.com/ef/65/BJktsVAx_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/de/7c/Na9vtoGs_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="_88"></a>第四步、全文编译</h3> 
<p>无需其他操作，点击编译按钮即可！</p> 
<pre><code class="prism language-sh">1&gt;------ Build started: Project: KMD_Test, Configuration: Debug x64 ------
1&gt;Building 'KMD_Test' with toolset 'WindowsKernelModeDriver10.0' and the 'Universal' target platform.
1&gt;C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\IDE\VC\VCTargets\Microsoft.CppBuild.targets(402,5): warning MSB8038: Spectre mitigation is enabled but Spectre mitigated libraries are not found.  Verify that the Visual Studio Workload includes the Spectre mitigated libraries.  See https://aka.ms/Ofhn4c for more information.
1&gt;Stamping x64\Debug\KMD_Test.inf
1&gt;Stamping [Version] section with DriverVer=02/14/2019,18.56.35.708
1&gt;Drive.c
1&gt;KMD_Test.vcxproj -&gt; D:\A_Download\KMD_Test\x64\Debug\KMD_Test.sys
1&gt;Done Adding Additional Store
1&gt;Successfully signed: D:\A_Download\KMD_Test\x64\Debug\KMD_Test.sys
1&gt;
1&gt;Driver is a Universal Driver.
1&gt;........................
1&gt;Signability test complete.
1&gt;
1&gt;Errors:
1&gt;None
1&gt;
1&gt;Warnings:
1&gt;None
1&gt;
1&gt;Catalog generation complete.
1&gt;D:\A_Download\KMD_Test\x64\Debug\KMD_Test\kmd_test.cat
1&gt;[0x7FF9F8B95140] ANOMALY: meaningless REX prefix used
1&gt;[0x7FF9F8B95180] ANOMALY: meaningless REX prefix used
1&gt;[0x7FF9F8B95380] ANOMALY: meaningless REX prefix used
1&gt;[0x7FF9F8B935F0] ANOMALY: meaningless REX prefix used
1&gt;[0x7FF9F8B91FD0] ANOMALY: meaningless REX prefix used
1&gt;Done Adding Additional Store
1&gt;Successfully signed: D:\A_Download\KMD_Test\x64\Debug\KMD_Test\kmd_test.cat
1&gt;
1&gt;Done building project "KMD_Test.vcxproj".
========== Build: 1 succeeded, 0 failed, 0 up-to-date, 0 skipped ==========
</code></pre> 
<p>编译出来的驱动程序，均放在”项目目录\Debug\KMD_Test“目录下：<br> <img src="https://images2.imgbox.com/4f/03/UlQBsvyY_o.jpg" alt="在这里插入图片描述"></p> 
<ul><li>KMD_Test.sys – 最关键的内核模式驱动文件；</li><li>KMD_Test.inf – 安装驱动时提供给系统使用的信息文件；</li><li>KMD_Test.cat – 安装程序用来鉴别驱动签名状态的目录文件；</li></ul> 
<p>注：以上全部过程，均是参考微软官方的指导文档执行下来，大家若有兴趣可以自行参阅【<a href="https://docs.microsoft.com/zh-cn/windows-hardware/drivers/gettingstarted/writing-a-very-small-kmdf--driver" rel="nofollow">Write a KMDF Hello World driver</a>】。</p> 
<p>另外，也可以参考微软在github上提供的一份全套示例参考【<a href="https://github.com/Microsoft/Windows-driver-samples">https://github.com/Microsoft/Windows-driver-samples</a>】。</p> 
<p>OK，新建的工程已经顺利编译成功，驱动程序也已经生成完毕，本篇到此为止。下一篇我们将继续研究如何进行驱动程序的调试和安装。</p> 
<hr> 
<p>篇后语：</p> 
<p>这里补充一下，安装完WDK之后，如果去编译其他的C++工程，有可能会遇到【LINK : fatal error LNK1104: 无法打开文件“MSVCRTD.lib”】之类的问题，请不要慌张，不要去网上乱找，这个问题的原因其实很简单，参考我的另一篇博客【<a href="https://blog.csdn.net/LEON1741/article/details/87392536">如何解决win10+VS2017+WDK环境下编译C++程序提示error LNK1104无法打开文件*.lib的问题</a>】即可！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b4dd48febaeb1d6cd9ccd642ed670fbc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">linux下C&#43;&#43;实现Http请求类(GET，POST，上传，下载)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e355c4010f2d9ca30ec19f785ff96bb1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">WebApi 接口参数不再困惑：传参详解 Get</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>