<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot集成SpringSecurity5和OAuth2 — 2、OAuth2客户端【SSO单点登录时作为客户端】 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringBoot集成SpringSecurity5和OAuth2 — 2、OAuth2客户端【SSO单点登录时作为客户端】" />
<meta property="og:description" content="相关代码：参考码云上的sso-client【仅供本人参考使用，不对外，但跟着本文也可实现】
注意：OAuth2的客户端和资源服务器是不同的概念，OAuth2的客户端类似于第三方应用，它对接OAuth2服务器主要是使用OAuth2服务器端提供的客户信息【此处是OAuth2给用户分配的token】来登录客户端自己的系统而非资源服务器，后续用户访问的资源也是客户端自己存的用户资源，所以使用客户端的code来请求token会报错；而资源服务器则需要单独获取code后再获取token，然后才能请求资源服务器上的资源。【资源服务器和认证授权服务器同属一方。】
获取授权码：
http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=client&amp;scope=read&amp;redirect_uri=http://localhost:8090/callback
获取token令牌：
http://localhost:8080/oauth/token?grant_type=authorization_code&amp;code=F4eRew&amp;client_id=client&amp;client_secret=secret&amp;redirect_uri=http://localhost:8090/callback
一、项目环境配置 1.1 、JDK8 1.2、Spring Boot： 2.3.0.RELEASE 1.3、spring-cloud.version：Hoxton.SR4 二、pom.xml 1、加入thymeleaf模板依赖（可选） &lt;!-- thymeleaf模板--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt; &lt;/dependency&gt; 2、加入starter-web依赖 &lt;!-- starter-web --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; 3、加入oauth2依赖 &lt;!-- oauth2 --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt; &lt;/dependency&gt; 4、完整的pom.xml文件 &lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt; &lt;project xmlns=&#34;http://maven.apache.org/POM/4.0.0&#34; xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34; xsi:schemaLocation=&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;parent&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; &lt;version&gt;2.3.0.RELEASE&lt;/version&gt; &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt; &lt;/parent&gt; &lt;groupId&gt;security.oauth2&lt;/groupId&gt; &lt;artifactId&gt;client&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;name&gt;client&lt;/name&gt; &lt;description&gt;OAuth2的客户端&lt;/description&gt; &lt;properties&gt; &lt;java.version&gt;1.8&lt;/java.version&gt; &lt;spring-cloud.version&gt;Hoxton.SR4&lt;/spring-cloud.version&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/49665e0032d98a696b988ced7fe0b984/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-29T14:35:20+08:00" />
<meta property="article:modified_time" content="2023-07-29T14:35:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot集成SpringSecurity5和OAuth2 — 2、OAuth2客户端【SSO单点登录时作为客户端】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><span style="color:#f33b45;"><strong>相关代码：参考码云上的sso-client【仅供本人参考使用，不对外，但跟着本文也可实现】</strong></span></p> 
<p><span style="color:#f33b45;"><strong>注意：</strong></span><strong>OAuth2的客户端和资源服务器是不同的概念，OAuth2的客户端类似于第三方应用，它对接OAuth2服务器主要是使用OAuth2服务器端提供的客户信息【此处是OAuth2给用户分配的token】来登录客户端自己的系统而非资源服务器，后续用户访问的资源也是客户端自己存的用户资源，所以使用客户端的code来请求token会报错；而资源服务器则需要单独获取code后再获取token，然后才能请求资源服务器上的资源。【资源服务器和认证授权服务器同属一方。】</strong></p> 
<p><strong>获取授权码：</strong></p> 
<p><a href="http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=client&amp;scope=read&amp;redirect_uri=http://localhost:8090/callback" rel="nofollow" title="http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=client&amp;scope=read&amp;redirect_uri=http://localhost:8090/callback">http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=client&amp;scope=read&amp;redirect_uri=http://localhost:8090/callback</a></p> 
<p><strong>获取token令牌：</strong></p> 
<p><a href="http://localhost:8080/oauth/token?grant_type=authorization_code&amp;code=F4eRew&amp;client_id=client&amp;client_secret=secret&amp;redirect_uri=http://localhost:8090/callback" rel="nofollow" title="http://localhost:8080/oauth/token?grant_type=authorization_code&amp;code=F4eRew&amp;client_id=client&amp;client_secret=secret&amp;redirect_uri=http://localhost:8090/callback">http://localhost:8080/oauth/token?grant_type=authorization_code&amp;code=F4eRew&amp;client_id=client&amp;client_secret=secret&amp;redirect_uri=http://localhost:8090/callback</a></p> 
<p><img alt="" height="943" src="https://images2.imgbox.com/44/7f/XcTdG3nt_o.png" width="1200"></p> 
<h2>一、项目环境配置</h2> 
<h3>1.1 、JDK8</h3> 
<h3><a name="t2"></a>1.2、Spring Boot： 2.3.0.RELEASE</h3> 
<h3><a name="t3"></a>1.3、spring-cloud.version：Hoxton.SR4</h3> 
<h2>二、pom.xml</h2> 
<h3>1、加入thymeleaf模板依赖（可选）</h3> 
<pre><code>		&lt;!-- thymeleaf模板--&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
		&lt;/dependency&gt;</code></pre> 
<h3>2、加入starter-web依赖</h3> 
<pre><code>		&lt;!-- starter-web --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
		&lt;/dependency&gt;</code></pre> 
<h3>3、加入oauth2依赖</h3> 
<pre><code>		&lt;!-- oauth2 --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
			&lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;
		&lt;/dependency&gt;</code></pre> 
<h3>4、完整的pom.xml文件</h3> 
<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
	&lt;parent&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
		&lt;version&gt;2.3.0.RELEASE&lt;/version&gt;
		&lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
	&lt;/parent&gt;
	&lt;groupId&gt;security.oauth2&lt;/groupId&gt;
	&lt;artifactId&gt;client&lt;/artifactId&gt;
	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
	&lt;name&gt;client&lt;/name&gt;
	&lt;description&gt;OAuth2的客户端&lt;/description&gt;

	&lt;properties&gt;
		&lt;java.version&gt;1.8&lt;/java.version&gt;
		&lt;spring-cloud.version&gt;Hoxton.SR4&lt;/spring-cloud.version&gt;
	&lt;/properties&gt;

	&lt;dependencies&gt;

		&lt;!-- thymeleaf模板--&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
		&lt;/dependency&gt;

		&lt;!-- starter-web --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
		&lt;/dependency&gt;

		&lt;!-- oauth2 --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
			&lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;
		&lt;/dependency&gt;

		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
			&lt;scope&gt;test&lt;/scope&gt;
			&lt;exclusions&gt;
				&lt;exclusion&gt;
					&lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;
					&lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;
				&lt;/exclusion&gt;
			&lt;/exclusions&gt;
		&lt;/dependency&gt;

	&lt;/dependencies&gt;

	&lt;dependencyManagement&gt;
		&lt;dependencies&gt;
			&lt;dependency&gt;
				&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
				&lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
				&lt;version&gt;${spring-cloud.version}&lt;/version&gt;
				&lt;type&gt;pom&lt;/type&gt;
				&lt;scope&gt;import&lt;/scope&gt;
			&lt;/dependency&gt;
		&lt;/dependencies&gt;
	&lt;/dependencyManagement&gt;

	&lt;build&gt;
		&lt;plugins&gt;
			&lt;plugin&gt;
				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
			&lt;/plugin&gt;
		&lt;/plugins&gt;
	&lt;/build&gt;

&lt;/project&gt;
</code></pre> 
<h3>三、application.properties</h3> 
<h3>1、配置客户端端口</h3> 
<pre><code class="language-html">server.port=8090</code></pre> 
<p>因为我在OAuth2认证服务器上写的回调地址的端口是8090，所以此处设置成8090端口</p> 
<h3>2、配置登陆路径</h3> 
<pre><code class="language-html">security.oauth2.sso.login-path=/callback</code></pre> 
<p>因为我在OAuth2认证服务器上写的回调地址是callback，所以此处设置成callback，必须和认证服务器上设置的回调地址一致，否则会报错</p> 
<h3>3、配置客户端在认证服务器上的appId和appSecret</h3> 
<pre><code class="language-html">#客户端id
security.oauth2.client.client-id=client
#客户端secret
security.oauth2.client.client-secret=secret</code></pre> 
<h3>4、配置授权码的地址</h3> 
<pre><code class="language-html">#获取授权码的地址
security.oauth2.client.user-authorization-uri=http://localhost:8080/oauth/authorize</code></pre> 
<h3>5、配置获取token的地址</h3> 
<pre><code class="language-html">security.oauth2.client.access-token-uri=http://localhost:8080/oauth/token</code></pre> 
<h3>6、配置校验token的地址</h3> 
<pre><code class="language-html">security.oauth2.resource.token-info-uri=http://localhost:8080/oauth/check_token</code></pre> 
<h3><span style="color:#f33b45;">7、配置客户端的session的cookie名称（必须配置）</span></h3> 
<pre><code class="language-html">server.servlet.session.cookie.name=OAuth-Client</code></pre> 
<p><strong>原因：</strong>如果同一台服务器（或电脑）上，同时部署了多个Spring Boot项目（假设A、B项目），但是项目之间没有任何关系，相互独立。然后在同一个浏览器上，同时请求A、B项目上的服务，在A项目进行定时认证session时，前端在发起Request请求时常将B的sessionId 当做A的sessionId上传给A，而导致A项目验证session时失败。</p> 
<p><strong>出现这种情况的原因是：</strong>A、B项目存储SessionId 的cookie name 相同，浏览器傻傻分不清JSESSIONID到底是A还是B的，所以就拿错了。</p> 
<p><strong>解决办法：</strong>在A项目的application.properties 中设置session的cookie名称，与B项目的session的cookie名称不相同即可<strong>。</strong></p> 
<p><strong>8、完整的application.properties配置</strong></p> 
<pre><code>
server.port=8090

spring.application.name=sso-client

#登陆路径
#security.oauth2.sso.login-path=/login
security.oauth2.sso.login-path=/callback
#客户端id
security.oauth2.client.client-id=client
#客户端secret
security.oauth2.client.client-secret=secret
#获取授权码的地址
security.oauth2.client.user-authorization-uri=http://localhost:8080/oauth/authorize
#获取token的地址
security.oauth2.client.access-token-uri=http://localhost:8080/oauth/token
#校验token的地址
security.oauth2.resource.token-info-uri=http://localhost:8080/oauth/check_token


#禁止同名的sessionId，是个坑，不加会报错
server.servlet.session.cookie.name=OAuth-Client

spring.thymeleaf.prefix = classpath:/templates/
#spring.thymeleaf.suffix = .html
spring.thymeleaf.encoding = UTF-8
spring.thymeleaf.servlet.content-type=text/html
spring.thymeleaf.cache = false
</code></pre> 
<h2>四、在springboot的启动器上开启SSOclient的配置</h2> 
<pre><code class="language-html">加入注解：@EnableOAuth2Sso</code></pre> 
<h2>五、新建一个Controller</h2> 
<pre><code>package security.oauth2.client.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class ClientController {

    @GetMapping("/callback")
    public String callback(){
        return "SSO Client callback!";
    }

    @GetMapping("/oauth-client")
    public String oauthClient(){
        return "This is SSO Client!";
    }


}
</code></pre> 
<h2>六、测试</h2> 
<p>1、在浏览器中输入：localhost:8090/oauth-client后，跳转到了认证服务器的登录界面，同时Set-Cookie设置的cookie名称也从JSESSIONID变为了OAuth-Client。</p> 
<p><img alt="" height="599" src="https://images2.imgbox.com/e6/f0/kf87NN18_o.png" width="1200"></p> 
<p>2、输入用户名密码后，进入是否同意授权的界面</p> 
<p><img alt="" height="676" src="https://images2.imgbox.com/39/6f/bvkeFJ7k_o.png" width="1200"></p> 
<p>3、选择同意授权后，跳回原来浏览器请求的客户端的地址，同时在服务器给出的回调地址中可以查看到认证服务器返回的授权码code</p> 
<p><img alt="" height="836" src="https://images2.imgbox.com/84/92/RfPXY7Pe_o.png" width="1200"></p> 
<h2>七、SSO单点登录时作为客户端</h2> 
<h3>7.1 新增WebSecurityConfig：</h3> 
<p>       主要是为了增加退出客户端的操作，在退出客户端系统时，发请求退出OAuth2认证服务器，这样就能实现单点登录的退出，即从所有系统中退出；</p> 
<pre><code class="language-java">package security.oauth2.client.config;

import org.springframework.boot.autoconfigure.security.oauth2.client.EnableOAuth2Sso;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.builders.WebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;

@EnableOAuth2Sso
@Configuration
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    public void configure(WebSecurity web) throws Exception {
        web.ignoring().antMatchers("/bootstrap/**");
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.logout().logoutSuccessUrl("http://localhost:8080/logout")
                .and()
                .authorizeRequests()
                .anyRequest().authenticated()
                .and()
                .csrf().disable();
    }
}
</code></pre> 
<p><span style="color:#f33b45;"><strong>注意</strong>：</span></p> 
<p>1、将 <strong>@EnableOAuth2Sso </strong>注解从启动类上改到WebSecurityConfig上；</p> 
<p>2、退出操作，请求：<a href="http://localhost:8090/logout" rel="nofollow" title="http://localhost:8090/logout">http://localhost:8090/logout</a>【logout：是security默认的退出请求地址】</p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9b8c0d296d65ad58713452f5c069d903/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">jwt在线解密工具分享</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7a70b030b474317af53220608a0305bd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C语言项目】多臂井径电子测井成像项目（一）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>