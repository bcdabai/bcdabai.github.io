<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>全文检索及Lucene及elasticsearch详解 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="全文检索及Lucene及elasticsearch详解" />
<meta property="og:description" content="全文检索
Lucene工具
elasticsearch基础
elasticsearch数据处理
elasticsearch数据查询
elasticsearch-head
elasticsearch-postman
elasticsearch-Kibana
springboot-elasticsearch
快捷使用导航
API快捷使用导航
常见ES报错情况
全文检索
一、什么是全文检索
数据的分类： 结构化数据
格式固定、长度固定、数据类型固定
例如：数据库中的数据
非结构化数据
格式不固定、长度不固定、数据类型不固定
例如：word文档、pdf文档、邮件、html、txt
数据的查询： 结构化数据的查询
sql语句。查询结构化数据的方法简单、速度快。非结构化数据的查询 目测
使用程序把文档读取到内存中，然后匹配字符串，顺序扫描
把非结构数据变成结构化数据
(举例英文文档)先根据空格进行字符串拆分，得到一个单词列表，基于单词列表创建一个索引。
然后查询索引，根据单词和文档的对应关系找到文档列表，这个过程叫做全文检索。
索引：一个为了提高查询速度，创建某种数据结构的集合。
全文检索：
先创建索引然后查询索引的过程叫做全文索引
索引一次创建可以多次使用，表现为每次查询速度很快。 二、 全文检索的应用场景
搜索引擎
百度、360搜索、谷歌、搜狗站内引擎
论坛搜索、微博、文章搜索电商搜索
淘宝搜索、京东搜索(搜索到的商品数据)
只要是有搜索的地方就可以使用全文检索技术 Lucene工具
lucene是一个基于java开发全文检索的工具包
Lucene 实现全文检索的流程
创建索引 获得文档
1. 原始文档：要基于哪些数据来进行搜索，那么这些数据就是原始文档
2. 搜索引擎：使用爬虫获取原始文档
3. 站内搜索：数据库中的数据
案例：直接使用io读取到磁盘上的文件
构建文档对象
对应每个原始文档创建一个Document对象
每个document对象中包含多个域(field)
域中保存就是原始文档数据
域的名称域的值
每个文档都有一个唯一的编号，就是文档id
分析分档
就是分词的过程
根据空格进行字符串拆分，得到一个单词列表把单词统一转换为小写去除标点符号去除停用词
停用词：无意义的词(the a)
每个关键词都封装成一个Term对象中。
Term中包含两部分内容： 关键词所在的域关键词本身
不同的域中拆分出来的相同的关键词是不同的Term 创建索引" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/872ee6a2e2d6de69506d63b9cc7be522/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-13T10:58:40+08:00" />
<meta property="article:modified_time" content="2023-07-13T10:58:40+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">全文检索及Lucene及elasticsearch详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><a href="#quanmwe" rel="nofollow"><font size="2" face="宋体" color="grey">全文检索</font></a></p> 
<p><a href="#aaucene" rel="nofollow"><font size="2" face="宋体" color="grey">Lucene工具</font></a></p> 
<p><a href="#elasticsearchjj" rel="nofollow"><font size="2" face="宋体" color="grey">elasticsearch基础</font></a></p> 
<p><a href="#elasticsearch" rel="nofollow"><font size="2" face="宋体" color="grey">elasticsearch数据处理</font></a></p> 
<p><a href="#sjcxesch" rel="nofollow"><font size="2" face="宋体" color="grey">elasticsearch数据查询</font></a></p> 
<p><a href="#head" rel="nofollow"><font size="2" face="宋体" color="grey">elasticsearch-head</font></a></p> 
<p><a href="#postman" rel="nofollow"><font size="2" face="宋体" color="grey">elasticsearch-postman</font></a></p> 
<p><a href="#Kibana" rel="nofollow"><font size="2" face="宋体" color="grey">elasticsearch-Kibana</font></a></p> 
<p><a href="#sb" rel="nofollow"><font size="2" face="宋体" color="grey">springboot-elasticsearch</font></a></p> 
<p><a href="#kljs" rel="nofollow"><font size="2" face="宋体" color="grey">快捷使用导航</font></a></p> 
<p><a href="#javspi" rel="nofollow"><font size="2" face="宋体" color="grey">API快捷使用导航</font></a></p> 
<p><a href="#bbaocuo" rel="nofollow"><font size="2" face="宋体" color="grey">常见ES报错情况</font></a></p> 
<blockquote> 
 <p><font size="3" face="宋体" color="black"><span id="quanmwe">全文检索</span></font></p> 
</blockquote> 
<p><font size="2" face="宋体">一、什么是全文检索</font></p> 
<ol><li>数据的分类： 
  <ol><li>结构化数据<br> 格式固定、长度固定、数据类型固定<br> 例如：数据库中的数据<br> <img src="https://images2.imgbox.com/86/b4/98u1c9TW_o.png" alt="在这里插入图片描述"></li><li>非结构化数据<br> 格式不固定、长度不固定、数据类型不固定<br> 例如：word文档、pdf文档、邮件、html、txt<br> <img src="https://images2.imgbox.com/35/3d/xyJsRvsg_o.png" alt="在这里插入图片描述"></li></ol> </li><li>数据的查询： 
  <ol><li>结构化数据的查询<br> sql语句。查询结构化数据的方法简单、速度快。</li><li>非结构化数据的查询 
    <ol><li> <p>目测</p> </li><li> <p>使用程序把文档读取到内存中，然后匹配字符串，顺序扫描</p> </li><li> <p>把非结构数据变成结构化数据<br> (举例英文文档)先根据空格进行字符串拆分，得到一个单词列表，基于单词列表创建一个索引。<br> 然后查询索引，根据单词和文档的对应关系找到文档列表，这个过程叫做全文检索。</p> <p>索引：一个为了提高查询速度，创建某种数据结构的集合。</p> </li></ol> </li></ol> </li><li>全文检索：<br> 先创建索引然后查询索引的过程叫做全文索引<br> 索引一次创建可以多次使用，表现为每次查询速度很快。</li></ol> 
<p>二、 全文检索的应用场景</p> 
<ol><li>搜索引擎<br> 百度、360搜索、谷歌、搜狗</li><li>站内引擎<br> 论坛搜索、微博、文章搜索</li><li>电商搜索<br> 淘宝搜索、京东搜索(搜索到的商品数据)<br> <img src="https://images2.imgbox.com/12/bc/YCzfaRFL_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/ba/9a/61S5A2tc_o.png" alt="在这里插入图片描述"></li><li>只要是有搜索的地方就可以使用全文检索技术</li></ol> 
<blockquote> 
 <p><font size="3" face="宋体" color="black"><span id="aaucene">Lucene工具</span></font></p> 
</blockquote> 
<p>lucene是一个基于java开发全文检索的工具包</p> 
<p>Lucene 实现全文检索的流程</p> 
<ol><li>创建索引 
  <ol><li> <p>获得文档<br> 1. 原始文档：要基于哪些数据来进行搜索，那么这些数据就是原始文档<br> 2. 搜索引擎：使用爬虫获取原始文档<br> 3. 站内搜索：数据库中的数据<br> 案例：直接使用io读取到磁盘上的文件</p> </li><li> <p>构建文档对象<br> 对应每个原始文档创建一个Document对象<br> 每个document对象中包含多个域(field)<br> 域中保存就是原始文档数据</p> 
    <ol><li>域的名称</li><li>域的值<br> 每个文档都有一个唯一的编号，就是文档id<br> <img src="https://images2.imgbox.com/e0/9b/lBb5fzEl_o.png" alt="在这里插入图片描述"></li></ol> </li><li> <p>分析分档<br> 就是分词的过程</p> 
    <ol><li>根据空格进行字符串拆分，得到一个单词列表</li><li>把单词统一转换为小写</li><li>去除标点符号</li><li>去除停用词<br> 停用词：无意义的词(the a)<br> 每个关键词都封装成一个Term对象中。<br> Term中包含两部分内容： 
      <ol><li>关键词所在的域</li><li>关键词本身<br> 不同的域中拆分出来的相同的关键词是不同的Term</li></ol> </li></ol> </li><li> <p>创建索引<br> 基于关键词列表创建一个索引，保存到索引库中。<br> 索引库中：<br> 索引<br> document对象<br> 关键词和文档的对应关系<br> 通过词语找到文档，这种索引的结构叫倒排索引结构</p> </li></ol> </li><li>查询索引 
  <ol><li>用户查询接口 
    <ol><li>用户输入查询条件的地方</li></ol> </li><li>把关键词封装成一个查询对象 
    <ol><li>要查询的域</li><li>要搜索的关键词</li></ol> </li><li>执行查询 
    <ol><li>根据要查询的关键词到对应的域上进行搜索</li><li>找到关键词，根据关键词找到对应的文档</li></ol> </li><li>渲染结果 
    <ol><li>根据文档的id找到id文档对象</li><li>对关键词进行高亮显示</li><li>分页处理</li><li>最终展示给用户</li></ol> </li></ol> </li></ol> 
<p>（索引和搜索流程图）<br> <img src="https://images2.imgbox.com/f1/4c/Xyt7AZIp_o.png" alt="ene">红框表示索引过程，对要索引的原始内容进行索引构建一个索引库，索引过程包括：确定原始内容即要搜索的内容–&gt;采集文档–&gt;创建文档–&gt;分析文档–&gt;索引文档</p> 
<hr> 
<ol start="3"><li> <p>入门程序<br> 需求：<br> 实现一个文件的搜索功能，通过关键字搜索文件，凡是文件名或文件内容包括关键字的文件都需要找出来，还可以根据中文词语进行查询，并且需要支持多个条件查询。<br> 案例中原始内容就是磁盘上的文件：<br> <img src="https://images2.imgbox.com/b0/7b/yoEB0E8P_o.png" alt="在这里插入图片描述"></p> 
  <ol><li> <p>创建索引</p> 
    <ol><li> <p>环境：最低jdk1.8</p> </li><li> <p>工程搭建：</p> 
      <ol><li> <p>创建Maven项目</p> </li><li> <p>添加jar：</p> <pre><code class="prism language-java"> <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>lucene<span class="token operator">-</span>core<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">7.4</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>commons<span class="token operator">-</span>io<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>commons<span class="token operator">-</span>io<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.6</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>

        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>lucene<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>lucene<span class="token operator">-</span>analyzers<span class="token operator">-</span>common<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">7.4</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> </li></ol> </li><li> <p>步骤：</p> 
      <ol><li>创建一个Directory对象，指定索引库保存的位置</li><li>基于Directory 对象创建一个IndexWriter对象</li><li>读取磁盘上的文件，对应每个文件创建一个文档对象</li><li>向文档对象中添加域</li><li>把文档对象写入索引库</li><li>关闭IndexWriter对象</li></ol> <pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{<!-- --></span>

        <span class="token class-name">Directory</span> directory <span class="token operator">=</span> <span class="token class-name">FSDirectory</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:\\FZ\\index"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IndexWriter</span> indexWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexWriter</span><span class="token punctuation">(</span>directory<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">IndexWriterConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> dir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:\\AllProjectText"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span>dir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> f <span class="token operator">:</span> files<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> fileName <span class="token operator">=</span>f<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> filePath <span class="token operator">=</span>f<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> fileContent <span class="token operator">=</span> <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">readFileToString</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> fileSize <span class="token operator">=</span><span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">sizeOf</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">// System.out.println(fileName+" " +filePath+" "+fileSize);</span>

            <span class="token class-name">Field</span> fieldName<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextField</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span>fileName<span class="token punctuation">,</span><span class="token class-name">Field<span class="token punctuation">.</span>Store</span><span class="token punctuation">.</span><span class="token constant">YES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Field</span> fieldPath<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextField</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">,</span>filePath<span class="token punctuation">,</span><span class="token class-name">Field<span class="token punctuation">.</span>Store</span><span class="token punctuation">.</span><span class="token constant">YES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Field</span> fieldContend<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextField</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span>fileContent<span class="token punctuation">,</span><span class="token class-name">Field<span class="token punctuation">.</span>Store</span><span class="token punctuation">.</span><span class="token constant">YES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Field</span> fieldSize<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextField</span><span class="token punctuation">(</span><span class="token string">"size"</span><span class="token punctuation">,</span>fileSize<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token class-name">Field<span class="token punctuation">.</span>Store</span><span class="token punctuation">.</span><span class="token constant">YES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Document</span> document <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Document</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fieldPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fieldContend<span class="token punctuation">)</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fieldSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            indexWriter<span class="token punctuation">.</span><span class="token function">addDocument</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        indexWriter<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> </li></ol> </li><li> <p>mark：luke<br> GitHub：https://github.com/DmitryKey/luke/releases<br> 使用luke查看索引库中的内容</p> </li><li> <p>查询索引库<br> 步骤：<br> 1. 创建一个Directory对象，指定索引库的位置<br> 2. 创建一个IndexReader对象<br> 3. 创建一个IndexSearcher对象，构造方法中的参数indexReader对象<br> 4. 创建一个Query对象，TermQuery<br> 5. 执行查询，得到一个TopDocs对象<br> 6. 取查询结果的总记录数<br> 7. 取文档列表<br> 8. 打印文档中的内容<br> 9. 关闭IndexReader对象</p> <pre><code class="prism language-java"> <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">searchIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span>  <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">Directory</span> directory <span class="token operator">=</span> <span class="token class-name">FSDirectory</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:\\FZ\\index"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IndexReader</span> indexReader <span class="token operator">=</span> <span class="token class-name">DirectoryReader</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>directory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IndexSearcher</span> indexSearcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexSearcher</span><span class="token punctuation">(</span>indexReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TermQuery</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Term</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">,</span><span class="token string">"spring"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TopDocs</span> topDocs <span class="token operator">=</span> indexSearcher<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"查询总记录数："</span><span class="token operator">+</span> topDocs<span class="token punctuation">.</span>totalHits<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ScoreDoc</span><span class="token punctuation">[</span><span class="token punctuation">]</span> scoreDocs <span class="token operator">=</span>topDocs<span class="token punctuation">.</span>scoreDocs<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ScoreDoc</span> doc <span class="token operator">:</span> scoreDocs<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> docId <span class="token operator">=</span> doc<span class="token punctuation">.</span>doc<span class="token punctuation">;</span>
            <span class="token class-name">Document</span> document <span class="token operator">=</span> indexSearcher<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>docId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" "</span><span class="token operator">+</span>document<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" "</span><span class="token operator">+</span>document<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"size"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"----------------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        indexReader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <p>结果如图：</p> <p><img src="https://images2.imgbox.com/5d/4d/YA9KTX9J_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dd/55/Cpu45QIV_o.png" alt="在这里插入图片描述">注意：出现乱码的原因是文件的编码格式要为UTF-8，即可正常显示</p> </li></ol> </li><li> <p>分析器<br> 默认使用的标准分词器StsandardAnalyzer<br> 查看分析器的分析效果<br> 1. 使用Analyzer对象的tokenStream方法返回一个TokenStream对象。词对象中包含了最终分词结果<br> 2. 实现步骤：</p> <pre><code>   1. 创建一个Analyzer对象，StandardAnalyzer对象
   2. 使用分析器对象的tokenStream方法获得一个TokenStream对象
   3. 向TokenStream对象中设置一个引用，相当于一个指针
   4. 调用TokenStream对象的rest方法，如果不调用抛异常
   5. 使用while循环遍历Tokenstream对象
   6. 关闭TOkenStream对象 
</code></pre> <p><img src="https://images2.imgbox.com/37/22/fFJ4VmpN_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/6c/78/VKuirrT1_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<blockquote> 
 <p><font size="3" face="宋体" color="black"><span id="elasticsearchjj">elasticsearch基础</span></font></p> 
</blockquote> 
<p><a href="#csss" rel="nofollow"><font size="2" face="宋体" color="grey">创建索引</font></a></p> 
<p><a href="#csssss" rel="nofollow"><font size="2" face="宋体" color="grey">数据类型</font></a></p> 
<p><a href="#cjwds" rel="nofollow"><font size="2" face="宋体" color="grey">创建文档</font></a></p> 
<p><a href="#xgxwd" rel="nofollow"><font size="2" face="宋体" color="grey">更新文档</font></a></p> 
<p><a href="#sypys" rel="nofollow"><font size="2" face="宋体" color="grey">索引片映射</font></a></p> 
<p><a href="#cxjgjs" rel="nofollow"><font size="2" face="宋体" color="grey">查询结果结构</font></a></p> 
<p><font size="2" face="宋体" color="黑体"><span id="csss">创建索引</span></font></p> 
<p><font size="2" face="宋体">在关系型数据库中，需要使用DDL语句来创建数据库和表，然后才可以插入数据， es 不是必须的</font></p> 
<p><font size="2" face="宋体" color="黑体"><span id="csssss">数据类型</span></font></p> 
<p><font size="2" face="宋体">• text：全文搜索字符串<br> <font size="2" face="宋体">• keyword：用于精确字符串匹配和聚合<br> <font size="2" face="宋体">• date 及 date_nanos：格式化为日期或数字日期的字符串<br> <font size="2" face="宋体">• byte,short，integer，long：整数类型 boolean：布尔类型<br> <font size="2" face="宋体">• float,double,half_float：浮点数类型 分级的类型：object 及 nested</font></font></font></font></font></p> 
<p><font size="2" face="宋体">一般情况下，es可以很好的理解文档的结构并自动创建映射（mapping）定义。自动创建映射使用无模式（schemaless）方法快速摄取数据，无需担心字段类型。<br> 为了在索引中获得更好搜索的结果和更好性能，我们有时需要需要手动定义映射。</font></p> 
<p><font size="2" face="宋体">再者需要明确一点，elasticsearch中字段的数据类型无法做更新处理，这不像mysql中字段数据类型可以更新。</font></p> 
<p><font size="2" face="宋体">因此修改字段数据类型的思路是：</font></p> 
<p><font size="2" face="宋体">• 先新建一份新的索引A，新的索引A中，将需要修改的字段数据类型改为你需要更正的类型，其余字段与旧的索引B保持一致<br> <font size="2" face="宋体">• 将旧索引B中数据复制到新索引A的数据中<br> <font size="2" face="宋体">• 删除旧索引B数据<br> <font size="2" face="宋体">•<br> <font size="2" face="宋体">•</font></font></font></font></font></p> 
<p><font size="2" face="宋体" color="黑体"><span id="cjwds">创建文档</span></font></p> 
<ol><li> <p><font size="2" face="宋体">创建索引</font></p> <p><font size="2" face="宋体">在关系型数据库中，创建表（对应es的文档）我们必须指定数据类型和长度，而es可以动态创建索引 mapping（mapping 指数据类型） 。即当我们创建文档时，如果没有创建对应的mapping，那么 es会根据所输入字段的数据猜测数据类型，例如上面的 user 被被认为是 text 类型，而 uid 将被猜测为整数类型。</font></p> </li><li> <p><font size="2" face="宋体">插入文档</font></p> <p><font size="2" face="宋体">在插入文档时，如果该文档的 ID 已经存在，那么就更新现有的文档；如果该文档从来没有存在过，那么就创建新的文档。</font></p> <p><font size="2" face="宋体">如果更新时该文档有新的字段并且这个字段在现有的 mapping 中没有出现，那么 es会根据 schem on write 的策略来推测该字段的类型，并更新当前的 mapping 到最新的状态。</font></p> <p><font size="2" face="宋体">动态 mapping 可能会导致某些字段不是我们想要的数据类型，从而导致索引请求失败</font></p> </li></ol> 
<p><font size="2" face="宋体" color="黑体"><span id="xgxwd">更新文档</span></font></p> 
<p><font size="2" face="宋体">修改文档通常使用 PUT 来进行操作，我们需要指定一个特定的 id 来进行修改：</font></p> 
<pre><code class="prism language-bash">PUT twitter/_doc/1
<span class="token punctuation">{<!-- --></span>
   <span class="token string">"user"</span><span class="token builtin class-name">:</span> <span class="token string">"GB"</span>,
   <span class="token string">"uid"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
   <span class="token string">"city"</span><span class="token builtin class-name">:</span> <span class="token string">"北京"</span>,
   <span class="token string">"province"</span><span class="token builtin class-name">:</span> <span class="token string">"北京"</span>,
   <span class="token string">"country"</span><span class="token builtin class-name">:</span> <span class="token string">"中国"</span>,
   <span class="token string">"location"</span>:<span class="token punctuation">{<!-- --></span>
     <span class="token string">"lat"</span><span class="token builtin class-name">:</span><span class="token string">"29.084661"</span>,
     <span class="token string">"lon"</span><span class="token builtin class-name">:</span><span class="token string">"111.335210"</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体">但是PUT每次修改一个文档我们需要把文档的每一项都要写出来，我们可以使用如下的方法来进行修改：</font></p> 
<pre><code class="prism language-bash">POST twitter/_update/1
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"doc"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"city"</span><span class="token builtin class-name">:</span> <span class="token string">"成都"</span>,
    <span class="token string">"province"</span><span class="token builtin class-name">:</span> <span class="token string">"四川"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<font size="2" face="宋体"> </font> 
<hr> 
<p><font size="2" face="宋体">Elasticsearch是面向文档(document oriented)的，这意味着它可以存储整个对象或文档(document)。然而它不仅仅是存储，还会索引(index) 每个文档的内容使之可以被搜索。在elasticsearch中，开发者可以对文档(而非成列的数据)j进行索引、搜索、排序、过滤。Elasticsearch比传统关系型数据库：</font></p> 
<p><img src="https://images2.imgbox.com/ce/5c/njBZvDO3_o.png" alt="在这里插入图片描述"></p> 
<ol><li><font size="2" face="宋体">索引 index<br> <font size="2" face="宋体">相当于开发者使用的Mysql中的库，一个索引由一个名字来标识(必须全部是小写字母的)，并且当开发者要对对应于这个索引中的文档进行索引、搜索、更新、和删除的时候，都要使用到这个名字。在一个集群中，可以定义任意多的索引。</font></font></li><li><font size="2" face="宋体">类型type<br> <font size="2" face="宋体">相当于开发者使用Mysql中的表，在一个索引中，可以定义一种或多种类型。一个类型是elasticsearch索引中的一个逻辑上的分类/分区。通常，会为具有一组共同字段的文档定义一个类型。比如说，假设开发者运营一个博客平台并且将开发者将所有的数据存储到一个索引中。在这个索引中，你可以为用户数据定义一个类型，为博客数据定义另一个类型，当然，也可以为评论数据定义另一个数据。</font></font></li><li><font size="2" face="宋体">字段Field<br> <font size="2" face="宋体">相当于关系型数据表的字段，对文档数据根据不同属性进行的分类标识</font></font></li><li><font size="2" face="宋体">映射mapping<br> <font size="2" face="宋体">相当于开发者使用的Mysql中的表结构定义，mapping是处理数据的方式和规则方面做一些限制，如某个字段的数据类型，默认值，分析器，是否被索引等等，这些都是映射里面可以设置的，其它就是处理es里面数据的一些使用规则设置也叫做映射，按照最优规则处理数据对性能提高很大，因此才需要建立映射，并且需要思考如何建立映射才能对性能更好。</font></font></li><li><font size="2" face="宋体">文档document<br> <font size="2" face="宋体">相当于开发者使用的Mysql数据表中的一条数据。一个文档是一个可被索引的基本信息单元。比如，你可以拥有某一个客户的文档，某一个产品的一个文档。文档以JSON格式来表示，而JSON是一个到处存在的互联网数据交互格式。<br> <font size="2" face="宋体">在一个index/type里面，你可以存储任意多的文档。注意，尽管一个文档，物理上存在于一个索引之中，文档必须被索引/赋予一个索引的type。</font></font></font></li><li><font size="2" face="宋体">接近实时NRT<br> elasticsearch是一个接近实时的搜索平台。这意味着，从索引一个文档直到这个文档能够被索引到有一个轻微的延迟（通常在1s以内）</font></li><li><font size="2" face="宋体">集群cluster<br> <font size="2" face="宋体">一个集群由一个或多个节点组织在一起，它们共同持有整个的数据，并一起提供索引和搜索功能。一个集群有一个唯一的名字标识，这个名字默认就是elasticsearch，这个名字是重要的，因为一个节点只能通过制定某个集群的名字，来加入这个集群<br> <img src="https://images2.imgbox.com/bc/20/9Xf9POWP_o.png" alt="在这里插入图片描述"></font></font></li><li><font size="2" face="宋体">节点Node<br> <font size="2" face="宋体">一个节点就是集群中的一个服务器，作为集群的一部分，它存储数据，参与集群的索引和搜索功能。</font></font></li><li><font size="2" face="宋体">分片和复制<br> <font size="2" face="宋体">一个索引可以存储超过单个节点硬件限制的大量数据。比如，一个具有10亿文档的索引占据1TB的磁盘空间，而任一节点都没有这样大的磁盘空间；或者单个节点处理搜索请求，响应太慢。为了解决这个问题。elasticsearch提供了将索引划分成多份的功能，这些份就叫做分片。<br> <img src="https://images2.imgbox.com/8a/24/mlzQmBdh_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/58/6c/WF8RLrIL_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/e5/25/hQNpBetx_o.png" alt="在这里插入图片描述"></font></font></li></ol> 
<p><font size="2" face="宋体" color="黑体"><span id="sypys">索引片映射</span></font></p> 
<p><font size="2" face="宋体">为了能够将时间域视为时间，数字域视为数字，字符串域视为全文或精确值字符串， Elasticsearch 需要知道每个域中数据的类型。这个信息包含在映射中。</font></p> 
<p><font size="2" face="宋体">Elasticsearch 支持如下简单域类型：<br> <font size="2" face="宋体">• 字符串: string<br> <font size="2" face="宋体">• 整数 : byte, short, integer, long<br> <font size="2" face="宋体">• 浮点数: float, double<br> <font size="2" face="宋体">• 布尔型: boolean<br> <font size="2" face="宋体">• 日期: date</font></font></font></font></font></font></p> 
<p><font size="2" face="宋体" color="黑体"><span id="cxjgjs">查询结果结构</span></font></p> 
<p><font size="2" face="宋体">• took：执行整个搜索请求耗费了多少毫秒<br> <font size="2" face="宋体">• timed_out：查询是否超时<br> <font size="2" face="宋体">• _shards：查询中参与分片的总数，以及这些分片成功了多少个失败了多少个<br> <font size="2" face="宋体">• hits: 返回结果中最重要的部分是 hits ，它包含 total 字段来表示匹配到的文档总数<br>   <font size="2" face="宋体">• hits.total：搜索到的总条数<br>   <font size="2" face="宋体">• hits.max_score：与查询所匹配文档的 _score 的最大值<br>   <font size="2" face="宋体">• hits.hits：一个 hits 数组包含所查询结果的前十个文档<br>     <font size="2" face="宋体">• hits.hits._type：文档类型<br>     <font size="2" face="宋体">• hits.hits._id：文档id<br>     <font size="2" face="宋体">• hits.hits._index：索引库<br>     <font size="2" face="宋体">• hits.hits._score：每个结果还有一个 _score ，它衡量了文档与查询的匹配程度<br>     <font size="2" face="宋体">• hits.hits._source：文档的源数据</font></font></font></font></font></font></font></font></font></font></font></font></p> 
<p><font size="2" face="宋体">• aggregations: 聚合查询的结果</font></p> 
<p><img src="https://images2.imgbox.com/79/72/LE6BP2Sp_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p><font size="3" face="宋体" color="black"><span id="elasticsearch">elasticsearch数据处理</span></font></p> 
</blockquote> 
<p><font size="2" color="green">是一个开源高扩展的分布式全文检索引擎，es可近乎实时的存储、检索数据；且自身扩展性很好，开源扩展到上百台服务器、处理PB级别的数据。es也使用java开发并使用Lucene作为其核心来实现所有索引和搜索功能，但是它的目的是通过简单的restful api 来隐藏lucene的复杂性，从而让全文搜索变得简单</font></p> 
<p><font size="2" face="宋体">下载elasticsearch安装包进行解压后得到目录如下结构：</font></p> 
<p><img src="https://images2.imgbox.com/37/3c/YKxjlIkS_o.png" alt="在这里插入图片描述"><br> <font size="2" face="宋体">进入bin目录里，点击elasticsearch可启动服务，<br> windows点击浏览器输入localhost:9200 即可测试连接<br> linux输入命令curl ‘192.168.33.100:9200/’ 即可测试连接</font></p> 
<p><img src="https://images2.imgbox.com/9e/1e/LiKslU1g_o.png" alt="在这里插入图片描述"></p> 
<p><font size="2" face="宋体">在启动成功后就是进行页面访问，若使用elasticsearch-head插件访问，则需要 修改config目录elasticsearch.yml服务配置文件，进行开启跨域访问</font></p> 
<pre><code class="prism language-bash"><span class="token comment">#文件末尾追加以下两行代码</span>
http.cors.enabled: <span class="token boolean">true</span>
http.cors.allow-origin: “*”
</code></pre> 
<p><font size="2" face="宋体" color="黑体">elasticsearch修改语法</font></p> 
<p><font size="2" face="宋体">Elasticsearch实际上并没有在原文档进行就地更新。无论何时我们进行更新，Elasticsearch都会删除旧文档，索引一个新文档来立刻替换它。</font></p> 
<p><font size="2" face="宋体">把刚才新增的请求方式改为PUT，就是修改了。不过修改必须指定id，id对应文档存在，则修改；id对应文档不存在，则新增</font></p> 
<p><font size="2" face="宋体">请求方式：http://127.0.0.1:9200/索引名称/_doc/ID编号</font></p> 
<p><font size="2" face="宋体">示例：</font></p> 
<pre><code class="prism language-bash">PUT /heima/goods/3
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"title"</span><span class="token builtin class-name">:</span><span class="token string">"超大米手机"</span>,
    <span class="token string">"images"</span><span class="token builtin class-name">:</span><span class="token string">"http://image.leyou.com/12479122.jpg"</span>,
    <span class="token string">"price"</span>:3899.00,
    <span class="token string">"stock"</span><span class="token builtin class-name">:</span> <span class="token number">100</span>,
    <span class="token string">"saleable"</span>:true
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体">kibana示例：</font></p> 
<p><font size="2" face="宋体">• PUT financial_report/_doc/izSZ2IYBNh5IGSpnAVb4/</font></p> 
<pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
<span class="token string">"indicator"</span><span class="token builtin class-name">:</span><span class="token string">"李华"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/61/ed/29idvFtS_o.png" alt="在这里插入图片描述"></p> 
<p><font size="2" face="宋体" color="黑体">elasticsearch删除语法</font></p> 
<ol><li> <p><font size="2" face="宋体">根据主键删除数据</font></p> <p><font size="2" face="宋体">语法：【DELETE /索引名称/类型名称/主键编号】</font></p> <p><font size="2" face="宋体">示例：Delete 索引名称/文档名称/主键编号</font></p> </li><li> <p><font size="2" face="宋体">根据匹配条件删除数据</font></p> <p><font size="2" face="宋体">描述：如果你想根据条件来删除你的数据，则在Query查询体中组织你的条件就可以了，注意请求方式是Post</font></p> <p><font size="2" face="宋体">示例：</font></p> <pre><code class="prism language-bash">POST 索引名称/文档名称/_delete_by_query
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
    <span class="token string">"term"</span>:<span class="token punctuation">{<!-- --></span>
      <span class="token string">"_id"</span>:100000100
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><font size="2" face="宋体">删除所有数据</font></p> <p><font size="2" face="宋体">描述：注意请求方式是Post，只删除数据，不删除表结构</font></p> <p><font size="2" face="宋体">示例：</font></p> <pre><code class="prism language-bash">POST /testindex/testtype/_delete_by_query?pretty
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"match_all"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><font size="2" face="宋体">删除单个索引(结构和数据同时删除)</font></p> <p><font size="2" face="宋体">语法：【DELETE /索引名称】</font></p> <p><font size="2" face="宋体">示例：Delete 索引名称</font></p> </li><li> <p><font size="2" face="宋体">删除多个索引</font></p> <p><font size="2" face="宋体">语法：【DELETE /索引1，索引2】</font></p> <p><font size="2" face="宋体">示例：Delete 索引名称1，索引名称2</font></p> </li></ol> 
<p><font size="2" face="宋体" color="黑体">elasticsearch新增语法</font></p> 
<ol><li> <p><font size="2" face="宋体">随机生成id添加数据</font></p> <p><font size="2" face="宋体">通过POST请求，可以向一个已经存在的索引库中添加数据</font></p> <p><font size="2" face="宋体">语法：</font></p> <pre><code class="prism language-bash">POST /索引库名/类型名<span class="token punctuation">{<!-- --></span>    
　　<span class="token string">"key"</span><span class="token builtin class-name">:</span><span class="token string">"value"</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><font size="2" face="宋体">自定义id添加数据</font></p> <p><font size="2" face="宋体">语法：</font></p> <pre><code class="prism language-bash">POST /索引库名/类型/id值
<span class="token punctuation">{<!-- --></span>
   <span class="token string">"key"</span><span class="token builtin class-name">:</span><span class="token string">"value"</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><font size="2" face="宋体">添加字段：</font></p> <p><font size="2" face="宋体">新增字段首先查看索引当前结构（GET）：GET http://IP:9200/user</font></p> <p><font size="2" face="宋体">查询结果例如：</font></p> <pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
	<span class="token string">"user"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string">"aliases"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,
		<span class="token string">"mappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
			<span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
				<span class="token string">"age"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
					<span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"double"</span>
				<span class="token punctuation">}</span>,
				<span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
					<span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"text"</span>
				<span class="token punctuation">}</span>,
				<span class="token string">"sex"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
					<span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"text"</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>,
		<span class="token string">"settings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
			<span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
				<span class="token string">"routing"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
					<span class="token string">"allocation"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
						<span class="token string">"include"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
							<span class="token string">"_tier_preference"</span><span class="token builtin class-name">:</span> <span class="token string">"data_content"</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>,
				<span class="token string">"number_of_shards"</span><span class="token builtin class-name">:</span> <span class="token string">"1"</span>,
				<span class="token string">"provided_name"</span><span class="token builtin class-name">:</span> <span class="token string">"user"</span>,
				<span class="token string">"creation_date"</span><span class="token builtin class-name">:</span> <span class="token string">"1668516591325"</span>,
				<span class="token string">"number_of_replicas"</span><span class="token builtin class-name">:</span> <span class="token string">"1"</span>,
				<span class="token string">"uuid"</span><span class="token builtin class-name">:</span> <span class="token string">"BArUKCd8RFafjfMSu6oHBw"</span>,
				<span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
					<span class="token string">"created"</span><span class="token builtin class-name">:</span> <span class="token string">"8050099"</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p><font size="2" face="宋体">可以看到当前的user索引具有name、age、sex三个字段，此时则可以进行除三个字段外的字段添加，添加模板如下：</font></p> <pre><code class="prism language-bash">PUT /索引名/_mapping
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"字段1"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"float"</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"字段2"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"keyword"</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"字段3"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"text"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p><font size="2" face="宋体">示例：</font></p> <pre><code class="prism language-bash"><span class="token comment">#增加索引字段location，为geo_point索引</span>
<span class="token comment">#PUT /my_index/_mapping/my_type</span>
<span class="token punctuation">{<!-- --></span>
        <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"location"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"type"</span><span class="token builtin class-name">:</span>     <span class="token string">"geo_point"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<blockquote> 
 <p><font size="3" face="宋体" color="black"><span id="sjcxesch">elasticsearch数据查询</span></font></p> 
</blockquote> 
<p><a href="#cxmoban" rel="nofollow"><font size="2" face="宋体" color="grey">查询模板</font></a></p> 
<p><font size="2" face="宋体" color="黑体">elasticsearch中查询方式主要分为URI Search和 Body Search：</font></p> 
<p><img src="https://images2.imgbox.com/15/c5/tX8IBk26_o.png" alt="在这里插入图片描述"></p> 
<p><font size="2" face="宋体">• URI Search：操作简便，方便通过命令进行测试，但它仅能包含部分查询语法</font></p> 
<p><img src="https://images2.imgbox.com/bf/bf/UN6vp9ad_o.png" alt="在这里插入图片描述"></p> 
<p><font size="2" face="宋体">• Body Search：将搜索条件写在请求体中，可以编写复杂查询</font></p> 
<p><img src="https://images2.imgbox.com/c0/77/nuc5Ib62_o.png" alt="在这里插入图片描述"></p> 
<p><font size="2" face="宋体" color="黑体">elasticsearch查询语法</font></p> 
<p><font size="2" face="宋体" color="黑体"><span id="cxmoban">查询模板</span></font></p> 
<p><font size="2" face="宋体">单条件查询模板如下：</font></p> 
<pre><code class="prism language-bash">GET /索引库名/_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"查询类型"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"查询条件"</span><span class="token builtin class-name">:</span><span class="token string">"查询条件值"</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体">查询示例如下：</font></p> 
<pre><code class="prism language-bash"><span class="token comment">#GET /resource_scale/_search</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"match"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"month"</span><span class="token builtin class-name">:</span><span class="token string">"1325347200000"</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体">这里的query代表一个查询对象，里面可以有不同的查询属性</font></p> 
<p><font size="2" face="宋体">查询类型：例如：match_all， match，term ， range 等等<br> <font size="2" face="宋体">查询条件：查询条件会根据类型的不同，写法也有差异，后面详细讲解</font></font></p> 
<ol><li> <p><font size="2" face="宋体">match查询指定条件</font></p> <p><font size="2" face="宋体">match类型查询，会把查询条件进行分词，然后进行查询,多个词条之间是or的关系；例如搜索"小米电视",不仅会查询到电视，而且与小米相关的都会查询到，多个词之间是or的关系。</font></p> <p><font size="2" face="宋体">match查询条件只能作为单条件查询，如果有多个条件，则会报错；</font></p> <p><font size="2" face="宋体">某些情况下，我们需要更精确查找，我们希望这个关系变成and，可以这样做：</font></p> <pre><code class="prism language-bash"><span class="token comment">#GET /heima/_search</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token string">"小米电视"</span>,
            <span class="token string">"operator"</span><span class="token builtin class-name">:</span> <span class="token string">"and"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p><font size="2" face="宋体">示例：查询name = “政治经济概况” 的数据</font></p> <pre><code class="prism language-bash"><span class="token comment">#http://10.254.218.131:9200/sheet_type/_doc/_search</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"match"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"政治经济概况"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p><img src="https://images2.imgbox.com/1f/d0/W1Tx3BbO_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="2" face="宋体">多字段查询（multi_match）</font></p> <p><font size="2" face="宋体">multi_match与match类似，不同的是它可以在多个字段中查询</font></p> <pre><code class="prism language-bash"><span class="token comment">#GET /heima/_search</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"multi_match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"query"</span><span class="token builtin class-name">:</span>    <span class="token string">"小米"</span>,
            <span class="token comment">#在title字段和subtitle字段中查询小米这个词</span>
            <span class="token string">"fields"</span><span class="token builtin class-name">:</span>   <span class="token punctuation">[</span> <span class="token string">"title"</span>, <span class="token string">"subTitle"</span> <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><font size="2" face="宋体">bool多条件查询</font></p> <p><font size="2" face="宋体">match单条件查询会报错，此时需要使用复合查询bool，bool查询包含四种操作<br> <font size="2" face="宋体">• must ：对应mysql的 and a=<br> <font size="2" face="宋体">• must not ：对应mysql的 and a!=<br> <font size="2" face="宋体">• filter ：对应mysql的 and a=<br> <font size="2" face="宋体">• should ：对应mysql的 or a=</font></font></font></font></font></p> <p><font size="2" face="宋体">must和filter不同在于must算分，filter不算分；所以filter效率比must高</font></p> <p><font size="2" face="宋体">精确匹配模板：</font></p> <pre><code class="prism language-bash"><span class="token comment">#精确不分词匹配查找，term/terms，单个匹配是term;多个是terms</span>
<span class="token comment">#存在match搜索可以搜索到但term搜索不到的问题，原因是表中关键词存储的格式是text类型存储的，</span>
<span class="token comment">#text类型数据默认是分词的,所以精确匹配匹配不到。将text类型改成keyword类型即可实现功能。</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token string">"bool"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"must"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"terms"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"键1"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"值11"</span>,<span class="token string">"值12"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,
    		<span class="token string">"should"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"term"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"键2"</span><span class="token builtin class-name">:</span> <span class="token string">"值2"</span><span class="token punctuation">}</span>
    		<span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p><font size="2" face="宋体">条件排除模板：</font></p> <pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token string">"bool"</span>:<span class="token punctuation">{<!-- --></span>
    		<span class="token string">"must"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"match"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"键1"</span><span class="token builtin class-name">:</span> <span class="token string">"值1"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,
    		<span class="token string">"must_not"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"match"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"键2"</span><span class="token builtin class-name">:</span> <span class="token string">"值2"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p><font size="2" face="宋体">或者模板：</font></p> <pre><code class="prism language-bash"><span class="token comment">#如果没有filter和must查询的话，那么必须满足一个should中的条件,表示或者</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token string">"bool"</span>:<span class="token punctuation">{<!-- --></span>
    		<span class="token string">"should"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"match"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"键1"</span><span class="token builtin class-name">:</span> <span class="token string">"值1"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,
    		<span class="token string">"should"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"match"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"键2"</span><span class="token builtin class-name">:</span> <span class="token string">"值2"</span><span class="token punctuation">}</span>
    		<span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p><font size="2" face="宋体">有或没有模板:</font></p> <pre><code class="prism language-bash"><span class="token comment">#如果包含了must或者filter查询，那么should的查询语句就不是或者的意思了,而是有或者没有都行的含义</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token string">"bool"</span>:<span class="token punctuation">{<!-- --></span>
    		<span class="token string">"must"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"match"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"键1"</span><span class="token builtin class-name">:</span> <span class="token string">"值1"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,
    		<span class="token string">"should"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"match"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"键2"</span><span class="token builtin class-name">:</span> <span class="token string">"值2"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p><font size="2" face="宋体">范围查询模板：</font></p> <pre><code class="prism language-bash"><span class="token comment">#范围过滤:range</span>
<span class="token comment">#大于：gt</span>
<span class="token comment">#小于：lt</span>
<span class="token comment">#大于等于：gae</span>
<span class="token comment">#小于等于：lte</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token string">"bool"</span>:<span class="token punctuation">{<!-- --></span>
    		<span class="token string">"must"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"range"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"键"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"gt"</span><span class="token builtin class-name">:</span><span class="token string">"值1"</span>,<span class="token string">"lt"</span><span class="token builtin class-name">:</span><span class="token string">"值2"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    		<span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p><font size="2" face="宋体">字段存在查询模板：</font></p> <pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token string">"bool"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"must"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"exists"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"字段"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    		<span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p><font size="2" face="宋体">过滤条件查询模板：</font></p> <pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"bool"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"must"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"match"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"键"</span> <span class="token builtin class-name">:</span> <span class="token string">"值"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,
            <span class="token string">"filter"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"range"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"条件"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"gt"</span> <span class="token builtin class-name">:</span> 范围 <span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><font size="2" face="宋体">aggs聚合查询</font></p> <p><font size="2" face="宋体">在Elasticsearch中，支持聚合操作，类似SQL中的group by操作</font></p> <p><font size="2" face="宋体">示例：按照年龄进行分组</font></p> <pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"aggs"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"all_interests"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"terms"</span>:<span class="token punctuation">{<!-- --></span>
                <span class="token string">"field"</span><span class="token builtin class-name">:</span><span class="token string">"age"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p><font size="2" face="宋体">返回结果：</font></p> <pre><code class="prism language-bash"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"took"</span><span class="token builtin class-name">:</span> <span class="token number">61</span>,
    <span class="token string">"timed_out"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"_shards"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"total"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
        <span class="token string">"successful"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
        <span class="token string">"skipped"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
        <span class="token string">"failed"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"hits"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"total"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"value"</span><span class="token builtin class-name">:</span> <span class="token number">3</span>,
            <span class="token string">"relation"</span><span class="token builtin class-name">:</span> <span class="token string">"eq"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"max_score"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
        <span class="token string">"hits"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"haoke"</span>,
                <span class="token string">"_type"</span><span class="token builtin class-name">:</span> <span class="token string">"user"</span>,
                <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"LgOccnEBK3PERGtN9-n7"</span>,
                <span class="token string">"_score"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
                <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"王五"</span>,
                    <span class="token string">"age"</span><span class="token builtin class-name">:</span> <span class="token number">20</span>,
                    <span class="token string">"sex"</span><span class="token builtin class-name">:</span> <span class="token string">"女"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>,
            <span class="token punctuation">{<!-- --></span>
                <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"haoke"</span>,
                <span class="token string">"_type"</span><span class="token builtin class-name">:</span> <span class="token string">"user"</span>,
                <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"LwPYcnEBK3PERGtNAOmn"</span>,
                <span class="token string">"_score"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
                <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token number">1002</span>,
                    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"张三"</span>,
                    <span class="token string">"age"</span><span class="token builtin class-name">:</span> <span class="token number">23</span>,
                    <span class="token string">"sex"</span><span class="token builtin class-name">:</span> <span class="token string">"男"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>,
            <span class="token punctuation">{<!-- --></span>
                <span class="token string">"_index"</span><span class="token builtin class-name">:</span> <span class="token string">"haoke"</span>,
                <span class="token string">"_type"</span><span class="token builtin class-name">:</span> <span class="token string">"user"</span>,
                <span class="token string">"_id"</span><span class="token builtin class-name">:</span> <span class="token string">"MAPYcnEBK3PERGtNx-k7"</span>,
                <span class="token string">"_score"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
                <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token number">1003</span>,
                    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"李四"</span>,
                    <span class="token string">"age"</span><span class="token builtin class-name">:</span> <span class="token number">20</span>,
                    <span class="token string">"sex"</span><span class="token builtin class-name">:</span> <span class="token string">"女"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"aggregations"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"all_interests"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"doc_count_error_upper_bound"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"sum_other_doc_count"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"buckets"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"key"</span><span class="token builtin class-name">:</span> <span class="token number">20</span>,
                    <span class="token string">"doc_count"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>     <span class="token comment"># 可以看出，年龄为20的用户有2个</span>
                <span class="token punctuation">}</span>,
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"key"</span><span class="token builtin class-name">:</span> <span class="token number">23</span>,
                    <span class="token string">"doc_count"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>    <span class="token comment"># 可以看出，年龄为23的用户有1个</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<blockquote> 
 <p><font size="3" face="宋体" color="black"><span id="head">elasticsearch-head</span></font></p> 
</blockquote> 
<ol><li> <p><font size="2" face="宋体" color="黑体">elasticsearch-head安装</font></p> <p>elasticsearch不同于solr自带图形化界面,开发者可通过安装elasticsearch的head插件，完成图形化界面的效果，完成索引数据的查看。<br> 1. 安装head插件<br> 2. 安装<a href="https://blog.csdn.net/qq_21561501/article/details/103064239">node.js</a><br> 3.<br> 4.<br> <img src="https://images2.imgbox.com/e8/04/BTzlJEUO_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/49/31/y2rCHoA6_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="2" face="宋体" color="黑体">elasticsearch-head界面介绍</font></p> <p><img src="https://images2.imgbox.com/49/73/7nhGPzWd_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="2" face="宋体" color="黑体">数据浏览区</font></p> <p><font size="2" face="宋体">数据浏览这里以_下划线开头的表示es内置字段，无法进行修改数据；每点击一条数据都会有json格式的显示</font></p> </li><li> <p><font size="2" face="宋体" color="黑体">es-head查询数据</font></p> <p><font size="2" face="宋体">在查询的框中填写es地址和查询的索引</font></p> <p><font size="2" face="宋体">_search表示查询索引中的所有数据，类型选择GET，最后点击提交请求<br> <img src="https://images2.imgbox.com/2f/b6/X3IqLmTl_o.png" alt="在这里插入图片描述"></font></p> </li><li> <p>分词插件<br> 下载地址：https://github.com/medcl/elasticsearch-analysis-ik/releases<a href="https://github.com/medcl/elasticsearch-analysis-ik/releases">点击这里</a><br> <img src="https://images2.imgbox.com/90/ff/sv5alFRj_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/ae/11/pKkvJP9w_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/92/c8/pk8M0moQ_o.png" alt="在这里插入图片描述"><br> ik分词器提供了两种分词算法 : ik_smart和ik_max_word<br> 其中ik_smart为最小切分，ik_max_word为最细粒度划分<br> 具体测试可用上文的方法测试即可</p> </li></ol> 
<hr> 
<p><font size="4">第三种客户端操作elasticsearch</font></p> 
<p>使用java客户端操作elasticsearch</p> 
<p>目标：</p> 
<ol><li>能够使用Java客户端完成创建，删除索引的操作</li><li>能够使用java客户端完成文档的增删改查的操作</li><li>能够使用java客户端完成文档的查询操作</li><li>能够完成文档的分页操作</li><li>能够完成文档的高亮查询操作</li><li>能够搭建springdata elasticsearch的环境</li><li>能够完成spring data elasticsearch的基本增删改查操作</li><li>能够掌握基本条件查询的方法命名规则</li></ol> 
<p>【1】使用Java客户端管理es</p> 
<ol><li> <p>创建索引库</p> 
  <ol><li> <p>步骤：<br> -创建java maven工程 <br> -添加jar包，添加maven坐标<br> -编写测试方法实现创建索引库</p> 
    <ol><li>创建一个Settting对象，相当于是一个配置信息。主要配置集群的名称。</li><li>创建一个客户端Client对象</li><li>使用client对象创建一个索引库</li><li>关闭client对象</li></ol> </li><li> <p>步骤实现:</p> 
    <ol><li> <p>创建工程及导入坐标<br> <img src="https://images2.imgbox.com/09/90/IXFL8mN9_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/fa/2c/mOuxUfi2_o.png" alt="在这里插入图片描述"></p> </li><li> <p>编写测试方法<br> <code>节点名称、ip、端口可在config/elasticsearch.yml中查看</code><br> <img src="https://images2.imgbox.com/5e/71/O2VpMzRt_o.png" alt="在这里插入图片描述"></p> <pre><code class="prism language-java"> <span class="token comment">/**
     * 创建索引库（无mapping）
     * @throws UnknownHostException
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建一个Setting对象，相当于是一个配置信息，主要配置集群的名称</span>
        <span class="token class-name">Settings</span> settings <span class="token operator">=</span> <span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"cluster.name"</span><span class="token punctuation">,</span> <span class="token string">"my-application"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建一个客户端client对象</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TransportClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreBuiltTransportClient</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//InetSocketTransportAddress 在es6.*以上版本是没有这个了，但是在5.*中还在用</span>
        <span class="token comment">//如果是springboot项目中，6.8.3是springboot父工程中已配置好的版本,如果读者使用的es版本是es5.*，可在Pom文件中添加版本锁定即可</span>
        client<span class="token punctuation">.</span><span class="token function">addTransportAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransportAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">"192.168.33.100"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">9300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//es是集群部署,假如第一个节点挂了,会自动找接下来的节点进行连接</span>
<span class="token comment">//        client.addTransportAddress(new TransportAddress(InetAddress.getByName("192.168.33.100"),9301));</span>
<span class="token comment">//        client.addTransportAddress(new TransportAddress(InetAddress.getByName("192.168.33.100"),9302));</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//使用client对象创建一个索引库</span>
        client<span class="token punctuation">.</span><span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prepareCreate</span><span class="token punctuation">(</span><span class="token string">"index_java"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//关闭client对象</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> </li></ol> </li></ol> </li><li> <p>使用java客户端设置mappings</p> 
  <ol><li> <p>步骤：<br> -创建一个Setting对象<br> -创建一个Client对象<br> -创建一个mapping信息,应该是一个json数据,可以是字符串，也可以是XContextBuilder对象<br> -使用client同es服务器发送mapping信息<br> -关闭client对象</p> </li><li> <p>实现步骤</p> <pre><code class="prism language-java">  <span class="token comment">/**
     * 设置索引库mapping
     * @throws UnknownHostException
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">setMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建一个setting对象</span>
        <span class="token class-name">Settings</span> settings <span class="token operator">=</span> <span class="token class-name">Settings</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"cluster.name"</span><span class="token punctuation">,</span> <span class="token string">"my-application"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建客户端对象</span>
        <span class="token class-name">TransportClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreBuiltTransportClient</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token function">addTransportAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransportAddress</span><span class="token punctuation">(</span><span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">"192.168.33.100"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">9300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XContentBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">XContentFactory</span><span class="token punctuation">.</span><span class="token function">jsonBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">"article"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">"properties"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"long"</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"store"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"store"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"analyzer"</span><span class="token punctuation">,</span> <span class="token string">"hanlp"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">startObject</span><span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"store"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"analyzer"</span><span class="token punctuation">,</span> <span class="token string">"hanlp"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">endObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//使用client把mapping信息设置到索引库中</span>
        client<span class="token punctuation">.</span><span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//设置要做mapping的索引</span>
                <span class="token punctuation">.</span><span class="token function">preparePutMapping</span><span class="token punctuation">(</span><span class="token string">"index_java"</span><span class="token punctuation">)</span>
                <span class="token comment">//设置要做索引的type</span>
                <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"article"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span>
                <span class="token comment">//执行操作</span>
                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//关闭连接</span>
        client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> </li><li></ol> </li></ol> 
<blockquote> 
 <p><font size="3" face="宋体" color="black"><span id="postman">elasticsearch-postman</span></font></p> 
</blockquote> 
<p><font size="2" face="宋体">使用Postman向ES发送put请求进行文档的存储/更新：https://ip:9200/索引/类别/文档<br> 使用Postman向ES发送get请求进行文档的获取：https://ip:9200/索引/类别/文档<br> 使用Postman向ES发送head请求进行文档是否存在，200存在，404不存在：https://ip:9200/索引/类别/文档<br> 使用Postman向ES发送delete请求进行文档的删除：https://ip:9200/索引/类别/文档</font></p> 
<p><font size="2" face="宋体">查询所有文档所有 get方法：https://ip:9200/索引/类别/_search<br> 查询满足条件的文档 get方法：https://ip:9200/索引/类别/_search?q=键:值<br> 使用查询表达式搜索满足条件的文档 post方法：https://ip:9200/索引/类别/_search加上一个表达式的json</font></p> 
<ol><li> <p><font size="2" face="宋体">添加索引【PUT】</font></p> <p><font size="1" face="宋体">http://127.0.0.1:9200/索引名称<br> <img src="https://images2.imgbox.com/e9/a4/lNy0CzIC_o.png" alt="在这里插入图片描述"></font></p> </li><li> <p><font size="2" face="宋体">添加索引附带Mapping【PUT】</font></p> <p><font size="1" face="宋体">http://127.0.0.1:9200/索引名称</font></p> <pre><code class="prism language-java"><span class="token punctuation">{<!-- --></span>
	<span class="token string">"mappings"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
		<span class="token string">"usermessage"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
			
			<span class="token string">"properties"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
				<span class="token string">"id"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
					<span class="token string">"type"</span><span class="token operator">:</span><span class="token string">"long"</span><span class="token punctuation">,</span>
					<span class="token string">"store"</span><span class="token operator">:</span><span class="token boolean">true</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token string">"titile"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
					<span class="token string">"type"</span><span class="token operator">:</span><span class="token string">"text"</span><span class="token punctuation">,</span>
					<span class="token string">"store"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
					<span class="token string">"index"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
					<span class="token string">"analyzer"</span><span class="token operator">:</span><span class="token string">"standard"</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token string">"content"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
					<span class="token string">"type"</span><span class="token operator">:</span><span class="token string">"text"</span><span class="token punctuation">,</span>
					<span class="token string">"store"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
					<span class="token string">"index"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
					<span class="token string">"analyzer"</span><span class="token operator">:</span><span class="token string">"standard"</span>
				<span class="token punctuation">}</span>
				
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p><img src="https://images2.imgbox.com/a7/2b/Mz8qc9pI_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="2" face="宋体">添加文档并指定ID【POST】</font></p> <p><font size="1" face="宋体">http://127.0.0.1:9200/索引名称/索引类型/自定义ID</font></p> <p><img src="https://images2.imgbox.com/e2/71/2VkzVjfM_o.png" alt="在这里插入图片描述"> <img src="https://images2.imgbox.com/eb/e4/GcPsstaq_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="2" face="宋体">添加文档不指定ID【POST】</font></p> <p><font size="1" face="宋体">http://127.0.0.1:9200/索引名称/索引类型</font></p> <p><img src="https://images2.imgbox.com/a6/49/OSqcRiQH_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d1/35/QZ1Q6ImF_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="2" face="宋体">主键查询【GET】</font></p> <p><font size="1" face="宋体">http://127.0.0.1:9200/索引名称/_doc/ID编号</font></p> <p><img src="https://images2.imgbox.com/35/5f/82BvTXlh_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="2" face="宋体">全查询【GET】</font></p> <p><font size="1" face="宋体">http://127.0.0.1:9200/索引名称/_search</font></p> <p><img src="https://images2.imgbox.com/85/e9/udWsUM7q_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="2" face="宋体">修改文档【PUT】</font></p> <p><font size="1" face="宋体">http://127.0.0.1:9200/索引名称/_doc/ID编号</font></p> <p><img src="https://images2.imgbox.com/ff/dc/n5FpuYtL_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="2" face="宋体">删除文档【DELETE】</font></p> <p><font size="1" face="宋体">http://127.0.0.1:9200/索引名称/_doc/ID编号</font></p> <p><font size="1" face="宋体">如果重复删除，则result 则返回not_found <img src="https://images2.imgbox.com/23/f7/ofbqXEWa_o.png" alt="在这里插入图片描述"></font></p> </li><li> <p>删除索引</p> 
  <ol><li>通过Postman删除<br> <img src="https://images2.imgbox.com/38/25/Nz14TtwG_o.png" alt="在这里插入图片描述"></li><li>通过elasticsearch-head的复合查询删除<br> <img src="https://images2.imgbox.com/39/83/FIUkhqWb_o.png" alt="在这里插入图片描述"></li></ol> </li><li> <p>搜索文档方式</p> 
  <ol><li>通过通过postman _search<br> <img src="https://images2.imgbox.com/23/ef/nXCJJgbc_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/e1/f4/qJAZwfxd_o.png" alt="在这里插入图片描述">2. 通过通过postman query_string查询<br> <img src="https://images2.imgbox.com/3c/47/RbGr4ODN_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/da/d9/L4K7X1iC_o.png" alt="在这里插入图片描述"></li></ol> </li><li> <p>通过head图形化插件查询<br> <img src="https://images2.imgbox.com/06/cd/2bEDB5aW_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<hr> 
<hr> 
<ol><li>分词器分词效果测试方法：<br> <img src="https://images2.imgbox.com/61/cf/tbboY8B7_o.png" alt="在这里插入图片描述"></li></ol> 
<blockquote> 
 <p><font size="3" face="宋体" color="black"><span id="Kibana">elasticsearch-Kibana</span></font></p> 
</blockquote> 
<ol><li> <p><font size="2" face="宋体">创建索引及文档</font></p> <pre><code class="prism language-bash"><span class="token comment">#PUT twitter/_doc/1</span>
<span class="token punctuation">{<!-- --></span>
 <span class="token string">"user"</span><span class="token builtin class-name">:</span> <span class="token string">"GB"</span>,
 <span class="token string">"uid"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
 <span class="token string">"city"</span><span class="token builtin class-name">:</span> <span class="token string">"Beijing"</span>,
 <span class="token string">"province"</span><span class="token builtin class-name">:</span> <span class="token string">"Beijing"</span>,
 <span class="token string">"country"</span><span class="token builtin class-name">:</span> <span class="token string">"China"</span>
<span class="token punctuation">}</span>
</code></pre> <p><img src="https://images2.imgbox.com/59/f8/RK6fROYT_o.png" alt="在这里插入图片描述"></p> </li><li> <p><font size="2" face="宋体">修改文档</font></p> <pre><code class="prism language-bash"><span class="token comment">#POST twitter/_update/1</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"doc"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"city"</span><span class="token builtin class-name">:</span> <span class="token string">"成都"</span>,
    <span class="token string">"province"</span><span class="token builtin class-name">:</span> <span class="token string">"四川"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p><img src="https://images2.imgbox.com/44/b0/WzbJl0Wp_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<blockquote> 
 <p><font size="3" face="宋体" color="black"><span id="sb">springboot-elasticsearch</span></font></p> 
</blockquote> 
<p><font size="2" face="宋体">Spring Data 的强大之处，就在于你不用写任何DAO处理，自动根据方法名或类的信息进行CRUD操作。只要你定义一个接口，然后继承Repository提供的一些子接口，就能具备各种基本的CRUD功能。</font></p> 
<p><font size="2" face="宋体">把数据存储到es中，有两种方式一种是 ElasticsearchRepository 接口，另一种是ElasticsearchTemplate接口，今天我们主要分析ElasticsearchRepository接口。</font></p> 
<p><font size="2" face="宋体">具体流程如下：</font></p> 
<ol><li> <p><font size="2" face="宋体">配置文件增加属性</font></p> <pre><code class="prism language-java"><span class="token comment">//端口配置</span>
spring<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>rest<span class="token punctuation">.</span>uris<span class="token operator">=</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">9200</span>
<span class="token comment">//集群名称</span>
spring<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>rest<span class="token punctuation">.</span>username<span class="token operator">=</span> xy_elastic
</code></pre> </li><li> <p><font size="2" face="宋体">接口继承ElasticSearchRepository</font></p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ItemRepository</span> <span class="token keyword">extends</span> <span class="token class-name">ElasticsearchRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre> </li><li> <p><font size="2" face="宋体">实体类</font></p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token comment">/*
 *indexName : 文档名称
 *shards: 分片数量，默认1
 */</span>
<span class="token annotation punctuation">@Document</span><span class="token punctuation">(</span>indexName <span class="token operator">=</span> <span class="token string">"item"</span><span class="token punctuation">,</span> shards <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Item</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Text</span> <span class="token punctuation">,</span> analyzer <span class="token operator">=</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Long</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> price<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Text</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Date</span><span class="token punctuation">,</span> format <span class="token operator">=</span> <span class="token class-name">DateFormat</span><span class="token punctuation">.</span>custom<span class="token punctuation">,</span> pattern <span class="token operator">=</span> <span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonFormat</span><span class="token punctuation">(</span>shape <span class="token operator">=</span> <span class="token class-name">JsonFormat<span class="token punctuation">.</span>Shape</span><span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span> pattern <span class="token operator">=</span> <span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> date<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> </li><li> <p><font size="2" face="宋体">ElasticSearchRepository已封装方法（保存/更新/批量保存/删除/查询/查询全部）</font></p> <pre><code class="prism language-java"><span class="token punctuation">{<!-- --></span>
	<span class="token annotation punctuation">@Autowired</span>
	<span class="token keyword">private</span> <span class="token class-name">ItemRepository</span> itemRepository<span class="token punctuation">;</span>
	
	<span class="token comment">//实体类</span>
	<span class="token class-name">Item</span> item <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	item<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	item<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"ElasticSearch目前最新的已到7X"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	item<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">30000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//保存 或 更新（区分的依据就是id）</span>
	itemRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//批量保存</span>
	itemRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//删除</span>
	itemRepository<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/**
	     * 通过id获取信息
	     *
	     * @param id id
	     * @return {@link Item}
	     */</span>
	<span class="token keyword">public</span> <span class="token class-name">Item</span> <span class="token function">esGetInfoById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	     <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> item <span class="token operator">=</span> itemRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	     <span class="token keyword">return</span>  item<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	     * 查询全部
	     *
	     * @param id id
	     * @return {@link Item}
	     */</span>
	<span class="token keyword">public</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> <span class="token function">esGetInfoAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	     <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> itemRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	     <span class="token keyword">return</span>  items<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><font size="2" face="宋体">ItemRepository自定义方法</font></p> <p><font size="2" face="宋体">Spring Data 的另一个强大功能，是根据方法名称自动实现功能。<br> 比如：你的方法名叫做：findByTitle，那么它就知道你是根据title查询，然后自动帮你完成，无需写实现类。</font></p> <p><font size="2" face="宋体">当然，方法名称要符合一定的约定：</font></p> 
  <table><thead><tr><th><font size="2" face="宋体">Keyword</font></th><th><font size="2" face="宋体">例子</font></th><th><font size="2" face="宋体">Elasticsearch Query String</font></th></tr></thead><tbody><tr><td><font size="2" face="宋体">And</font></td><td><font size="2" face="宋体">findByNameAndPrice</font></td><td><font size="2" face="宋体">{“bool” : {“must” : [ {“field” : {“name” : “?”}}, {“field” : {“price” : “?”}} ]}}</font></td></tr><tr><td><font size="2" face="宋体">Or</font></td><td><font size="2" face="宋体">findByNameOrPrice</font></td><td><font size="2" face="宋体"> {“bool” : {“should” : [ {“field” : {“name” : “?”}}, {“field” : {“price” : “?”}} ]}}</font></td></tr><tr><td><font size="2" face="宋体">Is</font></td><td><font size="2" face="宋体"> findByName</font></td><td><font size="2" face="宋体"> {“bool” : {“must” : {“field” : {“name” : “?”}}}}</font></td></tr><tr><td><font size="2" face="宋体">Not</font></td><td><font size="2" face="宋体">findByNameNot</font></td><td><font size="2" face="宋体">{“bool” : {“must_not” : {“field” : {“name” : “?”}}}}</font></td></tr><tr><td><font size="2" face="宋体">Between</font></td><td><font size="2" face="宋体">findByPriceBetween</font></td><td><font size="2" face="宋体">{“bool” : {“must” : {“range” : {“price” : {“from” : ?,“to” : ?,“include_lower” : true,“include_upper” : true}}}}}</font></td></tr><tr><td><font size="2" face="宋体">LessThanEqual</font></td><td><font size="2" face="宋体">findByPriceLessThan</font></td><td><font size="2" face="宋体">{“bool” : {“must” : {“range” : {“price” : {“from” : null,“to” : ?,“include_lower” : true,“include_upper” : true}}}}}</font></td></tr><tr><td><font size="2" face="宋体">GreaterThanEqual</font></td><td><font size="2" face="宋体">findByPriceGreaterThan</font></td><td><font size="2" face="宋体">{“bool” : {“must” : {“range” : {“price” : {“from” : ?,“to” : null,“include_lower” : true,“include_upper” : true}}}}}</font></td></tr><tr><td><font size="2" face="宋体">Before</font></td><td><font size="2" face="宋体">findByPriceBefore</font></td><td><font size="2" face="宋体">{“bool” : {“must” : {“range” : {“price” : {“from” : null,“to” : ?,“include_lower” : true,“include_upper” : true}}}}}</font></td></tr><tr><td><font size="2" face="宋体">After</font></td><td><font size="2" face="宋体"> findByPriceAfter</font></td><td><font size="2" face="宋体"> {“bool” : {“must” : {“range” : {“price” : {“from” : ?,“to” : null,“include_lower” : true,“include_upper” : true}}}}}</font></td></tr><tr><td><font size="2" face="宋体"> Like</font></td><td><font size="2" face="宋体">findByNameLike</font></td><td><font size="2" face="宋体">{“bool” : {“must” : {“field” : {“name” : {“query” : “?*”,“analyze_wildcard” : true}}}}}</font></td></tr><tr><td><font size="2" face="宋体">StartingWith</font></td><td><font size="2" face="宋体"> findByNameStartingWith</font></td><td><font size="2" face="宋体">{“bool” : {“must” : {“field” : {“name” : {“query” : “?*”,“analyze_wildcard” : true}}}}}</font></td></tr><tr><td><font size="2" face="宋体">EndingWith</font></td><td><font size="2" face="宋体">findByNameEndingWith</font></td><td><font size="2" face="宋体"> {“bool” : {“must” : {“field” : {“name” : {“query” : “*?”,“analyze_wildcard” : true}}}}}</font></td></tr></tbody></table><pre><code class="prism language-java"><span class="token comment">/**
     * 获取页面项目
     *
     * @param keyWord  关键字
     * @param pageable 可分页
     * @return {@link Page&lt;Item&gt;}
     */</span>
<span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPageItems</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyWord<span class="token punctuation">,</span> <span class="token class-name">Pageable</span> pageable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">NativeSearchQueryBuilder</span> nativeSearchQueryBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeSearchQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构建布尔查询</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * must 多条件 &amp;（并且）
     * mustNot 多条件 != (非)
     * should 多条件 || (或)
     */</span>
     <span class="token comment">// 关键字查询</span>
    boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span>keyWord<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">withQuery</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">withPageable</span><span class="token punctuation">(</span>pageable<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> itemRepository<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>nativeSearchQueryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<blockquote> 
 <p><font size="3" face="宋体" color="black"><span id="kljs">快捷使用导航</span></font></p> 
</blockquote> 
<p><font size="2" face="宋体" color="黑体">索引查询分类</font></p> 
<p><a href="#syjgcx" rel="nofollow"><font size="2" face="宋体" color="grey">索引结构查询</font></a></p> 
<hr> 
<p><font size="2" face="宋体" color="黑体">数据修改分类</font></p> 
<p><a href="#dxxzxzg" rel="nofollow"><font size="2" face="宋体" color="grey">单字段修改</font></a></p> 
<hr> 
<p><font size="2" face="宋体" color="黑体">数据查询分类</font></p> 
<p><a href="#daxcx" rel="nofollow"><font size="2" face="宋体" color="grey">单条件查询</font></a></p> 
<p><a href="#zdzsxx" rel="nofollow"><font size="2" face="宋体" color="grey">多条件查询</font></a></p> 
<p><a href="#qbcx" rel="nofollow"><font size="2" face="宋体" color="grey">全部字段查询</font></a></p> 
<p><a href="#zdzdfh" rel="nofollow"><font size="2" face="宋体" color="grey">指定字段查询</font></a></p> 
<p><a href="#pacxzcx" rel="nofollow"><font size="2" face="宋体" color="grey">排除字段查询</font></a></p> 
<p><a href="#zdtsdz" rel="nofollow"><font size="2" face="宋体" color="grey">指定条数返回查询</font></a></p> 
<p><a href="#fyfhcx" rel="nofollow"><font size="2" face="宋体" color="grey">分页返回查询</font></a></p> 
<p><a href="#dccx" rel="nofollow"><font size="2" face="宋体" color="grey">多词查询（or）</font></a></p> 
<p><a href="#dccxand" rel="nofollow"><font size="2" face="宋体" color="grey">多词查询（and）</font></a></p> 
<hr> 
<p><font size="2" face="宋体" color="黑体">数据删除分类</font></p> 
<p><a href="#dtsc" rel="nofollow"><font size="2" face="宋体" color="grey">单条删除</font></a></p> 
<p><a href="#zzdxg" rel="nofollow"><font size="2" face="宋体" color="grey">批量删除</font></a></p> 
<hr> 
<p><font size="2" face="宋体" color="黑体">数据汇总分类</font></p> 
<p><a href="#fhmgzdqh" rel="nofollow"><font size="2" face="宋体" color="grey">返回某个字段数值求和</font></a></p> 
<p><a href="#gshzmgzd" rel="nofollow"><font size="2" face="宋体" color="grey">返回某个字段个数汇总</font></a></p> 
<p><a href="#bszqhhuiz" rel="nofollow"><font size="2" face="宋体" color="grey">返回某个字段个数汇总并数值求和</font></a></p> 
<hr> 
<p><font size="2" face="宋体" color="黑体">数据类型分类</font></p> 
<p><a href="#zzdxg" rel="nofollow"><font size="2" face="宋体" color="grey">字段类型修改</font></a></p> 
<hr> 
<p><font size="2" face="宋体">查看索引user中的数据：GET http://IP:9200/user/_search</font></p> 
<p><font size="2" face="宋体">当前索引增加字段：</font></p> 
<pre><code class="prism language-bash">PUT s_person/_mapping/_doc?include_type_name<span class="token operator">=</span>true
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"weight"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"integer"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体">索引空列数据统一赋值：</font></p> 
<pre><code class="prism language-bash">POST http://IP:9200/user/_update_by_query
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"script"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"lang"</span><span class="token builtin class-name">:</span> <span class="token string">"painless"</span>,
        <span class="token string">"inline"</span><span class="token builtin class-name">:</span> <span class="token string">"ctx._source.class = '一班'"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体">索引空列数据按判断赋值：</font></p> 
<pre><code class="prism language-bash">POST s_person/_doc/_update_by_query
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"script"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"lang"</span><span class="token builtin class-name">:</span><span class="token string">"painless"</span>,
        <span class="token string">"source"</span><span class="token builtin class-name">:</span><span class="token string">"if (ctx._source.weight == null) {ctx._source.weight = 1}"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体">索引空列数据赋其他字段的值：</font></p> 
<pre><code class="prism language-bash">POST http://IP:9200/user/_update_by_query
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"script"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"lang"</span><span class="token builtin class-name">:</span> <span class="token string">"painless"</span>,
        <span class="token string">"inline"</span><span class="token builtin class-name">:</span> <span class="token string">"ctx._source.class = ctx._source.sex"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="syjgcx">索引结构查询</span></font></p> 
<pre><code class="prism language-bash"><span class="token comment">#GET  http://IP:9200/user</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="dxxzxzg">单字段修改</span></font></p> 
<pre><code class="prism language-bash"><span class="token comment">#POST data_report/_update/DDSLyoYBEypAanHiieNt</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"doc"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"status"</span><span class="token builtin class-name">:</span> <span class="token string">"IMPORT"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="daxcx">单字段查询</span></font></p> 
<pre><code class="prism language-bash"><span class="token comment">#GET /resource_scale/_search</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"match"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"month"</span><span class="token builtin class-name">:</span><span class="token string">"1325347200000"</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="zdzsxx">多字段查询</span></font></p> 
<pre><code class="prism language-bash"><span class="token comment">#GET data_report/_search</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"bool"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"must"</span>:<span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span><span class="token string">"match"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"status"</span><span class="token builtin class-name">:</span><span class="token string">"PENDING_REVIEW"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,
                <span class="token punctuation">{<!-- --></span><span class="token string">"term"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"province"</span><span class="token builtin class-name">:</span><span class="token string">"新疆"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="qbcx">全部字段查询</span></font></p> 
<pre><code class="prism language-bash">GET /heima/_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
    	<span class="token string">"match_all"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="zdzdfh">指定字段查询</span></font></p> 
<pre><code class="prism language-bash">GET network_scale/_search?size<span class="token operator">=</span><span class="token number">30</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
     <span class="token string">"includes"</span>:<span class="token punctuation">[</span><span class="token string">"dbId"</span>,<span class="token string">"userId"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
    	<span class="token string">"match_all"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="pacxzcx">排除字段查询</span></font></p> 
<pre><code class="prism language-bash">GET network_scale/_search?size<span class="token operator">=</span><span class="token number">30</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
     <span class="token string">"excludes"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"nickName"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
    	<span class="token string">"match_all"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="zdtsdz">指定条数返回查询</span></font></p> 
<pre><code class="prism language-bash">GET network_scale/_search?size<span class="token operator">=</span><span class="token number">30</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"bool"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"must"</span>:<span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span><span class="token string">"match"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"month"</span><span class="token builtin class-name">:</span><span class="token string">"1654012800000"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,
                <span class="token punctuation">{<!-- --></span><span class="token string">"term"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"province"</span><span class="token builtin class-name">:</span><span class="token string">"广东"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="fyfhcx">分页返回查询</span></font></p> 
<pre><code class="prism language-bash">GET network_scale/_search?size<span class="token operator">=</span><span class="token number">30</span><span class="token operator">&amp;</span><span class="token assign-left variable">from</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"bool"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"must"</span>:<span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span><span class="token string">"match"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"month"</span><span class="token builtin class-name">:</span><span class="token string">"1654012800000"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,
                <span class="token punctuation">{<!-- --></span><span class="token string">"term"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"province"</span><span class="token builtin class-name">:</span><span class="token string">"广东"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="dccx">多词查询（or）</span></font></p> 
<pre><code class="prism language-bash"><span class="token comment">#title 字段中包含brown 或 dog的都进行查询</span>
<span class="token comment">#它在内部实际上先执行两次 term 查询，然后将两次查询的结果合并作为最终结果输出,为了做到这点，它将两个 term 查询包入一个 bool 查询中</span>
GET /my_index/my_type/_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token string">"BROWN DOG!"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="dccxand">多词查询（and）</span></font></p> 
<pre><code class="prism language-bash"><span class="token comment">#match 查询还可以接受 operator 操作符作为输入参数，默认情况下该操作符是 or </span>
GET /my_index/my_type/_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"match"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>      
                <span class="token string">"query"</span><span class="token builtin class-name">:</span>    <span class="token string">"BROWN DOG!"</span>,
                <span class="token string">"operator"</span><span class="token builtin class-name">:</span> <span class="token string">"and"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体">多次字段分组查询：</font></p> 
<pre><code class="prism language-bash"><span class="token comment">#GET /你的索引/_search</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
	<span class="token string">"aggregations"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
		<span class="token string">"字段一的结果命名"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
			<span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
				<span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"startTime.keyword"</span>
			<span class="token punctuation">}</span>,
			<span class="token string">"aggregations"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
				<span class="token string">"字段二的结果命名"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
					<span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
						<span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"aa.keyword"</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="dtsc">单条删除</span></font></p> 
<pre><code class="prism language-bash">DELETE /network_scale/_doc/njWj34YBNh5IGSpnWRkp
</code></pre> 
<p><font size="2" face="宋体"><span id="fhmgzdqh">返回某个字段数值求和</span></font></p> 
<pre><code class="prism language-bash">GET network_scale/_search?size<span class="token operator">=</span><span class="token number">30</span>
<span class="token punctuation">{<!-- --></span>
  
    <span class="token string">"_source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"fiveGNetworkScale._5GAmount.jiZhanKaiTong"</span>
    <span class="token punctuation">]</span>,
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"bool"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"must"</span>:<span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span><span class="token string">"match"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"month"</span><span class="token builtin class-name">:</span><span class="token string">"1654012800000"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,
                <span class="token punctuation">{<!-- --></span><span class="token string">"term"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"province"</span><span class="token builtin class-name">:</span><span class="token string">"广东"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"aggs"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token string">"5GAmountNum"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> 
            <span class="token string">"sum"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> 
              <span class="token string">"field"</span> <span class="token builtin class-name">:</span> <span class="token string">"fiveGNetworkScale._5GAmount.jiZhanKaiTong"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="gshzmgzd">返回某个字段个数汇总</span></font></p> 
<pre><code class="prism language-bash">GET network_scale/_search?size<span class="token operator">=</span><span class="token number">30</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"bool"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"must"</span>:<span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"match"</span>:<span class="token punctuation">{<!-- --></span>
                        <span class="token string">"month"</span><span class="token builtin class-name">:</span><span class="token string">"1651334400000"</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>,
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"term"</span>:<span class="token punctuation">{<!-- --></span>
                        <span class="token string">"province"</span><span class="token builtin class-name">:</span><span class="token string">"新疆"</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"aggs"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"groupByFactory"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"terms"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token builtin class-name">:</span> <span class="token string">"factory"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="bszqhhuiz">返回某个字段个数汇总并数值求和</span></font></p> 
<pre><code class="prism language-bash">在这里插入代码片
</code></pre> 
<p><font size="2" face="宋体"><span id="zzdxg">批量删除修改</span></font></p> 
<pre><code class="prism language-bash"><span class="token comment">#POST planning_data/_delete_by_query</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"query"</span>:<span class="token punctuation">{<!-- --></span>
        <span class="token string">"bool"</span>:<span class="token punctuation">{<!-- --></span>
            <span class="token string">"must"</span>:<span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span><span class="token string">"match"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"province"</span><span class="token builtin class-name">:</span><span class="token string">"浙江"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>,
                <span class="token punctuation">{<!-- --></span><span class="token string">"match"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"month"</span><span class="token builtin class-name">:</span><span class="token string">"1693497600000"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体"><span id="zzdxg">字段类型修改</span></font></p> 
<pre><code class="prism language-bash"><span class="token comment">#前提1：原索引</span>

PUT my_index
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"mappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"_doc"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"create_date"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span><span class="token builtin class-name">:</span>   <span class="token string">"date"</span>,
          <span class="token string">"format"</span><span class="token builtin class-name">:</span> <span class="token string">"yyyy-MM-dd ||yyyy/MM/dd"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">#修改字段类型步骤1：创建新索引</span>

PUT my_index2
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"mappings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"_doc"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"properties"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"create_date"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"type"</span><span class="token builtin class-name">:</span>   <span class="token string">"text"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">#修改字段类型步骤2：同步数据</span>

POST _reindex
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"source"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"my_index"</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"dest"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"my_index2"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">#修改字段类型步骤3：删除原索引</span>

DELETE my_index

<span class="token comment">#修改字段类型步骤4（拓展）：设置别名</span>

POST /_aliases
<span class="token punctuation">{<!-- --></span>
      <span class="token string">"actions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{<!-- --></span><span class="token string">"add"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"index"</span><span class="token builtin class-name">:</span> <span class="token string">"my_index2"</span>, <span class="token string">"alias"</span><span class="token builtin class-name">:</span> <span class="token string">"my_index"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
<span class="token punctuation">}</span>


</code></pre> 
<blockquote> 
 <p><font size="3" face="宋体" color="black"><span id="javspi">API快捷使用导航</span></font></p> 
</blockquote> 
<p><font size="2" face="宋体" color="黑体">聚合分类</font></p> 
<p><a href="#dzdjhssss" rel="nofollow"><font size="2" face="宋体" color="grey">单字段聚合汇总</font></a></p> 
<p><a href="#dzdjhssqq" rel="nofollow"><font size="2" face="宋体" color="grey">多字段聚合汇总</font></a></p> 
<p><a href="#zuidapjixz" rel="nofollow"><font size="2" face="宋体" color="grey">单字段聚合求单字段的最大/最小/平均</font></a></p> 
<p><a href="#zuidapjissxz" rel="nofollow"><font size="2" face="宋体" color="grey">单字段聚合求多字段的最大/最小/平均</font></a></p> 
<p><a href="#jhsjzpx" rel="nofollow"><font size="2" face="宋体" color="grey">单字段聚合汇总并排序</font></a></p> 
<p><a href="#jgjsqbfh" rel="nofollow"><font size="2" face="宋体" color="grey">单字段聚合汇总返回所有结果条数</font></a></p> 
<hr> 
<p><font size="2" face="宋体" color="黑体"><span id="dzdjhssss">单字段聚合</span></font></p> 
<p><font size="2" face="宋体">sql表示语句</font></p> 
<pre><code class="prism language-sql"><span class="token comment">--计算每个球队的球员数</span>
<span class="token keyword">select</span> team<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> player_count <span class="token keyword">from</span> player <span class="token keyword">group</span> <span class="token keyword">by</span> team<span class="token punctuation">;</span>
</code></pre> 
<p><font size="2" face="宋体">es表示语句</font></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> main <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

	<span class="token class-name">TermsBuilder</span> teamAgg<span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"player_count "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"team"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sbuilder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>teamAgg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> sbuilder<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">actionGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体" color="黑体"><span id="dzdjhssqq">多字段聚合</span></font></p> 
<p><font size="2" face="宋体">sql表示语句</font></p> 
<pre><code class="prism language-sql"><span class="token comment">--计算每个球队每个位置的球员数</span>
<span class="token keyword">select</span> team<span class="token punctuation">,</span> position<span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pos_count <span class="token keyword">from</span> player <span class="token keyword">group</span> <span class="token keyword">by</span> team<span class="token punctuation">,</span> position<span class="token punctuation">;</span>
</code></pre> 
<p><font size="2" face="宋体">es表示语句</font></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> main <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

	<span class="token class-name">TermsBuilder</span> teamAgg<span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"player_count "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"team"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">TermsBuilder</span> posAgg<span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"pos_count"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"position"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sbuilder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>teamAgg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>posAgg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> sbuilder<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">actionGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体" color="黑体"><span id="zuidapjixz">单字段聚合求最大/最小/平均</span></font></p> 
<p><font size="2" face="宋体">sql表示语句</font></p> 
<pre><code class="prism language-sql"><span class="token comment">--计算每个球队年龄最大/最小/总/平均的球员年龄</span>
<span class="token keyword">select</span> team<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span> <span class="token keyword">as</span> max_age <span class="token keyword">from</span> player <span class="token keyword">group</span> <span class="token keyword">by</span> team<span class="token punctuation">;</span>
</code></pre> 
<p><font size="2" face="宋体">es表示语句</font></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> main <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

	<span class="token class-name">TermsBuilder</span> teamAgg<span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"player_count "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"team"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">MaxBuilder</span> ageAgg<span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">"max_age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sbuilder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>teamAgg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>ageAgg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> sbuilder<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">actionGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体" color="黑体"><span id="zuidapjissxz">单字段聚合求多字段的最大/最小/平均</span></font></p> 
<p><font size="2" face="宋体">sql表示语句</font></p> 
<pre><code class="prism language-sql"><span class="token comment">--计算每个球队球员的平均年龄，同时又要计算总年薪</span>
<span class="token keyword">select</span> team<span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token keyword">as</span> avg_age<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">as</span> total_salary <span class="token keyword">from</span> player <span class="token keyword">group</span> <span class="token keyword">by</span> team<span class="token punctuation">;</span>
</code></pre> 
<p><font size="2" face="宋体">es表示语句</font></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> main <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

	<span class="token class-name">TermsBuilder</span> teamAgg<span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"team"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">AvgBuilder</span> ageAgg<span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">"avg_age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">SumBuilder</span> salaryAgg<span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">"total_salary "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"salary"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sbuilder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>teamAgg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>ageAgg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>salaryAgg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> sbuilder<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">actionGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体" color="黑体"><span id="jhsjzpx">单字段聚合汇总并排序</span></font></p> 
<p><font size="2" face="宋体">sql表示语句</font></p> 
<pre><code class="prism language-sql"><span class="token comment">--计算每个球队总年薪，并按照总年薪倒序排列</span>
<span class="token keyword">select</span> team<span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">as</span> total_salary <span class="token keyword">from</span> player <span class="token keyword">group</span> <span class="token keyword">by</span> team <span class="token keyword">order</span> <span class="token keyword">by</span> total_salary <span class="token keyword">desc</span><span class="token punctuation">;</span>
</code></pre> 
<p><font size="2" face="宋体">es表示语句</font></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> main <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

	<span class="token comment">//Order.aggregation函数的第一个参数是aggregation的名字，第二个参数是boolean型，true表示正序，false表示倒序</span>
	<span class="token class-name">TermsBuilder</span> teamAgg<span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"team"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span><span class="token string">"total_salary "</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">SumBuilder</span> salaryAgg<span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">"total_salary "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"salary"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sbuilder<span class="token punctuation">.</span><span class="token function">addAggregation</span><span class="token punctuation">(</span>teamAgg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>salaryAgg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> sbuilder<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">actionGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体" color="黑体"><span id="jgjsqbfh">单字段聚合汇总返回所有结果条数</span></font></p> 
<p><font size="2" face="宋体">es表示语句</font></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> main <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

	<span class="token comment">//默认情况下，search执行后，仅返回10条聚合结果，如果想返回更多的结果，需要在构建TermsBuilder 时指定size</span>
	<span class="token class-name">TermsBuilder</span> teamAgg<span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"team"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p><font size="3" face="宋体" color="black"><span id="bbaocuo">常见ES报错情况</span></font></p> 
</blockquote> 
<p><a href="#baocuoqingkuang1" rel="nofollow"><font size="2" face="宋体" color="grey">[TOO_MANY_REQUESTS/12/disk usage exceeded flood-stage watermark, index has read-only-allow-delete block]</font></a></p> 
<p><font size="2" face="宋体" color="黑体"><span id="baocuoqingkuang1">[TOO_MANY_REQUESTS/12/disk usage exceeded flood-stage watermark, index has read-only-allow-delete block]</span></font></p> 
<p><font size="2" face="宋体">排查及解决思路：</font></p> 
<p><font size="2" face="宋体">一、排查</font></p> 
<p><font size="2" face="宋体">1. 分析ES集群日志</font></p> 
<p><font size="2" face="宋体">[root@localhost ~]# tail -fn 100 /data/elasticsearch/logs/es-cluster.log</font></p> 
<p><img src="https://images2.imgbox.com/d6/15/o28iJbh3_o.png" alt="在这里插入图片描述"><br> <font size="2" face="宋体">从日志信息上可以得到一些信息：一个是请求太多，另一个是磁盘超过阈值；这两个原因都有可能触发ES主动给索引上锁。</font></p> 
<p><font size="2" face="宋体">2. 查看ES节点磁盘容量</font></p> 
<p><font size="2" face="宋体">[root@localhost ~]# df -h</font></p> 
<p><font size="2" face="宋体">二、解决</font></p> 
<p><font size="2" face="宋体">1. 清理ES节点磁盘空间（进行服务器扩容）</font></p> 
<p><font size="2" face="宋体">2. Kibana发送重置请求，关闭索引的只读状态</font></p> 
<pre><code class="prism language-java"><span class="token constant">PUT</span> _all<span class="token operator">/</span>_settings
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"index.blocks.read_only_allow_delete"</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体" color="grey">[应急]若来不及给Elasticsearch硬盘扩容，可以先关闭磁盘分配保护，让最后仅有的5%的磁盘空间缓冲一点时间，然后再给硬盘扩容</font></p> 
<pre><code class="prism language-java"><span class="token constant">PUT</span> _cluster<span class="token operator">/</span>settings
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"transient"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"cluster.routing.allocation.disk.threshold_enabled"</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font size="2" face="宋体" color="grey">磁盘扩容完毕后，启用磁盘分配保护</font></p> 
<pre><code class="prism language-java"><span class="token constant">PUT</span> _cluster<span class="token operator">/</span>settings
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"transient"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"cluster.routing.allocation.disk.threshold_enabled"</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3bf8677775df84502c25bbeb4df5817b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ESP32编译自己的micropython固件以支持OV2640、SPIRAM、bluetooth等完整功能</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80bb30fccb2c9ca0bac267fc7b016193/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">c语言判断一个数是偶数还是奇数？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>