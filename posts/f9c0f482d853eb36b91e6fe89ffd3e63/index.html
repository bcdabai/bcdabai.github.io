<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>NGINX解决第三方图片跨域问题 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="NGINX解决第三方图片跨域问题" />
<meta property="og:description" content="1.前端代码修改把第三方图片地址进行替换
原始图片地址：
http://192.168.1.1/pic?8dd611z2c-=s0931065c3614e-=t1i5m*=p4p9i=d1si4d667d8=*5b8i2e=
前端把原始地址替换：
http://192.168.2.5:80/crossOriginImg?referer=http://192.168.1.1/pic?8dd611z2c-=s0931065c3614e-=t1i5m*=p4p9i=d1s*i4d66*7d8=*5b8i2e=
把IP端口指定到本地同源的可以部署nginx的服务器，把源地址当作一个参数传到nginx进行解析，这样不需要提前知道第三方图片地址ip和端口。
2.配置NGINX location ~/crossOriginImg { add_header Access-Control-Allow-Origin *; add_header Access-Control-Allow-Headers X-Requested-With; add_header Access-Control-Allow-Methods GET,POST,OPTIONS; if ($args ~ &#34;referer=(.*)&#34;){ set $newurl &#34;$1&#34;; } proxy_pass $newurl; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_intercept_errors on; error_page 301 302 307 = @handle_redirect; } location @handle_redirect { add_header Access-Control-Allow-Origin *; add_header Access-Control-Allow-Headers X-Requested-With; add_header Access-Control-Allow-Methods GET,POST,OPTIONS; set $saved_redirect_location &#39;$upstream_http_location&#39;; proxy_pass $saved_redirect_location; } 配置说明：
1.添加允许跨域的请求头
add_header Access-Control-Allow-Origin *; add_header Access-Control-Allow-Headers X-Requested-With; add_header Access-Control-Allow-Methods GET,POST,OPTIONS; 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f9c0f482d853eb36b91e6fe89ffd3e63/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-17T17:33:30+08:00" />
<meta property="article:modified_time" content="2023-04-17T17:33:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">NGINX解决第三方图片跨域问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <p><strong>1.前端代码修改把第三方图片地址进行替换</strong><br> 原始图片地址：<br> http://192.168.1.1/pic?8dd611z2c-=s0931065c3614e-=t1i5m*=p4p9i=d1si4d667d8=*5b8i2e=<br> 前端把原始地址替换：<br> http://192.168.2.5:80/crossOriginImg?referer=http://192.168.1.1/pic?8dd611z2c-=s0931065c3614e-=t1i5m*=p4p9i=d1s*i4d66*7d8=*5b8i2e=<br> 把IP端口指定到本地同源的可以部署nginx的服务器，把源地址当作一个参数传到nginx进行解析，这样不需要提前知道第三方图片地址ip和端口。<br>  </p> 
</blockquote> 
<h3>2.配置NGINX</h3> 
<pre><code class="language-bash">location ~/crossOriginImg {
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Headers X-Requested-With;
        add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
        if ($args ~ "referer=(.*)"){
            set $newurl "$1";
        }
        proxy_pass  $newurl;
        proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  Host $host;
        proxy_set_header  X-Real-IP $remote_addr;
        proxy_intercept_errors  on;
        error_page 301 302 307 = @handle_redirect;
    }
location @handle_redirect {
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Headers X-Requested-With;
    add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
    set $saved_redirect_location '$upstream_http_location';
    proxy_pass $saved_redirect_location;
}</code></pre> 
<p>配置说明：<br> 1.添加允许跨域的请求头</p> 
<pre><code class="language-bash">add_header Access-Control-Allow-Origin *;
add_header Access-Control-Allow-Headers X-Requested-With;
add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
</code></pre> 
<p>2.$args拿到地址中所有参数再正则匹配拿到原始图片地址，通过proxy_pass 代理到新的地址，这里不使用$arg_referer因为当图片地址有包含其他参数时会取不到完整的地址</p> 
<pre><code class="language-bash">if ($args ~ "referer=(.*)"){
     set $newurl "$1";
}
proxy_pass  $newurl;</code></pre> 
<p><br> 3.为了解决原始图片会自动跳转到其他地址返回301时，在重定向的响应头中拿到跳转后地址$upstream_http_location，进行二次代理</p> 
<pre><code class="language-bash">location @handle_redirect {
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Headers X-Requested-With;
    add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
    set $saved_redirect_location '$upstream_http_location';
    proxy_pass $saved_redirect_location;
}</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1091165b6cc32f893ab065591c47a23d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Arduino开发之如何连接WIFI模块？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e6bd1d92609080b981eab2e56e0a9806/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Charles安装及使用教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>