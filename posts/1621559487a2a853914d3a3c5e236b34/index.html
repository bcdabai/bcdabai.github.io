<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 权限总结 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 权限总结" />
<meta property="og:description" content="文章目录 Android 权限总结权限分类API说明单次授权权限被撤消时基本使用简单封装第三方权限框架 Android 权限总结 权限分类 官网文档
普通权限：这类权限通常不会直接威胁到用户的隐私。如果你的应用列表中包含这类权限，需要在 AndroidManifest.xml 文件中定义，系统会自动授予权限，无需用户明确授予。如：android.permission.INTERNET 网络权限，android.permission.SET_WALLPAPER 壁纸权限。危险权限：这类权限可能会涉及到用户的隐私数据，或者可能会对用户的存储数据或操作产生影响。需要在 AndroidManifest.xml 文件中定义，同时必须通过权限请求对话框向用户请求这类权限。如：android.permission.READ_CONTACTS 允许应用读取用户的联系人数据，android.permission.WRITE_EXTERNAL_STORAGE 允许应用写入到外部存储。特殊权限：这类权限不属于正常和危险权限，它们有自己的处理方式。如：android.permission.REQUEST_INSTALL_PACKAGES 安装应用权限，android.permission.MANAGE_EXTERNAL_STORAGE Android11新增的文件管理权限。 危险权限：
API说明 targetSdkVersion&gt;=23: 这时就需要在代码中检查权限了，否则打开app去执行需要权限的操作会崩溃。如果关闭权限将会弹出提示框提示你开启权限。
ContextCompact#checkSelfPermission()：判断权限是否允许。ActivityCompat#requestPermissions()：申请权限。ActivityCompat#onRequestPermissionsResult()：权限结果回调。ActivityCompat#shouldShowRequestPermissonRationale：返回true，表示权限被拒绝过，可以再次申请；返回false，表示权限被拒绝并且不再询问，必须在设置中打开。 /** * 检查权限： * PackageManager.PERMISSION_GRANTED 权限已申请 * PackageManager.PERMISSION_DENIED 权限拒绝 */ if (ContextCompat.checkSelfPermission(this, Manifest.permission.CALL_PHONE) != PackageManager.PERMISSION_GRANTED ) { //申请权限： ActivityCompat.requestPermissions(this, arrayOf(Manifest.permission.CALL_PHONE), 1) } /** * 权限回调： * * @param requestCode Int ：请求码 * @param permissions Array&lt;out String&gt; ：申请的所有权限 * @param grantResults IntArray ：权限申请结果 */ override fun onRequestPermissionsResult( requestCode: Int, permissions: Array&lt;out String&gt;, grantResults: IntArray, ) { super." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/1621559487a2a853914d3a3c5e236b34/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-08T10:34:51+08:00" />
<meta property="article:modified_time" content="2024-01-08T10:34:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 权限总结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Android__2" rel="nofollow">Android 权限总结</a></li><li><ul><li><a href="#_4" rel="nofollow">权限分类</a></li><li><a href="#API_18" rel="nofollow">API说明</a></li><li><a href="#_79" rel="nofollow">单次授权</a></li><li><a href="#_91" rel="nofollow">权限被撤消时</a></li><li><a href="#_99" rel="nofollow">基本使用</a></li><li><a href="#_246" rel="nofollow">简单封装</a></li><li><a href="#_662" rel="nofollow">第三方权限框架</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Android__2"></a>Android 权限总结</h2> 
<h3><a id="_4"></a>权限分类</h3> 
<p><a href="https://developer.android.google.cn/guide/topics/permissions/overview?hl=zh-cn" rel="nofollow">官网文档</a></p> 
<ul><li>普通权限：这类权限通常不会直接威胁到用户的隐私。如果你的应用列表中包含这类权限，需要在 AndroidManifest.xml 文件中定义，系统会自动授予权限，无需用户明确授予。如：android.permission.INTERNET 网络权限，android.permission.SET_WALLPAPER 壁纸权限。</li><li>危险权限：这类权限可能会涉及到用户的隐私数据，或者可能会对用户的存储数据或操作产生影响。需要在 AndroidManifest.xml 文件中定义，同时必须通过权限请求对话框向用户请求这类权限。如：android.permission.READ_CONTACTS 允许应用读取用户的联系人数据，android.permission.WRITE_EXTERNAL_STORAGE 允许应用写入到外部存储。</li><li>特殊权限：这类权限不属于正常和危险权限，它们有自己的处理方式。如：android.permission.REQUEST_INSTALL_PACKAGES 安装应用权限，android.permission.MANAGE_EXTERNAL_STORAGE Android11新增的文件管理权限。</li></ul> 
<p><strong>危险权限：</strong></p> 
<p><img src="https://images2.imgbox.com/72/e9/ukw4CUAx_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="API_18"></a>API说明</h3> 
<p><strong>targetSdkVersion&gt;=23: 这时就需要在代码中检查权限了，否则打开app去执行需要权限的操作会崩溃。如果关闭权限将会弹出提示框提示你开启权限。</strong></p> 
<ul><li><code>ContextCompact#checkSelfPermission()</code>：判断权限是否允许。</li><li><code>ActivityCompat#requestPermissions()</code>：申请权限。</li><li><code>ActivityCompat#onRequestPermissionsResult()</code>：权限结果回调。</li><li><code>ActivityCompat#shouldShowRequestPermissonRationale</code>：返回true，表示权限被拒绝过，可以再次申请；返回false，表示权限被拒绝并且不再询问，必须在设置中打开。</li></ul> 
<pre><code class="prism language-kotlin"><span class="token comment">/**
* 检查权限：
*  PackageManager.PERMISSION_GRANTED 权限已申请
*  PackageManager.PERMISSION_DENIED 权限拒绝
*/</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ContextCompat<span class="token punctuation">.</span><span class="token function">checkSelfPermission</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CALL_PHONE<span class="token punctuation">)</span> <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//申请权限：</span>
    ActivityCompat<span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CALL_PHONE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-kotlin"><span class="token comment">/**
* 权限回调：
*
* @param requestCode Int ：请求码
* @param permissions Array&lt;out String&gt; ：申请的所有权限
* @param grantResults IntArray ：权限申请结果
*/</span>
<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>
    requestCode<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    permissions<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token keyword">out</span> String<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    grantResults<span class="token operator">:</span> IntArray<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> grantResults<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">//权限申请成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>grantResults<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"授权成功"</span></span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//权限申请失败</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityCompat<span class="token punctuation">.</span><span class="token function">shouldShowRequestPermissionRationale</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>
                                                                    Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CALL_PHONE<span class="token punctuation">)</span>
               <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//已经拒绝过一次</span>
                AlertDialog<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"需要使用通话权限"</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"授权失败"</span></span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_79"></a>单次授权</h3> 
<p>从 Android 11（API 级别 30）开始，每当您的应用请求与位置信息、麦克风或摄像头相关的权限时，面向用户显示的权限对话框都会包含一个名为<strong>仅限这一次</strong>的选项，如图 2 所示。如果用户在对话框中选择此选项，系统会向应用授予临时的单次授权。</p> 
<p>然后，应用可以在一段时间内访问相关数据，具体时间取决于应用的行为和用户的操作：</p> 
<ul><li>当应用的 activity 可见时，应用可以访问相关数据。</li><li>如果用户将应用转为后台运行，应用可以在短时间内继续访问相关数据。</li><li>如果您在 activity 可见时启动了一项前台服务，并且用户随后将您的应用转到后台，那么您的应用可以继续访问相关数据，直到该前台服务停止。</li></ul> 
<h3><a id="_91"></a>权限被撤消时</h3> 
<p>如果用户撤消单次授权（例如在系统设置中撤消），无论您是否启动了前台服务，应用都无法访问相关数据。与任何权限一样，<strong>如果用户撤消了应用的单次授权，应用进程就会终止</strong>。</p> 
<p>当用户下次打开应用并且应用中的某项功能请求访问位置信息、麦克风或摄像头时，系统会再次提示用户授予权限。</p> 
<h3><a id="_99"></a>基本使用</h3> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.CALL_PHONE<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.CAMERA<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> <span class="token keyword">val</span> REQUEST_PERMISSIONS <span class="token operator">=</span> <span class="token number">111</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> context<span class="token operator">:</span> Context

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>
        context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">val</span> btnCallPhone<span class="token operator">:</span> Button <span class="token operator">=</span> findViewById<span class="token operator">&lt;</span>Button<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>btnCallPhone<span class="token punctuation">)</span>
        btnCallPhone<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">doCallPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">doCallPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//申请权限</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">requestPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> deniedPermissions <span class="token operator">=</span> <span class="token function">checkPermissions</span><span class="token punctuation">(</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CALL_PHONE<span class="token punctuation">,</span> Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CAMERA<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>deniedPermissions<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">requestPermissions</span><span class="token punctuation">(</span>deniedPermissions<span class="token punctuation">)</span>
            <span class="token boolean">false</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//拨打电话</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> intent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_CALL<span class="token punctuation">)</span>
            intent<span class="token punctuation">.</span>data <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"tel:10086"</span></span><span class="token punctuation">)</span>
            <span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 检查指定权限是否授权
     * 并返回未授权
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">checkPermissions</span><span class="token punctuation">(</span><span class="token keyword">vararg</span> permissions<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">checkPermissions</span><span class="token punctuation">(</span><span class="token function">listOf</span><span class="token punctuation">(</span><span class="token operator">*</span>permissions<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">checkPermissions</span><span class="token punctuation">(</span>permissionList<span class="token operator">:</span> List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//未授权</span>
        <span class="token keyword">val</span> deniedList <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>permission <span class="token keyword">in</span> permissionList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ContextCompat<span class="token punctuation">.</span><span class="token function">checkSelfPermission</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> permission<span class="token punctuation">)</span> <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                deniedList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>permission<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> deniedList
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 申请指定权限
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">requestPermissions</span><span class="token punctuation">(</span>permissionList<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ActivityCompat<span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> permissionList<span class="token punctuation">.</span><span class="token function">toTypedArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> REQUEST_PERMISSIONS<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 授权结果回调
     */</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>requestCode<span class="token operator">:</span> Int<span class="token punctuation">,</span> permissions<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token keyword">out</span> String<span class="token operator">&gt;</span><span class="token punctuation">,</span> grantResults<span class="token operator">:</span> IntArray<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> grantResults<span class="token punctuation">)</span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            REQUEST_PERMISSIONS <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//已拒绝权限集合</span>
                <span class="token keyword">val</span> deniedList <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//已拒绝权限且不再问询集合</span>
                <span class="token keyword">val</span> deniedWithNeverList <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                grantResults<span class="token punctuation">.</span><span class="token function">forEachIndexed</span> <span class="token punctuation">{<!-- --></span> 
                    index<span class="token punctuation">,</span> result <span class="token operator">-&gt;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityCompat<span class="token punctuation">.</span><span class="token function">shouldShowRequestPermissionRationale</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> permissions<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            deniedList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>permissions<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            deniedWithNeverList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>permissions<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>deniedList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> deniedWithNeverList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>deniedList<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//再次申请权限</span>
                        AlertDialog<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"App需要以下权限才能继续"</span></span><span class="token punctuation">)</span>
                            <span class="token function">setPositiveButton</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"确定"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
                                dialog<span class="token punctuation">,</span> which <span class="token operator">-&gt;</span>
                                <span class="token function">requestPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span>
                            <span class="token function">setNegativeButton</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"取消"</span></span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//跳转设置界面</span>
                        <span class="token function">gotoSetting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 跳转权限设置界面
     */</span>
    <span class="token keyword">fun</span> <span class="token function">gotoSetting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AlertDialog<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"请在设置中允许以下权限"</span></span><span class="token punctuation">)</span>
            <span class="token function">setNegativeButton</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"拒绝"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> dialog<span class="token punctuation">,</span> which <span class="token operator">-&gt;</span>
                                    <span class="token punctuation">}</span>
            <span class="token function">setPositiveButton</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"开启"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
                dialog<span class="token punctuation">,</span> which <span class="token operator">-&gt;</span>
                <span class="token keyword">val</span> intent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span>Settings<span class="token punctuation">.</span>ACTION_APPLICATION_DETAILS_SETTINGS<span class="token punctuation">)</span>
                <span class="token keyword">val</span> uri <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">fromParts</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"package"</span></span><span class="token punctuation">,</span> packageName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                intent<span class="token punctuation">.</span>data <span class="token operator">=</span> uri
                <span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_246"></a>简单封装</h3> 
<pre><code class="prism language-kotlin"><span class="token keyword">object</span> PermissionUtils <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> REQUEST_PERMISSION_CODE <span class="token operator">=</span> <span class="token number">6666</span>

    <span class="token keyword">const</span> <span class="token keyword">val</span> CAMERA <span class="token operator">=</span> Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CAMERA <span class="token comment">// 摄像头</span>
    <span class="token keyword">const</span> <span class="token keyword">val</span> CALL_PHONE <span class="token operator">=</span> Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CALL_PHONE <span class="token comment">// 拨打电话</span>

    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> TYPE_REQUEST_PERMISSION <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// 表示权限申请</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> TYPE_GOTO_SETTING <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// 表示跳转设置页面</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> permissionMap <span class="token operator">=</span> LinkedHashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">init</span> <span class="token punctuation">{<!-- --></span>
        permissionMap<span class="token punctuation">[</span>CAMERA<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"相机权限"</span></span>
        permissionMap<span class="token punctuation">[</span>CALL_PHONE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"拨打电话"</span></span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断权限是否全部通过
     */</span>
    <span class="token keyword">fun</span> <span class="token function">isGrantedPermissions</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> permissionList<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>permission <span class="token keyword">in</span> permissionList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ContextCompat<span class="token punctuation">.</span><span class="token function">checkSelfPermission</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> permission<span class="token punctuation">)</span>
                <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED
            <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 检查权限，并返回已拒绝的权限
     */</span>
    <span class="token keyword">fun</span> <span class="token function">checkPermissions</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> permissionList<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> deniedPermissionList <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>permission <span class="token keyword">in</span> permissionList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ContextCompat<span class="token punctuation">.</span><span class="token function">checkSelfPermission</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> permission<span class="token punctuation">)</span>
                <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED
            <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                deniedPermissionList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>permission<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> deniedPermissionList
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 申请权限
     */</span>
    <span class="token keyword">fun</span> <span class="token function">applyPermission</span><span class="token punctuation">(</span>activity<span class="token operator">:</span> Activity<span class="token punctuation">,</span> permissionList<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>M<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> list <span class="token operator">=</span> <span class="token function">checkPermissions</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> permissionList<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">showPermissionDialog</span><span class="token punctuation">(</span>
                    activity<span class="token punctuation">,</span> TYPE_REQUEST_PERMISSION<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"需要您同意以下权限才能正常使用"</span></span><span class="token punctuation">,</span> list
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 申请权限
     */</span>
    <span class="token keyword">fun</span> <span class="token function">applyPermission</span><span class="token punctuation">(</span>fragment<span class="token operator">:</span> Fragment<span class="token punctuation">,</span> permissionList<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>M<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> list <span class="token operator">=</span> <span class="token function">checkPermissions</span><span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>context<span class="token operator">!!</span><span class="token punctuation">,</span> permissionList<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">showPermissionDialog</span><span class="token punctuation">(</span>
                    fragment<span class="token punctuation">,</span> TYPE_REQUEST_PERMISSION<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"需要您同意以下权限才能正常使用"</span></span><span class="token punctuation">,</span> list
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">showPermissionDialog</span><span class="token punctuation">(</span>
        fragment<span class="token operator">:</span> Fragment<span class="token punctuation">,</span>
        type<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        title<span class="token operator">:</span> String<span class="token punctuation">,</span>
        permissionList<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> descList <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>permission <span class="token keyword">in</span> permissionList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> permissionDesc<span class="token operator">:</span> String <span class="token operator">=</span> permissionMap<span class="token punctuation">[</span>permission<span class="token punctuation">]</span><span class="token operator">!!</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>descList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>permissionDesc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                descList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>permissionDesc<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> builder <span class="token operator">=</span> <span class="token function">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>descList<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token keyword">in</span> descList<span class="token punctuation">.</span><span class="token function">withIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> descList<span class="token punctuation">.</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"\n"</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> message <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_REQUEST_PERMISSION<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            AlertDialog<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>context<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setPositiveButton</span><span class="token punctuation">(</span>
                    <span class="token string-literal singleline"><span class="token string">"允许"</span></span>
                <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> dialog<span class="token punctuation">,</span> which <span class="token operator">-&gt;</span>
                    <span class="token function">requestPermissions</span><span class="token punctuation">(</span>fragment<span class="token punctuation">,</span> permissionList<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token function">setNegativeButton</span><span class="token punctuation">(</span>
                    <span class="token string-literal singleline"><span class="token string">"拒绝"</span></span>
                <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> dialog<span class="token punctuation">,</span> which <span class="token operator">-&gt;</span> <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_GOTO_SETTING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            AlertDialog<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>context<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setPositiveButton</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"打开"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> dialog<span class="token punctuation">,</span> which <span class="token operator">-&gt;</span>
                    <span class="token function">gotoSettings</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token function">setNegativeButton</span><span class="token punctuation">(</span>
                    <span class="token string-literal singleline"><span class="token string">"拒绝"</span></span>
                <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> dialog<span class="token punctuation">,</span> which <span class="token operator">-&gt;</span> <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 显示权限弹窗
     */</span>
    <span class="token keyword">fun</span> <span class="token function">showPermissionDialog</span><span class="token punctuation">(</span>
        activity<span class="token operator">:</span> Activity<span class="token punctuation">,</span>
        type<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        title<span class="token operator">:</span> String<span class="token punctuation">,</span>
        permissionList<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> descList <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>permission <span class="token keyword">in</span> permissionList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> d<span class="token operator">:</span> String <span class="token operator">=</span> permissionMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>permission<span class="token punctuation">)</span><span class="token operator">!!</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>descList<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                descList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> builder <span class="token operator">=</span> <span class="token function">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>descList<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token keyword">in</span> descList<span class="token punctuation">.</span><span class="token function">withIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> descList<span class="token punctuation">.</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"\n"</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> message <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_REQUEST_PERMISSION<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            AlertDialog<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setPositiveButton</span><span class="token punctuation">(</span>
                    <span class="token string-literal singleline"><span class="token string">"允许"</span></span>
                <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> dialog<span class="token punctuation">,</span> which <span class="token operator">-&gt;</span>
                    <span class="token function">requestPermissions</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> permissionList<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token function">setNegativeButton</span><span class="token punctuation">(</span>
                    <span class="token string-literal singleline"><span class="token string">"拒绝"</span></span>
                <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> dialog<span class="token punctuation">,</span> which <span class="token operator">-&gt;</span> <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> TYPE_GOTO_SETTING<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            AlertDialog<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setPositiveButton</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"打开"</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> dialog<span class="token punctuation">,</span> which <span class="token operator">-&gt;</span>
                    <span class="token function">gotoSettings</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token function">setNegativeButton</span><span class="token punctuation">(</span>
                    <span class="token string-literal singleline"><span class="token string">"拒绝"</span></span>
                <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> dialog<span class="token punctuation">,</span> which <span class="token operator">-&gt;</span> <span class="token punctuation">}</span>
                <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 回调权限结果
     */</span>
    <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>
        obj<span class="token operator">:</span> T<span class="token punctuation">,</span>
        requestCode<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        permissions<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span>
        grantResults<span class="token operator">:</span> IntArray
    <span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requestCode <span class="token operator">==</span> REQUEST_PERMISSION_CODE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">is</span> Fragment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">val</span> fragment <span class="token operator">=</span> obj <span class="token keyword">as</span> Fragment
                <span class="token keyword">val</span> deniedList <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 已拒绝权限集合</span>
                <span class="token keyword">val</span> deniedWithNeverList <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 已拒绝且不再问询集合</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> grantResults<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>grantResults<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>PERMISSION_DENIED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityCompat<span class="token punctuation">.</span><span class="token function">shouldShowRequestPermissionRationale</span><span class="token punctuation">(</span>
                                fragment<span class="token punctuation">.</span>activity<span class="token operator">!!</span><span class="token punctuation">,</span>
                                permissions<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                            <span class="token punctuation">)</span>
                        <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            deniedList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>permissions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            deniedWithNeverList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>permissions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>deniedList<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">showPermissionDialog</span><span class="token punctuation">(</span>
                        fragment<span class="token punctuation">,</span>
                        TYPE_REQUEST_PERMISSION<span class="token punctuation">,</span>
                        <span class="token string-literal singleline"><span class="token string">"需要您同意以下权限才能正常使用"</span></span><span class="token punctuation">,</span>
                        deniedList
                    <span class="token punctuation">)</span>
                    <span class="token boolean">false</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>deniedWithNeverList<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">showPermissionDialog</span><span class="token punctuation">(</span>
                        fragment<span class="token punctuation">,</span>
                        TYPE_GOTO_SETTING<span class="token punctuation">,</span>
                        <span class="token string-literal singleline"><span class="token string">"请在设置中允许以下权限"</span></span><span class="token punctuation">,</span>
                        deniedWithNeverList
                    <span class="token punctuation">)</span>
                    <span class="token boolean">false</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">is</span> Activity<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">val</span> activity <span class="token operator">=</span> obj <span class="token keyword">as</span> Activity
                <span class="token keyword">val</span> deniedList <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//拒绝权限集合</span>
                <span class="token keyword">val</span> deniedWithNeverList <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//已拒绝且不再问询集合</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> grantResults<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>grantResults<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> PackageManager<span class="token punctuation">.</span>PERMISSION_DENIED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityCompat<span class="token punctuation">.</span><span class="token function">shouldShowRequestPermissionRationale</span><span class="token punctuation">(</span>
                                activity<span class="token punctuation">,</span>
                                permissions<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                            <span class="token punctuation">)</span>
                        <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            deniedList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>permissions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            deniedWithNeverList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>permissions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>deniedList<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">showPermissionDialog</span><span class="token punctuation">(</span>
                        activity<span class="token punctuation">,</span>
                        TYPE_REQUEST_PERMISSION<span class="token punctuation">,</span>
                        <span class="token string-literal singleline"><span class="token string">"需要您同意以下权限才能正常使用"</span></span><span class="token punctuation">,</span>
                        deniedList
                    <span class="token punctuation">)</span>
                    <span class="token boolean">false</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>deniedWithNeverList<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">showPermissionDialog</span><span class="token punctuation">(</span>
                        activity<span class="token punctuation">,</span>
                        TYPE_GOTO_SETTING<span class="token punctuation">,</span>
                        <span class="token string-literal singleline"><span class="token string">"请在设置中允许以下权限"</span></span><span class="token punctuation">,</span>
                        deniedWithNeverList
                    <span class="token punctuation">)</span>
                    <span class="token boolean">false</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span><span class="token function">IllegalStateException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"obj不是一个Fragment或Activity"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 真正申请权限
     */</span>
    <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">requestPermissions</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> T<span class="token punctuation">,</span> permissionList<span class="token operator">:</span> ArrayList<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">is</span> Activity <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                ActivityCompat<span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span>
                    obj<span class="token punctuation">,</span>
                    permissionList<span class="token punctuation">.</span><span class="token function">toTypedArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    REQUEST_PERMISSION_CODE
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">is</span> Fragment <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                obj<span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span>
                    permissionList<span class="token punctuation">.</span><span class="token function">toTypedArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    REQUEST_PERMISSION_CODE
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span><span class="token function">IllegalStateException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"obj不是一个Fragment或Activity"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 跳转设置页面
     */</span>
    <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">gotoSettings</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">when</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">is</span> Fragment <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">val</span> packageURI <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"package:"</span></span> <span class="token operator">+</span> obj<span class="token punctuation">.</span>activity<span class="token operator">!!</span><span class="token punctuation">.</span>packageName<span class="token punctuation">)</span>
                <span class="token keyword">val</span> intent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span>Settings<span class="token punctuation">.</span>ACTION_APPLICATION_DETAILS_SETTINGS<span class="token punctuation">,</span> packageURI<span class="token punctuation">)</span>
                obj<span class="token punctuation">.</span><span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">is</span> Activity <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">val</span> packageURI <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"package:"</span></span> <span class="token operator">+</span> obj<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span>
                <span class="token keyword">val</span> intent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span>Settings<span class="token punctuation">.</span>ACTION_APPLICATION_DETAILS_SETTINGS<span class="token punctuation">,</span> packageURI<span class="token punctuation">)</span>
                obj<span class="token punctuation">.</span><span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token function">IllegalStateException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"obj不是一个Fragment或Activity"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>在Activity中使用；</strong></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">BaseActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">onCallPhone</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">doCallPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">doCallPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> permissionList <span class="token operator">=</span> <span class="token function">arrayListOf</span><span class="token punctuation">(</span>PermissionUtils<span class="token punctuation">.</span>CALL_PHONE<span class="token punctuation">,</span> PermissionUtils<span class="token punctuation">.</span>CAMERA<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PermissionUtils<span class="token punctuation">.</span><span class="token function">isGrantedPermissions</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> permissionList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> callIntent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_CALL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">data</span> <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"tel:"</span></span> <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"1234567890"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">startActivity</span><span class="token punctuation">(</span>callIntent<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            PermissionUtils<span class="token punctuation">.</span><span class="token function">applyPermission</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> permissionList<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>
        requestCode<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        permissions<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span>
        grantResults<span class="token operator">:</span> IntArray
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> grantResults<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PermissionUtils<span class="token punctuation">.</span><span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span>
                requestCode<span class="token punctuation">,</span>
                permissions<span class="token punctuation">,</span>
                grantResults
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"权限已全部允许"</span></span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">doCallPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>在Fragment中使用：</strong></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> MyFragment <span class="token operator">:</span> <span class="token function">Fragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreateView</span><span class="token punctuation">(</span>
        inflater<span class="token operator">:</span> LayoutInflater<span class="token punctuation">,</span>
        container<span class="token operator">:</span> ViewGroup<span class="token operator">?</span><span class="token punctuation">,</span>
        savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> View<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> inflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>fragment_two<span class="token punctuation">,</span> container<span class="token operator">!!</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">,</span> savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> savedInstanceState<span class="token punctuation">)</span>
        view<span class="token punctuation">.</span>findViewById<span class="token operator">&lt;</span>Button<span class="token operator">&gt;</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>btn_call_phone<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">doCallPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">doCallPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> permissionList <span class="token operator">=</span> <span class="token function">arrayListOf</span><span class="token punctuation">(</span>PermissionUtils<span class="token punctuation">.</span>CALL_PHONE<span class="token punctuation">,</span> PermissionUtils<span class="token punctuation">.</span>CAMERA<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PermissionUtils<span class="token punctuation">.</span><span class="token function">isGrantedPermissions</span><span class="token punctuation">(</span>context<span class="token operator">!!</span><span class="token punctuation">,</span> permissionList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> callIntent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_CALL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">data</span> <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"tel:"</span></span> <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"1234567890"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">startActivity</span><span class="token punctuation">(</span>callIntent<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            PermissionUtils<span class="token punctuation">.</span><span class="token function">applyPermission</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> permissionList<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>
        requestCode<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        permissions<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">,</span>
        grantResults<span class="token operator">:</span> IntArray
    <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> grantResults<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PermissionUtils<span class="token punctuation">.</span><span class="token function">onRequestPermissionsResult</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span>
                requestCode<span class="token punctuation">,</span>
                permissions<span class="token punctuation">,</span>
                grantResults
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"权限已全部允许"</span></span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">doCallPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_662"></a>第三方权限框架</h3> 
<p>推荐第三方权限框架：<a href="https://github.com/getActivity/XXPermissions">XXPermissions</a>、<a href="https://github.com/guolindev/PermissionX">PermissionX</a>。</p> 
<p><strong>这里使用 PermissionX 框架：</strong></p> 
<p>安装：</p> 
<pre><code class="prism language-java">dependencies <span class="token punctuation">{<!-- --></span>
    implementation 'com<span class="token punctuation">.</span>permissionx<span class="token punctuation">.</span>guolindev<span class="token operator">:</span>permissionx<span class="token operator">:</span><span class="token number">1.4</span><span class="token number">.0</span>'
<span class="token punctuation">}</span>
</code></pre> 
<p>基本使用：</p> 
<pre><code class="prism language-java"><span class="token class-name">PermissionX</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">permissions</span><span class="token punctuation">(</span><span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">CAMERA</span><span class="token punctuation">,</span> <span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">ACCESS_FINE_LOCATION</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>onExplainRequestReason <span class="token punctuation">{<!-- --></span> scope<span class="token punctuation">,</span> deniedList <span class="token operator">-&gt;</span>
        val message <span class="token operator">=</span> <span class="token string">"拍照功能需要您同意相册和定位权限"</span>
        val ok <span class="token operator">=</span> <span class="token string">"确定"</span>
        scope<span class="token punctuation">.</span><span class="token function">showRequestReasonDialog</span><span class="token punctuation">(</span>deniedList<span class="token punctuation">,</span> message<span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span>onForwardToSettings <span class="token punctuation">{<!-- --></span> scope<span class="token punctuation">,</span> deniedList <span class="token operator">-&gt;</span>
        val message <span class="token operator">=</span> <span class="token string">"您需要去设置当中同意相册和定位权限"</span>
        val ok <span class="token operator">=</span> <span class="token string">"确定"</span>
        scope<span class="token punctuation">.</span><span class="token function">showForwardToSettingsDialog</span><span class="token punctuation">(</span>deniedList<span class="token punctuation">,</span> message<span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span>request <span class="token punctuation">{<!-- --></span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">-&gt;</span>
        <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/944619a82e10f7a9bfab142e19826218/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【计算机毕业选题】2024年计算机Java SpringBoot 毕业设计题目推荐</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/89e48589f7e6090c28003749ee0858be/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">③使用Redis缓存，并增强数据一致性。</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>