<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>目标检测之FasterRcnn算法——训练自己的数据集（pytorch） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="目标检测之FasterRcnn算法——训练自己的数据集（pytorch）" />
<meta property="og:description" content="数据集 数据集目录如上，VOC数据集的格式
JPEGImages目录下，放上自己的训练集和测试集 Annotations 下，放上自己的xml文档配置，如上。 在VOCdevkit\VOC2012\ImageSets\Main下，放上自己的train.txt和val.txt,
上面，我按照VOC的格式来的，前面是所有的XML，因为VOC有21类，这里有我懒的删除，刚好前面代表XML文件，后面代表这张图片中有多少该目标，-1表示没有。
这样的话，数据就准备好了。
准备一个json,文件，选择自己需要分类的目标。
数据的读取 from torch.utils.data import Dataset import os import torch import json from PIL import Image from lxml import etree class VOC2012DataSet(Dataset): &#34;&#34;&#34;读取解析PASCAL VOC2012数据集&#34;&#34;&#34; def __init__(self, voc_root, transforms, txt_name: str = &#34;train.txt&#34;,json_name=&#34;pascal_voc_classes.json&#34;): self.root = os.path.join(voc_root, &#34;VOCdevkit&#34;, &#34;VOC2012&#34;) self.img_root = os.path.join(self.root, &#34;JPEGImages&#34;) self.annotations_root = os.path.join(self.root, &#34;Annotations&#34;) # read train.txt or val.txt file txt_path = os.path.join(self.root, &#34;ImageSets&#34;, &#34;Main&#34;, txt_name) assert os.path.exists(txt_path), &#34;not found {} file." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/d92b100ea146bf836b36899b875a3f8a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-17T22:32:50+08:00" />
<meta property="article:modified_time" content="2021-11-17T22:32:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">目标检测之FasterRcnn算法——训练自己的数据集（pytorch）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="httpsimgblogcsdnimgcnb68a357f74164e9ab82b6f6cc95f04c3pngxossprocessimagewatermarktype_ZHJvaWRzYW5zZmFsbGJhY2sshadow_50text_Q1NETiBA5bCP6ZmIcGhksize_20color_FFFFFFt_70g_sex_16_0"></a>数据集<img src="https://images2.imgbox.com/bb/82/VIUYLHx8_o.png" alt="在这里插入图片描述"></h4> 
<p>数据集目录如上，VOC数据集的格式<br> <img src="https://images2.imgbox.com/1f/f2/EBMjL2hJ_o.png" alt="在这里插入图片描述"></p> 
<ul><li>JPEGImages目录下，放上自己的训练集和测试集</li></ul> 
<p><img src="https://images2.imgbox.com/42/92/mUeZbKaX_o.png" alt="在这里插入图片描述"></p> 
<ul><li>Annotations 下，放上自己的xml文档配置，如上。</li></ul> 
<p>在VOCdevkit\VOC2012\ImageSets\Main下，放上自己的train.txt和val.txt,<br> <img src="https://images2.imgbox.com/67/58/LkczaybM_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/57/72/Or34ElcL_o.png" alt="在这里插入图片描述"><br> 上面，我按照VOC的格式来的，前面是所有的XML，因为VOC有21类，这里有我懒的删除，刚好前面代表XML文件，后面代表这张图片中有多少该目标，-1表示没有。</p> 
<p>这样的话，数据就准备好了。<br> <img src="https://images2.imgbox.com/75/d8/HyYRKZUF_o.png" alt="在这里插入图片描述"><br> 准备一个json,文件，选择自己需要分类的目标。</p> 
<h4><a id="_20"></a>数据的读取</h4> 
<pre><code class="prism language-python"><span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset
<span class="token keyword">import</span> os
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> json
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree


<span class="token keyword">class</span> <span class="token class-name">VOC2012DataSet</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""读取解析PASCAL VOC2012数据集"""</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> voc_root<span class="token punctuation">,</span> transforms<span class="token punctuation">,</span> txt_name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"train.txt"</span><span class="token punctuation">,</span>json_name<span class="token operator">=</span><span class="token string">"pascal_voc_classes.json"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

        self<span class="token punctuation">.</span>root <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>voc_root<span class="token punctuation">,</span> <span class="token string">"VOCdevkit"</span><span class="token punctuation">,</span> <span class="token string">"VOC2012"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>img_root <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token string">"JPEGImages"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>annotations_root <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token string">"Annotations"</span><span class="token punctuation">)</span>

        <span class="token comment"># read train.txt or val.txt file</span>
        txt_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token string">"ImageSets"</span><span class="token punctuation">,</span> <span class="token string">"Main"</span><span class="token punctuation">,</span> txt_name<span class="token punctuation">)</span>


        <span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>txt_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"not found {} file."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>txt_name<span class="token punctuation">)</span>

        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txt_path<span class="token punctuation">)</span> <span class="token keyword">as</span> read<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>xml_list <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>annotations_root<span class="token punctuation">,</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".xml"</span><span class="token punctuation">)</span>
                             <span class="token keyword">for</span> line <span class="token keyword">in</span> read<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span><span class="token string">"-1"</span><span class="token punctuation">]</span>

        <span class="token comment"># print(self.xml_list)</span>

        <span class="token comment"># check file</span>
        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>xml_list<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"in '{}' file does not find any information."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>txt_path<span class="token punctuation">)</span>


        <span class="token keyword">for</span> xml_path <span class="token keyword">in</span> self<span class="token punctuation">.</span>xml_list<span class="token punctuation">:</span>
            <span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"not found '{}' file."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span>

        <span class="token comment"># read class_indict</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            json_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_name<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>class_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>json_file<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            exit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>transforms <span class="token operator">=</span> transforms

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>xml_list<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># read xml</span>
        xml_path <span class="token operator">=</span> self<span class="token punctuation">.</span>xml_list<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span> <span class="token keyword">as</span> fid<span class="token punctuation">:</span>
            xml_str <span class="token operator">=</span> fid<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        xml <span class="token operator">=</span> etree<span class="token punctuation">.</span>fromstring<span class="token punctuation">(</span>xml_str<span class="token punctuation">)</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_xml_to_dict<span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"annotation"</span><span class="token punctuation">]</span>
        img_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>img_root<span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">"filename"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
        <span class="token keyword">if</span> image<span class="token punctuation">.</span><span class="token builtin">format</span> <span class="token operator">!=</span> <span class="token string">"JPEG"</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Image format not JPEG"</span><span class="token punctuation">)</span>
        boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        iscrowd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> obj <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"object"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> obj<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>class_dict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                xmin <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"xmin"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                xmax <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"xmax"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                ymin <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"ymin"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                ymax <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"ymax"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax<span class="token punctuation">]</span><span class="token punctuation">)</span>
                labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>class_dict<span class="token punctuation">[</span>obj<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                iscrowd<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"difficult"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># convert everything into a torch.Tensor</span>
        boxes <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
        iscrowd <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>iscrowd<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
        image_id <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
        area <span class="token operator">=</span> <span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        target <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span> <span class="token operator">=</span> boxes
        target<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span> <span class="token operator">=</span> labels
        target<span class="token punctuation">[</span><span class="token string">"image_id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> image_id
        target<span class="token punctuation">[</span><span class="token string">"area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> area
        target<span class="token punctuation">[</span><span class="token string">"iscrowd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> iscrowd

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>transforms <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            image<span class="token punctuation">,</span> target <span class="token operator">=</span> self<span class="token punctuation">.</span>transforms<span class="token punctuation">(</span>image<span class="token punctuation">,</span> target<span class="token punctuation">)</span>

        <span class="token keyword">return</span> image<span class="token punctuation">,</span> target

    <span class="token keyword">def</span> <span class="token function">get_height_and_width</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># read xml</span>
        xml_path <span class="token operator">=</span> self<span class="token punctuation">.</span>xml_list<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span> <span class="token keyword">as</span> fid<span class="token punctuation">:</span>
            xml_str <span class="token operator">=</span> fid<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        xml <span class="token operator">=</span> etree<span class="token punctuation">.</span>fromstring<span class="token punctuation">(</span>xml_str<span class="token punctuation">)</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_xml_to_dict<span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"annotation"</span><span class="token punctuation">]</span>
        data_height <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"size"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"height"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        data_width <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"size"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"width"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> data_height<span class="token punctuation">,</span> data_width

    <span class="token keyword">def</span> <span class="token function">parse_xml_to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> xml<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        将xml文件解析成字典形式，参考tensorflow的recursive_parse_xml_to_dict
        Args:
            xml: xml tree obtained by parsing XML file contents using lxml.etree

        Returns:
            Python dictionary holding XML contents.
        """</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>xml<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 遍历到底层，直接返回tag对应的信息</span>
            <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>xml<span class="token punctuation">.</span>tag<span class="token punctuation">:</span> xml<span class="token punctuation">.</span>text<span class="token punctuation">}</span>

        result <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> child <span class="token keyword">in</span> xml<span class="token punctuation">:</span>
            child_result <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_xml_to_dict<span class="token punctuation">(</span>child<span class="token punctuation">)</span>  <span class="token comment"># 递归遍历标签信息</span>
            <span class="token keyword">if</span> child<span class="token punctuation">.</span>tag <span class="token operator">!=</span> <span class="token string">'object'</span><span class="token punctuation">:</span>
                result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span> <span class="token operator">=</span> child_result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> child<span class="token punctuation">.</span>tag <span class="token keyword">not</span> <span class="token keyword">in</span> result<span class="token punctuation">:</span>  <span class="token comment"># 因为object可能有多个，所以需要放入列表里</span>
                    result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>child_result<span class="token punctuation">[</span>child<span class="token punctuation">.</span>tag<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>xml<span class="token punctuation">.</span>tag<span class="token punctuation">:</span> result<span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">coco_index</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        该方法是专门为pycocotools统计标签信息准备，不对图像和标签作任何处理
        由于不用去读取图片，可大幅缩减统计时间

        Args:
            idx: 输入需要获取图像的索引
        """</span>
        <span class="token comment"># read xml</span>
        xml_path <span class="token operator">=</span> self<span class="token punctuation">.</span>xml_list<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>xml_path<span class="token punctuation">)</span> <span class="token keyword">as</span> fid<span class="token punctuation">:</span>
            xml_str <span class="token operator">=</span> fid<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        xml <span class="token operator">=</span> etree<span class="token punctuation">.</span>fromstring<span class="token punctuation">(</span>xml_str<span class="token punctuation">)</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_xml_to_dict<span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"annotation"</span><span class="token punctuation">]</span>
        data_height <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"size"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"height"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        data_width <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"size"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"width"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># img_path = os.path.join(self.img_root, data["filename"])</span>
        <span class="token comment"># image = Image.open(img_path)</span>
        <span class="token comment"># if image.format != "JPEG":</span>
        <span class="token comment">#     raise ValueError("Image format not JPEG")</span>
        boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        iscrowd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> obj <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"object"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> obj<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>class_dict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                xmin <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"xmin"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                xmax <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"xmax"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                ymin <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"ymin"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                ymax <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"bndbox"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"ymax"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> ymax<span class="token punctuation">]</span><span class="token punctuation">)</span>
                labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>class_dict<span class="token punctuation">[</span>obj<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                iscrowd<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span><span class="token string">"difficult"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># convert everything into a torch.Tensor</span>
        boxes <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
        iscrowd <span class="token operator">=</span> torch<span class="token punctuation">.</span>as_tensor<span class="token punctuation">(</span>iscrowd<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>
        image_id <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
        area <span class="token operator">=</span> <span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        target <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span> <span class="token operator">=</span> boxes
        target<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span> <span class="token operator">=</span> labels
        target<span class="token punctuation">[</span><span class="token string">"image_id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> image_id
        target<span class="token punctuation">[</span><span class="token string">"area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> area
        target<span class="token punctuation">[</span><span class="token string">"iscrowd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> iscrowd

        <span class="token keyword">return</span> <span class="token punctuation">(</span>data_height<span class="token punctuation">,</span> data_width<span class="token punctuation">)</span><span class="token punctuation">,</span> target

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">collate_fn</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>batch<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> VOC2012DataSet<span class="token punctuation">(</span><span class="token string">r"D:/"</span><span class="token punctuation">,</span>transforms<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>txt_name<span class="token operator">=</span><span class="token string">"car_train.txt"</span><span class="token punctuation">,</span>json_name<span class="token operator">=</span><span class="token string">"car_class.json"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>


</code></pre> 
<p>注意一下，倒数的这几行</p> 
<pre><code class="prism language-python"> 		 target<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span> <span class="token operator">=</span> boxes
        target<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span> <span class="token operator">=</span> labels
        target<span class="token punctuation">[</span><span class="token string">"image_id"</span><span class="token punctuation">]</span> <span class="token operator">=</span> image_id
        target<span class="token punctuation">[</span><span class="token string">"area"</span><span class="token punctuation">]</span> <span class="token operator">=</span> area
        target<span class="token punctuation">[</span><span class="token string">"iscrowd"</span><span class="token punctuation">]</span> <span class="token operator">=</span> iscrowd
</code></pre> 
<p>其实最重要的是boxes和labels，其他的都可以不要</p> 
<pre><code class="prism language-python">VOC2012DataSet<span class="token punctuation">(</span><span class="token string">r"D:/"</span><span class="token punctuation">,</span>transforms<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>txt_name<span class="token operator">=</span><span class="token string">"car_train.txt"</span><span class="token punctuation">,</span>json_name<span class="token operator">=</span><span class="token string">"car_class.json"</span><span class="token punctuation">)</span>
</code></pre> 
<p>依次代表的是路径，图像增强，训练集文件名以及对应的目标。</p> 
<h4><a id="_224"></a>训练文件</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os

<span class="token keyword">import</span> torch

<span class="token keyword">import</span> my_transforms <span class="token keyword">as</span>  transforms
<span class="token keyword">from</span> network_files<span class="token punctuation">.</span>faster_rcnn_framework <span class="token keyword">import</span> FasterRCNN<span class="token punctuation">,</span> FastRCNNPredictor
<span class="token keyword">from</span> backbone<span class="token punctuation">.</span>resnet50_fpn_model <span class="token keyword">import</span> resnet50_fpn_backbone
<span class="token keyword">from</span> my_dataset <span class="token keyword">import</span> VOC2012DataSet
<span class="token keyword">from</span> train_utils <span class="token keyword">import</span> train_eval_utils <span class="token keyword">as</span> utils
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader


<span class="token keyword">def</span> <span class="token function">create_model</span><span class="token punctuation">(</span>num_classes<span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">:</span>

    backbone <span class="token operator">=</span> resnet50_fpn_backbone<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练自己数据集时不要修改这里的91，修改的是传入的num_classes参数</span>
    model <span class="token operator">=</span> FasterRCNN<span class="token punctuation">(</span>backbone<span class="token operator">=</span>backbone<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">91</span><span class="token punctuation">)</span>
    <span class="token comment"># 载入预训练模型权重</span>

    weights_dict <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"./backbone/fasterrcnn_resnet50_fpn_coco.pth"</span><span class="token punctuation">,</span> map_location<span class="token operator">=</span>device<span class="token punctuation">)</span>
    missing_keys<span class="token punctuation">,</span> unexpected_keys <span class="token operator">=</span> model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>weights_dict<span class="token punctuation">,</span> strict<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>missing_keys<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>unexpected_keys<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"missing_keys: "</span><span class="token punctuation">,</span> missing_keys<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"unexpected_keys: "</span><span class="token punctuation">,</span> unexpected_keys<span class="token punctuation">)</span>

    <span class="token comment"># get number of input features for the classifier</span>
    in_features <span class="token operator">=</span> model<span class="token punctuation">.</span>roi_heads<span class="token punctuation">.</span>box_predictor<span class="token punctuation">.</span>cls_score<span class="token punctuation">.</span>in_features
    <span class="token comment"># replace the pre-trained head with a new one</span>
    model<span class="token punctuation">.</span>roi_heads<span class="token punctuation">.</span>box_predictor <span class="token operator">=</span> FastRCNNPredictor<span class="token punctuation">(</span>in_features<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>

    <span class="token keyword">return</span> model


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>parser_data<span class="token punctuation">)</span><span class="token punctuation">:</span>

    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span>parser_data<span class="token punctuation">.</span>device <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Using {} device training."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    data_transform <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"train"</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"val"</span><span class="token punctuation">:</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    VOC_root <span class="token operator">=</span> parser_data<span class="token punctuation">.</span>data_path

    <span class="token comment"># check voc root</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>VOC_root<span class="token punctuation">,</span> <span class="token string">"VOCdevkit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> FileNotFoundError<span class="token punctuation">(</span><span class="token string">"VOCdevkit dose not in path:'{}'."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>VOC_root<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># load train data set</span>
    <span class="token comment"># VOCdevkit -&gt; VOC2012 -&gt; ImageSets -&gt; Main -&gt; train.txt</span>
    train_data_set <span class="token operator">=</span> VOC2012DataSet<span class="token punctuation">(</span>VOC_root<span class="token punctuation">,</span> data_transform<span class="token punctuation">[</span><span class="token string">"train"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>train_txt<span class="token punctuation">,</span>args<span class="token punctuation">.</span>json_name<span class="token punctuation">)</span>

    <span class="token comment"># 注意这里的collate_fn是自定义的，因为读取的数据包括image和targets，不能直接使用默认的方法合成batch</span>
    batch_size <span class="token operator">=</span> parser_data<span class="token punctuation">.</span>batch_size
    nw <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">[</span>os<span class="token punctuation">.</span>cpu_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size <span class="token keyword">if</span> batch_size <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># number of workers</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Using %g dataloader workers'</span> <span class="token operator">%</span> nw<span class="token punctuation">)</span>

    train_data_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_data_set<span class="token punctuation">,</span>
                                    batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>
                                    shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                    num_workers<span class="token operator">=</span>nw<span class="token punctuation">,</span>
                                    collate_fn<span class="token operator">=</span>train_data_set<span class="token punctuation">.</span>collate_fn<span class="token punctuation">)</span>

    <span class="token comment"># load validation data set</span>
    <span class="token comment"># VOCdevkit -&gt; VOC2012 -&gt; ImageSets -&gt; Main -&gt; val.txt</span>
    val_data_set <span class="token operator">=</span> VOC2012DataSet<span class="token punctuation">(</span>VOC_root<span class="token punctuation">,</span> data_transform<span class="token punctuation">[</span><span class="token string">"val"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>val_txt<span class="token punctuation">,</span>args<span class="token punctuation">.</span>json_name<span class="token punctuation">)</span>
    val_data_set_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>val_data_set<span class="token punctuation">,</span>
                                  batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>
                                  shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                                  num_workers<span class="token operator">=</span>nw<span class="token punctuation">,</span>
                                  collate_fn<span class="token operator">=</span>train_data_set<span class="token punctuation">.</span>collate_fn<span class="token punctuation">)</span>

    <span class="token comment"># create models num_classes equal background + 20 classes</span>
    <span class="token comment"># print(args.num_classes)</span>

    model <span class="token operator">=</span> create_model<span class="token punctuation">(</span>num_classes<span class="token operator">=</span>args<span class="token punctuation">.</span>num_classes<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
    <span class="token comment"># print(models)</span>

    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    <span class="token comment"># print(model)</span>
    <span class="token comment"># exit()</span>

    <span class="token comment"># define optimizer</span>
    params <span class="token operator">=</span> <span class="token punctuation">[</span>p <span class="token keyword">for</span> p <span class="token keyword">in</span> model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> p<span class="token punctuation">.</span>requires_grad<span class="token punctuation">]</span>
    optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>params<span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.005</span><span class="token punctuation">,</span>
                                momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span><span class="token number">0.0005</span><span class="token punctuation">)</span>

    <span class="token comment"># learning rate scheduler</span>
    lr_scheduler <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>StepLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span>
                                                   step_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
                                                   gamma<span class="token operator">=</span><span class="token number">0.33</span><span class="token punctuation">)</span>

    <span class="token comment"># 如果指定了上次训练保存的权重文件地址，则接着上次结果接着训练</span>
    <span class="token keyword">if</span> parser_data<span class="token punctuation">.</span>resume <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">:</span>
        checkpoint <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>parser_data<span class="token punctuation">.</span>resume<span class="token punctuation">,</span> map_location<span class="token operator">=</span>device<span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">'models'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">'optimizer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        lr_scheduler<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>checkpoint<span class="token punctuation">[</span><span class="token string">'lr_scheduler'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        parser_data<span class="token punctuation">.</span>start_epoch <span class="token operator">=</span> checkpoint<span class="token punctuation">[</span><span class="token string">'epoch'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"the training process from epoch{}..."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>parser_data<span class="token punctuation">.</span>start_epoch<span class="token punctuation">)</span><span class="token punctuation">)</span>

    train_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    learning_rate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    val_mAP <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>parser_data<span class="token punctuation">.</span>start_epoch<span class="token punctuation">,</span> parser_data<span class="token punctuation">.</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># train for one epoch, printing every 10 iterations</span>
        utils<span class="token punctuation">.</span>train_one_epoch<span class="token punctuation">(</span>model<span class="token punctuation">,</span> optimizer<span class="token punctuation">,</span> train_data_loader<span class="token punctuation">,</span>
                              device<span class="token punctuation">,</span> epoch<span class="token punctuation">,</span> train_loss<span class="token operator">=</span>train_loss<span class="token punctuation">,</span> train_lr<span class="token operator">=</span>learning_rate<span class="token punctuation">,</span>
                              print_freq<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> warmup<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token comment"># update the learning rate</span>
        lr_scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># evaluate on the test dataset</span>
        utils<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>model<span class="token punctuation">,</span> val_data_set_loader<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> mAP_list<span class="token operator">=</span>val_mAP<span class="token punctuation">)</span>

        <span class="token comment"># save weights</span>
        save_files <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'models'</span><span class="token punctuation">:</span> model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'optimizer'</span><span class="token punctuation">:</span> optimizer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'lr_scheduler'</span><span class="token punctuation">:</span> lr_scheduler<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'epoch'</span><span class="token punctuation">:</span> epoch<span class="token punctuation">}</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>save_files<span class="token punctuation">,</span> <span class="token string">"./save_weights/resNetFpn-models-{}.pth"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># plot loss and lr curve</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loss<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>learning_rate<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> plot_curve <span class="token keyword">import</span> plot_loss_and_lr
        plot_loss_and_lr<span class="token punctuation">(</span>train_loss<span class="token punctuation">,</span> learning_rate<span class="token punctuation">)</span>

    <span class="token comment"># plot mAP curve</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>val_mAP<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> plot_curve <span class="token keyword">import</span> plot_map
        plot_map<span class="token punctuation">(</span>val_mAP<span class="token punctuation">)</span>



<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    version <span class="token operator">=</span> torch<span class="token punctuation">.</span>version<span class="token punctuation">.</span>__version__<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>  <span class="token comment"># example: 1.6.0</span>
    <span class="token comment"># 因为使用的官方的混合精度训练是1.6.0后才支持的，所以必须大于等于1.6.0</span>
    <span class="token keyword">if</span> version <span class="token operator">&lt;</span> <span class="token string">"1.6.0"</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> EnvironmentError<span class="token punctuation">(</span><span class="token string">"pytorch version must be 1.6.0 or above"</span><span class="token punctuation">)</span>

    <span class="token keyword">import</span> argparse

    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>
        description<span class="token operator">=</span>__doc__<span class="token punctuation">)</span>

    <span class="token comment"># 训练设备类型</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--device'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'cuda:0'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'device'</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练数据集的根目录</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--data-path'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">r'D:/'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'dataset'</span><span class="token punctuation">)</span>
    <span class="token comment"># 文件保存地址</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--output-dir'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'./save_weights'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'path where to save'</span><span class="token punctuation">)</span>
    <span class="token comment"># 若需要接着上次训练，则指定上次训练保存权重文件地址</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--resume'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'resume from checkpoint'</span><span class="token punctuation">)</span>
    <span class="token comment"># 指定接着从哪个epoch数开始训练</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--start_epoch'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'start epoch'</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练的总epoch数</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--epochs'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'N'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'number of total epochs to run'</span><span class="token punctuation">)</span>
    <span class="token comment"># 训练的batch size</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--batch_size'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'N'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'batch size when training.'</span><span class="token punctuation">)</span>

    <span class="token comment"># parser.add_argument('--json_name', default="pascal_voc_classes.json", type=str, metavar='N',</span>
    <span class="token comment">#                     help='the num of classes')</span>
    <span class="token comment"># parser.add_argument('--train_txt', default="train.txt", type=str, metavar='N',</span>
    <span class="token comment">#                 )</span>
    <span class="token comment"># parser.add_argument('--val_txt', default="val.txt", type=str, metavar='N',</span>
    <span class="token comment">#                     )</span>

		
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--num_classes'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'N'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'the num of classes'</span><span class="token punctuation">)</span>

    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--json_name'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"car_class.json"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'N'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'the num of classes'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--train_txt'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"car_train.txt"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'N'</span><span class="token punctuation">,</span>
                    <span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--val_txt'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"car_val.txt"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'N'</span><span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>

    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>

    <span class="token comment"># 检查保存权重文件夹是否存在，不存在则创建</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>args<span class="token punctuation">.</span>output_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>args<span class="token punctuation">.</span>output_dir<span class="token punctuation">)</span>

    main<span class="token punctuation">(</span>args<span class="token punctuation">)</span>

</code></pre> 
<p>只需要自改最后几行，分类数，json名字，训练数据文件名，测试数据文件名</p> 
<h4><a id="_424"></a>预测文件</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> time
<span class="token keyword">import</span> json
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torchvision
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms
<span class="token keyword">from</span> network_files<span class="token punctuation">.</span>faster_rcnn_framework <span class="token keyword">import</span> FasterRCNN<span class="token punctuation">,</span> FastRCNNPredictor
<span class="token keyword">from</span> backbone<span class="token punctuation">.</span>resnet50_fpn_model <span class="token keyword">import</span> resnet50_fpn_backbone
<span class="token keyword">from</span> backbone<span class="token punctuation">.</span>resnet152_fpn_model <span class="token keyword">import</span> resnet152_fpn_backbone
<span class="token keyword">from</span> network_files<span class="token punctuation">.</span>rpn_function <span class="token keyword">import</span> AnchorsGenerator
<span class="token comment"># from backbone.mobilenetv2_model import MobileNetV2</span>
<span class="token keyword">from</span> draw_box_utils <span class="token keyword">import</span> draw_box
<span class="token keyword">import</span> os
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"KMP_DUPLICATE_LIB_OK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"TRUE"</span>


<span class="token keyword">def</span> <span class="token function">create_model</span><span class="token punctuation">(</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># mobileNetv2+faster_RCNN</span>
    <span class="token comment"># backbone = MobileNetV2().features</span>
    <span class="token comment"># backbone.out_channels = 1280</span>
    <span class="token comment">#</span>
    <span class="token comment"># anchor_generator = AnchorsGenerator(sizes=((32, 64, 128, 256, 512),),</span>
    <span class="token comment">#                                     aspect_ratios=((0.5, 1.0, 2.0),))</span>
    <span class="token comment">#</span>
    <span class="token comment"># roi_pooler = torchvision.ops.MultiScaleRoIAlign(featmap_names=['0'],</span>
    <span class="token comment">#                                                 output_size=[7, 7],</span>
    <span class="token comment">#                                                 sampling_ratio=2)</span>
    <span class="token comment">#</span>
    <span class="token comment"># models = FasterRCNN(backbone=backbone,</span>
    <span class="token comment">#                    num_classes=num_classes,</span>
    <span class="token comment">#                    rpn_anchor_generator=anchor_generator,</span>
    <span class="token comment">#                    box_roi_pool=roi_pooler)</span>

    <span class="token comment"># resNet50+fpn+faster_RCNN</span>
    <span class="token comment"># backbone = resnet50_fpn_backbone()</span>
    backbone <span class="token operator">=</span> resnet50_fpn_backbone<span class="token punctuation">(</span><span class="token punctuation">)</span>
    model <span class="token operator">=</span> FasterRCNN<span class="token punctuation">(</span>backbone<span class="token operator">=</span>backbone<span class="token punctuation">,</span> num_classes<span class="token operator">=</span>num_classes<span class="token punctuation">)</span>

    <span class="token keyword">return</span> model


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># get devices</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda:0"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"using {} device."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># create models</span>
    model <span class="token operator">=</span> create_model<span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token comment"># load train weights</span>
    train_weights <span class="token operator">=</span> <span class="token string">"./save_weights/resNetFpn-models-car.pth"</span>
    <span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>train_weights<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"{} file dose not exist."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>train_weights<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>train_weights<span class="token punctuation">,</span> map_location<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"models"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    <span class="token comment"># read class_indict</span>
    label_json_path <span class="token operator">=</span> <span class="token string">'./car_class.json'</span>
    <span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>label_json_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"json file {} dose not exist."</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>label_json_path<span class="token punctuation">)</span>
    json_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>label_json_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
    class_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>json_file<span class="token punctuation">)</span>
    category_index <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>v<span class="token punctuation">:</span> k <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> class_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

    <span class="token comment"># load image</span>
    <span class="token keyword">for</span> img <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string">"./test_image"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        img_head <span class="token operator">=</span> img<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        original_img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"./test_image"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># from pil image to tensor, do not normalize image</span>
        data_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> data_transform<span class="token punctuation">(</span>original_img<span class="token punctuation">)</span>
        <span class="token comment"># expand batch dimension</span>
        img <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>img<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 进入验证模式</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># init</span>
            img_height<span class="token punctuation">,</span> img_width <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            init_img <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> img_height<span class="token punctuation">,</span> img_width<span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>
            model<span class="token punctuation">(</span>init_img<span class="token punctuation">)</span>

            t_start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            predictions <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"inference+NMS time: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t_start<span class="token punctuation">)</span><span class="token punctuation">)</span>

            predict_boxes <span class="token operator">=</span> predictions<span class="token punctuation">[</span><span class="token string">"boxes"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            predict_classes <span class="token operator">=</span> predictions<span class="token punctuation">[</span><span class="token string">"labels"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            predict_scores <span class="token operator">=</span> predictions<span class="token punctuation">[</span><span class="token string">"scores"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cpu"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>predict_boxes<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"没有检测到任何目标!"</span><span class="token punctuation">)</span>

            draw_box<span class="token punctuation">(</span>original_img<span class="token punctuation">,</span>
                     predict_boxes<span class="token punctuation">,</span>
                     predict_classes<span class="token punctuation">,</span>
                     predict_scores<span class="token punctuation">,</span>
                     category_index<span class="token punctuation">,</span>
                     thresh<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">,</span>
                     line_thickness<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>original_img<span class="token punctuation">)</span>
            plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 保存预测的图片结果</span>
            original_img<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img_head<span class="token punctuation">}</span></span><span class="token string">test_result.jpg"</span></span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>这里是主要修改的地方，FasterRcnn完整算法代码已上传csdn。<br> 记录一下自己自定义数据集FasterRcnn，<br> 链接: <a href="https://download.csdn.net/download/weixin_42917352/43756999">Faster代码下载</a>.<br> 欢迎有志之士一起交流。VX<br> <img src="https://images2.imgbox.com/53/cd/WDpCtzzz_o.jpg" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c9e14ec9ae61dd3c592cef3e6415bf33/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">修改Eclipse .eclipse和.p2位置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/76e82af6e0ea7e15cf65799939c88f36/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JPA Java Persistence API学习笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>