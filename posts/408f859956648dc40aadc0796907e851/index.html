<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring 源码分析衍生篇三 : lookup-method 和 replaced-method - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Spring 源码分析衍生篇三 : lookup-method 和 replaced-method" />
<meta property="og:description" content="文章目录 一、前言二、基本使用1. 作用 三、原理实现1. 预处理1.1 AbstractBeanDefinition#prepareMethodOverrides1.2 AutowiredAnnotationBeanPostProcessor#determineCandidateConstructors 2. 真正处理 一、前言 本文是 Spring源码分析：单例bean的获取 - createBean 的衍生文章。主要是因为本人菜鸡，在分析源码的过程中还有一些其他的内容不理解，故开设衍生篇来完善内容以学习。
二、基本使用 1. 作用 lookup-method ：用于注入方法返回结果，也就是说能通过配置方式替换方法返回结果。(在方法或者抽象方法上使用@Lookup注解，将会根据该方法的返回值，自动在BeanFactory中调用getBean()来注入该Bean)replaced-method ：可以实现方法主体或返回结果的替换
通俗来讲 ： lookup-method 可以注入属性bean， replaced-method 替换方法实现。 下面跟着一个Demo来理解
// 基类接口 public interface DemoBase { String hello(); } ... public class DemoA implements DemoBase { public DemoBase getDemoBase() { return new DemoB(); } @Override public String hello() { return &#34;demoA hello&#34;; } } ... public class DemoB implements DemoBase { @Override public String hello() { return &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/408f859956648dc40aadc0796907e851/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-17T18:57:37+08:00" />
<meta property="article:modified_time" content="2020-05-17T18:57:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring 源码分析衍生篇三 : lookup-method 和 replaced-method</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">一、前言</a></li><li><a href="#_3" rel="nofollow">二、基本使用</a></li><li><ul><li><a href="#1__4" rel="nofollow">1. 作用</a></li></ul> 
  </li><li><a href="#_93" rel="nofollow">三、原理实现</a></li><li><ul><li><a href="#1__98" rel="nofollow">1. 预处理</a></li><li><ul><li><a href="#11_AbstractBeanDefinitionprepareMethodOverrides_99" rel="nofollow">1.1 AbstractBeanDefinition#prepareMethodOverrides</a></li><li><a href="#12_AutowiredAnnotationBeanPostProcessordetermineCandidateConstructors_139" rel="nofollow">1.2 AutowiredAnnotationBeanPostProcessor#determineCandidateConstructors</a></li></ul> 
   </li><li><a href="#2__188" rel="nofollow">2. 真正处理</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一、前言</h2> 
<p>本文是 Spring源码分析：<a href="https://blog.csdn.net/qq_36882793/article/details/105800112">单例bean的获取 - createBean</a> 的衍生文章。主要是因为本人菜鸡，在分析源码的过程中还有一些其他的内容不理解，故开设衍生篇来完善内容以学习。</p> 
<h2><a id="_3"></a>二、基本使用</h2> 
<h3><a id="1__4"></a>1. 作用</h3> 
<ul><li><code>lookup-method</code> ：用于注入方法返回结果，也就是说能通过配置方式替换方法返回结果。(在方法或者抽象方法上使用@Lookup注解，将会根据该方法的返回值，自动在BeanFactory中调用getBean()来注入该Bean)</li><li><code>replaced-method</code> ：可以实现方法主体或返回结果的替换<br> 通俗来讲 ： lookup-method 可以注入属性bean， replaced-method 替换方法实现。</li></ul> 
<p>下面跟着一个Demo来理解</p> 
<pre><code class="prism language-java"><span class="token comment">// 基类接口</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DemoBase</span> <span class="token punctuation">{<!-- --></span>
    String <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoA</span> <span class="token keyword">implements</span> <span class="token class-name">DemoBase</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> DemoBase <span class="token function">getDemoBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DemoB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"demoA hello"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoB</span> <span class="token keyword">implements</span> <span class="token class-name">DemoBase</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"DemoB hello"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoC</span> <span class="token keyword">implements</span> <span class="token class-name">DemoBase</span><span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"DemoC hello"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoMethodReplacer</span> <span class="token keyword">implements</span> <span class="token class-name">MethodReplacer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Object <span class="token function">reimplement</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{<!-- --></span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"method = "</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"reimplement"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们来配置一下bean.xml 如下</p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>beans xmlns<span class="token operator">=</span><span class="token string">"http://www.springframework.org/schema/beans"</span>
       xmlns<span class="token operator">:</span>xsi<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       xsi<span class="token operator">:</span>schemaLocation<span class="token operator">=</span><span class="token string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">"demoA"</span>  name<span class="token operator">=</span><span class="token string">"demoA"</span>  <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"com.kingfish.springbootdemo.property.DemoA"</span><span class="token operator">&gt;</span>
    	<span class="token comment">// 指定 DemoA.getDemoBase 方法，返回值是 容器中的demoC</span>
        <span class="token operator">&lt;</span>lookup<span class="token operator">-</span>method name<span class="token operator">=</span><span class="token string">"getDemoBase"</span> bean<span class="token operator">=</span><span class="token string">"demoC"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>lookup<span class="token operator">-</span>method<span class="token operator">&gt;</span>
        <span class="token comment">// 指定 DemoA.hello方法，其方法经过 demoMethodReplacer.reimplement 代理</span>
        <span class="token operator">&lt;</span>replaced<span class="token operator">-</span>method name<span class="token operator">=</span><span class="token string">"hello"</span> replacer<span class="token operator">=</span><span class="token string">"demoMethodReplacer"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>replaced<span class="token operator">-</span>method<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">"demoB"</span> name<span class="token operator">=</span><span class="token string">"demoB"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"com.kingfish.springbootdemo.property.DemoB"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">"demoC"</span> name<span class="token operator">=</span><span class="token string">"demoC"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"com.kingfish.springbootdemo.property.DemoC"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">"demoMethodReplacer"</span> name<span class="token operator">=</span><span class="token string">"demoMethodReplacer"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"com.kingfish.springbootdemo.property.DemoMethodReplacer"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>beans<span class="token operator">&gt;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@ImportResource</span><span class="token punctuation">(</span><span class="token string">"bean.xml"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringbootDemoApplication</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationRunner</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ConfigurableApplicationContext run <span class="token operator">=</span> SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>SpringbootDemoApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        DemoA demoA <span class="token operator">=</span> run<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>DemoA<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>demoA<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>demoA<span class="token punctuation">.</span><span class="token function">getDemoBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>运行后输出结果如下<br> <img src="https://images2.imgbox.com/2e/37/KYP6eMgB_o.png" alt="在这里插入图片描述"></p> 
<p>根据上面的demo。我们可以看出</p> 
<ul><li><code>lookup-method</code> : name 指定方法名，bean 指定方法返回的bean。这里注意上面的demo中<code>getDemoBase</code>方法没有必要实现，可以直接写一个抽象方法。即当调用 <code>demoA.getDemoBase</code> 方法时返回的是 Spring 容器中name为demoC 的bean。<strong>这里可以通过将demoC 设置成原型模式来实现单例模式下原型bean的获取。</strong></li><li><code>replaced-mthod</code> : name 指定方法名，replacer 指定代理类。即当调用demoA中的hello方法时，会经过<code>demoMethodReplacer</code>的代理。<code>demoMethodReplacer</code>需要实现<code>MethodReplacer</code> 接口，调用方法时会经过<code>MethodReplacer.reimplement</code> 方法。</li></ul> 
<h2><a id="_93"></a>三、原理实现</h2> 
<p>首先需要知道，lookup-method 和 replaced-method 注解标注的方法都会被保存在BeanDefinition.methodOverrides 集合中。这两个功能的实现原理其实也是在bean实例化的时候如果检测到 methodOverrides 属性存在，则会动态的为当前bean生成代理并使用对应的拦截器为bean做增强处理。<br> <img src="https://images2.imgbox.com/f4/10/zFHuSlfW_o.png" alt="在这里插入图片描述"></p> 
<p>Spring 对 这两个属性的处理 在两个部分</p> 
<h3><a id="1__98"></a>1. 预处理</h3> 
<h4><a id="11_AbstractBeanDefinitionprepareMethodOverrides_99"></a>1.1 AbstractBeanDefinition#prepareMethodOverrides</h4> 
<p>这个阶段的时候bean还没开始创建，先做了一个预先的工作，减少后面的工作量。</p> 
<p>这个方法做了一些预处理的工作</p> 
<p><strong>详细代码如下：</strong></p> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">prepareMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> BeanDefinitionValidationException <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Check that lookup methods exist and determine their overloaded status.</span>
		<span class="token comment">// 判断是否有方法需要重写</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">getMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span><span class="token operator">:</span>prepareMethodOverride<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">prepareMethodOverride</span><span class="token punctuation">(</span>MethodOverride mo<span class="token punctuation">)</span> <span class="token keyword">throws</span> BeanDefinitionValidationException <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 获取对应的类中的对应方法名的个数</span>
		<span class="token keyword">int</span> count <span class="token operator">=</span> ClassUtils<span class="token punctuation">.</span><span class="token function">getMethodCountForName</span><span class="token punctuation">(</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mo<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 等于0抛出异常</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionValidationException</span><span class="token punctuation">(</span>
					<span class="token string">"Invalid method override: no method with name '"</span> <span class="token operator">+</span> mo<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
					<span class="token string">"' on class ["</span> <span class="token operator">+</span> <span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Mark override as not overloaded, to avoid the overhead of arg type checking.</span>
			<span class="token comment">// 标记 MethodOverride 暂未被覆盖，避免参数类型检查的开销。</span>
			mo<span class="token punctuation">.</span><span class="token function">setOverloaded</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p><strong>解释一下上面的逻辑：</strong></p> 
<ol><li>首先会判断是否有方法需要重写，这里的是根据 <code>RootBeanDefinition</code> 中的 <code>methodOverrides</code> 属性来进行判断，为空则表示没有。</li><li>若上述判断有方法需要覆盖，则会调用<code>prepareMethodOverride(MethodOverride mo)</code> 方法。而在 <code>prepareMethodOverride(MethodOverride mo)</code> 方法中会根据 需要覆盖的方法名称 来获取加载类中关于该方法的实现。如果获取不到 <code>count == 0</code>，则直接抛出异常，如果获取到只有一个 <code>count == 1</code>，则记录该方法并未被重载（因为Spring在方法匹配时，如果一个类中存在若干个重载方法，则在函数调用及增强的时候需要根据参数类型进行匹配，来最终确定调用的方法是哪一个，这里直接设置了该方法并未被重载，在后续方法匹配的时候就不需要进行参数匹配验证，直接调用即可）。</li><li>打个比方，比如指定覆盖A类中的 a方法，但是A类中可能存在多个a方法或者不存在a方法，若count == 0不 存在a方法，则谈何覆盖，直接抛出异常，若count ==1 则a方法的实现只有一个，标记该方法并未被重载后续可跳过参数验证的步骤。</li></ol> 
<h4><a id="12_AutowiredAnnotationBeanPostProcessordetermineCandidateConstructors_139"></a>1.2 AutowiredAnnotationBeanPostProcessor#determineCandidateConstructors</h4> 
<p>在 这里对 @Lookup 注解 进行了一个简单处理，将被 @Lookup 注解修饰的方法添加到<code>RootBeanDefinition</code> 中的 <code>methodOverrides</code> 属性中</p> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> Constructor<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">determineCandidateConstructors</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> beanClass<span class="token punctuation">,</span> <span class="token keyword">final</span> String beanName<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> BeanCreationException <span class="token punctuation">{<!-- --></span>

		<span class="token comment">// Let's check for lookup methods here...</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>lookupMethodsChecked<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>AnnotationUtils<span class="token punctuation">.</span><span class="token function">isCandidateClass</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> Lookup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> targetClass <span class="token operator">=</span> beanClass<span class="token punctuation">;</span>
					<span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
						ReflectionUtils<span class="token punctuation">.</span><span class="token function">doWithLocalMethods</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">,</span> method <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
							Lookup lookup <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span>Lookup<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>lookup <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
								Assert<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">!=</span> null<span class="token punctuation">,</span> <span class="token string">"No BeanFactory available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								LookupOverride override <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LookupOverride</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> lookup<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
									RootBeanDefinition mbd <span class="token operator">=</span> <span class="token punctuation">(</span>RootBeanDefinition<span class="token punctuation">)</span>
											<span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getMergedBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
									mbd<span class="token punctuation">.</span><span class="token function">getMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addOverride</span><span class="token punctuation">(</span>override<span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token punctuation">}</span>
								<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
									<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
											<span class="token string">"Cannot apply @Lookup to beans without corresponding bean definition"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
								<span class="token punctuation">}</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						targetClass <span class="token operator">=</span> targetClass<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">while</span> <span class="token punctuation">(</span>targetClass <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> targetClass <span class="token operator">!=</span> Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token punctuation">}</span>
				<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Lookup method resolution failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>lookupMethodsChecked<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="2__188"></a>2. 真正处理</h3> 
<p>这个阶段bean处于正在创建的过程中，这里是对其他配置的处理，lookup-method，replaced-method就是其中之一。</p> 
<p><strong>SimpleInstantiationStrategy#instantiate(RootBeanDefinition, String, BeanFactory)</strong></p> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> Object <span class="token function">instantiate</span><span class="token punctuation">(</span>RootBeanDefinition bd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String beanName<span class="token punctuation">,</span> BeanFactory owner<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Don't override the class with CGLIB if no overrides.</span>
		<span class="token comment">// 判断是否有使用lookup-method，replaced-method 来标注方法。如果没有直接反射即可。</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">hasMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			Constructor<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> constructorToUse<span class="token punctuation">;</span>
			<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>bd<span class="token punctuation">.</span>constructorArgumentLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				constructorToUse <span class="token operator">=</span> <span class="token punctuation">(</span>Constructor<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> bd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod<span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>constructorToUse <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">final</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> clazz <span class="token operator">=</span> bd<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanInstantiationException</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"Specified class is an interface"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							constructorToUse <span class="token operator">=</span> AccessController<span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>
									<span class="token punctuation">(</span>PrivilegedExceptionAction<span class="token operator">&lt;</span>Constructor<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span> clazz<span class="token operator">:</span><span class="token operator">:</span>getDeclaredConstructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
							constructorToUse <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						bd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod <span class="token operator">=</span> constructorToUse<span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanInstantiationException</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"No default constructor found"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> BeanUtils<span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>constructorToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Must generate CGLIB subclass.</span>
			<span class="token keyword">return</span> <span class="token function">instantiateWithMethodInjection</span><span class="token punctuation">(</span>bd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>这里简单将一下逻辑，不再详细分析代码。<br> 首先判断当前bean是否有使用 lookup-method，replaced-method 属性，若没有使用，则直接使用反射即可。若使用，则不能简单的使用反射，需要将这两个配置提供的功能切入进去，所以就必须使用动态代理的方式将两个特性所对应的逻辑的拦截增强器设置进去。这样就可以保证在调用方法的时候会被相应的拦截器增强，返回值为包含拦截器的代理实例。</p> 
<hr> 
<p><strong>以上：内容部分参考<br> 《Spring源码深度解析》<br> <a href="https://blog.csdn.net/lyc_liyanchao/article/details/82901216">https://blog.csdn.net/lyc_liyanchao/article/details/82901216</a><br> 如有侵扰，联系删除。 内容仅用于自我记录学习使用。如有错误，欢迎指正</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e36964858370bf66b2d92f336ac496a2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spring源码分析五 ：bean的获取③ - getSingleton</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5f9d0fe21e11a31deefd891d842dd222/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">卷积神经网络性能优化（提高准确率）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>