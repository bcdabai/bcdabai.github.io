<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>keepalived配置tomcat的高可用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="keepalived配置tomcat的高可用" />
<meta property="og:description" content="我这里只说配置tomcat的高可用的步骤，不再讲解原理以及执行流程方面的知识， 关于keepalived的原理以及执行流程，请参考我的其他文章。
机器：
ip操作系统版本备注10.253.12.10CentOS Linux release 7.0 (Core) 将被配置为MASTER10.253.12.30CentOS Linux release 7.0 (Core) 将被配置为BACKUP 约定：
为了简便，下文10.253.12.10我会简称10，10.253.12.30我会简称为30。
一、10上的keepalived的配置文件 vi /etc/keepalived/keepalived.conf：
! Configuration File for keepalived global_defs { router_id zaspark02 #当前机器标识 } vrrp_script monitor_tomcat { script &#34;/etc/keepalived/script/tomcat_monitor.sh&#34; interval 3 } vrrp_instance VI_1 { state MASTER #主MASTER 从BACKUP interface eth0 #ifconfig 得到,机器不同可能不同 virtual_router_id 51 priority 100 #1-254 ,从需要小于主 #如果机器不支持组播，需要使用单播模式开始 unicast_src_ip 10.253.12.10 unicast_peer { 10.253.12.30 } #如果机器不支持组播，需要使用单播模式结束 advert_int 1 authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 10." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a5544467774b1d86fcd8362434089526/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-28T00:13:20+08:00" />
<meta property="article:modified_time" content="2020-04-28T00:13:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">keepalived配置tomcat的高可用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>我这里只说配置tomcat的高可用的步骤，不再讲解原理以及执行流程方面的知识， 关于keepalived的原理以及执行流程，请参考我的其他文章。</p> 
<p>        机器：</p> 
<table><tbody><tr><td style="vertical-align:top;">ip</td><td style="vertical-align:top;">操作系统版本</td><td style="vertical-align:top;">备注</td></tr><tr><td style="vertical-align:top;">10.253.12.10</td><td style="vertical-align:top;">CentOS Linux release 7.0 (Core) </td><td style="vertical-align:top;">将被配置为MASTER</td></tr><tr><td style="vertical-align:top;">10.253.12.30</td><td style="vertical-align:top;">CentOS Linux release 7.0 (Core) </td><td style="vertical-align:top;">将被配置为BACKUP</td></tr></tbody></table> 
<p>约定：</p> 
<p>        为了简便，下文10.253.12.10我会简称10，10.253.12.30我会简称为30。</p> 
<p>一、10上的keepalived的配置文件 vi  /etc/keepalived/keepalived.conf：</p> 
<pre>! Configuration File for keepalived
global_defs {
	router_id zaspark02  #当前机器标识
}
vrrp_script monitor_tomcat {
	script "/etc/keepalived/script/tomcat_monitor.sh"  
	interval 3                        
}
vrrp_instance VI_1 {
	state MASTER #主MASTER 从BACKUP
	interface eth0  #ifconfig 得到,机器不同可能不同
	virtual_router_id 51    
	priority 100  #1-254 ,从需要小于主
	#如果机器不支持组播，需要使用单播模式开始
	unicast_src_ip 10.253.12.10  
	unicast_peer  { 
                10.253.12.30  
            } 
	#如果机器不支持组播，需要使用单播模式结束
	advert_int 1  
	authentication {  
		auth_type PASS
		auth_pass 1111
	}
	virtual_ipaddress {   
		10.253.12.22
	}
	track_script {
		monitor_tomcat      
	}
	notify_backup  "/etc/keepalived/script/tomcat_backup.sh"   
	notify_master  "/etc/keepalived/script/tomcat_master.sh"   
}</pre> 
<p>二、30上的/etc/keepalived/keepalived.conf：</p> 
<pre>! Configuration File for keepalived
global_defs {
	router_id zaspark01 #当前机器标识
}
vrrp_script monitor_tomcat {
	script "/etc/keepalived/script/tomcat_monitor.sh"  
	interval 3                       
}
vrrp_instance VI_1 {
	state BACKUP   #主MASTER 从BACKUP
	interface eth0  #ifconfig 得到,机器不同可能不同
	virtual_router_id 51     
	priority 90  #1-254 ,从需要小于主
	#如果机器不支持组播，需要使用单播模式开始
unicast_src_ip 10.253.12.30
unicast_peer  {
                10.253.12.10
        }
    #如果机器不支持组播，需要使用单播模式结束
	advert_int 1  
	authentication {  
		auth_type PASS
		auth_pass 1111
	}
	virtual_ipaddress {   
		10.253.12.22
	}
track_script {
		monitor_tomcat       
	}
		notify_backup  "/etc/keepalived/script/tomcat_backup.sh"
		notify_master  "/etc/keepalived/script/tomcat_master.sh"
}</pre> 
<p>三、tomcat_monitor.sh：</p> 
<pre>#!/bin/bash
. /etc/profile 
. ~/.bashrc
logdate=`date "+%Y-%m-%d %H:%M:%S"`                
logfile="/etc/keepalived/script/tomcat_monitor.log"
#根据安装情况修改
curl http://localhost:8080 
if [ "$?" = "0" ];then
	echo "$logdate tomcat running"&gt;&gt;$logfile
	exit 0
else
	echo "$logdate tomcat not running,stop keepalived start..."&gt;&gt;$logfile
	service keepalived stop
	echo "stop keepalived end"&gt;&gt;$logfile
	echo "make sure kill tomcat start..."&gt;&gt;$logfile
	ps -ef|grep -v grep|grep tomcat|awk '{print $2}'|xargs kill -9
	echo  "kill -9 tomcat end"&gt;&gt;$logfile
	exit 1
fi</pre> 
<p>四、tomcat_master.sh：</p> 
<pre>#!/bin/bash
. /etc/profile 
. ~/.bashrc
logdate=`date "+%Y-%m-%d %H:%M:%S"`         
logfile="/etc/keepalived/script/tomcat_master.log"
#根据安装情况修改
curl http://localhost:8080 
if [ "$?" = "0" ];then
	echo "$logdate tomcat running"&gt;&gt;$logfile
	exit 0
else
	echo "$logdate tomcat not running"&gt;&gt;$logfile
	echo "start tomcat..."&gt;&gt;$logfile
	#根据安装情况修改
	sh /usr/local/tomcat/apache-tomcat-7.0.77/bin/startup.sh
	echo  "started tomcat"&gt;&gt;$logfile
	exit 1
fi</pre> 
<p>五、tomcat_backup.sh：</p> 
<pre>#!/bin/bash
. /etc/profile 
. ~/.bashrc
logdate=`date "+%Y-%m-%d %H:%M:%S"`         
logfile="/etc/keepalived/script/tomcat_backup.log"
#根据安装情况修改
curl http://localhost:8080 
if [ "$?" = "0" ];then
	echo "$logdate tomcat running"&gt;&gt;$logfile
	exit 0
else
	echo "$logdate tomcat not running"&gt;&gt;$logfile
	echo "start tomcat..."&gt;&gt;$logfile
	#根据安装情况修改
	sh /usr/local/tomcat/apache-tomcat-7.0.77/bin/startup.sh
	echo  "started tomcat"&gt;&gt;$logfile
	exit 1
fi</pre> 
<p>六、创建目录：</p> 
<pre>mkdir -p  /etc/keepalived/script</pre> 
<p>七、把这3个脚本放到/etc/keepalived/script目录下以供调用</p> 
<p>八、进入到脚本所在目录：</p> 
<pre>cd /etc/keepalived/script</pre> 
<p>九、赋予可执行的权限：</p> 
<pre>chmod  777  tomcat_*.sh</pre> 
<p>十、分别启动和停止10和30上的tomcat与keepalived服务，查看tomcat_monitor.log等日志的变化以及keepalived的日志/var/log/messages是否符合预期，并使用提供的虚拟ip（这里是10.253.12.22）访问tomcat验证是否可以访问。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/40d671fdb991a97f03a00cf1574180cd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">chrome 调试进入 paused in debugger 状态解决办法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/35d3a0e8dea6328851fbc08b47c50d29/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python3.8解决No module named &#39;numpy&#39;报错</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>