<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Egg开发项目实践纪实 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Egg开发项目实践纪实" />
<meta property="og:description" content="博客版文档在线阅读地址：egg开发实践文档-by山岚
Egg开发实践文档 目前项目中 Node.js 的需求是越来越多，简单的内部系统、Socket 通信服务、官网等，开发难度也越来越大，而 Egg.js 就是一款解决企业级开发问题的 Node.js 框架。
web服务端框架背景介绍 市面主要流行的有Express、Koa2、Egg、NextJs等
Express.js 是 Node.JS 诞生之初，最早出现的一款框架，现在仍然很流行，作者是TJ。随着ECMAScript的发展，推出了generator yield 语法，JS向同步方式写异步代码迈出了一步，作为回应，TJ大神推出了Koa.js。Koa.js是一款微型Web框架，写一个hello world很简单，但 web 应用离不开session，视图模板，路由，文件上传，日志管理。这些 Koa 都不提供，需要自行去官方的 Middleware 寻找。然而，100个人可能找出100种搭配。Egg.js是基于Koa.js，解决了上述问题，将社区最佳实践整合进了Koa.js，另取名叫Egg.js，并且将多进程启动，开发时的热更新等问题一并解决了。这对开发者很友好，开箱即用，开箱即是最(较)佳配置。Egg.js发展期间，ECMAScript又推出了 async await，相比yield的语法async写起来更直观。当然，Koa.js同步进行了跟进，Egg.js低层依赖Koa.js，自然也进行了跟进。现在TypeScript大热，可以在编码期间，提供类型检查，更智能的代码提示。Egg.js不支持TypeScript，此时淘宝团队在Egg.js基础上，引入了TypeScript支持，取名叫 MidwayJS 。 TypeScript是绕不开的话题。基于Express.js的全功能框架 Nest.js，他是在Express.js上封装的，充分利用了TypeScript的特性；Nest.js的优点是社区活跃，涨势喜人。缺点是，如果从来没有接触过TS，刚开始学习曲线有点陡峭。
简单来讲，egg.js对我们使用者来说，其实是封装了一套koa，可以理解成大礼包版的koa，集成度高，可以轻松创建一个项目而不用做很多繁琐的初期工作，解放生产力，更可贵的是有一套现成的规范提供给我们，不需要我们自己再去探索一套规范。
那我们，还在等什么呢？备好键盘，快来一起体验一下！
一、体验搭建过程（demo） 推荐直接使用脚手架，只需几条简单指令，即可快速生成项目（npm &gt;=6.1.0):
使用egg脚手架初始化 * $ mkdir eggDemo &amp;&amp; cd eggDemo * $ cnpm init egg --type=simple * $ cnpm i ps: npm下载插件网速较慢，还是cnpm的淘宝镜像好撸些~
下面是命令的执行过程~
[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-WG2XaxzR-1603701814698)(/egg1.jpg)]
当与脚手架的连接建立成功时，首先需要手动补充项目的配置项：
project name（项目名称）project description （项目描述）project anthor (作者)cookie security keys (cookie标识 此项默认生成) [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Vvn59Sfy-1603701814699)(/egg2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f9c739243bec8308c311c6728c514546/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-26T16:45:11+08:00" />
<meta property="article:modified_time" content="2020-10-26T16:45:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Egg开发项目实践纪实</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>博客版文档在线阅读地址：<a href="http://egg.epochy.cn" rel="nofollow">egg开发实践文档-by山岚</a></p> 
<h2><a id="Egg_1"></a>Egg开发实践文档</h2> 
<p>目前项目中 Node.js 的需求是越来越多，简单的内部系统、Socket 通信服务、官网等，开发难度也越来越大，而 Egg.js 就是一款解决企业级开发问题的 Node.js 框架。</p> 
<h3><a id="web_4"></a>web服务端框架背景介绍</h3> 
<blockquote> 
 <p>市面主要流行的有Express、Koa2、Egg、NextJs等</p> 
</blockquote> 
<ul><li><strong>Express.js</strong> 是 Node.JS 诞生之初，最早出现的一款框架，现在仍然很流行，作者是TJ。</li><li>随着ECMAScript的发展，推出了<code>generator yield</code> 语法，JS向同步方式写异步代码迈出了一步，作为回应，TJ大神推出了<strong>Koa.js</strong>。</li><li><strong>Koa.js</strong>是一款微型Web框架，写一个<code>hello world</code>很简单，但 <strong>web</strong> 应用离不开<strong>session</strong>，视图模板，路由，文件上传，日志管理。这些 <strong>Koa</strong> 都不提供，需要自行去官方的 <code>Middleware</code> 寻找。<strong>然而，100个人可能找出100种搭配</strong>。</li><li><strong>Egg.js</strong>是基于<strong>Koa.js</strong>，解决了上述问题，将社区最佳实践整合进了<strong>Koa.js</strong>，另取名叫<strong>Egg.js</strong>，并且将多进程启动，开发时的热更新等问题一并解决了。这对开发者很友好，开箱即用，开箱即是最(较)佳配置。</li><li><strong>Egg.js</strong>发展期间，<strong>ECMAScript</strong>又推出了 <code>async await</code>，相比yield的语法async写起来更直观。当然，<strong>Koa.js</strong>同步进行了跟进，<strong>Egg.js</strong>低层依赖<strong>Koa.js</strong>，自然也进行了跟进。</li><li>现在<strong>TypeScript</strong>大热，可以在编码期间，提供类型检查，更智能的代码提示。<strong>Egg.js</strong>不支持<strong>TypeScript</strong>，此时淘宝团队在<strong>Egg.js</strong>基础上，引入了<strong>TypeScript</strong>支持，取名叫 <strong>MidwayJS</strong> 。</li></ul> 
<blockquote> 
 <p>TypeScript是绕不开的话题。基于Express.js的全功能框架 Nest.js，他是在Express.js上封装的，充分利用了TypeScript的特性；Nest.js的优点是社区活跃，涨势喜人。缺点是，如果从来没有接触过TS，刚开始学习曲线有点陡峭。</p> 
</blockquote> 
<p>简单来讲，<strong>egg.js</strong>对我们使用者来说，其实是封装了一套<strong>koa</strong>，可以理解成大礼包版的<strong>koa</strong>，集成度高，可以轻松创建一个项目而不用做很多繁琐的初期工作，解放生产力，更可贵的是有一套现成的规范提供给我们，不需要我们自己再去探索一套规范。<br></p> 
<p>那我们，还在等什么呢？<strong>备好键盘，快来一起体验一下！</strong></p> 
<h3><a id="demo_19"></a>一、体验搭建过程（demo）</h3> 
<p>推荐直接使用脚手架，只需几条简单指令，即可快速生成项目（npm &gt;=6.1.0):</p> 
<h4><a id="egg_23"></a>使用egg脚手架初始化</h4> 
<pre><code>* $ mkdir eggDemo &amp;&amp; cd eggDemo
* $ cnpm init egg --type=simple
* $ cnpm i
</code></pre> 
<blockquote> 
 <p>ps: npm下载插件网速较慢，还是cnpm的淘宝镜像好撸些~</p> 
</blockquote> 
<p>下面是命令的执行过程~</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-WG2XaxzR-1603701814698)(/egg1.jpg)]</p> 
<p>当与脚手架的连接建立成功时，首先需要手动补充项目的配置项：</p> 
<ul><li>project name（项目名称）</li><li>project description （项目描述）</li><li>project anthor (作者)</li><li><strong>cookie security keys</strong> (cookie标识 此项默认生成)</li></ul> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Vvn59Sfy-1603701814699)(/egg2.jpg)]</p> 
<p>注意：<br></p> 
<p>目录结构如图。其实简单来讲，脚手架就是在 npm 仓库中下载了个模板，然后给我们配置了个key。</p> 
<blockquote> 
 <p>谈论key值，它并不是个随机数，经过我的解密,<br><br> 是当前拉取脚手架的时间戳_当天下载量拼凑而成 Yeah~ 好吧，和随机数效果没差</p> 
</blockquote> 
<pre><code class="prism language-js"><span class="token comment">// use for cookie sign key, should change to your own and keep security</span>
config<span class="token punctuation">.</span>keys <span class="token operator">=</span> appInfo<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'_1603108381520_3138'</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="egginit_54"></a>使用egg-init脚手架初始化</h4> 
<p><strong>使用官方脚手架 egg-init 开始项目。</strong></p> 
<ul><li>脚手架安装：npm i -g egg-init</li><li>初始化目录：egg-init egg-first --type=simple</li><li>安装项目依赖：cd egg-first &amp;&amp; npm i</li><li>热部署启动：npm run dev</li></ul> 
<p>全局安装egg-init后，我们执行初始化流程，但是往下走的路往往不会那么顺利。</p> 
<blockquote> 
 <p>Connect Timeout for 5000ms!</p> 
</blockquote> 
<p>由于网络的原因，和npm仓库无法直连，那有别的法子能解决此问题否？</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-KWf09PoA-1603701814700)(/egg3.jpg)]</p> 
<ul><li>遇到问题,就去打开help~</li></ul> 
<p><strong>在配置项中，出现了配置registry的选项。（<strong>china/npm/custom</strong>,默认自动探测选择）</strong></p> 
<blockquote> 
 <p>顾名思义，china应该就是国内的仓库镜像.虽然他提及了自动选择，但是我试了五次，没有一次在超时后实现自动更换配置。这就有趣了~</p> 
</blockquote> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-3t2beavq-1603701814702)(/egg4.jpg)]</p> 
<p>我们转换思路，在执行初始化指令时，把配置项写入指令中。</p> 
<pre><code class="prism language-js">egg<span class="token operator">-</span>init egg<span class="token operator">-</span>first <span class="token operator">-</span>r<span class="token operator">=</span>china <span class="token operator">--</span>type<span class="token operator">=</span>simple
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-NCkwzpQt-1603701814704)(/egg5.jpg)]</p> 
<p>妥当！成功安装！</p> 
<p><strong>这里有个需要注意的点：</strong> 当准备项目的description时，不可以使用双引号。<br> 因为在配置文件时，录入的信息都会以json的key-value的形式写入到package.json中，如果带入双引号，会破坏package.json文件的结构，无法成功安装后续的依赖包。形如：</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-OcHVtblq-1603701814706)(/egg6.jpg)]</p> 
<p>解决了上面的注意事项，接下来就可以在编辑器中愉快的玩耍了。</p> 
<h4><a id="_94"></a>安装依赖</h4> 
<pre><code class="prism language-js">cnpm i
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-X6cEMThB-1603701814706)(/egg8.jpg)]</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-g90ySIBn-1603701814707)(/egg9.jpg)]</p> 
<h4><a id="_103"></a>运行初尝试</h4> 
<p>当准备工作完成后，我们可以在 <strong>浏览器</strong> 点开启动后的项目地址：http://127.0.0.1:7001<br> hello egg 经典再现：</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Fyqo8tsj-1603701814708)(/egg10.jpg)]</p> 
<h3><a id="_110"></a>二、架构概览</h3> 
<p>在成功搭建了简易的egg服务之后，我们回头看下在egg的 <strong>约定优于配置</strong> 的主旨下，具体是怎样实现的。</p> 
<h4><a id="_113"></a>脚手架项目结构</h4> 
<blockquote> 
 <p>我们的项目结构如下这般：</p> 
</blockquote> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-9ujNDO3U-1603701814709)(/egg7.jpg)]</p> 
<p>注解：</p> 
<pre><code> egg-first //项目根目录
 ├─ .autod.conf.js
 ├─ .eslintignore
 ├─ .eslintrc // eslint规则
 ├─ app
 │  ├─ controller //用于解析用户的输入，处理后返回相应的结果
 │  │  └─ home.js
 │  └─ router.js // 用于配置 URL 路由规则
 ├─ config //配置
 │  ├─ config.default.js //用于编写配置文件
 │  └─ plugin.js //用于配置需要加载的插件
 ├─ package.json
 ├─ README.md
 └─ test // 用于单元测试
    └─ app
       └─ controller
          └─ home.test.js
</code></pre> 
<p>初始化完成后，我们可以发现两点</p> 
<ol><li>其实目录和配置文件并不多，但是结构清晰。</li><li>在egg.js约定优于配置的主旨下，<strong>更多的配置文件都是可选的状态，未被创建</strong>，对后期开发而言，具有很强的灵活性。</li></ol> 
<h4><a id="_143"></a>完整项目结构及释义</h4> 
<p><em>官网</em> 补充的具体项目结构如下：</p> 
<pre><code>egg-project
├── package.json
├── app.js (可选)
├── agent.js (可选)
├── app
|   ├── router.js
│   ├── controller
│   |   └── home.js
│   ├── service (可选)
│   |   └── user.js
│   ├── middleware (可选)
│   |   └── response_time.js
│   ├── schedule (可选)
│   |   └── my_task.js
│   ├── public (可选)
│   |   └── reset.css
│   ├── view (可选)
│   |   └── home.tpl
│   └── extend (可选)
│       ├── helper.js (可选)
│       ├── request.js (可选)
│       ├── response.js (可选)
│       ├── context.js (可选)
│       ├── application.js (可选)
│       └── agent.js (可选)
├── config
|   ├── plugin.js
|   ├── config.default.js
│   ├── config.prod.js
|   ├── config.test.js (可选)
|   ├── config.local.js (可选)
|   └── config.unittest.js (可选)
└── test
    ├── middleware
    |   └── response_time.test.js
    └── controller
        └── home.test.js
</code></pre> 
<p>上面这些具体的、由框架约定的目录，一一释义：</p> 
<ul><li>app/router.js 用于配置 URL 路由规则。</li><li>app/controller/** 用于解析用户的输入，处理后返回相应的结果。</li><li>app/service/** 用于编写业务逻辑层，<strong>可选，建议使用</strong>。</li><li>app/middleware/** 用于编写中间件，<strong>可选</strong>。</li><li>app/public/** 用于放置静态资源，<strong>可选</strong>。</li><li>app/extend/** 用于框架的扩展，<strong>可选</strong>。</li><li>config/config.{env}.js 用于编写配置文件。</li><li>config/plugin.js 用于配置需要加载的插件。</li><li>test/** 用于单元测试。</li><li>app.js 和 agent.js 用于自定义启动时的初始化工作，<strong>可选</strong>。</li></ul> 
<blockquote> 
 <p>由内置插件约定的目录：</p> 
</blockquote> 
<ul><li>app/public/** 用于放置静态资源，可选。</li><li>app/schedule/** 用于定时任务，可选。</li></ul> 
<h4><a id="_203"></a>浅析运行机制</h4> 
<p>回顾我们打开浏览器时，请求的地址为 <em>http://127.0.0.1:7001/</em></p> 
<p>如果 <strong>好奇</strong> 请求的接口如何做出响应的，可以先简单看下router.js的运行机制</p> 
<pre><code class="prism language-js"><span class="token comment">// app/router.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * @param {Egg.Application} app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> app <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p><strong>router.js</strong>，是请求的路由配置文件。</p> 
<ul><li><strong>Router</strong> 主要用来描述请求 URL 和具体承担执行动作的 <strong>Controller</strong> 的 <strong>对应关系</strong>。</li><li><strong>框架约定了 app/router.js 文件用于统一所有路由规则</strong>。</li><li>通过<strong>统一的配置</strong>，我们可以避免路由规则逻辑散落在多个地方，从而出现未知的冲突，集中在一起我们可以<strong>更方便</strong>的来查看<strong>全局的路由规则</strong>。</li></ul> 
<p>仔细观察我们项目中的<strong>router.js</strong>，不难发现，在拿到 app的 router和controller类后，有个简单的 Router 对应关系：</p> 
<pre><code class="prism language-js">router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>我们通过 Router 将用户的请求基于 method 和 URL 分发到了对应的 Controller 上，那 Controller 负责做什么？<br> 简单的说 Controller 负责解析用户的输入，处理后返回相应的结果。</p> 
</blockquote> 
<p>简单的看一下我们的如今的controller的模样</p> 
<pre><code class="prism language-js"><span class="token comment">//app/controller/home.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hi, egg'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> HomeController<span class="token punctuation">;</span>

</code></pre> 
<p>controller的使用可分为以下三个场景：</p> 
<ul><li><strong>在 RESTful 接口中</strong>，Controller 接受用户的参数，从数据库中查找内容返回给用户或者将用户的请求更新到数据库中。</li><li><strong>在 HTML 页面请求中</strong>，Controller 根据用户访问不同的 URL，渲染不同的模板得到 HTML 返回给用户。</li><li><strong>在代理服务器中</strong>，Controller 将用户的请求转发到其他服务器上，并将其他服务器的处理结果返回给用户。</li></ul> 
<p><strong>在浏览器发起http://127.0.0.1:7001/请求后，路由以get请求 分发到了 controller的home的index入口方法<br><br> 在拿到ctx上下文后，处理响应，成功返回了字符‘hi，egg’</strong></p> 
<p>至此，一个仅涉及router和controller内置对象的简单的请求就通了。</p> 
<h4><a id="_261"></a>思考体会</h4> 
<p>在脚手架中，我们发现其只是提供了最基础的配置项。凡是标注【可选】状态的，都没有创建。</p> 
<p>但是实际使用的过程中，有些配置文件或约定的文件夹是必不可少的。</p> 
<p>接下来让我们以一个实例的形式，在和数据库交互的过程中，体验egg.js的工作原理。</p> 
<h3><a id="_272"></a>三、山岚笔札项目搭建</h3> 
<h4><a id="_274"></a>效果预览</h4> 
<p>使用egg.js链接mySql数据库搭建笔记站点，具备CRUD的完整功能。详情可预览效果 <a href="http://news.epochy.cn" rel="nofollow">山岚笔札</a></p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-5halTgmr-1603701814709)(/list.gif)]<br> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-nF5Ifry9-1603701814710)(/add.gif)]</p> 
<h4><a id="_280"></a>框架搭建</h4> 
<p>因为之前使用脚手架搭建的项目骨架，结构过于简单。所以需要适当增加几个常用的文件夹：</p> 
<ul><li>app/service/** 用于编写业务逻辑层</li><li>app/public/** 用于放置静态资源</li><li>app/extend/helper.js 用于框架的扩展,提供一些实用的 utility 函数</li></ul> 
<h4><a id="_287"></a>引入数据库</h4> 
<p>我们使用的数据库是mysql，但是我们不是直接使它，而是安装封装过的mysql2和egg-sequelize。</p> 
<blockquote> 
 <p>在 Node.js 社区中，sequelize 是一个广泛使用的 ORM 框架，它支持 MySQL、PostgreSQL、SQLite 和 MSSQL 等多个数据源。它会辅助我们将定义好的 Model 对象加载到 app 和 ctx 上。</p> 
</blockquote> 
<pre><code class="prism language-js"># 安装mysql
$ npm i mysql2 <span class="token operator">-</span><span class="token constant">S</span>

# 安装使用egg的sequelize版本  egg<span class="token operator">-</span>sequelize
$ npm add egg<span class="token operator">-</span>sequelize <span class="token operator">-</span><span class="token constant">S</span>
</code></pre> 
<p>当然，我们需要一个数据库进行连接，那就得在本机或服务器安装一个能够供我们使用的数据库。<br> 关于mysql安装包 待我准备好分享 或者 问一下度娘即可，这里不多解释。</p> 
<p>数据库安装好后，我们管理数据库，可以通过控制台命令行进行控制，也可以通过图形化工具进行控制。我们推荐后者，我们下载了一个Navicat Premiun的工具。</p> 
<blockquote> 
 <p>Navicat Premiun 是一款数据库可视化管理工具。</p> 
</blockquote> 
<h4><a id="_304"></a>连接数据库</h4> 
<p>配置数据库的基本信息，前提是我们已经创建好了这个数据库。假设我们创建了一个名为article的数据库，用户是root，密码是mine2020。那么，我们就可以像下面这样连接。</p> 
<pre><code class="prism language-js"><span class="token comment">// config/config.default.js</span>
<span class="token operator">...</span>
  <span class="token comment">// 数据库连接</span>
  config<span class="token punctuation">.</span>sequelize <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    dialect<span class="token punctuation">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    host<span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> <span class="token string">'led_develop'</span><span class="token punctuation">,</span>
    username<span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token string">'mine2020'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
</code></pre> 
<p>当然，这是通过包egg-sequelize处理的，我们也要将其引入，告诉eggjs去使用这个插件。</p> 
<pre><code class="prism language-js"><span class="token comment">// config/plugin.js</span>
<span class="token operator">...</span>
  sequelize<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    enable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">package</span><span class="token punctuation">:</span> <span class="token string">'egg-sequelize'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span>
</code></pre> 
<h4><a id="_331"></a>创建数据库表</h4> 
<h5><a id="1__332"></a>1. 通过查询语句创建</h5> 
<p>你可以直接通过<strong>mysql控制台命令行或者或者可视化工具Navicat Premiun</strong> <br><br> 执行mysql查询语句创建 ↓</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-k3CBaMlH-1603701814711)(/egg11.jpg)]<br> 参考查询语句如下：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>articlesss<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'primary key'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>logo<span class="token punctuation">`</span> <span class="token keyword">LONGTEXT</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'封面图'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>title<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'标题'</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span><span class="token keyword">desc</span><span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'笔记摘要'</span><span class="token punctuation">,</span>
	<span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">LONGTEXT</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'笔记内容'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>change_date<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> articles
<span class="token keyword">MODIFY</span> change_date <span class="token keyword">datetime</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间要自增'</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="2_sequelizeMigrations_353"></a>2. 使用sequelize实现Migrations迁移操作</h5> 
<p>我们可以直接通过 mysql 命令将表直接建好，但是这并不是一个对多人协作非常友好的开发模式。</p> 
<blockquote> 
 <p>在项目的演进过程中，每一个迭代都有可能对数据库数据结构做变更，怎样跟踪每一个迭代的数据变更，并在不同的环境（开发、测试、CI）和迭代切换中，快速变更数据结构呢？这时候我们就需要 Migrations 来帮我们管理数据结构的变更了。</p> 
</blockquote> 
<p><em>sequelize 提供了 sequelize-cli 工具来实现 Migrations，我们可以在 egg 项目中引入 sequelize-cli。</em></p> 
<pre><code class="prism language-js">npm i sequelize<span class="token operator">-</span>cli <span class="token operator">-</span><span class="token constant">D</span>
</code></pre> 
<p>在项目中，我们希望将所有的数据库Migrations相关的内容都放在database目录下面，所以在根目录下新建一个.sequelizerc配置文件：</p> 
<blockquote> 
 <p>如果不配置.sequelizerc 的话，sequelize init 初始化的文件夹会出现在项目目录下面，如果配置了.sequelizerc 就可以指定到相应的目录</p> 
</blockquote> 
<pre><code class="prism language-js"><span class="token comment">// .sequelizerc</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  config<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'database/config.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'migrations-path'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'database/migrations'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'seeders-path'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'database/seeders'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'models-path'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'app/model'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>在终端初始化Migrations配置文件和目录。</strong></p> 
<pre><code class="prism language-js">npx sequelize init<span class="token punctuation">:</span>config
npx sequelize init<span class="token punctuation">:</span>migrations
</code></pre> 
<p>执行完后会生成 database/config.json 文件和 database/migrations 目录 ↓</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-d1TITkYA-1603701814712)(/egg12.jpg)]</p> 
<p>我们修改一下 database/config.json 中的内容，将其改成我们项目中使用的数据库配置：</p> 
<pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"development"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"mine2020"</span><span class="token punctuation">,</span>
    <span class="token string">"database"</span><span class="token punctuation">:</span> <span class="token string">"led_develop"</span><span class="token punctuation">,</span>
    <span class="token string">"host"</span><span class="token punctuation">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
    <span class="token string">"dialect"</span><span class="token punctuation">:</span> <span class="token string">"mysql"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"test"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"mine2020"</span><span class="token punctuation">,</span>
    <span class="token string">"database"</span><span class="token punctuation">:</span> <span class="token string">"led_test"</span><span class="token punctuation">,</span>
    <span class="token string">"host"</span><span class="token punctuation">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
    <span class="token string">"dialect"</span><span class="token punctuation">:</span> <span class="token string">"mysql"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"production"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"mine2020"</span><span class="token punctuation">,</span>
    <span class="token string">"database"</span><span class="token punctuation">:</span> <span class="token string">"led_production"</span><span class="token punctuation">,</span>
    <span class="token string">"host"</span><span class="token punctuation">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
    <span class="token string">"dialect"</span><span class="token punctuation">:</span> <span class="token string">"mysql"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>此时 sequelize-cli 和相关的配置初始化到这里就完成啦。<br></p> 
<p>接下来，我们就可以开始编写项目的第一个 Migration 文件来创建我们数据库的“主菜” <strong>articles表</strong>。</p> 
<pre><code class="prism language-js">npx sequelize migration<span class="token punctuation">:</span>generate <span class="token operator">--</span>name<span class="token operator">=</span>init<span class="token operator">-</span>articles
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-meBEX8EV-1603701814712)(/egg13.jpg)]<br> 执行完后会在 database/migrations 目录下生成一个 migration 文件(${timestamp}-init-users.js)，我们修改它来处理初始化 users 表：</p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-usolQQlz-1603701814714)(/egg14.jpg)]</p> 
<p>下面是init-articles.js的具体模样 ↓</p> 
<pre><code class="prism language-js"><span class="token comment">// app/model/article.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 在执行数据库升级时调用的函数，创建 users 表</span>
  up<span class="token punctuation">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>queryInterface<span class="token punctuation">,</span> Sequelize<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Sequelize<span class="token punctuation">;</span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'articles'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      id<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      logo<span class="token punctuation">:</span> <span class="token constant">TEXT</span><span class="token punctuation">(</span><span class="token string">'long'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      title<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      desc<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      content<span class="token punctuation">:</span> <span class="token constant">TEXT</span><span class="token punctuation">(</span><span class="token string">'long'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      change_date<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 在执行数据库降级时调用的函数，删除 users 表</span>
  down<span class="token punctuation">:</span> <span class="token keyword">async</span> queryInterface <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'articles'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p><strong>在涉及数据类型定义的问题时，需要和数据库的类型定义对应。<br><br> <em>sequelize</em> 的常用类型:</strong></p> 
<table><thead><tr><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>STRING</td><td>将字段指定为变长字符串类型，默认长度为 255。例：<em><strong>Sequelize.STRING(64)</strong></em></td></tr><tr><td>CHAR</td><td>将字段指定为定长字符串类型，默认长度为 255。例：<em><strong>Sequelize.CHAR(64)</strong></em></td></tr><tr><td>TEXT</td><td>将字段指定为(无)有限长度的文本列。可用长度：tiny, medium, long。例： <em><strong>Sequelize.TEXT(‘tiny’)</strong></em></td></tr><tr><td>INTEGER</td><td>32位整型，可用属性：UNSIGNED,ZEROFILL。例：Sequelize.INTEGER(‘UNSIGNED’)</td></tr><tr><td>DECIMAL</td><td>小数，接受一个或两个参数表示精度。例：<em><strong>Sequelize.BOOLEAN()</strong></em></td></tr><tr><td>TIME</td><td>指定为时间类型列，<em><strong>Sequelize.TIME()</strong></em></td></tr><tr><td>DATE</td><td>指定为日期时间类型列, <em><strong>Sequelize.DATE()</strong></em></td></tr><tr><td>DATEONLY</td><td>指定为日期类型列, <em><strong>Sequelize.DATEONLY()</strong></em></td></tr><tr><td>HSTORE</td><td>指定为键/值类型列，仅Postgres适用, <em><strong>Sequelize.HSTORE()</strong></em></td></tr><tr><td>JSON</td><td>指定为JSON字符串类型列，仅Postgres适用, <em><strong>Sequelize.JSON()</strong></em></td></tr><tr><td>JSONB</td><td>指定为预处理的JSON数据列，仅Postgres适用, <em><strong>Sequelize.JSONB()</strong></em></td></tr><tr><td>NOW</td><td>一个表示当前时间戳的默认值, <em><strong>Sequelize.NOW()</strong></em></td></tr><tr><td>UUID</td><td>UUID类型列，其默认值可以为UUIDV1或UUIDV4，<em><strong>Sequelize.UUID()</strong></em></td></tr><tr><td>ENUM</td><td>枚举类型, <em><strong>Sequelize.ENUM()</strong></em></td></tr><tr><td>ARRAY</td><td>数组类型，仅Postgres适用, <em><strong>Sequelize.ARRAY()</strong></em></td></tr></tbody></table> 
<p>而后在项目中执行脚本命令：</p> 
<pre><code class="prism language-js"># 升级数据库
npx sequelize db<span class="token punctuation">:</span>migrate
</code></pre> 
<ul><li>如果有问题需要回滚，可以通过 <code>db:migrate:undo</code> 回退一个变更</li><li><code>npx sequelize db:migrate:undo</code></li><li>可以通过 <code>db:migrate:undo:all</code> 回退到初始状态</li><li><code>npx sequelize db:migrate:undo:all</code></li></ul> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-alMHBDOg-1603701814714)(/egg15.jpg)]</p> 
<p>但是如果在执行过程中遇到了：</p> 
<blockquote> 
 <p>ERROR: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ‘NOW, PRIMARY KEY (id)) ENGINE=InnoDB’ at line 1</p> 
</blockquote> 
<p>这时，<strong>停下来</strong> 看一下model/article.js中的创建表的语句是否有数据类型方面的错误，err内容虽然是报mysql版本问题，但是实际上，数据类型定义出错，也囊括其中。</p> 
<p>只要我们的脚本没问题，<code>在执行migrate的过程就不会节外生枝</code>。</p> 
<p>更加详细内容，可以参考官网 <a href="https://www.sequelize.com.cn/" rel="nofollow">sequelize</a> 相关章节</p> 
<hr> 
<h3><a id="CRUD_493"></a>四、准备CRUD接口</h3> 
<p>服务端的工作到这里就准备妥当了，我们可以在此基础上开始编写代码，实现属于自己的业务逻辑。<br> 那么，下面的章节是结合数据库，来实现对文章表进行增删改查的操作。</p> 
<p>首先我们来在 app/model/ 目录下编写 user 这个 Model：</p> 
<pre><code class="prism language-js"><span class="token string">'use strict'</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> app <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">TEXT</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span>

  <span class="token keyword">const</span> Article <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>
    <span class="token string">'articlesss'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      id<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span> type<span class="token punctuation">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      logo<span class="token punctuation">:</span> <span class="token constant">TEXT</span><span class="token punctuation">(</span><span class="token string">'long'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      title<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      desc<span class="token punctuation">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      content<span class="token punctuation">:</span> <span class="token constant">TEXT</span><span class="token punctuation">(</span><span class="token string">'long'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      change_date<span class="token punctuation">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      freezeTableName<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 不自动将表名添加复数</span>
      timestamps<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 不强制添加 created_at/updated_at 两个时间戳字段</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Article<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>这个 <em><strong>Model</strong></em> 就可以在 <em><strong>Controller</strong></em> 和 <em><strong>Service</strong></em> 中通过 <em><strong>app.model.User</strong></em> 或者 <em><strong>ctx.model.User</strong></em> 访问到了。</p> 
<p>之后，搭架路由，我们使用的是MVC的架构，那么我们的现有代码逻辑自然会这样流向：<br></p> 
<ul><li><code>app/router.js 获取文章路由</code>↓↓↓</li><li><code>app/controller/article.js中对应的方法</code>↓↓↓</li><li><code>app/service/article.js中的方法</code> -end</li></ul> 
<p>回顾下，这样的流向的原因</p> 
<ul><li>app/router.js 用于配置 URL 路由规则</li><li>app/controller/** 用于解析用户的输入，处理后返回相应的结果</li><li>app/service/** 用于编写业务逻辑层</li></ul> 
<p>根据规则，我们可以先把 <strong>路由对应关系</strong> 在router.js中创建出来</p> 
<pre><code class="prism language-js"><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * @param {Egg.Application} app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> app <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/api/lists'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>article<span class="token punctuation">.</span>getList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/api/getArticle/:id'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>article<span class="token punctuation">.</span>getArticle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/create'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>article<span class="token punctuation">.</span>postItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/edit'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>article<span class="token punctuation">.</span>putItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/api/del'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>article<span class="token punctuation">.</span>deleteItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>搭架完骨架，接下来，我们就主要展示在controller层和service层做的事情了。把接口丰富起来。</strong></p> 
<pre><code class="prism language-js"><span class="token comment">// app/controller/article.js</span>
<span class="token comment">/*
 * @description:
 * @Author: ljc
 * @Date: 2020-10-21 14:46:48
 * @LastEditors: ljc
 * @LastEditTime: 2020-10-23 16:17:11
 */</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ArticleController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hi, egg'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token comment">//   在这里 增加相应的异步方法</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> ArticleController<span class="token punctuation">;</span>

</code></pre> 
<h4><a id="_582"></a>获取文章列表</h4> 
<blockquote> 
 <p>[get] /api/lists</p> 
</blockquote> 
<pre><code class="prism language-js"><span class="token comment">// app/controller/article.js</span>
<span class="token operator">...</span>
  <span class="token comment">// 查询列表</span>
  <span class="token keyword">async</span> <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> page<span class="token punctuation">,</span> pageSize <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>page <span class="token operator">||</span> <span class="token operator">!</span>pageSize<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">returnBody</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'缺少必要参数'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> lists <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      page<span class="token punctuation">,</span>
      pageSize<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">returnBody</span><span class="token punctuation">(</span>
      <span class="token number">200</span><span class="token punctuation">,</span>
      <span class="token string">'获取文章列表成功！'</span><span class="token punctuation">,</span>
      <span class="token punctuation">{<!-- --></span>
        count<span class="token punctuation">:</span> <span class="token punctuation">(</span>lists <span class="token operator">&amp;&amp;</span> lists<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
        results<span class="token punctuation">:</span> <span class="token punctuation">(</span>lists <span class="token operator">&amp;&amp;</span> lists<span class="token punctuation">.</span>rows<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span>
<span class="token comment">// app/service/article.js</span>
<span class="token operator">...</span>
  <span class="token keyword">async</span> <span class="token function">getList</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">findAndCountAll</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      order<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">'change_date'</span><span class="token punctuation">,</span> <span class="token string">'ASC'</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      offset<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>page<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
      limit<span class="token punctuation">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre> 
<h4><a id="_622"></a>获取文章详情</h4> 
<blockquote> 
 <p>[get] /api/getArticle/:id</p> 
</blockquote> 
<pre><code class="prism language-js"><span class="token comment">// app/controller/article.js</span>
<span class="token operator">...</span>
 <span class="token comment">// 查询单个文章</span>
  <span class="token keyword">async</span> <span class="token function">getArticle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> articleDetail <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">getArticle</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>articleDetail<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">returnBody</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'不存在此条数据！'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'00001'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">returnBody</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'获取文章成功！'</span><span class="token punctuation">,</span> articleDetail<span class="token punctuation">,</span> <span class="token string">'00000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span>
<span class="token comment">// app/service/article.js</span>
<span class="token operator">...</span>
<span class="token keyword">async</span> <span class="token function">getArticle</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      where<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span>

</code></pre> 
<h4><a id="_653"></a>添加文章</h4> 
<blockquote> 
 <p>[post] /api/create</p> 
</blockquote> 
<pre><code class="prism language-js"><span class="token comment">// app/controller/article.js</span>
<span class="token operator">...</span>
  <span class="token comment">// 添加文章</span>
  <span class="token keyword">async</span> <span class="token function">postItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> title<span class="token punctuation">,</span> logo<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> content <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token comment">// 新文章</span>
    <span class="token keyword">const</span> newArticle <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> title<span class="token punctuation">,</span> logo<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> content <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> article <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">addArticle</span><span class="token punctuation">(</span>newArticle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>article<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">returnBody</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'网络错误，请稍后再试！'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'00001'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ssss'</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">returnBody</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'新建文章成功!'</span><span class="token punctuation">,</span> article<span class="token punctuation">,</span> <span class="token string">'00000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span>
<span class="token comment">// app/service/article.js</span>
<span class="token operator">...</span>
  <span class="token keyword">async</span> <span class="token function">addArticle</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre> 
<h4><a id="_682"></a>编辑文章</h4> 
<blockquote> 
 <p>[post] /api/edit</p> 
</blockquote> 
<pre><code class="prism language-js"><span class="token comment">// app/controller/article.js</span>
<span class="token operator">...</span>
<span class="token comment">// 编辑文章</span>
  <span class="token keyword">async</span> <span class="token function">putItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> id<span class="token punctuation">,</span> title<span class="token punctuation">,</span> logo<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> content <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token comment">// 存在文章</span>
    <span class="token keyword">const</span> editArticle <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> id<span class="token punctuation">,</span> title<span class="token punctuation">,</span> logo<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> content <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> article <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">editArticle</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> editArticle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>article<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">returnBody</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'网络错误，请稍后再试！'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'00001'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>article<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">returnBody</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'文章不存在，请检查重试！'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'00001'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">returnBody</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'编辑文章成功!'</span><span class="token punctuation">,</span> article<span class="token punctuation">,</span> <span class="token string">'00000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span>
<span class="token comment">// app/service/article.js</span>
<span class="token operator">...</span>
  <span class="token keyword">async</span> <span class="token function">editArticle</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      where<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre> 
<h4><a id="_719"></a>删除文章</h4> 
<blockquote> 
 <p>[post] /api/del</p> 
</blockquote> 
<pre><code class="prism language-js"><span class="token comment">// app/controller/article.js</span>
<span class="token operator">...</span>
 <span class="token comment">// 删除文章</span>
  <span class="token keyword">async</span> <span class="token function">deleteItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> id <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">const</span> articleDetail <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>article<span class="token punctuation">.</span><span class="token function">deleteArticle</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>articleDetail<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">returnBody</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'不存在此条数据！'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'00001'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">returnBody</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'删除文章成功！'</span><span class="token punctuation">,</span> articleDetail<span class="token punctuation">,</span> <span class="token string">'00000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span>
<span class="token comment">// app/service/article.js</span>
<span class="token operator">...</span>
  <span class="token keyword">async</span> <span class="token function">deleteArticle</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      where<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        id<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre> 
<h4><a id="postMan_749"></a>使用postMan测试接口</h4> 
<p><em><strong>当表为空，不做任何操作时的状态</strong></em></p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-XFTkivBG-1603701814715)(/egg16.jpg)]</p> 
<h5><a id="1_754"></a>1.添加文章</h5> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-QsPNH3i3-1603701814716)(/egg17.jpg)]<br> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-re4sBlfh-1603701814716)(/egg18.jpg)]</p> 
<h5><a id="2_757"></a>2.修改文章</h5> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-EuZbgEci-1603701814717)(/egg19.jpg)]<br> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-psqvGXyJ-1603701814717)(/egg20.jpg)]</p> 
<h5><a id="3_760"></a>3.获取文章</h5> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-jB9JqK4H-1603701814718)(/egg21.jpg)]</p> 
<h5><a id="4_762"></a>4.删除文章</h5> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Asyx2ZNn-1603701814719)(/egg22.jpg)]<br> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-X6no7M3B-1603701814719)(/egg23.jpg)]</p> 
<h4><a id="_766"></a>使用单元测试</h4> 
<p>在编写测试之前，推荐阅读官方文档单元测试章节 <a href="https://eggjs.org/zh-cn/core/unittest.html" rel="nofollow">Egg单元测试</a> 了解相关知识。</p> 
<p>由于在前面的 egg 配置中，我们将单元测试环境和开发环境指向了不同的数据库，因此需要通过 Migrations 来初始化测试数据库的数据结构：</p> 
<pre><code class="prism language-js">npx sequelize<span class="token operator">-</span>cli db<span class="token punctuation">:</span>migrate <span class="token operator">--</span>env<span class="token operator">=</span>test
</code></pre> 
<p>有数据库访问的单元测试直接写起来会特别繁琐，特别是很多接口我们需要创建一系列的数据才能进行，造测试数据是一个非常繁琐的过程。为了简化单测，我们可以通过 factory-girl 模块来快速创建测试数据。</p> 
<ul><li>安装 factory-girl 依赖 <code>npm install --save-dev factory-girl</code></li><li>定义 factory-girl 的数据模型到 test/factories.js 中</li></ul> 
<pre><code class="prism language-js"><span class="token comment">// test/factories.js</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> factory <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'factory-girl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> app <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 可以通过 app.factory 访问 factory 实例</span>
  app<span class="token punctuation">.</span>factory <span class="token operator">=</span> factory<span class="token punctuation">;</span>

  <span class="token comment">// 定义 user 和默认数据</span>
  factory<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'article'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    title<span class="token punctuation">:</span> factory<span class="token punctuation">.</span><span class="token function">sequence</span><span class="token punctuation">(</span><span class="token string">'Article.'</span><span class="token punctuation">,</span> n <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`title_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>n<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    logo<span class="token punctuation">:</span> <span class="token string">'2233'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<ul><li>初始化文件 test/.setup.js，引入 factory，并确保测试执行完后清理数据，避免被影响。</li></ul> 
<blockquote> 
 <p>我们对测试单元执行顺序无特殊要求</p> 
</blockquote> 
<pre><code class="prism language-js"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"egg-mock/bootstrap"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> factories <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./factories"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">factories</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// clear database after each test case</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Article<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> truncate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> force<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>接下来我们就可以开始编写真正的测试用例了：【 <strong>覆盖我们的增删改查的接口</strong> 】</p> 
<pre><code class="prism language-js"><span class="token comment">// test/app/controller/article.test.js</span>
<span class="token comment">/*
 * @description:
 * @Author: ljc
 * @Date: 2020-10-26 10:41:48
 * @LastEditors: ljc
 * @LastEditTime: 2020-10-26 11:35:53
 */</span>
<span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> assert<span class="token punctuation">,</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg-mock/bootstrap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/app/controller/article.test.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'GET /api/getLists'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should work'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 通过 factory-girl 快速创建 user 对象到数据库中</span>
      <span class="token keyword">await</span> app<span class="token punctuation">.</span>factory<span class="token punctuation">.</span><span class="token function">createMany</span><span class="token punctuation">(</span><span class="token string">'article'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/api/getLists?page=1&amp;pageSize=10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>results<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>logo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'GET /api/getArticle/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should work'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> article <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">'article'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/getArticle/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>article<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>logo <span class="token operator">===</span> article<span class="token punctuation">.</span>dataValues<span class="token punctuation">.</span>logo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'POST /api/create'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should work'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      app<span class="token punctuation">.</span><span class="token function">mockCsrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/create'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        logo<span class="token punctuation">:</span> <span class="token string">'233333'</span><span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">'我是测试'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

      res <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/getArticle/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>title <span class="token operator">===</span> <span class="token string">'我是测试'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'POST /api/edit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should work'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      app<span class="token punctuation">.</span><span class="token function">mockCsrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/create'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        logo<span class="token punctuation">:</span> <span class="token string">'233333'</span><span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">'我是测试'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> resLast <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/edit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        id<span class="token punctuation">:</span> res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        logo<span class="token punctuation">:</span> <span class="token string">'233333'</span><span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">'我是修改过后的测试'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>resLast<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      res <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/getArticle/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>title <span class="token operator">===</span> <span class="token string">'我是修改过后的测试'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'DELETE /api/del?id='</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should work'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> article <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span>factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">'article'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      app<span class="token punctuation">.</span><span class="token function">mockCsrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/del?id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>article<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>最后，如果我们需要在 CI 中运行单元测试，需要确保在执行测试代码之前，执行一次 migrate 确保数据结构更新，例如我们在 <code>package.json</code> 中声明 <code>scripts.ci</code> 来在 CI 环境下执行单元测试：</p> 
<pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"scripts"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"ci"</span><span class="token punctuation">:</span> <span class="token string">"eslint . &amp;&amp; npx sequelize db:migrate --env=test &amp;&amp; egg-bin cov"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>通过命令<code>npm run cli</code>执行单元测试</li></ul> 
<blockquote> 
 <p>展示结果：</p> 
</blockquote> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-VD6xwbA8-1603701814720)(/test.gif)]</p> 
<blockquote> 
 <p>测试结果 概况</p> 
</blockquote> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-oo9ilLe2-1603701814721)(/egg24.jpg)]<br> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-kofrqp6B-1603701814721)(/egg25.jpg)]</p> 
<h3><a id="_912"></a>五、前端项目搭建</h3> 
<h4><a id="_913"></a>源码地址</h4> 
<p>前端项目源码地址：<a href="https://github.com/ledtwo/eggNews">山岚笔札</a></p> 
<p>可在线预览效果 <a href="http://news.epochy.cn" rel="nofollow">http://news.epochy.cn</a></p> 
<p><strong>山岚笔札 V1.0</strong></p> 
<blockquote> 
 <p>本项目demo为配合egg.js搭建的服务接口，链接mysql数据库测试CRUD使用，使用Vue开发，具备完整的增删改查功能。</p> 
</blockquote> 
<h4><a id="_921"></a>效果预览</h4> 
<p><strong>预览图</strong></p> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-lvosVRLm-1603701814722)(https://cdn.jsdelivr.net/gh/ledtwo/eggNews@1.0/src/assets/preview1.jpg “首页”)][外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-TP2Jr1da-1603701814722)(https://cdn.jsdelivr.net/gh/ledtwo/eggNews@1.0/src/assets/preview2.jpg “详情页”)]</p> 
<hr> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-oynVRGxQ-1603701814723)(https://cdn.jsdelivr.net/gh/ledtwo/eggNews@1.0/src/assets/preview3.jpg “左滑操作文章队列”)][外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-AF7vL0Di-1603701814724)(https://cdn.jsdelivr.net/gh/ledtwo/eggNews@1.0/src/assets/preview4.jpg “添加文章预览”)]</p> 
<h4><a id="_930"></a>项目结构</h4> 
<p><strong>前端项目文件结构</strong></p> 
<pre><code>dif-client
├─ .gitignore
├─ babel.config.js
├─ package-lock.json
├─ package.json
├─ public
│  ├─ favicon.ico
│  └─ index.html
├─ README.md
├─ src
│  ├─ App.vue
│  ├─ assets
│  │  ├─ bg1.jpg
│  │  ├─ bg2.jpg
│  │  ├─ bg3.jpg
│  │  ├─ logo.png
│  │  └─ twoP.jpg
│  ├─ common
│  │  └─ initHtmlEditor.js
│  ├─ components
│  │  └─ HelloWorld.vue
│  ├─ main.js
│  ├─ router
│  │  └─ index.js
│  └─ views
│     ├─ add.vue
│     ├─ details.vue
│     └─ home.vue
└─ vue.config.js

</code></pre> 
<h4><a id="_965"></a>使用方法</h4> 
<ul><li>克隆本仓库<a href="https://github.com/ledtwo/eggNews.git">https://github.com/ledtwo/eggNews.git</a>，<code>npm i</code> 安装所有依赖包</li><li>启动项目 npm run serve 就可以愉快的玩耍啦~</li></ul> 
<pre><code class="prism language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  lintOnSave<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  devServer<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    proxy<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"/"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//   下面这行替换成你的服务地址</span>
        target<span class="token punctuation">:</span> <span class="token string">"http://localhost:7001/"</span><span class="token punctuation">,</span>
        ws<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        changeOrigin<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  runtimeCompiler<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_987"></a>六、执行过程与运行环境</h3> 
<h4><a id="_988"></a>执行过程</h4> 
<p>当想继续深入探寻egg的机制时，我们可以先从最熟悉的request讲起</p> 
<blockquote> 
 <p>如下图：</p> 
</blockquote> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-ba7Kb4SB-1603701814725)(/eggServe.jpg)]</p> 
<p><strong>绿色虚线框起来的所有组件组成了一个Worker，<br> 这就是egg.js中实际执行代码逻辑的进程</strong><br><br> <em><strong>【即一个node服务器。】</strong></em></p> 
<ul><li><strong>request</strong>进来后，先穿过中间件，自己定义的中间件都放在<code>eggServerDir/app/middleware</code>下，并在<strong>config</strong>中启用。</li><li><strong>egg.js</strong>内置了<strong>egg-static</strong>中间件，将静态资源放在<code>eggServerDir/app/public</code>中，只会经过<strong>egg-static</strong>中间件之前的中间件，最后<strong>egg-static</strong>直接响应给客户端，不会到达其后的中间件以及<strong>Router</strong>。</li><li>如果不是<strong>public</strong>中的资源，将会穿越所有中间件，到达路由。一般所有的路由都放在<strong>router.js</strong>中，这个文件没有任何逻辑，而是直接指向一个处理请求的<strong>controller</strong>，只起到目录和索引的作用:</li></ul> 
<pre><code class="prism language-js">router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li><strong>Controller</strong>都放在<code>eggServerDir/app/controller</code>中，不含有具体的业务逻辑，<strong>业务逻辑都在Service中，Controller只负责调用并组合Service</strong>，最后将响应提交给客户端。</li><li><strong>Service</strong>放在<code>eggServerDir/app/service</code>中，负责调用Model，进行具体业务。</li><li>除此之外，<strong>Worker</strong>中还有定时任务，写在<code>eggServerDir/app/schedule</code>文件夹中。</li><li>各个部件的所有可操控行为，都可以在<code>eggServerDir/confg/</code>中的配置文件中定义，配置文件可以同时有很多份，<strong>default</strong>会被具体环境的配置文件中的同名字段覆盖，具体使用哪份配置，是根据使用场景来决定</li></ul> 
<p><strong>待续…</strong></p> 
<h4><a id="_1013"></a>运行环境</h4> 
<p><strong>EGG_SERVER_ENV</strong>这个环境变量的值。</p> 
<p>框架有两种方式指定运行环境：</p> 
<p>通过 <code>config/env</code> 文件指定，该文件的内容就是运行环境，如 <strong>prod</strong>。一般通过构建工具来生成这个文件。</p> 
<pre><code class="prism language-js"><span class="token comment">// config/env</span>
prod
</code></pre> 
<p>通过 <code>EGG_SERVER_ENV</code> 环境变量指定运行环境更加方便，比如在生产环境启动应用：</p> 
<pre><code class="prism language-js">npm start <span class="token constant">EGG_SERVER_ENV</span><span class="token operator">=</span>prod
</code></pre> 
<h3><a id="_1029"></a>七、扩展内置对象</h3> 
<blockquote> 
 <p>内置对象可以被方便地获取到，不过功能有限，我们可以通过egg.js的扩展(Extend)功能去进一步加强、定制框架的能力。<br> egg.js中有非常多新鲜的特性：“扩展”、“插件”、“多环境配置”，这些特性名称虽然不一样，但本质都是一样的：有则覆盖，无则增加。类似于lodash中的defaults函数，也类似于继承。<br> 因此，如果我们想扩展Application对象，根据egg.js规范，应该在projectDir/app/extend/下增加application.js：</p> 
</blockquote> 
<pre><code class="prism language-js"><span class="token comment">// app/extend/application.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  specialName<span class="token punctuation">:</span> <span class="token string">"ljc's app"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以后就可以方便地调用app.specialName获取这个值。</p> 
<p><strong>待续…</strong></p> 
<h3><a id="_1045"></a>九、中间件</h3> 
<p><strong>待续…</strong></p> 
<h3><a id="express_1048"></a>八、与express框架的中间件比较</h3> 
<p>其实中间件执行逻辑没有什么特别的不同，都是依赖函数调用栈的执行顺序，抬杠一点讲都可以叫做洋葱模型。</p> 
<ul><li> <p><strong>Koa</strong> 依靠 <code>async/await</code>让异步操作可以变成同步写法，更好理解。</p> </li><li> <p>最关键的不是这些中间的执行顺序，而是响应的时机。</p> </li><li> <p><strong>Express</strong> 使用 <code>res.end()</code> 是立即返回，这样想要做出些响应前的操作变得比较麻烦；</p> </li><li> <p>而 <strong>Koa</strong> 是在所有中间件中使用 <strong>ctx.body</strong> 设置响应数据，但是并不立即响应，而是在所有中间件执行结束后，再调用 <code>res.end(ctx.body)</code> 进行响应，这样就为响应前的操作预留了空间，所以是请求与响应都在最外层，中间件处理是一层层进行，所以被理解成 <strong>洋葱模型</strong>。<br> [外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-uDE2PYEW-1603701814725)(/atnsr-gzcrg.jpg)]</p> </li><li> <p>这个流程可以从源码 <code>compse(middlewares)</code> 后形成的函数执行处看到，这个合并的函数执行后有个 <code>.then((ctx) =&gt; { res.end(ctx.body) })</code> 的操作，我们也可以通过在不同中间件中都设置 <code>ctx.body</code>，会发现响应数据被一次次覆盖。</p> </li></ul> 
<p><em><strong>形成差异的核心就是请求的响应的时机不同</strong></em></p> 
<p>express是在调用res.send就结束响应了，而koa则是在中间件调用完成之后，在洋葱的最外层，由koa调用res.send方法。</p> 
<p><strong>待续…</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c0d913694d5df4112b51a08c1ce2f814/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PTA 列出叶结点 (25分)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1d4d0a3a64aa490962afb81f77834b2a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SQLITE语法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>