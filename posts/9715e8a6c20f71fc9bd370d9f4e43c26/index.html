<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RxJavaCallAdapterFactory默认实现异步调度 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="RxJavaCallAdapterFactory默认实现异步调度" />
<meta property="og:description" content="默认添加异步调度 重复的异步调度代码：
设计给Retrofit代理的Flowable 和 Observable的对象默认添加异步调度
Sevice.XXX()
.subscribeOn(Schedulers.io())
.observeOn(AndroidSchedulers.mainThread())
.subscribe();
根据RxJava2CallAdapterFactory的get方法返回一个CallAdapter的实现类RxJava2CallAdapter，其adapt 方法经过处理得到我们需要的可以操作的对象observable 或者Flowable等
源码分析 final class RxJava2CallAdapter&lt;R&gt; implements CallAdapter&lt;R, Object&gt; { @Override public Object adapt(Call&lt;R&gt; call) { Observable&lt;Response&lt;R&gt;&gt; responseObservable = isAsync ? new CallEnqueueObservable&lt;&gt;(call) : new CallExecuteObservable&lt;&gt;(call); Observable&lt;?&gt; observable; if (isResult) { observable = new ResultObservable&lt;&gt;(responseObservable); } else if (isBody) { observable = new BodyObservable&lt;&gt;(responseObservable); } else { observable = responseObservable; } if (scheduler != null) { observable = observable.subscribeOn(scheduler); } if (isFlowable) { return observable." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9715e8a6c20f71fc9bd370d9f4e43c26/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-20T10:48:28+08:00" />
<meta property="article:modified_time" content="2023-10-20T10:48:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RxJavaCallAdapterFactory默认实现异步调度</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4 id="%E8%AE%BE%E8%AE%A1%E9%BB%98%E8%AE%A4%E7%BB%99Retrofit%E4%BB%A3%E7%90%86%E7%9A%84Flowable%20%E5%92%8C%20Observable%E7%9A%84%E5%AF%B9%E8%B1%A1%E6%B7%BB%E5%8A%A0%E5%BC%82%E6%AD%A5%E8%B0%83%E5%BA%A6"><code class="language-html"><strong>默认添加异步调度</strong></code></h4> 
<hr> 
<blockquote> 
 <p><span style="color:#3d464d;">重复的</span>异步调度<span style="color:#3d464d;">代码：</span></p> 
 <p><code class="language-html"><strong>设计给Retrofit代理的Flowable 和 Observable的对象默认添加异步调度</strong></code></p> 
 <p>  Sevice.XXX()<br>          <strong><span style="color:#7c79e5;"><s><s>.su</s>bscribeOn(Schedulers.io())</s><br>          <s>.observeOn(AndroidSchedulers.mainThread())</s></span></strong><br>          .subscribe();</p> 
 <p>根据<code class="language-html"><span style="color:#7c79e5;"><strong>RxJava2CallAdapterFactory</strong></span>的<strong><span style="color:#7c79e5;">get</span></strong>方法返回一个</code><span style="color:#7c79e5;"><strong>CallAdapter</strong></span>的实现类<span style="color:#7c79e5;"><strong>RxJava2CallAdapter</strong></span>，其<span style="color:#7c79e5;"><strong>adapt </strong></span>方法经过处理得到我们需要的可以操作的对象<span style="color:#7c79e5;"><strong>observable </strong></span>或者<span style="color:#7c79e5;"><strong>Flowable</strong></span>等</p> 
</blockquote> 
<hr> 
<h4> 源码分析</h4> 
<pre class="has"><code class="language-java">final class RxJava2CallAdapter&lt;R&gt; implements CallAdapter&lt;R, Object&gt; {
 
  @Override public Object adapt(Call&lt;R&gt; call) {
    Observable&lt;Response&lt;R&gt;&gt; responseObservable = isAsync
        ? new CallEnqueueObservable&lt;&gt;(call)
        : new CallExecuteObservable&lt;&gt;(call);
    Observable&lt;?&gt; observable;
    if (isResult) {
      observable = new ResultObservable&lt;&gt;(responseObservable);
    } else if (isBody) {
      observable = new BodyObservable&lt;&gt;(responseObservable);
    } else {
      observable = responseObservable;
    }
    if (scheduler != null) {
      observable = observable.subscribeOn(scheduler);
    }
    if (isFlowable) {
      return observable.toFlowable(BackpressureStrategy.LATEST);
    }
     //省略...
    return observable;
  }
}
</code></pre> 
<h4><strong><code class="language-html">自定义CallAdapter.Factory实现委托RxJava2CallAdapterFactory对象实现添加</code></strong>异步调度<strong><code class="language-html">:</code> </strong></h4> 
<hr> 
<pre class="has"><code class="language-java">
public final class ArnoldRxJava2CallAdapterFactory extends CallAdapter.Factory {

    private CallAdapter.Factory mFactory;

    public static ArnoldRxJava2CallAdapterFactory create() {
        return new ArnoldRxJava2CallAdapterFactory();
    }
    private ArnoldRxJava2CallAdapterFactory() {
        mFactory = RxJava2CallAdapterFactory.create();
    }
    @Override
    public CallAdapter&lt;?, ?&gt; get(@NonNull Type returnType, @NonNull Annotation[] annotations, @NonNull Retrofit retrofit) {
        final CallAdapter&lt;?, ?&gt; callAdapter = mFactory.get(returnType, annotations, retrofit);

        Class&lt;?&gt; rawType = getRawType(returnType);

        boolean isFlowable = rawType == Flowable.class;
        boolean isObservable = rawType == Observable.class;

        if (null == callAdapter) {
            return null;
        }
        //生产不同的CallAdapter
        if (isObservable) {
            return CallAdapterFactory.create((CallAdapter&lt;Observable&lt;?&gt;, Observable&lt;?&gt;&gt;) callAdapter, f -&gt; f.subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()));
        }
        if (isFlowable) {
            return CallAdapterFactory.create((CallAdapter&lt;Flowable&lt;?&gt;, Flowable&lt;?&gt;&gt;) callAdapter, f -&gt; f.subscribeOn(Schedulers.io()).observeOn(AndroidSchedulers.mainThread()));
        }
        //省略...
        return callAdapter;
    }
}</code></pre> 
<h4>创建CallAdapterFactory工厂类</h4> 
<pre class="has"><code class="language-java">public class CallAdapterFactory&lt;R, W&gt; implements CallAdapter&lt;R, W&gt; {

    public static &lt;R, W&gt; CallAdapterFactory&lt;R, W&gt; create(CallAdapter&lt;R, W&gt; mAdapter, Function&lt;W, W&gt; mFunction) {
        return new CallAdapterFactory&lt;R, W&gt;(mAdapter, mFunction);
    }
    private CallAdapterFactory(CallAdapter&lt;R, W&gt; mAdapter, Function&lt;W, W&gt; mFunction) {
        this.mAdapter = mAdapter;
        this.mFunction = mFunction;
    }
    private CallAdapter&lt;R, W&gt; mAdapter;

    private Function&lt;W, W&gt; mFunction;

    @Override
    public Type responseType() {
        return mAdapter.responseType();
    }
    @Override
    public W adapt(Call&lt;R&gt; call) {
        W adapt = mAdapter.adapt(call);
        if (mFunction == null) {
            return adapt;
        }
        try {
            adapt = mFunction.apply(mAdapter.adapt(call));
        } catch (Exception e) {
            e.printStackTrace();
        }
        return adapt;
    }
}</code></pre> 
<h4>调用示例</h4> 
<pre class="has"><code class="language-java">        T service= new Retrofit.Builder()
                .client(OkHttpClient client)
                .addConverterFactory(ArnoldGsonConverterFactory.create())
                .addCallAdapterFactory(ArnoldRxJava2CallAdapterFactory .create())
                .baseUrl(BASE_HTTP_URL)
                .build()
                .create(Class&lt;T&gt; service);</code></pre> 
<p></p> 
<blockquote> 
 <p>在创建Retrofit时添加自定义RxJava2CallAdapterFactory，使用时不再需要添加异步调度代码： sevice.XXX().subscribe();</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d26a4bb8aab812eb81211a72f917d7bc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">为什么trim出来的aaa与字符串aaa不双等</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f2478b0891711daef9f505f9056c11ad/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ERR_PNPM_LINKING_FAILED Error: EPERM: operation not permitted, rename</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>