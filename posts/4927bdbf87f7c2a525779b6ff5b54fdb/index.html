<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mbedtls学习2.mbedtls从0使用指南 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mbedtls学习2.mbedtls从0使用指南" />
<meta property="og:description" content="1.使用指南 这里主要介绍 mbedtls 程序的基本使用流程，并针对使用过程中经常涉及到的结构体和重要 API 进行简要说明。
mbedtls 的基本工作流程如下所示：
初始化 SSL/TLS 上下文建立 SSL/TLS 握手发送、接收数据交互完成，关闭连接 menuconfig 配置说明 获取 mbedtls 软件包或者修改用户配置都需要使用 menuconfig。需要用户打开 ENV 工具，并将目录切换到您所用的 BSP 目录，使用 menuconfig 命令打开配置界面。
在 RT-Thread online packages → security packages 中选择 mbedtls 软件包，操作界面如下图所示：
详细的配置介绍如下所示：
RT-Thread online packages ---&gt; security packages ---&gt; Select Root Certificate ---&gt; # 选择证书文件 [*] mbedtls: An portable and flexible SSL/TLS library # 打开 mbedtls 软件包 [*] Store the AES tables in ROM # 将 AES 表存储在 ROM 中 (2) Maximum window size used # 用于点乘的最大“窗口”大小（2-7） (3584) Maxium fragment length in bytes # 配置数据帧大小 [*] Enable a mbedtls client example # 开启 mbedtls 测试例程 [ ] Enable Debug log output # 开启调试 log 输出 version (latest) ---&gt; # 选择软件包版本，默认为最新版本 Using all default CA 配置选项会将 certs/default 目录下的所有预置证书加入编译，将占用很大的内存Using user CA 配置选项允许用户将自己需要的证书文件加入编译，需要用户将证书文件拷贝到 certs 根目录 选择合适的配置项后，使用 pkgs --update 命令下载软件包并更新用户配置。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4927bdbf87f7c2a525779b6ff5b54fdb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-26T14:07:34+08:00" />
<meta property="article:modified_time" content="2020-05-26T14:07:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mbedtls学习2.mbedtls从0使用指南</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_0"></a>1.使用指南</h2> 
<p>这里主要介绍 mbedtls 程序的基本使用流程，并针对使用过程中经常涉及到的结构体和重要 API 进行简要说明。</p> 
<p>mbedtls 的基本工作流程如下所示：</p> 
<ul><li>初始化 SSL/TLS 上下文</li><li>建立 SSL/TLS 握手</li><li>发送、接收数据</li><li>交互完成，关闭连接</li></ul> 
<h3><a id="menuconfig__11"></a>menuconfig 配置说明</h3> 
<p>获取 mbedtls 软件包或者修改用户配置都需要使用 <code>menuconfig</code>。需要用户打开 ENV 工具，并将目录切换到您所用的 BSP 目录，使用 <code>menuconfig</code> 命令打开配置界面。</p> 
<p>在 <code>RT-Thread online packages → security packages</code> 中选择 <strong>mbedtls</strong> 软件包，操作界面如下图所示：</p> 
<p><img src="https://images2.imgbox.com/83/a8/bgkFj778_o.png" alt="在这里插入图片描述"></p> 
<p>详细的配置介绍如下所示：</p> 
<pre><code class="prism language-c">RT<span class="token operator">-</span>Thread online packages <span class="token operator">--</span><span class="token operator">-&gt;</span>
  security packages  <span class="token operator">--</span><span class="token operator">-&gt;</span>
        Select Root Certificate  <span class="token operator">--</span><span class="token operator">-&gt;</span>      # 选择证书文件
    <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> mbedtls<span class="token punctuation">:</span> An portable and flexible SSL<span class="token operator">/</span>TLS library # 打开 mbedtls 软件包
    <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>   Store the AES tables in ROM      # 将 AES 表存储在 ROM 中
    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>   Maximum window size used         # 用于点乘的最大“窗口”大小（<span class="token number">2</span><span class="token operator">-</span><span class="token number">7</span>）
    <span class="token punctuation">(</span><span class="token number">3584</span><span class="token punctuation">)</span> Maxium fragment length in bytes # 配置数据帧大小
    <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>   Enable a mbedtls client example  # 开启 mbedtls 测试例程
    <span class="token punctuation">[</span> <span class="token punctuation">]</span>   Enable Debug log output          # 开启调试 log 输出
          version <span class="token punctuation">(</span>latest<span class="token punctuation">)</span>  <span class="token operator">--</span><span class="token operator">-&gt;</span>           # 选择软件包版本，默认为最新版本
</code></pre> 
<ul><li><code>Using all default CA</code> 配置选项会将 <code>certs/default</code> 目录下的所有预置证书加入编译，将占用很大的内存</li><li><code>Using user CA</code> 配置选项允许用户将自己需要的证书文件加入编译，需要用户将证书文件拷贝到 <code>certs</code> 根目录</li></ul> 
<p>选择合适的配置项后，使用 <code>pkgs --update</code> 命令下载软件包并更新用户配置。</p> 
<h3><a id="_39"></a>功能配置说明</h3> 
<blockquote> 
 <p>mbedtls 功能模块的开启与关闭定义在 mbedtls/config.h 和 ports/inc/tls_config.h 文件中</p> 
</blockquote> 
<p><code>mbedtls/config.h</code> 是 mbedtls 源码里提供的配置文件，<code>ports/inc/tls_config.h</code> 是 RT-Thread 基于 mbedtls 源码中的配置文件进行的裁剪和适配。</p> 
<p>最终，用户使用的是 RT-Thread 提供的配置文件 <strong><code>ports/inc/tls_config.h</code></strong>。</p> 
<p>用户可以通过文件中的宏来使能或失能部分不需要使用的功能模块，从而将 mbedtls 配置到合适的尺寸。</p> 
<h3><a id="_49"></a>证书配置说明</h3> 
<ul><li>预置的 CA 证书文件存放在 <code>certs/default</code> 目录中</li><li>用户增加的 CA 证书文件存放在 <code>certs</code> 根目录中</li></ul> 
<p><code>certs/default</code> 目录中已经包含了大多数 CA 根证书，如果您使用的根证书不在该文件夹内，需要用户将自己的 <strong>PEM 格式</strong>的 CA 证书拷贝 <code>certs</code> 根目录下。（仅支持 <strong>PEM 格式</strong>证书，不支持 <strong>DER 格式</strong>证书）。</p> 
<p>该证书文件中已经包含了大多数 CA 根证书，，参考后边的 <strong><code>添加新证书</code></strong> 章节。</p> 
<h3><a id="_TLS__58"></a>初始化 TLS 会话</h3> 
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> MbedTLSSession
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span><span class="token operator">*</span> host<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> port<span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">;</span>               <span class="token comment">// 公用数据缓冲区</span>
    size_t buffer_len<span class="token punctuation">;</span>                   <span class="token comment">// 缓冲区大小</span>

    mbedtls_ssl_context ssl<span class="token punctuation">;</span>             <span class="token comment">// 保存 ssl 基本数据</span>
    mbedtls_ssl_config conf<span class="token punctuation">;</span>             <span class="token comment">// 保存 ssl 配置信息</span>
    mbedtls_entropy_context entropy<span class="token punctuation">;</span>     <span class="token comment">// 保存 ssl 熵配置</span>
    mbedtls_ctr_drbg_context ctr_drbg<span class="token punctuation">;</span>   <span class="token comment">// 保存随机字节发生器配置</span>
    mbedtls_net_context server_fd<span class="token punctuation">;</span>       <span class="token comment">// 保存文件描述符</span>
    mbedtls_x509_crt cacert<span class="token punctuation">;</span>             <span class="token comment">// 保存认证信息</span>
<span class="token punctuation">}</span> MbedTLSSession<span class="token punctuation">;</span>
</code></pre> 
<p><code>MbedTLSSession</code> 用于保存建立 TLS 会话连接时的配置信息，在 TLS 上下文中传递使用。用户在使用建立 TLS 会话前，必须定义一个存储会话内容的结构体，如下所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> MbedTLSSession <span class="token operator">*</span>tls_session <span class="token operator">=</span> RT_NULL<span class="token punctuation">;</span>
tls_session <span class="token operator">=</span> <span class="token punctuation">(</span>MbedTLSSession <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>MbedTLSSession<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tls_session<span class="token operator">-&gt;</span>host <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>MBEDTLS_WEB_SERVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
tls_session<span class="token operator">-&gt;</span>port <span class="token operator">=</span> <span class="token function">strdup</span><span class="token punctuation">(</span>MBEDTLS_WEB_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
tls_session<span class="token operator">-&gt;</span>buffer_len <span class="token operator">=</span> MBEDTLS_READ_BUFFER<span class="token punctuation">;</span>
tls_session<span class="token operator">-&gt;</span>buffer <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>tls_session<span class="token operator">-&gt;</span>buffer_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里需要设置 SSL/TLS 服务器的 host 和 port，以及数据接收 buffer 等配置。</p> 
<h3><a id="_SSLTLS__92"></a>初始化 SSL/TLS 客户端</h3> 
<p>应用程序使用 <code>mbedtls_client_init</code> 函数初始化 TLS 客户端。</p> 
<p>初始化阶段按照 API 参数定义传入相关参数即可，主要用来初始化网络接口、证书、SSL 会话配置等 SSL 交互必须的一些配置，以及设置相关的回调函数。</p> 
<p>示例代码如下所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">char</span> <span class="token operator">*</span>pers <span class="token operator">=</span> <span class="token string">"hello_world"</span><span class="token punctuation">;</span> <span class="token comment">// 设置随机字符串种子</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">mbedtls_client_init</span><span class="token punctuation">(</span>tls_session<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>pers<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">rt_kprintf</span><span class="token punctuation">(</span><span class="token string">"MbedTLSClientInit err return : -0x%x\n"</span><span class="token punctuation">,</span> <span class="token operator">-</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> __exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>实际调用的 mbedtls 库函数如下所示：</p> 
<h3><a id="_SSLTLS__111"></a>初始化 SSL/TLS 客户端上下文</h3> 
<p>应用程序使用 <code>mbedtls_client_context</code> 函数配置客户端上下文信息，包括证书解析、设置主机名、设置默认 SSL 配置、设置认证模式（默认 MBEDTLS_SSL_VERIFY_OPTIONAL）等。</p> 
<p>示例代码如下所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">mbedtls_client_context</span><span class="token punctuation">(</span>tls_session<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">rt_kprintf</span><span class="token punctuation">(</span><span class="token string">"MbedTLSCLlientContext err return : -0x%x\n"</span><span class="token punctuation">,</span> <span class="token operator">-</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> __exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_SSLTLS__125"></a>建立 SSL/TLS 连接</h3> 
<p>使用 <code>mbedtls_client_connect</code> 函数为 SSL/TLS 连接建立通道。这里包含整个的握手连接过程，以及证书校验结果。</p> 
<p>示例代码如下所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">mbedtls_client_connect</span><span class="token punctuation">(</span>tls_session<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">rt_kprintf</span><span class="token punctuation">(</span><span class="token string">"MbedTLSCLlientConnect err return : -0x%x\n"</span><span class="token punctuation">,</span> <span class="token operator">-</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> __exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_139"></a>读写数据</h3> 
<p><strong>向 SSL/TLS 中写入数据</strong></p> 
<p>示例代码如下所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>REQUEST <span class="token operator">=</span> <span class="token string">"GET https://www.howsmyssl.com/a/check HTTP/1.0\r\n"</span>
    <span class="token string">"Host: www.howsmyssl.com\r\n"</span>
    <span class="token string">"User-Agent: rtthread/3.1 rtt\r\n"</span>
    <span class="token string">"\r\n"</span><span class="token punctuation">;</span>

<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">mbedtls_client_write</span><span class="token punctuation">(</span>tls_session<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>REQUEST<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>REQUEST<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> MBEDTLS_ERR_SSL_WANT_READ <span class="token operator">&amp;&amp;</span> ret <span class="token operator">!=</span> MBEDTLS_ERR_SSL_WANT_WRITE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">rt_kprintf</span><span class="token punctuation">(</span><span class="token string">"mbedtls_ssl_write returned -0x%x\n"</span><span class="token punctuation">,</span> <span class="token operator">-</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> __exit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>从 SSL/TLS 中读取数据</strong></p> 
<p>示例代码如下所示：</p> 
<pre><code class="prism language-c"><span class="token function">memset</span><span class="token punctuation">(</span>tls_session<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> tls_session<span class="token operator">-&gt;</span>buffer_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
ret <span class="token operator">=</span> <span class="token function">mbedtls_client_read</span><span class="token punctuation">(</span>tls_session<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tls_session<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> MBEDTLS_ERR_SSL_WANT_READ <span class="token operator">||</span> ret <span class="token operator">==</span>MBEDTLS_ERR_SSL_WANT_WRITE<span class="token punctuation">)</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> MBEDTLS_ERR_SSL_PEER_CLOSE_NOTIFY<span class="token punctuation">)</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">rt_kprintf</span><span class="token punctuation">(</span><span class="token string">"mbedtls_ssl_read returned -0x%x\n"</span><span class="token punctuation">,</span> <span class="token operator">-</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">rt_kprintf</span><span class="token punctuation">(</span><span class="token string">"connection closed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注意，如果读写接口返回了一个错误，必须关闭连接。</p> 
<h3><a id="_SSLTLS__187"></a>关闭 SSL/TLS 客户端连接</h3> 
<p>客户端主动关闭连接或者因为异常错误关闭连接，都需要使用 <code>mbedtls_client_close</code> 关闭连接并释放资源。</p> 
<p>示例代码如下所示：</p> 
<pre><code class="prism language-c"><span class="token function">mbedtls_client_close</span><span class="token punctuation">(</span>tls_session<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h3><a id="mbedtls__198"></a>mbedtls 使用范式</h3> 
<p>参考示例程序 <code>samples/tls_app_test.c</code>。</p> 
<h3><a id="_202"></a>添加新证书</h3> 
<p>CA 证书有两种常用格式 <strong>PEM 格式</strong> 和 <strong>DER</strong> 格式，目前 RT-Thread mbedtls 仅支持 <strong>PEM 格式</strong> 的证书文件。</p> 
<ul><li> <p><code>PEM 格式证书</code></p> <p><strong>PEM 格式证书</strong> 通常是以 <strong>.pem</strong> 和 <strong>.cer</strong> 后缀名结尾的文件。</p> <p>使用文本编辑器打开后，文件内容以 <code>-----BEGIN CERTIFICATE-----</code> 开头，以 <code>-----END CERTIFICATE-----</code> 结尾。</p> </li><li> <p><code>DER 格式证书</code></p> <p><strong>DER 格式证书</strong> 是二进制文件类型。</p> </li></ul> 
<h4><a id="_216"></a>根证书样式</h4> 
<p>双击 <strong>.cer</strong> 后缀名结尾的 CA 文件（Windows系统）可以看到证书的签发机构和有效期，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/59/b8/vE7RCnEy_o.png" alt="在这里插入图片描述"></p> 
<p><strong>PEM 格式</strong> 格式的证书文件内容内容样式如下所示：</p> 
<pre><code>-----BEGIN CERTIFICATE-----
MIIDdTCCAl2gAwIBAgILBAAAAAABFUtaw5QwDQYJKoZIhvcNAQEFBQAwVzELMAkG
A1UEBhMCQkUxGTAXBgNVBAoTEEdsb2JhbFNpZ24gbnYtc2ExEDAOBgNVBAsTB1Jv
b3QgQ0ExGzAZBgNVBAMTEkdsb2JhbFNpZ24gUm9vdCBDQTAeFw05ODA5MDExMjAw
MDBaFw0yODAxMjgxMjAwMDBaMFcxCzAJBgNVBAYTAkJFMRkwFwYDVQQKExBHbG9i
YWxTaWduIG52LXNhMRAwDgYDVQQLEwdSb290IENBMRswGQYDVQQDExJHbG9iYWxT
aWduIFJvb3QgQ0EwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDaDuaZ
jc6j40+Kfvvxi4Mla+pIH/EqsLmVEQS98GPR4mdmzxzdzxtIK+6NiY6arymAZavp
xy0Sy6scTHAHoT0KMM0VjU/43dSMUBUc71DuxC73/OlS8pF94G3VNTCOXkNz8kHp
1Wrjsok6Vjk4bwY8iGlbKk3Fp1S4bInMm/k8yuX9ifUSPJJ4ltbcdG6TRGHRjcdG
snUOhugZitVtbNV4FpWi6cgKOOvyJBNPc1STE4U6G7weNLWLBYy5d4ux2x8gkasJ
U26Qzns3dLlwR5EiUWMWea6xrkEmCMgZK9FGqkjWZCrXgzT/LCrBbBlDSgeF59N8
9iFo7+ryUp9/k5DPAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMBAf8E
BTADAQH/MB0GA1UdDgQWBBRge2YaRQ2XyolQL30EzTSo//z9SzANBgkqhkiG9w0B
AQUFAAOCAQEA1nPnfE920I2/7LqivjTFKDK1fPxsnCwrvQmeU79rXqoRSLblCKOz
yj1hTdNGCbM+w6DjY1Ub8rrvrTnhQ7k4o+YviiY776BQVvnGCv04zcQLcFGUl5gE
38NflNUVyRRBnMRddWQVDf9VMOyGj/8N7yy5Y0b2qvzfvGn9LhJIZJrglfCm7ymP
AbEVtQwdpf5pLGkkeB6zpxxxYu7KyJesF12KwvhHhm4qxFYxldBniYUr+WymXUad
DKqC5JlR3XC321Y9YeRq4VzW9v493kHMB65jUr9TU/Qr6cf9tveCX4XSQRjbgbME
HMUfpIBvFSDJ3gyICh3WZlXi/EjJKSZp4A==
-----END CERTIFICATE-----

</code></pre> 
<h4><a id="_249"></a>获取根证书</h4> 
<ul><li> <p>直接向服务商索取</p> <p>向服务商索取 <strong><code>base64 编码 X.509</code></strong> 编码的 <strong>PEM 格式</strong> 证书文件。</p> </li><li> <p>从服务商网站导出</p> 
  <ul><li> <p>浏览器打开服务商网站，以 <code>https://www.rt-thread.org/</code> 为例</p> </li><li> <p>点击浏览器地址栏的 <strong><code>安全</code></strong>，然后点击证书<br> <img src="https://images2.imgbox.com/50/4a/Q2AEE9Rg_o.png" alt="在这里插入图片描述"></p> </li><li> <p>查看证书详细信息<br> <img src="https://images2.imgbox.com/b5/5a/7evnHdAe_o.png" alt="在这里插入图片描述"></p> </li><li> <p>根证书导出向导<br> <img src="https://images2.imgbox.com/0c/16/8q4WDjXQ_o.png" alt="在这里插入图片描述"></p> </li><li> <p>选择导出 Base64 编码证书<br> <img src="https://images2.imgbox.com/d5/0b/Cim8ubFU_o.png" alt="在这里插入图片描述"></p> </li><li> <p>选择证书存储位置<br> <img src="https://images2.imgbox.com/0c/73/JvMUYhin_o.png" alt="在这里插入图片描述"></p> </li><li> <p>完成证书文件导出<br> <img src="https://images2.imgbox.com/51/17/AoZ3YwgJ_o.png" alt="在这里插入图片描述"><br> 完成证书导出，假设证书文件名为 <strong>USER_ROOT_CA.cer</strong>。</p> </li></ul> </li></ul> 
<h4><a id="_274"></a>导入证书</h4> 
<ul><li>使用文本编辑器打开上个步骤导出的根证书文件 <strong>USER_ROOT_CA.cer</strong></li><li>拷贝 <strong>USER_ROOT_CA.cer</strong> 文件到 <code>certs</code> 根目录</li><li>使用 <code>scons</code> 命令重新编译</li></ul> 
<p><strong>注：</strong></p> 
<p><code>scons</code> 命令编译后，会自动将证书文件拷贝到 <code>const char mbedtls_root_certificate[]</code> 数组中。</p> 
<h2><a id="2_284"></a>2.工作原理</h2> 
<p>mbedtls** 软件包是对 SSL/TLS 协议的实现。SSL（安全套接层）和 TLS（传输安全层）均是为了保证传输过程中信息的安全，是在明文传输基础上进行的加密，然后以密文的形式传输数据。</p> 
<p>mbedTLS 建立安全通信连接需要经过以下几个步骤：</p> 
<ul><li>初始化 SSL/TLS 上下文</li><li>建立 SSL/TLS 握手</li><li>发送、接收数据</li><li>交互完成，关闭连接</li></ul> 
<p>其中，最关键的步骤就是 <strong>SSL/TLS 握手</strong> 连接的建立，这里需要进行证书校验。<br> SSL/TLS 握手流程<br> <img src="https://images2.imgbox.com/6f/07/VeFriLzV_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="DTLS__297"></a>DTLS 握手流程</h3> 
<p>为了避免拒绝服务攻击，DTLS采用和IKE一样的无状态 cookie 技术。当客户端发送 client hello 消息后，服务器发送 HelloVerifyRequest 消息，这个消息包含了无状态 cookie。客户端收到之后必须重传添加上了 cookie 的 clienthello。</p> 
<p>DTLS 握手流程如下图所示：<br> <img src="https://images2.imgbox.com/ed/c3/7hBj5hQB_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3_304"></a>3.示例程序</h2> 
<p>该示例程序提供了一个简单的 TLS client，与测试网站建立 TLS 连接并获取加密数据。</p> 
<p>示例文件</p> 
<p>示例程序路径 说明<br> samples/tls_app_test.c TLS 测试例程<br> 例程工作流程<br> 本例程使用了 RT-Thread 官方 TLS 测试网站 www.rt-thread.org，使用 mbedtls_client_write 函数发送 HTTP 测试请求，成功后，该网站会返回文本数据，测试例程将解析后的数据输出到控制台。</p> 
<p>例程使用的 HTTP 请求数据如下所示￼</p> 
<pre><code class="prism language-c"><span class="token string">"GET /download/rt-thread.txt HTTP/1.0\r\n"</span>
<span class="token string">"Host: www.rt-thread.org\r\n"</span>
<span class="token string">"User-Agent: rtthread/3.1 rtt\r\n"</span>
<span class="token string">"\r\n"</span><span class="token punctuation">;</span>
</code></pre> 
<p>mbedTLS 测试例程的基本工作流程如下所示</p> 
<p>client连接测试网站 www.rt-thread.org</p> 
<p>client 和 server 握手成功</p> 
<p>client 发送请求</p> 
<p>server 回应请求</p> 
<p>TLS 测试成功/失败</p> 
<h4><a id="_335"></a>同步设备时间</h4> 
<p>SSL/TLS 服务器进行证书校验的过程中，会对当前发起校验请求的时间进行认证，如果时间不满足服务器的要求，就会校验证书失败。因此，我们需要为设备同步本地时间。</p> 
<ul><li> <p>方式一： 使用 <strong><code>date</code></strong> 命令</p> <p>未同步过时间的设备输入 <strong><code>date</code></strong> 命令后如下所示：</p> </li></ul> 
<pre><code class="prism language-c">msh <span class="token operator">/</span><span class="token operator">&gt;</span>date
Thu Jan  <span class="token number">1</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">06</span> <span class="token number">1970</span>
</code></pre> 
<p>使用 <strong><code>date</code></strong> 设置当前时间，如下所示：</p> 
<pre><code class="prism language-c">msh <span class="token operator">/</span><span class="token operator">&gt;</span>date <span class="token number">2018</span> <span class="token number">08</span> <span class="token number">02</span> <span class="token number">12</span> <span class="token number">23</span> <span class="token number">00</span>
msh <span class="token operator">/</span><span class="token operator">&gt;</span>date
Thu Aug  <span class="token number">2</span> <span class="token number">12</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">:</span><span class="token number">01</span> <span class="token number">2018</span>
msh <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre> 
<ul><li> <p>方式二： 使用 NTP 同步网络时间</p> <p>该方式需要依赖 NTP 工具包，使用 <code>menuconfig</code> 配置获取，如下所示：</p> </li></ul> 
<pre><code class="prism language-c">RT<span class="token operator">-</span>Thread online packages <span class="token operator">--</span><span class="token operator">-&gt;</span>
    IoT <span class="token operator">-</span> internet of things  <span class="token operator">--</span><span class="token operator">-&gt;</span>
        <span class="token operator">-</span><span class="token operator">*</span><span class="token operator">-</span> netutils<span class="token punctuation">:</span> Networking utilities <span class="token keyword">for</span> RT<span class="token operator">-</span>Thread  <span class="token operator">--</span><span class="token operator">-&gt;</span>
            <span class="token operator">-</span><span class="token operator">*</span><span class="token operator">-</span>   Enable <span class="token function">NTP</span><span class="token punctuation">(</span>Network Time Protocol<span class="token punctuation">)</span> client
            <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>     Timezone <span class="token keyword">for</span> calculate local time
            <span class="token punctuation">(</span>cn<span class="token punctuation">.</span>ntp<span class="token punctuation">.</span>org<span class="token punctuation">.</span>cn<span class="token punctuation">)</span> NTP server name
</code></pre> 
<p>使用命令 <strong><code>ntp_sync</code></strong> 同步网络时间</p> 
<pre><code class="prism language-c">msh <span class="token operator">/</span><span class="token operator">&gt;</span>ntp_sync
Get local time from NTP server<span class="token punctuation">:</span> Thu Aug  <span class="token number">2</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">30</span> <span class="token number">2018</span>
The system time is updated<span class="token punctuation">.</span> Timezone is <span class="token number">8.</span>
msh <span class="token operator">/</span><span class="token operator">&gt;</span>date
Thu Aug  <span class="token number">2</span> <span class="token number">14</span><span class="token punctuation">:</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">34</span> <span class="token number">2018</span>
</code></pre> 
<h3><a id="_379"></a>启动例程</h3> 
<p>在 MSH 中使用命令 <strong><code>tls_test</code></strong> 执行示例程序，成功建立 TLS 连接后，设备会从服务器拿到一组密码套件，设备 log 如下所示：</p> 
<pre><code class="prism language-c">msh <span class="token operator">/</span><span class="token operator">&gt;</span>tls_test
MbedTLS test sample<span class="token operator">!</span>
Memory usage before the handshake connection is established<span class="token punctuation">:</span>
total memory<span class="token punctuation">:</span> <span class="token number">33554408</span>
used memory <span class="token punctuation">:</span> <span class="token number">20968</span>
maximum allocated memory<span class="token punctuation">:</span> <span class="token number">20968</span>
Start handshake tick<span class="token punctuation">:</span><span class="token number">3313</span>
<span class="token punctuation">[</span>tls<span class="token punctuation">]</span>mbedtls client <span class="token keyword">struct</span> init success<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>tls<span class="token punctuation">]</span>Loading the CA root certificate success<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>tls<span class="token punctuation">]</span>mbedtls client context init success<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
msh <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>tls<span class="token punctuation">]</span>Connected www<span class="token punctuation">.</span>rt<span class="token operator">-</span>thread<span class="token punctuation">.</span>org<span class="token punctuation">:</span><span class="token number">443</span> success<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>tls<span class="token punctuation">]</span>Certificate verified success<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Finish handshake tick<span class="token punctuation">:</span><span class="token number">6592</span>
MbedTLS connect success<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Memory usage after the handshake connection is established<span class="token punctuation">:</span>
total memory<span class="token punctuation">:</span> <span class="token number">33554408</span>
used memory <span class="token punctuation">:</span> <span class="token number">45480</span>
maximum allocated memory<span class="token punctuation">:</span> <span class="token number">50808</span>
Writing HTTP request success<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Getting HTTP response<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
HTTP<span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span> OK
Server<span class="token punctuation">:</span> nginx<span class="token operator">/</span><span class="token number">1.10</span><span class="token number">.3</span> <span class="token punctuation">(</span>Ubuntu<span class="token punctuation">)</span>
Date<span class="token punctuation">:</span> Fri<span class="token punctuation">,</span> <span class="token number">31</span> Aug <span class="token number">2018</span> <span class="token number">08</span><span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">24</span> GMT
Content<span class="token operator">-</span>Type<span class="token punctuation">:</span> text<span class="token operator">/</span>plain
Content<span class="token operator">-</span>Length<span class="token punctuation">:</span> <span class="token number">267</span>
Last<span class="token operator">-</span>Modified<span class="token punctuation">:</span> Sat<span class="token punctuation">,</span> <span class="token number">04</span> Aug <span class="token number">2018</span> <span class="token number">02</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">:</span><span class="token number">51</span> GMT
Connection<span class="token punctuation">:</span> keep<span class="token operator">-</span>alive
ETag<span class="token punctuation">:</span> <span class="token string">"5b650c1b-10b"</span>
Strict<span class="token operator">-</span>Transport<span class="token operator">-</span>Security<span class="token punctuation">:</span> max<span class="token operator">-</span>age<span class="token operator">=</span><span class="token number">1800</span><span class="token punctuation">;</span> includeSubdomains<span class="token punctuation">;</span> preload
Accept<span class="token operator">-</span>Ranges<span class="token punctuation">:</span> bytes

RT<span class="token operator">-</span>Thread is an open source IoT operating system from China<span class="token punctuation">,</span> which has strong scalability<span class="token punctuation">:</span> from a tiny kernel running on a tiny core<span class="token punctuation">,</span> <span class="token keyword">for</span> example ARM Cortex<span class="token operator">-</span>M0<span class="token punctuation">,</span> or Cortex<span class="token operator">-</span>M3<span class="token operator">/</span><span class="token number">4</span><span class="token operator">/</span><span class="token number">7</span><span class="token punctuation">,</span> to a rich feature system running on MIPS32<span class="token punctuation">,</span> ARM Cortex<span class="token operator">-</span>A8<span class="token punctuation">,</span> ARM Cortex<span class="token operator">-</span>A9 DualCore etc<span class="token punctuation">.</span>

MbedTLS connection close success<span class="token punctuation">.</span>
</code></pre> 
<h2><a id="4_420"></a>4.常见问题</h2> 
<h4><a id="_421"></a>证书验证失败</h4> 
<pre><code>[tls]verification info: ! The CRL is not correctly signed by the trusted CA

</code></pre> 
<ul><li> <p>原因</p> <p>mbedtls 包中支持多种主流 CA 机构根证书，部分 CA 机构未支持</p> </li><li> <p>解决方法</p> <p>若测试其他 TLS 网站证书验证失败，手动获取测试网站根证书（Root Cerificate）添加到<code>mbedtls/tls_cerificate.c</code>文件中</p> </li></ul> 
<h4><a id="_434"></a>证书时间错误</h4> 
<pre><code>[tls]verify peer certificate fail....
[tls]verification info:   ! The certificate validity starts in the future

</code></pre> 
<ul><li> <p>原因</p> <p>TLS 握手是证书验证需要时间的验证，本地时间获取有误导致</p> </li><li> <p>解决方式</p> <p>检查 RTC 设备是否支持，检查 <code>RT_USING_RTC</code> 宏是否打开，校准设备时间。建议使用 NTP 同步本地时间。</p> </li></ul> 
<h4><a id="_CN__450"></a>证书 CN 错误</h4> 
<pre><code class="prism language-c">    verification info<span class="token punctuation">:</span> <span class="token operator">!</span> The certificate Common Name <span class="token punctuation">(</span>CN<span class="token punctuation">)</span> does not match with the expected CN

</code></pre> 
<ul><li> <p>原因</p> <p>测试其他 TLS 网站时，若输入域名不符合证书的 Common Name（CN）出现 CN 验证失败问题</p> </li><li> <p>解决方法</p> <p>检查输入域名和证书中 CN 是否匹配或输入 IP 地址</p> </li></ul> 
<h4><a id="0x7200__465"></a>0x7200 错误</h4> 
<ul><li> <p>原因</p> <p>部分原因是因为 mbedTls 收到了大于缓冲区大小的数据包</p> </li><li> <p>解决方法</p> <p><code>menuconfig</code> 配置增加数据帧大小 ( <code>Maxium fragment length in bytes</code> )</p> </li></ul> 
<pre><code class="prism language-c">RT<span class="token operator">-</span>Thread online packages <span class="token operator">--</span><span class="token operator">-&gt;</span>
    security packages  <span class="token operator">--</span><span class="token operator">-&gt;</span>
            Select Root Certificate  <span class="token operator">--</span><span class="token operator">-&gt;</span>      # 选择证书文件
        <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span> mbedtls<span class="token punctuation">:</span> An portable and flexible SSL<span class="token operator">/</span>TLS library  <span class="token operator">--</span><span class="token operator">-</span>
        <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>   Store the AES tables in ROM
        <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>   Maximum window size used
        <span class="token punctuation">(</span><span class="token number">6144</span><span class="token punctuation">)</span> Maxium fragment length in bytes # 配置数据帧大小（<span class="token number">0x7200</span> 错误可尝试增加该大小）
        <span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span>   Enable a mbedtls client example
              version <span class="token punctuation">(</span>latest<span class="token punctuation">)</span>  <span class="token operator">--</span><span class="token operator">-&gt;</span>

</code></pre> 
<h3><a id="_488"></a>参考</h3> 
<ul><li>mbedTLS官方网站：https://tls.mbed.org/</li><li>ARMmbed GitHub：<a href="https://github.com/ARMmbed/mbedtls/tree/72ea31b026e1fc61b01662474aa5125817b968bc">mbedtls</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3de470dceb24ef489142597a635f9e19/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Newtonsoft.Json.JsonConvert.DeserializeObject首次转换太慢问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/464b6c90dfd2cb4c3d4b71899dc17a20/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mbedtls学习4.mbedtls_RAM/ROM优化指南</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>