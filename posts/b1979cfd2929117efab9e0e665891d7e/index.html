<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>TCP高并发服务器简介（select、poll、epoll实现与区别） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="TCP高并发服务器简介（select、poll、epoll实现与区别）" />
<meta property="og:description" content="select、poll、epoll三者的实现： select实现TCP高并发服务器的流程： 一、创建套接字（socket函数）：二、填充服务器的网络信息结构体：三、套接字和服务器的网络信息结构体进行绑定（bind函数）：四、套接字设置成被动监听（listen函数）：五、创建要监听的文件描述符集合：使用select函数后，会将没有就绪的文件描述符在集合中去除，所以需要创建两个文件描述符集合，一个是母本read_fds，类似于常量，保持不变，而另一个作为副本read_fds_t，类似于变量，可以改变； fd_set read_fds; FD_ZERO(&amp;read_fds); fd_set read_fds_t; FD_ZERO(&amp;read_fds_t); 六、把创建的套接字添加到要监视的集合中： FD_SET(sockfd,&amp;read_fds); int fd_max = 0; fd_max = fd_max &gt; sockfd ? fd_max : sockfd; 七、设置系统时间结构体变量，用来指定超时的时间： struct timeval tm_out; 八、等待文件描述符中的事件是否就绪，成功则返回就绪的文件描述符的个数（select函数）：select函数： #include &lt;sys/select.h&gt; int select(int nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout); /* 参数： nfds：	要监视的最大文件描述符&#43;1 readfds：	要监视的读文件描述符集合 不关心可以传NULL writefds：	要监视的写文件描述符集合 不关心可以传NULL exceptfds：	要监视的异常文件描述符集合 不关心可以传NULL timeout：	超时时间 如果设置成NULL 会一直阻塞 直到有文件描述符就绪 返回值： 成功 就绪的文件描述符的个数 超时 0 失败 -1 重置错误码 */ //struct timeval 可以指定超时时间 //如果结构体的两个成员都为0 表示非阻塞 struct timeval { long tv_sec; //秒 long tv_usec; //微秒 }; void FD_CLR(int fd, fd_set *set);	//将文件描述符在集合中删除 int FD_ISSET(int fd, fd_set *set);	//判断文件描述符是否还在集合中 // 返回0 表示不在了 非0 表示在 void FD_SET(int fd, fd_set *set);	//向集合中添加一个文件描述符 void FD_ZERO(fd_set *set);	//清空集合 if(-1 == (ret = select(fd_max &#43; 1,&amp;read_fds_t,NULL,NULL,&amp;tm_out))) { perror(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/b1979cfd2929117efab9e0e665891d7e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-18T17:44:43+08:00" />
<meta property="article:modified_time" content="2024-01-18T17:44:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">TCP高并发服务器简介（select、poll、epoll实现与区别）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="selectpollepoll_0"></a>select、poll、epoll三者的实现：</h2> 
<h3><a id="selectTCP_1"></a>select实现TCP高并发服务器的流程：</h3> 
<ul><li><em><strong>一、创建套接字（socket函数）：</strong></em></li><li><em><strong>二、填充服务器的网络信息结构体：</strong></em></li><li><em><strong>三、套接字和服务器的网络信息结构体进行绑定（bind函数）：</strong></em></li><li><em><strong>四、套接字设置成被动监听（listen函数）：</strong></em></li><li><em><strong>五、创建要监听的文件描述符集合：</strong></em></li><li>使用select函数后，会将<code>没有就绪的文件描述符</code>在集合中<code>去除</code>，所以需要<code>创建两个文件描述符集合</code>，一个是母本<code>read_fds</code>，类似于常量，保持不变，而另一个作为副本<code>read_fds_t</code>，类似于变量，可以改变；</li></ul> 
<pre><code class="prism language-c">	fd_set read_fds<span class="token punctuation">;</span>
    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fd_set <span class="token class-name">read_fds_t</span><span class="token punctuation">;</span>
    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">read_fds_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li><em><strong>六、把创建的套接字添加到要监视的集合中：</strong></em></li></ul> 
<pre><code class="prism language-c">	<span class="token function">FD_SET</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd_max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    fd_max <span class="token operator">=</span> fd_max <span class="token operator">&gt;</span> sockfd <span class="token operator">?</span> fd_max <span class="token operator">:</span> sockfd<span class="token punctuation">;</span>
</code></pre> 
<ul><li><em><strong>七、设置系统时间结构体变量，用来指定超时的时间：</strong></em></li></ul> 
<pre><code class="prism language-c">	<span class="token keyword">struct</span> <span class="token class-name">timeval</span> tm_out<span class="token punctuation">;</span>
</code></pre> 
<ul><li><em><strong>八、等待文件描述符中的事件是否就绪，成功则返回就绪的文件描述符的个数（select函数）：</strong></em></li><li><em><strong>select函数：</strong></em></li></ul> 
<pre><code class="prism language-c">	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>
	<span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> nfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span>
                fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
	参数：
		nfds：		要监视的最大文件描述符+1
	
		readfds：	要监视的读文件描述符集合 不关心可以传NULL
	
		writefds：	要监视的写文件描述符集合 不关心可以传NULL
	
		exceptfds：	要监视的异常文件描述符集合 不关心可以传NULL
	
		timeout：	超时时间 如果设置成NULL 会一直阻塞 直到有文件描述符就绪
					
	返回值：
	
		成功 就绪的文件描述符的个数
	
		超时 0
	
		失败 -1 重置错误码
	 */</span>
	 				<span class="token comment">//struct timeval  可以指定超时时间</span>

				    <span class="token comment">//如果结构体的两个成员都为0 表示非阻塞</span>
				    
				    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token punctuation">{<!-- --></span>
				        <span class="token keyword">long</span>    tv_sec<span class="token punctuation">;</span>         <span class="token comment">//秒 </span>
				        <span class="token keyword">long</span>    tv_usec<span class="token punctuation">;</span>       <span class="token comment">//微秒</span>
				    <span class="token punctuation">}</span><span class="token punctuation">;</span>
				    
		<span class="token keyword">void</span> <span class="token function">FD_CLR</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将文件描述符在集合中删除</span>
		
		<span class="token keyword">int</span>  <span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//判断文件描述符是否还在集合中</span>
							<span class="token comment">// 返回0 表示不在了 非0 表示在</span>
		<span class="token keyword">void</span> <span class="token function">FD_SET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//向集合中添加一个文件描述符</span>
		
		<span class="token keyword">void</span> <span class="token function">FD_ZERO</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//清空集合</span>

</code></pre> 
<pre><code class="prism language-c">		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>fd_max <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span><span class="token class-name">read_fds_t</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>tm_out<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"select error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"timeout!!!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ul><li><em><strong>九、遍历文件描述符集合，判断哪些文件描述符已经准备就绪：</strong></em></li></ul> 
<pre><code class="prism language-c">		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fd_max <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token number">0</span> <span class="token operator">!=</span> ret<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
</code></pre> 
<ul><li><em><strong>十、判断文件描述符是否还在集合中，并且接收来自客户端的数据（recv函数）和给客户端发送应答消息（send函数）：</strong></em></li></ul> 
<pre><code class="prism language-c">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token operator">&amp;</span><span class="token class-name">read_fds_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//说明有新的客户端连接服务器</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> sockfd<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>   
                    
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>accept_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                    <span class="token punctuation">}</span>

                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端[%d]连接到服务器\n"</span><span class="token punctuation">,</span>accept_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//将新连接的客户端的套接字添加到要监视的集合中</span>
                    <span class="token function">FD_SET</span><span class="token punctuation">(</span>accept_fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    fd_max <span class="token operator">=</span> fd_max <span class="token operator">&gt;</span> accept_fd <span class="token operator">?</span> fd_max <span class="token operator">:</span> accept_fd<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token comment">//之前连接的客户端在向服务器发送信息</span>
                <span class="token punctuation">{<!-- --></span>

                    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>nbytes <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> nbytes<span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端[%d]已断开连接\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">//将已断开连接客户端的套接字在文件描述符集合中剔除</span>
                        <span class="token function">FD_CLR</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">//关闭套接字</span>
                        <span class="token function">close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"quit"</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端[%d]已退出\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//将已断开连接客户端的套接字在文件描述符集合中剔除</span>
                        <span class="token function">FD_CLR</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">//关闭套接字</span>
                        <span class="token function">close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端[%d]发来信息[%s]\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//组装应答消息</span>
                    <span class="token function">strcat</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"----------k"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//给客户端发送应答消息</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">send</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"send error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span>
                ret<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment">//减少遍历次数</span>
                
            <span class="token punctuation">}</span>
</code></pre> 
<ul><li><em><strong>十一、关闭套接字（close函数）：</strong></em></li></ul> 
<h3><a id="pollTCP_162"></a>poll实现TCP高并发服务器的流程：</h3> 
<ul><li><em><strong>一、创建套接字（socket函数）：</strong></em></li><li><em><strong>二、填充服务器的网络信息结构体：</strong></em></li><li><em><strong>三、套接字和服务器的网络信息结构体进行绑定（bind函数）：</strong></em></li><li><em><strong>四、套接字设置成被动监听（listen函数）：</strong></em></li><li><em><strong>五、创建要监听的文件描述符集合并清空文件描述符集合：</strong></em></li></ul> 
<pre><code class="prism language-c">	<span class="token comment">//创建要监听的文件描述符集合</span>
    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> new_fds<span class="token punctuation">[</span><span class="token number">2048</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token comment">//清空文件描述符集合</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2048</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        new_fds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ul><li><em><strong>六、把创建的套接字添加到要监视的集合中：</strong></em></li></ul> 
<pre><code class="prism language-c">	<span class="token function">FD_SET</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>read_fds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd_max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    fd_max <span class="token operator">=</span> fd_max <span class="token operator">&gt;</span> sockfd <span class="token operator">?</span> fd_max <span class="token operator">:</span> sockfd<span class="token punctuation">;</span>
</code></pre> 
<ul><li><em><strong>七、套接字添加到要监视的集合中，并且设置要监听的事件：</strong></em></li></ul> 
<pre><code class="prism language-c">	<span class="token comment">//套接字添加到要监视的集合中</span>
    new_fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> sockfd<span class="token punctuation">;</span>

    <span class="token comment">//设置要监听的事件</span>
    new_fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">|=</span> POLLIN<span class="token punctuation">;</span>
</code></pre> 
<ul><li><em><strong>八、记录文件描述符集合中最大的文件描述符，并且设置超时的时间：</strong></em></li></ul> 
<pre><code class="prism language-c">	<span class="token comment">//记录文件描述符集合中最大的文件描述符</span>
    <span class="token keyword">int</span> fd_max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    fd_max <span class="token operator">=</span> fd_max <span class="token operator">&gt;</span> sockfd <span class="token operator">?</span> fd_max <span class="token operator">:</span> sockfd<span class="token punctuation">;</span>

    <span class="token comment">//设置超时的时间</span>
    <span class="token keyword">int</span> tm_out <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li><em><strong>九、等待文件描述符中的事件是否就绪，成功则返回就绪的文件描述符的个数（poll函数）：</strong></em></li><li><code>poll实现TCP中型并发服务器</code>与<code>select实现TCP小型并发服务器</code>的<code>区别</code>就是<code>无需每次重置</code>集合,并且可以<code>设置要监视的最大文件描述符的个数</code>，而select<code>至多</code>监视<code>1024个文件描述符</code>；</li><li><em><strong>poll函数：</strong></em></li></ul> 
<pre><code class="prism language-c">	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>
	<span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token operator">*</span>fds<span class="token punctuation">,</span> <span class="token class-name">nfds_t</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	参数：
	
		fds：要监视的文件描述符的集合指向自定义的结构体数据
		
		nfds：fds中已经使用的项目的个数
		
		timeout：超时时间单位是毫秒  
		
				设置成10000 表示10s
				
				-1	永久阻塞
				
				0	非阻塞
	返回值：
	
		0		超时
		-1		出错 重置错误码
		正数	成功 返回的就绪的文件描述符的个数
	*/</span>
			<span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token punctuation">{<!-- --></span>
			   <span class="token keyword">int</span>   fd<span class="token punctuation">;</span>         <span class="token comment">/* 文件描述符 设置成-1 内核就不再监视这一位了*/</span>
			   <span class="token keyword">short</span> events<span class="token punctuation">;</span>     <span class="token comment">/* 要监视的事件 */</span>
			   <span class="token keyword">short</span> revents<span class="token punctuation">;</span>    <span class="token comment">/* 返回的事件 */</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token comment">/*
			要监视的事件是用位运算或起来的
			
			要监视的事件放在events字段,而实际就绪的事件在revents字段返回
			
			POLLIN	读事件
			
			POLLOUT	写时间
			
			POLLERR	异常事件
			*/</span>

</code></pre> 
<pre><code class="prism language-c">		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>new_fds<span class="token punctuation">,</span>fd_max<span class="token punctuation">,</span>tm_out<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"poll error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"timeout!!!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ul><li><em><strong>十、遍历文件描述符集合，判断哪些文件描述符已经准备就绪：</strong></em></li></ul> 
<pre><code class="prism language-c">		<span class="token keyword">for</span><span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;=</span> fd_max <span class="token operator">&amp;&amp;</span> ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>   
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">}</span>
</code></pre> 
<ul><li><em><strong>十一、找到实际就绪的事件的文件描述符，并且接收来自客户端的数据（recv函数）和给客户端发送应答消息（send函数）：</strong></em></li></ul> 
<pre><code class="prism language-c">           <span class="token comment">//找到实际就绪的事件的文件描述符</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>new_fds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//说明有新的客户端连接服务器</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>new_fds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">==</span> sockfd<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>accept_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
                    <span class="token punctuation">}</span>

                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端[%d]连接到服务器\n"</span><span class="token punctuation">,</span>accept_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//将新连接的客户端的套接字添加到要监视的集合中</span>

                    <span class="token comment">//遍历文件描述符集合，给新的文件描述符找一个位置</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">2048</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> new_fds<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span>
                        <span class="token punctuation">{<!-- --></span>
                            new_fds<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> accept_fd<span class="token punctuation">;</span>
                            new_fds<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">|=</span> POLLIN<span class="token punctuation">;</span>

                            fd_max <span class="token operator">=</span> fd_max <span class="token operator">&gt;</span> accept_fd <span class="token operator">?</span> fd_max <span class="token operator">:</span> accept_fd<span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">2048</span> <span class="token operator">==</span> j<span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//此时集合容量满了</span>
                        <span class="token function">close</span><span class="token punctuation">(</span>accept_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    

                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token comment">//之前连接的客户端在向服务器发送信息</span>
                <span class="token punctuation">{<!-- --></span>

                    <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>nbytes <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>new_fds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> nbytes<span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端[%d]已断开连接\n"</span><span class="token punctuation">,</span>new_fds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">//将已断开连接客户端的套接字在文件描述符集合中剔除</span>
                        <span class="token function">close</span><span class="token punctuation">(</span>new_fds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        new_fds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"quit"</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端[%d]已退出\n"</span><span class="token punctuation">,</span>new_fds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//将已断开连接客户端的套接字在文件描述符集合中剔除</span>
                        <span class="token function">close</span><span class="token punctuation">(</span>new_fds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        new_fds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端[%d]发来信息[%s]\n"</span><span class="token punctuation">,</span>new_fds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//组装应答消息</span>
                    <span class="token function">strcat</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"----------k"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//给客户端发送应答消息</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">send</span><span class="token punctuation">(</span>new_fds<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"send error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span>
                ret<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment">//减少遍历次数</span>
            <span class="token punctuation">}</span>
</code></pre> 
<ul><li><em><strong>十二、关闭套接字（close函数）：</strong></em></li></ul> 
<h3><a id="epollTCP_355"></a>epoll实现TCP高并发服务器的流程：</h3> 
<ul><li><em><strong>一、创建套接字（socket函数）：</strong></em></li><li><code>通信域</code>选择<code>IPV4</code>网络协议、套接字类型选择<code>流式</code>；</li></ul> 
<pre><code class="prism language-c">	<span class="token keyword">int</span> sock_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//通信域选择IPV4、套接字类型选择流式</span>
</code></pre> 
<ul><li><em><strong>二、填充服务器和客户机的网络信息结构体：</strong></em></li><li>1.分别定义服务器网络信息结构体变量<code>serveraddr</code>和客户机网络信息结构体变量<code>clientaddr</code>；</li><li>2.分别求出服务器和客户机的网络信息结构体变量的内存空间大小，以作备用；</li><li>3.网络信息<code>结构体清0</code>；</li><li>4.使用<code>IPV4</code>网络协议<code>AF_INET</code>；</li><li>5.在终端预留服务器端主机的<code>IP地址</code>：<code>inet_addr(argv[1])</code>；</li><li>6.在终端预留服务器端网络字节序的<code>端口号</code>：<code>htons(atoi(argv[2]))</code>；</li></ul> 
<pre><code class="prism language-c">	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serveraddr<span class="token punctuation">;</span> <span class="token comment">//定义服务器网络信息结构体变量</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clientaddr<span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> serveraddr_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serveraddr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//求出服务器结构体变量的内存空间大小</span>
    <span class="token class-name">socklen_t</span> clientaddr_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientaddr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//求出客户机结构体变量的内存空间大小</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>serveraddr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>serveraddr_len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//服务器结构体清零</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>clientaddr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>clientaddr_len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//客户机结构体清零</span>

    serveraddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>  <span class="token comment">//使用IPV4网络协议</span>
    serveraddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//IP地址</span>
    serveraddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//网络字节序的端口号</span>
</code></pre> 
<ul><li><em><strong>三、设置允许端口复用（setsockopt函数）：</strong></em></li><li><em><strong>setsockopt函数：</strong></em></li><li><em><strong>功能</strong></em>：设置套接字属性；</li></ul> 
<pre><code class="prism language-c">
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

	<span class="token keyword">int</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">int</span> optname<span class="token punctuation">,</span>
	<span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>optval<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> optlen<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token comment">/*
	参数：
	
		sockfd：套接字
		level：	选项的级别
	
			套接字API级别		SOL_SOCKET
	
			TCP级别			IPPROTO_TCP
	
			IP级别			IPPROTO_IP
	
		optname：选项的名字
	
			套接字API级别
	
				SO_BROADCAST	是否允许发送广播
	
				SO_RCVBUF		接收缓冲区的大小
	
				SO_SNDBUF		发送缓冲区的大小
	
				SO_RCVTIMEO		接收超时时间
					参数使用的是 struct timeval 结构体
					如果超时了 函数调用会立即返回-1
					并将错误码置成 EAGAIN
	
				SO_SNDTIMEO			发送超时时间
	
				SO_REUSEADDR		端口复用
	
			TCP级别
	
				TCP_NODELAY		使能/禁用Nagle算法
	
			IP级别
	
				IP_ADD_MEMBERSHIP	设置加入多播组
	
		optval：	选项的值
	
			没有特殊说明时 使用的都是int类型
	
		optlen：optval的大小
	
	返回值：
	
		成功 	0
	
		失败 	-1 	重置错误码
	*/</span>
</code></pre> 
<ul><li><em><strong>特别注意：</strong></em></li><li>使用setsockopt设置允许端口复用时，其在代码的位置在填充网络信息结构体和bind之间；</li></ul> 
<pre><code class="prism language-c">	<span class="token keyword">int</span> reuse <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>reuse<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>reuse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"setsockopt error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<ul><li> <p><em><strong>四、套接字和服务器的网络信息结构体进行绑定（bind函数）：</strong></em></p> </li><li> <p><em><strong>五、套接字设置成被动监听（listen函数）：</strong></em></p> </li><li> <p><em><strong>六、创建红黑树（epoll_create函数）：</strong></em></p> </li></ul> 
<pre><code class="prism language-c">	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
	<span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	功能：
		
		创建epoll/创建epoll实例的描述符
	
	参数：
	
	    size:参数已经被忽略了，只需要填写大于0的值即可
	
	返回值：

        epoll_create 调用成功时会返回一个非负整数epfd，
    
        表示新创建的 epoll 实例的文件描述符，
    
        如果调用失败则返回 -1，并设置 errno 变量以指示具体错误原因
     */</span>
</code></pre> 
<pre><code class="prism language-c">	<span class="token keyword">int</span> epfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> epfd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"epoll_create error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre> 
<ul><li><em><strong>七、定义事件结构体变量和存放就绪事件描述符的数组：</strong></em></li><li><em><strong>事件结构体</strong></em>：<code>epoll_event</code>用于描述一个文件描述符上的事件；</li></ul> 
<pre><code class="prism language-c">			<span class="token keyword">typedef</span> <span class="token keyword">union</span> epoll_data <span class="token punctuation">{<!-- --></span>
               <span class="token keyword">void</span>        <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
               <span class="token keyword">int</span>          fd<span class="token punctuation">;</span>  
               <span class="token class-name">uint32_t</span>     u32<span class="token punctuation">;</span>
               <span class="token class-name">uint64_t</span>     u64<span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token class-name">epoll_data_t</span><span class="token punctuation">;</span>   
           <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token punctuation">{<!-- --></span>
               <span class="token class-name">uint32_t</span>     events<span class="token punctuation">;</span>      <span class="token comment">//EPOLLIN 读 / EPOLLOUT 写</span>
               <span class="token class-name">epoll_data_t</span> data<span class="token punctuation">;</span>        <span class="token comment">//存放用户的数据</span>
           <span class="token punctuation">}</span><span class="token punctuation">;</span>    
</code></pre> 
<pre><code class="prism language-c">
    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> event<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> events<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li><em><strong>八、将关心的文件描述符加入到红黑树（epoll_ctl函数）：</strong></em></li><li><em><strong>功能</strong></em>：epoll的控制操作或者用于向 epoll 实例中添加、修改、删除事件；</li><li><em><strong>epoll_ctl函数：</strong></em></li></ul> 
<pre><code class="prism language-c">	<span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	参数：
	         epfd:epoll的文件描述符
	
	         op:控制方式
	
	            EPOLL_CTL_ADD：添加
	
	            EPOLL_CTL_MOD：修改
	
	            EPOLL_CTL_DEL：删除
	
	         fd:被操作的文件描述符
	
	         event:（事件）结构体指针
	          
	
	返回值：    
				成功返回0，
	
	            失败返回-1 置位错误码
	 */</span>
</code></pre> 
<pre><code class="prism language-c">	<span class="token comment">//添加要检测事件的描述符</span>
    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>

    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> sock_fd<span class="token punctuation">;</span>

    <span class="token comment">//将关心的文件描述符加入到红黑树</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span>EPOLL_CTL_ADD<span class="token punctuation">,</span>sock_fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"epoll_ctl error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre> 
<ul><li><em><strong>九、等待文件描述符中的事件是否就绪，成功则返回就绪的文件描述符的个数（epoll_wait函数）：</strong></em></li><li><em><strong>epoll_wait函数：</strong></em></li></ul> 
<pre><code class="prism language-c">	<span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>events<span class="token punctuation">,</span><span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	参数：

		    epfd:epoll的文件描述符
		
		    events:准备好的事件的结构体地址
		
		    maxevents:返回的最大的文件描述符的个数
		
		    timeout:超时
		
		        &gt;0 :毫秒级别的超时时间
		
		        =0 :立即返回
		
		        =-1:不关心超时时间
	返回值：
	
		     成功返回准备好的文件描述符的个数
		
		     返回0代表超时时间到了
		
		     失败返回-1置位错误码
	*/</span>
</code></pre> 
<pre><code class="prism language-c">		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span>events<span class="token punctuation">,</span>N<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"epoll_wait error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>	
</code></pre> 
<ul><li><em><strong>十、遍历就绪的文件描述符集，判断哪些文件描述符已经准备就绪：</strong></em></li></ul> 
<pre><code class="prism language-c">		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ret<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ul><li><em><strong>十一、找到实际就绪的事件的文件描述符，并且接收来自客户端的数据（recv函数）和给客户端发送应答消息（send函数）：</strong></em></li></ul> 
<pre><code class="prism language-c">			<span class="token keyword">if</span><span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">==</span> sock_fd<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//获取连接成功后新的客户端</span>
                new_fd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clientaddr<span class="token punctuation">,</span><span class="token operator">&amp;</span>clientaddr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> new_fd<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件描述符[%d]客户端[%s:%d]连接到了服务器\n"</span><span class="token punctuation">,</span>new_fd<span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>clientaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">ntohs</span><span class="token punctuation">(</span>clientaddr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//添加要检测的文件描述符</span>
                event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>
                event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> new_fd<span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span>EPOLL_CTL_ADD<span class="token punctuation">,</span>new_fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"epoll_ctl error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件描述符[%d]成功挂载在红黑树上\n"</span><span class="token punctuation">,</span>new_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> old_fd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token punctuation">(</span>nbytes <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>old_fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recv error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> nbytes<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件描述符[%d]客户端断开了服务器\n"</span><span class="token punctuation">,</span>old_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//关闭对应的文件描述符</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>old_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//剔除挂在树上对应的文件描述符</span>
                    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span>EPOLL_CTL_DEL<span class="token punctuation">,</span>old_fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"quit"</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件描述符[%d]客户端退出了服务器\n"</span><span class="token punctuation">,</span>old_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//关闭对应的文件描述符</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>old_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//剔除挂在树上对应的文件描述符</span>
                    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span>EPOLL_CTL_DEL<span class="token punctuation">,</span>old_fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件描述符[%d]客户端发来数据[%s]\n"</span><span class="token punctuation">,</span>old_fd<span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//组装应答消息</span>
                <span class="token function">strcat</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"-----k"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//给客户端发送应答消息</span>
                <span class="token function">send</span><span class="token punctuation">(</span>old_fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<ul><li><em><strong>十二、关闭套接字（close函数）：</strong></em></li></ul> 
<h2><a id="selectpollepoll_662"></a>select、poll、epoll三者的区别：</h2> 
<p><img src="https://images2.imgbox.com/68/85/YYtK8H24_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/27ffb28d356d391f08ad6cb78fa61cac/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">什么是车载信息娱乐系统和集成驾驶舱</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c014eb8a8f8657e6019e6d54faa5fab0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JNA调用C&#43;&#43;动态库，返回二维数组</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>