<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>万方 protobuf 反序列化 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="万方 protobuf 反序列化" />
<meta property="og:description" content="protobuf 是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化。
在网络传输方面，相比传统的json，有着更快、更小，且加密性好的特点。
在实际应用中，万方数据库官网发送的请求，就用到了这。
一般网站，比如cnki，我们检索内容，只需要拼接一个http请求，便能获取到数据。
但是，万方数据库，却是这样的，看不到请求body都是一些乱码一样的数据，连返回的数据也是。
这正是由于其使用了protobuf序列化，我们通过它发送请求头中也可以看到有 “application/grpc-web&#43;proto” 这样的字样。
其大致流程：实例化一个proto格式对象（长得类似c的结构体），将检索式塞到该对象属性中，对其进行序列化为二进制，发送请求，对接收到的数据进行反序列化。
因此我们重点就在于拿到这个proto对象的结构。
有关万方protobuf发送请求的大部分内容，可以参考大佬的文章： https://blog.csdn.net/qq_35491275/article/details/111721639
这里就只对拿到数据，将其反序列化的大致步骤，进行讲解。
本人是通过python发送请求，根据上面参考文章说的，要将数据反序列化，便需要获取到proto格式，比如有哪些变量和变量类型。
而这都需要通过在浏览器F12，打断点，一步步调试js函数才能获得。本人由于对js不了解，也不太会调试js，所以也是变相换个方法去实现。
F12------》Source------》XHR/fetch Breakpoints，将接口请求地址复制进去，这样调试的时候就会自动在相关位置断点了。
在Call Stack调用栈中，看到了SearchService字样，点击进去。
后面通过打断点，一步步调试，便能在一些方法名中找到需要的变量和类型。
本人这里就不做调试，我说说自己当时的思路。
因为整个检索流程，就主要经过了两份js，所以我直接ctrl&#43;F，搜索SearchService字样，发现都在api.1f9fdaa9.js这一份当中。
然后我再ctrl&#43;F，搜索 “toObject = function(e, t) {” 字样，一般每个message结构对应的变量名和序号就在这个函数中，变量类型则一般在 “serializeBinaryToWriter = function(e, t) {” 函数中，大概有90多个匹配的。这一步不清楚可以看上面参考博客，便知道为什么这样找这些message结构。将他们列出来，写入一份.proto文件中。
这里变量名好像可以自己命名，主要是序号需要保持一致，但为了解析数据方便，这里变量名也尽量保持了和js中的一致，最终得到右边的proto文件。
然后通过protoc.exe编译器，输入命令 protoc proto文件名 --python_out=./ 得到相关py文件。
新建一个python工程，将刚刚生成的py文件丢入工程中。便可成功反序列化出数据。
这里请求时使用了blackboxprotobuf模块，可以减少去获取请求的proto结构这一步骤。具体一些点的可以参考他人博客。
参考代码：main.py
# This is a sample Python script. # Press Shift&#43;F10 to execute it or replace it with your code. # Press Double Shift to search everywhere for classes, files, tool windows, actions, and settings." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/32c2ee3cc2970ce5f2dc5985ba0d421b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-01T10:31:25+08:00" />
<meta property="article:modified_time" content="2023-06-01T10:31:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">万方 protobuf 反序列化</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>protobuf 是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化。<br> 在网络传输方面，相比传统的json，有着更快、更小，且加密性好的特点。</p> 
<p><br>在实际应用中，万方数据库官网发送的请求，就用到了这。<br> 一般网站，比如cnki，我们检索内容，只需要拼接一个http请求，便能获取到数据。<br> <img src="https://images2.imgbox.com/36/b3/msrLgnf3_o.png" alt="在这里插入图片描述"></p> 
<p><br><br>但是，万方数据库，却是这样的，看不到请求body都是一些乱码一样的数据，连返回的数据也是。<br> <img src="https://images2.imgbox.com/c2/ed/wqmAxGZ1_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a2/9b/x6N4nt2p_o.png" alt="在这里插入图片描述"></p> 
<p><br><br>这正是由于其使用了protobuf序列化，我们通过它发送请求头中也可以看到有 “application/grpc-web+proto” 这样的字样。<br> <img src="https://images2.imgbox.com/d8/f2/0FvdaL6m_o.png" alt="在这里插入图片描述"></p> 
<p><strong><br><br><br><font color="blue">其大致流程：实例化一个proto格式对象（长得类似c的结构体），将检索式塞到该对象属性中，对其进行序列化为二进制，发送请求，对接收到的数据进行反序列化。<br> 因此我们重点就在于拿到这个proto对象的结构。</font></strong></p> 
<p><em><strong><br><br>有关万方protobuf发送请求的大部分内容，可以参考大佬的文章： https://blog.csdn.net/qq_35491275/article/details/111721639</strong></em></p> 
<p><br><br>这里就只对拿到数据，将其反序列化的大致步骤，进行讲解。<br> 本人是通过python发送请求，根据上面参考文章说的，要将数据反序列化，便需要获取到proto格式，比如有哪些变量和变量类型。<br> 而这都需要通过在浏览器F12，打断点，一步步调试js函数才能获得。本人由于对js不了解，也不太会调试js，所以也是变相换个方法去实现。</p> 
<p><br><br>F12------》Source------》XHR/fetch Breakpoints，将接口请求地址复制进去，这样调试的时候就会自动在相关位置断点了。<br> <img src="https://images2.imgbox.com/06/b8/qIpel3W4_o.png" alt="在这里插入图片描述"></p> 
<p><br><br>在Call Stack调用栈中，看到了SearchService字样，点击进去。<br> <img src="https://images2.imgbox.com/22/1c/F48GA4TO_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bf/c0/ant2xvc7_o.png" alt="在这里插入图片描述"></p> 
<p><br><br>后面通过打断点，一步步调试，便能在一些方法名中找到需要的变量和类型。<br> 本人这里就不做调试，我说说自己当时的思路。</p> 
<p>因为整个检索流程，就主要经过了两份js，所以我直接ctrl+F，搜索SearchService字样，发现都在api.1f9fdaa9.js这一份当中。<br> 然后我再ctrl+F，搜索 “toObject = function(e, t) {” 字样，一般每个message结构对应的变量名和序号就在这个函数中，变量类型则一般在 “serializeBinaryToWriter = function(e, t) {” 函数中，大概有90多个匹配的。这一步不清楚可以看上面参考博客，便知道为什么这样找这些message结构。将他们列出来，写入一份.proto文件中。<br> 这里变量名好像可以自己命名，主要是序号需要保持一致，但为了解析数据方便，这里变量名也尽量保持了和js中的一致，最终得到右边的proto文件。<br> <img src="https://images2.imgbox.com/c5/cb/k38D5vDu_o.png" alt="在这里插入图片描述"><br> <br><br> <img src="https://images2.imgbox.com/e6/51/tnnTJKnL_o.png" alt="在这里插入图片描述"><br> <br><br> <img src="https://images2.imgbox.com/51/6a/260Letgp_o.png" alt="在这里插入图片描述"></p> 
<p><br><br><br>然后通过protoc.exe编译器，输入命令 <code>protoc proto文件名 --python_out=./</code> 得到相关py文件。</p> 
<p><img src="https://images2.imgbox.com/b7/1f/0toUIaxQ_o.png" alt="在这里插入图片描述"></p> 
<p><br><br><br>新建一个python工程，将刚刚生成的py文件丢入工程中。便可成功反序列化出数据。</p> 
<p><img src="https://images2.imgbox.com/83/f8/Mxi6bMix_o.png" alt="在这里插入图片描述"></p> 
<p><br>这里请求时使用了blackboxprotobuf模块，可以减少去获取请求的proto结构这一步骤。具体一些点的可以参考他人博客。<br> <br>参考代码：main.py</p> 
<pre><code class="prism language-python"><span class="token comment"># This is a sample Python script.</span>

<span class="token comment"># Press Shift+F10 to execute it or replace it with your code.</span>
<span class="token comment"># Press Double Shift to search everywhere for classes, files, tool windows, actions, and settings.</span>


<span class="token keyword">import</span> blackboxprotobuf
<span class="token keyword">import</span> urllib
<span class="token keyword">from</span> urllib <span class="token keyword">import</span> parse
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> tkinter
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> os
<span class="token keyword">import</span> wf_proto_pb2 <span class="token keyword">as</span> wf_proto_pb2


<span class="token keyword">def</span> <span class="token function">intToBytes</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">:</span>
  result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>value <span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span>
  result<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> result


<span class="token keyword">def</span> <span class="token function">prowfdata</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 转码</span>
    response <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'latin1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'unicode-escape'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'latin1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> response


<span class="token keyword">def</span> <span class="token function">searchw</span><span class="token punctuation">(</span>searchkey<span class="token punctuation">)</span><span class="token punctuation">:</span>
    searchkey <span class="token operator">=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>searchkey<span class="token punctuation">)</span>
    json <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>searchkey<span class="token punctuation">)</span>
    url <span class="token operator">=</span> json<span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span>
    headers <span class="token operator">=</span> json<span class="token punctuation">[</span><span class="token string">"headers"</span><span class="token punctuation">]</span>
    deserialize_data <span class="token operator">=</span> json<span class="token punctuation">[</span><span class="token string">"deserialize_data"</span><span class="token punctuation">]</span>
    message_type <span class="token operator">=</span> json<span class="token punctuation">[</span><span class="token string">"message_type"</span><span class="token punctuation">]</span>
    unwanted_bytes <span class="token operator">=</span> json<span class="token punctuation">[</span><span class="token string">"unwanted_bytes"</span><span class="token punctuation">]</span>

    proxies <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'http'</span><span class="token punctuation">:</span> <span class="token string">'http://127.0.0.1:8888'</span><span class="token punctuation">,</span> <span class="token string">'https'</span><span class="token punctuation">:</span> <span class="token string">'http://127.0.0.1:8888'</span><span class="token punctuation">}</span>
    form_data <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>blackboxprotobuf<span class="token punctuation">.</span>encode_message<span class="token punctuation">(</span>deserialize_data<span class="token punctuation">,</span> message_type<span class="token punctuation">)</span><span class="token punctuation">)</span>
    bytes_head <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>intToBytes<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>form_data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    requests<span class="token punctuation">.</span>packages<span class="token punctuation">.</span>urllib3<span class="token punctuation">.</span>disable_warnings<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>data<span class="token operator">=</span>bytes_head <span class="token operator">+</span> form_data<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>data<span class="token operator">=</span>bytes_head <span class="token operator">+</span> form_data<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxies<span class="token punctuation">)</span>



    search_response2 <span class="token operator">=</span> wf_proto_pb2<span class="token punctuation">.</span>SearchService_SearchResponse<span class="token punctuation">(</span><span class="token punctuation">)</span>
    search_response2<span class="token punctuation">.</span>ParseFromString<span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> prowfdata<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>search_response2<span class="token punctuation">)</span><span class="token punctuation">)</span>





<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    searchkey <span class="token operator">=</span> <span class="token string">'{"url":"https://s.wanfangdata.com.cn/SearchService.SearchService/search","headers":{"accept":"*/*","Referer":"https://s.wanfangdata.com.cn","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36","Content-Type":"application/grpc-web+proto",},"deserialize_data":{"1":{"1":"paper","2":"(题名:(dna))","4":{"1":"Type","2":"(Periodical OR Thesis OR Conference)"},"5":1,"6":10,"8":"\\u0000"},"2":3},"message_type":{"1":{"type":"message","message_typedef":{"1":{"type":"bytes", "name":""}, "2":{"type":"bytes", "name":""},"4":{"type":"message","message_typedef":{"1":{"type":"bytes", "name":""},"2":{"type":"bytes", "name":""}},"name":""}, "5":{"type":"int", "name":""},"6":{"type":"int", "name":""}, "8":{"type":"bytes", "name":""}},"name":""}, "2":{"type":"int", "name":""}},"unwanted_bytes":"0"}'</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>searchw<span class="token punctuation">(</span>searchkey<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/408c77cbaeb6ddd830b329095f79a103/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">全面理解C&#43;&#43;函数最难理解的部分：数组形参，函数指针，以及函数指针作为形参</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1a5e6482fa177697f45b81c4caa9f28f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">flinkcdc on yarn任务迁移到 on k8s 问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>