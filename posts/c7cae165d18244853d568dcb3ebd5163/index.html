<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Socket套接字通信 TCP UDP详解（网络通信） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Socket套接字通信 TCP UDP详解（网络通信）" />
<meta property="og:description" content="文章目录 一 什么是套接字Socket1.Socket简介2.Socket的域（domain）3.Socket主要类型（type）4.Socket基本工作流程 二 创建套接字Socket1.socket函数 三 绑定套接字Socket与主机网络地址1.bind函数2.struct sockaddr与struct sockaddr_in3.常用填充地址信息的方法4.主机字节序与网络字节序 四 UDP通信的实现1.recvfrom函数2.sendto函数3.示例 五 TCP通信的实现1.listen函数（server端）2.accept函数（server端）3.connect函数（client端）4.write与read函数5.send与recv函数6.示例 六 套接字的缓冲区以及阻塞模式1.缓冲区2.使用write/send发送数据3.使用read/recv读取数据 七 总结套接字收发数据的过程 一 什么是套接字Socket 1.Socket简介 所谓套接字(Socket)，就是对网络中不同主机上的应用进程之间进行双向通信的端点的抽象。一个套接字就是网络上进程通信的一端，提供了应用层进程利用网络协议交换数据的机制。从所处的地位来讲，套接字上联应用进程，下联网络协议栈，是应用程序通过网络协议进行通信的接口，是应用程序与网络协议根进行交互的接口 。
Socket(套接字)可以看成是两个网络应用程序进行通信时，各自通信连接中的端点，这是一个逻辑上的概念。它是网络环境中进程间通信的API(应用程序编程接口)，也是可以被命名和寻址的通信端点，使用中的每一个套接字都有其类型和一个与之相连进程。通信时其中一个网络应用程序将要传输的一段信息写入它所在主机的 Socket中，该 Socket通过与网络接口卡(NIC)相连的传输介质将这段信息送到另外一台主机的 Socket中，使对方能够接收到这段信息。 Socket是由IP地址和端口结合的，提供向应用层进程传送数据包的机制 。
2.Socket的域（domain） 域指定套接字通信中使用的网络介质。最常见的套接字域是 AF_INET（IPv4）或者AF_INET6(IPV6)，它是指 Internet 网络，许多 Linux 局域网使用的都是该网络，当然，因特网自身用的也是它。
3.Socket主要类型（type） 流套接字(SOCK_STREAM)
流套接字用于提供面向连接、可靠的数据传输服务。该服务将保证数据能够实现无差错、无重复送，并按顺序接收。流套接字之所以能够实现可靠的数据服务，原因在于其使用了传输控制协议，即TCP(The Transmission Control Protocol)协议 。数据报套接字(SOCK_DGRAM)
数据报套接字提供一种无连接的服务。该服务并不能保证数据传输的可靠性,数据有可能在传输过程中丢失或出现数据重复，且无法保证顺序地接收到数据。数据报套接字使用UDP( User DatagramProtocol)协议进行数据的传输。由于数据报套接字不能保证数据传输的可靠性，对于有可能出现的数据丢失情况，需要在程序中做相应的处理 。原始套接字(SOCK_RAW)
原始套接字与标准套接字(标准套接字指的是前面介绍的流套接字和数据报套接字)的区别在于：原始套接字可以读写内核没有处理的IP数据包，而流套接字只能读取TCP协议的数据，数据报套接字只能读取UDP协议的数据。因此，如果要访问其他协议发送的数据必须使用原始套接 。 4.Socket基本工作流程 要通过互联网进行通信，至少需要一对套接字，其中一个运行于客户端，我们称之为 Client Socket，另一个运行于服务器端，我们称之为 Server Socket 。根据连接启动的方式以及本地套接字要连接的目标，套接字之间的连接过程可以分为三个步骤 ：
服务器监听
所谓服务器监听，是指服务器端套接字并不定位具体的客户端套接字，而是处于等待连接的状态，实时监控网络状态 。客户端请求
所谓客户端请求，是指由客户端的套接字提出连接请求，要连接的目标是服务器端的套接字。为此，客户端的套接字必须首先描述它要连接的服务器的套接字，指出服务器端套接字的地址和端口号，然后就向服务器端接字提出连接请求 。连接确认
所谓连接确认，是指当服务器端套接字监听到或者说接收到客户端套接字的连接请求，就会响应客户端套接字的请求，建立一个新的线程，并把服务器端套接字的描述发送给客户端。一旦客户端确认了此描述，连接就建立好了。而服务器端套接字继续处于监听状态，接收其他客户端套接字的连接请求 。 二 创建套接字Socket 1.socket函数 int socket(int domain, int type, int protocol); /* 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c7cae165d18244853d568dcb3ebd5163/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-15T16:05:39+08:00" />
<meta property="article:modified_time" content="2022-08-15T16:05:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Socket套接字通信 TCP UDP详解（网络通信）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_Socket_1" rel="nofollow">一 什么是套接字Socket</a></li><li><ul><li><a href="#1Socket_2" rel="nofollow">1.Socket简介</a></li><li><a href="#2Socketdomain_7" rel="nofollow">2.Socket的域（domain）</a></li><li><a href="#3Sockettype_9" rel="nofollow">3.Socket主要类型（type）</a></li><li><a href="#4Socket_16" rel="nofollow">4.Socket基本工作流程</a></li></ul> 
   </li><li><a href="#_Socket_24" rel="nofollow">二 创建套接字Socket</a></li><li><ul><li><a href="#1socket_25" rel="nofollow">1.socket函数</a></li></ul> 
   </li><li><a href="#_Socket_43" rel="nofollow">三 绑定套接字Socket与主机网络地址</a></li><li><ul><li><a href="#1bind_44" rel="nofollow">1.bind函数</a></li><li><a href="#2struct_sockaddrstruct_sockaddr_in_58" rel="nofollow">2.struct sockaddr与struct sockaddr_in</a></li><li><a href="#3_103" rel="nofollow">3.常用填充地址信息的方法</a></li><li><a href="#4_172" rel="nofollow">4.主机字节序与网络字节序</a></li></ul> 
   </li><li><a href="#_UDP_214" rel="nofollow">四 UDP通信的实现</a></li><li><ul><li><a href="#1recvfrom_219" rel="nofollow">1.recvfrom函数</a></li><li><a href="#2sendto_237" rel="nofollow">2.sendto函数</a></li><li><a href="#3_255" rel="nofollow">3.示例</a></li></ul> 
   </li><li><a href="#_TCP_446" rel="nofollow">五 TCP通信的实现</a></li><li><ul><li><a href="#1listenserver_450" rel="nofollow">1.listen函数（server端）</a></li><li><a href="#2acceptserver_470" rel="nofollow">2.accept函数（server端）</a></li><li><a href="#3connectclient_487" rel="nofollow">3.connect函数（client端）</a></li><li><a href="#4writeread_502" rel="nofollow">4.write与read函数</a></li><li><a href="#5sendrecv_518" rel="nofollow">5.send与recv函数</a></li><li><a href="#6_545" rel="nofollow">6.示例</a></li></ul> 
   </li><li><a href="#__762" rel="nofollow">六 套接字的缓冲区以及阻塞模式</a></li><li><ul><li><a href="#1_765" rel="nofollow">1.缓冲区</a></li><li><a href="#2writesend_779" rel="nofollow">2.使用write/send发送数据</a></li><li><a href="#3readrecv_791" rel="nofollow">3.使用read/recv读取数据</a></li></ul> 
   </li><li><a href="#__802" rel="nofollow">七 总结套接字收发数据的过程</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_Socket_1"></a>一 什么是套接字Socket</h3> 
<h4><a id="1Socket_2"></a>1.Socket简介</h4> 
<p>所谓套接字(Socket)，就是对网络中不同主机上的应用进程之间进行双向通信的端点的抽象。一个套接字就是网络上进程通信的一端，提供了应用层进程利用网络协议交换数据的机制。从所处的地位来讲，套接字上联应用进程，下联网络协议栈，是应用程序通过网络协议进行通信的接口，是应用程序与网络协议根进行交互的接口 。<br> <img src="https://images2.imgbox.com/ba/f6/AyjgBSFO_o.png" alt="在这里插入图片描述"></p> 
<p><strong>Socket</strong>(套接字)可以看成是两个网络应用程序进行通信时，各自通信连接中的端点，这是一个逻辑上的概念。它是网络环境中进程间通信的API(应用程序编程接口)，也是可以被命名和寻址的通信端点，使用中的每一个套接字都有其类型和一个与之相连进程。通信时其中一个网络应用程序将要传输的一段信息写入它所在主机的 Socket中，该 Socket通过与网络接口卡(NIC)相连的传输介质将这段信息送到另外一台主机的 Socket中，使对方能够接收到这段信息。 Socket是由IP地址和端口结合的，提供向应用层进程传送数据包的机制 。</p> 
<h4><a id="2Socketdomain_7"></a>2.Socket的域（domain）</h4> 
<p>域指定套接字通信中使用的网络介质。最常见的套接字域是 AF_INET（IPv4）或者AF_INET6(IPV6)，它是指 Internet 网络，许多 Linux 局域网使用的都是该网络，当然，因特网自身用的也是它。</p> 
<h4><a id="3Sockettype_9"></a>3.Socket主要类型（type）</h4> 
<ol><li><font color="#dd0000">流套接字(<strong>SOCK_STREAM</strong>)</font><br> 流套接字用于提供面向连接、可靠的数据传输服务。该服务将保证数据能够实现无差错、无重复送，并按顺序接收。流套接字之所以能够实现可靠的数据服务，原因在于其使用了传输控制协议，即TCP(The Transmission Control Protocol)协议 。</li><li><font color="#dd0000">数据报套接字(<strong>SOCK_DGRAM</strong>)</font><br> 数据报套接字提供一种无连接的服务。该服务并不能保证数据传输的可靠性,数据有可能在传输过程中丢失或出现数据重复，且无法保证顺序地接收到数据。数据报套接字使用UDP( User DatagramProtocol)协议进行数据的传输。由于数据报套接字不能保证数据传输的可靠性，对于有可能出现的数据丢失情况，需要在程序中做相应的处理 。</li><li><font color="#dd0000">原始套接字(<strong>SOCK_RAW</strong>)</font><br> 原始套接字与标准套接字(标准套接字指的是前面介绍的流套接字和数据报套接字)的区别在于：原始套接字可以读写内核没有处理的IP数据包，而流套接字只能读取TCP协议的数据，数据报套接字只能读取UDP协议的数据。因此，如果要访问其他协议发送的数据必须使用原始套接 。</li></ol> 
<h4><a id="4Socket_16"></a>4.Socket基本工作流程</h4> 
<p>要通过互联网进行通信，至少需要一对套接字，其中一个运行于客户端，我们称之为 Client Socket，另一个运行于服务器端，我们称之为 Server Socket 。根据连接启动的方式以及本地套接字要连接的目标，套接字之间的连接过程可以分为三个步骤 ：</p> 
<ol><li><font color="#00dd00">服务器监听</font><br> 所谓服务器监听，是指服务器端套接字并不定位具体的客户端套接字，而是处于等待连接的状态，实时监控网络状态 。</li><li><font color="#00dd00">客户端请求</font><br> 所谓客户端请求，是指由客户端的套接字提出连接请求，要连接的目标是服务器端的套接字。为此，客户端的套接字必须首先描述它要连接的服务器的套接字，指出服务器端套接字的地址和端口号，然后就向服务器端接字提出连接请求 。</li><li><font color="#00dd00">连接确认</font><br> 所谓连接确认，是指当服务器端套接字监听到或者说接收到客户端套接字的连接请求，就会响应客户端套接字的请求，建立一个新的线程，并把服务器端套接字的描述发送给客户端。一旦客户端确认了此描述，连接就建立好了。而服务器端套接字继续处于监听状态，接收其他客户端套接字的连接请求 。</li></ol> 
<h3><a id="_Socket_24"></a>二 创建套接字Socket</h3> 
<h4><a id="1socket_25"></a>1.socket函数</h4> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
1.函数功能：创建套接字
2.参数：
	int domain：套接字的域通常为 AF_INET（IPv4）或者AF_INET6(IPV6)
	int type：套接字类型通常为 SOCK_STREAM、SOCK_DGRAM
	int protocol：
							 0 ：使用默认协议
					IPPROTO_TCP：使用TCP协议
					IPPROTO_UDP：使用UDP协议
3.返回值：
		成功:返回套接字描述符
		失败：-1
*/</span>
</code></pre> 
<h3><a id="_Socket_43"></a>三 绑定套接字Socket与主机网络地址</h3> 
<h4><a id="1bind_44"></a>1.bind函数</h4> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span><span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
1.函数功能：绑定套接字Socket与主机网络地址信息
2.参数：
	int sockfd：				 套接字描述符
	const struct sockaddr *addr：主机地址信息，下文详解
	socklen_t addrlen：			 参数2的长度（字节）
3.返回值：
		成功:0
		失败：-1
*/</span>
</code></pre> 
<h4><a id="2struct_sockaddrstruct_sockaddr_in_58"></a>2.struct sockaddr与struct sockaddr_in</h4> 
<pre><code class="prism language-c"><span class="token comment">//以下主要摘自LINUX手册</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> <span class="token class-name">sa_family_t</span><span class="token punctuation">;</span>
<span class="token comment">/* Structure describing a generic socket address.翻译:描述通用套接字地址的结构  */</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token punctuation">{<!-- --></span>    
          			<span class="token class-name">sa_family_t</span> sa_family<span class="token punctuation">;</span><span class="token comment">//地址族</span>
 					<span class="token keyword">char</span>    sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//14字节，包含套接字中的目标地址和端口信息  </span>
				<span class="token punctuation">}</span>

<span class="token comment">/* Structure describing an Internet socket address.翻译：描述Internet套接字地址的结构  */</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token punctuation">{<!-- --></span>
						<span class="token class-name">sa_family_t</span>    sin_family<span class="token punctuation">;</span> <span class="token comment">/* address family: AF_INET */</span>
               			<span class="token class-name">in_port_t</span>      sin_port<span class="token punctuation">;</span>   <span class="token comment">/* port in network byte order */</span>
               			<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> sin_addr<span class="token punctuation">;</span>   <span class="token comment">/* internet address */</span>
    					<span class="token keyword">char</span>		   sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//占位不使用，用来与struct sockaddr对齐</span>
					<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* Internet address */</span>
<span class="token keyword">struct</span> <span class="token class-name">in_addr</span>  <span class="token punctuation">{<!-- --></span>
			<span class="token comment">/*uint32_t*/</span> <span class="token class-name">in_addr_t</span>  s_addr<span class="token punctuation">;</span><span class="token comment">/* address in network byte order地址的网络字节序 */</span>
				<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*sin_addr  is  the  IP host address. 
 The s_addr member of struct in_addr contains the host interface address in network byte order. 
 翻译：sin_addr为主机IP地址。struct in_addr的s_addr成员以网络字节顺序包含主机接口地址*/</span>
</code></pre> 
<ol><li>这两个结构体一样大，都是16个字节，而且都有family属性，二者是并列结构，指向sockaddr_in结构的指针也可以指向sockaddr。不同的是：<br> <font color="#00dd00">sockaddr</font>结构体中<font color="#660000"><strong>sa_data</strong></font>成员融合了端口与地址信息，而<font color="#00dd00">sockaddr_in</font>结构体用两个成员<font color="#660000"><strong>sin_port</strong></font>和<font color="#660000"><strong>sin_addr</strong></font>分别表示端口号和地址信息</li><li>sin_port和sin_addr都必须是网络字节序（<strong>NBO</strong> Network byte order），一般可视化的数字都是主机字节序（<strong>HBO</strong> Host byte order），<strong>下文详解</strong>。</li><li>sockaddr是给操作系统用的。程序员应使用sockaddr_in来表示地址，把类型、ip地址、端口填充sockaddr_in结构体，然后强制转换成sockaddr，作为参数传递给系统调用函数。sockaddr_in用于socket定义和赋值；sockaddr用于函数参数。</li></ol> 
<p><strong>示例</strong>：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serverAddr<span class="token punctuation">;</span>
sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 填充struct sockaddr_in */</span>
<span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化为0状态 主要是对成员sin_zero[8]清0</span>
serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span> <span class="token comment">//设置地址家族</span>
serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>SERV_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//端口号1024-65535</span>
serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 强制转换成struct sockaddr */</span>
<span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="3_103"></a>3.常用填充地址信息的方法</h4> 
<pre><code class="prism language-c"><span class="token comment">//填充IP地址</span>
serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//0.0.0.0 等号后面可以是htonl(0)或者0</span>
serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//填充端口</span>
serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">1234</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//端口号1024-65535</span>
serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//随机端口 等号后面可以 0</span>
</code></pre> 
<p>相关函数：<br> <strong>1. inet_addr</strong></p> 
<pre><code class="prism language-c"><span class="token class-name">in_addr_t</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
功能：点分字符串格式地址转网络格式
参数：IPv4地址字符串例如"127.0.0.1"
返回值：
		成功：返回网络字节序的地址用于赋值serverAddr.sin_addr.s_addr
		失败：-1
*/</span>
</code></pre> 
<p><strong>2.inet_ntoa 、inet_aton</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">inet_ntoa</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">in_addr</span> in<span class="token punctuation">)</span> <span class="token comment">//net to ascii</span>
<span class="token comment">/*
功能：网络字节序地址转点分字符串格式地址
参数：传入通用的网络字节序地址struct in_addr sin_addr
返回值：
		成功：返回指针指向IPv4点分字符串格式地址 例如"127.0.0.1"
		失败：0
*/</span>
<span class="token keyword">int</span> <span class="token function">inet_aton</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token operator">*</span>inp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ascii to net</span>
<span class="token comment">/*
功能：点分字符串格式地址转网络格式地址
参数：
		 cp:IPv4点分字符串格式地址
		inp：网络字节序地址struct in_addr sin_addr
返回值：
		成功：非0
		失败：0
*/</span>
</code></pre> 
<p><strong>4.htons、htonl</strong></p> 
<pre><code class="prism language-c"><span class="token class-name">uint16_t</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> hostshort<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//h host n net s short</span>
<span class="token class-name">uint32_t</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> hostlong<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//h host n net l long</span>
<span class="token comment">/*
功能：将主机字节序的short/long类型数据转为网络字节序类型数据
参数：
		short类型数据/long类型
返回值：
		成功：网络字节序类型数据
		失败：-1
*/</span>
</code></pre> 
<p><strong>5.inet_pton</strong>、<strong>inet_ntop</strong><br> 这两个函数是随IPv6出现的函数，对于IPv4地址和IPv6地址都适用，函数中p和n分别代表表达（presentation)和数值（numeric)。地址的表达格式通常是ASCII字符串，数值格式则是存放到套接字地址结构的二进制值。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">inet_pton</span><span class="token punctuation">(</span><span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>addrptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//返回值：若成功则为1，若输入不是有效的表达式则为0，若出错则为-1</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">inet_ntop</span><span class="token punctuation">(</span><span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>addrptr<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>strptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//返回值：若成功则为指向结构的指针，若出错则为NULL</span>
</code></pre> 
<h4><a id="4_172"></a>4.主机字节序与网络字节序</h4> 
<p>NBO : 网络字节序<br> HBO : 主机字节序<br> LE little-endian：小端<br> BE big-endian：大端</p> 
<ol><li>网络字节序和主机字节序：<br> <font color="#00dddd">网络数据流的地址规定</font>：先发出的数据是低地址，后发出的数据是高地址。<br> 发送主机通常将发送缓冲区中的数据按内存地址从低到高的顺序发出，为了不使数据流乱序，接收主机也会把从网络上接收的数据按内存地址从低到高的顺序保存在接收缓冲区中。<br> <font color="#00dddd">TCP/IP协议规定</font>：网络数据流应采用大端字节序，即低地址高字节。</li></ol> 
<blockquote> 
 <p>tcp/ip规定它们的网络字节序都是大端字节序。主机字节序可能是大端也可能是小端，与<strong>主机的cpu有关，与操作系统无关</strong>考虑到与协议的一致以及与同类其它平台产品的互通，在程序中发数据包时，将主机字节序转换为网络字节序，收数据包处将网络字 节序转换为主机字节序。网络程序开发时 或是跨平台开发时 应该注意保证只用一种字节序 不然两方的解释不一样就会产生bug。数据在传输的过程中，一定有一个标准化的过程，也就是说：<br> 从主机a到主机b进行通信：a的主机字节序——网络字节序——b的主机字节序</p> 
</blockquote> 
<ol start="2"><li>大端字节序和小端字节序：<br> 大端字节序存储时值的高位存储在较小的地址，值的低位存储在较大的地址。<br> 小端字节序存储时值的高位存储在较大的地址，值的低位存储在较小的地址。<br> 以0x12345678为例：<br> 地址：0x1000  0x1001  0x1002  0x1003<br> 小端： 78    56    34    12<br> 大端： 12    34    56    78</li><li>测试主机是大端还是小端的方法：</li></ol> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">union</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">short</span> s<span class="token punctuation">;</span>
		<span class="token keyword">char</span> c<span class="token punctuation">[</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>un<span class="token punctuation">;</span>
	un<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token number">0x0102</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span>un<span class="token punctuation">.</span>c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> un<span class="token punctuation">.</span>c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Big-Endian\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>un<span class="token punctuation">.</span>c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> un<span class="token punctuation">.</span>c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Little-Endian\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unknown\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
		<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"sizeof(short)=%d\n"</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_UDP_214"></a>四 UDP通信的实现</h3> 
<p>在创建并绑定套接字之后，我们就可以尝试TCP、UDP通信了。<br> TCP/IP协议是一个协议簇。里面包括很多协议，UDP只是其中的一个。</p> 
<ul><li>UDP（User Datagram Protocol用户数据报协议）是一个非连接的协议，传输数据之前源端和终端不建立连接， 当它想传送时就简单地去抓取来自应用程序的数据，并尽可能快地把它扔到网络上。 在发送端，UDP传送数据的速度仅仅是受应用程序生成数据的速度、 计算机的能力和传输带宽的限制； 在接收端，UDP把每个消息段放在队列中，应用程序每次从队列中读一个消息段。</li><li>UDP 是不具有可靠性的数据报协议。细微的处理它会交给上层的应用去完成。在 UDP 的情况下，虽然可以确保发送消息的大小，却不能保证消息一定会到达。因此，应用有时会根据自己的需要进行重发处理。</li></ul> 
<h4><a id="1recvfrom_219"></a>1.recvfrom函数</h4> 
<pre><code class="prism language-c"><span class="token class-name">ssize_t</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>src_addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
功能：接收数据
参数：
		int sockfd：socket函数的返回值，套接字描述符
		 void *buf：存放收到的数据
		size_t len：参数2的大小
		 int flags：如果没有数据到来 阻塞等待还是不等待 0表示阻塞 MSG_DONTWAIT 不等待
		 
	   struct sockaddr *src_addr：用于获取发送方的地址信息
	          socklen_t *addrlen：发送方地址信息长度 注意：传的实参必须初始化
返回值：
		成功：返回实际收到的字节数
		失败：-1
*/</span>
</code></pre> 
<h4><a id="2sendto_237"></a>2.sendto函数</h4> 
<pre><code class="prism language-c"><span class="token class-name">ssize_t</span> <span class="token function">sendto</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>dest_addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
功能：发送数据给对端
参数：
		 int sockfd：socket函数的返回值，套接字描述符
	const void *buf：要发送的数据存放的地址
		 size_t len：参数2的大小
		  int flags：套接字缓存满 阻塞还是不阻塞 0表示阻塞 MSG_DONTWAIT 不阻塞
		 
	const struct sockaddr *dest_addr：目标端的地址信息
	              socklen_t *addrlen：目标端的地址信息
返回值：
		成功：返回实际发送的字节数
		失败：-1
*/</span>
</code></pre> 
<h4><a id="3_255"></a>3.示例</h4> 
<p>实现服务器端与客户端聊天<br> <strong>运行效果</strong>：<br> <img src="https://images2.imgbox.com/94/96/rADvFYGT_o.gif" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token comment">/***************************/</span>
<span class="token comment">/*         服务器端         */</span>
<span class="token comment">/***************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;strings.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> buf_data<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">/*创建套接字*/</span>
        <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_DGRAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sockfd:%d\n"</span><span class="token punctuation">,</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/*定义网络地址结构体变量并填充*/</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> myselfAddr<span class="token punctuation">;</span>
	myselfAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	myselfAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把短整形转为网络格式</span>
	myselfAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主机格式转网络格式</span>

	<span class="token comment">/*套接字与主机绑定*/</span>
	<span class="token keyword">int</span> ret_bind <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>myselfAddr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>myselfAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret_bind <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*缓存用于获取对端网络地址信息*/</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> buf_sockaddr<span class="token punctuation">;</span>
	<span class="token class-name">socklen_t</span> buf_addrlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_sockaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"等待客户端连接...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> ret_recv <span class="token operator">=</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf_sockaddr<span class="token punctuation">,</span><span class="token operator">&amp;</span>buf_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ret_recv <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recvfrom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"IP:%s:%s\n"</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>buf_sockaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">bzero</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">gets</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">ssize_t</span> ret_send <span class="token operator">=</span> <span class="token function">sendto</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>buf_data<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf_sockaddr<span class="token punctuation">,</span>buf_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>ret_send <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"sendto"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"我：%s\n"</span><span class="token punctuation">,</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token class-name">ssize_t</span> ret_recv <span class="token operator">=</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf_sockaddr<span class="token punctuation">,</span><span class="token operator">&amp;</span>buf_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>ret_recv <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recvfrom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"IP:%s:%s\n"</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>buf_sockaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/***************************/</span>
<span class="token comment">/*           客户端        */</span>
<span class="token comment">/***************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;strings.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> buf_data<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\0"</span><span class="token punctuation">;</span>
	<span class="token comment">/*创建套接字*/</span>
	<span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_DGRAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sockfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sockfd:%d\n"</span><span class="token punctuation">,</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/*输入并配置对端网络地址信息*/</span>
	<span class="token keyword">short</span> port<span class="token punctuation">;</span>
	<span class="token keyword">char</span> IP<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"输入对方IP:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span>IP<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"输入对方端口号:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%hd"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serverAddr<span class="token punctuation">;</span>
	serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//短整型转为网络格式</span>
	serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>IP<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//字符串格式转网络地址格式</span>

	<span class="token comment">/*缓存用于获取对端的网络地址信息*/</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> buf_sockaddr<span class="token punctuation">;</span>
	<span class="token class-name">socklen_t</span> buf_addrlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_sockaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">/*发送信息*/</span>
			<span class="token function">bzero</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">gets</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">ssize_t</span> ret_send <span class="token operator">=</span> <span class="token function">sendto</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>buf_data<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>ret_send <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"sendto"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>		
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"我：%s\n"</span><span class="token punctuation">,</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">bzero</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">/*接收信息*/</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">bzero</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">ssize_t</span> ret_recv <span class="token operator">=</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf_sockaddr<span class="token punctuation">,</span><span class="token operator">&amp;</span>buf_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>ret_recv <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"recvfrom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"IP:%s:%s\n"</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>buf_sockaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="_TCP_446"></a>五 TCP通信的实现</h3> 
<ul><li>TCP（Transmission Control Protocol，传输控制协议）是面向连接的协议，也就是说，在收发数据前，必须和对方建立可靠的连接。</li><li>TCP 是面向连接的、可靠的流协议。流就是指不间断的数据结构，当应用程序采用 TCP 发送消息时，虽然可以保证发送的顺序，但还是犹如没有任何间隔的数据流发送给接收端。TCP 为提供可靠性传输，实行“顺序控制”或“重发控制”机制。此外还具备“流控制（流量控制）”、“拥塞控制”、提高网络利用率等众多功能。</li></ul> 
<h4><a id="1listenserver_450"></a>1.listen函数（server端）</h4> 
<ul><li>对于服务器端程序，使用<font color="#00dd00">bind</font> 函数绑定套接字后，还需要使用<font color="#00dd00">listen</font> 函数让套接字进入<font color="#dd0000">被动监听状态</font>，再调用<font color="#00dd00">accept</font> 函数，就可以随时响应客户端的请求了。</li><li>所谓被动监听，是指当没有客户端请求时，套接字处于“<strong>睡眠</strong>”状态，只有当接收到客户端请求时，套接字才会被“<strong>唤醒</strong>”来响应请求。</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
功能：使套接字进入被动监听状态
参数：
		 int sockfd： 需要进入监听状态的套接字
		int backlog：请求队列的最大长度
返回值：
		成功：0
		失败：-1
*/</span>
</code></pre> 
<ul><li>当套接字正在处理客户端请求时，如果有新的请求进来，套接字是没法处理的，只能把它放进缓冲区，待当前请求处理完毕后，再从缓冲区中读取出来处理。如果不断有新的请求进来，它们就按照先后顺序在缓冲区中排队，直到缓冲区满。这个缓冲区，就称为 <font color="#0000dd">请求队列（Request Queue）</font></li><li>当请求队列满时，就不再接收新的请求，对于 Linux，客户端会收到 ECONNREFUSED 错误</li><li>listen只是让套接字处于监听状态，并没有接收请求。接收请求需要使用 accept函数</li></ul> 
<h4><a id="2acceptserver_470"></a>2.accept函数（server端）</h4> 
<ul><li>当套接字处于监听状态时，可以通过 accept函数来接收客户端请求。</li><li>listen只是让套接字进入监听状态，并没有真正接收客户端请求，listen后面的代码会继续执行，直到遇到 accept</li><li>accept 会<font color="#dd0000">阻塞</font>程序执行，直到有新的请求到来。</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
功能：处理来自客户端的连接请求
参数：
	 		   int sockfd： 处于监听状态的套接字（服务器绑定的套接字也叫监听套接字）
	struct sockaddr *addr：用于获取对端的地址信息
	   socklen_t *addrlen：参数2的大小
返回值：
		成功：返回一个新的套接字（这个套接字与当前发起申请的客户端连接）
		失败：-1
*/</span>
</code></pre> 
<h4><a id="3connectclient_487"></a>3.connect函数（client端）</h4> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
功能：客户端发起连接服务器请求
参数：
	 		         int sockfd：client套接字
	const struct sockaddr *addr：对端（服务器）的地址信息
	         socklen_t *addrlen：参数2的大小
返回值：
		成功：0
		失败：-1
*/</span>
</code></pre> 
<h4><a id="4writeread_502"></a>4.write与read函数</h4> 
<blockquote> 
 <p>建立好了 TCP 连接之后，我们就可以把得到的 sockfd 当作文件描述符来使用。</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token class-name">ssize_t</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ssize_t</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>需要注意 <font color="#dd0000"><strong>read</strong></font> 函数的返回值：</p> 
<ul><li>retval &gt; 0 ：实际读到的字节数</li><li>retval = 0 ：<br>      普通文件 — 到达文件末尾<br>      管道文件 — 管道写端关闭<br>      套接字文件 — 对端关闭，网络断开</li><li>retval &lt; 0 ：出错</li></ul> 
<h4><a id="5sendrecv_518"></a>5.send与recv函数</h4> 
<p>recv 和 send 函数提供了和 read 和 write 差不多的功能。前3个参数同read、write，第4<br> 个参数用来控制读写操作。</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token class-name">ssize_t</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nbytes<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
参数 int flags：
				0：等同于write
	MSG_DONTROUTE：告诉 IP 目的主机在本地网络上面，没有必要查找表，这个标志一般用网络诊断和路由程序里面
		  MSG_OOB：表示可以接收和发送带外的数据
	 MSG_DONTWAIT：仅本操作非阻塞（执行完恢复阻塞模式）
*/</span>
<span class="token class-name">ssize_t</span> <span class="token function">recv</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nbytes<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
参数 int flags：
			    0：等同于read
		 MSG_PEEK：表示只是从系统缓冲区中读取内容，而不清除系统缓冲区的内容
		  MSG_OOB：表示可以接收和发送带外的数据
	 MSG_DONTWAIT：仅本操作非阻塞（执行完恢复阻塞模式）
	  MSG_WAITALL：表示等到所有的信息到达时才返回。使用这个标志的时候 recv 会一直阻塞，直到指定的条件满足，或者是发生了错误：
			  		1.当读到了指定的字节时，函数正常返回。返回值等于 len
					2.当读到了文件的结尾时，函数正常返回。返回值小于 len
					3.当操作发生错误时，返回 -1，且设置错误为相应的错误号 (errno) 
*/</span>
</code></pre> 
<h4><a id="6_545"></a>6.示例</h4> 
<p>实现客户端与服务器端的对话，服务器端运行时命令行传参端口号，客户端运行时命令行传参服务器的IP和端口号<br> 关于程序中用到的IO多路复用<strong>select</strong>函数，参考<a href="https://blog.csdn.net/qq_41796226/article/details/126337024">select函数详解</a></p> 
<p><strong>运行效果</strong>：<br> <img src="https://images2.imgbox.com/06/9c/hSifafQL_o.gif" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token comment">/***************************/</span>
<span class="token comment">/*        服务器端         */</span>
<span class="token comment">/***************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;strings.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> func<span class="token punctuation">,</span><span class="token keyword">int</span> retval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">error_of_read</span><span class="token punctuation">(</span><span class="token keyword">int</span> retval<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> IP<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">sigFun</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s Port"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">signal</span><span class="token punctuation">(</span>SIGCHLD<span class="token punctuation">,</span>sigFun<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf_data<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">/*创建套接字——监听套接字*/</span>
	<span class="token keyword">int</span> listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">,</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/*绑定监听套接字与主机网络地址信息*/</span>
	<span class="token keyword">int</span> on <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret_set <span class="token operator">=</span> <span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>on<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>on<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//地址复用</span>
	<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"setsockopt"</span><span class="token punctuation">,</span>ret_set<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serverAddr<span class="token punctuation">;</span>
	serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret_bind <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">,</span>ret_bind<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/*设置监听队列的大小*/</span>
	<span class="token keyword">int</span> ret_listen <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">,</span>ret_listen<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/*监听等待连接*/</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> buf_addr<span class="token punctuation">;</span>
	<span class="token class-name">socklen_t</span> buf_addrlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"服务器持续监听中\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"连接服务器的客户端数量：%d\n"</span><span class="token punctuation">,</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> newconfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buf_addr<span class="token punctuation">,</span><span class="token operator">&amp;</span>buf_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回分机套接字</span>
		<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">,</span>newconfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">pid_t</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"FATHERPID:%d  CHILDPID:%d\n"</span><span class="token punctuation">,</span><span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"与IP:| %s |建立连接\n"</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>buf_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token comment">/*在这里做一个IO多路复用*/</span>
				fd_set readfds<span class="token punctuation">;</span>
				<span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">FD_SET</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">FD_SET</span><span class="token punctuation">(</span>newconfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">int</span> ret_select <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>newconfd<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"select"</span><span class="token punctuation">,</span>ret_select<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">/*select返回表示有描述符就绪*/</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//检查标准输入是否被置位</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token class-name">ssize_t</span> ret_read <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">,</span>ret_read<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">ssize_t</span> ret_write <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>newconfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">,</span>ret_write<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"我:%s\n"</span><span class="token punctuation">,</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>newconfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//检查套接字是否被置位</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token class-name">ssize_t</span> ret_read <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>newconfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">error_of_read</span><span class="token punctuation">(</span>ret_read<span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>buf_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s:%s\n"</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>buf_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">/*关闭套接字*/</span>
	<span class="token comment">//close(newconfd);</span>
	<span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> func<span class="token punctuation">,</span><span class="token keyword">int</span> retval<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>retval <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">error_of_read</span><span class="token punctuation">(</span><span class="token keyword">int</span> retval<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> IP<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>retval<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>retval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s 已断开连接,此进程结束\n"</span><span class="token punctuation">,</span>IP<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">sigFun</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	count<span class="token operator">--</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"有子进程退出已经收尸\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token comment">/***************************/</span>
<span class="token comment">/*          客户端         */</span>
<span class="token comment">/***************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;strings.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> func<span class="token punctuation">,</span><span class="token keyword">int</span> retval<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s IP Port\n"</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">char</span> buf_data<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">/*创建套接字*/</span>
	<span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">,</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/*连接*/</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> serverAddr<span class="token punctuation">;</span>
	serverAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	serverAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret_connect <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>serverAddr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">,</span>ret_connect<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/*发送数据*/</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">/*在这里做一个IO多路复用*/</span>
		fd_set readfds<span class="token punctuation">;</span>
		<span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">FD_SET</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">FD_SET</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> ret_select <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>sockfd<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"select"</span><span class="token punctuation">,</span>ret_select<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/*select返回表示有描述符就绪*/</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//检查标准输入是否被置位</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token class-name">ssize_t</span> ret_read <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">,</span>ret_read<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">ssize_t</span> ret_write <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">,</span>ret_write<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"我:%s\n"</span><span class="token punctuation">,</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//检查套接字是否被置位</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token class-name">ssize_t</span> ret_read <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span><span class="token operator">&amp;</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">,</span>ret_read<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s:%s\n"</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>serverAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">,</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf_data<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*关闭套接字*/</span>
	<span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">error_Handling</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> func<span class="token punctuation">,</span><span class="token keyword">int</span> retval<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>retval <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="__762"></a>六 套接字的缓冲区以及阻塞模式</h3> 
<p><img src="https://images2.imgbox.com/cb/12/1jqaYGN1_o.png" alt="在这里插入图片描述"><br> 参考<a href="https://blog.csdn.net/daaikuaichuan/article/details/83061726?spm=1001.2014.3001.5506">socket套接字及缓冲区详解</a></p> 
<h4><a id="1_765"></a>1.缓冲区</h4> 
<ul><li>每个 socket 被创建后，都会分配两个缓冲区，<font color="#00dddd">输入缓冲区</font> 和 <font color="#00dddd">输出缓冲区</font></li><li><font color="#0000dd">write()/send()/send to()</font> 函数并不立即向网络中传输数据，而是先将数据写入缓冲区中，再由TCP协议将数据从缓冲区发送到目标机器。<strong>一旦将数据写入到缓冲区，函数就可以成功返回</strong>，不管它们有没有到达目标机器，也不管它们何时被发送到网络，这些都是TCP协议负责的事情。</li><li><font color="#0000dd">read()/recv()/recefrom()</font> 函数也是如此，也从输入缓冲区中读取数据，而不是直接从网络中读取。</li><li>每个套接字的I/O缓冲区单独存在。</li><li>即使一端关闭套接字，也会继续传送这端套接字输出缓冲区中遗留的数据。</li><li>如果一端关闭套接字，这端将丢失输入缓冲区中的数据。</li><li><font color="#dd0000"> <strong>默认情况下，套接字为阻塞模式</strong></font></li></ul> 
<pre><code class="prism language-c"><span class="token comment">//把套接字设置成非阻塞模式</span>
<span class="token function">fcntl</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> flags <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//非阻塞模式的使用并不普遍，因为非阻塞模式会浪费大量的CPU资源</span>
</code></pre> 
<h4><a id="2writesend_779"></a>2.使用write/send发送数据</h4> 
<p><strong>阻塞模式下：</strong></p> 
<ul><li>首先会检查<font color="#dd0000">输出缓冲区</font>，如果缓冲区的可用空间长度小于要发送的数据，那么 write()/send() 会被阻塞（暂停执行），直到缓冲区中的数据被发送到目标机器，腾出足够的空间，才唤醒 write()/send() 函数继续写入数据；</li><li>如果要写入的数据大于缓冲区的最大长度，那么将分批写入。直到所有数据被写入缓冲区 write()/send() 才能返回。</li><li>如果TCP协议正在向网络发送数据，那么输出缓冲区会被锁定，不允许写入，write()/send() 也会被阻塞，直到数据发送完毕缓冲区解锁，write()/send() 才会被唤醒。</li><li>send()函数默认情况下会使用Nagle算法。Nagle算法通过将未确认的数据存入缓冲区直到积攒到一定数量一起发送的方法，来降低主机发送零碎小数据包的数目。所以假设send()函数发送数据过快的话，该算法会将一些数据打包后统一发出去。通过setsockopt()的TCP_NODELAY选项来禁用Nagle算法。</li></ul> 
<p><strong>非阻塞模式下：</strong></p> 
<ul><li>write/send不做等待立即返回；</li><li>write()/send()函数的过程仅仅是将数据拷贝到协议栈的缓冲区而已，如果缓冲区可用空间不够，则尽可能拷贝，返回成功拷贝的大小；</li><li>如果缓存区可用空间为0，则返回-1，同时设置errno为EWOULDBLOCK。</li></ul> 
<h4><a id="3readrecv_791"></a>3.使用read/recv读取数据</h4> 
<p>read/recv函数返回其实际copy的字节数，如果recv在copy时出错，那么它返回SOCKET_ERROR；如果recv函数在等待协议接收数据时网络中断了，那么它返回0。<br> <strong>阻塞模式下：</strong></p> 
<ul><li>首先会检查<font color="#dd0000">输入缓冲区</font>，如果缓冲区中有数据，那么就读取，否则函数会被阻塞，直到网络上有数据到来；（如果数据正在从输入缓冲区拷贝到用户空间，read/recv也会被阻塞）</li><li>如果要读取的数据长度小于缓冲区中的数据长度，那么就不能一次性将缓冲区中的所有数据读出，剩余数据将不断积压，直到输入缓冲区满，协议栈不能再接收数据。</li></ul> 
<p><strong>非阻塞模式下：</strong></p> 
<ul><li>write/send不做等待立即返回；</li><li>成功返回实际读到的字节数；</li><li>如果输入缓冲区中没有数据，返回错误EWOULDBLOCK。</li></ul> 
<h3><a id="__802"></a>七 总结套接字收发数据的过程</h3> 
<p>TCP发送数据的过程：首先，TCP是有链接的可靠传输协议，所谓可靠也就是说保证客户端发送的数据服务端都能够收到，并且是按序收到。</p> 
<ol><li> <p>数据首先由应用程序缓冲区复制到发送端的输出缓冲区（位于内核），注意这个过程是用类似write功能的函数完成的。有的人通常看到write成功就以为数据发送到了对端主机，其实这是错误的，write成功仅仅表示数据成功的由应用进程缓冲区复制到了输出缓冲区。</p> </li><li> <p>然后内核协议栈将输出缓冲区中的数据发送到对端主机，注意这个过程不受应用程序控制，而是发送端内核协议栈完成，其中包括使用滑动窗口、拥塞控制等功能。</p> </li><li> <p>数据到达接收端主机的输入缓冲区，注意这个接收过程也不受应用程序控制，而是由接收端内核协议栈完成，其中包括发送ack确认等。</p> </li><li> <p>数据由套接字接收缓冲区复制到接收端应用程序缓冲区，注意这个过程是由类似read等函数来完成。</p> </li></ol> 
<p><strong>思考</strong>：如果TCP服务端一直sleep，客户端一直发送数据，会出现什么情况？</p> 
<ol><li>阻塞模式下：<br> 如果服务端一直sleep不接收数据，而客户端一直write，也就是只能执行上述过程中的前三步，这样最终结果肯定是接收端的输入缓冲区和发送端的输出缓冲区都被填满，这样write就无法继续将数据从应用程序复制到发送端的输出缓冲区了，从而使进程进入睡眠。</li><li>非阻塞情况下：<br> 服务端一直sleep，随着客户端write，接收端的输入缓冲区和发送端的输出缓冲区会被填满。当发送端的输出缓冲区的可用空间为0时，write立即返回-1，并将errno置为EWOULDBLOCK。</li></ol> 
<p><a href="http://www.hqyj.com/" rel="nofollow">“华清远见” http://www.hqyj.com/学习更多编程知识</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6ec933123503d592e95118cfeacf75f1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">电脑外放没声音但插入耳机有声音怎么回事</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d74a9a8ae82d81d5ddc7a8517d5627c5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">LeetCode——23. Merge k Sorted Lists（C&#43;&#43;）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>