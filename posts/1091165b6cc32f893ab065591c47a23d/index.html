<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Arduino开发之如何连接WIFI模块？ - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Arduino开发之如何连接WIFI模块？" />
<meta property="og:description" content="文章目录 0.引言1.WIFI模块说明2.安装ESP8266开发板库3.设置ESP8266连接WIFI4.Arduino通过ESP8266收发消息5.功能演示 0.引言 在硬件开发过程中，会将许多传感器组合，产生许多数据，这些数据需要传输到上位机进行数据融合处理才能实现硬件系统的功能，或许这些数据不急着处理，可以将数据存储到SD卡中，隔一段时间后再导出统一整理，但有时需要无线通信，远控硬件作出行动。对于无线传输控制硬件，蓝牙和WIFI都可以实现，但蓝牙更多的应用于连接设备，在传输速度上比WIFI慢，若需信息传输，可以选择WIFI。本文采用ESP8266-12E的WFI模块，在【Arduino如何进行开发？】基础上，阐述Arduino如何连接WIFI模块。
1.WIFI模块说明 WIF模块情况：
ESP8266(CP2102)，NodeMCU板载ESP-12E ( 4MB Flash) WIFI模组和USB转TTL串口(CP2102/ CH340)芯片,不用外接下载器，直接通过USB线与电脑相连，方便下载固件和调试。
引脚说明：
2.安装ESP8266开发板库 （1）将ESP8266模块通过USB连接电脑，在工具→端口选择端口，若端口不可选中，需要安装usb转串口通用驱动.EXE；
（2）在文件→首选项→其他开发板管理器地址，网址添加：
http://arduino.esp8266.com/stable/package_esp8266com_index.json
（3）在工具→开发板→开发板管理器，添加ESP8266库；
注：若因网络问题无法安装，下载ESP8266安装包，安装完成后重启Arduino，即可添加ESP8266库。
（4）在工具→管理库，添加pubsubclient库和ArduinoJson库。
3.设置ESP8266连接WIFI （1）设置热点名称、热点密码；
热点名称和密码为方便测试是否连接网络，可使用手机热点或者无线路由器。
若使用无线路由器，可在笔记本浏览器输入：tplogin.cn访问路由器管理网页。
（2）获取Sub、Pub的代码；
Sub、Pub的代码来自于易联智能物联网平台，获取步骤如下：
（3）编写设置代码；
ESP8266_SetWifi.ino
#include &lt;ESP8266WiFi.h&gt; #include &lt;PubSubClient.h&gt; #define BUILTIN_LED 2 char P_NAME[] = &#34;F305&#34;; //设置热点名称 char P_PSWD[] = &#34;f305f305&#34;; //设置热点密码 char sub[] = &#34;Sub/100326&#34;; //设置设备Sub代码 char pub[] = &#34;Pub/100326&#34;; //设置设备Pub代码 const char *ssid = P_NAME; const char *password = P_PSWD; const char *mqtt_server = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/1091165b6cc32f893ab065591c47a23d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-17T17:20:50+08:00" />
<meta property="article:modified_time" content="2023-04-17T17:20:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Arduino开发之如何连接WIFI模块？</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#0_1" rel="nofollow">0.引言</a></li><li><a href="#1WIFI_3" rel="nofollow">1.WIFI模块说明</a></li><li><a href="#2ESP8266_9" rel="nofollow">2.安装ESP8266开发板库</a></li><li><a href="#3ESP8266WIFI_19" rel="nofollow">3.设置ESP8266连接WIFI</a></li><li><a href="#4ArduinoESP8266_118" rel="nofollow">4.Arduino通过ESP8266收发消息</a></li><li><a href="#5_221" rel="nofollow">5.功能演示</a></li></ul> 
</div> 
<p></p> 
<h2><a id="0_1"></a>0.引言</h2> 
<p>  在硬件开发过程中，会将许多传感器组合，产生许多数据，这些数据需要传输到上位机进行数据融合处理才能实现硬件系统的功能，或许这些数据不急着处理，可以将数据存储到SD卡中，隔一段时间后再导出统一整理，但有时需要无线通信，远控硬件作出行动。对于无线传输控制硬件，蓝牙和WIFI都可以实现，但蓝牙更多的应用于连接设备，在传输速度上比WIFI慢，若需信息传输，可以选择WIFI。本文采用ESP8266-12E的WFI模块，在【<a href="https://blog.csdn.net/qq_40640910/article/details/129409097?spm=1001.2014.3001.5502">Arduino如何进行开发？</a>】基础上，阐述Arduino如何连接WIFI模块。</p> 
<h2><a id="1WIFI_3"></a>1.WIFI模块说明</h2> 
<p>  <img src="https://images2.imgbox.com/b2/1b/5LYNxoO9_o.png" alt="在这里插入图片描述" width="250"><br>   <strong>WIF模块情况</strong>：<br>   ESP8266(CP2102)，NodeMCU板载ESP-12E ( 4MB Flash) WIFI模组和USB转TTL串口(CP2102/ CH340)芯片,不用外接下载器，直接通过USB线与电脑相连，方便下载固件和调试。<br>   <strong>引脚说明：</strong><br>   <img src="https://images2.imgbox.com/3d/31/ZIPM0MaN_o.png" alt="在这里插入图片描述" width="600"></p> 
<h2><a id="2ESP8266_9"></a>2.安装ESP8266开发板库</h2> 
<p>  <strong>（1）将ESP8266模块通过USB连接电脑，在工具→端口选择端口，若端口不可选中，需要安装<a href="https://www.easyiothings.com/files/DocImage/Fast_1/usb%E8%BD%AC%E4%B8%B2%E5%8F%A3%E9%80%9A%E7%94%A8%E9%A9%B1%E5%8A%A8.EXE" rel="nofollow">usb转串口通用驱动.EXE</a>；</strong><br>   <strong>（2）在文件→首选项→其他开发板管理器地址，网址添加：</strong><br>   http://arduino.esp8266.com/stable/package_esp8266com_index.json<br>   <img src="https://images2.imgbox.com/f1/9f/QrMrvcah_o.png" alt="在这里插入图片描述" width="850"><br>   <strong>（3）在工具→开发板→开发板管理器，添加ESP8266库；</strong><br>   <img src="https://images2.imgbox.com/20/25/w2iqbyL8_o.png" alt="在这里插入图片描述" width="850"><br>   注：若因网络问题无法安装，下载<a href="https://www.easyiothings.com/files/DocImage/Fast_1/8266_package_3.0.1_arduino.cn.exe" rel="nofollow">ESP8266安装包</a>，安装完成后重启Arduino，即可添加ESP8266库。<br>   <strong>（4）在工具→管理库，添加pubsubclient库和ArduinoJson库。</strong><br>   <img src="https://images2.imgbox.com/64/d0/CjVEfwUa_o.png" alt="在这里插入图片描述" width="550"></p> 
<h2><a id="3ESP8266WIFI_19"></a>3.设置ESP8266连接WIFI</h2> 
<p>  <strong>（1）设置热点名称、热点密码；</strong><br>   热点名称和密码为方便测试是否连接网络，可使用手机热点或者无线路由器。<br>   若使用无线路由器，可在笔记本浏览器输入：tplogin.cn访问路由器管理网页。<br>   <strong>（2）获取Sub、Pub的代码；</strong><br>   Sub、Pub的代码来自于<a href="https://www.easyiothings.com/#/" rel="nofollow">易联智能物联网平台</a>，获取步骤如下：<br>   <img src="https://images2.imgbox.com/4f/69/D2GhWcAI_o.png" alt="在这里插入图片描述" width="850"><br>   <strong>（3）编写设置代码；</strong><br>   <strong>ESP8266_SetWifi.ino</strong></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ESP8266WiFi.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;PubSubClient.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUILTIN_LED</span> <span class="token expression"><span class="token number">2</span></span></span>
<span class="token keyword">char</span> P_NAME<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"F305"</span><span class="token punctuation">;</span>           <span class="token comment">//设置热点名称</span>
<span class="token keyword">char</span> P_PSWD<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"f305f305"</span><span class="token punctuation">;</span>       <span class="token comment">//设置热点密码</span>
<span class="token keyword">char</span> sub<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Sub/100326"</span><span class="token punctuation">;</span>    <span class="token comment">//设置设备Sub代码</span>
<span class="token keyword">char</span> pub<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Pub/100326"</span><span class="token punctuation">;</span>    <span class="token comment">//设置设备Pub代码</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ssid <span class="token operator">=</span> P_NAME<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>password <span class="token operator">=</span> P_PSWD<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mqtt_server <span class="token operator">=</span> <span class="token string">"easyiothings.com"</span><span class="token punctuation">;</span>
String reStr<span class="token punctuation">;</span>
WiFiClient espClient<span class="token punctuation">;</span>
PubSubClient <span class="token function">client</span><span class="token punctuation">(</span>espClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> lastMsg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MSG_BUFFER_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span></span></span>
<span class="token keyword">char</span> msg<span class="token punctuation">[</span>MSG_BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">setup_wifi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  WiFi<span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span>WIFI_STA<span class="token punctuation">)</span><span class="token punctuation">;</span>
  WiFi<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>ssid<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>WiFi<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> WL_CONNECTED<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">randomSeed</span><span class="token punctuation">(</span><span class="token function">micros</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>topic<span class="token punctuation">,</span> byte <span class="token operator">*</span>payload<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>payload<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    String clientId <span class="token operator">=</span> <span class="token string">"ESP8266Client"</span><span class="token punctuation">;</span>
    clientId <span class="token operator">+=</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>clientId<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>pub<span class="token punctuation">,</span> <span class="token string">"{\"State\":\"OnLine\"}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
      Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token function">pinMode</span><span class="token punctuation">(</span>BUILTIN_LED<span class="token punctuation">,</span> OUTPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setup_wifi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  client<span class="token punctuation">.</span><span class="token function">setServer</span><span class="token punctuation">(</span>mqtt_server<span class="token punctuation">,</span> <span class="token number">1883</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  client<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">digitalWrite</span><span class="token punctuation">(</span>BUILTIN_LED<span class="token punctuation">,</span> HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  client<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Serial<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    reStr <span class="token operator">=</span> Serial<span class="token punctuation">.</span><span class="token function">readStringUntil</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//检测json数据是否完整</span>
    <span class="token keyword">int</span> jsonBeginAt <span class="token operator">=</span> reStr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"{"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> jsonEndAt <span class="token operator">=</span> reStr<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jsonBeginAt <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> jsonEndAt <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      reStr <span class="token operator">=</span> reStr<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>jsonBeginAt<span class="token punctuation">,</span> jsonEndAt <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> str_len <span class="token operator">=</span> reStr<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">char</span> char_array<span class="token punctuation">[</span>str_len<span class="token punctuation">]</span><span class="token punctuation">;</span>
      reStr<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span>char_array<span class="token punctuation">,</span> str_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
      client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>pub<span class="token punctuation">,</span> char_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  <strong>（4）ArduinoIDE中开发板选择NodeMCU 1.0（ESP-12E Module），上传代码，查看ESP8266连接网络情况。</strong><br>   <img src="https://images2.imgbox.com/bd/9a/wMxBodMM_o.png" alt="在这里插入图片描述" width="850"></p> 
<h2><a id="4ArduinoESP8266_118"></a>4.Arduino通过ESP8266收发消息</h2> 
<p>  <strong>（1）将WIFI模块去掉USB线，连接到Arduino上，为测试数据收发，将时钟模块也连接到Arduino上；<br>   WIFI模块引脚说明：</strong><br>     “GND”：接Arduino的GND<br>     “3v3”：接Arduino的3v3<br>     “EN”：接Arduino的3v3<br>     “TX”：接Arduino的RXD<br>     “RX”：接Arduino的TXD<br>   <strong>时钟模块引脚说明：</strong><br>     “GND”：接Arduino的GND<br>     “VCC”：接Arduino的5V<br>     “SDA”：接Arduino的A4<br>     “SCL”：接Arduino的A5</p> 
<p>  <strong>（2）编写运行代码</strong><br>   <strong>Communiate_ThroughESP8266.ino</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/*
可实现功能：
  时钟模块的秒数上传到云平台，且云平台能发送指令被arduino接收。
接线：
  将ESP8266的Rx引脚接在Arduino的Tx上，Tx引脚接在Rx上。但下载代码时需将Rx与Tx的接线移除，否则程序会报错；
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ArduinoJson.h&gt;</span><span class="token comment">//导入JSON库，用来封装发送数据的格式</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Wire.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;DS3231.h&gt;</span></span>
StaticJsonDocument<span class="token operator">&lt;</span><span class="token number">500</span><span class="token operator">&gt;</span> sendJson<span class="token punctuation">;</span>          <span class="token comment">// 创建JSON对象，用来存放发送数据</span>
StaticJsonDocument<span class="token operator">&lt;</span><span class="token number">500</span><span class="token operator">&gt;</span> readJson<span class="token punctuation">;</span>          <span class="token comment">// 创建JSON对象，用来存放接收到的数据</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> lastUpdateTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token comment">//记录上次上传数据时间</span>
<span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> updateInterval <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span> <span class="token comment">// 在这里设置数据发送至云平台的时间间隔，单位为毫秒</span>
byte year<span class="token punctuation">;</span>
byte month<span class="token punctuation">;</span>
byte date<span class="token punctuation">;</span>
byte dOW<span class="token punctuation">;</span>
byte hour<span class="token punctuation">;</span>
byte minute<span class="token punctuation">;</span>
byte second<span class="token punctuation">;</span>
DS3231 dsTime<span class="token punctuation">;</span>
bool century <span class="token operator">=</span> false<span class="token punctuation">;</span>
bool h12Flag <span class="token operator">=</span> false<span class="token punctuation">;</span>
bool pmFlag <span class="token operator">=</span> false<span class="token punctuation">;</span>

<span class="token comment">//定义相关的变量</span>
<span class="token keyword">long</span> ID <span class="token operator">=</span> <span class="token number">100326</span><span class="token punctuation">;</span><span class="token comment">// 定义设备ID号,替换成云平台生成的ID号</span>
String DS3231TIME<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">;</span>      
<span class="token comment">// Arduino的初始化函数，仅在通电时运行一次</span>
<span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  Serial<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token number">9600</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化串口，用于和esp8266进行通信，完成数据的接收与上传</span>
  Wire<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Arduino的loop函数，当setup函数执行完毕后进入该函数并一直循环运行</span>
<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 该函数段可完成数据定时上报的功能，并且不会阻塞loop函数的运行</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> lastUpdateTime <span class="token operator">&gt;</span> updateInterval<span class="token punctuation">)</span> 
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">sendJsonData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lastUpdateTime <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 当用户使用手机或者网站控制当前设备时ESP8266会通过串口向Arduino发送指令，该函数段可判断串口有没有接收到消息，并完成对用户消息的解析</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>Serial<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 判断串口缓冲区是否有消息</span>
    String inputString <span class="token operator">=</span> Serial<span class="token punctuation">.</span><span class="token function">readStringUntil</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//从串口缓冲区读入数据，并赋值给inputString变量（String变量为Arduino独有变量类型，可以简化字符串操作）</span>
    <span class="token comment">//检测json数据是否完整，若通过则进行下一步的处理</span>
    <span class="token comment">/*
      云平台向硬件下发JSON的格式为 {TIME:1} 类型的字符串，通常叫键值对，C语言中叫做哈希表。经测试，在易联智能发送指令时，【接口名称】无法设置，指令只能从【控制指令】窗口发出，发出的指令为 {TIME:1} ，正常情况【接口名称】处选择TIME，然后再【控制指令】输入1，发送即可
    */</span>
    <span class="token keyword">int</span> jsonBeginAt <span class="token operator">=</span> inputString<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"{"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> jsonEndAt <span class="token operator">=</span> inputString<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"}"</span><span class="token punctuation">,</span>inputString<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"}"</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jsonBeginAt <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> jsonEndAt <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      inputString <span class="token operator">=</span> inputString<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>jsonBeginAt<span class="token punctuation">,</span> jsonEndAt <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//净化json数据</span>
      <span class="token function">deserializeJson</span><span class="token punctuation">(</span>readJson<span class="token punctuation">,</span> inputString<span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">//通过ArduinoJSON库将JSON字符串转换为方便操作的对象</span>
      <span class="token comment">// 判断接收的指令</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>readJson<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"TIME"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//判断云平台下发的消息是否包含TIME标识符，如果是则进行下一步处理</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DS3231TIME <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>readJson<span class="token punctuation">[</span><span class="token string">"TIME"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>DS3231TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">sendJsonData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//向云平台发送最新的信息</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  DS3231TIME<span class="token operator">=</span>dsTime<span class="token punctuation">.</span><span class="token function">getSecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//上传数值</span>
<span class="token keyword">void</span> <span class="token function">sendJsonData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 将数据添加到JSON对象中，左边为在云平台中定义的标识符，右边为变量</span>
  sendJson<span class="token punctuation">[</span><span class="token string">"ID"</span><span class="token punctuation">]</span> <span class="token operator">=</span> ID<span class="token punctuation">;</span>
  sendJson<span class="token punctuation">[</span><span class="token string">"TIME"</span><span class="token punctuation">]</span> <span class="token operator">=</span> DS3231TIME<span class="token punctuation">;</span>
  <span class="token comment">//将对象转换成字符串，并向ese8266发送消息</span>
  <span class="token function">serializeJson</span><span class="token punctuation">(</span>sendJson<span class="token punctuation">,</span> Serial<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  <strong>（3）上传代码</strong><br>   上传代码时，RX、TX先不要与Arduino上的TXD、RXD连接，不然会报错。<br>   <strong>（4）在云平台查看消息</strong><br>   <img src="https://images2.imgbox.com/1d/52/eiCZi7lZ_o.png" alt="在这里插入图片描述" width="850"></p> 
<h2><a id="5_221"></a>5.功能演示</h2> 
<p>  <strong>（1）Arduino发送消息</strong><br>   <img src="https://images2.imgbox.com/7e/f6/vsX5IGP0_o.png" alt="在这里插入图片描述" width="850"><br>   <strong>（2）Arduino接收消息</strong><br>   在云平台的【控制指令】处输入：{TIME:123}，点击发送。<br>   <img src="https://images2.imgbox.com/41/02/FuL4TWBY_o.png" alt="在这里插入图片描述" width="850"></p> 
<p>参考资料：<br> [1] cacrle. <a href="https://blog.csdn.net/qq_40640910/article/details/129409097?spm=1001.2014.3001.5502">Arduino如何进行开发？</a>; 2023-03-15 [accessed 2023-03-28].<br> [2] Cacra. <a href="https://blog.csdn.net/u014465934/article/details/80470236">Arduino 与 ESP8266 WIFI模块的连接</a>; 2018-05-27 [accessed 2023-03-28].<br> [3] Schdust. <a href="https://blog.csdn.net/m0_52991090/article/details/122157194?spm=1001.2101.3001.6650.2&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-2-122157194-blog-80470236.pc_relevant_vip_default&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-2-122157194-blog-80470236.pc_relevant_vip_default&amp;utm_relevant_index=3">Arduino连接ESP8266实现联网功能</a>; 2023-02-12 [accessed 2023-03-28].<br> [4] 凉西西工作室. <a href="https://blog.csdn.net/qq_45296007/article/details/115049304?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-2-115049304-blog-122295981.pc_relevant_vip_default&amp;spm=1001.2101.3001.4242.2&amp;utm_relevant_index=5">解决Arduino开发板管理器下载esp8266开发包失败和速度慢的方法</a>; 2021-03-21 [accessed 2023-03-28].<br> [5] 闪烁shimmer. <a href="https://blog.csdn.net/qq_55490300/article/details/122222132">A fatal error occurred: Failed to connect to ESP32: Timed out waiting for packet header</a>; 2022-01-19 [accessed 2023-03-28].<br> [6] 奈何col. <a href="https://arduino.me/a/esp8266" rel="nofollow">Arduino IDE安装esp8266 SDK</a>; 2018-3-28 [accessed 2023-03-28].</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9388804872cbb0d639c85a11bcee20d5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">2023 年 18 种最佳 Android 测试工具</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f9c0f482d853eb36b91e6fe89ffd3e63/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">NGINX解决第三方图片跨域问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>