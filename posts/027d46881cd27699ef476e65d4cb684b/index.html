<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>函数调用和汇编 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="函数调用和汇编" />
<meta property="og:description" content="文章目录 1 函数调用和汇编1.1 函数的调用约定1.2 堆栈平衡1.3 汇编码1.3.1 寄存器1.3.2 指令 1.4 栈帧1.4.1 开辟栈帧1.4.2 栈帧回退 2 汇编解析2.1 函数调用流程 1 函数调用和汇编 1.1 函数的调用约定 C函数的默认调用约定是__cdeclC&#43;&#43;全局函数和静态成员函数的默认调用约定是__stdcall类的成员函数的调用约定是__thiscall 函数生成符号不同
函数参数入栈顺序不同
void __stdcall swap(int a,int b) { int tmp = a; a = b; b = tmp; } 1.2 堆栈平衡 因为函数调用过程中，参数需要压栈，所以在函数调用结束后，用于函数调用的压栈参数也需要退栈。 调用约定堆栈平衡方式__stdcall函数自己平衡__cdecl调用者负责平衡__thiscall调用者负责平衡__fastcall调用者负责平衡__naked编译器不负责平衡，由编写者自己负责 1.3 汇编码 1.3.1 寄存器 寄存器ebp（base pointer ）：帧指针或基址指针，栈底指针寄存器esp（stack pointer）：栈指针，栈顶指针 1.3.2 指令 lea eax,dword ptr [b]：将b地址的偏移量保存到寄存器eax中mov ebp,esp：将esp指向内存中的数据保存到目的寄存器ebp中call swap()：将程序跳转到目标函数处执行。
首先将call指令的下一条指令的地址（当前指令地址寄存器EIP中的地址&#43;偏移量4个字节）压栈；
然后执行jump指令跳转到调用函数的入口，即函数的开始地址。ret：将栈顶保存的地址弹出到EIP中 #include&lt;iostream&gt; using namespace std; int swap(int a,int b) { int tmp = a; a = b; b = tmp; return a; } int main() { int a = 10; int b = 20; swap(a, b); return 0; } 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/027d46881cd27699ef476e65d4cb684b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-23T20:06:42+08:00" />
<meta property="article:modified_time" content="2021-11-23T20:06:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">函数调用和汇编</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1__4" rel="nofollow">1 函数调用和汇编</a></li><li><ul><li><a href="#11__5" rel="nofollow">1.1 函数的调用约定</a></li><li><a href="#12__19" rel="nofollow">1.2 堆栈平衡</a></li><li><a href="#13__31" rel="nofollow">1.3 汇编码</a></li><li><ul><li><a href="#131__32" rel="nofollow">1.3.1 寄存器</a></li><li><a href="#132__35" rel="nofollow">1.3.2 指令</a></li></ul> 
   </li><li><a href="#14__69" rel="nofollow">1.4 栈帧</a></li><li><ul><li><a href="#141__72" rel="nofollow">1.4.1 开辟栈帧</a></li><li><a href="#142__74" rel="nofollow">1.4.2 栈帧回退</a></li></ul> 
  </li></ul> 
  </li><li><a href="#2__77" rel="nofollow">2 汇编解析</a></li><li><ul><li><a href="#21__205" rel="nofollow">2.1 函数调用流程</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<h2><a id="1__4"></a>1 函数调用和汇编</h2> 
<h3><a id="11__5"></a>1.1 函数的调用约定</h3> 
<ul><li>C函数的默认调用约定是__cdecl</li><li>C++全局函数和静态成员函数的默认调用约定是__stdcall</li><li>类的成员函数的调用约定是__thiscall</li></ul> 
<blockquote> 
 <p>函数生成符号不同<br> 函数参数入栈顺序不同</p> 
</blockquote> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> __stdcall <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> tmp <span class="token operator">=</span> a<span class="token punctuation">;</span>
  a <span class="token operator">=</span> b<span class="token punctuation">;</span>
  b <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="12__19"></a>1.2 堆栈平衡</h3> 
<ul><li>因为函数调用过程中，参数需要压栈，所以在函数调用结束后，用于函数调用的压栈参数也需要退栈。</li></ul> 
<table><thead><tr><th align="center">调用约定</th><th align="center">堆栈平衡方式</th></tr></thead><tbody><tr><td align="center">__stdcall</td><td align="center">函数<mark>自己</mark>平衡</td></tr><tr><td align="center">__cdecl</td><td align="center">调用者负责平衡</td></tr><tr><td align="center">__thiscall</td><td align="center">调用者负责平衡</td></tr><tr><td align="center">__fastcall</td><td align="center">调用者负责平衡</td></tr><tr><td align="center">__naked</td><td align="center">编译器不负责平衡，由编写者自己负责</td></tr></tbody></table> 
<h3><a id="13__31"></a>1.3 汇编码</h3> 
<h4><a id="131__32"></a>1.3.1 寄存器</h4> 
<ul><li>寄存器ebp（base pointer ）：帧指针或基址指针，栈底指针</li><li>寄存器esp（stack pointer）：栈指针，栈顶指针</li></ul> 
<h4><a id="132__35"></a>1.3.2 指令</h4> 
<ul><li>lea eax,dword ptr [b]：将b地址的偏移量保存到寄存器eax中</li><li>mov ebp,esp：将esp指向内存中的数据保存到目的寄存器ebp中</li><li>call swap()：将程序跳转到目标函数处执行。<br> 首先将call指令的下一条指令的地址（当前指令地址寄存器EIP中的地址+偏移量4个字节）压栈；<br> 然后执行jump指令跳转到调用函数的入口，即函数的开始地址。</li><li>ret：将栈顶保存的地址弹出到EIP中</li></ul> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> tmp <span class="token operator">=</span> a<span class="token punctuation">;</span>
  a <span class="token operator">=</span> b<span class="token punctuation">;</span>
  b <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
	<span class="token function">swap</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/32/82/UxtkLi7G_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/aa/32/abE4QTmi_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/33/ac/h3Z7lpHl_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="14__69"></a>1.4 栈帧</h3> 
<ul><li>存储在用户栈上的，ebp栈底指针和esp栈顶指针之间的所有函数调用涉及的相关信息的记录单元；也叫做，过程活动记录。<br> <br></li></ul> 
<h4><a id="141__72"></a>1.4.1 开辟栈帧</h4> 
<p><img src="https://images2.imgbox.com/ae/d0/VDDwvpKb_o.png" alt="在这里插入图片描述" width="700"></p> 
<h4><a id="142__74"></a>1.4.2 栈帧回退</h4> 
<p><img src="https://images2.imgbox.com/53/7b/NGYvYJWW_o.png" alt="在这里插入图片描述" width="700"><br> <br></p> 
<h2><a id="2__77"></a>2 汇编解析</h2> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//当前栈帧：ESP = 00B5FD54 EBP = 00B5FD70</span>
<span class="token number">002</span>D1920  push        ebp<span class="token comment">//ebp压栈，保存栈顶指针</span>
<span class="token comment">//ESP = 00B5FD50 EBP = 00B5FD70</span>
<span class="token number">002</span>D1921  mov         ebp<span class="token punctuation">,</span>esp<span class="token comment">//将esp栈顶指针指向的地址保存到ebp中</span>
<span class="token comment">//ESP = 00B5FD50 EBP = 00B5FD50</span>
<span class="token number">002</span>D1923  sub         esp<span class="token punctuation">,</span><span class="token number">0</span>D8h<span class="token comment">//将esp的地址 - D8，预留字节给函数临时变量</span>
<span class="token comment">//ESP = 00B5FC78 EBP = 00B5FD50 </span>
<span class="token number">002</span>D1929  push        ebx<span class="token comment">//基址(base)寄存器，压栈</span>
<span class="token comment">//ESP = 00B5FC74 EBP = 00B5FD50</span>
<span class="token number">002</span>D192A  push        esi<span class="token comment">//源索引寄存器，压栈</span>
<span class="token comment">//ESP = 00B5FC70 EBP = 00B5FD50  </span>
<span class="token number">002</span>D192B  push        edi<span class="token comment">//目标索引寄存器，压栈</span>
<span class="token comment">//ESP = 00B5FC6C EBP = 00B5FD50</span>
<span class="token number">002</span>D192C  lea         edi<span class="token punctuation">,</span><span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">18</span>h<span class="token punctuation">]</span><span class="token comment">//将 ebp-18 的地址保存到edi中</span>
<span class="token number">002</span>D192F  mov         ecx<span class="token punctuation">,</span><span class="token number">6</span><span class="token comment">//计数器，用于重复rep指令</span>
<span class="token number">002</span>D1934  mov         eax<span class="token punctuation">,</span><span class="token number">0</span>CCCCCCCCh<span class="token comment">//给eax寄存器赋予随机值</span>
<span class="token number">002</span>D1939  rep stos    dword ptr es<span class="token operator">:</span><span class="token punctuation">[</span>edi<span class="token punctuation">]</span><span class="token comment">//从edi的地址开始向上每4个字节，重复执行上述指令</span>
<span class="token number">002</span>D193B  mov         ecx<span class="token punctuation">,</span>offset _12508171_源文件名@<span class="token function">cpp</span> <span class="token punctuation">(</span><span class="token number">02</span>DC072h<span class="token punctuation">)</span><span class="token comment">//文件的地址</span>
<span class="token number">002</span>D1940  call        @__CheckForDebuggerJustMyCode@<span class="token number">4</span> <span class="token punctuation">(</span><span class="token number">02</span>D1339h<span class="token punctuation">)</span><span class="token comment">//检查错误</span>

	<span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token number">002</span>D1945  mov         dword ptr <span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span>Ah<span class="token comment">//将10写入4个字节到a的地址中</span>
	<span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token number">002</span>D194C  mov         dword ptr <span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">14</span>h<span class="token comment">//将20写入4个字节到b的地址中</span>

	<span class="token function">swap</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">002</span>D1953  mov         eax<span class="token punctuation">,</span>dword ptr <span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token comment">//从b的地址取4个字节到eax寄存器中</span>
<span class="token number">002</span>D1956  push        eax<span class="token comment">//eax寄存器，压栈</span>
<span class="token comment">//ESP = 00B5FC68 EBP = 00B5FD50</span>

<span class="token number">002</span>D1957  mov         ecx<span class="token punctuation">,</span>dword ptr <span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token comment">//从a的地址取4个字节到eax寄存器中</span>
<span class="token number">002</span>D195A  push        ecx<span class="token comment">//ecx寄存器，压栈</span>
<span class="token comment">//ESP = 00B5FC64 EBP = 00B5FD50</span>

<span class="token number">002</span>D195B  call        <span class="token function">swap</span> <span class="token punctuation">(</span><span class="token number">02</span>D13E3h<span class="token punctuation">)</span><span class="token comment">//进入swap函数</span>
<span class="token comment">//push EIP//将当前指令的下一条指令的地址压栈，(EIP = 002D195B + 4)</span>
<span class="token comment">//ESP = 00B5FC60 EBP = 00B5FD50</span>


<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>

<span class="token comment">//当前栈帧：ESP = 00B5FC60 EBP = 00B5FD50</span>
<span class="token comment">//EIP = 002D13E3</span>
<span class="token number">002</span>D13E3  jmp         <span class="token function">swap</span> <span class="token punctuation">(</span><span class="token number">02</span>D18D0h<span class="token punctuation">)</span><span class="token comment">//跳转到swap函数的入口，即开始地址</span>
<span class="token comment">//EIP = 002D18D0</span>

<span class="token comment">//进入swap函数体</span>
<span class="token keyword">int</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span>
<span class="token number">002</span>D18D0  push        ebp<span class="token comment">//ebp压栈，保存栈顶指针</span>
<span class="token comment">//ESP = 00B5FC5C EBP = 00B5FD50  </span>
<span class="token number">002</span>D18D1  mov         ebp<span class="token punctuation">,</span>esp<span class="token comment">//将esp栈顶指针指向的地址保存到ebp中</span>
<span class="token comment">//ESP = 00B5FC5C EBP = 00B5FC5C  </span>
<span class="token number">002</span>D18D3  sub         esp<span class="token punctuation">,</span><span class="token number">0</span>CCh<span class="token comment">//将esp的地址 - CC，预留字节给函数临时变量</span>
<span class="token comment">//ESP = 00B5FB90 EBP = 00B5FC5C EFL = 00000206（标志寄存器），执行地址运算指令时，标记位变化  </span>
<span class="token number">002</span>D18D9  push        ebx<span class="token comment">//ebx寄存器压栈</span>
<span class="token comment">//ESP = 00B5FB8C EBP = 00B5FC5C  </span>
<span class="token number">002</span>D18DA  push        esi<span class="token comment">//esi寄存器压栈</span>
<span class="token comment">//ESP = 00B5FB88 EBP = 00B5FC5C  </span>
<span class="token number">002</span>D18DB  push        edi<span class="token comment">//edi寄存器压栈</span>
<span class="token comment">//ESP = 00B5FB84 EBP = 00B5FC5C  </span>
<span class="token number">002</span>D18DC  lea         edi<span class="token punctuation">,</span><span class="token punctuation">[</span>ebp<span class="token operator">-</span><span class="token number">0</span>Ch<span class="token punctuation">]</span>
<span class="token number">002</span>D18DF  mov         ecx<span class="token punctuation">,</span><span class="token number">3</span>
<span class="token number">002</span>D18E4  mov         eax<span class="token punctuation">,</span><span class="token number">0</span>CCCCCCCCh  
<span class="token number">002</span>D18E9  rep stos    dword ptr es<span class="token operator">:</span><span class="token punctuation">[</span>edi<span class="token punctuation">]</span>  
<span class="token number">002</span>D18EB  mov         ecx<span class="token punctuation">,</span>offset _12508171_源文件名@<span class="token function">cpp</span> <span class="token punctuation">(</span><span class="token number">02</span>DC072h<span class="token punctuation">)</span>  
<span class="token number">002</span>D18F0  call        @__CheckForDebuggerJustMyCode@<span class="token number">4</span> <span class="token punctuation">(</span><span class="token number">02</span>D1339h<span class="token punctuation">)</span>
 
	<span class="token keyword">int</span> tmp <span class="token operator">=</span> a<span class="token punctuation">;</span>
<span class="token number">002</span>D18F5  mov         eax<span class="token punctuation">,</span>dword ptr <span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token comment">//从a的地址取4个字节到eax寄存器中</span>
<span class="token number">002</span>D18F8  mov         dword ptr <span class="token punctuation">[</span>tmp<span class="token punctuation">]</span><span class="token punctuation">,</span>eax<span class="token comment">//将eax寄存器中的数据写入4个字节到tmp的地址中  </span>
	a <span class="token operator">=</span> b<span class="token punctuation">;</span>
<span class="token number">002</span>D18FB  mov         eax<span class="token punctuation">,</span>dword ptr <span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token comment">//从b的地址取4个字节到eax寄存器中</span>
<span class="token number">002</span>D18FE  mov         dword ptr <span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">,</span>eax<span class="token comment">//将eax寄存器中的数据写入4个字节到a的地址中</span>
	b <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
<span class="token number">002</span>D1901  mov         eax<span class="token punctuation">,</span>dword ptr <span class="token punctuation">[</span>tmp<span class="token punctuation">]</span><span class="token comment">//从tmp的地址取4个字节到eax寄存器中</span>
<span class="token number">002</span>D1904  mov         dword ptr <span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token punctuation">,</span>eax<span class="token comment">//将eax寄存器中的数据写入4个字节到b的地址中</span>

	<span class="token keyword">return</span> a<span class="token punctuation">;</span>
<span class="token number">002</span>D1907  mov         eax<span class="token punctuation">,</span>dword ptr <span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token comment">//从a的地址取4个字节到eax寄存器中</span>
<span class="token number">002</span>D190A  pop         edi<span class="token comment">//edi寄存器出栈</span>
<span class="token comment">//ESP = 00B5FB88 EBP = 00B5FC5C  </span>
<span class="token number">002</span>D190B  pop         esi<span class="token comment">//esi寄存器出栈</span>
<span class="token comment">//ESP = 00B5FB8C EBP = 00B5FC5C  </span>
<span class="token number">002</span>D190C  pop         ebx<span class="token comment">//ebx寄存器出栈</span>
<span class="token comment">//ESP = 00B5FB90 EBP = 00B5FC5C  </span>
<span class="token number">002</span>D190D  add         esp<span class="token punctuation">,</span><span class="token number">0</span>CCh<span class="token comment">//将esp的地址 + CC，回退释放临时变量的内存空间，平衡堆栈</span>
<span class="token comment">//ESP = 00B5FC5C EBP = 00B5FC5C</span>
<span class="token number">002</span>D1913  cmp         ebp<span class="token punctuation">,</span>esp<span class="token comment">//检查堆栈平衡</span>
<span class="token number">002</span>D1915  call        <span class="token function">__RTC_CheckEsp</span> <span class="token punctuation">(</span><span class="token number">02</span>D1253h<span class="token punctuation">)</span><span class="token comment">//判断esp和ebp是否相等</span>
<span class="token number">002</span>D191A  mov         esp<span class="token punctuation">,</span>ebp  
<span class="token number">002</span>D191C  pop         ebp<span class="token comment">//ebp出栈，ebp返回到进入函数之前的地址</span>
<span class="token comment">//ESP = 00B5FC60 EBP = 00B5FD50  </span>
<span class="token number">002</span>D191D  ret<span class="token comment">//复位，EIP出栈，栈帧回退到main函数</span>
<span class="token comment">//pop EIP</span>
<span class="token comment">//ESP = 00B5FC64 EBP = 00B5FD50</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>


<span class="token comment">//退出函数</span>
<span class="token comment">//当前栈帧：ESP = 00B5FC64 EBP = 00B5FD50</span>
<span class="token comment">//EIP = 002D1960</span>

<span class="token number">002</span>D1960  add         esp<span class="token punctuation">,</span><span class="token number">8</span><span class="token comment">//esp栈顶指针+8，回退释放两个参数占用的内存空间</span>
<span class="token comment">//ESP = 00B5FC6C EBP = 00B5FD50</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">002</span>D1963  <span class="token operator">xor</span>         eax<span class="token punctuation">,</span>eax<span class="token comment">//eax异或，寄存器清零</span>
<span class="token number">002</span>D1965  pop         edi<span class="token comment">//edi寄存器出栈</span>
<span class="token comment">//ESP = 00B5FC70 EBP = 00B5FD50  </span>
<span class="token number">002</span>D1966  pop         esi<span class="token comment">//esi寄存器出栈</span>
<span class="token comment">//ESP = 00B5FC74 EBP = 00B5FD50  </span>
<span class="token number">002</span>D1967  pop         ebx<span class="token comment">//ebx寄存器出栈</span>
<span class="token comment">//ESP = 00B5FC78 EBP = 00B5FD50  </span>
<span class="token number">002</span>D1968  add         esp<span class="token punctuation">,</span><span class="token number">0</span>D8h<span class="token comment">//将esp的地址 + D8，回退释放临时变量的内存空间，平衡堆栈</span>
<span class="token comment">//ESP = 00B5FD50 EBP = 00B5FD50  </span>
<span class="token number">002</span>D196E  cmp         ebp<span class="token punctuation">,</span>esp<span class="token comment">//检查堆栈平衡</span>
<span class="token number">002</span>D1970  call        <span class="token function">__RTC_CheckEsp</span> <span class="token punctuation">(</span><span class="token number">02</span>D1253h<span class="token punctuation">)</span> 
<span class="token number">002</span>D1975  mov         esp<span class="token punctuation">,</span>ebp  
<span class="token number">002</span>D1977  pop         ebp<span class="token comment">//ebp出栈，ebp返回到main函数之前的地址</span>
<span class="token comment">//ESP = 00B5FD54 EBP = 00B5FD70  </span>
<span class="token number">002</span>D1978  ret<span class="token comment">//复位，栈帧回退</span>
<span class="token comment">//调用main函数，mainCRTStartup()</span>
</code></pre> 
<br> 
<h3><a id="21__205"></a>2.1 函数调用流程</h3> 
<table><thead><tr><th align="center"></th><th align="center">进入main函数</th></tr></thead><tbody><tr><td align="center">push ebp</td><td align="center">保存栈底指针</td></tr><tr><td align="center">push 寄存器</td><td align="center">保存现场</td></tr><tr><td align="center">push 参数</td><td align="center">压参</td></tr><tr><td align="center">call 函数</td><td align="center">调用函数</td></tr><tr><td align="center"></td><td align="center"><strong>进入被调用函数</strong></td></tr><tr><td align="center">push ebp</td><td align="center">保存栈底指针</td></tr><tr><td align="center">push 寄存器</td><td align="center">保存现场</td></tr><tr><td align="center"></td><td align="center">执行函数运算</td></tr><tr><td align="center">pop 寄存器</td><td align="center">恢复现场</td></tr><tr><td align="center">add esp</td><td align="center">释放临时变量占用空间，平衡堆栈</td></tr><tr><td align="center">cmp ebp,esp</td><td align="center">检查堆栈平衡</td></tr><tr><td align="center">pop ebp</td><td align="center">回退栈底指针</td></tr><tr><td align="center">ret</td><td align="center">复位，栈帧回退</td></tr><tr><td align="center"></td><td align="center"><strong>退出被调用函数</strong></td></tr><tr><td align="center">add esp</td><td align="center">释放参数占用空间</td></tr><tr><td align="center">xor eax</td><td align="center">寄存器清零</td></tr><tr><td align="center">pop 寄存器</td><td align="center">恢复现场</td></tr><tr><td align="center">add esp</td><td align="center">释放临时变量占用空间，平衡堆栈</td></tr><tr><td align="center">cmp ebp,esp</td><td align="center">检查堆栈平衡</td></tr><tr><td align="center">pop ebp</td><td align="center">回退栈底指针</td></tr><tr><td align="center">ret</td><td align="center">复位，栈帧回退</td></tr></tbody></table>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a2551a223ca2e1c17e77d5b6313f11ca/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java接口的作用和意义是什么？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dd9be90be17bcd8fbef50560012d2a0f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">记录当把本地项目运行在服务器上时出现的一些错误</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>