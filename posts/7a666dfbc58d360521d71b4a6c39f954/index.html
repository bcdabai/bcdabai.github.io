<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Chisel教程——02.Chisel环境配置和第一个Chisel模块的实现与测试 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Chisel教程——02.Chisel环境配置和第一个Chisel模块的实现与测试" />
<meta property="og:description" content="Chisel环境配置和第一个Chisel模块的实现与测试 动机 现在已经对Scala有一定的了解了，可以开始构造一些硬件了。Chisel的全称为Constructing Hardware In a Scala Embedded Language，是一个基于Scala的DSL（Domain Specific Language，特定领域专用语言），因此可以在同一串代码内兼得Scala和Chisel编程的优点。
理解哪些代码是Scala哪些又是Chisel这点很重要，不过后面再谈。
现在开始，应该把Chisel和本章的代码看作写Verilog更好的方式。本章会展示一个完整的Chisel模块和测试模块，用于了解相关要点，后续后给出更多充足的例子。
环境配置（先不包括Chisel） 安装JDK、git、make和gtkwave等基本环境：
sudo apt install openjdk-8-jdk git make gtkwave 安装sbt
echo &#34;deb https://repo.scala-sbt.org/scalasbt/debian all main&#34; | sudo tee /etc/apt/sources.list.d/sbt.list echo &#34;deb https://repo.scala-sbt.org/scalasbt/debian /&#34; | sudo tee /etc/apt/sources.list.d/sbt_old.list curl -sL &#34;https://keyserver.ubuntu.com/pks/lookup?op=get&amp;search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823&#34; | sudo apt-key add sudo apt-get update sudo apt-get install sbt 在VS Code中安装插件，先安装Scala Syntax (official)，再安装Scala (Metals)：
Scala测试
新建源文件test.scala：
object HelloScala extends App { println(&#34;Hello Scala&#34;) } 运行：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/7a666dfbc58d360521d71b4a6c39f954/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-03T01:06:09+08:00" />
<meta property="article:modified_time" content="2022-07-03T01:06:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Chisel教程——02.Chisel环境配置和第一个Chisel模块的实现与测试</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="ChiselChisel_1"></a>Chisel环境配置和第一个Chisel模块的实现与测试</h2> 
<h3><a id="_3"></a>动机</h3> 
<p>现在已经对Scala有一定的了解了，可以开始构造一些硬件了。Chisel的全称为<strong>C</strong>onstructing <strong>H</strong>ardware <strong>I</strong>n a <strong>S</strong>cala <strong>E</strong>mbedded <strong>L</strong>anguage，是一个基于Scala的DSL（Domain Specific Language，特定领域专用语言），因此可以在同一串代码内兼得Scala和Chisel编程的优点。</p> 
<p>理解哪些代码是Scala哪些又是Chisel这点很重要，不过后面再谈。</p> 
<p>现在开始，应该把Chisel和本章的代码看作写Verilog更好的方式。本章会展示一个完整的Chisel模块和测试模块，用于了解相关要点，后续后给出更多充足的例子。</p> 
<h3><a id="Chisel_11"></a>环境配置（先不包括Chisel）</h3> 
<ol><li> <p>安装JDK、git、make和gtkwave等基本环境：</p> <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openjdk-8-jdk <span class="token function">git</span> <span class="token function">make</span> gtkwave
</code></pre> </li><li> <p>安装sbt</p> <pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"deb https://repo.scala-sbt.org/scalasbt/debian all main"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/sbt.list
<span class="token builtin class-name">echo</span> <span class="token string">"deb https://repo.scala-sbt.org/scalasbt/debian /"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/sbt_old.list
<span class="token function">curl</span> -sL <span class="token string">"https://keyserver.ubuntu.com/pks/lookup?op=get&amp;search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823"</span> <span class="token operator">|</span> <span class="token function">sudo</span> apt-key <span class="token function">add</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> sbt
</code></pre> </li><li> <p>在VS Code中安装插件，先安装<code>Scala Syntax (official)</code>，再安装<code>Scala (Metals)</code>：</p> <p><img src="https://images2.imgbox.com/00/ac/9Oy52Xg2_o.png" alt="在这里插入图片描述"> <img src="https://images2.imgbox.com/11/b5/H2QKpJma_o.png" alt="在这里插入图片描述"></p> </li><li> <p>Scala测试</p> 
  <ol><li> <p>新建源文件<code>test.scala</code>：</p> <pre><code class="prism language-scala"><span class="token keyword">object</span> HelloScala <span class="token keyword">extends</span> App <span class="token punctuation">{<!-- --></span>
  println<span class="token punctuation">(</span><span class="token string">"Hello Scala"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>运行：</p> <pre><code class="prism language-bash">sbt run
</code></pre> </li><li> <p>结果如下：</p> <p><img src="https://images2.imgbox.com/a3/a0/ooESz6XB_o.png" alt="在这里插入图片描述"></p> </li></ol> </li><li> <p>但是上面的步骤仅仅测试了Scala，并不是Chisel，进一步测试：</p> <pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/schoeberl/chisel-examples.git
<span class="token builtin class-name">cd</span> chisel-examples/hello-world
<span class="token function">make</span>
sbt <span class="token builtin class-name">test</span>
</code></pre> <p>结果如下：</p> <p><img src="https://images2.imgbox.com/3d/54/HvYyPuXY_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<h3><a id="Chisel_67"></a>项目文件目录结构（包括Chisel安装）</h3> 
<p>Chisel项目和Java这种类似，一般是有标准的目录结构的，对于Chisel而言，使用Scala项目构建工具sbt会很方便。</p> 
<p>使用sbt需要在项目文件夹下应有一个<code>build.sbt</code>文件，这个文件长这样（这样在执行<code>sbt run</code>的时候就会下载安装相应的依赖，比如这里会安装Chisel 3.5）：</p> 
<pre><code class="prism language-scala">scalaVersion <span class="token operator">:</span><span class="token operator">=</span> <span class="token string">"2.12.13"</span>

scalacOptions <span class="token operator">++</span><span class="token operator">=</span> Seq<span class="token punctuation">(</span>
  <span class="token string">"-feature"</span><span class="token punctuation">,</span>
  <span class="token string">"-language:reflectiveCalls"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

resolvers <span class="token operator">++</span><span class="token operator">=</span> Seq<span class="token punctuation">(</span>
  Resolver<span class="token punctuation">.</span>sonatypeRepo<span class="token punctuation">(</span><span class="token string">"releases"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">// Chisel 3.5</span>
addCompilerPlugin<span class="token punctuation">(</span><span class="token string">"edu.berkeley.cs"</span> <span class="token operator">%</span> <span class="token string">"chisel3-plugin"</span> <span class="token operator">%</span> <span class="token string">"3.5.0"</span> cross CrossVersion<span class="token punctuation">.</span>full<span class="token punctuation">)</span>
libraryDependencies <span class="token operator">+=</span> <span class="token string">"edu.berkeley.cs"</span> <span class="token operator">%</span><span class="token operator">%</span> <span class="token string">"chisel3"</span> <span class="token operator">%</span> <span class="token string">"3.5.0"</span>
libraryDependencies <span class="token operator">+=</span> <span class="token string">"edu.berkeley.cs"</span> <span class="token operator">%</span><span class="token operator">%</span> <span class="token string">"chiseltest"</span> <span class="token operator">%</span> <span class="token string">"0.5.0"</span>
</code></pre> 
<p>这个文件会指定很多信息，比如Scala的版本、依赖的库等。</p> 
<p>然后项目文件夹下，应该有<code>src/main/scala/</code>路径和<code>src/test/scala</code>，分别用于存放主程序和测试用代码。比如：</p> 
<p><img src="https://images2.imgbox.com/0a/78/IicpYiFS_o.png" alt="在这里插入图片描述"></p> 
<p>这里用之前的测试用例里面的代码，暂且先不管代码具体啥意思：</p> 
<pre><code class="prism language-scala"><span class="token comment">// Hello.scala</span>
<span class="token comment">/*
 * This code is a minimal hardware described in Chisel.
 * 
 * Blinking LED: the FPGA version of Hello World
 */</span>

<span class="token keyword">import</span> <span class="token namespace">chisel3<span class="token punctuation">.</span></span>_

<span class="token comment">/**
 * The blinking LED component.
 */</span>

<span class="token keyword">class</span> Hello <span class="token keyword">extends</span> Module <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">val</span> io <span class="token operator">=</span> IO<span class="token punctuation">(</span><span class="token keyword">new</span> Bundle <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> led <span class="token operator">=</span> Output<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">1.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">val</span> CNT_MAX <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">50000000</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>U

  <span class="token keyword">val</span> cntReg <span class="token operator">=</span> RegInit<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">(</span><span class="token number">32.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">val</span> blkReg <span class="token operator">=</span> RegInit<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">(</span><span class="token number">1.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>

  cntReg <span class="token operator">:</span><span class="token operator">=</span> cntReg <span class="token operator">+</span> <span class="token number">1.</span>U
  when<span class="token punctuation">(</span>cntReg <span class="token operator">==</span><span class="token operator">=</span> CNT_MAX<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cntReg <span class="token operator">:</span><span class="token operator">=</span> <span class="token number">0.</span>U
    blkReg <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">~</span>blkReg
  <span class="token punctuation">}</span>
  io<span class="token punctuation">.</span>led <span class="token operator">:</span><span class="token operator">=</span> blkReg
<span class="token punctuation">}</span>

<span class="token comment">/**
 * An object extending App to generate the Verilog code.
 */</span>
<span class="token keyword">object</span> Hello <span class="token keyword">extends</span> App <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">(</span><span class="token keyword">new</span> chisel3<span class="token punctuation">.</span>stage<span class="token punctuation">.</span>ChiselStage<span class="token punctuation">)</span><span class="token punctuation">.</span>emitVerilog<span class="token punctuation">(</span><span class="token keyword">new</span> Hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>和：</p> 
<pre><code class="prism language-scala"><span class="token comment">// HelloTest.scala</span>
<span class="token keyword">import</span> <span class="token namespace">chiseltest<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>scalatest<span class="token punctuation">.</span>flatspec<span class="token punctuation">.</span></span>AnyFlatSpec

<span class="token keyword">class</span> HelloTest <span class="token keyword">extends</span> AnyFlatSpec <span class="token keyword">with</span> ChiselScalatestTester <span class="token punctuation">{<!-- --></span>
  behavior of <span class="token string">"Hello"</span>
  it should <span class="token string">"pass"</span> in <span class="token punctuation">{<!-- --></span>
    test<span class="token punctuation">(</span><span class="token keyword">new</span> Hello<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> c <span class="token keyword">=&gt;</span>
      c<span class="token punctuation">.</span>clock<span class="token punctuation">.</span>setTimeout<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">var</span> ledStatus <span class="token operator">=</span> BigInt<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
      println<span class="token punctuation">(</span><span class="token string">"Start the blinking LED"</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>_ <span class="token keyword">&lt;-</span> <span class="token number">0</span> until <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        c<span class="token punctuation">.</span>clock<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> ledNow <span class="token operator">=</span> c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>led<span class="token punctuation">.</span>peek<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>litValue
        <span class="token keyword">val</span> s <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ledNow <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">"o"</span> <span class="token keyword">else</span> <span class="token string">"*"</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ledStatus <span class="token operator">!=</span> ledNow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          System<span class="token punctuation">.</span>out<span class="token punctuation">.</span>println<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
          ledStatus <span class="token operator">=</span> ledNow
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      println<span class="token punctuation">(</span><span class="token string">"\nEnd the blinking LED"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>分别保存到相应的路径之后，在项目根目录下执行以下命令即可编译运行<code>Hello.scala</code>：</p> 
<pre><code class="prism language-bash">sbt run
</code></pre> 
<p>结果如下：</p> 
<p><img src="https://images2.imgbox.com/27/53/UnMQ3545_o.png" alt="在这里插入图片描述"></p> 
<p>执行以下命名可以编译运行<code>HelloTest.scala</code>：</p> 
<pre><code class="prism language-bash">sbt <span class="token builtin class-name">test</span>
</code></pre> 
<p>结果如下：</p> 
<p><img src="https://images2.imgbox.com/14/cd/dYKLsAFM_o.png" alt="在这里插入图片描述"></p> 
<p>出现类似的结果就表示代码成功运行并且测试通过了。</p> 
<p>当然了，最推荐的还是使用官方提供的模板<a href="https://github.com/freechipsproject/chisel-template">freechipsproject/chisel-template: A template project for beginning new Chisel work (github.com)</a>，直接修改其中的源代码文件即可。</p> 
<h3><a id="Chisel_194"></a>创建一个Chisel模块</h3> 
<p>首先导入Chisel库里面的类，先不管都有些啥：</p> 
<pre><code class="prism language-scala"><span class="token keyword">import</span> <span class="token namespace">chisel3<span class="token punctuation">.</span></span>_
</code></pre> 
<p>然后我们写一个Chisel的<code>Module</code>，名为<code>Passthrough</code>，功能很简单，4-bit的输入<code>in</code>，4-bit的输出<code>out</code>，然后这个模块把<code>in</code>和<code>out</code>直接连在一起，由<code>in</code>驱动<code>out</code>，简单地说就是输入啥就输出啥：</p> 
<pre><code class="prism language-scala"><span class="token comment">// Chisel Code: Declare a new module definition</span>
<span class="token keyword">class</span> Passthrough <span class="token keyword">extends</span> Module <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">val</span> io <span class="token operator">=</span> IO<span class="token punctuation">(</span><span class="token keyword">new</span> Bundle <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> in <span class="token operator">=</span> Input<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">4.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> out <span class="token operator">=</span> Output<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span><span class="token number">4.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  io<span class="token punctuation">.</span>out <span class="token operator">:</span><span class="token operator">=</span> io<span class="token punctuation">.</span>in
<span class="token punctuation">}</span>
</code></pre> 
<p>逐行解析一下：</p> 
<ol><li> <p><code>class Passthrough extends Module {<!-- --></code>…}：创建一个新的模块叫做<code>Passthrough</code>，<code>Module</code>是Chisel的内置类，实现任何硬件模块都需要从它<code>extends</code>；</p> </li><li> <p><code>val io = IO(...)</code>：这一句把所有的输入输出端口定义在<code>val</code> <code>io</code>中，这地方这个变量必须叫做<code>io</code>且是一个IO对象或实例，需要<code>IO(_instantiated_bundle_)</code>这样的形式；</p> </li><li> <pre><code class="prism language-scala"><span class="token keyword">new</span> Bundle <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> in <span class="token operator">=</span> Input<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> out <span class="token operator">=</span> Output<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <p>这里是声明了一个新的硬件结构类型（Bundle），它包含了命名信号<code>in</code>和<code>out</code>，方向分别为输入输出；</p> </li><li> <p><code>UInt(4.W)</code>：声明了信号的硬件类型，这里是宽度为4的无符号整数；</p> </li><li> <p><code>io.out := io.in</code>：把输入端口连接到了输出端口上，这样就是<code>io.in</code>驱动<code>io.out</code>了。<strong>需要注意的是</strong>，<code>:=</code>是一个Chisel运算符，表示右边的信号驱动左边的信号，是个有方向的操作符。</p> </li><li> <p>硬件构造语言（HCL，Hardware Construction Languages）的巧妙之处在于可以将底层编程语言用作脚本语言，比如在声明了我们的Chisel模块之后，我们可以使用Scala调用Chisel编译器，来将Chisel Passthrough翻译为Verilog Passthrough，这个过程叫展开（elaboration）：</p> <pre><code class="prism language-scala"><span class="token keyword">object</span> Passthrough <span class="token keyword">extends</span> App <span class="token punctuation">{<!-- --></span>
  println<span class="token punctuation">(</span>getVerilogString<span class="token punctuation">(</span><span class="token keyword">new</span> Passthrough<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <p>运行结果如下：</p> <p><img src="https://images2.imgbox.com/19/87/ANjpidtl_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<h3><a id="Chisel_247"></a>创建一个Chisel模块生成器</h3> 
<p>Chisel模块其实就是一个Scala的类，所以和其他的Scala类一样，可以给Chisel模块提供一些构造参数。这里我们创建一个类<code>PassthroughGenerator</code>，这个类接受一个整数参数<code>width</code>，用于指定输入输出的端口宽度：</p> 
<pre><code class="prism language-scala"><span class="token comment">// Chisel Code, but pass in a parameter to set widths of ports</span>
<span class="token keyword">class</span> PassthroughGenerator<span class="token punctuation">(</span>width<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Module <span class="token punctuation">{<!-- --></span> 
  <span class="token keyword">val</span> io <span class="token operator">=</span> IO<span class="token punctuation">(</span><span class="token keyword">new</span> Bundle <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> in <span class="token operator">=</span> Input<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span>width<span class="token punctuation">.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> out <span class="token operator">=</span> Output<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span>width<span class="token punctuation">.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  io<span class="token punctuation">.</span>out <span class="token operator">:</span><span class="token operator">=</span> io<span class="token punctuation">.</span>in
<span class="token punctuation">}</span>

<span class="token comment">// Let's now generate modules with different widths</span>
<span class="token keyword">object</span> Passthrough <span class="token keyword">extends</span> App <span class="token punctuation">{<!-- --></span>
  println<span class="token punctuation">(</span>getVerilogString<span class="token punctuation">(</span><span class="token keyword">new</span> PassthroughGenerator<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  println<span class="token punctuation">(</span>getVerilogString<span class="token punctuation">(</span><span class="token keyword">new</span> PassthroughGenerator<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>执行<code>sbt run</code>结果如下：</p> 
<p><img src="https://images2.imgbox.com/76/a7/VTSOlvLP_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到，生成的Verilog代码分别对应了不同<code>width</code>参数值，这里类的参数化是Scala本身具备的功能。</p> 
<p>由于<code>PassthroughGenerator</code>已经不再是描述单个模块了，而是通过<code>width</code>参数化的一族模块，因此把这个类叫做<code>generator</code>，也就是生成器。</p> 
<h3><a id="_277"></a>创建一个测试器</h3> 
<p>没有测试器测试硬件肯定是不行的，Chisel有内置的测试功能，下面这个例子就是一个Chisel的测试器，传递值给<code>Passthrough</code>的实例的输入端口<code>in</code>，检查输出端口<code>out</code>输出的信号是否复合预期。</p> 
<p>语法是用<code>poke</code>来设置输入信号，用<code>expect</code>来检查输出信号：</p> 
<pre><code class="prism language-scala"><span class="token keyword">import</span> <span class="token namespace">chisel3<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">chiseltest<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>scalatest<span class="token punctuation">.</span>flatspec<span class="token punctuation">.</span></span>AnyFlatSpec

<span class="token keyword">class</span> PassthroughTest <span class="token keyword">extends</span> AnyFlatSpec <span class="token keyword">with</span> ChiselScalatestTester <span class="token punctuation">{<!-- --></span>
  behavior of <span class="token string">"PassthroughGenerator"</span>
  it should <span class="token string">"pass through bits"</span> in <span class="token punctuation">{<!-- --></span>
    test<span class="token punctuation">(</span><span class="token keyword">new</span> PassthroughGenerator<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> c <span class="token keyword">=&gt;</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>in<span class="token punctuation">.</span>poke<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">)</span>     <span class="token comment">// Set our input to value 0</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>out<span class="token punctuation">.</span>expect<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">)</span>  <span class="token comment">// Assert that the output correctly has 0</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>in<span class="token punctuation">.</span>poke<span class="token punctuation">(</span><span class="token number">1.</span>U<span class="token punctuation">)</span>     <span class="token comment">// Set our input to value 1</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>out<span class="token punctuation">.</span>expect<span class="token punctuation">(</span><span class="token number">1.</span>U<span class="token punctuation">)</span>  <span class="token comment">// Assert that the output correctly has 1</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>in<span class="token punctuation">.</span>poke<span class="token punctuation">(</span><span class="token number">2.</span>U<span class="token punctuation">)</span>     <span class="token comment">// Set our input to value 2</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>out<span class="token punctuation">.</span>expect<span class="token punctuation">(</span><span class="token number">2.</span>U<span class="token punctuation">)</span>  <span class="token comment">// Assert that the output correctly has 2</span>
    <span class="token punctuation">}</span>
    println<span class="token punctuation">(</span><span class="token string">"SUCCESS!!"</span><span class="token punctuation">)</span> <span class="token comment">// Scala Code: if we get here, our tests passed!</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中：</p> 
<pre><code class="prism language-scala">behavior of <span class="token string">"PassthroughGenerator"</span>
it should <span class="token string">"pass through bits"</span> in <span class="token punctuation">{<!-- --></span>
  test<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>中的<code>behavior of "PassthroughGenerator"</code>和<code>it should "pass through bits" in</code>会在测试中输出测试的相关信息。</p> 
<p>输入命令<code>sbt test</code>进行测试，结果如下：</p> 
<p><img src="https://images2.imgbox.com/7c/f2/g0ICC0Bb_o.png" alt="在这里插入图片描述"></p> 
<p>我们也可以进行多个实例的测试，比如分别测试<code>width</code>为10和20的<code>Passthrough</code>的边界情况：</p> 
<pre><code class="prism language-scala"><span class="token keyword">import</span> <span class="token namespace">chisel3<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">chiseltest<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>scalatest<span class="token punctuation">.</span>flatspec<span class="token punctuation">.</span></span>AnyFlatSpec

<span class="token keyword">class</span> PassthroughTest <span class="token keyword">extends</span> AnyFlatSpec <span class="token keyword">with</span> ChiselScalatestTester <span class="token punctuation">{<!-- --></span>
  behavior of <span class="token string">"PassthroughGenerator"</span>
  it should <span class="token string">"pass through bits"</span> in <span class="token punctuation">{<!-- --></span>
    test<span class="token punctuation">(</span><span class="token keyword">new</span> PassthroughGenerator<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> c <span class="token keyword">=&gt;</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>in<span class="token punctuation">.</span>poke<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">)</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>out<span class="token punctuation">.</span>expect<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">)</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>in<span class="token punctuation">.</span>poke<span class="token punctuation">(</span><span class="token number">1023.</span>U<span class="token punctuation">)</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>out<span class="token punctuation">.</span>expect<span class="token punctuation">(</span><span class="token number">1023.</span>U<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    test<span class="token punctuation">(</span><span class="token keyword">new</span> PassthroughGenerator<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> c <span class="token keyword">=&gt;</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>in<span class="token punctuation">.</span>poke<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">)</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>out<span class="token punctuation">.</span>expect<span class="token punctuation">(</span><span class="token number">0.</span>U<span class="token punctuation">)</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>in<span class="token punctuation">.</span>poke<span class="token punctuation">(</span><span class="token number">1048575.</span>U<span class="token punctuation">)</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>out<span class="token punctuation">.</span>expect<span class="token punctuation">(</span><span class="token number">1048575.</span>U<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    println<span class="token punctuation">(</span><span class="token string">"SUCCESS!!"</span><span class="token punctuation">)</span> <span class="token comment">// Scala Code: if we get here, our tests passed!</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果如下：</p> 
<p><img src="https://images2.imgbox.com/b7/ce/pG76mUCG_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="VerilogFIRRTL_354"></a>关于生成的Verilog和FIRRTL</h3> 
<p>如果一时半会儿还不习惯Chisel对电路的描述，可以输出生成的Verilog代码或FIRRTL：</p> 
<p>注意，本系列使用的Chisel 3.5里面的很多API与官方教程里面不同，尤其需要注意，可以通过这个链接检索API：<a href="https://www.chisel-lang.org/api/" rel="nofollow">Chisel/FIRRTL: Chisel API Documentation (chisel-lang.org)</a>，目前更新到了3.5.0。</p> 
<p>首先是生成Verilog代码，接口为<code>getVerilogString()</code>，<code>import chisel3._</code>就可以用了：</p> 
<pre><code class="prism language-scala">println<span class="token punctuation">(</span>getVerilogString<span class="token punctuation">(</span><span class="token keyword">new</span> PassthroughGenerator<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>结果如下：</p> 
<pre><code class="prism language-verilog">module PassthroughGenerator(
  input        clock,
  input        reset,
  input  [9:0] io_in,
  output [9:0] io_out
);
  assign io_out = io_in; // @[Passthrough.scala 10:10]
endmodule
</code></pre> 
<p>然后是生成Firrtl代码，这个API需要<code>import chisel3.stage.ChiselStage.emitFirrtl</code>，使用如下：</p> 
<pre><code class="prism language-scala">println<span class="token punctuation">(</span>emitFirrtl<span class="token punctuation">(</span><span class="token keyword">new</span> PassthroughGenerator<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出如下：</p> 
<p><img src="https://images2.imgbox.com/0b/34/WXKMSKDJ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="printf_390"></a>通过<code>printf</code>进行调试</h3> 
<p>虽然用 print 语句进行调试不是最好的方法，但确实最简单的方法。</p> 
<p>由于Chisel生成器是生成硬件的程序，所以在输出生成器和电路状态时存在一些细节需要注意，重点是要明确 print 语句是什么时候执行的、打印的内容是什么。</p> 
<p>有三种常见场景需要作区分：</p> 
<ol><li>Chisel生成器在生成电路的时候打印输出；</li><li>电路在仿真期间打印输出；</li><li>测试器在测试期间打印输出；</li></ol> 
<p><code>println</code>是Scala的内置函数，可以向控制台输出信息，但是不能用于在电路仿真的时候输出，因为生成的电路不是Scala语言的，而是Verilog或者FIRRTL的。</p> 
<p>比如下面的情况：</p> 
<pre><code class="prism language-scala"><span class="token comment">// Passthrough.scala</span>
<span class="token keyword">import</span> <span class="token namespace">chisel3<span class="token punctuation">.</span></span>_

<span class="token keyword">class</span> PassthroughGenerator<span class="token punctuation">(</span>width<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Module <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">val</span> io <span class="token operator">=</span> IO<span class="token punctuation">(</span><span class="token keyword">new</span> Bundle <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> in <span class="token operator">=</span> Input<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span>width<span class="token punctuation">.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> out <span class="token operator">=</span> Output<span class="token punctuation">(</span>UInt<span class="token punctuation">(</span>width<span class="token punctuation">.</span>W<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  io<span class="token punctuation">.</span>out <span class="token operator">:</span><span class="token operator">=</span> io<span class="token punctuation">.</span>in

  printf<span class="token punctuation">(</span><span class="token string">"Print during simulation: Input is %d\n"</span><span class="token punctuation">,</span> io<span class="token punctuation">.</span>in<span class="token punctuation">)</span>
  <span class="token comment">// chisel printf has its own string interpolator too</span>
  printf<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">p</span><span class="token string">"Print during simulation: IO is </span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">io</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>

  println<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"Print during generation: Input is </span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">io<span class="token punctuation">.</span>in</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">object</span> Passthrough <span class="token keyword">extends</span> App <span class="token punctuation">{<!-- --></span>
  println<span class="token punctuation">(</span>getVerilogString<span class="token punctuation">(</span><span class="token keyword">new</span> PassthroughGenerator<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  println<span class="token punctuation">(</span>getVerilogString<span class="token punctuation">(</span><span class="token keyword">new</span> PassthroughGenerator<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-scala"><span class="token comment">// PassthroughTest.scala</span>
<span class="token keyword">import</span> <span class="token namespace">chisel3<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">chiseltest<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">chisel3<span class="token punctuation">.</span>stage<span class="token punctuation">.</span></span>ChiselStage<span class="token punctuation">.</span>emitFirrtl
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>scalatest<span class="token punctuation">.</span>flatspec<span class="token punctuation">.</span></span>AnyFlatSpec

<span class="token keyword">class</span> PassthroughTest <span class="token keyword">extends</span> AnyFlatSpec <span class="token keyword">with</span> ChiselScalatestTester <span class="token punctuation">{<!-- --></span>
  behavior of <span class="token string">"PassthroughGenerator"</span>
  it should <span class="token string">"pass through bits"</span> in <span class="token punctuation">{<!-- --></span>
    test<span class="token punctuation">(</span><span class="token keyword">new</span> PassthroughGenerator<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> c <span class="token keyword">=&gt;</span>
      c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>in<span class="token punctuation">.</span>poke<span class="token punctuation">(</span><span class="token number">3.</span>U<span class="token punctuation">)</span>
      c<span class="token punctuation">.</span>clock<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">// circuit will print</span>
      
      println<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token id function">s</span><span class="token string">"Print during testing: Input is </span><span class="token interpolation"><span class="token punctuation">${<!-- --></span><span class="token expression">c<span class="token punctuation">.</span>io<span class="token punctuation">.</span>in<span class="token punctuation">.</span>peek<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    println<span class="token punctuation">(</span><span class="token string">"SUCCESS!!"</span><span class="token punctuation">)</span> <span class="token comment">// Scala Code: if we get here, our tests passed!</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>输出如下：</p> 
<p><img src="https://images2.imgbox.com/b8/96/VlXlr7cW_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到，<code>println</code>只会在生成和测试的时候输出，<code>printf</code>只会在仿真的时候输出。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2278148dd70f98a1ffe1136281e4992d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">sysctl.conf文件配置详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/811e4a63452323c27bd9472a04de562e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">百度地图api-基本用法总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>