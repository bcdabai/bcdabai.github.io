<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于k8s&#43;docker&#43;Prometheus的可监控高可用web集群 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于k8s&#43;docker&#43;Prometheus的可监控高可用web集群" />
<meta property="og:description" content="目录
文章目录
项目名称
项目环境
项目描述
项目步骤
1.规划设计整个集群的网络拓扑结构，配置防火墙和堡垒机，在堡垒机上安装部署ansible服务。
1.1.规划设计集群的网络拓扑结构
1.2.前期准备工作
1.3.配置防火墙
1.4.在堡垒机上安装部署ansible服务
2.安装Kubeadm部署单master的集群，形成1台master2台node的集群环境。使用deployment在集群中启动nginx的pod作为web应用。
2.1.k8s集群搭建
2.2.在集群中启动nginx
3.安装metrics-server，采用HPA技术，让pod达到自动缩放效果。当CPU使用率达到50%进行水平扩缩，实现启动最小20个pod，最多40个pod。
3.1.安装好metrics-server，运行php-apache
3.2.上传hpa.example.tar的镜像到两个node节点上
3.3.修改php-apache.yaml
3.4.启动pod
3.5.增加水平扩缩，创建hpa
3.6.验证效果
4.部署NFS服务器，实现集群的数据一致性，在nginx容器中使用PV和PVC与NFS融合，保证容器提供的web服务内容一致。
4.1.搭建好nfs服务器
4.2.创建pv使用nfs服务器上的共享目录（在master上操作）
4.3.创建pvc使用pv
4.4.指定pod使用pvc
5.构建CI/CD环境，安装gitlab，Jenkins，harbor实现代码发布、镜像制作、数据备份等流水线工作。
5.1.搭建私有仓库harbor
5.1.1.环境准备：
5.1.2.harbor安装过程
5.1.3.本机上传拉取镜像
5.2.搭建gitlab
5.3.安装Jenkins
6.使用Prometheus对k8s集群进行监控，在Grafana中配置好Prometheus的数据源进行数据展示，更直观地监控整个web集群的性能。
6.1.使用Docker容器部署Prometheus
6.2.配置Grafana
7.部署ingress给web业务进行负载均衡，使用探针（liveless\readiness\startup）的httpGET和exec方法试探pod能否正常提供服务，增强业务pod的可靠性
7.1.定义探针
7.2.部署ingress实现负载均衡
7.2.1.安装部署ingress controller
7.2.2.检查pod是否启动
7.3.创建ingress资源
7.3.1.启动service，暴露nginx
7.3.2.创建yaml文件，启动ingress
7.3.3.查看创建是否成功
7.3.4.验证
8.安装k8s的dashboard对整个集群资源进行掌控了解
8.1.准备工作
8.2.启动dashboard
8.2.1.应用配置文件
8.2.2.查看是否启动dashboard的启动情况
8.2.3.浏览器访问（使用https协议访问）
项目心得
项目名称
基于k8s&#43;docker&#43;Prometheus的可监控高可用web集群
项目环境 centos 7.9、Kubernetes v1.20.6、Docker 23.0.3、ansible 2.9.27、Prometheus 2.42、Grafana 9.1.2等
项目描述 模拟企业中的生产环境，底层采用k8s管理的docker集群提供web服务，通过ansible实现自动化运维，使用NFS实现数据同源，利用Prometheus实现监控功能并通过Grafana进行监控数据可视化，搭建Jenkins构建CI/CD环境，构造一个高并发，高可用的web集群。
项目步骤 1.规划设计整个集群的网络拓扑结构，配置防火墙和堡垒机，在堡垒机上安装部署ansible服务。 1.1.规划设计集群的网络拓扑结构 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/13ef396227c8a002c630006efbddf393/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-09T23:20:04+08:00" />
<meta property="article:modified_time" content="2023-09-09T23:20:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于k8s&#43;docker&#43;Prometheus的可监控高可用web集群</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <p></p> 
</blockquote> 
<div> 
 <p id="main-toc"><strong>目录</strong></p> 
 <p id="%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95-toc" style="margin-left:80px;"><a href="#%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95" rel="nofollow">文章目录</a></p> 
 <p id="%E9%A1%B9%E7%9B%AE%E5%90%8D%E7%A7%B0-toc" style="margin-left:0px;"><a href="#%E9%A1%B9%E7%9B%AE%E5%90%8D%E7%A7%B0" rel="nofollow">项目名称</a></p> 
 <p id="%E9%A1%B9%E7%9B%AE%E7%8E%AF%E5%A2%83-toc" style="margin-left:0px;"><a href="#%E9%A1%B9%E7%9B%AE%E7%8E%AF%E5%A2%83" rel="nofollow">项目环境</a></p> 
 <p id="%E9%A1%B9%E7%9B%AE%E6%8F%8F%E8%BF%B0-toc" style="margin-left:0px;"><a href="#%E9%A1%B9%E7%9B%AE%E6%8F%8F%E8%BF%B0" rel="nofollow">项目描述</a></p> 
 <p id="%E9%A1%B9%E7%9B%AE%E6%AD%A5%E9%AA%A4-toc" style="margin-left:0px;"><a href="#%E9%A1%B9%E7%9B%AE%E6%AD%A5%E9%AA%A4" rel="nofollow">项目步骤</a></p> 
 <p id="1.%E8%A7%84%E5%88%92%E8%AE%BE%E8%AE%A1%E6%95%B4%E4%B8%AA%E9%9B%86%E7%BE%A4%E7%9A%84%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84%EF%BC%8C%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99%E5%92%8C%E5%A0%A1%E5%9E%92%E6%9C%BA%EF%BC%8C%E5%9C%A8%E5%A0%A1%E5%9E%92%E6%9C%BA%E4%B8%8A%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2ansible%E6%9C%8D%E5%8A%A1%E3%80%82-toc" style="margin-left:40px;"><a href="#1.%E8%A7%84%E5%88%92%E8%AE%BE%E8%AE%A1%E6%95%B4%E4%B8%AA%E9%9B%86%E7%BE%A4%E7%9A%84%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84%EF%BC%8C%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99%E5%92%8C%E5%A0%A1%E5%9E%92%E6%9C%BA%EF%BC%8C%E5%9C%A8%E5%A0%A1%E5%9E%92%E6%9C%BA%E4%B8%8A%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2ansible%E6%9C%8D%E5%8A%A1%E3%80%82" rel="nofollow">1.规划设计整个集群的网络拓扑结构，配置防火墙和堡垒机，在堡垒机上安装部署ansible服务。</a></p> 
 <p id="1.1.%E8%A7%84%E5%88%92%E8%AE%BE%E8%AE%A1%E9%9B%86%E7%BE%A4%E7%9A%84%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84-toc" style="margin-left:80px;"><a href="#1.1.%E8%A7%84%E5%88%92%E8%AE%BE%E8%AE%A1%E9%9B%86%E7%BE%A4%E7%9A%84%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84" rel="nofollow">1.1.规划设计集群的网络拓扑结构</a></p> 
 <p id="1.2.%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-toc" style="margin-left:80px;"><a href="#1.2.%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" rel="nofollow">1.2.前期准备工作</a></p> 
 <p id="1.3.%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99-toc" style="margin-left:80px;"><a href="#1.3.%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99" rel="nofollow">1.3.配置防火墙</a></p> 
 <p id="1.4.%E5%9C%A8%E5%A0%A1%E5%9E%92%E6%9C%BA%E4%B8%8A%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2ansible%E6%9C%8D%E5%8A%A1-toc" style="margin-left:80px;"><a href="#1.4.%E5%9C%A8%E5%A0%A1%E5%9E%92%E6%9C%BA%E4%B8%8A%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2ansible%E6%9C%8D%E5%8A%A1" rel="nofollow">1.4.在堡垒机上安装部署ansible服务</a></p> 
 <p id="2.%E5%AE%89%E8%A3%85Kubeadm%E9%83%A8%E7%BD%B2%E5%8D%95master%E7%9A%84%E9%9B%86%E7%BE%A4%EF%BC%8C%E5%BD%A2%E6%88%901%E5%8F%B0master2%E5%8F%B0node%E7%9A%84%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E3%80%82%E4%BD%BF%E7%94%A8deployment%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%90%AF%E5%8A%A8nginx%E7%9A%84pod%E4%BD%9C%E4%B8%BAweb%E5%BA%94%E7%94%A8%E3%80%82-toc" style="margin-left:40px;"><a href="#2.%E5%AE%89%E8%A3%85Kubeadm%E9%83%A8%E7%BD%B2%E5%8D%95master%E7%9A%84%E9%9B%86%E7%BE%A4%EF%BC%8C%E5%BD%A2%E6%88%901%E5%8F%B0master2%E5%8F%B0node%E7%9A%84%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E3%80%82%E4%BD%BF%E7%94%A8deployment%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%90%AF%E5%8A%A8nginx%E7%9A%84pod%E4%BD%9C%E4%B8%BAweb%E5%BA%94%E7%94%A8%E3%80%82" rel="nofollow">2.安装Kubeadm部署单master的集群，形成1台master2台node的集群环境。使用deployment在集群中启动nginx的pod作为web应用。</a></p> 
 <p id="2.1.k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA-toc" style="margin-left:80px;"><a href="#2.1.k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA" rel="nofollow">2.1.k8s集群搭建</a></p> 
 <p id="2.2.%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%90%AF%E5%8A%A8nginx-toc" style="margin-left:80px;"><a href="#2.2.%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%90%AF%E5%8A%A8nginx" rel="nofollow">2.2.在集群中启动nginx</a></p> 
 <p id="3.%E5%AE%89%E8%A3%85metrics-server%EF%BC%8C%E9%87%87%E7%94%A8HPA%E6%8A%80%E6%9C%AF%EF%BC%8C%E8%AE%A9pod%E8%BE%BE%E5%88%B0%E8%87%AA%E5%8A%A8%E7%BC%A9%E6%94%BE%E6%95%88%E6%9E%9C%E3%80%82%E5%BD%93CPU%E4%BD%BF%E7%94%A8%E7%8E%87%E8%BE%BE%E5%88%B050%25%E8%BF%9B%E8%A1%8C%E6%B0%B4%E5%B9%B3%E6%89%A9%E7%BC%A9%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%90%AF%E5%8A%A8%E6%9C%80%E5%B0%8F20%E4%B8%AApod%EF%BC%8C%E6%9C%80%E5%A4%9A40%E4%B8%AApod%E3%80%82-toc" style="margin-left:40px;"><a href="#3.%E5%AE%89%E8%A3%85metrics-server%EF%BC%8C%E9%87%87%E7%94%A8HPA%E6%8A%80%E6%9C%AF%EF%BC%8C%E8%AE%A9pod%E8%BE%BE%E5%88%B0%E8%87%AA%E5%8A%A8%E7%BC%A9%E6%94%BE%E6%95%88%E6%9E%9C%E3%80%82%E5%BD%93CPU%E4%BD%BF%E7%94%A8%E7%8E%87%E8%BE%BE%E5%88%B050%25%E8%BF%9B%E8%A1%8C%E6%B0%B4%E5%B9%B3%E6%89%A9%E7%BC%A9%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%90%AF%E5%8A%A8%E6%9C%80%E5%B0%8F20%E4%B8%AApod%EF%BC%8C%E6%9C%80%E5%A4%9A40%E4%B8%AApod%E3%80%82" rel="nofollow">3.安装metrics-server，采用HPA技术，让pod达到自动缩放效果。当CPU使用率达到50%进行水平扩缩，实现启动最小20个pod，最多40个pod。</a></p> 
 <p id="3.1.%E5%AE%89%E8%A3%85%E5%A5%BDmetrics-server%EF%BC%8C%E8%BF%90%E8%A1%8Cphp-apache-toc" style="margin-left:80px;"><a href="#3.1.%E5%AE%89%E8%A3%85%E5%A5%BDmetrics-server%EF%BC%8C%E8%BF%90%E8%A1%8Cphp-apache" rel="nofollow">3.1.安装好metrics-server，运行php-apache</a></p> 
 <p id="3.2.%E4%B8%8A%E4%BC%A0hpa.example.tar%E7%9A%84%E9%95%9C%E5%83%8F%E5%88%B0%E4%B8%A4%E4%B8%AAnode%E8%8A%82%E7%82%B9%E4%B8%8A-toc" style="margin-left:80px;"><a href="#3.2.%E4%B8%8A%E4%BC%A0hpa.example.tar%E7%9A%84%E9%95%9C%E5%83%8F%E5%88%B0%E4%B8%A4%E4%B8%AAnode%E8%8A%82%E7%82%B9%E4%B8%8A" rel="nofollow">3.2.上传hpa.example.tar的镜像到两个node节点上</a></p> 
 <p id="3.3.%E4%BF%AE%E6%94%B9php-apache.yaml-toc" style="margin-left:80px;"><a href="#3.3.%E4%BF%AE%E6%94%B9php-apache.yaml" rel="nofollow">3.3.修改php-apache.yaml</a></p> 
 <p id="3.4.%E5%90%AF%E5%8A%A8pod-toc" style="margin-left:80px;"><a href="#3.4.%E5%90%AF%E5%8A%A8pod" rel="nofollow">3.4.启动pod</a></p> 
 <p id="3.5.%E5%A2%9E%E5%8A%A0%E6%B0%B4%E5%B9%B3%E6%89%A9%E7%BC%A9%EF%BC%8C%E5%88%9B%E5%BB%BAhpa-toc" style="margin-left:80px;"><a href="#3.5.%E5%A2%9E%E5%8A%A0%E6%B0%B4%E5%B9%B3%E6%89%A9%E7%BC%A9%EF%BC%8C%E5%88%9B%E5%BB%BAhpa" rel="nofollow">3.5.增加水平扩缩，创建hpa</a></p> 
 <p id="3.6.%E9%AA%8C%E8%AF%81%E6%95%88%E6%9E%9C-toc" style="margin-left:80px;"><a href="#3.6.%E9%AA%8C%E8%AF%81%E6%95%88%E6%9E%9C" rel="nofollow">3.6.验证效果</a></p> 
 <p id="4.%E9%83%A8%E7%BD%B2NFS%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E5%AE%9E%E7%8E%B0%E9%9B%86%E7%BE%A4%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%8C%E5%9C%A8nginx%E5%AE%B9%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8PV%E5%92%8CPVC%E4%B8%8ENFS%E8%9E%8D%E5%90%88%EF%BC%8C%E4%BF%9D%E8%AF%81%E5%AE%B9%E5%99%A8%E6%8F%90%E4%BE%9B%E7%9A%84web%E6%9C%8D%E5%8A%A1%E5%86%85%E5%AE%B9%E4%B8%80%E8%87%B4%E3%80%82-toc" style="margin-left:40px;"><a href="#4.%E9%83%A8%E7%BD%B2NFS%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E5%AE%9E%E7%8E%B0%E9%9B%86%E7%BE%A4%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%8C%E5%9C%A8nginx%E5%AE%B9%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8PV%E5%92%8CPVC%E4%B8%8ENFS%E8%9E%8D%E5%90%88%EF%BC%8C%E4%BF%9D%E8%AF%81%E5%AE%B9%E5%99%A8%E6%8F%90%E4%BE%9B%E7%9A%84web%E6%9C%8D%E5%8A%A1%E5%86%85%E5%AE%B9%E4%B8%80%E8%87%B4%E3%80%82" rel="nofollow">4.部署NFS服务器，实现集群的数据一致性，在nginx容器中使用PV和PVC与NFS融合，保证容器提供的web服务内容一致。</a></p> 
 <p id="4.1.%E6%90%AD%E5%BB%BA%E5%A5%BDnfs%E6%9C%8D%E5%8A%A1%E5%99%A8-toc" style="margin-left:80px;"><a href="#4.1.%E6%90%AD%E5%BB%BA%E5%A5%BDnfs%E6%9C%8D%E5%8A%A1%E5%99%A8" rel="nofollow">4.1.搭建好nfs服务器</a></p> 
 <p id="4.2.%E5%88%9B%E5%BB%BApv%E4%BD%BF%E7%94%A8nfs%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84%E5%85%B1%E4%BA%AB%E7%9B%AE%E5%BD%95%EF%BC%88%E5%9C%A8master%E4%B8%8A%E6%93%8D%E4%BD%9C%EF%BC%89-toc" style="margin-left:80px;"><a href="#4.2.%E5%88%9B%E5%BB%BApv%E4%BD%BF%E7%94%A8nfs%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84%E5%85%B1%E4%BA%AB%E7%9B%AE%E5%BD%95%EF%BC%88%E5%9C%A8master%E4%B8%8A%E6%93%8D%E4%BD%9C%EF%BC%89" rel="nofollow">4.2.创建pv使用nfs服务器上的共享目录（在master上操作）</a></p> 
 <p id="4.3.%E5%88%9B%E5%BB%BApvc%E4%BD%BF%E7%94%A8pv-toc" style="margin-left:80px;"><a href="#4.3.%E5%88%9B%E5%BB%BApvc%E4%BD%BF%E7%94%A8pv" rel="nofollow">4.3.创建pvc使用pv</a></p> 
 <p id="4.4.%E6%8C%87%E5%AE%9Apod%E4%BD%BF%E7%94%A8pvc-toc" style="margin-left:80px;"><a href="#4.4.%E6%8C%87%E5%AE%9Apod%E4%BD%BF%E7%94%A8pvc" rel="nofollow">4.4.指定pod使用pvc</a></p> 
 <p id="5.%E6%9E%84%E5%BB%BACI%2FCD%E7%8E%AF%E5%A2%83%EF%BC%8C%E5%AE%89%E8%A3%85gitlab%EF%BC%8CJenkins%EF%BC%8Charbor%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83%E3%80%81%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C%E3%80%81%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E7%AD%89%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%B7%A5%E4%BD%9C%E3%80%82-toc" style="margin-left:40px;"><a href="#5.%E6%9E%84%E5%BB%BACI%2FCD%E7%8E%AF%E5%A2%83%EF%BC%8C%E5%AE%89%E8%A3%85gitlab%EF%BC%8CJenkins%EF%BC%8Charbor%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83%E3%80%81%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C%E3%80%81%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E7%AD%89%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%B7%A5%E4%BD%9C%E3%80%82" rel="nofollow">5.构建CI/CD环境，安装gitlab，Jenkins，harbor实现代码发布、镜像制作、数据备份等流水线工作。</a></p> 
 <p id="5.1.%E6%90%AD%E5%BB%BA%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93harbor-toc" style="margin-left:80px;"><a href="#5.1.%E6%90%AD%E5%BB%BA%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93harbor" rel="nofollow">5.1.搭建私有仓库harbor</a></p> 
 <p id="5.1.1.%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%EF%BC%9A-toc" style="margin-left:120px;"><a href="#5.1.1.%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%EF%BC%9A" rel="nofollow">5.1.1.环境准备：</a></p> 
 <p id="5.1.2.harbor%E5%AE%89%E8%A3%85%E8%BF%87%E7%A8%8B-toc" style="margin-left:120px;"><a href="#5.1.2.harbor%E5%AE%89%E8%A3%85%E8%BF%87%E7%A8%8B" rel="nofollow">5.1.2.harbor安装过程</a></p> 
 <p id="5.1.3.%E6%9C%AC%E6%9C%BA%E4%B8%8A%E4%BC%A0%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F-toc" style="margin-left:120px;"><a href="#5.1.3.%E6%9C%AC%E6%9C%BA%E4%B8%8A%E4%BC%A0%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F" rel="nofollow">5.1.3.本机上传拉取镜像</a></p> 
 <p id="5.2.%E6%90%AD%E5%BB%BAgitlab-toc" style="margin-left:80px;"><a href="#5.2.%E6%90%AD%E5%BB%BAgitlab" rel="nofollow">5.2.搭建gitlab</a></p> 
 <p id="5.3.%E5%AE%89%E8%A3%85Jenkins-toc" style="margin-left:80px;"><a href="#5.3.%E5%AE%89%E8%A3%85Jenkins" rel="nofollow">5.3.安装Jenkins</a></p> 
 <p id="6.%E4%BD%BF%E7%94%A8Prometheus%E5%AF%B9k8s%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E7%9B%91%E6%8E%A7%EF%BC%8C%E5%9C%A8Grafana%E4%B8%AD%E9%85%8D%E7%BD%AE%E5%A5%BDPrometheus%E7%9A%84%E6%95%B0%E6%8D%AE%E6%BA%90%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%B1%95%E7%A4%BA%EF%BC%8C%E6%9B%B4%E7%9B%B4%E8%A7%82%E5%9C%B0%E7%9B%91%E6%8E%A7%E6%95%B4%E4%B8%AAweb%E9%9B%86%E7%BE%A4%E7%9A%84%E6%80%A7%E8%83%BD%E3%80%82-toc" style="margin-left:40px;"><a href="#6.%E4%BD%BF%E7%94%A8Prometheus%E5%AF%B9k8s%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E7%9B%91%E6%8E%A7%EF%BC%8C%E5%9C%A8Grafana%E4%B8%AD%E9%85%8D%E7%BD%AE%E5%A5%BDPrometheus%E7%9A%84%E6%95%B0%E6%8D%AE%E6%BA%90%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%B1%95%E7%A4%BA%EF%BC%8C%E6%9B%B4%E7%9B%B4%E8%A7%82%E5%9C%B0%E7%9B%91%E6%8E%A7%E6%95%B4%E4%B8%AAweb%E9%9B%86%E7%BE%A4%E7%9A%84%E6%80%A7%E8%83%BD%E3%80%82" rel="nofollow">6.使用Prometheus对k8s集群进行监控，在Grafana中配置好Prometheus的数据源进行数据展示，更直观地监控整个web集群的性能。</a></p> 
 <p id="6.1.%E4%BD%BF%E7%94%A8Docker%E5%AE%B9%E5%99%A8%E9%83%A8%E7%BD%B2Prometheus-toc" style="margin-left:80px;"><a href="#6.1.%E4%BD%BF%E7%94%A8Docker%E5%AE%B9%E5%99%A8%E9%83%A8%E7%BD%B2Prometheus" rel="nofollow">6.1.使用Docker容器部署Prometheus</a></p> 
 <p id="6.2.%E9%85%8D%E7%BD%AEGrafana-toc" style="margin-left:80px;"><a href="#6.2.%E9%85%8D%E7%BD%AEGrafana" rel="nofollow">6.2.配置Grafana</a></p> 
 <p id="7.%E9%83%A8%E7%BD%B2ingress%E7%BB%99web%E4%B8%9A%E5%8A%A1%E8%BF%9B%E8%A1%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%8C%E4%BD%BF%E7%94%A8%E6%8E%A2%E9%92%88%EF%BC%88liveless%5Creadiness%5Cstartup%EF%BC%89%E7%9A%84httpGET%E5%92%8Cexec%E6%96%B9%E6%B3%95%E8%AF%95%E6%8E%A2pod%E8%83%BD%E5%90%A6%E6%AD%A3%E5%B8%B8%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%A2%9E%E5%BC%BA%E4%B8%9A%E5%8A%A1pod%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7-toc" style="margin-left:40px;"><a href="#7.%E9%83%A8%E7%BD%B2ingress%E7%BB%99web%E4%B8%9A%E5%8A%A1%E8%BF%9B%E8%A1%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%8C%E4%BD%BF%E7%94%A8%E6%8E%A2%E9%92%88%EF%BC%88liveless%5Creadiness%5Cstartup%EF%BC%89%E7%9A%84httpGET%E5%92%8Cexec%E6%96%B9%E6%B3%95%E8%AF%95%E6%8E%A2pod%E8%83%BD%E5%90%A6%E6%AD%A3%E5%B8%B8%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%A2%9E%E5%BC%BA%E4%B8%9A%E5%8A%A1pod%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7" rel="nofollow">7.部署ingress给web业务进行负载均衡，使用探针（liveless\readiness\startup）的httpGET和exec方法试探pod能否正常提供服务，增强业务pod的可靠性</a></p> 
 <p id="7.1.%E5%AE%9A%E4%B9%89%E6%8E%A2%E9%92%88-toc" style="margin-left:80px;"><a href="#7.1.%E5%AE%9A%E4%B9%89%E6%8E%A2%E9%92%88" rel="nofollow">7.1.定义探针</a></p> 
 <p id="7.2.%E9%83%A8%E7%BD%B2ingress%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-toc" style="margin-left:80px;"><a href="#7.2.%E9%83%A8%E7%BD%B2ingress%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" rel="nofollow">7.2.部署ingress实现负载均衡</a></p> 
 <p id="7.2.1.%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2ingress%20controller-toc" style="margin-left:120px;"><a href="#7.2.1.%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2ingress%20controller" rel="nofollow">7.2.1.安装部署ingress controller</a></p> 
 <p id="7.2.2.%E6%A3%80%E6%9F%A5pod%E6%98%AF%E5%90%A6%E5%90%AF%E5%8A%A8-toc" style="margin-left:120px;"><a href="#7.2.2.%E6%A3%80%E6%9F%A5pod%E6%98%AF%E5%90%A6%E5%90%AF%E5%8A%A8" rel="nofollow">7.2.2.检查pod是否启动</a></p> 
 <p id="7.3.%E5%88%9B%E5%BB%BAingress%E8%B5%84%E6%BA%90-toc" style="margin-left:80px;"><a href="#7.3.%E5%88%9B%E5%BB%BAingress%E8%B5%84%E6%BA%90" rel="nofollow">7.3.创建ingress资源</a></p> 
 <p id="7.3.1.%E5%90%AF%E5%8A%A8service%EF%BC%8C%E6%9A%B4%E9%9C%B2nginx-toc" style="margin-left:120px;"><a href="#7.3.1.%E5%90%AF%E5%8A%A8service%EF%BC%8C%E6%9A%B4%E9%9C%B2nginx" rel="nofollow">7.3.1.启动service，暴露nginx</a></p> 
 <p id="7.3.2.%E5%88%9B%E5%BB%BAyaml%E6%96%87%E4%BB%B6%EF%BC%8C%E5%90%AF%E5%8A%A8ingress-toc" style="margin-left:120px;"><a href="#7.3.2.%E5%88%9B%E5%BB%BAyaml%E6%96%87%E4%BB%B6%EF%BC%8C%E5%90%AF%E5%8A%A8ingress" rel="nofollow">7.3.2.创建yaml文件，启动ingress</a></p> 
 <p id="7.3.3.%E6%9F%A5%E7%9C%8B%E5%88%9B%E5%BB%BA%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F-toc" style="margin-left:120px;"><a href="#7.3.3.%E6%9F%A5%E7%9C%8B%E5%88%9B%E5%BB%BA%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F" rel="nofollow">7.3.3.查看创建是否成功</a></p> 
 <p id="7.3.4.%E9%AA%8C%E8%AF%81-toc" style="margin-left:120px;"><a href="#7.3.4.%E9%AA%8C%E8%AF%81" rel="nofollow">7.3.4.验证</a></p> 
 <p id="8.%E5%AE%89%E8%A3%85k8s%E7%9A%84dashboard%E5%AF%B9%E6%95%B4%E4%B8%AA%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E8%BF%9B%E8%A1%8C%E6%8E%8C%E6%8E%A7%E4%BA%86%E8%A7%A3-toc" style="margin-left:40px;"><a href="#8.%E5%AE%89%E8%A3%85k8s%E7%9A%84dashboard%E5%AF%B9%E6%95%B4%E4%B8%AA%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E8%BF%9B%E8%A1%8C%E6%8E%8C%E6%8E%A7%E4%BA%86%E8%A7%A3" rel="nofollow">8.安装k8s的dashboard对整个集群资源进行掌控了解</a></p> 
 <p id="8.1.%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-toc" style="margin-left:80px;"><a href="#8.1.%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" rel="nofollow">8.1.准备工作</a></p> 
 <p id="8.2.%E5%90%AF%E5%8A%A8dashboard-toc" style="margin-left:80px;"><a href="#8.2.%E5%90%AF%E5%8A%A8dashboard" rel="nofollow">8.2.启动dashboard</a></p> 
 <p id="8.2.1.%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-toc" style="margin-left:120px;"><a href="#8.2.1.%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" rel="nofollow">8.2.1.应用配置文件</a></p> 
 <p id="8.2.2.%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E5%90%AF%E5%8A%A8dashboard%E7%9A%84%E5%90%AF%E5%8A%A8%E6%83%85%E5%86%B5-toc" style="margin-left:120px;"><a href="#8.2.2.%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E5%90%AF%E5%8A%A8dashboard%E7%9A%84%E5%90%AF%E5%8A%A8%E6%83%85%E5%86%B5" rel="nofollow">8.2.2.查看是否启动dashboard的启动情况</a></p> 
 <p id="8.2.3.%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE%EF%BC%88%E4%BD%BF%E7%94%A8https%E5%8D%8F%E8%AE%AE%E8%AE%BF%E9%97%AE%EF%BC%89-toc" style="margin-left:120px;"><a href="#8.2.3.%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE%EF%BC%88%E4%BD%BF%E7%94%A8https%E5%8D%8F%E8%AE%AE%E8%AE%BF%E9%97%AE%EF%BC%89" rel="nofollow">8.2.3.浏览器访问（使用https协议访问）</a></p> 
 <p id="%E9%A1%B9%E7%9B%AE%E5%BF%83%E5%BE%97-toc" style="margin-left:0px;"><a href="#%E9%A1%B9%E7%9B%AE%E5%BF%83%E5%BE%97" rel="nofollow">项目心得</a></p> 
 <hr> 
 <p><strong>项目名称</strong></p> 
</div> 
<p>基于k8s+docker+Prometheus的可监控高可用web集群</p> 
<h2 id="%E9%A1%B9%E7%9B%AE%E7%8E%AF%E5%A2%83"><a id="_19"></a>项目环境</h2> 
<p>centos 7.9、Kubernetes v1.20.6、Docker 23.0.3、ansible 2.9.27、Prometheus 2.42、Grafana 9.1.2等</p> 
<h2 id="%E9%A1%B9%E7%9B%AE%E6%8F%8F%E8%BF%B0">项目描述</h2> 
<p>模拟企业中的生产环境，底层采用k8s管理的docker集群提供web服务，通过ansible实现自动化运维，使用NFS实现数据同源，利用Prometheus实现监控功能并通过Grafana进行监控数据可视化，搭建Jenkins构建CI/CD环境，构造一个高并发，高可用的web集群。</p> 
<h2 id="%E9%A1%B9%E7%9B%AE%E6%AD%A5%E9%AA%A4">项目步骤</h2> 
<h3 id="1.%E8%A7%84%E5%88%92%E8%AE%BE%E8%AE%A1%E6%95%B4%E4%B8%AA%E9%9B%86%E7%BE%A4%E7%9A%84%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84%EF%BC%8C%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99%E5%92%8C%E5%A0%A1%E5%9E%92%E6%9C%BA%EF%BC%8C%E5%9C%A8%E5%A0%A1%E5%9E%92%E6%9C%BA%E4%B8%8A%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2ansible%E6%9C%8D%E5%8A%A1%E3%80%82" style="text-align:left;">1.规划设计整个集群的网络拓扑结构，配置防火墙和堡垒机，在堡垒机上安装部署ansible服务。</h3> 
<h4 id="1.1.%E8%A7%84%E5%88%92%E8%AE%BE%E8%AE%A1%E9%9B%86%E7%BE%A4%E7%9A%84%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84">1.1.规划设计集群的网络拓扑结构</h4> 
<p><img alt="" height="919" src="https://images2.imgbox.com/5c/9d/v8FnKkHm_o.png" width="1200"></p> 
<h4 id="1.2.%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">1.2.前期准备工作</h4> 
<p>所有服务器都关闭防火墙和selinux</p> 
<pre><code>#关闭防火墙
systemctl disable firewalld

#关闭selinux
sed -i '/^SELINUX=/ s/enforcing/disabled/' /etc/selinux/config</code></pre> 
<h4 id="1.3.%E9%85%8D%E7%BD%AE%E9%98%B2%E7%81%AB%E5%A2%99">1.3.配置防火墙</h4> 
<p>在防火墙服务器上开启路由功能并添加SNAT/DANT策略</p> 
<pre><code>#编辑脚本配置SNAT策略，实现从内网访问外网
#!/bin/bash
 
#清除filter表和nat表里的防火墙规则
iptables -F
iptables -t nat -F
 
#snat策略
iptables -t nat -A POSTROUTING -s 192.168.81.0/24 -o ens33 -j SNAT --to-source 192.168.43.128
 
#开启路由功能
echo 1 &gt; /proc/sys/net/ipv4/ip_forward</code></pre> 
<pre><code>#在实现SNAT的基础上，编辑标本添加DNAT策略，实现从外网访问内网
#!/bin/bash
 
#清除filter表和nat表里的防火墙规则
iptables -F
iptables -t nat -F
 
#snat策略
iptables -t nat -A POSTROUTING -s 192.168.81.0/24 -o ens33 -j SNAT --to-source 192.168.43.128
 
#开启路由功能
echo 1 &gt; /proc/sys/net/ipv4/ip_forward
 
#dnat
#dnat web
iptables -t nat -A PREROUTING -i ens33 -d 192.168.43.128 -p tcp --dport 80 -j DNAT --to-destination 192.168.81.0/24</code></pre> 
<h4 id="1.4.%E5%9C%A8%E5%A0%A1%E5%9E%92%E6%9C%BA%E4%B8%8A%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2ansible%E6%9C%8D%E5%8A%A1">1.4.在堡垒机上安装部署ansible服务</h4> 
<pre><code>#1.从ansible上生成ssh密钥同步到两台node主机上，实现无密钥登陆管理
[root@localhost ~]# ssh-keygen
 
#2.建立免密通道
[root@localhost ~]# ssh-copy-id -i id_rsa.pub root@192.168.81.54
[root@localhost .ssh]# ssh-copy-id -i id_rsa.pub root@192.168.81.98
[root@localhost .ssh]# ssh-copy-id -i id_rsa.pub root@192.168.81.99
[root@localhost .ssh]# ssh-copy-id -i id_rsa.pub root@192.168.81.97
 
#3.验证是否建立成功（远程登陆）
[root@ansible ~]# ssh 'root@192.168.81.54'
Last login: Fri Apr  7 10:28:46 2023
[root@lb1 ~]# exit
登出
Connection to 192.168.81.54 closed.
[root@ansible ~]# ssh 'root@192.168.81.99'
Last login: Fri Apr  7 10:28:57 2023
[root@lb2 ~]# exit
登出
Connection to 192.168.81.99 closed.
[root@ansible ~]# ssh 'root@192.168.81.98'
Last login: Fri Apr  7 10:29:22 2023
[root@web2 ~]# exit
登出
Connection to 192.168.81.98 closed.
[root@ansible ~]# ssh 'root@192.168.81.97'
Last login: Fri Apr  7 10:29:53 2023 from 192.168.81.97
 
#4.安装ansible
[root@ansible ~]# yum install epel-release -y 
[root@ansible ~]# yum install ansible -y
 
 
#5.将node主机添加到管主机单中
[root@ansible ~]# cd /etc/ansible
[root@ansible ansible]# ls
ansible.cfg  hosts  roles
[root@ansible ansible]# cat hosts 
[webservers]
192.168.81.54
192.168.81.99
192.168.81.98
192.168.81.97</code></pre> 
<h3 id="2.%E5%AE%89%E8%A3%85Kubeadm%E9%83%A8%E7%BD%B2%E5%8D%95master%E7%9A%84%E9%9B%86%E7%BE%A4%EF%BC%8C%E5%BD%A2%E6%88%901%E5%8F%B0master2%E5%8F%B0node%E7%9A%84%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E3%80%82%E4%BD%BF%E7%94%A8deployment%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%90%AF%E5%8A%A8nginx%E7%9A%84pod%E4%BD%9C%E4%B8%BAweb%E5%BA%94%E7%94%A8%E3%80%82">2.安装Kubeadm部署单master的集群，形成1台master2台node的集群环境。使用deployment在集群中启动nginx的pod作为web应用。</h3> 
<h4 id="2.1.k8s%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA">2.1.k8s集群搭建</h4> 
<p>k8s集群具体的搭建过程在之前的文章中有详细介绍，此处不过多赘述：</p> 
<p><a href="https://blog.csdn.net/yuer1228/article/details/130700638?spm=1001.2014.3001.5501" title="K8S安装部署的详细步骤与注意事项！_本地安装k8s_钰儿yu1228的博客-CSDN博客">K8S安装部署的详细步骤与注意事项！_本地安装k8s_钰儿yu1228的博客-CSDN博客</a></p> 
<h4 id="2.2.%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%90%AF%E5%8A%A8nginx">2.2.在集群中启动nginx</h4> 
<p>编写一个yaml文件nginx.yaml，使用deployment控制器，启动一个nginx的pod，3个副本，然后创建一个服务service-nginx，发布nginx集群（使用deployment控制器启动pod）</p> 
<pre><code>[root@k8smaster service]# cat nginx-3.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment-3
  labels:
    app: nginx-3
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx-3
  template:
    metadata:
      labels:
        app: nginx-3
    spec:
      containers:
      - name: nginx
        image: nginx
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
          name: http-web-svc

---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service-3
spec:
  type: NodePort
  selector:
    app: nginx-3
  ports:
  - name: name-of-service-port
    protocol: TCP
    port: 80
    targetPort: http-web-svc
    nodePort: 30008</code></pre> 
<p>验证：</p> 
<p><img alt="" height="745" src="https://images2.imgbox.com/80/83/xufLWqS6_o.png" width="1200"></p> 
<h3 id="3.%E5%AE%89%E8%A3%85metrics-server%EF%BC%8C%E9%87%87%E7%94%A8HPA%E6%8A%80%E6%9C%AF%EF%BC%8C%E8%AE%A9pod%E8%BE%BE%E5%88%B0%E8%87%AA%E5%8A%A8%E7%BC%A9%E6%94%BE%E6%95%88%E6%9E%9C%E3%80%82%E5%BD%93CPU%E4%BD%BF%E7%94%A8%E7%8E%87%E8%BE%BE%E5%88%B050%25%E8%BF%9B%E8%A1%8C%E6%B0%B4%E5%B9%B3%E6%89%A9%E7%BC%A9%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%90%AF%E5%8A%A8%E6%9C%80%E5%B0%8F20%E4%B8%AApod%EF%BC%8C%E6%9C%80%E5%A4%9A40%E4%B8%AApod%E3%80%82">3.安装metrics-server，采用HPA技术，让pod达到自动缩放效果。当CPU使用率达到50%进行水平扩缩，实现启动最小20个pod，最多40个pod。</h3> 
<h4 id="3.1.%E5%AE%89%E8%A3%85%E5%A5%BDmetrics-server%EF%BC%8C%E8%BF%90%E8%A1%8Cphp-apache">3.1.安装好metrics-server，运行php-apache</h4> 
<pre><code>[root@k8smaster hpa]# wget https://k8s.io/examples/application/php-apache.yaml</code></pre> 
<h4 id="3.2.%E4%B8%8A%E4%BC%A0hpa.example.tar%E7%9A%84%E9%95%9C%E5%83%8F%E5%88%B0%E4%B8%A4%E4%B8%AAnode%E8%8A%82%E7%82%B9%E4%B8%8A">3.2.上传hpa.example.tar的镜像到两个node节点上</h4> 
<p><img alt="" height="383" src="https://images2.imgbox.com/55/60/hHX2jAEk_o.png" width="1200"></p> 
<h4 id="3.3.%E4%BF%AE%E6%94%B9php-apache.yaml" style="background-color:transparent;">3.3.修改php-apache.yaml</h4> 
<p>增加配置修改参数，防止再次拉取hpa镜像</p> 
<pre><code>    spec:
      containers:
      - name: nginx-3
        image: k8s.gcr.io/hpa-example  
        imagePullPolicy: IfNotPresent  #添加，当镜像在本地有时不再重新拉取镜像</code></pre> 
<h4 id="3.4.%E5%90%AF%E5%8A%A8pod">3.4.启动pod</h4> 
<pre><code>[root@k8smaster hpa]# kubectl apply -f php-apache.yaml
[root@k8smaster hpa]# kubectl get pod -o wide
NAME                                READY   STATUS    RESTARTS   AGE    IP               NODE        NOMINATED NODE   READINESS GATES
nginx-deployment-559d658b74-2247s   1/1     Running   0          86m    10.244.62.166    k8snode-1   &lt;none&gt;           &lt;none&gt;
nginx-deployment-559d658b74-cv6zr   1/1     Running   0          106m   10.244.62.165    k8snode-1   &lt;none&gt;           &lt;none&gt;
nginx-deployment-559d658b74-sr2jv   1/1     Running   0          107m   10.244.163.156   k8snode-2   &lt;none&gt;           &lt;none&gt;
php-apache-567d9f79d-jkqwb          1/1     Running   0          5s     10.244.163.160   k8snode-2   &lt;none&gt;           &lt;none&gt;</code></pre> 
<h4 id="3.5.%E5%A2%9E%E5%8A%A0%E6%B0%B4%E5%B9%B3%E6%89%A9%E7%BC%A9%EF%BC%8C%E5%88%9B%E5%BB%BAhpa" style="background-color:transparent;">3.5.增加水平扩缩，创建hpa</h4> 
<pre><code>kubectl autoscale deployment php-apache --cpu-percent=50 --min=20 --max=40
[root@k8smaster hpa]# kubectl get hpa
NAME         REFERENCE               TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
php-apache   Deployment/php-apache   0%/10%    1         10        1          16s</code></pre> 
<h4 id="3.6.%E9%AA%8C%E8%AF%81%E6%95%88%E6%9E%9C">3.6.验证效果</h4> 
<p>增加负载：</p> 
<p>客户端 Pod 中的容器在无限循环中运行，向 php-apache 服务发送查询。</p> 
<pre><code>kubectl run -i --tty load-generator --rm --image=busybox:1.28 --restart=Never -- /bin/sh -c "while sleep 0.01; do wget -q -O- http://php-apache; done"</code></pre> 
<h2 id="%E2%80%8B%E7%BC%96%E8%BE%91"><img alt="" height="284" src="https://images2.imgbox.com/f7/3f/t1jjUAiQ_o.png" width="1200"></h2> 
<p>将启动pod的最大值设置为10，方便观察效果：</p> 
<p><img alt="" height="634" src="https://images2.imgbox.com/18/e6/ZvpACviT_o.png" width="1200"></p> 
<p>ctrl+c停止负载后的效果：</p> 
<p><img alt="" height="149" src="https://images2.imgbox.com/76/22/z9DSK14g_o.png" width="1200"></p> 
<p>动态观察变化：</p> 
<pre><code>kubectl get hpa php-apache --watch</code></pre> 
<h3 id="4.%E9%83%A8%E7%BD%B2NFS%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E5%AE%9E%E7%8E%B0%E9%9B%86%E7%BE%A4%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%8C%E5%9C%A8nginx%E5%AE%B9%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8PV%E5%92%8CPVC%E4%B8%8ENFS%E8%9E%8D%E5%90%88%EF%BC%8C%E4%BF%9D%E8%AF%81%E5%AE%B9%E5%99%A8%E6%8F%90%E4%BE%9B%E7%9A%84web%E6%9C%8D%E5%8A%A1%E5%86%85%E5%AE%B9%E4%B8%80%E8%87%B4%E3%80%82">4.部署NFS服务器，实现集群的数据一致性，在nginx容器中使用PV和PVC与NFS融合，保证容器提供的web服务内容一致。</h3> 
<h4 id="4.1.%E6%90%AD%E5%BB%BA%E5%A5%BDnfs%E6%9C%8D%E5%8A%A1%E5%99%A8">4.1.搭建好nfs服务器</h4> 
<p>搭建好nfs服务器，在k8s集群中的每个节点上都安装相关软件，因为节点服务器里创建卷需要支持nfs网络文件系统：</p> 
<pre><code>[root@k8smaster ~]# yum install nfs-utils -y</code></pre> 
<p>设置共享目录：</p> 
<pre><code>[root@nfs ~]# cat /etc/exports
/web 192.168.81.0/24(ro,all_squash,sync)
[root@nfs /]# cd web
[root@nfs web]# ls
index.html  sanchuang
[root@nfs web]# cat index.html 
Welcome!!!
Good luck to you!!
Have fun!
[root@nfs web]# exportfs -rv
exporting 192.168.81.0/24:/web</code></pre> 
<p>测试k8s集群能否挂载nfs共享目录：</p> 
<pre><code>[root@k8smaster ~]# mkdir /pv_pvc
[root@k8smaster ~]# mount 192.168.81.201:/web /pv_pvc
[root@k8smaster ~]# cd /pv_pvc/
[root@k8smaster pv_pvc]# ls
index.html  sanchuang</code></pre> 
<h4 id="4.2.%E5%88%9B%E5%BB%BApv%E4%BD%BF%E7%94%A8nfs%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84%E5%85%B1%E4%BA%AB%E7%9B%AE%E5%BD%95%EF%BC%88%E5%9C%A8master%E4%B8%8A%E6%93%8D%E4%BD%9C%EF%BC%89">4.2.创建pv使用nfs服务器上的共享目录（在master上操作）</h4> 
<pre><code>[root@k8smaster pv]# pwd
/root/pv
[root@k8smaster pv]# cat nfs-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata: 
  name: sc-nginx-pv
  labels: 
    type: sc-nginx-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteMany
  storageClassName: nfs
  nfs:
    path: "/web"
    server: 192.168.81.201
    readOnly: false
[root@k8smaster pv]# kubectl apply -f nfs-pv.yaml </code></pre> 
<h4 id="4.3.%E5%88%9B%E5%BB%BApvc%E4%BD%BF%E7%94%A8pv">4.3.创建pvc使用pv</h4> 
<pre><code>[root@k8smaster pv]# cat nfs-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata: 
  name: sc-nginx-pvc
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: nfs   #使用nfs类型的pv
[root@k8smaster pv]# kubectl  apply -f nfs-pvc.yaml </code></pre> 
<h4 id="4.4.%E6%8C%87%E5%AE%9Apod%E4%BD%BF%E7%94%A8pvc">4.4.指定pod使用pvc</h4> 
<pre><code>[root@k8smaster pv]# cat nginx-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata: 
  name: nginx-deployment
  labels: 
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      volumes:
        - name: sc-pv-storage-nfs
          persistentVolumeClaim:
            claimName: sc-nginx-pvc
      containers:
        - name: sc-pv-container-nfs
          image: nginx
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80
              name: "http-server"
          volumeMounts:
            - mountPath: "/usr/share/nginx/html"
              name: sc-pv-storage-nfs
  [root@k8smaster pv]# kubectl apply -f nginx-deployment.yaml </code></pre> 
<p>验证：</p> 
<pre><code>[root@k8smaster pv]# curl 10.244.62.184 
Welcome!!!
Good luck to you!!
Have fun!</code></pre> 
<h3 id="5.%E6%9E%84%E5%BB%BACI%2FCD%E7%8E%AF%E5%A2%83%EF%BC%8C%E5%AE%89%E8%A3%85gitlab%EF%BC%8CJenkins%EF%BC%8Charbor%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E5%8F%91%E5%B8%83%E3%80%81%E9%95%9C%E5%83%8F%E5%88%B6%E4%BD%9C%E3%80%81%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E7%AD%89%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%B7%A5%E4%BD%9C%E3%80%82">5.构建CI/CD环境，安装gitlab，Jenkins，harbor实现代码发布、镜像制作、数据备份等流水线工作。</h3> 
<h4 id="5.1.%E6%90%AD%E5%BB%BA%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93harbor">5.1.搭建私有仓库harbor</h4> 
<h5 id="5.1.1.%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%EF%BC%9A">5.1.1.环境准备：</h5> 
<p>1.提前安装docker和docker compose</p> 
<p>2.下载harbor的源码</p> 
<p>3.将源码上传到Linux服务器</p> 
<pre><code>[root@docker Dockerfile]# mkdir harbor
[root@docker Dockerfile]# cd harbor/
[root@docker harbor]# ls
harbor-offline-installer-v2.1.0.tgz

#对文件进行解压
[root@docker harbor]# tar xf harbor-offline-installer-v2.1.0.tgz 
[root@docker harbor]# cp harbor.yml.tmpl harbor.yml</code></pre> 
<h5 id="5.1.2.harbor%E5%AE%89%E8%A3%85%E8%BF%87%E7%A8%8B">5.1.2.harbor安装过程</h5> 
<p>修改配置文件：</p> 
<pre><code>[root@docker harbor]# vim harbor.yml
hostname: 192.168.81.140  #修改

# http related config
http:
  # port for http, default is 80. If https enabled, this port will redirect to https port
  port: 8090  #修改
  
  #如果没有证书，可以在配置文件中注释掉https的相关内容</code></pre> 
<p>上传docker-compose文件，并赋予可执行权限：</p> 
<pre><code>[root@docker harbor]# chmod +x docker-compose 

#将docker-compose存放到PATH变量目录下就可以
#[root@docker harbor]# cp docker-compose /usr/bin/</code></pre> 
<p>执行安装操作：</p> 
<p>[root@docker harbor]# ./install.sh </p> 
<p>访问：</p> 
<p>在windows机器上访问网站，配置harbor</p> 
<p>默认登陆的用户名和密码：</p> 
<p>admin   Harbor12345</p> 
<p>在harbor中创建一个项目sanchuang</p> 
<p>新建自己的用户名和密码</p> 
<h5 id="5.1.3.%E6%9C%AC%E6%9C%BA%E4%B8%8A%E4%BC%A0%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F">5.1.3.本机上传拉取镜像</h5> 
<p>在另外一台docker宿主机上使用这个仓库：</p> 
<pre><code>[root@docker ~]# cat /etc/docker/daemon.json 
{
"registry-mirrors": ["https://registry.docker-cn.com"],
"insecure-registries" : ["192.168.81.140:8090"]
}

#重启docker
[root@docker ~]# systemctl daemon-reload
[root@docker ~]# systemctl restart docker</code></pre> 
<p>修改镜像名字：</p> 
<pre><code>[root@docker ~]# docker tag nginx:latest 192.168.81.140:8090/sanchuang/nginx:latest</code></pre> 
<p>登陆私有仓库：</p> 
<pre><code>[root@docker harbor]# docker login 192.168.81.140:8090
Username: lay
Password: 
WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded</code></pre> 
<p>推送镜像到私人仓库：</p> 
<pre><code>[root@docker harbor]# docker push 192.168.81.140:8090/sanchuang/nginx:latest</code></pre> 
<h4 id="5.2.%E6%90%AD%E5%BB%BAgitlab">5.2.搭建gitlab</h4> 
<p>参考官网流程：https://gitlab.cn/install/</p> 
<p><img alt="" height="784" src="https://images2.imgbox.com/cd/23/oZI1QsOD_o.png" width="1200"></p> 
<p>根据提示配置域名：</p> 
<pre><code>[root@gitlab ~]# vim /etc/gitlab/gitlab.rb</code></pre> 
<h2><img alt="" height="235" src="https://images2.imgbox.com/03/4f/NgcsP3bl_o.png" width="1200"></h2> 
<pre><code>#启动极狐gitlab
[root@gitlab ~]#  sudo gitlab-ctl reconfigure</code></pre> 
<p>获取初始化密码：</p> 
<pre><code>[root@gitlab ~]# cat /etc/gitlab/initial_root_password
# WARNING: This value is valid only in the following conditions
#          1. If provided manually (either via `GITLAB_ROOT_PASSWORD` environment variable or via `gitlab_rails['initial_root_password']` setting in `gitlab.rb`, it was provided before database was seeded for the first time (usually, the first reconfigure run).
#          2. Password hasn't been changed manually, either via UI or via command line.
#
#          If the password shown here doesn't work, you must reset the admin password following https://docs.gitlab.com/ee/security/reset_user_password.html#reset-your-root-password.

Password: 87A2+QNqMiSSneececlY37DP0YRPAN31dcFpfAHD3Lk=</code></pre> 
<p>访问页面：</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/0a/f6/hYYFMq2V_o.png" width="1200"></p> 
<h4 id="5.3.%E5%AE%89%E8%A3%85Jenkins">5.3.安装Jenkins</h4> 
<p>安装搭建Jenkins的步骤在之前的文章中有详细的配置过程，此处不过多赘述</p> 
<p><a href="https://blog.csdn.net/yuer1228/article/details/132551200?spm=1001.2014.3001.5501" title="在docker和k8s中安装Jenkins，详细教程！！！_钰儿yu1228的博客-CSDN博客">在docker和k8s中安装Jenkins，详细教程！！！_钰儿yu1228的博客-CSDN博客</a></p> 
<h3 id="6.%E4%BD%BF%E7%94%A8Prometheus%E5%AF%B9k8s%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E7%9B%91%E6%8E%A7%EF%BC%8C%E5%9C%A8Grafana%E4%B8%AD%E9%85%8D%E7%BD%AE%E5%A5%BDPrometheus%E7%9A%84%E6%95%B0%E6%8D%AE%E6%BA%90%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%B1%95%E7%A4%BA%EF%BC%8C%E6%9B%B4%E7%9B%B4%E8%A7%82%E5%9C%B0%E7%9B%91%E6%8E%A7%E6%95%B4%E4%B8%AAweb%E9%9B%86%E7%BE%A4%E7%9A%84%E6%80%A7%E8%83%BD%E3%80%82">6.使用Prometheus对k8s集群进行监控，在Grafana中配置好Prometheus的数据源进行数据展示，更直观地监控整个web集群的性能。</h3> 
<h4 id="6.1.%E4%BD%BF%E7%94%A8Docker%E5%AE%B9%E5%99%A8%E9%83%A8%E7%BD%B2Prometheus">6.1.使用Docker容器部署Prometheus</h4> 
<p><a href="https://blog.csdn.net/yuer1228/article/details/131018138?spm=1001.2014.3001.5501" title="使用Docker容器部署Prometheus_docker部署prometheus_钰儿yu1228的博客-CSDN博客">使用Docker容器部署Prometheus_docker部署prometheus_钰儿yu1228的博客-CSDN博客</a></p> 
<h4 id="6.2.%E9%85%8D%E7%BD%AEGrafana">6.2.配置Grafana</h4> 
<pre><code>#启动grafana工具
[root@localhost prometheus]# service grafana-server start
#设置grafana开机启动
[root@localhost prometheus]# systemctl enable grafana-server</code></pre> 
<p>在Grafana中配置prometheus的数据源，并导入相关模板进行数据可视化展示，界面如图:</p> 
<h2><img alt="" height="1200" src="https://images2.imgbox.com/40/9b/TznIw5ZQ_o.png" width="1200"></h2> 
<h3 id="7.%E9%83%A8%E7%BD%B2ingress%E7%BB%99web%E4%B8%9A%E5%8A%A1%E8%BF%9B%E8%A1%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%8C%E4%BD%BF%E7%94%A8%E6%8E%A2%E9%92%88%EF%BC%88liveless%5Creadiness%5Cstartup%EF%BC%89%E7%9A%84httpGET%E5%92%8Cexec%E6%96%B9%E6%B3%95%E8%AF%95%E6%8E%A2pod%E8%83%BD%E5%90%A6%E6%AD%A3%E5%B8%B8%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%A2%9E%E5%BC%BA%E4%B8%9A%E5%8A%A1pod%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7">7.部署ingress给web业务进行负载均衡，使用探针（liveless\readiness\startup）的httpGET和exec方法试探pod能否正常提供服务，增强业务pod的可靠性</h3> 
<h4 id="7.1.%E5%AE%9A%E4%B9%89%E6%8E%A2%E9%92%88">7.1.定义探针</h4> 
<pre><code>[root@k8smaster probe]# wget https://k8s.io/examples/pods/probe/exec-liveness.yaml  --no-check-certificate

[root@k8smaster probe]# cat exec-liveness.yaml 
apiVersion: v1
kind: Pod
metadata:
  labels:
    test: liveness
  name: liveness-exec
spec:
  containers:
  - name: liveness
    image: busybox  #修改
    args:
    - /bin/sh
    - -c
    - touch /tmp/healthy; sleep 30; rm -f /tmp/healthy; sleep 600
    livenessProbe:
      exec:
        command:
        - cat
        - /tmp/healthy
      initialDelaySeconds: 5
      periodSeconds: 5

[root@k8smaster probe]# kubectl apply -f exec-liveness.yaml </code></pre> 
<h4 id="7.2.%E9%83%A8%E7%BD%B2ingress%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">7.2.部署ingress实现负载均衡</h4> 
<h5 id="7.2.1.%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2ingress%20controller">7.2.1.安装部署ingress controller</h5> 
<pre><code>[root@k8smaster ~]# cd ingress/
[root@k8smaster ingress]# ls
[root@k8smaster ingress]# wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml</code></pre> 
<p>下载拉取相关镜像：</p> 
<pre><code>[root@k8smaster ingress]# docker pull registry.k8s.io/ingress-nginx/controller:v1.8.1@sha256:e5c4824e7375fcf2a393e1c03c293b69759af37a9ca6abdb91b13d78a93da8bd
Error response from daemon: Get https://us-west2-docker.pkg.dev/v2/k8s-artifacts-prod/images/ingress-nginx/controller/manifests/sha256:e5c4824e7375fcf2a393e1c03c293b69759af37a9ca6abdb91b13d78a93da8bd: dial tcp 108.177.125.82:443: connect: connection refused</code></pre> 
<p>将所有的镜像scp到所有的节点服务器上：</p> 
<pre><code>[root@k8smaster ingress]# scp ingress-nginx-controllerv1.1.0.tar.gz k8snode-1:/root
ingress-nginx-controllerv1.1.0.tar.gz                        100%  276MB  45.9MB/s   00:06    
[root@k8smaster ingress]# scp ingress-nginx-controllerv1.1.0.tar.gz k8snode-2:/root

[root@k8smaster ingress]# scp kube-webhook-certgen-v1.1.0.tar.gz k8snode-2:/root
kube-webhook-certgen-v1.1.0.tar.gz                           100%   47MB  48.8MB/s   00:00    
[root@k8smaster ingress]# scp kube-webhook-certgen-v1.1.0.tar.gz k8snode-1:/root</code></pre> 
<p>导入镜像到所有的节点：</p> 
<pre><code>[root@k8snode-1 ~]# docker load -i ingress-nginx-controllerv1.1.0.tar.gz 
[root@k8snode-2 ~]# docker load -i kube-webhook-certgen-v1.1.0.tar.gz </code></pre> 
<p>执行yaml文件，创建ingress controller：</p> 
<pre><code>kubectl apply -f ingress-deploy.yaml</code></pre> 
<h5 id="7.2.2.%E6%A3%80%E6%9F%A5pod%E6%98%AF%E5%90%A6%E5%90%AF%E5%8A%A8">7.2.2.检查pod是否启动</h5> 
<p>查看命名空间：</p> 
<pre><code>[root@k8smaster ingress]# kubectl get ns
NAME              STATUS   AGE
default           Active   99d
ingress-nginx     Active   107s
kube-node-lease   Active   99d
kube-public       Active   99d
kube-system       Active   99d</code></pre> 
<p>查看pod是否启动：</p> 
<pre><code>[root@k8smaster ingress]# kubectl get pod -n ingress-nginx  
NAME                                        READY   STATUS      RESTARTS   AGE
ingress-nginx-admission-create-c6h2b        0/1     Completed   0          2m17s
ingress-nginx-admission-patch-8m4bp         0/1     Completed   1          2m17s
ingress-nginx-controller-6c8ffbbfcf-7qksk   1/1     Running     0          2m17s
ingress-nginx-controller-6c8ffbbfcf-swfjc   1/1     Running     0          2m17s</code></pre> 
<h4 id="7.3.%E5%88%9B%E5%BB%BAingress%E8%B5%84%E6%BA%90">7.3.创建ingress资源</h4> 
<h5 id="7.3.1.%E5%90%AF%E5%8A%A8service%EF%BC%8C%E6%9A%B4%E9%9C%B2nginx">7.3.1.启动service，暴露nginx</h5> 
<pre><code>[root@k8smaster ingress]# kubectl apply -f nginx-3.yaml 
deployment.apps/nginx-deployment-3 created
service/nginx-service-3 configured</code></pre> 
<pre><code>[root@k8smaster ingress]# cat nginx-3.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment-3
  labels:
    app: nginx-3
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx-3
  template:
    metadata:
      labels:
        app: nginx-3
    spec:
      containers:
      - name: nginx-deployment-3
        image: nginx
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
          name: http-web-svc

---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service-3
spec:
  type: NodePort
  selector:
    app: nginx-3
  ports:
  - name: name-of-service-port
    protocol: TCP
    port: 80
    targetPort: 80 </code></pre> 
<p>检查服务是否发布成功：访问服务暴露的ip</p> 
<pre><code>[root@k8smaster service]# kubectl describe svc nginx-service-3
Name:                     nginx-service-3
Namespace:                default
Labels:                   &lt;none&gt;
Annotations:              &lt;none&gt;
Selector:                 app=nginx-3
Type:                     NodePort
IP Families:              &lt;none&gt;
IP:                       10.104.34.53
IPs:                      10.104.34.53
Port:                     name-of-service-port  80/TCP
TargetPort:               http-web-svc/TCP
NodePort:                 name-of-service-port  30080/TCP
Endpoints:                10.244.163.136:80,10.244.163.137:80,10.244.62.147:80
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   &lt;none&gt;
[root@k8smaster service]# kubectl get svc
\NAME              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
kubernetes        ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP          100d
mysql-service     NodePort    10.107.198.6     &lt;none&gt;        3306:30006/TCP   85d
nginx             ClusterIP   None             &lt;none&gt;        80/TCP           85d
nginx-service     ClusterIP   10.98.148.225    &lt;none&gt;        80/TCP           86d
nginx-service-2   NodePort    10.100.239.164   &lt;none&gt;        80:30007/TCP     86d
nginx-service-3   NodePort    10.104.34.53     &lt;none&gt;        80:30080/TCP     85d
php-apache        ClusterIP   10.103.201.130   &lt;none&gt;        80/TCP           96d
[root@k8smaster service]# curl 10.104.34.53 
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre> 
<h5 id="7.3.2.%E5%88%9B%E5%BB%BAyaml%E6%96%87%E4%BB%B6%EF%BC%8C%E5%90%AF%E5%8A%A8ingress">7.3.2.创建yaml文件，启动ingress</h5> 
<pre><code>[root@k8smaster ingress]# cat sc-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: sc-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx-example
  rules:
  - host: www.li.com
    http:
      paths:
      - path: /                 #基于路径的负载均衡
        pathType: Prefix
        backend:
          service:
            name: nginx-service-3    #创建服务的名字
            port:
              number: 80          #宿主机上暴露的端口号
  - host: www.wei.com
    http:
      paths:
      - path: /                 
        pathType: Prefix
        backend:
          service:
            name: nginx-service-4   
            port:
              number: 80        </code></pre> 
<h5 id="7.3.3.%E6%9F%A5%E7%9C%8B%E5%88%9B%E5%BB%BA%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F">7.3.3.查看创建是否成功</h5> 
<pre><code>[root@k8smaster ingress]# kubectl apply -f  sc-ingress.yaml
ingress.networking.k8s.io/sc-ingress created
[root@k8smaster ingress]# kubectl get ingress
NAME         CLASS           HOSTS                           ADDRESS            PORTS   AGE
sc-ingress   nginx-example   www.li.com,www.wei.com  192.168.81.97,192.168.81.98                 80      10s</code></pre> 
<h5 id="7.3.4.%E9%AA%8C%E8%AF%81">7.3.4.验证</h5> 
<p>获取ingress controller对应的service暴露宿主机的端口，访问宿主机和相关端口，就可以验证ingress controller是否能进行负载均衡：</p> 
<pre><code>[root@k8smaster ingress]# kubectl get svc -n ingress-nginx
NAME                                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx-controller             NodePort    10.108.167.155   &lt;none&gt;        80:30065/TCP,443:31369/TCP   24h
ingress-nginx-controller-admission   ClusterIP   10.97.20.100     &lt;none&gt;        443/TCP                      24h</code></pre> 
<p>在其他宿主机或者weindows机器上使用域名访问：</p> 
<pre><code>vim /etc/hosts
#添加配置
192.168.81.97 www.li.com
192.168.81.98 www.wei.com</code></pre> 
<h3 id="8.%E5%AE%89%E8%A3%85k8s%E7%9A%84dashboard%E5%AF%B9%E6%95%B4%E4%B8%AA%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E8%BF%9B%E8%A1%8C%E6%8E%8C%E6%8E%A7%E4%BA%86%E8%A7%A3">8.安装k8s的dashboard对整个集群资源进行掌控了解</h3> 
<h4 id="8.1.%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">8.1.准备工作</h4> 
<p>下载dashboard，修改配置文件：</p> 
<pre><code>wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml


#修改service的配置，其他配置不修改
vim recommended.yaml

kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  type: NodePort  #指定类型
  ports:
    - port: 443
      targetPort: 8443
      nodePort: 30088  #指定宿主机的端口号
  selector:
    k8s-app: kubernetes-dashboard</code></pre> 
<h4 id="8.2.%E5%90%AF%E5%8A%A8dashboard">8.2.启动dashboard</h4> 
<h5 id="8.2.1.%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">8.2.1.应用配置文件</h5> 
<pre><code>[root@k8smaster dashboard]# kubectl apply -f recommended.yaml </code></pre> 
<h5 id="8.2.2.%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E5%90%AF%E5%8A%A8dashboard%E7%9A%84%E5%90%AF%E5%8A%A8%E6%83%85%E5%86%B5">8.2.2.查看是否启动dashboard的启动情况</h5> 
<p>查看pod是否启动：</p> 
<pre><code>[root@k8smaster dashboard]# kubectl get pod --all-namespaces|grep dashboard
kubernetes-dashboard   dashboard-metrics-scraper-66dd8bdd86-xdp79         1/1     Running            0          4m13s
kubernetes-dashboard   kubernetes-dashboard-785c75749d-d9ktr              1/1     Running            0          4m13s</code></pre> 
<p>查看service是否启动：</p> 
<pre><code>[root@k8smaster dashboard]# kubectl get svc --all-namespaces|grep dashboard
kubernetes-dashboard   dashboard-metrics-scraper            ClusterIP   10.100.150.154   &lt;none&gt;        8000/TCP                     3m21s
kubernetes-dashboard   kubernetes-dashboard                 NodePort    10.100.11.255    &lt;none&gt;        443:30088/TCP                3m21s</code></pre> 
<h5 id="8.2.3.%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE%EF%BC%88%E4%BD%BF%E7%94%A8https%E5%8D%8F%E8%AE%AE%E8%AE%BF%E9%97%AE%EF%BC%89">8.2.3.浏览器访问（使用https协议访问）</h5> 
<p>登录界面获取token：</p> 
<pre><code>#获取dashboard的secret的名字
[root@k8smaster dashboard]# kubectl get secret -n kubernetes-dashboard|grep dashboard-token
kubernetes-dashboard-token-7kk6x   kubernetes.io/service-account-token   3      8m34s

#获取secret里的token
[root@k8smaster dashboard]# kubectl describe secret kubernetes-dashboard-token-7kk6x -n kubernetes-dashboard
Name:         kubernetes-dashboard-token-7kk6x
Namespace:    kubernetes-dashboard
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/service-account.name: kubernetes-dashboard
              kubernetes.io/service-account.uid: 9d927444-793e-499d-bbfa-180a448d537a

Type:  kubernetes.io/service-account-token

Data
====
ca.crt:     1066 bytes
namespace:  20 bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IlhzUERpWFY2RmJNV0liTXhfRUFOQzFKLVRyVkh6UV9XRFc4S01EdUItS2MifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi03a2s2eCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjlkOTI3NDQ0LTc5M2UtNDk5ZC1iYmZhLTE4MGE0NDhkNTM3YSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.Tnv4HyLP9tfwQqG_2G6lqIC8Lx4i1irO_i9OLckP_m7wrnDgZsqt-RMQv9ryflYULpSKh1Yvz0poLQZjRoTQulA8hW0L5XD8FETF9oaUMupdgqIyj40NX2-R1UpgJZB5bSxUVifmiDtTYuiw0uYhOG1AOu6TCdap8qhOb_3_NACDifsSaOeAcW2DFvDT9iEG4ycXng6itN4v3Uz4rAF3LYk8F1cliY3rakha_Pl9rqhNZvvTPNMYruuYWeK15Ypl_Kxk1UkJbM4mluaC4XsCDaCihFgkGGY3jXudqljzxNCJiTT8O1LgQVSNkBbw6cqoI4oqcZpHj30Q4ZUyACwivw</code></pre> 
<p>登录成功后，dashboard不能访问任何资源对象，需要RBAC鉴权：</p> 
<pre><code>[root@k8smaster dashboard]# kubectl create clusterrolebinding serviceaccount-cluster-admin --clusterrole=cluster-admin --user=system:serviceaccount:kubernetes-dashboard:kubernetes-dashboard
clusterrolebinding.rbac.authorization.k8s.io/serviceaccount-cluster-admin created
</code></pre> 
<p>验证：</p> 
<p><img alt="" height="1079" src="https://images2.imgbox.com/61/86/KXPCUQdr_o.png" width="1200"></p> 
<h2 id="%E9%A1%B9%E7%9B%AE%E5%BF%83%E5%BE%97">项目心得</h2> 
<p>通过完成这个项目，对容器化、集群管理和监控知识更加熟悉，对于k8s的架构和组件更加了解。通过解决问题，进一步提升了技术和解决问题的能力</p> 
<h3><a id="1_20"></a></h3>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1aeb1c3bf44cf878be431c2228847918/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Mac】编译Spring 源码和Idea导入</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c336347b64ad142c43d74591a80f9a38/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vivado2019&#43;Modelsim仿真环境搭建(保姆式说明)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>