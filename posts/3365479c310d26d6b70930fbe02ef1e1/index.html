<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>TEngine框架的事件系统 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="TEngine框架的事件系统" />
<meta property="og:description" content="事件系统对于游戏项目来说是必不可少的系统模块，它能够有效地降低代码的耦合度。
using System; using System.Collections.Generic; namespace TEngine.Runtime { /// &lt;summary&gt; /// 事件数据 /// &lt;/summary&gt; class DEventDelegateData { /// &lt;summary&gt; /// 事件ID /// &lt;/summary&gt; private int m_eventType = 0; /// &lt;summary&gt; /// 该事件所有的委托回调列表 /// &lt;/summary&gt; public List&lt;Delegate&gt; m_listExist = new List&lt;Delegate&gt;(); /// &lt;summary&gt; /// 待新增的回调列表 /// &lt;/summary&gt; private List&lt;Delegate&gt; m_addList = new List&lt;Delegate&gt;(); /// &lt;summary&gt; /// 待移除的回调列表 /// &lt;/summary&gt; private List&lt;Delegate&gt; m_deleteList = new List&lt;Delegate&gt;(); /// &lt;summary&gt; /// 是否在执行回调中 /// &lt;/summary&gt; private bool m_isExcute = false; /// &lt;summary&gt; /// 是否已经脏了 /// &lt;/summary&gt; private bool m_dirty = false; public DEventDelegateData(int evnetType) { m_eventType = evnetType; } /// &lt;summary&gt; /// 添加事件回调 /// &lt;/summary&gt; /// &lt;param name=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/3365479c310d26d6b70930fbe02ef1e1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-22T18:25:09+08:00" />
<meta property="article:modified_time" content="2023-04-22T18:25:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">TEngine框架的事件系统</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>事件系统对于游戏项目来说是必不可少的系统模块，它能够有效地降低代码的耦合度。</p> 
<pre><code class="language-cs">using System;
using System.Collections.Generic;

namespace TEngine.Runtime
{
    /// &lt;summary&gt;
    /// 事件数据
    /// &lt;/summary&gt;
    class DEventDelegateData
    {
        /// &lt;summary&gt;
        /// 事件ID
        /// &lt;/summary&gt;
        private int m_eventType = 0;
        /// &lt;summary&gt;
        /// 该事件所有的委托回调列表
        /// &lt;/summary&gt;
        public List&lt;Delegate&gt; m_listExist = new List&lt;Delegate&gt;();
        /// &lt;summary&gt;
        /// 待新增的回调列表
        /// &lt;/summary&gt;
        private List&lt;Delegate&gt; m_addList = new List&lt;Delegate&gt;();
        /// &lt;summary&gt;
        /// 待移除的回调列表
        /// &lt;/summary&gt;
        private List&lt;Delegate&gt; m_deleteList = new List&lt;Delegate&gt;();

        /// &lt;summary&gt;
        /// 是否在执行回调中
        /// &lt;/summary&gt;
        private bool m_isExcute = false;

        /// &lt;summary&gt;
        /// 是否已经脏了
        /// &lt;/summary&gt;
        private bool m_dirty = false;

        public DEventDelegateData(int evnetType)
        {
            m_eventType = evnetType;
        }


        /// &lt;summary&gt;
        /// 添加事件回调
        /// &lt;/summary&gt;
        /// &lt;param name="handler"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool AddHandler(Delegate handler)
        {
            if (m_listExist.Contains(handler))
            {
                Log.Fatal("Repeated Add Handler");
                return false;
            }

            if (m_isExcute)
            {
                m_dirty = true;
                m_addList.Add(handler);
            }
            else
            {
                m_listExist.Add(handler);
            }

            return true;
        }


        /// &lt;summary&gt;
        /// 移除事件回调
        /// &lt;/summary&gt;
        /// &lt;param name="hander"&gt;&lt;/param&gt;
        public void RmvHandler(Delegate hander)
        {
            if (m_isExcute)
            {
                m_dirty = true;
                m_deleteList.Add(hander);
            }
            else
            {
                if (!m_listExist.Remove(hander))
                {
                    Log.Fatal("Delete handle failed, not exist, EventId: {0}", StringId.HashToString(m_eventType));
                }
            }
        }


        /// &lt;summary&gt;
        /// 检查事件的委托回调是否发生了修改，如果有，则把新增的加入、待移除的除掉
        /// &lt;/summary&gt;
        private void CheckModify()
        {
            m_isExcute = false;
            if (m_dirty)
            {
                for (int i = 0; i &lt; m_addList.Count; i++)
                {
                    m_listExist.Add(m_addList[i]);
                }

                m_addList.Clear();

                for (int i = 0; i &lt; m_deleteList.Count; i++)
                {
                    m_listExist.Remove(m_deleteList[i]);
                }

                m_deleteList.Clear();
            }
        }


        /// &lt;summary&gt;
        /// 执行回调【无参数】
        /// &lt;/summary&gt;
        public void Callback()
        {
            m_isExcute = true;
            for (var i = 0; i &lt; m_listExist.Count; i++)
            {
                var d = m_listExist[i];
                Action action = d as Action;
                if (action != null)
                {
                    action();
                }
            }

            CheckModify();
        }

        /// &lt;summary&gt;
        /// 执行回调【一个参数】
        /// &lt;/summary&gt;
        /// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;
        /// &lt;param name="arg1"&gt;参数&lt;/param&gt;
        public void Callback&lt;T&gt;(T arg1)
        {
            m_isExcute = true;
            for (var i = 0; i &lt; m_listExist.Count; i++)
            {
                var d = m_listExist[i];
                var action = d as Action&lt;T&gt;;
                if (action != null)
                {
                    action(arg1);
                }
            }

            CheckModify();
        }

        /// &lt;summary&gt;
        /// 执行回调【2个参数】
        /// &lt;/summary&gt;
        /// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="U"&gt;&lt;/typeparam&gt;
        /// &lt;param name="arg1"&gt;参数1&lt;/param&gt;
        /// &lt;param name="arg2"&gt;参数2&lt;/param&gt;
        public void Callback&lt;T, U&gt;(T arg1, U arg2)
        {
            m_isExcute = true;
            for (var i = 0; i &lt; m_listExist.Count; i++)
            {
                var d = m_listExist[i];
                var action = d as Action&lt;T, U&gt;;
                if (action != null)
                {
                    action(arg1, arg2);
                }
            }

            CheckModify();
        }


        /// &lt;summary&gt;
        /// 执行回调【3个参数】
        /// &lt;/summary&gt;
        /// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="U"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="V"&gt;&lt;/typeparam&gt;
        /// &lt;param name="arg1"&gt;参数1&lt;/param&gt;
        /// &lt;param name="arg2"&gt;参数2&lt;/param&gt;
        /// &lt;param name="arg3"&gt;参数3&lt;/param&gt;
        public void Callback&lt;T, U, V&gt;(T arg1, U arg2, V arg3)
        {
            m_isExcute = true;
            for (var i = 0; i &lt; m_listExist.Count; i++)
            {
                var d = m_listExist[i];
                var action = d as Action&lt;T, U, V&gt;;
                if (action != null)
                {
                    action(arg1, arg2, arg3);
                }
            }

            CheckModify();
        }


        /// &lt;summary&gt;
        /// 执行回调【4个参数】
        /// &lt;/summary&gt;
        /// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="U"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="V"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="W"&gt;&lt;/typeparam&gt;
        /// &lt;param name="arg1"&gt;参数1&lt;/param&gt;
        /// &lt;param name="arg2"&gt;参数2&lt;/param&gt;
        /// &lt;param name="arg3"&gt;参数3&lt;/param&gt;
        /// &lt;param name="arg4"&gt;参数4&lt;/param&gt;
        public void Callback&lt;T, U, V, W&gt;(T arg1, U arg2, V arg3, W arg4)
        {
            m_isExcute = true;
            for (var i = 0; i &lt; m_listExist.Count; i++)
            {
                var d = m_listExist[i];
                var action = d as Action&lt;T, U, V, W&gt;;
                if (action != null)
                {
                    action(arg1, arg2, arg3, arg4);
                }
            }

            CheckModify();
        }


        /// &lt;summary&gt;
        /// 执行回调【5个参数】
        /// &lt;/summary&gt;
        /// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="U"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="V"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="W"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="X"&gt;&lt;/typeparam&gt;
        /// &lt;param name="arg1"&gt;参数1&lt;/param&gt;
        /// &lt;param name="arg2"&gt;参数2&lt;/param&gt;
        /// &lt;param name="arg3"&gt;参数3&lt;/param&gt;
        /// &lt;param name="arg4"&gt;参数4&lt;/param&gt;
        /// &lt;param name="arg5"&gt;参数5&lt;/param&gt;
        public void Callback&lt;T, U, V, W, X&gt;(T arg1, U arg2, V arg3, W arg4, X arg5)
        {
            m_isExcute = true;
            for (var i = 0; i &lt; m_listExist.Count; i++)
            {
                var d = m_listExist[i];
                var action = d as Action&lt;T, U, V, W, X&gt;;
                if (action != null)
                {
                    action(arg1, arg2, arg3, arg4, arg5);
                }
            }

            CheckModify();
        }
    }

    /// &lt;summary&gt;
    /// 事件注册分发器
    /// &lt;/summary&gt;
    class DEventDispatcher
    {

        /// &lt;summary&gt;
        /// 事件字典列表
        /// &lt;/summary&gt;
        static Dictionary&lt;int, DEventDelegateData&gt; m_eventTable = new Dictionary&lt;int, DEventDelegateData&gt;();

        #region 事件管理接口

        /// &lt;summary&gt;
        /// 添加事件监听
        /// &lt;/summary&gt;
        /// &lt;param name="eventType"&gt;事件ID&lt;/param&gt;
        /// &lt;param name="handler"&gt;回调&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool AddEventListener(int eventType, Delegate handler)
        {
            DEventDelegateData data;
            if (!m_eventTable.TryGetValue(eventType, out data))
            {
                data = new DEventDelegateData(eventType);
                m_eventTable.Add(eventType, data);
            }

            return data.AddHandler(handler);
        }


        /// &lt;summary&gt;
        /// 注销事件回调
        /// &lt;/summary&gt;
        /// &lt;param name="eventType"&gt;&lt;/param&gt;
        /// &lt;param name="handler"&gt;&lt;/param&gt;
        public void RemoveEventListener(int eventType, Delegate handler)
        {
            DEventDelegateData data;
            if (m_eventTable.TryGetValue(eventType, out data))
            {
                data.RmvHandler(handler);
            }
        }

        #endregion

        #region 事件分发接口

        /// &lt;summary&gt;
        /// 事件发送【无参数】
        /// &lt;/summary&gt;
        /// &lt;param name="eventType"&gt;事件ID&lt;/param&gt;
        public void Send(int eventType)
        {
            DEventDelegateData d;
            if (m_eventTable.TryGetValue(eventType, out d))
            {
                d.Callback();
            }
        }

        /// &lt;summary&gt;
        /// 事件发送【1个参数】
        /// &lt;/summary&gt;
        /// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;
        /// &lt;param name="eventType"&gt;事件ID&lt;/param&gt;
        /// &lt;param name="arg1"&gt;参数1&lt;/param&gt;
        public void Send&lt;T&gt;(int eventType, T arg1)
        {
            DEventDelegateData d;
            if (m_eventTable.TryGetValue(eventType, out d))
            {
                d.Callback(arg1);
            }
        }

        /// &lt;summary&gt;
        /// 事件发送【2个参数】
        /// &lt;/summary&gt;
        /// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="U"&gt;&lt;/typeparam&gt;
        /// &lt;param name="eventType"&gt;事件ID&lt;/param&gt;
        /// &lt;param name="arg1"&gt;参数1&lt;/param&gt;
        /// &lt;param name="arg2"&gt;参数2&lt;/param&gt;
        public void Send&lt;T, U&gt;(int eventType, T arg1, U arg2)
        {
            DEventDelegateData d;
            if (m_eventTable.TryGetValue(eventType, out d))
            {
                d.Callback(arg1, arg2);
            }
        }

        /// &lt;summary&gt;
        /// 事件发送【3个参数】
        /// &lt;/summary&gt;
        /// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="U"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="V"&gt;&lt;/typeparam&gt;
        /// &lt;param name="eventType"&gt;事件ID&lt;/param&gt;
        /// &lt;param name="arg1"&gt;参数1&lt;/param&gt;
        /// &lt;param name="arg2"&gt;参数2&lt;/param&gt;
        /// &lt;param name="arg3"&gt;参数3&lt;/param&gt;
        public void Send&lt;T, U, V&gt;(int eventType, T arg1, U arg2, V arg3)
        {
            DEventDelegateData d;
            if (m_eventTable.TryGetValue(eventType, out d))
            {
                d.Callback(arg1, arg2, arg3);
            }
        }

        /// &lt;summary&gt;
        /// 事件发送【4个参数】
        /// &lt;/summary&gt;
        /// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="U"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="V"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="W"&gt;&lt;/typeparam&gt;
        /// &lt;param name="eventType"&gt;事件ID&lt;/param&gt;
        /// &lt;param name="arg1"&gt;参数1&lt;/param&gt;
        /// &lt;param name="arg2"&gt;参数2&lt;/param&gt;
        /// &lt;param name="arg3"&gt;参数3&lt;/param&gt;
        /// &lt;param name="arg4"&gt;参数4&lt;/param&gt;
        public void Send&lt;T, U, V, W&gt;(int eventType, T arg1, U arg2, V arg3, W arg4)
        {
            DEventDelegateData d;
            if (m_eventTable.TryGetValue(eventType, out d))
            {
                d.Callback(arg1, arg2, arg3, arg4);
            }
        }

        /// &lt;summary&gt;
        /// 事件发送【5个参数】
        /// &lt;/summary&gt;
        /// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="U"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="V"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="W"&gt;&lt;/typeparam&gt;
        /// &lt;typeparam name="X"&gt;&lt;/typeparam&gt;
        /// &lt;param name="eventType"&gt;事件ID&lt;/param&gt;
        /// &lt;param name="arg1"&gt;参数1&lt;/param&gt;
        /// &lt;param name="arg2"&gt;参数2&lt;/param&gt;
        /// &lt;param name="arg3"&gt;参数3&lt;/param&gt;
        /// &lt;param name="arg4"&gt;参数4&lt;/param&gt;
        /// &lt;param name="arg5"&gt;参数5&lt;/param&gt;
        public void Send&lt;T, U, V, W, X&gt;(int eventType, T arg1, U arg2, V arg3, W arg4, X arg5)
        {
            DEventDelegateData d;
            if (m_eventTable.TryGetValue(eventType, out d))
            {
                d.Callback(arg1, arg2, arg3, arg4, arg5);
            }
        }

        #endregion
    }
}</code></pre> 
<p>上面是包含事件的注册、注销以及事件的分发等接口的封装。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/81bd4ebe90481dbcfdab2c72e9c5a663/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PHP 连接 clickhouse 数据库</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e81f4ec46f7eaaf3680c4264c3a8f3b3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">error: Failed dependencies: libcrypto.so.10()(64bit) is needed by mysql-community-client-plugins-8.</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>