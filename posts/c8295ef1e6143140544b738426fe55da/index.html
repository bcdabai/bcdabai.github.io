<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>4.æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´ - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="4.æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´" />
<meta property="og:description" content="æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´ ä¸»è¦å†…å®¹ â– Podå®‰å…¨ä¸Šä¸‹æ–‡
â– Podå®‰å…¨ç­–ç•¥
â– Secretå­˜å‚¨æ•æ„Ÿæ•°æ®
â– å®‰å…¨æ²™ç®±è¿è¡Œå®¹å™¨
Podå®‰å…¨ä¸Šä¸‹æ–‡ å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆSecurity Contextï¼‰ï¼šK8så¯¹Podå’Œå®¹å™¨æä¾›çš„å®‰å…¨æœºåˆ¶ï¼Œå¯ä»¥è®¾ç½®Podç‰¹æƒå’Œè®¿é—®æ§åˆ¶ã€‚
å®‰å…¨ä¸Šä¸‹æ–‡é™åˆ¶ç»´åº¦ï¼š
è‡ªä¸»è®¿é—®æ§åˆ¶ï¼ˆDiscretionary Access Controlï¼‰ï¼šåŸºäºç”¨æˆ·IDï¼ˆUIDï¼‰å’Œç»„IDï¼ˆGIDï¼‰ï¼Œæ¥åˆ¤å®šå¯¹å¯¹è±¡ï¼ˆä¾‹å¦‚æ–‡ä»¶ï¼‰ çš„è®¿é—®æƒé™ã€‚å®‰å…¨æ€§å¢å¼ºçš„ Linuxï¼ˆSELinuxï¼‰ï¼š ä¸ºå¯¹è±¡èµ‹äºˆå®‰å…¨æ€§æ ‡ç­¾ã€‚ä»¥ç‰¹æƒæ¨¡å¼æˆ–è€…éç‰¹æƒæ¨¡å¼è¿è¡Œã€‚Linux Capabilities: ä¸ºè¿›ç¨‹èµ‹äºˆ root ç”¨æˆ·çš„éƒ¨åˆ†ç‰¹æƒè€Œéå…¨éƒ¨ç‰¹æƒã€‚AppArmorï¼šå®šä¹‰Podä½¿ç”¨AppArmoré™åˆ¶å®¹å™¨å¯¹èµ„æºè®¿é—®é™åˆ¶Seccompï¼šå®šä¹‰Podä½¿ç”¨Seccompé™åˆ¶å®¹å™¨è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨AllowPrivilegeEscalationï¼š ç¦æ­¢å®¹å™¨ä¸­è¿›ç¨‹ï¼ˆé€šè¿‡ SetUID æˆ– SetGID æ–‡ä»¶æ¨¡å¼ï¼‰è·å¾—ç‰¹æƒæå‡ã€‚å½“å®¹å™¨ä»¥ç‰¹æƒæ¨¡å¼ è¿è¡Œæˆ–è€…å…·æœ‰CAP_SYS_ADMINèƒ½åŠ›æ—¶ï¼ŒAllowPrivilegeEscalationæ€»ä¸ºTrueã€‚readOnlyRootFilesystemï¼šä»¥åªè¯»æ–¹å¼åŠ è½½å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚ æ¡ˆä¾‹å®æ–½ æ¡ˆä¾‹1ï¼šè®¾ç½®å®¹å™¨ä»¥æ™®é€šç”¨æˆ·è¿è¡Œ èƒŒæ™¯ï¼šå®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºé»˜è®¤ä»¥rootè´¦å·è¿è¡Œçš„ï¼Œè¿™ä¸ªrootä¸å®¿ä¸»æœºrootè´¦å·æ˜¯ç›¸åŒçš„ï¼Œ æ‹¥æœ‰å¤§éƒ¨åˆ†å¯¹Linuxå†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨æƒé™ï¼Œè¿™æ ·æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°†å®¹å™¨ä»¥æ™® é€šç”¨æˆ·è¿è¡Œï¼Œå‡å°‘åº”ç”¨ç¨‹åºå¯¹æƒé™çš„ä½¿ç”¨ã€‚
å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹æ³•è®¾ç½®æ™®é€šç”¨æˆ·ï¼š
Dockerfileé‡Œä½¿ç”¨USERæŒ‡å®šè¿è¡Œç”¨æˆ·K8sé‡ŒæŒ‡å®šspec.securityContext.runAsUserï¼ŒæŒ‡å®šå®¹å™¨é»˜è®¤ç”¨æˆ·UID spec: securityContext: runAsUser: 1000 # é•œåƒé‡Œå¿…é¡»æœ‰è¿™ä¸ªç”¨æˆ·UID fsGroup: 1000 # æ•°æ®å·æŒ‚è½½åçš„ç›®å½•å±ç»„è®¾ç½®ä¸ºè¯¥ç»„ containers: - image: lizhenliang/flask-demo:root name: web securityContext: allowPrivilegeEscalation: false # ä¸å…è®¸ææƒ åˆ›å»ºPodä½¿ç”¨å®‰å…¨ä¸Šä¸‹æ–‡æµ‹è¯•æ˜¯å¦æ”¹ä¸ºuuidè¿è¡Œå®¹å™¨:
[root@master01:~] # cat pod-test.yaml apiVersion: v1 kind: Pod metadata: name: test spec: securityContext: runAsUser: 1000 fsGroup: 1000 containers: - image: lizhenliang/flask-demo:root name: test securityContext: allowPrivilegeEscalation: false æ‰§è¡Œyamlä¹‹åè¿›å…¥å®¹å™¨æŸ¥çœ‹å½“å‰çš„uuidï¼š" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c8295ef1e6143140544b738426fe55da/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-04T15:43:38+08:00" />
<meta property="article:modified_time" content="2023-04-04T15:43:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">4.æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´</h2> 
<h4><a id="_2"></a>ä¸»è¦å†…å®¹</h4> 
<p>â– Podå®‰å…¨ä¸Šä¸‹æ–‡</p> 
<p>â– Podå®‰å…¨ç­–ç•¥</p> 
<p>â– Secretå­˜å‚¨æ•æ„Ÿæ•°æ®</p> 
<p>â– å®‰å…¨æ²™ç®±è¿è¡Œå®¹å™¨</p> 
<h4><a id="Pod_13"></a>Podå®‰å…¨ä¸Šä¸‹æ–‡</h4> 
<p><code>å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆSecurity Contextï¼‰</code>ï¼šK8så¯¹Podå’Œå®¹å™¨æä¾›çš„å®‰å…¨æœºåˆ¶ï¼Œå¯ä»¥è®¾ç½®Podç‰¹æƒå’Œè®¿é—®æ§åˆ¶ã€‚</p> 
<p><strong>å®‰å…¨ä¸Šä¸‹æ–‡é™åˆ¶ç»´åº¦ï¼š</strong></p> 
<ul><li><code>è‡ªä¸»è®¿é—®æ§åˆ¶ï¼ˆDiscretionary Access Controlï¼‰</code>ï¼šåŸºäºç”¨æˆ·IDï¼ˆUIDï¼‰å’Œç»„IDï¼ˆGIDï¼‰ï¼Œæ¥åˆ¤å®šå¯¹å¯¹è±¡ï¼ˆä¾‹å¦‚æ–‡ä»¶ï¼‰ çš„è®¿é—®æƒé™ã€‚</li><li><code>å®‰å…¨æ€§å¢å¼ºçš„ Linuxï¼ˆSELinuxï¼‰</code>ï¼š ä¸ºå¯¹è±¡èµ‹äºˆå®‰å…¨æ€§æ ‡ç­¾ã€‚</li><li>ä»¥<code>ç‰¹æƒæ¨¡å¼</code>æˆ–è€…éç‰¹æƒæ¨¡å¼è¿è¡Œã€‚</li><li><code>Linux Capabilities</code>: ä¸ºè¿›ç¨‹èµ‹äºˆ root ç”¨æˆ·çš„éƒ¨åˆ†ç‰¹æƒè€Œéå…¨éƒ¨ç‰¹æƒã€‚</li><li><code>AppArmor</code>ï¼šå®šä¹‰Podä½¿ç”¨AppArmoré™åˆ¶å®¹å™¨å¯¹èµ„æºè®¿é—®é™åˆ¶</li><li><code>Seccomp</code>ï¼šå®šä¹‰Podä½¿ç”¨Seccompé™åˆ¶å®¹å™¨è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨</li><li><code>AllowPrivilegeEscalation</code>ï¼š ç¦æ­¢å®¹å™¨ä¸­è¿›ç¨‹ï¼ˆé€šè¿‡ SetUID æˆ– SetGID æ–‡ä»¶æ¨¡å¼ï¼‰è·å¾—ç‰¹æƒæå‡ã€‚å½“å®¹å™¨ä»¥ç‰¹æƒæ¨¡å¼ è¿è¡Œæˆ–è€…å…·æœ‰CAP_SYS_ADMINèƒ½åŠ›æ—¶ï¼ŒAllowPrivilegeEscalationæ€»ä¸ºTrueã€‚</li><li><code>readOnlyRootFilesystem</code>ï¼šä»¥åªè¯»æ–¹å¼åŠ è½½å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</li></ul> 
<h4><a id="_32"></a>æ¡ˆä¾‹å®æ–½</h4> 
<h6><a id="1_34"></a>æ¡ˆä¾‹1ï¼šè®¾ç½®å®¹å™¨ä»¥æ™®é€šç”¨æˆ·è¿è¡Œ</h6> 
<p>èƒŒæ™¯ï¼šå®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºé»˜è®¤ä»¥rootè´¦å·è¿è¡Œçš„ï¼Œè¿™ä¸ªrootä¸å®¿ä¸»æœºrootè´¦å·æ˜¯ç›¸åŒçš„ï¼Œ æ‹¥æœ‰å¤§éƒ¨åˆ†å¯¹Linuxå†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨æƒé™ï¼Œè¿™æ ·æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°†å®¹å™¨ä»¥æ™® é€šç”¨æˆ·è¿è¡Œï¼Œå‡å°‘åº”ç”¨ç¨‹åºå¯¹æƒé™çš„ä½¿ç”¨ã€‚</p> 
<p>å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹æ³•è®¾ç½®æ™®é€šç”¨æˆ·ï¼š</p> 
<ol><li>Dockerfileé‡Œä½¿ç”¨USERæŒ‡å®šè¿è¡Œç”¨æˆ·</li><li>K8sé‡ŒæŒ‡å®šspec.securityContext.runAsUserï¼ŒæŒ‡å®šå®¹å™¨é»˜è®¤ç”¨æˆ·UID</li></ol> 
<pre><code class="prism language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span> 	<span class="token comment"># é•œåƒé‡Œå¿…é¡»æœ‰è¿™ä¸ªç”¨æˆ·UID</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">1000</span> 		<span class="token comment"># æ•°æ®å·æŒ‚è½½åçš„ç›®å½•å±ç»„è®¾ç½®ä¸ºè¯¥ç»„</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> lizhenliang/flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>root
    <span class="token key atrule">name</span><span class="token punctuation">:</span> web
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># ä¸å…è®¸ææƒ</span>
</code></pre> 
<p>åˆ›å»ºPodä½¿ç”¨å®‰å…¨ä¸Šä¸‹æ–‡æµ‹è¯•æ˜¯å¦æ”¹ä¸ºuuidè¿è¡Œå®¹å™¨:</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span> <span class="token comment"># cat pod-test.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> lizhenliang/flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>root
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre> 
<p>æ‰§è¡Œyamlä¹‹åè¿›å…¥å®¹å™¨æŸ¥çœ‹å½“å‰çš„uuidï¼š</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it test -- bash</span>
python@test:/data/www$ <span class="token function">id</span>
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>python<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>python<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>python<span class="token punctuation">)</span>
</code></pre> 
<h6><a id="2_90"></a>æ¡ˆä¾‹2ï¼šé¿å…ä½¿ç”¨ç‰¹æƒå®¹å™¨</h6> 
<p>èƒŒæ™¯ï¼šå®¹å™¨ä¸­æœ‰äº›åº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦è®¿é—®å®¿ä¸»æœºè®¾å¤‡ã€ä¿®æ”¹å†…æ ¸ç­‰éœ€æ±‚ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ å®¹å™¨æ²¡è¿™ä¸ªæœ‰è¿™ä¸ªèƒ½åŠ›ï¼Œå› æ­¤è¿™æ—¶ä¼šè€ƒè™‘ç»™å®¹å™¨è®¾ç½®ç‰¹æƒæ¨¡å¼ã€‚</p> 
<p>å¯ç”¨ç‰¹æƒæ¨¡å¼ï¼š</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">containers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> lizhenliang/flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>root
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> true / false 
</code></pre> 
<blockquote> 
 <p>å¯ç”¨ç‰¹æƒæ¨¡å¼å°±æ„å‘³ç€ï¼Œä½ è¦ä¸ºå®¹å™¨æä¾›äº†è®¿é—®Linuxå†…æ ¸çš„æ‰€æœ‰èƒ½åŠ›ï¼Œè¿™æ˜¯å¾ˆå±é™©çš„ï¼Œ ä¸ºäº†å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„ä¾›ç»™ï¼Œå¯ä»¥ä½¿ç”¨Capabilitiesä¸ºå®¹å™¨èµ‹äºˆä»…æ‰€éœ€çš„èƒ½åŠ›ã€‚</p> 
</blockquote> 
<p><code>Linux Capabilitiesï¼šCapabilities æ˜¯ä¸€ä¸ªå†…æ ¸çº§åˆ«çš„æƒé™</code>ï¼Œå®ƒå…è®¸å¯¹å†…æ ¸è°ƒç”¨æƒ é™è¿›è¡Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œè€Œä¸æ˜¯ç®€å•åœ°ä»¥ root èº«ä»½èƒ½åŠ›æˆæƒã€‚ Capabilities åŒ…æ‹¬æ›´æ”¹æ–‡ä»¶æƒé™ã€æ§åˆ¶ç½‘ç»œå­ç³»ç»Ÿå’Œæ‰§è¡Œç³»ç»Ÿç®¡ç†ç­‰åŠŸèƒ½ã€‚åœ¨ securityContext ä¸­ï¼Œå¯ä»¥æ·»åŠ æˆ–åˆ é™¤ Capabilitiesï¼Œåšåˆ°å®¹å™¨ç²¾ç»†åŒ–æƒé™æ§åˆ¶ã€‚</p> 
<p><img src="https://images2.imgbox.com/c6/95/PRaC8djE_o.png" alt="image-20220413084355164"></p> 
<h6><a id="3_118"></a>æ¡ˆä¾‹3ï¼šå–æ¶ˆæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ</h6> 
<p>å®¹å™¨é»˜è®¤æ²¡æœ‰æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿèƒ½åŠ›ï¼Œæ·»åŠ SYS_ADMINå¢åŠ è¿™ä¸ªèƒ½åŠ›</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox 
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">command</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> sleep
    <span class="token punctuation">-</span> 24h
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>
        <span class="token key atrule">add</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"SYS_ADMIN"</span><span class="token punctuation">]</span>
</code></pre> 
<p>åˆ›å»ºè¿›å…¥å®¹å™¨æµ‹è¯•æŒ‚è½½æƒé™ï¼š</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it  busybox -- sh</span>
/ <span class="token comment"># mount /data/ /tmp/</span>
mount: mounting /data/ on /tmp/ failed: Permission denied
</code></pre> 
<h6><a id="4_151"></a>æ¡ˆä¾‹4ï¼šåªè¯»æŒ‚è½½æƒé™</h6> 
<p>åªè¯»æŒ‚è½½å®¹å™¨æ–‡ä»¶ç³»ç»Ÿï¼Œé˜²æ­¢æ¶æ„äºŒè¿›åˆ¶æ–‡ä»¶åˆ›å»º</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">command</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> sleep
    <span class="token punctuation">-</span> 24h
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<p>åˆ›å»ºè¿›å…¥å®¹å™¨æµ‹è¯•æ–‡ä»¶æƒé™ï¼š</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it  busybox  -- sh</span>
/ <span class="token comment"># mkdir a</span>
mkdir: can<span class="token string">'t create directory '</span>a': Read-only <span class="token function">file</span> system
</code></pre> 
<h4><a id="PodPSP_185"></a>Podå®‰å…¨ç­–ç•¥ï¼ˆPSPï¼‰</h4> 
<p><code>PodSecurityPolicyï¼ˆç®€ç§°PSPï¼‰</code>ï¼šKubernetesä¸­Podéƒ¨ç½²æ—¶é‡è¦çš„å®‰å…¨æ ¡éªŒæ‰‹æ®µï¼Œèƒ½å¤Ÿ æœ‰æ•ˆåœ°çº¦æŸåº”ç”¨è¿è¡Œæ—¶è¡Œä¸ºå®‰å…¨ã€‚ ä½¿ç”¨PSPå¯¹è±¡å®šä¹‰ä¸€ç»„Podåœ¨è¿è¡Œæ—¶å¿…é¡»éµå¾ªçš„æ¡ä»¶åŠç›¸å…³å­—æ®µçš„é»˜è®¤å€¼ï¼Œåªæœ‰Podæ»¡è¶³è¿™ äº›æ¡ä»¶æ‰ä¼šè¢«K8sæ¥å—ã€‚</p> 
<h5><a id="Pod_191"></a>Podå®‰å…¨ç­–ç•¥é™åˆ¶ç»´åº¦</h5> 
<p><img src="https://images2.imgbox.com/24/cf/u1prZxkZ_o.png" alt="image-20220413100840633"></p> 
<h5><a id="_197"></a>å¯ç”¨å‡†å…¥æ§åˆ¶å™¨</h5> 
<p>Podå®‰å…¨ç­–ç•¥å®ç°ä¸ºä¸€ä¸ªå‡†å…¥æ§åˆ¶å™¨ï¼Œé»˜è®¤æ²¡æœ‰å¯ç”¨ï¼Œå½“å¯ç”¨åä¼šå¼ºåˆ¶å®æ–½ Podå®‰å…¨ç­–ç•¥ï¼Œæ²¡æœ‰æ»¡è¶³çš„Podå°†æ— æ³•åˆ›å»ºã€‚å› æ­¤ï¼Œå»ºè®®åœ¨å¯ç”¨PSPä¹‹å‰å…ˆæ·»åŠ  ç­–ç•¥å¹¶å¯¹å…¶æˆæƒã€‚</p> 
<p>å¯ç”¨Podå®‰å…¨ç­–ç•¥ï¼š</p> 
<blockquote> 
 <p>vi /etc/kubernetes/manifests/kube-apiserver.yaml<br> â€¦<br> â€“enable-admission-plugins=NodeRestriction,PodSecurityPolicy<br> â€¦<br> systemctl restart kubelet</p> 
</blockquote> 
<h5><a id="PSP_213"></a>å¦‚ä½•ä½¿ç”¨PSPèµ„æº</h5> 
<p>ç”¨æˆ·ä½¿ç”¨SA ï¼ˆServiceAccountï¼‰åˆ›å»ºäº†ä¸€ä¸ªPodï¼Œ<code>K8sä¼šå…ˆéªŒè¯è¿™ä¸ªSAæ˜¯å¦ å¯ä»¥è®¿é—®PSPèµ„æºæƒé™</code>ï¼Œå¦‚æœå¯ä»¥è¿›ä¸€æ­¥éªŒè¯Podé…ç½®æ˜¯å¦æ»¡è¶³PSPè§„åˆ™ï¼Œä»» æ„ä¸€æ­¥ä¸æ»¡è¶³éƒ½ä¼šæ‹’ç»éƒ¨ç½²ã€‚</p> 
<p>å› æ­¤ï¼Œéœ€è¦å®æ–½éœ€è¦æœ‰è¿™å‡ ç‚¹ï¼š</p> 
<ol><li>åˆ›å»ºSAæœåŠ¡è´¦å·</li><li>è¯¥SAéœ€è¦å…·å¤‡åˆ›å»ºå¯¹åº”èµ„æºæƒé™ï¼Œä¾‹å¦‚åˆ›å»ºPodã€Deployment</li><li>SAä½¿ç”¨PSPèµ„æºæƒé™ï¼šåˆ›å»ºRoleï¼Œä½¿ç”¨PSPèµ„æºæƒé™ï¼Œå†å°†SAç»‘å®šRole</li></ol> 
<img src="https://images2.imgbox.com/a4/ef/ajBGFTMt_o.png" alt="image-20220413102111236"> 
<h4><a id="_226"></a>æ¡ˆä¾‹å®æ–½</h4> 
<h6><a id="1Pod_228"></a>ç¤ºä¾‹1ï¼šç¦æ­¢åˆ›å»ºç‰¹æƒæ¨¡å¼çš„Pod</h6> 
<p>åˆ›å»ºPodå®‰å…¨ç­–ç•¥èµ„æºå¦‚ä¸‹ï¼š</p> 
<ul><li>ä¸å…è®¸ç‰¹æƒPod</li><li>è¿è¡ŒseLinuxçš„è§„åˆ™</li><li>æŒ‡å®šå®¹å™¨å¯åŠ¨çš„ç”¨æˆ·IDå’Œä¸»ç»„IDä½ä»»ä½•äººæˆ–è€…ç¦æ­¢æ²¡æŒ‡å®šæ™®é€šç”¨æˆ·è¿è¡Œçš„å®¹å™¨ï¼ˆrunAsUserï¼‰</li><li>å…è®¸ä½¿ç”¨æŒ‚è½½ç±»å‹æ•°æ®å·</li></ul> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># cat psp.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> policy/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PodSecurityPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> psp<span class="token punctuation">-</span>example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># ä¸å…è®¸ç‰¹æƒPod</span>
  <span class="token comment"># ä¸‹é¢æ˜¯ä¸€äº›å¿…è¦çš„å­—æ®µ</span>
  <span class="token key atrule">seLinux</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">supplementalGroups</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny   /  MustRunAsNonRoot
  <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">'*'</span>
</code></pre> 
<p>æ‰§è¡Œä¹‹åæŸ¥çœ‹å½“å‰çš„PSPèµ„æºæƒ…å†µï¼š</p> 
<p>åœ¨åç»­çš„1.25ä¹‹åçš„ç‰ˆæœ¬é‡Œé¢ï¼Œå°†ä¼šå®Œå…¨åºŸå¼ƒPodå®‰å…¨ç­–ç•¥ï¼Œé‡‡ç”¨å®‰å…¨ä¸Šä¸‹æ–‡ çš„æ–¹å¼ã€‚</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f psp.yaml</span>
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="token keyword">in</span> v1.21+, unavailable <span class="token keyword">in</span> v1.25+
podsecuritypolicy.policy/psp-example created

<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get psp</span>
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="token keyword">in</span> v1.21+, unavailable <span class="token keyword">in</span> v1.25+
NAME          PRIV    CAPS   SELINUX    RUNASUSER   FSGROUP    SUPGROUP   READONLYROOTFS   VOLUMES
psp-example   <span class="token boolean">false</span>          RunAsAny   RunAsAny    RunAsAny   RunAsAny   <span class="token boolean">false</span>            *
</code></pre> 
<h6><a id="2_277"></a>ç¤ºä¾‹2ï¼šç¦æ­¢åˆ›å»ºç‰¹æƒæ¨¡å¼æµç¨‹</h6> 
<pre><code class="prism language-shell"><span class="token comment"># åˆ›å»ºSA</span>
$ kubectl create serviceaccount aliang

<span class="token comment"># å°†SAç»‘å®šåˆ°ç³»ç»Ÿå†…ç½®Role</span>
$ kubectl create rolebinding aliang --clusterrole<span class="token operator">=</span>edit --serviceaccount<span class="token operator">=</span>default:aliang

<span class="token comment"># åˆ›å»ºä½¿ç”¨PSPæƒé™çš„Role</span>
$ kubectl create role psp:unprivileged --verb<span class="token operator">=</span>use --resource<span class="token operator">=</span>podsecuritypolicy --resource-name<span class="token operator">=</span>psp-example

<span class="token comment"># å°†SAç»‘å®šåˆ°Role</span>
$ kubectl create rolebinding aliang:psp:unprivileged --role<span class="token operator">=</span>psp:unprivileged --serviceaccount<span class="token operator">=</span>default:aliang

<span class="token comment"># åˆ›å»ºpodæµ‹è¯•</span>
$ kubectl --as<span class="token operator">=</span>system:serviceaccount:default:psp-sa run nginx --image<span class="token operator">=</span>nginx
</code></pre> 
<h4><a id="OPA_Gatekeeper_297"></a>OPA Gatekeeper</h4> 
<h5><a id="OPA_299"></a>OPAä»‹ç»</h5> 
<p>PSPä¸è¶³ä¸çŠ¶å†µï¼š</p> 
<ul><li>å°†å†1.21ç‰ˆæœ¬å¼ƒç”¨PSPï¼Œåœ¨1.25ç‰ˆæœ¬åˆ é™¤PSP</li><li>ä»…æ”¯æŒPodç­–ç•¥</li><li>ä½¿ç”¨å¤æ‚ï¼Œæƒé™æ¨¡å‹å­˜åœ¨ç¼ºé™·ï¼Œæ§åˆ¶ä¸æ˜ç¡®</li></ul> 
<p>ğŸ·ï¸<a href="https://kubernetes.io/blog/2021/04/06/podsecuritypolicy-deprecation-past-present-and-future/" rel="nofollow">å¼ƒç”¨æ–‡ç« </a></p> 
<p>ğŸ·ï¸<a href="https://github.com/kubernetes/enhancements/issues/2579">æ›¿ä»£ææ¡ˆ</a></p> 
<p><code>OPAï¼ˆOpen Policy Agentï¼‰</code>ï¼šæ˜¯ä¸€ä¸ªå¼€æºçš„ã€é€šç”¨ç­–ç•¥å¼•æ“ï¼Œå¯ä»¥å°†ç­–ç•¥ç¼–å†™ä¸ºä»£ç ã€‚æä¾› ä¸€ä¸ªç§é«˜çº§å£°æ˜æ€§è¯­è¨€-Regoæ¥ç¼–å†™ç­–ç•¥ï¼Œå¹¶æŠŠå†³ç­–è¿™ä¸€æ­¥éª¤ä»å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ä¸­è§£è€¦å‡ºæ¥ã€‚</p> 
<p>OPAå¯ä»¥ç”¨æ¥åšä»€ä¹ˆï¼Ÿ</p> 
<ol><li>æ‹’ç»ä¸ç¬¦åˆæ¡ä»¶çš„YAMLéƒ¨ç½²</li><li>å…è®¸ä½¿ç”¨å“ªäº›ä»“åº“ä¸­çš„é•œåƒ</li><li>å…è®¸åœ¨å“ªä¸ªæ—¶é—´æ®µè®¿é—®ç³»ç»Ÿ</li><li>ç­‰â€¦</li></ol> 
<h5><a id="OPA_328"></a>OPAå·¥ä½œæµç¨‹</h5> 
<p>Gatekeeper æ˜¯åŸºäº OPAçš„ä¸€ä¸ª Kubernetes ç­–ç•¥è§£å†³æ–¹æ¡ˆï¼Œå¯æ›¿ä»£PSPæˆ–è€…éƒ¨åˆ†RBACåŠŸèƒ½ã€‚</p> 
<p>å½“åœ¨é›†ç¾¤ä¸­éƒ¨ç½²äº†Gatekeeperç»„ä»¶ï¼ŒAPIServeræ‰€æœ‰çš„åˆ›å»ºã€æ›´æ–°æˆ–è€…åˆ é™¤æ“ä½œéƒ½ä¼šè§¦å‘ Gatekeeperæ¥å¤„ç†ï¼Œå¦‚æœä¸æ»¡è¶³ç­–ç•¥åˆ™æ‹’ç»ã€‚</p> 
<p><img src="https://images2.imgbox.com/2e/bc/5zqMu7eB_o.png" alt="image-20220413133253793"></p> 
<h5><a id="OPA_Gatekeeper_338"></a>éƒ¨ç½²OPA Gatekeeper</h5> 
<p>Gatekeeperçš„ç­–ç•¥ç”±ä¸¤ä¸ªèµ„æºå¯¹è±¡ç»„æˆï¼š</p> 
<ul><li><code>Template</code>ï¼šç­–ç•¥é€»è¾‘å®ç°çš„åœ°æ–¹ï¼Œä½¿ç”¨regoè¯­è¨€</li><li><code>Contsraint</code>ï¼šè´Ÿè´£Kubernetesèµ„æºå¯¹è±¡çš„è¿‡æ»¤æˆ–è€…ä¸ºTemplateæä¾›è¾“å…¥å‚æ•°</li></ul> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.7/deploy/gatekeeper.yaml</span>

<span class="token punctuation">[</span>root@master01:~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n gatekeeper-system</span>
NAME                                             READY   STATUS    RESTARTS   AGE
gatekeeper-controller-manager-66f474f785-kn5fl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32s
gatekeeper-controller-manager-66f474f785-xgz7s   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32s
gatekeeper-controller-manager-66f474f785-xxwdm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32s
</code></pre> 
<h4><a id="_357"></a>æ¡ˆä¾‹å®æ–½</h4> 
<h6><a id="1_359"></a>æ¡ˆä¾‹1ï¼šç¦æ­¢å®¹å™¨å¯ç”¨ç‰¹æƒ</h6> 
<ul><li>éœ€è¦åˆ›å»º<code>ConstraintTemplate</code>çš„èµ„æº</li><li>ä½¿ç”¨<code>rego</code>çš„è¯­è¨€ç¼–å†™å¯¹å¯ç”¨ç‰¹æƒçš„èµ„æºå‘å‡ºè­¦å‘Š</li><li>éœ€è¦æŒ‡å®šç±»å‹ä¸º<code>privileged</code>æ¨¡å¼</li></ul> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat privileged_tpl.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> templates.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConstraintTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> privileged
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">crd</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span>
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> privileged
  <span class="token key atrule">targets</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> admission.k8s.gatekeeper.sh
      <span class="token key atrule">rego</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        package admission
        violation[{"msg": msg}] {  # å¦‚æœviolationä¸ºtrueè¯´æ˜è¿åçº¦æŸ
          containers = input.review.object.spec.template.spec.containers
          c_name := containers[0].name
          containers[0].securityContext.privileged # å¦‚æœè¿”å›falseæˆ–è€…æ²¡è·å–åˆ°å€¼è¯´æ˜é€šè¿‡
          msg := sprintf("æç¤ºï¼š'%v'å®¹å™¨ç¦æ­¢å¯ç”¨ç‰¹æƒï¼",[c_name])
        }</span>
        
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get ConstraintTemplate</span>
NAME         AGE
privileged   32m
</code></pre> 
<p>åˆ›å»ºçº¦æŸã€å¦‚ä¸‹æ˜¯çº¦æŸèµ„æºç±»å‹ï¼š</p> 
<ul><li>Deployment</li><li>DaemonSet</li><li>StatefulSet</li></ul> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat privileged_constraints.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> constraints.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> privileged
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> privileged
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">match</span><span class="token punctuation">:</span>  <span class="token comment"># åŒ¹é…çš„èµ„æº</span>
    <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"apps"</span><span class="token punctuation">]</span>
        <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">"Deployment"</span>
        <span class="token punctuation">-</span> <span class="token string">"DaemonSet"</span>
        <span class="token punctuation">-</span> <span class="token string">"StatefulSet"</span>
        
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get constraints</span>
NAME         AGE
privileged   31m
</code></pre> 
<p>åˆ›å»ºDeploymentå¼€å¯ç‰¹æƒæ¨¡å¼å†æ‰§è¡Œåˆ›å»ºä¼šå‘å‡ºè­¦å‘Šã€‚</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f deployment.yaml</span>
Error from server (<span class="token punctuation">[</span>privileged<span class="token punctuation">]</span> æç¤ºï¼š'nginx'å®¹å™¨ç¦æ­¢å¯ç”¨ç‰¹æƒï¼)<span class="token punctuation">:</span> <span class="token key atrule">error when creating "dp.yaml"</span><span class="token punctuation">:</span> <span class="token key atrule">admission webhook "validation.gatekeeper.sh" denied the request</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>privileged<span class="token punctuation">]</span> æç¤ºï¼š'nginx'å®¹å™¨ç¦æ­¢å¯ç”¨ç‰¹æƒï¼
</code></pre> 
<h6><a id="2_453"></a>æ¡ˆä¾‹2ï¼šåªå…è®¸ä½¿ç”¨ç‰¹å®šçš„é•œåƒä»“åº“</h6> 
<ul><li>éœ€è¦åˆ›å»º<code>ConstraintTemplate</code>çš„èµ„æº</li><li>ä½¿ç”¨<code>rego</code>çš„è¯­è¨€ç¼–å†™å¯¹é•œåƒä»“åº“çš„ä¿¡ä»»</li><li>éœ€è¦æŒ‡å®šç±»å‹ä¸º<code>image-check</code>æ¨¡å¼</li></ul> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat   image-check_tpl.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> templates.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConstraintTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">crd</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span>
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
      <span class="token key atrule">validation</span><span class="token punctuation">:</span>
        <span class="token key atrule">openAPIV3Schema</span><span class="token punctuation">:</span>
          <span class="token key atrule">properties</span><span class="token punctuation">:</span>  <span class="token comment"># éœ€è¦æ»¡è¶³æ¡ä»¶çš„å‚æ•°</span>
            <span class="token key atrule">prefix</span><span class="token punctuation">:</span>
              <span class="token key atrule">type</span><span class="token punctuation">:</span> string
  <span class="token key atrule">targets</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> admission.k8s.gatekeeper.sh
      <span class="token key atrule">rego</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        package image
        violation[{"msg": msg}] {
          containers = input.review.object.spec.template.spec.containers
          image := containers[0].image
          not startswith(image, input.parameters.prefix)
          msg := sprintf("æç¤ºï¼š'%v'é•œåƒåœ°å€ä¸åœ¨å¯ä¿¡ä»»ä»“åº“ï¼", [image])
        }</span>
        
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get constrainttemplate</span>
NAME          AGE
image<span class="token punctuation">-</span>check   77s
privileged    35m
</code></pre> 
<p>è¿™é‡Œéœ€è¦é…ç½®ä¼ é€’OPAçš„å‚æ•°ä¸ºï¼š â€œlizhenliang/â€</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat image-check_constraints.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> constraints.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"apps"</span><span class="token punctuation">]</span>
        <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">"Deployment"</span>
        <span class="token punctuation">-</span> <span class="token string">"DaemonSet"</span>
        <span class="token punctuation">-</span> <span class="token string">"StatefulSet"</span>
  <span class="token key atrule">parameters</span><span class="token punctuation">:</span>  <span class="token comment"># ä¼ é€’ç»™opaçš„å‚æ•°</span>
    <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">"lizhenliang/"</span>
    
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get constraints</span>
NAME                                                AGE
image<span class="token punctuation">-</span>check.constraints.gatekeeper.sh/image<span class="token punctuation">-</span>check   77s
</code></pre> 
<p>æ‰§è¡Œæµ‹è¯•æ—¶ä½¿ç”¨dockerå®˜æ–¹çš„é•œåƒä»“åº“ï¼š</p> 
<ol><li><code>ç”±äºæˆ‘ä»¬å¼€å¯äº†é•œåƒä»“åº“çš„ä¿¡ä»» æ‰€ä»¥å¯¹dockerä»“åº“ä¸æ”¯æŒ</code></li><li><code>åªèƒ½ä»lizhenliangè¯¥ä»“åº“è¿›è¡Œæ‹‰å–é•œåƒ</code></li></ol> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment test --image=nginx</span>
error: failed to create deployment: admission webhook <span class="token string">"validation.gatekeeper.sh"</span> denied the request: <span class="token punctuation">[</span>image-check<span class="token punctuation">]</span> æç¤ºï¼š<span class="token string">'nginx'</span>é•œåƒåœ°å€ä¸åœ¨å¯ä¿¡ä»»ä»“åº“ï¼
</code></pre> 
<h4><a id="Secret_534"></a>Secretå­˜å‚¨æ•æ„Ÿæ•°æ®</h4> 
<p>Secretæ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨æ•æ„Ÿæ•°æ®çš„èµ„æºï¼Œæ‰€æœ‰çš„æ•°æ®è¦ç»è¿‡base64ç¼–ç ï¼Œæ•°æ®å®é™…ä¼šå­˜å‚¨åœ¨K8sä¸­Etcdï¼Œ ç„¶åé€šè¿‡åˆ›å»ºPodæ—¶å¼•ç”¨è¯¥æ•°æ®ã€‚</p> 
<p>åº”ç”¨åœºæ™¯ï¼šå‡­æ®</p> 
<p>Podä½¿ç”¨secretæ•°æ®æœ‰ä¸¤ç§æ–¹å¼ï¼š</p> 
<ul><li><code>å˜é‡æ³¨å…¥</code></li><li><code>æ•°æ®å·æŒ‚è½½</code></li></ul> 
<h5><a id="secret_549"></a>secretçš„ç±»å‹</h5> 
<p>kubectl create secret æ”¯æŒä¸‰ç§æ•°æ®ç±»å‹ï¼š</p> 
<ul><li>docker-registryï¼šå­˜å‚¨é•œåƒä»“åº“è®¤è¯ä¿¡æ¯</li><li>genericï¼šä»æ–‡ä»¶ã€ç›®å½•æˆ–è€…å­—ç¬¦ä¸²åˆ›å»ºï¼Œä¾‹å¦‚å­˜å‚¨ç”¨æˆ·åå¯†ç </li><li>tlsï¼šå­˜å‚¨è¯ä¹¦ï¼Œä¾‹å¦‚HTTPSè¯ä¹¦</li></ul> 
<h5><a id="secret_559"></a>secretçš„ä½¿ç”¨</h5> 
<p>ä¸€ä¸ª Secret å¯ä»¥åŒ…å« Pod è®¿é—®æ•°æ®åº“æ‰€éœ€çš„ç”¨æˆ·å‡­è¯ã€‚ ä¾‹å¦‚ï¼Œç”±ç”¨æˆ·åå’Œå¯†ç ç»„æˆçš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚ ä½  å¯ä»¥åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šï¼Œå°†ç”¨æˆ·åå­˜å‚¨åœ¨æ–‡ä»¶ <code>./username.txt</code> ä¸­ï¼Œå°†å¯†ç å­˜å‚¨åœ¨æ–‡ä»¶ <code>./password.txt</code> ä¸­ã€‚</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo -n 'admin' &gt; username.txt</span>
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo -n '1a2b3c4d' &gt; password.txt</span>
</code></pre> 
<p>åœ¨è¿™äº›å‘½ä»¤ä¸­ï¼Œ -n æ ‡å¿—ç¡®ä¿ç”Ÿæˆçš„æ–‡ä»¶åœ¨æ–‡æœ¬æœ«å°¾ä¸åŒ…å«é¢å¤–çš„æ¢è¡Œç¬¦ã€‚ è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºå½“ kubectl è¯» å–æ–‡ä»¶å¹¶å°†å†…å®¹ç¼–ç ä¸º base64 å­—ç¬¦ä¸²æ—¶ï¼Œå¤šä½™çš„æ¢è¡Œç¬¦ä¹Ÿä¼šè¢«ç¼–ç ã€‚</p> 
<p>kubectl create secret å‘½ä»¤å°†è¿™äº›æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª Secret å¹¶åœ¨ API æœåŠ¡å™¨ä¸Šåˆ›å»ºå¯¹è±¡ã€‚</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl create secret generic db-user-pass --from-file=username.txt --from-file=password.txt</span>
secret/db<span class="token punctuation">-</span>user<span class="token punctuation">-</span>pass created

<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl get secrets db-user-pass -o yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">password.txt</span><span class="token punctuation">:</span> MWEyYjNjNGQ=
  <span class="token key atrule">username.txt</span><span class="token punctuation">:</span> YWRtaW4=
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2022-04-13T06:43:03Z"</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> db<span class="token punctuation">-</span>user<span class="token punctuation">-</span>pass
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"100098"</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 440fa829<span class="token punctuation">-</span>0135<span class="token punctuation">-</span>4ef2<span class="token punctuation">-</span>b8dc<span class="token punctuation">-</span>9f06f5a2f2a3
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
</code></pre> 
<h5><a id="_Secret_595"></a>è§£ç  Secret</h5> 
<p>è¦æŸ¥çœ‹åˆ›å»ºçš„ Secret çš„å†…å®¹ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get secrets db-user-pass -o jsonpath='{.data}'</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"password.txt"</span><span class="token builtin class-name">:</span><span class="token string">"MWEyYjNjNGQ="</span>,<span class="token string">"username.txt"</span><span class="token builtin class-name">:</span><span class="token string">"YWRtaW4="</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo 'MWEyYjNjNGQ=' | base64 -d</span>
1a2b3c4d
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo 'YWRtaW4=' | base64 -d</span>
admin
</code></pre> 
<h4><a id="_612"></a>æ¡ˆä¾‹å®æ–½</h4> 
<h6><a id="MysqlSecret_614"></a>ç¤ºä¾‹ï¼šå°†Mysqlç”¨æˆ·å¯†ç ä¿å­˜åˆ°Secretä¸­å­˜å‚¨</h6> 
<p>åˆ›å»ºsecretï¼Œmysql-root-passwordçš„é”®å€¼æ˜¯1a2a3a4a</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl create secret generic mysql --from-literal=mysql-root-password=1a2a3a4a</span>
secret/mysql created

<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl get secrets mysql -o yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">mysql-root-password</span><span class="token punctuation">:</span> MWEyYTNhNGE=
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2022-04-13T07:06:21Z"</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"102066"</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 3104256b<span class="token punctuation">-</span>5b46<span class="token punctuation">-</span>43a4<span class="token punctuation">-</span>85ed<span class="token punctuation">-</span>acc66be7ccba
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
</code></pre> 
<p>åˆ›å»ºPodæµ‹è¯•ï¼Œä½¿ç”¨envä»secretä¸­å¼•ç”¨å˜é‡</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># cat pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> master01
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span>  mysql<span class="token punctuation">:</span><span class="token number">5.6</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
        <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>root<span class="token punctuation">-</span>password
          
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME    READY   STATUS    RESTARTS   AGE
mysql   1/1     Running   0          21s
</code></pre> 
<h4><a id="_667"></a>å®‰å…¨æ²™ç®±è¿è¡Œå®¹å™¨</h4> 
<h5><a id="gVisor_669"></a>gVisorä»‹ç»</h5> 
<img src="https://images2.imgbox.com/cb/ef/F8eXWB1E_o.png" alt="image-20220413152858652"> 
<p>æ‰€çŸ¥ï¼Œå®¹å™¨çš„åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥è®¿é—®Linuxå†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®¹å™¨åœ¨å®‰å…¨éš”ç¦»ä¸Šè¿˜æ˜¯æ¯”è¾ƒå¼±ï¼Œè™½ç„¶ å†…æ ¸åœ¨ä¸æ–­åœ°å¢å¼ºè‡ªèº«çš„å®‰å…¨ç‰¹æ€§ï¼Œä½†ç”±äºå†…æ ¸è‡ªèº«ä»£ç æç«¯å¤æ‚ï¼ŒCVE æ¼æ´å±‚å‡ºä¸ç©·ã€‚ æ‰€ä»¥è¦æƒ³å‡å°‘è¿™æ–¹é¢å®‰å…¨é£é™©ï¼Œå°±æ˜¯åšå¥½å®‰å…¨éš”ç¦»ï¼Œé˜»æ–­å®¹å™¨å†…ç¨‹åºå¯¹ç‰©ç†æœºå†…æ ¸çš„ä¾èµ–ã€‚ Googleå¼€æºçš„ä¸€ç§gVisorå®¹å™¨æ²™ç®±æŠ€æœ¯å°±æ˜¯é‡‡ç”¨è¿™ç§æ€è·¯ï¼ŒgVisoréš”ç¦»å®¹å™¨å†…åº”ç”¨å’Œå†…æ ¸ä¹‹é—´è®¿ é—®ï¼Œæä¾›äº†å¤§éƒ¨åˆ†Linuxå†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå·§å¦™çš„å°†å®¹å™¨å†…è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨è½¬åŒ–ä¸ºå¯¹gVisorçš„è®¿é—®ã€‚</p> 
<p>gVisorå…¼å®¹OCIï¼Œä¸Dockerå’ŒK8sæ— ç¼é›†æˆï¼Œå¾ˆæ–¹é¢ä½¿ç”¨ã€‚</p> 
<p>é¡¹ç›®åœ°å€ï¼šhttps://github.com/google/gvisor</p> 
<h5><a id="gVisor_683"></a>gVisorå†…æ ¸äº¤äº’</h5> 
<p><img src="https://images2.imgbox.com/63/dd/s6Jx6N3E_o.png" alt="image-20220413152923179"></p> 
<h5><a id="gVisor_689"></a>gVisoræ¶æ„</h5> 
<p><img src="https://images2.imgbox.com/d1/ee/NmdGQRJx_o.png" alt="image-20220413153011389"></p> 
<h5><a id="gVisorDocker_695"></a>gVisorä¸Dockeré›†æˆ</h5> 
<p>gVisorå†…æ ¸è¦æ±‚ï¼š</p> 
<p>Linux 3.17+ å¦‚æœç”¨çš„æ˜¯CentOS7åˆ™éœ€è¦å‡çº§å†…æ ¸ï¼ŒUbuntuä¸éœ€è¦ã€‚</p> 
<p>CentOS7å†…æ ¸å‡çº§æ­¥éª¤ï¼š</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml â€“y</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># grub2-set-default 0</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># reboot</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># uname -r</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># 5.17.2-1.el7.elrepo.x86_64</span>
</code></pre> 
<p>gVisoré›†æˆDockeré…ç½®</p> 
<p>å‚è€ƒæ–‡æ¡£ï¼šhttps://gvisor.dev/docs/user_guide/install/</p> 
<p>å·²ç»æµ‹è¯•è¿‡çš„åº”ç”¨å’Œå·¥å…·ï¼šhttps://gvisor.dev/docs/user_guide/compatibility/</p> 
<pre><code class="prism language-shell"><span class="token number">1</span>ã€å‡†å¤‡gVisoräºŒè¿›åˆ¶æ–‡ä»¶
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># sha512sum -c runsc.sha512</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rm -f *.sha512</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># chmod a+x runsc </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># chmod a+x containerd-shim-runsc-v1</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># mv runsc containerd-shim-runsc-v1 /usr/local/bin</span>

<span class="token number">2</span>ã€Dockeré…ç½®ä½¿ç”¨gVisor
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># runsc install # æŸ¥çœ‹åŠ çš„é…ç½®/etc/docker/daemon.json</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart docker</span>


ä½¿ç”¨runscè¿è¡Œå®¹å™¨ï¼š
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># docker run -d --runtime=runsc nginx</span>
ä½¿ç”¨dmesgéªŒè¯ï¼š
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># docker run --runtime=runsc -it nginx dmesg</span>
</code></pre> 
<h5><a id="gVisorContainerd_746"></a>gVisorä¸Containerdé›†æˆ</h5> 
<p>å¦‚æœè¿™é‡Œæ˜¯Dockerçš„ç¯å¢ƒï¼Œéœ€è¦åˆ‡æ¢åˆ°Containerdå®¹å™¨å¼•æ“ã€‚</p> 
<p>ä»ç„¶éœ€è¦å°†runsc ã€containerd-shim-runsc-v1å·¥å…·ç§»åˆ°/usr/local/binä¸‹é¢</p> 
<p><strong>1.å‡†å¤‡é…ç½®</strong></p> 
<p>å¼€å¯ipv4è·¯ç”±è½¬å‘é…ç½®ï¼Œé‡æ–°ç”Ÿæ•ˆç³»ç»Ÿé…ç½®</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat &gt; /etc/sysctl.d/99-kubernetes-cri.conf &lt;&lt; EOF</span>
net.bridge.bridge-nf-call-iptables <span class="token operator">=</span> <span class="token number">1</span>
net.ipv4.ip_forward <span class="token operator">=</span> <span class="token number">1</span>
net.bridge.bridge-nf-call-ip6tables <span class="token operator">=</span> <span class="token number">1</span>
EOF

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># sysctl -system</span>
</code></pre> 
<p><strong>2ã€å®‰è£…Containerd</strong></p> 
<p>å¦‚æœé»˜è®¤å®‰è£…äº†docker-ceä¼šè‡ªåŠ¨å®‰è£…containerdçš„ä¾èµ–ï¼Œæ²¡æœ‰åˆ™éœ€è¦å®‰è£…containerdã€‚</p> 
<p>ubuntuæ·»åŠ docker-ceçš„repoæºä¹‹åapt-get installçš„æ–¹å¼å®‰è£…</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/yum.repos.d</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># wget http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y containerd.io</span>
</code></pre> 
<p><strong>3ã€ä¿®æ”¹é…ç½®æ–‡ä»¶</strong></p> 
<ol><li>pauseé•œåƒåœ°å€</li><li>Cgroupé©±åŠ¨æ”¹ä¸ºsystemd</li><li>å¢åŠ runscå®¹å™¨è¿è¡Œæ—¶</li><li>é…ç½®dockeré•œåƒåŠ é€Ÿå™¨</li></ol> 
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶é»˜è®¤çš„containerdçš„é…ç½®æ–‡ä»¶æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„é…ç½®æ–‡ä»¶ã€‚</p> 
<p>containerdçš„ç›®å½•æ˜¯åœ¨ <code>/etc/containerd</code></p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/containerd/</span>
<span class="token punctuation">[</span>root@master01 containerd<span class="token punctuation">]</span><span class="token comment"># containerd config  default &gt; config.toml</span>
<span class="token punctuation">[</span>root@master01 containerd<span class="token punctuation">]</span><span class="token comment"># vim config.toml</span>
 <span class="token number">43</span>   <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">]</span>
 		Â·Â·Â·Â·
 		<span class="token comment"># ä¿®æ”¹é•œåƒä¸ºå›½å†…çš„é•œåƒ</span>
 <span class="token number">56</span>     sandbox_image <span class="token operator">=</span> <span class="token string">"registry.aliyuncs.com/google_containers/pause:3.2"</span>   
 		Â·Â·Â·Â· 
 			<span class="token comment"># æ·»åŠ ä¸€ä¸ªrunsc,æŒ‡å®šç±»å‹ä¸ºrunscï¼Œè¿™é‡Œæ˜¯è·ŸruncåŒçº§</span>
 <span class="token number">90</span>        <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runsc<span class="token punctuation">]</span>  
 <span class="token number">91</span>           runtime_type <span class="token operator">=</span> <span class="token string">"io.containerd.runsc.v1"</span>   				  

			<span class="token comment"># ä¿®æ”¹systemdé©±åŠ¨ä¸ºtrue</span>
 <span class="token number">94</span>        <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runc<span class="token punctuation">]</span>
 <span class="token number">103</span>          <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runc.options<span class="token punctuation">]</span>
				Â·Â·Â·
 <span class="token number">114</span>            SystemdCgroup <span class="token operator">=</span> <span class="token boolean">true</span>	
 		
 			<span class="token comment"># æ·»åŠ dockerä»“åº“çš„é•œåƒæºï¼Œé…ç½®é˜¿é‡Œé•œåƒåŠ é€Ÿ</span>
 <span class="token number">139</span>       <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors<span class="token punctuation">]</span>
 <span class="token number">140</span>        <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span class="token string">"docker.io"</span><span class="token punctuation">]</span>  
 <span class="token number">141</span>          endpoint <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"https://b9pmyelo.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>
</code></pre> 
<p><strong>é…ç½®kubeletä½¿ç”¨containerd</strong></p> 
<p>é…ç½®å®Œä¹‹åå…ˆé‡å¯containerdï¼Œå†é‡å¯kubeletï¼Œæœ€åå¦‚æœpodå‡ºç°æŠ¥é”™ï¼Œé‡å¯dockerã€‚</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/sysconfig/kubelet </span>
<span class="token assign-left variable">KUBELET_EXTRA_ARGS</span><span class="token operator">=</span>--container-runtime<span class="token operator">=</span>remote --container-runtime-endpoint<span class="token operator">=</span>unix:///run/containerd/containerd.sock --cgroup-driver<span class="token operator">=</span>systemd

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart containerd</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart kubelet</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart docker</span>
</code></pre> 
<p><strong>éªŒè¯å½“å‰çš„Kuberneteså®¹å™¨åŸºå±‚</strong></p> 
<ol><li><code>ä»¥ä¸Šçš„æ­¥éª¤éœ€è¦åœ¨æ‰€æœ‰é›†ç¾¤é…ç½®</code></li><li><code>åŒ…æ‹¬crictlè¿æ¥containerdçš„é…ç½®ä¹Ÿè¦åœ¨æ‰€æœ‰é›†ç¾¤è¿è¡Œ</code></li></ol> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get  node -o wide | awk  '{print $1,$2,$5,$NF}' | column -t</span>
NAME      STATUS  VERSION  CONTAINER-RUNTIME
master01  Ready   v1.22.1  containerd://1.5.11
master02  Ready   v1.22.1  containerd://1.5.11
master03  Ready   v1.22.1  containerd://1.5.11
</code></pre> 
<p><strong>crictlè¿æ¥containerd</strong></p> 
<p>containerdä¹Ÿæœ‰ ctr ç®¡ç†å·¥å…·ï¼Œä½†åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œä¸€èˆ¬ä½¿ç”¨crictlå·¥å…·æ£€æŸ¥å’Œè°ƒè¯•å®¹å™¨ã€‚</p> 
<p>é¡¹ç›®åœ°å€ï¼šhttps://github.com/kubernetes-sigs/cri-tools/</p> 
<p>å‡†å¤‡crictlè¿æ¥containerdé…ç½®æ–‡ä»¶ï¼š</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat &gt; /etc/crictl.yaml &lt;&lt; EOF</span>
runtime-endpoint: unix:///run/containerd/containerd.sock
EOF
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart  containerd </span>
</code></pre> 
<p>ä¸‹é¢æ˜¯dockerä¸crictlå‘½ä»¤å¯¹ç…§è¡¨ï¼š</p> 
<p><img src="https://images2.imgbox.com/f8/49/a9xIpH7C_o.png" alt="image-20220414115021436"></p> 
<h4><a id="_875"></a>æ¡ˆä¾‹å®æ–½</h4> 
<h6><a id="_K8sgVisor_877"></a>ç¤ºä¾‹ï¼š K8sä½¿ç”¨gVisorè¿è¡Œå®¹å™¨</h6> 
<ul><li>åˆ›å»ºRuntimeClass</li><li>ç»‘å®šRuntimeClass</li></ul> 
<p>RuntimeClass æ˜¯ä¸€ä¸ªç”¨äºé€‰æ‹©å®¹å™¨è¿è¡Œæ—¶é…ç½®çš„ç‰¹æ€§ï¼Œå®¹å™¨è¿è¡Œæ—¶é…ç½®ç”¨ äºè¿è¡Œ Pod ä¸­çš„å®¹å™¨ã€‚</p> 
<p>åˆ›å»ºRuntimeClassï¼š</p> 
<ul><li>è¿™é‡Œåˆ›å»ºä¸€ä¸ªåç§°ä¸º<code>gvisor</code>çš„runtimeclassèµ„æº</li><li>å¯ä»¥åˆ›å»ºå¤šä¸ª<code>runtimeclass</code>èµ„æºï¼Œèµ·åˆ°éš”ç¦»çš„æ•ˆæœ</li><li>handlerä¸€å®šæ˜¯<code>runsc</code>ï¼Œå¯¹åº”CSIçš„é…ç½®åç§°</li></ul> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat runtime.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> node.k8s.io/v1 <span class="token comment"># RuntimeClass å®šä¹‰äº node.k8s.io API ç»„</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RuntimeClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gvisor <span class="token comment"># ç”¨æ¥å¼•ç”¨ RuntimeClass çš„åå­—</span>
<span class="token key atrule">handler</span><span class="token punctuation">:</span> runsc <span class="token comment"># å¯¹åº”çš„ CRI é…ç½®çš„åç§°</span>

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get runtimeclasses</span>
NAME     HANDLER   AGE
gvisor   runsc     72m
</code></pre> 
<p>åˆ›å»ºPodæµ‹è¯•gVisorï¼š</p> 
<p>è¿™é‡Œä½¿ç”¨<code>runtimeClassName</code>ç»‘å®š</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> pod
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> <span class="token string">"master01"</span>
  <span class="token key atrule">runtimeClassName</span><span class="token punctuation">:</span> gvisor
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
    
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME   READY   STATUS    RESTARTS   AGE
pod    1/1     Running   0          72m
</code></pre> 
<ul><li>åˆ›å»ºRuntimeClass</li><li>ç»‘å®šRuntimeClass</li></ul> 
<p>RuntimeClass æ˜¯ä¸€ä¸ªç”¨äºé€‰æ‹©å®¹å™¨è¿è¡Œæ—¶é…ç½®çš„ç‰¹æ€§ï¼Œå®¹å™¨è¿è¡Œæ—¶é…ç½®ç”¨ äºè¿è¡Œ Pod ä¸­çš„å®¹å™¨ã€‚</p> 
<p>åˆ›å»ºRuntimeClassï¼š</p> 
<ul><li>è¿™é‡Œåˆ›å»ºä¸€ä¸ªåç§°ä¸º<code>gvisor</code>çš„runtimeclassèµ„æº</li><li>å¯ä»¥åˆ›å»ºå¤šä¸ª<code>runtimeclass</code>èµ„æºï¼Œèµ·åˆ°éš”ç¦»çš„æ•ˆæœ</li><li>handlerä¸€å®šæ˜¯<code>runsc</code>ï¼Œå¯¹åº”CSIçš„é…ç½®åç§°</li></ul> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat runtime.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> node.k8s.io/v1 <span class="token comment"># RuntimeClass å®šä¹‰äº node.k8s.io API ç»„</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RuntimeClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gvisor <span class="token comment"># ç”¨æ¥å¼•ç”¨ RuntimeClass çš„åå­—</span>
<span class="token key atrule">handler</span><span class="token punctuation">:</span> runsc <span class="token comment"># å¯¹åº”çš„ CRI é…ç½®çš„åç§°</span>

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get runtimeclasses</span>
NAME     HANDLER   AGE
gvisor   runsc     72m
</code></pre> 
<p>åˆ›å»ºPodæµ‹è¯•gVisorï¼š</p> 
<p>è¿™é‡Œä½¿ç”¨<code>runtimeClassName</code>ç»‘å®š</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> pod
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> <span class="token string">"master01"</span>
  <span class="token key atrule">runtimeClassName</span><span class="token punctuation">:</span> gvisor
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
    
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME   READY   STATUS    RESTARTS   AGE
pod    1/1     Running   0          72m
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/319ccd67a718e0fd22a97268689a03c9/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">wordæ–‡æ¡£ä¸­å·¥å…·æ ä¸æ˜¾ç¤ºmathtypeå¤„ç†æ–¹æ³•</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/aec4c00e1abb4e03ac1b19ec936bcfba/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">6.ç›‘æ§ã€å®¡è®¡å’Œè¿è¡Œæ—¶å®‰å…¨</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>