<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>4.最小化微服务漏洞 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="4.最小化微服务漏洞" />
<meta property="og:description" content="最小化微服务漏洞 主要内容 ❖ Pod安全上下文
❖ Pod安全策略
❖ Secret存储敏感数据
❖ 安全沙箱运行容器
Pod安全上下文 安全上下文（Security Context）：K8s对Pod和容器提供的安全机制，可以设置Pod特权和访问控制。
安全上下文限制维度：
自主访问控制（Discretionary Access Control）：基于用户ID（UID）和组ID（GID），来判定对对象（例如文件） 的访问权限。安全性增强的 Linux（SELinux）： 为对象赋予安全性标签。以特权模式或者非特权模式运行。Linux Capabilities: 为进程赋予 root 用户的部分特权而非全部特权。AppArmor：定义Pod使用AppArmor限制容器对资源访问限制Seccomp：定义Pod使用Seccomp限制容器进程的系统调用AllowPrivilegeEscalation： 禁止容器中进程（通过 SetUID 或 SetGID 文件模式）获得特权提升。当容器以特权模式 运行或者具有CAP_SYS_ADMIN能力时，AllowPrivilegeEscalation总为True。readOnlyRootFilesystem：以只读方式加载容器的根文件系统。 案例实施 案例1：设置容器以普通用户运行 背景：容器中的应用程序默认以root账号运行的，这个root与宿主机root账号是相同的， 拥有大部分对Linux内核的系统调用权限，这样是不安全的，所以我们应该将容器以普 通用户运行，减少应用程序对权限的使用。
可以通过两种方法设置普通用户：
Dockerfile里使用USER指定运行用户K8s里指定spec.securityContext.runAsUser，指定容器默认用户UID spec: securityContext: runAsUser: 1000 # 镜像里必须有这个用户UID fsGroup: 1000 # 数据卷挂载后的目录属组设置为该组 containers: - image: lizhenliang/flask-demo:root name: web securityContext: allowPrivilegeEscalation: false # 不允许提权 创建Pod使用安全上下文测试是否改为uuid运行容器:
[root@master01:~] # cat pod-test.yaml apiVersion: v1 kind: Pod metadata: name: test spec: securityContext: runAsUser: 1000 fsGroup: 1000 containers: - image: lizhenliang/flask-demo:root name: test securityContext: allowPrivilegeEscalation: false 执行yaml之后进入容器查看当前的uuid：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c8295ef1e6143140544b738426fe55da/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-04T15:43:38+08:00" />
<meta property="article:modified_time" content="2023-04-04T15:43:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">4.最小化微服务漏洞</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>最小化微服务漏洞</h2> 
<h4><a id="_2"></a>主要内容</h4> 
<p>❖ Pod安全上下文</p> 
<p>❖ Pod安全策略</p> 
<p>❖ Secret存储敏感数据</p> 
<p>❖ 安全沙箱运行容器</p> 
<h4><a id="Pod_13"></a>Pod安全上下文</h4> 
<p><code>安全上下文（Security Context）</code>：K8s对Pod和容器提供的安全机制，可以设置Pod特权和访问控制。</p> 
<p><strong>安全上下文限制维度：</strong></p> 
<ul><li><code>自主访问控制（Discretionary Access Control）</code>：基于用户ID（UID）和组ID（GID），来判定对对象（例如文件） 的访问权限。</li><li><code>安全性增强的 Linux（SELinux）</code>： 为对象赋予安全性标签。</li><li>以<code>特权模式</code>或者非特权模式运行。</li><li><code>Linux Capabilities</code>: 为进程赋予 root 用户的部分特权而非全部特权。</li><li><code>AppArmor</code>：定义Pod使用AppArmor限制容器对资源访问限制</li><li><code>Seccomp</code>：定义Pod使用Seccomp限制容器进程的系统调用</li><li><code>AllowPrivilegeEscalation</code>： 禁止容器中进程（通过 SetUID 或 SetGID 文件模式）获得特权提升。当容器以特权模式 运行或者具有CAP_SYS_ADMIN能力时，AllowPrivilegeEscalation总为True。</li><li><code>readOnlyRootFilesystem</code>：以只读方式加载容器的根文件系统。</li></ul> 
<h4><a id="_32"></a>案例实施</h4> 
<h6><a id="1_34"></a>案例1：设置容器以普通用户运行</h6> 
<p>背景：容器中的应用程序默认以root账号运行的，这个root与宿主机root账号是相同的， 拥有大部分对Linux内核的系统调用权限，这样是不安全的，所以我们应该将容器以普 通用户运行，减少应用程序对权限的使用。</p> 
<p>可以通过两种方法设置普通用户：</p> 
<ol><li>Dockerfile里使用USER指定运行用户</li><li>K8s里指定spec.securityContext.runAsUser，指定容器默认用户UID</li></ol> 
<pre><code class="prism language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span> 	<span class="token comment"># 镜像里必须有这个用户UID</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">1000</span> 		<span class="token comment"># 数据卷挂载后的目录属组设置为该组</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> lizhenliang/flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>root
    <span class="token key atrule">name</span><span class="token punctuation">:</span> web
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 不允许提权</span>
</code></pre> 
<p>创建Pod使用安全上下文测试是否改为uuid运行容器:</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span> <span class="token comment"># cat pod-test.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> lizhenliang/flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>root
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre> 
<p>执行yaml之后进入容器查看当前的uuid：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it test -- bash</span>
python@test:/data/www$ <span class="token function">id</span>
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>python<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>python<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>python<span class="token punctuation">)</span>
</code></pre> 
<h6><a id="2_90"></a>案例2：避免使用特权容器</h6> 
<p>背景：容器中有些应用程序可能需要访问宿主机设备、修改内核等需求，在默认情况下， 容器没这个有这个能力，因此这时会考虑给容器设置特权模式。</p> 
<p>启用特权模式：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">containers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> lizhenliang/flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>root
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> true / false 
</code></pre> 
<blockquote> 
 <p>启用特权模式就意味着，你要为容器提供了访问Linux内核的所有能力，这是很危险的， 为了减少系统调用的供给，可以使用Capabilities为容器赋予仅所需的能力。</p> 
</blockquote> 
<p><code>Linux Capabilities：Capabilities 是一个内核级别的权限</code>，它允许对内核调用权 限进行更细粒度的控制，而不是简单地以 root 身份能力授权。 Capabilities 包括更改文件权限、控制网络子系统和执行系统管理等功能。在 securityContext 中，可以添加或删除 Capabilities，做到容器精细化权限控制。</p> 
<p><img src="https://images2.imgbox.com/c6/95/PRaC8djE_o.png" alt="image-20220413084355164"></p> 
<h6><a id="3_118"></a>案例3：取消挂载文件系统</h6> 
<p>容器默认没有挂载文件系统能力，添加SYS_ADMIN增加这个能力</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox 
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">command</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> sleep
    <span class="token punctuation">-</span> 24h
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>
        <span class="token key atrule">add</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"SYS_ADMIN"</span><span class="token punctuation">]</span>
</code></pre> 
<p>创建进入容器测试挂载权限：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it  busybox -- sh</span>
/ <span class="token comment"># mount /data/ /tmp/</span>
mount: mounting /data/ on /tmp/ failed: Permission denied
</code></pre> 
<h6><a id="4_151"></a>案例4：只读挂载权限</h6> 
<p>只读挂载容器文件系统，防止恶意二进制文件创建</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">command</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> sleep
    <span class="token punctuation">-</span> 24h
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<p>创建进入容器测试文件权限：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it  busybox  -- sh</span>
/ <span class="token comment"># mkdir a</span>
mkdir: can<span class="token string">'t create directory '</span>a': Read-only <span class="token function">file</span> system
</code></pre> 
<h4><a id="PodPSP_185"></a>Pod安全策略（PSP）</h4> 
<p><code>PodSecurityPolicy（简称PSP）</code>：Kubernetes中Pod部署时重要的安全校验手段，能够 有效地约束应用运行时行为安全。 使用PSP对象定义一组Pod在运行时必须遵循的条件及相关字段的默认值，只有Pod满足这 些条件才会被K8s接受。</p> 
<h5><a id="Pod_191"></a>Pod安全策略限制维度</h5> 
<p><img src="https://images2.imgbox.com/24/cf/u1prZxkZ_o.png" alt="image-20220413100840633"></p> 
<h5><a id="_197"></a>启用准入控制器</h5> 
<p>Pod安全策略实现为一个准入控制器，默认没有启用，当启用后会强制实施 Pod安全策略，没有满足的Pod将无法创建。因此，建议在启用PSP之前先添加 策略并对其授权。</p> 
<p>启用Pod安全策略：</p> 
<blockquote> 
 <p>vi /etc/kubernetes/manifests/kube-apiserver.yaml<br> …<br> –enable-admission-plugins=NodeRestriction,PodSecurityPolicy<br> …<br> systemctl restart kubelet</p> 
</blockquote> 
<h5><a id="PSP_213"></a>如何使用PSP资源</h5> 
<p>用户使用SA （ServiceAccount）创建了一个Pod，<code>K8s会先验证这个SA是否 可以访问PSP资源权限</code>，如果可以进一步验证Pod配置是否满足PSP规则，任 意一步不满足都会拒绝部署。</p> 
<p>因此，需要实施需要有这几点：</p> 
<ol><li>创建SA服务账号</li><li>该SA需要具备创建对应资源权限，例如创建Pod、Deployment</li><li>SA使用PSP资源权限：创建Role，使用PSP资源权限，再将SA绑定Role</li></ol> 
<img src="https://images2.imgbox.com/a4/ef/ajBGFTMt_o.png" alt="image-20220413102111236"> 
<h4><a id="_226"></a>案例实施</h4> 
<h6><a id="1Pod_228"></a>示例1：禁止创建特权模式的Pod</h6> 
<p>创建Pod安全策略资源如下：</p> 
<ul><li>不允许特权Pod</li><li>运行seLinux的规则</li><li>指定容器启动的用户ID和主组ID位任何人或者禁止没指定普通用户运行的容器（runAsUser）</li><li>允许使用挂载类型数据卷</li></ul> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># cat psp.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> policy/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PodSecurityPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> psp<span class="token punctuation">-</span>example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 不允许特权Pod</span>
  <span class="token comment"># 下面是一些必要的字段</span>
  <span class="token key atrule">seLinux</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">supplementalGroups</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny   /  MustRunAsNonRoot
  <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">'*'</span>
</code></pre> 
<p>执行之后查看当前的PSP资源情况：</p> 
<p>在后续的1.25之后的版本里面，将会完全废弃Pod安全策略，采用安全上下文 的方式。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f psp.yaml</span>
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="token keyword">in</span> v1.21+, unavailable <span class="token keyword">in</span> v1.25+
podsecuritypolicy.policy/psp-example created

<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get psp</span>
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="token keyword">in</span> v1.21+, unavailable <span class="token keyword">in</span> v1.25+
NAME          PRIV    CAPS   SELINUX    RUNASUSER   FSGROUP    SUPGROUP   READONLYROOTFS   VOLUMES
psp-example   <span class="token boolean">false</span>          RunAsAny   RunAsAny    RunAsAny   RunAsAny   <span class="token boolean">false</span>            *
</code></pre> 
<h6><a id="2_277"></a>示例2：禁止创建特权模式流程</h6> 
<pre><code class="prism language-shell"><span class="token comment"># 创建SA</span>
$ kubectl create serviceaccount aliang

<span class="token comment"># 将SA绑定到系统内置Role</span>
$ kubectl create rolebinding aliang --clusterrole<span class="token operator">=</span>edit --serviceaccount<span class="token operator">=</span>default:aliang

<span class="token comment"># 创建使用PSP权限的Role</span>
$ kubectl create role psp:unprivileged --verb<span class="token operator">=</span>use --resource<span class="token operator">=</span>podsecuritypolicy --resource-name<span class="token operator">=</span>psp-example

<span class="token comment"># 将SA绑定到Role</span>
$ kubectl create rolebinding aliang:psp:unprivileged --role<span class="token operator">=</span>psp:unprivileged --serviceaccount<span class="token operator">=</span>default:aliang

<span class="token comment"># 创建pod测试</span>
$ kubectl --as<span class="token operator">=</span>system:serviceaccount:default:psp-sa run nginx --image<span class="token operator">=</span>nginx
</code></pre> 
<h4><a id="OPA_Gatekeeper_297"></a>OPA Gatekeeper</h4> 
<h5><a id="OPA_299"></a>OPA介绍</h5> 
<p>PSP不足与状况：</p> 
<ul><li>将再1.21版本弃用PSP，在1.25版本删除PSP</li><li>仅支持Pod策略</li><li>使用复杂，权限模型存在缺陷，控制不明确</li></ul> 
<p>🏷️<a href="https://kubernetes.io/blog/2021/04/06/podsecuritypolicy-deprecation-past-present-and-future/" rel="nofollow">弃用文章</a></p> 
<p>🏷️<a href="https://github.com/kubernetes/enhancements/issues/2579">替代提案</a></p> 
<p><code>OPA（Open Policy Agent）</code>：是一个开源的、通用策略引擎，可以将策略编写为代码。提供 一个种高级声明性语言-Rego来编写策略，并把决策这一步骤从复杂的业务逻辑中解耦出来。</p> 
<p>OPA可以用来做什么？</p> 
<ol><li>拒绝不符合条件的YAML部署</li><li>允许使用哪些仓库中的镜像</li><li>允许在哪个时间段访问系统</li><li>等…</li></ol> 
<h5><a id="OPA_328"></a>OPA工作流程</h5> 
<p>Gatekeeper 是基于 OPA的一个 Kubernetes 策略解决方案，可替代PSP或者部分RBAC功能。</p> 
<p>当在集群中部署了Gatekeeper组件，APIServer所有的创建、更新或者删除操作都会触发 Gatekeeper来处理，如果不满足策略则拒绝。</p> 
<p><img src="https://images2.imgbox.com/2e/bc/5zqMu7eB_o.png" alt="image-20220413133253793"></p> 
<h5><a id="OPA_Gatekeeper_338"></a>部署OPA Gatekeeper</h5> 
<p>Gatekeeper的策略由两个资源对象组成：</p> 
<ul><li><code>Template</code>：策略逻辑实现的地方，使用rego语言</li><li><code>Contsraint</code>：负责Kubernetes资源对象的过滤或者为Template提供输入参数</li></ul> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.7/deploy/gatekeeper.yaml</span>

<span class="token punctuation">[</span>root@master01:~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n gatekeeper-system</span>
NAME                                             READY   STATUS    RESTARTS   AGE
gatekeeper-controller-manager-66f474f785-kn5fl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32s
gatekeeper-controller-manager-66f474f785-xgz7s   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32s
gatekeeper-controller-manager-66f474f785-xxwdm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32s
</code></pre> 
<h4><a id="_357"></a>案例实施</h4> 
<h6><a id="1_359"></a>案例1：禁止容器启用特权</h6> 
<ul><li>需要创建<code>ConstraintTemplate</code>的资源</li><li>使用<code>rego</code>的语言编写对启用特权的资源发出警告</li><li>需要指定类型为<code>privileged</code>模式</li></ul> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat privileged_tpl.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> templates.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConstraintTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> privileged
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">crd</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span>
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> privileged
  <span class="token key atrule">targets</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> admission.k8s.gatekeeper.sh
      <span class="token key atrule">rego</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        package admission
        violation[{"msg": msg}] {  # 如果violation为true说明违反约束
          containers = input.review.object.spec.template.spec.containers
          c_name := containers[0].name
          containers[0].securityContext.privileged # 如果返回false或者没获取到值说明通过
          msg := sprintf("提示：'%v'容器禁止启用特权！",[c_name])
        }</span>
        
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get ConstraintTemplate</span>
NAME         AGE
privileged   32m
</code></pre> 
<p>创建约束、如下是约束资源类型：</p> 
<ul><li>Deployment</li><li>DaemonSet</li><li>StatefulSet</li></ul> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat privileged_constraints.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> constraints.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> privileged
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> privileged
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">match</span><span class="token punctuation">:</span>  <span class="token comment"># 匹配的资源</span>
    <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"apps"</span><span class="token punctuation">]</span>
        <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">"Deployment"</span>
        <span class="token punctuation">-</span> <span class="token string">"DaemonSet"</span>
        <span class="token punctuation">-</span> <span class="token string">"StatefulSet"</span>
        
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get constraints</span>
NAME         AGE
privileged   31m
</code></pre> 
<p>创建Deployment开启特权模式再执行创建会发出警告。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f deployment.yaml</span>
Error from server (<span class="token punctuation">[</span>privileged<span class="token punctuation">]</span> 提示：'nginx'容器禁止启用特权！)<span class="token punctuation">:</span> <span class="token key atrule">error when creating "dp.yaml"</span><span class="token punctuation">:</span> <span class="token key atrule">admission webhook "validation.gatekeeper.sh" denied the request</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>privileged<span class="token punctuation">]</span> 提示：'nginx'容器禁止启用特权！
</code></pre> 
<h6><a id="2_453"></a>案例2：只允许使用特定的镜像仓库</h6> 
<ul><li>需要创建<code>ConstraintTemplate</code>的资源</li><li>使用<code>rego</code>的语言编写对镜像仓库的信任</li><li>需要指定类型为<code>image-check</code>模式</li></ul> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat   image-check_tpl.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> templates.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConstraintTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">crd</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span>
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
      <span class="token key atrule">validation</span><span class="token punctuation">:</span>
        <span class="token key atrule">openAPIV3Schema</span><span class="token punctuation">:</span>
          <span class="token key atrule">properties</span><span class="token punctuation">:</span>  <span class="token comment"># 需要满足条件的参数</span>
            <span class="token key atrule">prefix</span><span class="token punctuation">:</span>
              <span class="token key atrule">type</span><span class="token punctuation">:</span> string
  <span class="token key atrule">targets</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> admission.k8s.gatekeeper.sh
      <span class="token key atrule">rego</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        package image
        violation[{"msg": msg}] {
          containers = input.review.object.spec.template.spec.containers
          image := containers[0].image
          not startswith(image, input.parameters.prefix)
          msg := sprintf("提示：'%v'镜像地址不在可信任仓库！", [image])
        }</span>
        
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get constrainttemplate</span>
NAME          AGE
image<span class="token punctuation">-</span>check   77s
privileged    35m
</code></pre> 
<p>这里需要配置传递OPA的参数为： “lizhenliang/”</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat image-check_constraints.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> constraints.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"apps"</span><span class="token punctuation">]</span>
        <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">"Deployment"</span>
        <span class="token punctuation">-</span> <span class="token string">"DaemonSet"</span>
        <span class="token punctuation">-</span> <span class="token string">"StatefulSet"</span>
  <span class="token key atrule">parameters</span><span class="token punctuation">:</span>  <span class="token comment"># 传递给opa的参数</span>
    <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">"lizhenliang/"</span>
    
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get constraints</span>
NAME                                                AGE
image<span class="token punctuation">-</span>check.constraints.gatekeeper.sh/image<span class="token punctuation">-</span>check   77s
</code></pre> 
<p>执行测试时使用docker官方的镜像仓库：</p> 
<ol><li><code>由于我们开启了镜像仓库的信任 所以对docker仓库不支持</code></li><li><code>只能从lizhenliang该仓库进行拉取镜像</code></li></ol> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment test --image=nginx</span>
error: failed to create deployment: admission webhook <span class="token string">"validation.gatekeeper.sh"</span> denied the request: <span class="token punctuation">[</span>image-check<span class="token punctuation">]</span> 提示：<span class="token string">'nginx'</span>镜像地址不在可信任仓库！
</code></pre> 
<h4><a id="Secret_534"></a>Secret存储敏感数据</h4> 
<p>Secret是一个用于存储敏感数据的资源，所有的数据要经过base64编码，数据实际会存储在K8s中Etcd， 然后通过创建Pod时引用该数据。</p> 
<p>应用场景：凭据</p> 
<p>Pod使用secret数据有两种方式：</p> 
<ul><li><code>变量注入</code></li><li><code>数据卷挂载</code></li></ul> 
<h5><a id="secret_549"></a>secret的类型</h5> 
<p>kubectl create secret 支持三种数据类型：</p> 
<ul><li>docker-registry：存储镜像仓库认证信息</li><li>generic：从文件、目录或者字符串创建，例如存储用户名密码</li><li>tls：存储证书，例如HTTPS证书</li></ul> 
<h5><a id="secret_559"></a>secret的使用</h5> 
<p>一个 Secret 可以包含 Pod 访问数据库所需的用户凭证。 例如，由用户名和密码组成的数据库连接字符串。 你 可以在本地计算机上，将用户名存储在文件 <code>./username.txt</code> 中，将密码存储在文件 <code>./password.txt</code> 中。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo -n 'admin' &gt; username.txt</span>
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo -n '1a2b3c4d' &gt; password.txt</span>
</code></pre> 
<p>在这些命令中， -n 标志确保生成的文件在文本末尾不包含额外的换行符。 这一点很重要，因为当 kubectl 读 取文件并将内容编码为 base64 字符串时，多余的换行符也会被编码。</p> 
<p>kubectl create secret 命令将这些文件打包成一个 Secret 并在 API 服务器上创建对象。</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl create secret generic db-user-pass --from-file=username.txt --from-file=password.txt</span>
secret/db<span class="token punctuation">-</span>user<span class="token punctuation">-</span>pass created

<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl get secrets db-user-pass -o yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">password.txt</span><span class="token punctuation">:</span> MWEyYjNjNGQ=
  <span class="token key atrule">username.txt</span><span class="token punctuation">:</span> YWRtaW4=
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2022-04-13T06:43:03Z"</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> db<span class="token punctuation">-</span>user<span class="token punctuation">-</span>pass
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"100098"</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 440fa829<span class="token punctuation">-</span>0135<span class="token punctuation">-</span>4ef2<span class="token punctuation">-</span>b8dc<span class="token punctuation">-</span>9f06f5a2f2a3
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
</code></pre> 
<h5><a id="_Secret_595"></a>解码 Secret</h5> 
<p>要查看创建的 Secret 的内容，运行以下命令：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get secrets db-user-pass -o jsonpath='{.data}'</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"password.txt"</span><span class="token builtin class-name">:</span><span class="token string">"MWEyYjNjNGQ="</span>,<span class="token string">"username.txt"</span><span class="token builtin class-name">:</span><span class="token string">"YWRtaW4="</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo 'MWEyYjNjNGQ=' | base64 -d</span>
1a2b3c4d
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo 'YWRtaW4=' | base64 -d</span>
admin
</code></pre> 
<h4><a id="_612"></a>案例实施</h4> 
<h6><a id="MysqlSecret_614"></a>示例：将Mysql用户密码保存到Secret中存储</h6> 
<p>创建secret，mysql-root-password的键值是1a2a3a4a</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl create secret generic mysql --from-literal=mysql-root-password=1a2a3a4a</span>
secret/mysql created

<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl get secrets mysql -o yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">mysql-root-password</span><span class="token punctuation">:</span> MWEyYTNhNGE=
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2022-04-13T07:06:21Z"</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"102066"</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 3104256b<span class="token punctuation">-</span>5b46<span class="token punctuation">-</span>43a4<span class="token punctuation">-</span>85ed<span class="token punctuation">-</span>acc66be7ccba
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
</code></pre> 
<p>创建Pod测试，使用env从secret中引用变量</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># cat pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> master01
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span>  mysql<span class="token punctuation">:</span><span class="token number">5.6</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
        <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>root<span class="token punctuation">-</span>password
          
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME    READY   STATUS    RESTARTS   AGE
mysql   1/1     Running   0          21s
</code></pre> 
<h4><a id="_667"></a>安全沙箱运行容器</h4> 
<h5><a id="gVisor_669"></a>gVisor介绍</h5> 
<img src="https://images2.imgbox.com/cb/ef/F8eXWB1E_o.png" alt="image-20220413152858652"> 
<p>所知，容器的应用程序可以直接访问Linux内核的系统调用，容器在安全隔离上还是比较弱，虽然 内核在不断地增强自身的安全特性，但由于内核自身代码极端复杂，CVE 漏洞层出不穷。 所以要想减少这方面安全风险，就是做好安全隔离，阻断容器内程序对物理机内核的依赖。 Google开源的一种gVisor容器沙箱技术就是采用这种思路，gVisor隔离容器内应用和内核之间访 问，提供了大部分Linux内核的系统调用，巧妙的将容器内进程的系统调用转化为对gVisor的访问。</p> 
<p>gVisor兼容OCI，与Docker和K8s无缝集成，很方面使用。</p> 
<p>项目地址：https://github.com/google/gvisor</p> 
<h5><a id="gVisor_683"></a>gVisor内核交互</h5> 
<p><img src="https://images2.imgbox.com/63/dd/s6Jx6N3E_o.png" alt="image-20220413152923179"></p> 
<h5><a id="gVisor_689"></a>gVisor架构</h5> 
<p><img src="https://images2.imgbox.com/d1/ee/NmdGQRJx_o.png" alt="image-20220413153011389"></p> 
<h5><a id="gVisorDocker_695"></a>gVisor与Docker集成</h5> 
<p>gVisor内核要求：</p> 
<p>Linux 3.17+ 如果用的是CentOS7则需要升级内核，Ubuntu不需要。</p> 
<p>CentOS7内核升级步骤：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml –y</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># grub2-set-default 0</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># reboot</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># uname -r</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># 5.17.2-1.el7.elrepo.x86_64</span>
</code></pre> 
<p>gVisor集成Docker配置</p> 
<p>参考文档：https://gvisor.dev/docs/user_guide/install/</p> 
<p>已经测试过的应用和工具：https://gvisor.dev/docs/user_guide/compatibility/</p> 
<pre><code class="prism language-shell"><span class="token number">1</span>、准备gVisor二进制文件
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># sha512sum -c runsc.sha512</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rm -f *.sha512</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># chmod a+x runsc </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># chmod a+x containerd-shim-runsc-v1</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># mv runsc containerd-shim-runsc-v1 /usr/local/bin</span>

<span class="token number">2</span>、Docker配置使用gVisor
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># runsc install # 查看加的配置/etc/docker/daemon.json</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart docker</span>


使用runsc运行容器：
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># docker run -d --runtime=runsc nginx</span>
使用dmesg验证：
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># docker run --runtime=runsc -it nginx dmesg</span>
</code></pre> 
<h5><a id="gVisorContainerd_746"></a>gVisor与Containerd集成</h5> 
<p>如果这里是Docker的环境，需要切换到Containerd容器引擎。</p> 
<p>仍然需要将runsc 、containerd-shim-runsc-v1工具移到/usr/local/bin下面</p> 
<p><strong>1.准备配置</strong></p> 
<p>开启ipv4路由转发配置，重新生效系统配置</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat &gt; /etc/sysctl.d/99-kubernetes-cri.conf &lt;&lt; EOF</span>
net.bridge.bridge-nf-call-iptables <span class="token operator">=</span> <span class="token number">1</span>
net.ipv4.ip_forward <span class="token operator">=</span> <span class="token number">1</span>
net.bridge.bridge-nf-call-ip6tables <span class="token operator">=</span> <span class="token number">1</span>
EOF

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># sysctl -system</span>
</code></pre> 
<p><strong>2、安装Containerd</strong></p> 
<p>如果默认安装了docker-ce会自动安装containerd的依赖，没有则需要安装containerd。</p> 
<p>ubuntu添加docker-ce的repo源之后apt-get install的方式安装</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/yum.repos.d</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># wget http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y containerd.io</span>
</code></pre> 
<p><strong>3、修改配置文件</strong></p> 
<ol><li>pause镜像地址</li><li>Cgroup驱动改为systemd</li><li>增加runsc容器运行时</li><li>配置docker镜像加速器</li></ol> 
<p>修改配置文件默认的containerd的配置文件是空的，所以需要重新生成一个完整的配置文件。</p> 
<p>containerd的目录是在 <code>/etc/containerd</code></p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/containerd/</span>
<span class="token punctuation">[</span>root@master01 containerd<span class="token punctuation">]</span><span class="token comment"># containerd config  default &gt; config.toml</span>
<span class="token punctuation">[</span>root@master01 containerd<span class="token punctuation">]</span><span class="token comment"># vim config.toml</span>
 <span class="token number">43</span>   <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">]</span>
 		····
 		<span class="token comment"># 修改镜像为国内的镜像</span>
 <span class="token number">56</span>     sandbox_image <span class="token operator">=</span> <span class="token string">"registry.aliyuncs.com/google_containers/pause:3.2"</span>   
 		···· 
 			<span class="token comment"># 添加一个runsc,指定类型为runsc，这里是跟runc同级</span>
 <span class="token number">90</span>        <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runsc<span class="token punctuation">]</span>  
 <span class="token number">91</span>           runtime_type <span class="token operator">=</span> <span class="token string">"io.containerd.runsc.v1"</span>   				  

			<span class="token comment"># 修改systemd驱动为true</span>
 <span class="token number">94</span>        <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runc<span class="token punctuation">]</span>
 <span class="token number">103</span>          <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runc.options<span class="token punctuation">]</span>
				···
 <span class="token number">114</span>            SystemdCgroup <span class="token operator">=</span> <span class="token boolean">true</span>	
 		
 			<span class="token comment"># 添加docker仓库的镜像源，配置阿里镜像加速</span>
 <span class="token number">139</span>       <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors<span class="token punctuation">]</span>
 <span class="token number">140</span>        <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.registry.mirrors.<span class="token string">"docker.io"</span><span class="token punctuation">]</span>  
 <span class="token number">141</span>          endpoint <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"https://b9pmyelo.mirror.aliyuncs.com"</span><span class="token punctuation">]</span>
</code></pre> 
<p><strong>配置kubelet使用containerd</strong></p> 
<p>配置完之后先重启containerd，再重启kubelet，最后如果pod出现报错，重启docker。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/sysconfig/kubelet </span>
<span class="token assign-left variable">KUBELET_EXTRA_ARGS</span><span class="token operator">=</span>--container-runtime<span class="token operator">=</span>remote --container-runtime-endpoint<span class="token operator">=</span>unix:///run/containerd/containerd.sock --cgroup-driver<span class="token operator">=</span>systemd

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart containerd</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart kubelet</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart docker</span>
</code></pre> 
<p><strong>验证当前的Kubernetes容器基层</strong></p> 
<ol><li><code>以上的步骤需要在所有集群配置</code></li><li><code>包括crictl连接containerd的配置也要在所有集群运行</code></li></ol> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get  node -o wide | awk  '{print $1,$2,$5,$NF}' | column -t</span>
NAME      STATUS  VERSION  CONTAINER-RUNTIME
master01  Ready   v1.22.1  containerd://1.5.11
master02  Ready   v1.22.1  containerd://1.5.11
master03  Ready   v1.22.1  containerd://1.5.11
</code></pre> 
<p><strong>crictl连接containerd</strong></p> 
<p>containerd也有 ctr 管理工具，但功能比较简单，一般使用crictl工具检查和调试容器。</p> 
<p>项目地址：https://github.com/kubernetes-sigs/cri-tools/</p> 
<p>准备crictl连接containerd配置文件：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat &gt; /etc/crictl.yaml &lt;&lt; EOF</span>
runtime-endpoint: unix:///run/containerd/containerd.sock
EOF
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart  containerd </span>
</code></pre> 
<p>下面是docker与crictl命令对照表：</p> 
<p><img src="https://images2.imgbox.com/f8/49/a9xIpH7C_o.png" alt="image-20220414115021436"></p> 
<h4><a id="_875"></a>案例实施</h4> 
<h6><a id="_K8sgVisor_877"></a>示例： K8s使用gVisor运行容器</h6> 
<ul><li>创建RuntimeClass</li><li>绑定RuntimeClass</li></ul> 
<p>RuntimeClass 是一个用于选择容器运行时配置的特性，容器运行时配置用 于运行 Pod 中的容器。</p> 
<p>创建RuntimeClass：</p> 
<ul><li>这里创建一个名称为<code>gvisor</code>的runtimeclass资源</li><li>可以创建多个<code>runtimeclass</code>资源，起到隔离的效果</li><li>handler一定是<code>runsc</code>，对应CSI的配置名称</li></ul> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat runtime.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> node.k8s.io/v1 <span class="token comment"># RuntimeClass 定义于 node.k8s.io API 组</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RuntimeClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gvisor <span class="token comment"># 用来引用 RuntimeClass 的名字</span>
<span class="token key atrule">handler</span><span class="token punctuation">:</span> runsc <span class="token comment"># 对应的 CRI 配置的名称</span>

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get runtimeclasses</span>
NAME     HANDLER   AGE
gvisor   runsc     72m
</code></pre> 
<p>创建Pod测试gVisor：</p> 
<p>这里使用<code>runtimeClassName</code>绑定</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> pod
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> <span class="token string">"master01"</span>
  <span class="token key atrule">runtimeClassName</span><span class="token punctuation">:</span> gvisor
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
    
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME   READY   STATUS    RESTARTS   AGE
pod    1/1     Running   0          72m
</code></pre> 
<ul><li>创建RuntimeClass</li><li>绑定RuntimeClass</li></ul> 
<p>RuntimeClass 是一个用于选择容器运行时配置的特性，容器运行时配置用 于运行 Pod 中的容器。</p> 
<p>创建RuntimeClass：</p> 
<ul><li>这里创建一个名称为<code>gvisor</code>的runtimeclass资源</li><li>可以创建多个<code>runtimeclass</code>资源，起到隔离的效果</li><li>handler一定是<code>runsc</code>，对应CSI的配置名称</li></ul> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat runtime.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> node.k8s.io/v1 <span class="token comment"># RuntimeClass 定义于 node.k8s.io API 组</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RuntimeClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gvisor <span class="token comment"># 用来引用 RuntimeClass 的名字</span>
<span class="token key atrule">handler</span><span class="token punctuation">:</span> runsc <span class="token comment"># 对应的 CRI 配置的名称</span>

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get runtimeclasses</span>
NAME     HANDLER   AGE
gvisor   runsc     72m
</code></pre> 
<p>创建Pod测试gVisor：</p> 
<p>这里使用<code>runtimeClassName</code>绑定</p> 
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> pod
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> <span class="token string">"master01"</span>
  <span class="token key atrule">runtimeClassName</span><span class="token punctuation">:</span> gvisor
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
    
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME   READY   STATUS    RESTARTS   AGE
pod    1/1     Running   0          72m
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/319ccd67a718e0fd22a97268689a03c9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">word文档中工具栏不显示mathtype处理方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/aec4c00e1abb4e03ac1b19ec936bcfba/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">6.监控、审计和运行时安全</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>