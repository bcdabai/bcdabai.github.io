<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux之pinctrl子系统与gpio - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux之pinctrl子系统与gpio" />
<meta property="og:description" content="文章目录 pinctrl子系统文件列表pinctrl主要数据结构pinctrl_dev 是 pinctrl 子系统的根源结构体函数调用逻辑 设备树实例驱动使用pinctrl与驱动模型的接口和device tree或者machine driver相关的接口 参考链接： http://www.wowotech.net/sort/gpio_subsystem pinctrl子系统文件列表 linux/drivers/pinctrl目录下的源文件列表
源文件列表 文件名描述core.c core.hpin control subsystem的core driverpinctrl-utils.c pinctrl-utils.hpin control subsystem的一些utility接口函数pinmux.c pinmux.hpin control subsystem的core driver(pin muxing部分的代码，也称为pinmux driver)pinconf.c pinconf.hpin control subsystem的core driver(pin config部分的代码，也称为pin config driver)devicetree.c devicetree.hpin control subsystem的device tree代码pinctrl-xxxx.c各种pin controller的low level driver 其他内核模块接口文件，很多内核的其他模块需要用到pin control subsystem的服务，这些头文件就定义了pin control subsystem的外部接口以及相关的数据结构 文件名描述consumer.h其他的driver要使用pin control subsystem的接口：a、设置引脚复用功能 b、配置引脚的电气特性；需要include这个头文件devinfo.h这是linux内核的驱动模型模块使用的接口。struct device中包括struct dev_pin_info *pins的成员，描述了该设备的引脚的初始状态信息，在probe之前，driver model中的core driver在调用driver的probe函数之前会先设定pin statemachine.hmachine模块的接口 Low level pin controller driver接口，提供给底层specific pin controller driver的头文件列表 文件名描述pinconf-generic.h主要是提供给各种pin controller driver使用的，不是外部接口pinconf.hpin configuration 接口pinctrl-state.hpin control state状态定义pinmux." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/fba6d88a5010a1a0856693a06b9ca92c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-22T09:35:54+08:00" />
<meta property="article:modified_time" content="2022-07-22T09:35:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux之pinctrl子系统与gpio</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#pinctrl_4" rel="nofollow">pinctrl子系统文件列表</a></li><li><a href="#pinctrl_31" rel="nofollow">pinctrl主要数据结构</a></li><li><ul><li><a href="#pinctrl_dev__pinctrl__32" rel="nofollow">pinctrl_dev 是 pinctrl 子系统的根源结构体</a></li><li><a href="#_292" rel="nofollow">函数调用逻辑</a></li></ul> 
  </li><li><a href="#_300" rel="nofollow">设备树实例</a></li><li><a href="#pinctrl_367" rel="nofollow">驱动使用pinctrl</a></li><li><a href="#_391" rel="nofollow">与驱动模型的接口</a></li><li><a href="#device_treemachine_driver_435" rel="nofollow">和device tree或者machine driver相关的接口</a></li></ul> 
</div> 
<br> 参考链接： 
<br> 
<a href="http://www.wowotech.net/sort/gpio_subsystem" rel="nofollow">http://www.wowotech.net/sort/gpio_subsystem</a> 
<br> 
<img src="https://images2.imgbox.com/58/c1/EwyU6GHL_o.png" alt="在这里插入图片描述"> 
<p></p> 
<h2><a id="pinctrl_4"></a>pinctrl子系统文件列表</h2> 
<p>linux/drivers/pinctrl目录下的源文件列表</p> 
<ul><li>源文件列表</li></ul> 
<table><thead><tr><th>文件名</th><th>描述</th></tr></thead><tbody><tr><td>core.c core.h</td><td>pin control subsystem的core driver</td></tr><tr><td>pinctrl-utils.c pinctrl-utils.h</td><td>pin control subsystem的一些utility接口函数</td></tr><tr><td>pinmux.c pinmux.h</td><td>pin control subsystem的core driver(pin muxing部分的代码，也称为pinmux driver)</td></tr><tr><td>pinconf.c pinconf.h</td><td>pin control subsystem的core driver(pin config部分的代码，也称为pin config driver)</td></tr><tr><td>devicetree.c devicetree.h</td><td>pin control subsystem的device tree代码</td></tr><tr><td>pinctrl-xxxx.c</td><td>各种pin controller的low level driver</td></tr></tbody></table> 
<ul><li>其他内核模块接口文件，很多内核的其他模块需要用到pin control subsystem的服务，这些头文件就定义了pin control subsystem的外部接口以及相关的数据结构</li></ul> 
<table><thead><tr><th>文件名</th><th>描述</th></tr></thead><tbody><tr><td>consumer.h</td><td>其他的driver要使用pin control subsystem的接口：a、设置引脚复用功能 b、配置引脚的电气特性；需要include这个头文件</td></tr><tr><td>devinfo.h</td><td>这是linux内核的驱动模型模块使用的接口。struct device中包括struct dev_pin_info *pins的成员，描述了该设备的引脚的初始状态信息，在probe之前，driver model中的core driver在调用driver的probe函数之前会先设定pin state</td></tr><tr><td>machine.h</td><td>machine模块的接口</td></tr></tbody></table> 
<ul><li>Low level pin controller driver接口，提供给底层specific pin controller driver的头文件列表</li></ul> 
<table><thead><tr><th>文件名</th><th>描述</th></tr></thead><tbody><tr><td>pinconf-generic.h</td><td>主要是提供给各种pin controller driver使用的，不是外部接口</td></tr><tr><td>pinconf.h</td><td>pin configuration 接口</td></tr><tr><td>pinctrl-state.h</td><td>pin control state状态定义</td></tr><tr><td>pinmux.h</td><td>pin mux function接口</td></tr></tbody></table> 
<h2><a id="pinctrl_31"></a>pinctrl主要数据结构</h2> 
<h3><a id="pinctrl_dev__pinctrl__32"></a>pinctrl_dev 是 pinctrl 子系统的根源结构体</h3> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> node<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">pinctrl_desc</span> <span class="token operator">*</span>desc<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">radix_tree_root</span> pin_desc_tree<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_GENERIC_PINCTRL_GROUPS</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">radix_tree_root</span> pin_group_tree<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> num_groups<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_GENERIC_PINMUX_FUNCTIONS</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">radix_tree_root</span> pin_function_tree<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> num_functions<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> gpio_ranges<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>driver_data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>hog_default<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>hog_sleep<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mutex</span> mutex<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_DEBUG_FS</span></span>
	<span class="token keyword">struct</span> <span class="token class-name">dentry</span> <span class="token operator">*</span>device_root<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ol><li>pinctrl_desc：这里包含了pinctrl 子系统三个最重要的结构体，有三个操作函数集，pinctrl_ops 包含了对 PIN 的操作函数集，pinmux_ops 包含了对 PIN 的复用函数集，pinconf_ops 包含了对 PIN 的配置函数</li></ol> 
<ul><li>pin controller描述符。每一个特定的pin controller都用一个struct pinctrl_desc来抽象</li><li>pin controller描述符需要描述它可以控制多少个pin，每一个pin的信息。这两个成员就确定了一个pin controller所能控制的引脚的信息。</li></ul> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/pinctrl/pinctrl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/pinctrl/pinmux.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/pinctrl/pinconf.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/platform_device.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">pinctrl_desc</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
	<span class="token comment">//指向npins个pin描述符，每个描述符描述一个pin</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_pin_desc</span> <span class="token operator">*</span>pins<span class="token punctuation">;</span>
	<span class="token comment">//该pin controller中有多少个可控的pin</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> npins<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_ops</span> <span class="token operator">*</span>pctlops<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinmux_ops</span> <span class="token operator">*</span>pmxops<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinconf_ops</span> <span class="token operator">*</span>confops<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_GENERIC_PINCONF</span></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> num_custom_params<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinconf_generic_params</span> <span class="token operator">*</span>custom_params<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pin_config_item</span> <span class="token operator">*</span>custom_conf_items<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//对PIN的操作函数集</span>
<span class="token keyword">struct</span> <span class="token class-name">pinctrl_ops</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//该pin controller支持多少个pin group</span>
	<span class="token comment">//pin group的定义可以参考关于pin controller的功能规格中的描述。</span>
	<span class="token comment">//注意不要把pin group和IO port的硬件分组搞混了。例如：S3C2416有138个I/O 端口，分成11组，分别是gpa～gpl，这个组并不叫pin group，而是叫做pin bank。pin group是和特定功能（例如SPI、I2C）相关的一组pin。</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_groups_count<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//给定一个selector（index），获取指定pin group的name</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>get_group_name<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//给定一个selector（index），获取该pin group中pin的信息（该pin group包括多少个pin，每个pin的ID是什么）</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_group_pins<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> selector<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token operator">*</span><span class="token operator">*</span>pins<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token operator">*</span>num_pins<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//debug fs的callback接口</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_dbg_show<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//分析一个pin configuration node并把分析的结果保存成mapping table entry，每一个entry表示一个setting（一个功能复用设定，或者电气特性设定）</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>dt_node_to_map<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np_config<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span><span class="token operator">*</span>map<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token operator">*</span>num_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//dt_node_to_map函数的逆函数</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dt_free_map<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>map<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> num_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//对PIN的复用函数集</span>
<span class="token keyword">struct</span> <span class="token class-name">pinmux_ops</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//pin control core进行具体的复用设定之前需要调用该函数，主要是用来底层的driver判断某个引脚的复用设定是否是OK的。</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//是request的逆函数。调用request函数请求占用了某些pin的资源，调用free可以释放这些资源</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>free<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//返回pin controller支持的function的数目</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_functions_count<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//给定一个selector（index），获取指定function的name</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>get_function_name<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//给定一个selector（index），获取指定function的pin groups信息</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_function_groups<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> selector<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> <span class="token operator">*</span><span class="token operator">*</span>groups<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token operator">*</span>num_groups<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>set_mux<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> func_selector<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> group_selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//request并且enable一个单独的gpio pin</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>gpio_request_enable<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_gpio_range</span> <span class="token operator">*</span>range<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//gpio_request_enable的逆函数</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>gpio_disable_free<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_gpio_range</span> <span class="token operator">*</span>range<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//设定GPIO方向的回调函数</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>gpio_set_direction<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_gpio_range</span> <span class="token operator">*</span>range<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">,</span> bool input<span class="token punctuation">)</span><span class="token punctuation">;</span>
	bool strict<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//对PIN的配置函数</span>
<span class="token keyword">struct</span> <span class="token class-name">pinconf_ops</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_GENERIC_PINCONF</span></span>
	bool is_generic<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token comment">//给定一个pin ID以及config type ID，获取该引脚上指定type的配置</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_get<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> pin<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//设定一个指定pin的配置</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_set<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> pin<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>configs<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> num_configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//	以pin group为单位，获取pin上的配置信息</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_group_get<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> selector<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//	以pin group为单位，设定pin group的特性配置</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_group_set<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> selector<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>configs<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> num_configs<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//debug接口</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_dbg_parse_modify<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//debug接口</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_dbg_show<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//debug接口</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_group_dbg_show<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//debug接口</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin_config_config_dbg_show<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>pinctrl 结构体：这里包含了 PIN 控制器所控制 PIN 的状态 state，state 里面包含了setting，这个 setting 就是在设备树中对PIN的设置，设计理念如下：</li></ol> 
<ul><li>设置该设备的功能复用，一个是function，另外一个pin group。function是功能抽象，对应一个HW逻辑block，例如SPI0。虽然给定了具体的gunction name，并不能确定其使用的pins的情况。例如：芯片内部的SPI0的功能可能引出到pin group { A8, A7, A6, A5 }，也可能引出到另外一个pin group{ G4, G3, G2, G1 }，但是这两个pin group不能同时active， 因此，只有给出function selector（selector就是一个ID或者index）以及function的pin group selector才能进行function mux的设定。</li><li>设定该device对应的那些pin的电气特性。由于电源管理的要求，某个device可能处于某个电源管理状态，如idle或者sleep，这时候，属于该device的所有的pin就会需要处于另外的状态。综合上述的需求，定义了pin control state的概念，也就是设备可能处于非常多的状态中的一个，device driver可以切换设备处于的状态。为了方便管理pin control state，提出了一个pin control state holder的概念，用来管理一个设备的所有的pin control状态</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> node<span class="token punctuation">;</span><span class="token comment">//系统中的所有device的pin control state holder被挂入到了一个全局链表中</span>
	<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span><span class="token comment">//该pin control state holder对应的device</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> states<span class="token punctuation">;</span><span class="token comment">//该设备的所有的状态被挂入到这个链表中</span>
	<span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>state<span class="token punctuation">;</span><span class="token comment">//当前的pin control state</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> dt_maps<span class="token punctuation">;</span><span class="token comment">//mapping table</span>
	<span class="token keyword">struct</span> <span class="token class-name">kref</span> users<span class="token punctuation">;</span><span class="token comment">//引用计数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>通过create_pinctrl()函数来创建一个pinctrl，通过pinctrl_dt_to_map()来解析</li><li>系统中的每一个需要和pin control subsystem进行交互的设备在进行设定之前都需要首先获取这个结构体指针。而属于该设备的所有的状态都是挂入到一个链表中，链表头就是pin control state holder的states成员，一个state的定义如下：</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> node<span class="token punctuation">;</span><span class="token comment">//挂入链表头的节点</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span><span class="token comment">//该state的名字</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> settings<span class="token punctuation">;</span><span class="token comment">//属于该状态的所有的settings</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//一个pin state包含若干个setting，所有的settings被挂入一个链表中，链表头就是pin state中的settings成员，定义如下：</span>
<span class="token keyword">struct</span> <span class="token class-name">pinctrl_setting</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> node<span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token class-name">pinctrl_map_type</span> type<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dev_name<span class="token punctuation">;</span>
    <span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> <span class="token class-name">pinctrl_setting_mux</span> mux<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">pinctrl_setting_configs</span> configs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*
当driver设定一个pin state的时候，pin control subsystem内部会遍历该state的settings链表，将一个一个的setting进行设定。这些settings有各种类型，定义如下：
*/</span>
<span class="token keyword">enum</span> <span class="token class-name">pinctrl_map_type</span> <span class="token punctuation">{<!-- --></span>
    PIN_MAP_TYPE_INVALID<span class="token punctuation">,</span>
    PIN_MAP_TYPE_DUMMY_STATE<span class="token punctuation">,</span>
    PIN_MAP_TYPE_MUX_GROUP<span class="token punctuation">,</span><span class="token comment">//功能复用的setting</span>
    PIN_MAP_TYPE_CONFIGS_PIN<span class="token punctuation">,</span><span class="token comment">//设定单一个pin的电气特性</span>
    PIN_MAP_TYPE_CONFIGS_GROUP<span class="token punctuation">,</span><span class="token comment">//设定单pin group的电气特性</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//有pin mux相关的设定（PIN_MAP_TYPE_MUX_GROUP），定义如下：</span>
<span class="token keyword">struct</span> <span class="token class-name">pinctrl_setting_mux</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> group<span class="token punctuation">;</span><span class="token comment">//该setting所对应的group selector</span>
    <span class="token keyword">unsigned</span> func<span class="token punctuation">;</span><span class="token comment">//该setting所对应的function selector</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//有了function selector以及属于该functiong的roup selector就可以进行该device和pin mux相关的设定了。设定电气特性的settings定义如下：</span>
<span class="token keyword">struct</span> <span class="token class-name">pinctrl_map_configs</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>group_or_pin<span class="token punctuation">;</span><span class="token comment">//该pin或者pin group的名字</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>configs<span class="token punctuation">;</span><span class="token comment">//要设定的值的列表。这个值被用来写入HW</span>
    <span class="token keyword">unsigned</span> num_configs<span class="token punctuation">;</span><span class="token comment">//列表中值的个数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="3"><li>gpio 相关的结构体gpio_chip，因 pinctrl 子系统和 gpio 子系统是耦合的</li></ol> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>label<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">gpio_device</span>	<span class="token operator">*</span>gpiodev<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">module</span> <span class="token operator">*</span>owner<span class="token punctuation">;</span>

	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>request<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>free<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_direction<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>direction_input<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>direction_output<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>get<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>set_multiple<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>mask<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>set_config<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>to_irq<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dbg_show<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">seq_file</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>chip<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> base<span class="token punctuation">;</span>
	u16 ngpio<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token operator">*</span>names<span class="token punctuation">;</span>
	bool can_sleep<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_GPIO_GENERIC<span class="token punctuation">)</span></span></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_reg<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> __iomem <span class="token operator">*</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>write_reg<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> __iomem <span class="token operator">*</span>reg<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>pin2mask<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>gc<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pin<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> __iomem <span class="token operator">*</span>reg_dat<span class="token punctuation">;</span>
	<span class="token keyword">void</span> __iomem <span class="token operator">*</span>reg_set<span class="token punctuation">;</span>
	<span class="token keyword">void</span> __iomem <span class="token operator">*</span>reg_clr<span class="token punctuation">;</span>
	<span class="token keyword">void</span> __iomem <span class="token operator">*</span>reg_dir<span class="token punctuation">;</span>
	<span class="token keyword">int</span> bgpio_bits<span class="token punctuation">;</span>
	<span class="token class-name">spinlock_t</span> bgpio_lock<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> bgpio_data<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> bgpio_dir<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_GPIOLIB_IRQCHIP</span></span>
	<span class="token comment">/*
	 * With CONFIG_GPIOLIB_IRQCHIP we get an irqchip inside the gpiolib
	 * to handle IRQs for most practical cases.
	 */</span>
	<span class="token keyword">struct</span> <span class="token class-name">irq_chip</span>		<span class="token operator">*</span>irqchip<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">irq_domain</span>	<span class="token operator">*</span>irqdomain<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		irq_base<span class="token punctuation">;</span>
	<span class="token class-name">irq_flow_handler_t</span>	irq_handler<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		irq_default_type<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span>		irq_chained_parent<span class="token punctuation">;</span>
	bool			irq_nested<span class="token punctuation">;</span>
	bool			irq_need_valid_mask<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span>		<span class="token operator">*</span>irq_valid_mask<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">lock_class_key</span>	<span class="token operator">*</span>lock_key<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_OF_GPIO<span class="token punctuation">)</span></span></span>
	<span class="token comment">/*
	 * If CONFIG_OF is enabled, then all GPIO controllers described in the
	 * device tree automatically may have an OF translation
	 */</span>

	<span class="token comment">/*Pointer to a device tree node representing this GPIO controller.*/</span>
	<span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>of_node<span class="token punctuation">;</span>

	<span class="token comment">/* Number of cells used to form the GPIO specifier.*/</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> of_gpio_n_cells<span class="token punctuation">;</span>

	<span class="token comment">/**
	 * Callback to translate a device tree GPIO specifier into a chip-
	 * relative GPIO number and flags.
	 */</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>of_xlate<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>gc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_phandle_args</span> <span class="token operator">*</span>gpiospec<span class="token punctuation">,</span> u32 <span class="token operator">*</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>根据GPIO ID找到该ID对应的pin control device（struct pinctrl_dev）和GPIO rang（pinctrl_gpio_range）。在core driver中，每个low level的pin controller device都被映射成一个struct pinctrl_dev，并形成链表，链表头就是pinctrldev_list。由于实际的硬件设计（例如GPIO block被分成若干个GPIO 的bank，每个bank就对应一个HW GPIO Controller Block），一个pin control device要管理的GPIO ID是分成区域的，每个区域用struct pinctrl_gpio_range来抽象，在low level 的pin controller初始化的时候（具体参考samsung_pinctrl_register的代码），会调用pinctrl_add_gpio_range将每个GPIO bank表示的gpio range挂入到pin control device的range list中（gpio_ranges成员）。pinctrl_gpio_range 的定义如下：</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_gpio_range</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> node<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span><span class="token comment">//GPIO chip ID</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> base<span class="token punctuation">;</span><span class="token comment">//该range中的起始GPIO IDD</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pin_base<span class="token punctuation">;</span><span class="token comment">//在线性映射的情况下，这是起始的pin base</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">const</span> <span class="token operator">*</span>pins<span class="token punctuation">;</span><span class="token comment">//在非线性映射的时候，这是table是pin到GPIO的lookup table</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> npins<span class="token punctuation">;</span><span class="token comment">//这个range有多少个GPIO引脚</span>
    <span class="token keyword">struct</span> <span class="token class-name">gpio_chip</span> <span class="token operator">*</span>gc<span class="token punctuation">;</span><span class="token operator">-</span><span class="token comment">//每个GPIO bank都是一个gpio chip，对应一个GPIO range</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>pin ID和GPIO ID有两种映射关系，一种是线性映射（这时候pin_base有效），对于这个GPIO range，GPIO base ID是a，pin ID base是b，那么a&lt;—&gt;b，a＋1&lt;—&gt;b＋1，a＋2&lt;—&gt;b＋2，以此类推。对于非线性映射（pin_base无效，pins是有效的），需要建立一个lookup table，以GPIO ID为索引，可以找到对于的pin ID。</li></ul> 
<h3><a id="_292"></a>函数调用逻辑</h3> 
<ol><li>在文件 drivers/pinctrl/freescale/pinctrl-xxx.c中，驱动的入口是 arch_initcall 中声明的函数</li><li>pinctrl 子系统的驱动也是一个标准的 platform 驱动框架，分为：驱动、设备、总线。platform 虚拟总线会按照 of_device_id 结构体中的 compatible 属性去匹配 pinctrl 驱动和设备</li><li>of_device_id 定义的数组，最后一个是空元素，这是必须的，原因是 platform 本身的 match 函数中需要判断是否达到末尾，of_device_id 定义的 compatible 经常不止一个，系统需要知道是否匹配到最后一个元素</li><li>probe 函数后面的调用中，调用 pinctrl_register 函数，向 Linux 内核注册一个 PIN 控制器</li></ol> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span><span class="token function">pinctrl_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl_desc</span> <span class="token operator">*</span>pctldesc<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>driver_data<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_300"></a>设备树实例</h2> 
<ol><li>pin controller 的DTS结构</li></ol> 
<ul><li>每个pin configuration都是pin controller的child node，描述了client device要使用到的一组pin的配置信息</li><li>各个device可以通过自己节点的属性来指向pin controller的某个child node，也就是pin configuration</li></ul> 
<ol start="2"><li>DTS的PIN属性</li></ol> 
<ul><li>actions，groups的属性用于表示Mux Group的名字数组</li><li>actions，pins的属性用于表示该组pin的名字数组</li><li>actions，function的属性表示该组Mux Group使用功能的名字</li><li>actions，paddrv的属性表示该组Dirve Group所代表的pin的驱动能力</li><li>actions，pull的属性表述该组的pin需要配置的上下拉状态</li></ul> 
<pre><code class="prism language-c">pinctrl@<span class="token number">56000000</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token comment">//定义S3C2416 pin controller自己的属性</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x56000000</span> <span class="token number">0x1000</span><span class="token operator">=</span><span class="token string">""</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        compatible <span class="token operator">=</span> <span class="token string">"samsung,s3c2416-pinctrl"</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//定义pin bank</span>
        gpf <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//gpio-controller属性，说明该device node是一个GPIO controller</span>
            gpio<span class="token operator">-</span>controller<span class="token punctuation">;</span>
            <span class="token comment">//#gpio-cells属性是一个GPIO controller的必须定义的属性，描述了需要多少个cell来具体描述一个GPIO（这是和具体的GPIO controller相关的）</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">gpio</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
            interrupt<span class="token operator">-</span>controller<span class="token punctuation">;</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">interrupt</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
            <span class="token comment">//phandle（linux,phandle这个属性和phandle是一样的，只不过linux,phandle是old-style，多定义一个属性是为了兼容）定义了一个句柄，当其他的device node想要引用这个node的时候就可以使用该句柄</span>
            linux<span class="token punctuation">,</span>phandle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0xc</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
            phandle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0xc</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//定义功能复用配置</span>
        uart0<span class="token operator">-</span>data <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//samsung,pins这个属性定义了一个pin configuration所涉及到的引脚定义</span>
        <span class="token comment">//对于uart0-data这个node，该配置涉及了gph bank中的第一个和第二个GPIO pin</span>
        <span class="token comment">//一旦选择功能，amsung,pins定义的引脚需要做功能设定，这就是samsung,pin-function定义的内容。而具体设定需要去查阅datasheet</span>
    	samsung<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token string">"gph-0"</span><span class="token punctuation">,</span> <span class="token string">"gph-1"</span><span class="token punctuation">;</span>
    	samsung<span class="token punctuation">,</span>pin<span class="token operator">-</span>function <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    	linux<span class="token punctuation">,</span>phandle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    	phandle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>

		uart0<span class="token operator">-</span>fctl <span class="token punctuation">{<!-- --></span>
    	samsung<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token string">"gph-8"</span><span class="token punctuation">,</span> <span class="token string">"gph-9"</span><span class="token punctuation">;</span>
    	samsung<span class="token punctuation">,</span>pin<span class="token operator">-</span>function <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x2</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    	linux<span class="token punctuation">,</span>phandle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x3</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    	phandle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x3</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token comment">//client device的DTS</span>
device<span class="token operator">-</span>node<span class="token operator">-</span>name <span class="token punctuation">{<!-- --></span> 
    <span class="token comment">//定义该device自己的属性  </span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">//pinctrl-names定义了一个pin state列表</span>
	<span class="token comment">//state有两种，标识，一种就是pinctrl-names定义的字符串列表，另外一种就是ID,ID从0开始，依次加</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"sleep"</span><span class="token punctuation">,</span> <span class="token string">"active"</span><span class="token punctuation">;</span>
    <span class="token comment">//pinctrl-x的定义。pinctrl-x是一个句柄（phandle）列表，每个句柄指向一个pin configuration。</span>
    <span class="token comment">//有时候，一个state对应多个pin configure。例如I2C功能有两种配置，一是pin ID{7,8}引出，另一是pin ID{69,103}引出</span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span>pin<span class="token operator">-</span>config<span class="token operator">-</span><span class="token number">0</span><span class="token operator">-</span>a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span>pin<span class="token operator">-</span>config<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>a pin<span class="token operator">-</span>config<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>b<span class="token operator">&gt;</span><span class="token punctuation">;</span>        
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//例如</span>
serial@<span class="token number">50000000</span> <span class="token punctuation">{<!-- --></span> 
	……
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x2</span> <span class="token number">0x3</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token comment">//或 pinctrl-0 = &lt;&amp;uart0-data &amp;uart0-fctl&gt;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="pinctrl_367"></a>驱动使用pinctrl</h2> 
<pre><code class="prism language-c"><span class="token comment">//设备驱动模块获取对应的pinctrl</span>
<span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span><span class="token function">devm_pinctrl_get</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span><span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span><span class="token function">pinctrl_get_select_default</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span><span class="token function">devm_pinctrl_get_select</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//pinctrl子系统申请GPIO</span>
<span class="token keyword">int</span> <span class="token function">pinctrl_request_gpio</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">pinctrl_free_gpio</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pinctrl_gpio_direction_input</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pinctrl_gpio_direction_output</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//GPIO子系统申请GPIO</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio.h&gt;</span> <span class="token comment">//里面声明io口的操作函数</span></span>
<span class="token keyword">int</span> <span class="token function">gpio_request</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//每个io只能被请求一次,可防止多个驱动来控制同一个IO口 </span>
<span class="token keyword">void</span> <span class="token function">gpio_free</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//释放已请求的io口 </span>
<span class="token keyword">int</span> <span class="token function">gpio_direction_input</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//把指定的IO口作输入功能, gpio用于指定具体哪个io口 </span>
<span class="token keyword">int</span> <span class="token function">gpio_direction_output</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//作输出功能，并根据value的值输出高低电平 </span>
<span class="token keyword">int</span> <span class="token function">gpio_get_value</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//获取指定IO口的电平 </span>
<span class="token keyword">void</span> <span class="token function">gpio_set_value</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置IO口的电平为value(0/1)</span>
<span class="token keyword">int</span> <span class="token function">gpio_to_irq</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> gpio<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//根据io口，获取到它对应的中断号(io口大都有外部中断功能)</span>
</code></pre> 
<h2><a id="_391"></a>与驱动模型的接口</h2> 
<ul><li>与其写代码调用devm_pinctrl_get、pinctrl_lookup_state、pinctrl_select_state等pin control subsystem的接口函数，最好是让统一设备驱动模型（Driver model）来处理pin 的各种设定。</li><li>linux kernel中的驱动模型提供了driver和device的绑定机制，一旦匹配会调用probe函数如下：</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">really_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ……
    ret <span class="token operator">=</span> <span class="token function">pinctrl_bind_pins</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//对该device涉及的pin进行pin control相关设定</span>
    ……

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span>probe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//下面是真正的probe过程</span>
        ret <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>bus<span class="token operator">-&gt;</span><span class="token function">probe</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> probe_failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>drv<span class="token operator">-&gt;</span>probe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> drv<span class="token operator">-&gt;</span><span class="token function">probe</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> probe_failed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

……

<span class="token punctuation">}</span>
<span class="token comment">//pinctrl_bind_pins的代码如下：</span>
<span class="token keyword">int</span> <span class="token function">pinctrl_bind_pins</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>pins <span class="token operator">=</span> <span class="token function">devm_kzalloc</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p <span class="token operator">=</span> <span class="token function">devm_pinctrl_get</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用devm_pinctrl_get获取该device对应的 pin control state holder句柄</span>
    <span class="token comment">//搜索default state，sleep state，idle state并记录在本device中</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>default_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">pinctrl_select_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>default_state<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将该设备设定为pin default state</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>sleep_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_SLEEP<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//（3）</span>
    dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>idle_state <span class="token operator">=</span> <span class="token function">pinctrl_lookup_state</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>pins<span class="token operator">-&gt;</span>p<span class="token punctuation">,</span> PINCTRL_STATE_IDLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//（3）</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//struct device数据结构有一个pins的成员，它描述了和该设备相关的pin control的信息，定义如下：</span>
<span class="token keyword">struct</span> <span class="token class-name">dev_pin_info</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">;</span><span class="token comment">//该device对应的pin control state holder</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>default_state<span class="token punctuation">;</span><span class="token comment">//缺省状态</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>sleep_state<span class="token punctuation">;</span><span class="token comment">//电源管理相关的状态</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_state</span> <span class="token operator">*</span>idle_state<span class="token punctuation">;</span><span class="token comment">//电源管理相关的状态</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="device_treemachine_driver_435"></a>和device tree或者machine driver相关的接口</h2> 
<ul><li>device tree或者machine driver这两个模块主要是为 pin control subsystem提供pin mapping database的支持。这个database的每个entry用下面的数据结构表示：</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dev_name<span class="token punctuation">;</span><span class="token comment">//使用这个mapping entry的设备名</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span><span class="token comment">//该名字表示了该mapping entry</span>
    <span class="token keyword">enum</span> <span class="token class-name">pinctrl_map_type</span> type<span class="token punctuation">;</span><span class="token comment">//这个entry的mapping type</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ctrl_dev_name<span class="token punctuation">;</span><span class="token comment">//pin controller这个设备的名字</span>
    <span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map_mux</span> mux<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map_configs</span> configs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>通过machine driver静态定义的数据来建立pin mapping database，machine driver定义一个巨大的mapping table，描述，然后在machine初始化的时候，调用pinctrl_register_mappings将该table注册到pin control subsystem中。</li><li>通过device tree来建立pin mapping database，pin mapping信息定义在dts中，主要包括两个部分，一个是定义在各个具体的device node中，另外一处是定义在pin controller的device node中。</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//一个典型的device tree中的外设node定义如下</span>
device<span class="token operator">-</span>node<span class="token operator">-</span>name <span class="token punctuation">{<!-- --></span> 
        <span class="token comment">//定义该device自己的属性  </span>
        pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"sleep"</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
        pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token punctuation">;</span>
        pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token punctuation">;</span>        
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>对普通device的dts分析在函数pinctrl_dt_to_map中，代码如下：</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">pinctrl_dt_to_map</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  
    <span class="token function">of_node_get</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">//pinctrl-0 pinctrl-1……表示了该设备的一个个的状态，这里定义了两个pinctrl-0和pinctrl-1分别对应sleep和default状态。这里每次循环分析一个pin state。</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> state<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Retrieve the pinctrl-* property */</span>
        propname <span class="token operator">=</span> <span class="token function">kasprintf</span><span class="token punctuation">(</span>GFP_KERNEL<span class="token punctuation">,</span> <span class="token string">"pinctrl-%d"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        prop <span class="token operator">=</span> <span class="token function">of_find_property</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> propname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">kfree</span><span class="token punctuation">(</span>propname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prop<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token comment">//size和list分别保存了该pin state中所涉及pin configuration phandle的数目以及phandle的列表</span>
		<span class="token comment">//list指向pinctrl-x，size等于pinctrl-x=&lt;...&gt;元素个数</span>
        list <span class="token operator">=</span> prop<span class="token operator">-&gt;</span>value<span class="token punctuation">;</span>
        size <span class="token operator">/=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//读取从pinctrl-names属性中获取对应的state name，如：sleep 或 default</span>
        ret <span class="token operator">=</span> <span class="token function">of_property_read_string_index</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"pinctrl-names"</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token operator">&amp;</span>statename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//如果没有定义pinctrl-names属性，那么我们将pinctrl-0 pinctrl-1……中的那个ID取出来作为state name</span>
            <span class="token comment">/* strlen("pinctrl-") == 8 */</span>
            statename <span class="token operator">=</span> prop<span class="token operator">-&gt;</span>name <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//遍历一个pin state中的pin configuration list，即pinctrl-x=&lt;...&gt;对应的pin configuration，实际应该是pin controler device node中的sub node，用指针phandle标识</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>config <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> config <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> config<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            phandle <span class="token operator">=</span> <span class="token function">be32_to_cpup</span><span class="token punctuation">(</span>list<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//用phandle作为索引，在device tree中找他该phandle表示的那个pin configuration</span>
            np_config <span class="token operator">=</span> <span class="token function">of_find_node_by_phandle</span><span class="token punctuation">(</span>phandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>np_config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">dev_err</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"prop %s index %i invalid phandle\n"</span><span class="token punctuation">,</span> prop<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
				ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
				<span class="token keyword">goto</span> err<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
            <span class="token comment">//分析一个pin configuration</span>
            ret <span class="token operator">=</span> <span class="token function">dt_to_map_one_config</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> statename<span class="token punctuation">,</span> np_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">of_node_put</span><span class="token punctuation">(</span>np_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//如果该设备没有定义pin configuration，那么也要创建一个dummy的pin state</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">dt_remember_dummy_state</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> statename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
err<span class="token operator">:</span>
    <span class="token function">pinctrl_dt_free_maps</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>对普通device的dts分析在函数dt_to_map_one_config中，代码如下：</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//statename，对应的pinctrl-x的pinctrl-names属性名字，或ID</span>
<span class="token comment">//np_config，指向pinctrl-x=&lt;...&gt;其中的一个节点</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dt_to_map_one_config</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pinctrl</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>statename<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np_config<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np_pctldev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_dev</span> <span class="token operator">*</span>pctldev<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">pinctrl_ops</span> <span class="token operator">*</span>ops<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pinctrl_map</span> <span class="token operator">*</span>map<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> num_maps<span class="token punctuation">;</span>

    <span class="token comment">/* 增加节点np_config的引用 */</span>
    np_pctldev <span class="token operator">=</span> <span class="token function">of_node_get</span><span class="token punctuation">(</span>np_config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//首先找到该pin configuration node对应的parent node（也就是pin controler对应的node，如device-node-name），如果找不到或者是root node，则进入出错处理。</span>
        np_pctldev <span class="token operator">=</span> <span class="token function">of_get_next_parent</span><span class="token punctuation">(</span>np_pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>np_pctldev <span class="token operator">||</span> <span class="token function">of_node_is_root</span><span class="token punctuation">(</span>np_pctldev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">of_node_put</span><span class="token punctuation">(</span>np_pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EPROBE_DEFER<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取pin control class device，也就是底层注册的pinctrl_dev</span>
        pctldev <span class="token operator">=</span> <span class="token function">get_pinctrl_dev_from_of_node</span><span class="token punctuation">(</span>np_pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pctldev<span class="token punctuation">)</span>
        	<span class="token comment">//一旦找到pin control class device则跳出for循环</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token comment">/* Do not defer probing of hogs (circular loop) */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>np_pctldev <span class="token operator">==</span> p<span class="token operator">-&gt;</span>dev<span class="token operator">-&gt;</span>of_node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">of_node_put</span><span class="token punctuation">(</span>np_pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">of_node_put</span><span class="token punctuation">(</span>np_pctldev<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     * Call pinctrl driver to parse device tree node, and
     * generate mapping table entries
     */</span>
    ops <span class="token operator">=</span> pctldev<span class="token operator">-&gt;</span>desc<span class="token operator">-&gt;</span>pctlops<span class="token punctuation">;</span>
    <span class="token comment">//调用底层的callback函数处理pin configuration node</span>
    ret <span class="token operator">=</span> ops<span class="token operator">-&gt;</span><span class="token function">dt_node_to_map</span><span class="token punctuation">(</span>pctldev<span class="token punctuation">,</span> np_config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>map<span class="token punctuation">,</span> <span class="token operator">&amp;</span>num_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

    <span class="token comment">/* Stash the mapping table chunk away for later use */</span>
    <span class="token comment">//将该pin configuration node的mapping entry信息注册到系统中</span>
    <span class="token keyword">return</span> <span class="token function">dt_remember_or_free_map</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> statename<span class="token punctuation">,</span> pctldev<span class="token punctuation">,</span> map<span class="token punctuation">,</span> num_maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f4139e26835e9590bdd39297a4350fce/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SpringMVC详解及基本使用第一天</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5c4c6e0a3d2a13a0dd1975b3326bfe14/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在计算机上设置指定当拒绝用户访问文件或文件夹时要显示的自定义消息【Windows操作系统优化配置】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>