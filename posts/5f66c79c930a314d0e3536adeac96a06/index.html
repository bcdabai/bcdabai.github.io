<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>数据库之MHA高可用集群部署及故障切换 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="数据库之MHA高可用集群部署及故障切换" />
<meta property="og:description" content="目录 一、MHA概念
1、MHA 的组成
2、MHA 的特点
二、搭建MySQL&#43;MHA
1、修改mysql节点的主机名
2、修改三台MySQL服务器的主配置文件/etc/my.cnf，并创建命令软链接
3、配置MySQL一主两从
4、安装 MHA 软件
5、在所有服务器上配置无密码认证
6、在 manager 节点上配置 MHA
7、第一次配置需要在 Master 节点上手动开启虚拟IP
8、在 manager 节点上测试 ssh 无密码认证
9、在 manager 节点上测试 mysql 主从连接情况
10、在 manager 节点上启动 MHA
11、查看相关状态
三、故障模拟
1、故障模拟
2、故障修复步骤
在上篇的传统主从架构中存在着一些问题（例如：单点故障等），将在这篇的博客新增内容解决这些问题。
一、MHA概念 MHA（MasterHigh Availability）是一套优秀的MySQL高可用环境下故障切换和主从复制的软件。
MHA 的出现就是解决MySQL 单点的问题。
MySQL故障切换过程中，MHA能做到0-30秒内自动完成故障切换操作。
MHA能在故障切换的过程中最大程度上保证数据的一致性，以达到真正意义上的高可用。
MHA 的组成 MHA Node（数据节点）
MHA Node 运行在每台 MySQL 服务器上。
MHA Manager（管理节点）
MHA Manager 可以单独部署在一台独立的机器上，管理多个 master-slave 集群；也可以部署在一台 slave 节点上。
MHA Manager 会定时探测集群中的 master 节点。当 master 出现故障时，它可以自动将最新数据的 slave 提升为新的 master， 然后将所有其他的 slave 重新指向新的 master。整个故障转移过程对应用程序完全透明。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5f66c79c930a314d0e3536adeac96a06/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-25T14:56:30+08:00" />
<meta property="article:modified_time" content="2023-03-25T14:56:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">数据库之MHA高可用集群部署及故障切换</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="kdocs-document"> 
 <h4 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">目录</span></h4> 
 <p style="">一、MHA概念</p> 
 <p style="">1、MHA 的组成</p> 
 <p style="">2、MHA 的特点</p> 
 <p style="">二、搭建MySQL+MHA</p> 
 <p style="">1、修改mysql节点的主机名</p> 
 <p style="">2、修改三台MySQL服务器的主配置文件/etc/my.cnf，并创建命令软链接</p> 
 <p style="">3、配置MySQL一主两从</p> 
 <p style="">4、安装 MHA 软件</p> 
 <p style="">5、在所有服务器上配置无密码认证</p> 
 <p style="">6、在 manager 节点上配置 MHA</p> 
 <p style="">7、第一次配置需要在 Master 节点上手动开启虚拟IP</p> 
 <p style="">8、在 manager 节点上测试 ssh 无密码认证</p> 
 <p style="">9、在 manager 节点上测试 mysql 主从连接情况</p> 
 <p style="">10、在 manager 节点上启动 MHA</p> 
 <p style="">11、查看相关状态</p> 
 <p style="">三、故障模拟</p> 
 <p style="">1、故障模拟</p> 
 <p style="">2、故障修复步骤</p> 
 <p style="">在上篇的传统主从架构中存在着一些问题（例如：单点故障等），将在这篇的博客新增内容解决这些问题。</p> 
 <h2 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">一、MHA概念</span></h2> 
 <p style="">MHA（MasterHigh Availability）是一套优秀的MySQL高可用环境下故障切换和主从复制的软件。</p> 
 <p style="">MHA 的出现就是解决MySQL 单点的问题。</p> 
 <p style="">MySQL故障切换过程中，MHA能做到0-30秒内自动完成故障切换操作。</p> 
 <p style="">MHA能在故障切换的过程中最大程度上保证数据的一致性，以达到真正意义上的高可用。</p> 
 <ol start="1"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">MHA 的组成</span></h3></li></ol> 
 <p style="">MHA Node（数据节点）</p> 
 <p style="">MHA Node 运行在每台 MySQL 服务器上。</p> 
 <p style="">MHA Manager（管理节点）</p> 
 <p style="">MHA Manager 可以单独部署在一台独立的机器上，管理多个 master-slave 集群；也可以部署在一台 slave 节点上。</p> 
 <p style="">MHA Manager 会定时探测集群中的 master 节点。当 master 出现故障时，它可以自动将最新数据的 slave 提升为新的 master， 然后将所有其他的 slave 重新指向新的 master。整个故障转移过程对应用程序完全透明。</p> 
 <ol start="2"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">MHA 的特点</span></h3></li></ol> 
 <p style="">自动故障切换过程中，MHA试图从宕机的主服务器上保存二进制日志，最大程度的保证数据不丢失</p> 
 <p style="">使用半同步复制，可以大大降低数据丢失的风险，如果只有一个slave已经收到了最新的二进制日志，MHA可以将最新的二进制日志应用于其他所有的slave服务器上，因此可以保证所有节点的数据一致性</p> 
 <p style="">目前MHA支持一主多从架构，最少三台服务，即一主两从</p> 
 <h2 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">二、搭建MySQL+MHA</span></h2> 
 <p style="text-align:null;">安装mysql数据库：<a class="kdocs-link" style="color:#0A6CFF;" href="https://blog.csdn.net/weixin_51326240/article/details/113427630" target="_blank" rel="noopener noreferrer">shell脚本之编辑安装MySQL</a></p> 
 <p style="text-align:null;">mha4mysql-manager-0.57.tar.gz</p> 
 <p style="text-align:null;">mha4mysql-node-0.57.tar.gz</p> 
 <p style="text-align:null;">链接：<a class="kdocs-link" style="color:#0A6CFF;" href="https://pan.baidu.com/s/1msCqvoPR8bmRLrrsQzz1Mw" rel="nofollow noopener noreferrer" target="_blank">相关安装包</a></p> 
 <p style="text-align:null;">提取码：1234</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:55.67568%;height:0;"> 
    <img src="https://images2.imgbox.com/1c/72/1IkotIqp_o.png" style="margin-left:;display:block;width:740px;margin-top:-55.67568%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="text-align:null;"><span class="kdocs-bold" style="font-weight:bold;">实验思路</span></p> 
 <p style="text-align:null;">1、MHA架构</p> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>数据库安装</p></li></ul> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>一主两从</p></li></ul> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>MHA搭建</p></li></ul> 
 <p style="text-align:null;">2、故障模拟</p> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>模拟主库失效</p></li></ul> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>备选主库成为主库</p></li></ul> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>原故障主库恢复重新加入到MHA成为从库</p></li></ul> 
 <p style="text-align:null;"><span class="kdocs-bold" style="font-weight:bold;">实验准备</span></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1321px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:20.893263%;height:0;"> 
    <img src="https://images2.imgbox.com/23/55/gp5FR7jI_o.png" style="margin-left:;display:block;width:1321px;margin-top:-20.893263%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>现在三台mysql主机上安装mysql,可以使用上面链接中的脚本安装</p></li></ul> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>关闭防火墙和安全机制</p></li></ul> 
 <p style="">systemctl stop firewalld</p> 
 <p style="">systemctl disable firewalld</p> 
 <p style="">setenforce 0</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:20.27027%;height:0;"> 
    <img src="https://images2.imgbox.com/6c/be/g1XtySDx_o.png" style="margin-left:;display:block;width:740px;margin-top:-20.27027%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:17.567568%;height:0;"> 
    <img src="https://images2.imgbox.com/b4/62/p7pCvqMw_o.png" style="margin-left:;display:block;width:740px;margin-top:-17.567568%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ol start="1"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">修改mysql节点的</span><a class="kdocs-link" style="color:#0A6CFF;" href="https://so.csdn.net/so/search?q=%E4%B8%BB%E6%9C%BA%E5%90%8D&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer"><span class="kdocs-bold" style="font-weight:bold;">主机名</span></a></h3></li></ol> 
 <p style="text-align:null;">mysql1（192.168.163.11）</p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">hostnamectl set-hostname mysql1
su -</code></pre> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:14.324325%;height:0;"> 
    <img src="https://images2.imgbox.com/35/d5/DKx5Mwul_o.png" style="margin-left:;display:block;width:740px;margin-top:-14.324325%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="text-align:null;">mysql2（192.168.163.12）</p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">hostnamectl set-hostname mysql2
su -</code></pre> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:15.540541%;height:0;"> 
    <img src="https://images2.imgbox.com/72/dc/DTB746SE_o.png" style="margin-left:;display:block;width:740px;margin-top:-15.540541%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ol start="2"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">修改三台MySQL服务器的主配置文件/etc/my.cnf，并创建命令软链接</span></h3></li></ol> 
 <p style="">mysql1（192.168.163.11）</p> 
 <p style=""></p> 
 <p style="">vim /etc/my.cnf</p> 
 <p style="">[mysqld]</p> 
 <p style="">server-id = 11</p> 
 <p style="">log_bin = master-bin</p> 
 <p style="">log-slave-updates = true</p> 
 <p style=""></p> 
 <p style="">systemctl restart mysqld</p> 
 <p style=""></p> 
 <p style="">ln -s /usr/local/mysql/bin/mysql /usr/sbin/</p> 
 <p style="">ln -s /usr/local/mysql/bin/mysqlbinlog /usr/sbin/</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:710px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:84.50705%;height:0;"> 
    <img src="https://images2.imgbox.com/55/8b/bUSoNeaB_o.png" style="margin-left:;display:block;width:710px;margin-top:-84.50705%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="">mysql2（192.168.163.12）</p> 
 <p style="">mysql3（192.168.163.13）</p> 
 <p style="">vim /etc/my.cnf</p> 
 <p style="">server-id = 12 </p> 
 <p style="">#server-id = 13 mysql3则为13，三台服务器 server-id 不能一样</p> 
 <p style="">log_bin = master-bin</p> 
 <p style="">relay-log = relay-log-bin</p> 
 <p style="">relay-log-index = slave-relay-bin.index</p> 
 <p style=""></p> 
 <p style="">systemctl restart mysqld</p> 
 <p style=""></p> 
 <p style="">ln -s /usr/local/mysql/bin/mysql /usr/sbin/</p> 
 <p style="">ln -s /usr/local/mysql/bin/mysqlbinlog /usr/sbin/</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:695px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:85.899284%;height:0;"> 
    <img src="https://images2.imgbox.com/d6/46/cHTvAh1s_o.png" style="margin-left:;display:block;width:695px;margin-top:-85.899284%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ol start="3"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">配置MySQL一主两从</span></h3></li></ol> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（1）所有MySQL服务器进行MySQL授权</span></p> 
 <p style="">mysql1（192.168.163.11）</p> 
 <p style="">mysql2（192.168.163.12）</p> 
 <p style="">mysql3（192.168.163.13）</p> 
 <p style="">mysql -uroot -p123456</p> 
 <p style="">grant replication slave on *.* to 'myslave'@'192.168.163.%' identified by '123456';</p> 
 <p style="">grant all privileges on *.* to 'mha'@'192.168.163.%' identified by 'manager';</p> 
 <p style="">grant all privileges on *.* to 'mha'@'mysql1' identified by 'manager';</p> 
 <p style="">grant all privileges on *.* to 'mha'@'mysql2' identified by 'manager';</p> 
 <p style="">grant all privileges on *.* to 'mha'@'mysql3' identified by 'manager';</p> 
 <p style="">flush privileges;</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:695px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:86.474815%;height:0;"> 
    <img src="https://images2.imgbox.com/95/7e/9FHhHtoD_o.png" style="margin-left:;display:block;width:695px;margin-top:-86.474815%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（2）在Master节点查看二进制文件和同步点</span></p> 
 <p style="">mysql1（192.168.163.11）</p> 
 <p style="">show master status;</p> 
 <p style="">#每个人的二进制文件名或者偏移量都可能不一样，记住自己的</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:22.297297%;height:0;"> 
    <img src="https://images2.imgbox.com/48/64/dB2LBEeQ_o.png" style="margin-left:;display:block;width:740px;margin-top:-22.297297%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（3）在 Slave1、Slave2 节点执行同步操作</span></p> 
 <p style="">mysql2（192.168.163.12）</p> 
 <p style="">mysql3（192.168.163.13）</p> 
 <p style="">change master to master_host='192.168.163.11',master_user='myslave',master_password='123456',master_log_file='master-bin.000001',master_log_pos=1747;</p> 
 <p style=""></p> 
 <p style="">start slave;</p> 
 <p style=""></p> 
 <p style="">show slave status\G</p> 
 <p style="">Slave_IO_Running: Yes</p> 
 <p style="">Slave_SQL_Running: Yes</p> 
 <p style=""></p> 
 <p style="">#一般 Slave_IO_Running: No 的可能性：</p> 
 <p style="">#网络不通</p> 
 <p style="">#my.cnf配置有问题</p> 
 <p style="">#密码、file文件名、pos偏移量不对</p> 
 <p style="">#防火墙没有关闭</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:64.86487%;height:0;"> 
    <img src="https://images2.imgbox.com/df/4c/ZLDN349C_o.png" style="margin-left:;display:block;width:740px;margin-top:-64.86487%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（4）Slave1、Slave2 节点设置为只读模式</span></p> 
 <p style="">mysql2（192.168.163.12）</p> 
 <p style="">mysql3（192.168.163.13）</p> 
 <p style="">set global read_only=1;</p> 
 <p style="">#改回读写状态set global read_only=0;</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:15.135135%;height:0;"> 
    <img src="https://images2.imgbox.com/ad/3e/AxaL8SkD_o.png" style="margin-left:;display:block;width:740px;margin-top:-15.135135%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（5）主从复制验证</span></p> 
 <p style="">mysql1（192.168.163.11）</p> 
 <p style="">创建库</p> 
 <p style="">create database test;</p> 
 <p style="">use test;</p> 
 <p style="">create table test(id int);</p> 
 <p style="">insert into test values(1);</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:562px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:106.40569%;height:0;"> 
    <img src="https://images2.imgbox.com/64/a4/xgzRkS1u_o.png" style="margin-left:;display:block;width:562px;margin-top:-106.40569%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="">mysql2（192.168.163.12）</p> 
 <p style="">mysql3（192.168.163.13）</p> 
 <p style="">查询库验证</p> 
 <p style="">show databases;</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:33.91892%;height:0;"> 
    <img src="https://images2.imgbox.com/62/87/69juZhyu_o.png" style="margin-left:;display:block;width:740px;margin-top:-33.91892%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ol start="4"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">安装 MHA 软件</span></h3></li></ol> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（1）所有服务器上都安装 MHA 依赖的环境</span></p> 
 <p style="">MHAmanager（192.168.163.10）</p> 
 <p style="">mysql1（192.168.163.11）</p> 
 <p style="">mysql2（192.168.163.12）</p> 
 <p style="">mysql3（192.168.163.13）</p> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>首先安装 epel 源，需要在线源安装</p></li></ul> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>再在所有服务器上安装 node 组件</p></li></ul> 
 <p style="">#安装在线源</p> 
 <p style="">mv /etc/yum.repos.d/repos.bak/CentOS-* /etc/yum.repos.d/</p> 
 <p style="">yum list</p> 
 <p style=""></p> 
 <p style="">yum install epel-release --nogpgcheck -y</p> 
 <p style=""></p> 
 <p style="">yum install -y perl-DBD-MySQL \</p> 
 <p style="">perl-Config-Tiny \</p> 
 <p style="">perl-Log-Dispatch \</p> 
 <p style="">perl-Parallel-ForkManager \</p> 
 <p style="">perl-ExtUtils-CBuilder \</p> 
 <p style="">perl-ExtUtils-MakeMaker \</p> 
 <p style="">perl-CPAN</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:680px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:88.088234%;height:0;"> 
    <img src="https://images2.imgbox.com/e1/78/Ath7yQTX_o.png" style="margin-left:;display:block;width:680px;margin-top:-88.088234%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（2）安装MHA node软件包</span></p> 
 <p style="">MHAmanager（192.168.163.10）</p> 
 <p style="">mysql1（192.168.163.11）</p> 
 <p style="">mysql2（192.168.163.12）</p> 
 <p style="">mysql3（192.168.163.13）</p> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>对于每个操作系统版本不一样，这里 CentOS7.4 必须选择 0.57 版本。</p></li></ul> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>在所有服务器上必须先安装 node 组件，最后在 MHA-manager 节点上安装 manager 组件，因为 manager 依赖 node 组件。</p></li></ul> 
 <p style="">#将软件包mha4mysql-node-0.57.tar.gz放入/opt目录下</p> 
 <p style="">cd /opt</p> 
 <p style="">tar zxvf mha4mysql-node-0.57.tar.gz</p> 
 <p style="">cd mha4mysql-node-0.57</p> 
 <p style="">perl Makefile.PL</p> 
 <p style="">make &amp;&amp; make install</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:525px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:113.333336%;height:0;"> 
    <img src="https://images2.imgbox.com/f3/06/HVPxGUmF_o.png" style="margin-left:;display:block;width:525px;margin-top:-113.333336%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（3）在 MHA manager 节点上安装 manager 组件</span></p> 
 <p style="">MHAmanager（192.168.163.10）</p> 
 <p style="">#将软件包mha4mysql-manager-0.57.tar.gz放入/opt目录下</p> 
 <p style="">cd /opt</p> 
 <p style="">tar zxvf mha4mysql-manager-0.57.tar.gz</p> 
 <p style="">cd mha4mysql-manager-0.57</p> 
 <p style="">perl Makefile.PL</p> 
 <p style="">make &amp;&amp; make install</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:540px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:110.55556%;height:0;"> 
    <img src="https://images2.imgbox.com/1a/c2/zv96iSrz_o.png" style="margin-left:;display:block;width:540px;margin-top:-110.55556%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="">manager 组件安装后在/usr/local/bin 下面会生成几个工具</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:30.945946%;height:0;"> 
    <img src="https://images2.imgbox.com/7c/39/qpFbgxSM_o.png" style="margin-left:;display:block;width:740px;margin-top:-30.945946%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="">主要包括以下几个：</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1319px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:36.618652%;height:0;"> 
    <img src="https://images2.imgbox.com/49/ad/qaXK9RAM_o.png" style="margin-left:;display:block;width:1319px;margin-top:-36.618652%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="">node 组件安装后也会在/usr/local/bin 下面会生成几个脚本（这些工具通常由 MHAManager 的脚本触发，无需人为操作）</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:42.2973%;height:0;"> 
    <img src="https://images2.imgbox.com/29/04/8nUxCDJu_o.png" style="margin-left:;display:block;width:740px;margin-top:-42.2973%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1342px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:24.590164%;height:0;"> 
    <img src="https://images2.imgbox.com/33/20/06q3O2GD_o.png" style="margin-left:;display:block;width:1342px;margin-top:-24.590164%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ol start="5"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">在所有服务器上配置无密码认证</span></h3></li></ol> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（1）在 manager 节点上配置到所有数据库节点的无密码认证</span></p> 
 <p style="">MHAmanager（192.168.163.10）</p> 
 <p style="">ssh-keygen -t rsa #一路按回车键</p> 
 <p style="">ssh-copy-id 192.168.163.11</p> 
 <p style="">ssh-copy-id 192.168.163.12</p> 
 <p style="">ssh-copy-id 192.168.163.13</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:532px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:112.21805%;height:0;"> 
    <img src="https://images2.imgbox.com/67/18/F7CsNjm4_o.png" style="margin-left:;display:block;width:532px;margin-top:-112.21805%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>三台mysql服务器一样，太占篇幅，就不贴图了。</p></li></ul> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（2）在 mysql1 上配置到数据库节点 mysql2 和 mysql3 的无密码认证 ssh-keygen -t rsa</span></p> 
 <p style="text-align:null;">mysql1（192.168.163.11）</p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">ssh-keygen -t rsa
ssh-copy-id 192.168.163.12
ssh-copy-id 192.168.163.13</code></pre> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（3）在 mysql2 上配置到数据库节点 mysql1 和 mysql3 的无密码认证</span></p> 
 <p style="text-align:null;">mysql2（192.168.163.12）</p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">ssh-keygen -t rsa
ssh-copy-id 192.168.163.11
ssh-copy-id 192.168.163.13</code></pre> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（4）在 mysql3 上配置到数据库节点 mysql1 和 mysql2 的无密码认证</span></p> 
 <p style="text-align:null;">mysql3（192.168.163.13）</p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">ssh-keygen -t rsa
ssh-copy-id 192.168.163.11
ssh-copy-id 192.168.163.12</code></pre> 
 <ol start="6"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">在 manager 节点上配置 MHA</span></h3></li></ol> 
 <p style="">MHAmanager（192.168.163.10）</p> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（1）在 manager 节点上复制相关脚本到/usr/local/bin 目录</span></p> 
 <p style="">cp -rp /opt/mha4mysql-manager-0.57/samples/scripts /usr/local/bin</p> 
 <p style=""></p> 
 <p style="">#复制后会有四个执行文件</p> 
 <p style="">ll /usr/local/bin/scripts/</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:24.594593%;height:0;"> 
    <img src="https://images2.imgbox.com/a7/19/mrLOy3Ut_o.png" style="margin-left:;display:block;width:740px;margin-top:-24.594593%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:1319px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:20.621683%;height:0;"> 
    <img src="https://images2.imgbox.com/c4/fd/VMIZAbyE_o.png" style="margin-left:;display:block;width:1319px;margin-top:-20.621683%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（2）复制上述的自动切换时 VIP 管理的脚本到 /usr/local/bin 目录，这里使用master_ip_failover脚本来管理 VIP 和故障切换</span></p> 
 <p style="">cp /usr/local/bin/scripts/master_ip_failover /usr/local/bin</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:18.918919%;height:0;"> 
    <img src="https://images2.imgbox.com/bb/6e/DYNKcmhD_o.png" style="margin-left:;display:block;width:740px;margin-top:-18.918919%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="">#先清空原有内容</p> 
 <p style="">echo '' &gt; /usr/local/bin/master_ip_failover</p> 
 <p style=""></p> 
 <p style="">#直接复制并修改vip相关参数</p> 
 <p style="">vim /usr/local/bin/master_ip_failover</p> 
 <p style="">#!/usr/bin/env perl</p> 
 <p style="">use strict;</p> 
 <p style="">use warnings FATAL =&gt; 'all';</p> 
 <p style=""></p> 
 <p style="">use Getopt::Long;</p> 
 <p style=""></p> 
 <p style="">my (</p> 
 <p style="">$command, $ssh_user, $orig_master_host, $orig_master_ip,</p> 
 <p style="">$orig_master_port, $new_master_host, $new_master_ip, $new_master_port</p> 
 <p style="">);</p> 
 <p style="">#############################添加内容部分#########################################</p> 
 <p style="">my $vip = '192.168.163.200';#指定vip的地址</p> 
 <p style="">my $brdc = '192.168.163.255';#指定vip的广播地址</p> 
 <p style="">my $ifdev = 'ens33';#指定vip绑定的网卡</p> 
 <p style="">my $key = '1';#指定vip绑定的虚拟网卡序列号</p> 
 <p style="">my $ssh_start_vip = "/sbin/ifconfig ens33:$key $vip";#代表此变量值为ifconfig ens33:1 192.168.163.200</p> 
 <p style="">my $ssh_stop_vip = "/sbin/ifconfig ens33:$key down";#代表此变量值为ifconfig ens33:1 down</p> 
 <p style="">my $exit_code = 0;#指定退出状态码为0</p> 
 <p style="">#my $ssh_start_vip = "/usr/sbin/ip addr add $vip/24 brd $brdc dev $ifdev label $ifdev:$key;/usr/sbin/arping -q -A -c 1 -I $ifdev $vip;iptables -F;";</p> 
 <p style="">#my $ssh_stop_vip = "/usr/sbin/ip addr del $vip/24 dev $ifdev label $ifdev:$key";</p> 
 <p style="">##################################################################################</p> 
 <p style="">GetOptions(</p> 
 <p style="">'command=s' =&gt; \$command,</p> 
 <p style="">'ssh_user=s' =&gt; \$ssh_user,</p> 
 <p style="">'orig_master_host=s' =&gt; \$orig_master_host,</p> 
 <p style="">'orig_master_ip=s' =&gt; \$orig_master_ip,</p> 
 <p style="">'orig_master_port=i' =&gt; \$orig_master_port,</p> 
 <p style="">'new_master_host=s' =&gt; \$new_master_host,</p> 
 <p style="">'new_master_ip=s' =&gt; \$new_master_ip,</p> 
 <p style="">'new_master_port=i' =&gt; \$new_master_port,</p> 
 <p style="">);</p> 
 <p style=""></p> 
 <p style="">exit &amp;main();</p> 
 <p style=""></p> 
 <p style="">sub main {<!-- --></p> 
 <p style=""></p> 
 <p style="">print "\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n";</p> 
 <p style=""></p> 
 <p style="">if ( $command eq "stop" || $command eq "stopssh" ) {<!-- --></p> 
 <p style=""></p> 
 <p style="">my $exit_code = 1;</p> 
 <p style="">eval {<!-- --></p> 
 <p style="">print "Disabling the VIP on old master: $orig_master_host \n";</p> 
 <p style="">&amp;stop_vip();</p> 
 <p style="">$exit_code = 0;</p> 
 <p style="">};</p> 
 <p style="">if ($@) {<!-- --></p> 
 <p style="">warn "Got Error: $@\n";</p> 
 <p style="">exit $exit_code;</p> 
 <p style="">}</p> 
 <p style="">exit $exit_code;</p> 
 <p style="">}</p> 
 <p style="">elsif ( $command eq "start" ) {<!-- --></p> 
 <p style=""></p> 
 <p style="">my $exit_code = 10;</p> 
 <p style="">eval {<!-- --></p> 
 <p style="">print "Enabling the VIP - $vip on the new master - $new_master_host \n";</p> 
 <p style="">&amp;start_vip();</p> 
 <p style="">$exit_code = 0;</p> 
 <p style="">};</p> 
 <p style="">if ($@) {<!-- --></p> 
 <p style="">warn $@;</p> 
 <p style="">exit $exit_code;</p> 
 <p style="">}</p> 
 <p style="">exit $exit_code;</p> 
 <p style="">}</p> 
 <p style="">elsif ( $command eq "status" ) {<!-- --></p> 
 <p style="">print "Checking the Status of the script.. OK \n";</p> 
 <p style="">exit 0;</p> 
 <p style="">}</p> 
 <p style="">else {<!-- --></p> 
 <p style="">&amp;usage();</p> 
 <p style="">exit 1;</p> 
 <p style="">}</p> 
 <p style="">}</p> 
 <p style="">sub start_vip() {<!-- --></p> 
 <p style="">`ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`;</p> 
 <p style="">}</p> 
 <p style="">## A simple system call that disable the VIP on the old_master</p> 
 <p style="">sub stop_vip() {<!-- --></p> 
 <p style="">`ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`;</p> 
 <p style="">}</p> 
 <p style=""></p> 
 <p style="">sub usage {<!-- --></p> 
 <p style="">print</p> 
 <p style="">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n";</p> 
 <p style="">}</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:666px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:89.63963%;height:0;"> 
    <img src="https://images2.imgbox.com/84/2b/gLaQciry_o.png" style="margin-left:;display:block;width:666px;margin-top:-89.63963%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（3）创建 MHA 软件目录并拷贝配置文件，这里使用app1.cnf配置文件来管理 mysql 节点服务器</span></p> 
 <p style="">mkdir /etc/masterha</p> 
 <p style="">cp /opt/mha4mysql-manager-0.57/samples/conf/app1.cnf /etc/masterha</p> 
 <p style=""></p> 
 <p style="">vim /etc/masterha/app1.cnf</p> 
 <p style="">[server default]</p> 
 <p style="">manager_log=/var/log/masterha/app1/manager.log</p> 
 <p style="">manager_workdir=/var/log/masterha/app1</p> 
 <p style="">master_binlog_dir=/usr/local/mysql/data</p> 
 <p style="">master_ip_failover_script=/usr/local/bin/master_ip_failover</p> 
 <p style="">master_ip_online_change_script=/usr/local/bin/master_ip_online_change</p> 
 <p style="">user=mha</p> 
 <p style="">password=manager</p> 
 <p style="">ping_interval=1</p> 
 <p style="">remote_workdir=/tmp</p> 
 <p style="">repl_user=myslave</p> 
 <p style="">repl_password=123456</p> 
 <p style="">secondary_check_script=/usr/local/bin/masterha_secondary_check -s 192.168.163.12 -s 192.168.163.13</p> 
 <p style="">shutdown_script=""</p> 
 <p style="">ssh_user=root</p> 
 <p style=""></p> 
 <p style="">[server1]</p> 
 <p style="">hostname=192.168.163.11</p> 
 <p style="">port=3306</p> 
 <p style=""></p> 
 <p style="">[server2]</p> 
 <p style="">candidate_master=1</p> 
 <p style="">check_repl_delay=0</p> 
 <p style="">hostname=192.168.163.12</p> 
 <p style="">port=3306</p> 
 <p style=""></p> 
 <p style="">[server3]</p> 
 <p style="">hostname=192.168.163.13</p> 
 <p style="">port=3306</p> 
 <p style=""></p> 
 <p style="">#--------------------------配置文件解释--------------------------------------------------------------------------</p> 
 <p style="">[server default]</p> 
 <p style="">manager_log=/var/log/masterha/app1/manager.log　　　 #manager日志</p> 
 <p style="">manager_workdir=/var/log/masterha/app1.log　　　　#manager工作目录</p> 
 <p style="">master_binlog_dir=/usr/local/mysql/data/　　　　　　　#master保存binlog的位置，这里的路径要与master里配置的binlog的路径一致，以便MHA能找到</p> 
 <p style="">master_ip_failover_script=/usr/local/bin/master_ip_failover　 　#设置自动failover时候的切换脚本，也就是上面的那个脚本</p> 
 <p style="">master_ip_online_change_script=/usr/local/bin/master_ip_online_change　　#设置手动切换时候的切换脚本</p> 
 <p style="">user=mha#设置监控用户root</p> 
 <p style="">password=manager#设置mysql中root用户的密码，这个密码是前文中创建监控用户的那个密码</p> 
 <p style="">ping_interval=1#设置监控主库，发送ping包的时间间隔1秒，默认是3秒，尝试三次没有回应的时候自动进行failover</p> 
 <p style="">remote_workdir=/tmp#设置远端mysql在发生切换时binlog的保存位置</p> 
 <p style="">repl_user=myslave#设置复制用户的用户</p> 
 <p style="">repl_password=123456#设置复制用户的密码</p> 
 <p style="">report_script=/usr/local/send_report　　#设置发生切换后发送的报警的脚本</p> 
 <p style="">secondary_check_script=/usr/local/bin/masterha_secondary_check -s 192.168.163.12 -s 192.168.163.13#指定检查的从服务器IP地址</p> 
 <p style="">shutdown_script=""#设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机防止发生脑裂,这里没有使用）</p> 
 <p style="">ssh_user=root#设置ssh的登录用户名</p> 
 <p style=""></p> 
 <p style="">[server1]</p> 
 <p style="">hostname=192.168.163.11</p> 
 <p style="">port=3306</p> 
 <p style=""></p> 
 <p style="">[server2]</p> 
 <p style="">hostname=192.168.163.12</p> 
 <p style="">port=3306</p> 
 <p style="">candidate_master=1</p> 
 <p style="">#设置为候选master，设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集群中最新的slave</p> 
 <p style="">check_repl_delay=0</p> 
 <p style="">#默认情况下如果一个slave落后master 超过100M的relay logs的话，MHA将不会选择该slave作为一个新的master， 因为对于这个slave的恢复需要花费很长时间；通过设置check_repl_delay=0，MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=1的主机非常有用，因为这个候选主在切换的过程中一定是新的master</p> 
 <p style=""></p> 
 <p style="">[server3]</p> 
 <p style="">hostname=192.168.163.13</p> 
 <p style="">port=3306</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:636px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:94.18239%;height:0;"> 
    <img src="https://images2.imgbox.com/45/c7/Q5SRsXpt_o.png" style="margin-left:;display:block;width:636px;margin-top:-94.18239%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ol start="7"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">第一次配置需要在 Master 节点上手动开启虚拟IP</span></h3></li></ol> 
 <p style="">Master（192.168.163.11）</p> 
 <p style="">/sbin/ifconfig ens33:1 192.168.163.200/24</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:710px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:84.50705%;height:0;"> 
    <img src="https://images2.imgbox.com/c3/78/fShrtPOv_o.png" style="margin-left:;display:block;width:710px;margin-top:-84.50705%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ol start="8"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">在 manager 节点上测试 </span><a class="kdocs-link" style="color:#0A6CFF;" href="https://so.csdn.net/so/search?q=ssh&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer"><span class="kdocs-bold" style="font-weight:bold;">ssh</span></a><span class="kdocs-bold" style="font-weight:bold;"> 无密码认证</span></h3></li></ol> 
 <p style="">MHAmanager（192.168.163.10）</p> 
 <p style="">masterha_check_ssh -conf=/etc/masterha/app1.cnf</p> 
 <p style="">#如果正常最后会输出 successfully；</p> 
 <p style="">#如果失败可以去配置服务器无密码认证的地方看看有没有问题</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:732px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:81.55738%;height:0;"> 
    <img src="https://images2.imgbox.com/f8/dd/4ocVXNfX_o.png" style="margin-left:;display:block;width:732px;margin-top:-81.55738%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ol start="9"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">在 manager 节点上测试 mysql 主从连接情况</span></h3></li></ol> 
 <p style="">MHAmanager（192.168.163.10）</p> 
 <p style="">masterha_check_repl -conf=/etc/masterha/app1.cnf</p> 
 <p style="">#最后出现 MySQL Replication Health is OK 字样说明正常；</p> 
 <p style="">#出现MySQL Replication Health is NOT OK!的，可以去看一下mysql服务器上的软链接是否少创建--&gt;本文位置：2、修改三台MySQL服务器的主配置文件/etc/my.cnf，并创建命令软链接</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:68.10811%;height:0;"> 
    <img src="https://images2.imgbox.com/2e/99/zw0BNzn9_o.png" style="margin-left:;display:block;width:740px;margin-top:-68.10811%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""></p> 
 <ol start="10"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">在 manager 节点上启动 MHA</span></h3></li></ol> 
 <p style="">MHAmanager（192.168.163.10）</p> 
 <p style="">nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /var/log/masterha/app1/manager.log 2&gt;&amp;1 &amp;</p> 
 <p style=""></p> 
 <p style=""></p> 
 <p style="">#------------------------组件解释----------------------------------------------------------------------------------</p> 
 <p style="">--remove_dead_master_conf：该参数代表当发生主从切换后，老的主库的 ip 将会从配置文件中移除。</p> 
 <p style="">--manger_log：日志存放位置。</p> 
 <p style="">--ignore_last_failover：在缺省情况下，如果 MHA 检测到连续发生宕机，且两次宕机间隔不足 8 小时的话，则不会进行 Failover， 之所以这样限制是为了避免 ping-pong 效应。该参数代表忽略上次 MHA 触发切换产生的文件，默认情况下，MHA 发生切换后会在日志记目录，也就是上面设置的日志app1.failover.complete文件，下次再次切换的时候如果发现该目录下存在该文件将不允许触发切换，除非在第一次切换后收到删除该文件，为了方便，这里设置为--ignore_last_failover。</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:15.810811%;height:0;"> 
    <img src="https://images2.imgbox.com/9b/6b/Pe6KHeI6_o.png" style="margin-left:;display:block;width:740px;margin-top:-15.810811%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ol start="11"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">查看相关状态</span></h3></li></ol> 
 <p style="">MHAmanager（192.168.163.10）</p> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>查看 MHA 状态，可以看到当前的 master 是 Mysql1 节点。</p></li></ul> 
 <p style="">masterha_check_status --conf=/etc/masterha/app1.cnf</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:14.72973%;height:0;"> 
    <img src="https://images2.imgbox.com/5f/6d/QzNTTgQa_o.png" style="margin-left:;display:block;width:740px;margin-top:-14.72973%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="">MHAmanager（192.168.163.10）</p> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>查看 MHA 日志，也以看到当前的 master 是 192.168.163.11</p></li></ul> 
 <p style="">cat /var/log/masterha/app1/manager.log | grep "current master"</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:20.27027%;height:0;"> 
    <img src="https://images2.imgbox.com/17/79/XYHw8uJA_o.png" style="margin-left:;display:block;width:740px;margin-top:-20.27027%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="">mysql1（192.168.163.11）</p> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>查看 Mysql1 的 VIP 地址，查看 Mysql1 的 VIP 地址 192.168.163.200 是否存在，这个 VIP 地址不会因为 manager 节点停止 MHA 服务而消失。</p></li></ul> 
 <p style="">ifconfig</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:695px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:86.18705%;height:0;"> 
    <img src="https://images2.imgbox.com/65/91/PRbtqX5U_o.png" style="margin-left:;display:block;width:695px;margin-top:-86.18705%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">补充：若要关闭 manager 服务，可以使用如下命令。</span></p> 
 <p style="">masterha_stop --conf=/etc/masterha/app1.cnf</p> 
 <p style="">或者可以直接采用 kill 进程 ID 的方式关闭。</p> 
 <p style=""></p> 
 <h2 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">三、故障模拟</span></h2> 
 <ol start="1"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">故障模拟</span></h3></li></ol> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（1）在 manager 节点上监控观察日志记录</span></p> 
 <p style="">MHAmanager（192.168.163.10）</p> 
 <p style="">tail -f /var/log/masterha/app1/manager.log</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:61.216217%;height:0;"> 
    <img src="https://images2.imgbox.com/64/c3/PRBdkRRU_o.png" style="margin-left:;display:block;width:740px;margin-top:-61.216217%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（2）在 Master 节点 Mysql1 上停止mysql服务</span></p> 
 <p style="">mysql1（192.168.163.11）</p> 
 <p style="">systemctl stop mysqld</p> 
 <p style="">或</p> 
 <p style="">pkill -9 mysql</p> 
 <p style=""></p> 
 <p style="">正常自动切换一次后，MHA 进程会退出。HMA 会自动修改 app1.cnf 文件内容，将宕机的 mysql1 节点删除。</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:77.432434%;height:0;"> 
    <img src="https://images2.imgbox.com/e7/bd/b9bm6V55_o.png" style="margin-left:;display:block;width:740px;margin-top:-77.432434%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（3）查看 mysql2 是否接管 VIP</span></p> 
 <p style="">mysql2（192.168.163.12）</p> 
 <p style="">ifconfig</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:59.324326%;height:0;"> 
    <img src="https://images2.imgbox.com/d4/48/W5vIc1ya_o.png" style="margin-left:;display:block;width:740px;margin-top:-59.324326%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（4）回到manager 节点上监控观察日志记录</span></p> 
 <p style="">MHAmanager（192.168.163.10）</p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:688px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:86.9186%;height:0;"> 
    <img src="https://images2.imgbox.com/48/eb/iY7hhYW2_o.png" style="margin-left:;display:block;width:688px;margin-top:-86.9186%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style="">故障切换备选主库的算法：</p> 
 <p style="">1、一般判断从库的是从（position/GTID）判断优劣，数据有差异，最接近于master的slave，成为备选主。</p> 
 <p style="">2、数据一致的情况下，按照配置文件顺序，选择备选主库。</p> 
 <p style="">3、设定有权重（candidate_master=1），按照权重强制指定备选主。</p> 
 <p style="">（1）默认情况下如果一个slave落后master 100M的relay logs的话，即使有权重，也会失效。</p> 
 <p style="">（2）如果check_repl_delay=0的话，即使落后很多日志，也强制选择其为备选主。</p> 
 <ol start="2"><li style="margin-left:1.4em;list-style-type:decimal;text-indent:0;text-align:left;"><h3><span class="kdocs-bold" style="font-weight:bold;">故障修复步骤</span></h3></li></ol> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（1）修复mysql</span></p> 
 <p style="">mysql1（192.168.163.11）</p> 
 <p style="">systemctl restart mysqld</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:22.027027%;height:0;"> 
    <img src="https://images2.imgbox.com/c3/ce/vLvrVTPf_o.png" style="margin-left:;display:block;width:740px;margin-top:-22.027027%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（2）修复主从</span></p> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>在现主库服务器 Mysql2 查看二进制文件和同步点<br>mysql2（192.168.163.12）</p></li></ul> 
 <p style="">mysql -uroot -p123456 -e 'show master status;'</p> 
 <p style="">#在数据库中执行show master status;</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:28.513514%;height:0;"> 
    <img src="https://images2.imgbox.com/ac/55/92G8PGXl_o.png" style="margin-left:;display:block;width:740px;margin-top:-28.513514%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>在原主库服务器 mysql1 执行同步操作<br>mysql1（192.168.163.11）</p></li></ul> 
 <p style="">change master to master_host='192.168.163.12',master_user='myslave',master_password='123456',master_log_file='master-bin.000001',master_log_pos=1747;</p> 
 <p style=""></p> 
 <p style="">start slave;</p> 
 <p style="">show slave status\G</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:621px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:96.13527%;height:0;"> 
    <img src="https://images2.imgbox.com/71/33/2tGEElyK_o.png" style="margin-left:;display:block;width:621px;margin-top:-96.13527%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（3）在 manager 节点上修改配置文件app1.cnf</span></p> 
 <p style="text-align:null;">MHAmanager（192.168.163.10）</p> 
 <ul><li style="margin-left:1.4em;list-style-type:disc;text-indent:0;"><p>再把这个记录添加进去，因为它检测掉失效时候会自动消失</p></li></ul> 
 <p style="">vim /etc/masterha/app1.cnf</p> 
 <p style="">……</p> 
 <p style="">secondary_check_script=/usr/local/bin/masterha_secondary_check -s 192.168.163.11 -s 192.168.163.13</p> 
 <p style="">......</p> 
 <p style="">[server1]</p> 
 <p style="">hostname=192.168.163.12</p> 
 <p style="">port=3306</p> 
 <p style=""></p> 
 <p style="">[server2]</p> 
 <p style="">candidate_master=1</p> 
 <p style="">check_repl_delay=0</p> 
 <p style="">hostname=192.168.163.11</p> 
 <p style="">port=3306</p> 
 <p style=""></p> 
 <p style="">[server3]</p> 
 <p style="">hostname=192.168.163.13</p> 
 <p style="">port=3306</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:80.540535%;height:0;"> 
    <img src="https://images2.imgbox.com/a6/ff/5AeiXIg4_o.png" style="margin-left:;display:block;width:740px;margin-top:-80.540535%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""><span class="kdocs-bold" style="font-weight:bold;">（4）在 manager 节点上启动 MHA</span></p> 
 <p style="">MHAmanager（192.168.163.10）</p> 
 <p style="">masterha_stop --conf=/etc/masterha/app1.cnf</p> 
 <p style=""></p> 
 <p style="">nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /var/log/masterha/app1/manager.log 2&gt;&amp;1 &amp;</p> 
 <p style=""></p> 
 <p style="">masterha_check_status --conf=/etc/masterha/app1.cnf</p> 
 <p style=""></p> 
 <div class="kdocs-line-container" style="display:flex;"> 
  <div class="kdocs-img" style="flex-direction:column;max-width:100%;display:flex;width:740px;justify-content:center;align-items:center;height:auto;"> 
   <div class="kdocs-img" style="padding-top:27.972973%;height:0;"> 
    <img src="https://images2.imgbox.com/82/2f/OK9Bdgnx_o.png" style="margin-left:;display:block;width:740px;margin-top:-27.972973%;height:auto;"> 
   </div> 
  </div> 
 </div> 
 <p style=""></p> 
 <p style=""></p> 
 <p style=""></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/768f0e0b9d2c44cc4f40e58461241941/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java八股文 v2.0</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7c3673f3f2dda812a3d8799f892dae1c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Ubuntu下安装Redis</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>