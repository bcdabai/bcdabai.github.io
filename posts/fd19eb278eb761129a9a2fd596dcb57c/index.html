<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Transformer】一文搞懂Transformer | CV领域中Transformer应用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Transformer】一文搞懂Transformer | CV领域中Transformer应用" />
<meta property="og:description" content="目录 阅读本文的基础：一、发展历史：二、从上向下的理解Transformer1、Transformer整体结构简单介绍2、Transformer中的Self-attention（1）引入（2）self-attention（3）并行化计算（4）Multi-head Self-attention（5）位置编码Positional Encoding 3、Transformer整体结构详细介绍(1)整体(2)编码器部分(3)解码器部分 4、示例5、Transformer的compress与accelerate 三、用Transformer解决计算机视觉问题1、iGPT（简介）2、ViT（简介）（1）简介：（2）整体流程： 3、DETR（详解）（1）流程简介：（2）详细流程：1）CNN Backbone&#43;位置编码1.a 上边的分支：位置编码1.a下边的分支：特征提取 2）Encoder3）Decoder4）后处理：匈牙利算法4.a 基于CNN的检测算法的label assignment：4.b DETR的label assignment： 4、Deformable DETR（只言片语）（1）答案1：（2）答案2：（3）答案3： 阅读本文的基础： 需要对【视觉卷积神经网络】比较熟悉。需要对【目标分类、检测任务】比较熟悉。需要对【RNN】有了解。 一、发展历史： （参考：A Survey on Visual Transformer 2020.12.23）
（参考Cheng He）
起源：2017年6月谷歌《Attention is all you need》检测和分割：DETR（CNN&#43; Transformer，更简单和更灵活的pipeline）分类：Vision Transformer（only Transformer：SOTA，减少训练计算资源）像素级图像补全：Image GPT车道标记检测：End-to-end Lane Shape Prediction with Transformers
二、从上向下的理解Transformer 本章的思路为：1、整体结构简单介绍 =&gt; 2、细节 =&gt; 3、整体结构详细介绍 =&gt; 4、Transformer的示例 1、Transformer整体结构简单介绍 （参考 龙心尘）
Transformer由Encoders和Decoders组成，解决Seq2Seq问题Encoders = 6 × \times × encoder， 这6个encoder结构相同，但不共享参数。Decoders = 6 × \times × decoder， 这6个decoder结构相同，但不共享参数。
每个encoder都 = “self-attention” &#43; “feed-forward network”。 self-attention，自注意力，获得上下文信息。feed-forward network，每个位置的单词对应的前馈神经网络都完全一样。（BP层和平常用的FC层的区别，参考：https://www." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/fd19eb278eb761129a9a2fd596dcb57c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-29T21:50:27+08:00" />
<meta property="article:modified_time" content="2021-09-29T21:50:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Transformer】一文搞懂Transformer | CV领域中Transformer应用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">阅读本文的基础：</a></li><li><a href="#_7" rel="nofollow">一、发展历史：</a></li><li><a href="#Transformer_21" rel="nofollow">二、从上向下的理解Transformer</a></li><li><ul><li><a href="#1Transformer_23" rel="nofollow">1、Transformer整体结构简单介绍</a></li><li><a href="#2TransformerSelfattention_33" rel="nofollow">2、Transformer中的Self-attention</a></li><li><ul><li><a href="#1_36" rel="nofollow">（1）引入</a></li><li><a href="#2selfattention_40" rel="nofollow">（2）self-attention</a></li><li><a href="#3_52" rel="nofollow">（3）并行化计算</a></li><li><a href="#4Multihead_Selfattention_62" rel="nofollow">（4）Multi-head Self-attention</a></li><li><a href="#5Positional_Encoding_70" rel="nofollow">（5）位置编码Positional Encoding</a></li></ul> 
   </li><li><a href="#3Transformer_77" rel="nofollow">3、Transformer整体结构详细介绍</a></li><li><ul><li><a href="#1_79" rel="nofollow">(1)整体</a></li><li><a href="#2_83" rel="nofollow">(2)编码器部分</a></li><li><a href="#3_94" rel="nofollow">(3)解码器部分</a></li></ul> 
   </li><li><a href="#4_104" rel="nofollow">4、示例</a></li><li><a href="#5Transformercompressaccelerate_115" rel="nofollow">5、Transformer的compress与accelerate</a></li></ul> 
  </li><li><a href="#Transformer_128" rel="nofollow">三、用Transformer解决计算机视觉问题</a></li><li><ul><li><a href="#1iGPT_131" rel="nofollow">1、iGPT（简介）</a></li><li><a href="#2ViT_136" rel="nofollow">2、ViT（简介）</a></li><li><ul><li><a href="#1_138" rel="nofollow">（1）简介：</a></li><li><a href="#2_144" rel="nofollow">（2）整体流程：</a></li></ul> 
   </li><li><a href="#3DETR_151" rel="nofollow">3、DETR（详解）</a></li><li><ul><li><a href="#1_160" rel="nofollow">（1）流程简介：</a></li><li><a href="#2_164" rel="nofollow">（2）详细流程：</a></li><li><ul><li><a href="#1CNN_Backbone_168" rel="nofollow">1）CNN Backbone+位置编码</a></li><li><ul><li><a href="#1a__171" rel="nofollow">1.a 上边的分支：位置编码</a></li><li><a href="#1a_175" rel="nofollow">1.a下边的分支：特征提取</a></li></ul> 
     </li><li><a href="#2Encoder_179" rel="nofollow">2）Encoder</a></li><li><a href="#3Decoder_185" rel="nofollow">3）Decoder</a></li><li><a href="#4_192" rel="nofollow">4）后处理：匈牙利算法</a></li><li><ul><li><a href="#4a_CNNlabel_assignment_193" rel="nofollow">4.a 基于CNN的检测算法的label assignment：</a></li><li><a href="#4b_DETRlabel_assignment_202" rel="nofollow">4.b DETR的label assignment：</a></li></ul> 
    </li></ul> 
   </li></ul> 
   </li><li><a href="#4Deformable_DETR_207" rel="nofollow">4、Deformable DETR（只言片语）</a></li><li><ul><li><ul><li><a href="#11_209" rel="nofollow">（1）答案1：</a></li><li><a href="#22_216" rel="nofollow">（2）答案2：</a></li><li><a href="#33_221" rel="nofollow">（3）答案3：</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>阅读本文的基础：</h2> 
<ul><li>需要对【视觉卷积神经网络】比较熟悉。</li><li>需要对【目标分类、检测任务】比较熟悉。</li><li>需要对【RNN】有了解。</li></ul> 
<h2><a id="_7"></a>一、发展历史：</h2> 
<p>（参考：<a href="https://arxiv.org/abs/2012.12556" rel="nofollow">A Survey on Visual Transformer 2020.12.23</a>）<br> （<a href="https://zhuanlan.zhihu.com/p/344170484" rel="nofollow">参考Cheng He</a>）</p> 
<ul><li>起源：2017年6月谷歌《Attention is all you need》</li><li>检测和分割：DETR（CNN+ Transformer，更简单和更灵活的pipeline）</li><li>分类：Vision Transformer（only Transformer：SOTA，减少训练计算资源）</li><li>像素级图像补全：Image GPT</li><li>车道标记检测：End-to-end Lane Shape Prediction with Transformers<br> <img src="https://images2.imgbox.com/42/8a/7TmWQSee_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/87/95/kG2tj6xN_o.png" alt="在这里插入图片描述"></li></ul> 
<h2><a id="Transformer_21"></a>二、从上向下的理解Transformer</h2> 
<ul><li>本章的思路为：1、整体结构简单介绍 =&gt; 2、细节 =&gt; 3、整体结构详细介绍 =&gt; 4、Transformer的示例</li></ul> 
<h3><a id="1Transformer_23"></a>1、Transformer整体结构简单介绍</h3> 
<p>（<a href="https://blog.csdn.net/longxinchen_ml/article/details/86533005">参考 龙心尘</a>）</p> 
<ul><li>Transformer由Encoders和Decoders组成，解决Seq2Seq问题</li><li>Encoders = 6 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          × 
         
        
       
         \times 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.66666em; vertical-align: -0.08333em;"></span><span class="mord">×</span></span></span></span></span> encoder， 这6个encoder结构相同，但不共享参数。</li><li>Decoders = 6 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          × 
         
        
       
         \times 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.66666em; vertical-align: -0.08333em;"></span><span class="mord">×</span></span></span></span></span> decoder， 这6个decoder结构相同，但不共享参数。<br> <img src="https://images2.imgbox.com/a2/64/Bp5Vju8u_o.png" alt="在这里插入图片描述"></li><li>每个encoder都 = “self-attention” + “feed-forward network”。 self-attention，自注意力，获得上下文信息。feed-forward network，每个位置的单词对应的前馈神经网络都完全一样。（BP层和平常用的FC层的区别，参考：https://www.zhihu.com/question/470674012，感觉就是一个东西）</li><li>每个decoder都 = “self-attention” + “attention” + “feed-forward network”。注意力层，用来关注输入句子的相关部分 。<br> <img src="https://images2.imgbox.com/a7/08/FXYIoA1F_o.png" alt="在这里插入图片描述"></li></ul> 
<h3><a id="2TransformerSelfattention_33"></a>2、Transformer中的Self-attention</h3> 
<p>（参考：李宏毅老师的Transformer视频）<br> （参考：<a href="https://arxiv.org/abs/2012.12556" rel="nofollow">A Survey on Visual Transformer 2020.12.23</a>）</p> 
<h4><a id="1_36"></a>（1）引入</h4> 
<ul><li>最简单的seq2seq结构就是RNN，缺点是不能并行化</li><li>用一维卷积网络做seq2seq，可以平行化，但是缺点是必须叠很多层才能拥有大感受野</li><li>利用Self-attention可以做到seq2seq结构，并且并行化，完全替代RNN</li></ul> 
<h4><a id="2selfattention_40"></a>（2）self-attention</h4> 
<ul><li>第一步：提取qkv<br> q: query(to match others) <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          q 
         
        
       
         q 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.19444em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">q</span></span></span></span></span> = [<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           W 
          
         
           q 
          
         
         
         
           a 
          
         
           i 
          
         
        
       
         W^qa^i 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.824664em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">q</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.824664em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span></span></span></span></span></span></span></span> for <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          i 
         
        
       
         i 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.65952em; vertical-align: 0em;"></span><span class="mord mathdefault">i</span></span></span></span></span> in range(len(a))]<br> k: key(to be matched) <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          k 
         
        
       
         k 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span></span></span></span></span> = [<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           W 
          
         
           k 
          
         
         
         
           a 
          
         
           i 
          
         
        
       
         W^ka^i 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.849108em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.849108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03148em;">k</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.824664em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span></span></span></span></span></span></span></span> for <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          i 
         
        
       
         i 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.65952em; vertical-align: 0em;"></span><span class="mord mathdefault">i</span></span></span></span></span> in range(len(a))]<br> v: value(information to be extracted) <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          v 
         
        
       
         v 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span></span></span></span></span> = [<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           W 
          
         
           v 
          
         
         
         
           a 
          
         
           i 
          
         
        
       
         W^va^i 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.824664em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">v</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.824664em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span></span></span></span></span></span></span></span> for <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          i 
         
        
       
         i 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.65952em; vertical-align: 0em;"></span><span class="mord mathdefault">i</span></span></span></span></span> in range(len(a))]</li><li>第二步：做attention得到<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          α 
         
        
       
         \alpha 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span></span></span></span>（除以根号d是为了获得更稳定的梯度）<br> 用每个q（<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           q 
          
         
           i 
          
         
        
       
         q^i 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0191em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.824664em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span></span></span></span></span></span></span></span>）去和每个k（<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           k 
          
         
           j 
          
         
        
       
         k^j 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.824664em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.824664em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05724em;">j</span></span></span></span></span></span></span></span></span></span></span></span>）做乘法，得到attention（ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           α 
          
          
          
            i 
           
          
            j 
           
          
         
        
          = 
         
         
          
           
           
             q 
            
           
             i 
            
           
           
           
             k 
            
           
             j 
            
           
          
          
          
            d 
           
          
         
        
       
         \alpha^{ij}=\frac{q^ik^j}{\sqrt{d}} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.824664em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.824664em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right: 0.05724em;">j</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.61557em; vertical-align: -0.538em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.07757em;"><span class="" style="top: -2.53351em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.937845em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mtight" style="padding-left: 0.833em;"><span class="mord mathdefault mtight">d</span></span></span><span class="" style="top: -2.89785em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail mtight" style="min-width: 0.853em; height: 1.08em;"> 
                    <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
                     <path d="M95,702c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,
-10,-9.5,-14c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54c44.2,-33.3,65.8,
-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10s173,378,173,378c0.7,0,
35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429c69,-144,104.5,-217.7,106.5,
-221c5.3,-9.3,12,-14,20,-14H400000v40H845.2724s-225.272,467,-225.272,467
s-235,486,-235,486c-2.7,4.7,-9,7,-19,7c-6,0,-10,-1,-12,-3s-194,-422,-194,-422
s-65,47,-65,47z M834 80H400000v40H845z"></path> 
                    </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.102155em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.44611em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.902086em;"><span class="" style="top: -2.931em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span></span></span></span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.902086em;"><span class="" style="top: -2.931em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05724em;">j</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.538em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>）</li><li>第三步：softmax得到<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           α 
          
         
           ^ 
          
         
        
       
         \hat{\alpha} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;">^</span></span></span></span></span></span></span></span></span></span><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            α 
           
          
            ^ 
           
          
          
          
            i 
           
          
            j 
           
          
         
        
          = 
         
        
          e 
         
        
          x 
         
        
          p 
         
        
          ( 
         
         
         
           α 
          
          
          
            i 
           
          
            j 
           
          
         
        
          ) 
         
        
          / 
         
         
         
           ∑ 
          
         
           j 
          
         
         
         
           e 
          
         
           x 
          
         
           p 
          
         
           ( 
          
          
          
            α 
           
           
           
             i 
            
           
             j 
            
           
          
         
           ) 
          
         
        
       
         \hat{\alpha}^{ij}=exp(\alpha^{ij})/\sum_j{exp(\alpha^{ij})} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.824664em; vertical-align: 0em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.824664em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right: 0.05724em;">j</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.26048em; vertical-align: -0.435818em;"></span><span class="mord mathdefault">e</span><span class="mord mathdefault">x</span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.824664em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right: 0.05724em;">j</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position: relative; top: -5e-06em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.161954em;"><span class="" style="top: -2.40029em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.435818em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="mord mathdefault">x</span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.824664em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right: 0.05724em;">j</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></li><li>第四步：weighted-sum得到b<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           b 
          
         
           i 
          
         
        
          = 
         
         
         
           ∑ 
          
         
           j 
          
         
         
          
          
            α 
           
          
            ^ 
           
          
          
          
            i 
           
          
            j 
           
          
         
         
         
           v 
          
         
           j 
          
         
        
       
         b^{i}=\sum_j\hat{\alpha}^{ij}v^j 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.824664em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathdefault">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.824664em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.26048em; vertical-align: -0.435818em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position: relative; top: -5e-06em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.161954em;"><span class="" style="top: -2.40029em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.435818em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;">^</span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.824664em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right: 0.05724em;">j</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.824664em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05724em;">j</span></span></span></span></span></span></span></span></span></span></span></span><br> <img src="https://images2.imgbox.com/8a/3c/69LZd6v1_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="3_52"></a>（3）并行化计算</h4> 
<ul><li>第一步：得到qkv<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          Q 
         
        
          = 
         
        
          [ 
         
         
         
           q 
          
         
           1 
          
         
        
          , 
         
         
         
           q 
          
         
           2 
          
         
        
          , 
         
         
         
           q 
          
         
           3 
          
         
        
          , 
         
         
         
           q 
          
         
           4 
          
         
        
          ] 
         
        
          = 
         
         
         
           W 
          
         
           q 
          
         
        
          [ 
         
         
         
           a 
          
         
           1 
          
         
        
          , 
         
         
         
           a 
          
         
           2 
          
         
        
          , 
         
         
         
           a 
          
         
           3 
          
         
        
          , 
         
         
         
           a 
          
         
           4 
          
         
        
          ] 
         
        
       
         Q=[q^1,q^2,q^3,q^4]=W^q[a^1,a^2,a^3,a^4] 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.87777em; vertical-align: -0.19444em;"></span><span class="mord mathdefault">Q</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.06411em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.06411em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.664392em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">q</span></span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></li><li>第二步：做attention得到<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          α 
         
        
       
         \alpha 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span></span></span></span><br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          α 
         
        
          = 
         
        
          [ 
         
         
         
           k 
          
         
           1 
          
         
        
          , 
         
         
         
           k 
          
         
           2 
          
         
        
          , 
         
         
         
           k 
          
         
           3 
          
         
        
          , 
         
         
         
           k 
          
         
           4 
          
         
         
         
           ] 
          
         
           T 
          
         
        
          [ 
         
         
         
           q 
          
         
           1 
          
         
        
          , 
         
         
         
           q 
          
         
           2 
          
         
        
          , 
         
         
         
           q 
          
         
           3 
          
         
        
          , 
         
         
         
           q 
          
         
           4 
          
         
        
          ] 
         
        
          = 
         
         
         
           K 
          
         
           T 
          
         
        
          Q 
         
        
       
         \alpha=[k^1,k^2,k^3,k^4]^T[q^1,q^2,q^3,q^4]=K^TQ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.09133em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.841331em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span></span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.03577em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.841331em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord mathdefault">Q</span></span></span></span></span></li><li>第三步：softmax得到<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           α 
          
         
           ^ 
          
         
        
       
         \hat{\alpha} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;">^</span></span></span></span></span></span></span></span></span></span><br> 对每一列进行softmax</li><li>第四步：weighted-sum得到b<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          b 
         
        
          = 
         
        
          [ 
         
         
         
           b 
          
         
           1 
          
         
        
          , 
         
         
         
           b 
          
         
           2 
          
         
        
          , 
         
         
         
           b 
          
         
           3 
          
         
        
          , 
         
         
         
           b 
          
         
           4 
          
         
        
          ] 
         
        
          = 
         
        
          [ 
         
         
         
           v 
          
         
           1 
          
         
        
          , 
         
         
         
           v 
          
         
           2 
          
         
        
          , 
         
         
         
           v 
          
         
           3 
          
         
        
          , 
         
         
         
           v 
          
         
           4 
          
         
        
          ] 
         
         
         
           α 
          
         
           ^ 
          
         
        
          = 
         
        
          v 
         
         
         
           α 
          
         
           ^ 
          
         
        
       
         b=[b^1,b^2,b^3,b^4] =[v^1,v^2,v^3,v^4]\hat{\alpha}=v\hat{\alpha} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault">b</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.06411em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathdefault">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1.06411em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mclose">]</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;">^</span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.69444em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.0037em;">α</span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="accent-body" style="left: -0.22222em;">^</span></span></span></span></span></span></span></span></span></span><br> <img src="https://images2.imgbox.com/f7/43/tdL6CtRy_o.png" alt="在这里插入图片描述"></li></ul> 
<h4><a id="4Multihead_Selfattention_62"></a>（4）Multi-head Self-attention</h4> 
<ul><li> <p>意义：分为多个head，每个head做不同的工作，比如一个head负责局部，另一个负责全局（不同head is almost the same, except the随机初始化）。head数量是一个可调参数。<br> <img src="https://images2.imgbox.com/9b/41/2SPCpiUx_o.png" alt="在这里插入图片描述"></p> </li><li> <p>做法第一步：以2-head Self-attention为例。如图，qkv都分为两支，而左侧的q之和左侧的k做attention，右侧的q之和右侧的k做attention。<br> <img src="https://images2.imgbox.com/dd/0e/hqAywdNd_o.png" alt="在这里插入图片描述"></p> </li><li> <p>做法第二步：得到2个b，直接contact起来，如果得到的维度过大，可以直接再乘上一个矩阵降维。<br> <img src="https://images2.imgbox.com/43/a8/gMSuk3h2_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<h4><a id="5Positional_Encoding_70"></a>（5）位置编码Positional Encoding</h4> 
<ul><li>缺点：对于一个给定的self-attention层，无论序列以任何顺序输入，得到的输出总是相同的，因为self-attention无法关注到序列的位置信息。</li><li>解决方法：Positional Encoding，将位置信息编码到向量e里，再将其原始向量a相加。</li></ul> 
<p><img src="https://images2.imgbox.com/76/b2/hudyctnW_o.png" alt="在这里插入图片描述"></p> 
<ul><li>为什么是e和a是相加而不是contact： 李宏毅老师也觉得很奇怪。</li></ul> 
<h3><a id="3Transformer_77"></a>3、Transformer整体结构详细介绍</h3> 
<p>（参考：李宏毅老师的Transformer视频）</p> 
<h4><a id="1_79"></a>(1)整体</h4> 
<p><img src="https://images2.imgbox.com/20/7b/mC91uBeQ_o.png" alt="在这里插入图片描述"><br> 编码器部分同时输入“机器学习”四个中文，并同时得到编码结果。<br> 解码器部分先输出“machine”，然后把“machine”作为解码器的输入，在输出“learning”。</p> 
<h4><a id="2_83"></a>(2)编码器部分</h4> 
<ul><li>Positional Encoding:见上文</li><li>Multi-Head Attention:见上文</li><li>Add: 输出和输入相加（残差连接，防止梯度消失）<br> <img src="https://images2.imgbox.com/6c/86/IkzAlmdd_o.png" alt="在这里插入图片描述"></li><li>Layer Norm<br> 第一、Layer Norm 一般搭配RNN使用<br> 第二、Batch Norm 令同一batch中 “所有data” 的同一纬度 的均值为0方差为1<br> 第三、Layer Norm 令同一data中 “所有纬度” 的 的均值为0方差为1，无Batch的概念<br> <img src="https://images2.imgbox.com/fb/23/vXTLv81P_o.png" alt="在这里插入图片描述"></li><li>Feed Forward：直接理解为两层全连接，权重映射+非线性激活+权重映射</li></ul> 
<h4><a id="3_94"></a>(3)解码器部分</h4> 
<p>解码器部分先输出“machine”，然后把“machine”作为解码器的输入，在输出“learning”。</p> 
<ul><li>Masked Multi-Head Attention：这一层的输入是已经产生的输出，比如在解码器部分先输出“machine”之后，下一次解码器的输入就是“machine”。（masked的意思是只关注已产生的输出）</li><li>encoder-decoder attention层：就是解码器中的第二个Multi-Head Attention layer：它的K和V是编码器的，Q是之前层获得的。<br> <img src="https://images2.imgbox.com/8c/83/pVWuisRy_o.png" alt="在这里插入图片描述"><br> <a href="https://jalammar.github.io/images/t/transformer_decoding_2.gif" rel="nofollow">解码过程动图</a></li></ul> 
<h3><a id="4_104"></a>4、示例</h3> 
<p>（参考：李宏毅老师的Transformer视频）</p> 
<ul><li>在不同的语境中，Transformer可以自行关注到重点内容。<br> 这个动物并没有过马路，因为它太累了：attention把"它"理解为动物。<br> 这个动物并没有过马路，因为它太宽了：attention把"它"理解为马路。<br> <img src="https://images2.imgbox.com/5e/35/B15k5XZ0_o.png" alt="在这里插入图片描述"></li><li>multi-head attention 能够自行关注到局部和全局信息。<br> 下边的更关注局部信息（红色局部很明显），上边更关注长时信息（绿色全局很明显）。<br> <img src="https://images2.imgbox.com/c4/61/Ox4SYGiR_o.png" alt="在这里插入图片描述"></li></ul> 
<h3><a id="5Transformercompressaccelerate_115"></a>5、Transformer的compress与accelerate</h3> 
<p>（参考：<a href="https://arxiv.org/abs/2012.12556" rel="nofollow">A Survey on Visual Transformer 2020.12.23</a>）（参考：大连理工大学 王栋老师 A Survey on Visual Transformer 导读）</p> 
<ul><li> <p>常见：pruning 剪枝，low-rank decomposition 低秩分解， 知识蒸馏，网络量化，精致结构等等<br> <img src="https://images2.imgbox.com/69/97/u2hxKQJa_o.png" alt="在这里插入图片描述"></p> </li><li> <p>手机端要求模型大小要小。</p> </li><li> <p>嵌入式端，如自动驾驶，更要求计算速度。</p> </li></ul> 
<h2><a id="Transformer_128"></a>三、用Transformer解决计算机视觉问题</h2> 
<p>（参考：<a href="https://arxiv.org/abs/2012.12556" rel="nofollow">A Survey on Visual Transformer 2020.12.23</a>）（参考：大连理工大学 王栋老师 A Survey on Visual Transformer 导读）<br> 大部分视觉任务都只是使用了encoder部分，所以和CNN配合使用</p> 
<h3><a id="1iGPT_131"></a>1、iGPT（简介）</h3> 
<ul><li>自监督模型</li><li>训练时，扣掉一个点，用周围的点去预测它。这样就会学到一个能理解图像内容的模型，再将这个模型用于特征提取。（类似于学英语，找到一篇文章，随机扣掉一个词，做完形填空，学好了之后去做阅读理解。）</li><li>微调时，用交叉熵。</li><li>完全照搬NLP中的策略</li></ul> 
<h3><a id="2ViT_136"></a>2、ViT（简介）</h3> 
<p>（<a href="https://zhuanlan.zhihu.com/p/344170484" rel="nofollow">参考Cheng He</a>）（<a href="https://zhuanlan.zhihu.com/p/359071701" rel="nofollow">参考咫尺小厘米​</a>）（<a href="https://arxiv.org/abs/2010.11929" rel="nofollow">论文</a>）</p> 
<h4><a id="1_138"></a>（1）简介：</h4> 
<ul><li>An image is worth 16x16 words</li><li>将图像拆分为小块，并提供这些小块的线性嵌入序列作为transformer的输入。</li><li>性能优于CNN，计算资源减小4倍（但目前在显卡上计算效率不高）；</li><li>需要大数据预训练：transformer没有CNN固有的一些先验（平移不变性、局部性），所以在中等数据集不如CNN。</li><li>ViT在设计时尽可能地遵循原始的transformer。</li></ul> 
<h4><a id="2_144"></a>（2）整体流程：</h4> 
<ul><li>先把图像分为16x16块</li><li>每个块编码为向量，再加上位置编码</li><li>输入Transformer</li><li>分类层</li></ul> 
<p><img src="https://images2.imgbox.com/ab/c0/THEyrjRO_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3DETR_151"></a>3、DETR（详解）</h3> 
<p>（参考<a href="https://zhuanlan.zhihu.com/p/344170484" rel="nofollow">Cheng He</a>）<br> （参考<a href="https://zhuanlan.zhihu.com/p/146065711" rel="nofollow">梦里梦到梦​</a>）<br> （参考<a href="https://zhuanlan.zhihu.com/p/386579206" rel="nofollow">henaqvmoyi</a>）<br> （参考<a href="https://zhuanlan.zhihu.com/p/348060767" rel="nofollow">学无止境</a>）<br> （<a href="https://ai.facebook.com/research/publications/end-to-end-object-detection-with-transformers" rel="nofollow">DETR原文</a>）<br> （<a href="https://www.bilibili.com/video/BV1Qg4y1B7rL" rel="nofollow">看过的最好的讲解视频</a>）</p> 
<ul><li>缺点：大目标的检测性能显著提高，但小目标检测性能下降</li></ul> 
<h4><a id="1_160"></a>（1）流程简介：</h4> 
<p><img src="https://images2.imgbox.com/24/15/Nukc8ZbD_o.png" alt="在这里插入图片描述"></p> 
<ul><li>DETR是将目标检测视为一个集合预测（序列转换）问题。输入一个图像序列，输出为一个位置编码的集合序列。</li></ul> 
<h4><a id="2_164"></a>（2）详细流程：</h4> 
<p><img src="https://images2.imgbox.com/e8/63/deh6Toad_o.png" alt="在这里插入图片描述"></p> 
<p>可以分为4个部分，backbone，encoder，decoder，后处理。</p> 
<h5><a id="1CNN_Backbone_168"></a>1）CNN Backbone+位置编码</h5> 
<p><img src="https://images2.imgbox.com/60/48/CDIm0Ow7_o.png" alt="在这里插入图片描述"><br> 输入图像尺寸为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         B 
        
       
         × 
        
       
         3 
        
       
         × 
        
       
         H 
        
       
         × 
        
       
         W 
        
       
      
        B \times 3 \times H \times W 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.76666em; vertical-align: -0.08333em;"></span><span class="mord mathdefault" style="margin-right: 0.05017em;">B</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.76666em; vertical-align: -0.08333em;"></span><span class="mord mathdefault" style="margin-right: 0.08125em;">H</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">W</span></span></span></span></span>，分为位置编码和特征提取两个分支</p> 
<h6><a id="1a__171"></a>1.a 上边的分支：位置编码</h6> 
<ul><li>MASK编码：因为是固定尺寸输入，所以可能图片中只有一部分是原始图片，其他是padding。需要一个mask区分出原始图片，直接以下采样32倍的尺度绘制mask，与后续对齐。铺平后得到序列形式的Mask</li><li>位置编码：将位置信息编码为特征图，得到<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          B 
         
        
          × 
         
        
          256 
         
        
          × 
         
         
         
           H 
          
         
           32 
          
         
        
          × 
         
         
         
           W 
          
         
           32 
          
         
        
       
         B\times 256 \times \frac{H}{32} \times \frac{W}{32} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.76666em; vertical-align: -0.08333em;"></span><span class="mord mathdefault" style="margin-right: 0.05017em;">B</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">6</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.21733em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.872331em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.21733em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.872331em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>的位置信息编码。</li><li>序列化: 将长宽两维铺平，对其铺平后得到尺寸为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            H 
           
          
            W 
           
          
          
          
            3 
           
           
           
             2 
            
           
             2 
            
           
          
         
        
          × 
         
        
          B 
         
        
          × 
         
        
          256 
         
        
       
         \frac{HW}{32^2} \times B\times 256 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.21733em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.872331em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.746314em;"><span class="" style="top: -2.786em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.08125em;">H</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.76666em; vertical-align: -0.08333em;"></span><span class="mord mathdefault" style="margin-right: 0.05017em;">B</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">6</span></span></span></span></span>的序列。</li></ul> 
<h6><a id="1a_175"></a>1.a下边的分支：特征提取</h6> 
<ul><li>CNN特征提取：（CNN去掉全局池化和线性层，下采样倍数为32，最后一层输出维度为2048），得到 尺寸为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          B 
         
        
          × 
         
        
          2048 
         
        
          × 
         
         
         
           H 
          
         
           32 
          
         
        
          × 
         
         
         
           W 
          
         
           32 
          
         
        
       
         B \times 2048 \times \frac{H}{32} \times \frac{W}{32} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.76666em; vertical-align: -0.08333em;"></span><span class="mord mathdefault" style="margin-right: 0.05017em;">B</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mord">4</span><span class="mord">8</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.21733em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.872331em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.21733em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.872331em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>的特征图。</li><li>特征图降维：使用1x1的卷积对CNN特征提取得到的尺寸为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          B 
         
        
          × 
         
        
          2048 
         
        
          × 
         
         
         
           H 
          
         
           32 
          
         
        
          × 
         
         
         
           W 
          
         
           32 
          
         
        
       
         B\times 2048 \times \frac{H}{32} \times \frac{W}{32} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.76666em; vertical-align: -0.08333em;"></span><span class="mord mathdefault" style="margin-right: 0.05017em;">B</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mord">4</span><span class="mord">8</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.21733em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.872331em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.21733em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.872331em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>的特征图进行降维，得到尺寸为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          B 
         
        
          × 
         
        
          256 
         
        
          × 
         
         
         
           H 
          
         
           32 
          
         
        
          × 
         
         
         
           W 
          
         
           32 
          
         
        
       
         B\times 256 \times \frac{H}{32} \times \frac{W}{32} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.76666em; vertical-align: -0.08333em;"></span><span class="mord mathdefault" style="margin-right: 0.05017em;">B</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.72777em; vertical-align: -0.08333em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">6</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.21733em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.872331em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.21733em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.872331em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>的特征图。</li><li>序列化: 将长宽两维铺平，对特征图铺平后得到尺寸为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
            H 
           
          
            W 
           
          
          
          
            3 
           
           
           
             2 
            
           
             2 
            
           
          
         
        
          × 
         
        
          B 
         
        
          × 
         
        
          256 
         
        
       
         \frac{HW}{32^2} \times B\times 256 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.21733em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.872331em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight"><span class="mord mtight">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.746314em;"><span class="" style="top: -2.786em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.08125em;">H</span><span class="mord mathdefault mtight" style="margin-right: 0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.76666em; vertical-align: -0.08333em;"></span><span class="mord mathdefault" style="margin-right: 0.05017em;">B</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.64444em; vertical-align: 0em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">6</span></span></span></span></span>的序列。</li></ul> 
<h5><a id="2Encoder_179"></a>2）Encoder</h5> 
<p><img src="https://images2.imgbox.com/e1/57/xOjvMwfW_o.png" alt="在这里插入图片描述"></p> 
<ul><li>输入：铺平的特征图（特征序列）</li><li>过程：特征映射</li><li>输出：与输入相同大小的特征序列</li></ul> 
<h5><a id="3Decoder_185"></a>3）Decoder</h5> 
<p><img src="https://images2.imgbox.com/a1/16/2OU2vIJp_o.png" alt="在这里插入图片描述"></p> 
<ul><li>输入：编码器的输出、object queries。<br> （与BERT不同，不做自回归操作，不把输出重新作为输入，只是one-shot）</li><li>object queries是什么：可以理解为100个提问者，每个提问者关注图像的某一区域，如图所示，第一个object query更关注图像的左侧区域，第二个object query更关注图像的中间和偏下区域。<br> <img src="https://images2.imgbox.com/1a/3c/e1DVQb3K_o.png" alt="在这里插入图片描述"></li><li>object queries输入Decoder之后，Decoder做了什么：object queries作为Q，而编码器的输出作为K和V，这可以理解为，提问者向编码器的输出提问，并且自行决定关注编码器的输出的哪些部分。多次询问，以及提问者之间多次互相讨论之后，会得到预测框的输出。</li></ul> 
<h5><a id="4_192"></a>4）后处理：匈牙利算法</h5> 
<h6><a id="4a_CNNlabel_assignment_193"></a>4.a 基于CNN的检测算法的label assignment：</h6> 
<p>（参考：<a href="https://zhuanlan.zhihu.com/p/166275032" rel="nofollow">mileistone</a>）</p> 
<ul><li>Faster RCNN/SSD/RetinaNet（Anchor机制）：基于anchor与GT框IOU划分正负样本，允许多个anchor同时对应与某一个真值框</li><li>YOLOv1（Grid Cell机制，无anchor）：每个Grid Cell最多只负责一个object，遍历真值框，为每个真值框选择一个Grid Cell。</li><li>YOLOv2（Grid Cell机制，有anchor）：每个Grid Cell最多只负责一个object，遍历真值框，先为每个真值框选择一个Grid Cell；对于某一个真值框，计算它与它对应的Grid Cell中所有anchor的IOU，选择IOU最大的anchor作为positive；计算它与它对应的Grid Cell中所有proposal的IOU，IoU大于0.6的proposal对应的anchor为ignore。</li><li>YOLOv3：每个Grid Cell最多只负责一个object，遍历真值框，先为每个真值框选择一个Grid Cell；对于某一个真值框，计算它与Grid Cell中所有anchor的IOU（左上角对齐，不考虑位置），选择IOU最大的anchor作为positive；对于某一个proposal，计算它与它对应的Grid Cell中所有gt的IOU，IoU大的ignore。</li><li>FCOS（无anchor）：对于每一层feature map，将每个坐标映射到原图，与包围它的GT框对应，有包围则为positive，没有则为negative，同时有多个的话取最小的为positive。</li><li>FreeAnchor：与某一GT的IOU低于0.6的anchor为negative；与某一GT的IOU高的top 50为候选positive，候选positive anchor对应的loss小的则为正式positive；以外的anchor为ignore。</li><li>AutoAssign：对于每一层feature map，将每个坐标映射到原图，与包围它的GT框对应，并不是直接划分正负样本，而是设定权重，positive的权重通过attention的方式来学，negative的权重通过与所有GT框之间最大的IoU负相关地确定。其余grid cell为negative，没有ignore。</li></ul> 
<h6><a id="4b_DETRlabel_assignment_202"></a>4.b DETR的label assignment：</h6> 
<ul><li>DETR使用的Loss是L1Loss（xywh绝对误差）和GIouLoss。Decoder的输出经过分类器后会得到100个预测框（有些预测框为空），在计算loss之前需要将预测框与GT匹配。DETR使用匈牙利算法实现该过程，简要来说，就是找到一种匹配方案，使loss总和”最小，是一个存粹的匹配问题，没有参数不需要学习。</li><li>匈牙利算法的一个简单应用就是任务分配问题：N个人分配N项任务，一个人只能分配一项任务，一项任务只能分配给一个人，将一项任务分配给一个人是需要支付报酬，如何分配任务，保证支付的报酬总数最小。（已知每个人完成每项任务所需要的报酬：NxN的矩阵）。 实现过程可以参考：<a href="https://www.cnblogs.com/dwdxdy/p/3261742.html" rel="nofollow">一点心青</a></li></ul> 
<h3><a id="4Deformable_DETR_207"></a>4、Deformable DETR（只言片语）</h3> 
<ul><li><a href="https://www.zhihu.com/question/424814377/answer/1640597255" rel="nofollow">如何看待商汤的Deformable DETR？能否取代Faster-RCNN范式？</a></li></ul> 
<h5><a id="11_209"></a>（1）答案1：</h5> 
<ul><li>Deformable DETR比DETR训练快10x</li><li>Backbone、 Matcher 和 positional encoding 的实现和 DETR是一样的</li><li>multi-scale deformable attention</li><li>DETR 中是直接回归的 bounding box 绝对坐标；Deformable DETR 引入了 reference，回归的是基于 point 坐标的 offset。</li><li>head 的部分调整了初始化策略，应该对训练也有帮助</li><li>K=1 的情况本身就相当于在 head 里引入了 Deformable Convolution ，baseline 上来就比 DETR 高了很多</li></ul> 
<h5><a id="22_216"></a>（2）答案2：</h5> 
<ul><li>Deformable DETR之于 DETR，应该相当于 ResNet 之于 AlexNet</li><li>对全连接 Transformer 的计算量进行优化，为每个 query 采样 K 个 key-value pair</li><li>最大的性能收益，来源于这一方法可以自然地引入多尺度特征。</li></ul> 
<h5><a id="33_221"></a>（3）答案3：</h5> 
<ul><li>self-attention的最大意义是在于建立长距离的相互关系，并且能够避免CNN中存在的归纳偏好问题，</li><li>如果仅仅只在self-attention引入局部的attention操作就会失去self-attention建立长距离相互关系的优点</li><li>deformable attention操作降低self-attention的复杂度，同时保留了self-attention构建长距离相互关系的优点</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/52a010309f841bb57b0e37a92f943dbb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Effective Java 读书笔记</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4a117b9d0ba49356b0f453ae9837b362/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">12枚硬币称重问题(面试)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>