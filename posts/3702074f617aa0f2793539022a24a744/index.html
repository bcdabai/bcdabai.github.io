<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>5.3 内容管理模块 - 课程发布、任务调度、页面静态化、熔断降级 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="5.3 内容管理模块 - 课程发布、任务调度、页面静态化、熔断降级" />
<meta property="og:description" content="内容管理模块 - 课程发布 - 任务调度、熔断降级、页面静态化 文章目录 内容管理模块 - 课程发布 - 任务调度、熔断降级、页面静态化一、课程发布 - 任务调度1.1 添加Maven依赖1.2 XxlJobConfig配置文件1.3 消息处理抽象类 MessageProcessAbstract1.4 课程发布任务类 CoursePublishTask1.5 执行器配置信息1.6 添加任务管理 二、 课程发布 - 页面静态化2.1 静态化测试2.1.1 Maven依赖2.1.2 静态化测试 2.2 上传文件测试2.2.1 Feign 远程调用2.2.2 扩充上传文件接口2.2.3 远程调用测试 2.3 熔断 - 降级2.3.1 介绍2.3.2 熔断 - 降级处理 2.4 页面静态化任务2.4.1 CoursePublishServiceImpl2.4.2 课程发布任务类 CoursePublishTask 一、课程发布 - 任务调度 下面完成这几步，这几步在消息的SDK中已经给我们提供了
1.1 添加Maven依赖 content-service工程中添加xxl-job依赖
&lt;dependency&gt; &lt;groupId&gt;com.xuxueli&lt;/groupId&gt; &lt;artifactId&gt;xxl-job-core&lt;/artifactId&gt; &lt;/dependency&gt; 1.2 XxlJobConfig配置文件 content-service工程中添加XxlJobConfig配置文件
@Configuration public class XxlJobConfig { private Logger logger = LoggerFactory." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/3702074f617aa0f2793539022a24a744/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-21T20:10:45+08:00" />
<meta property="article:modified_time" content="2024-01-21T20:10:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">5.3 内容管理模块 - 课程发布、任务调度、页面静态化、熔断降级</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_____0"></a>内容管理模块 - 课程发布 - 任务调度、熔断降级、页面静态化</h2> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_____0" rel="nofollow">内容管理模块 - 课程发布 - 任务调度、熔断降级、页面静态化</a></li><li><a href="#___3" rel="nofollow">一、课程发布 - 任务调度</a></li><li><ul><li><a href="#11_Maven_11" rel="nofollow">1.1 添加Maven依赖</a></li><li><a href="#12__XxlJobConfig_22" rel="nofollow">1.2 XxlJobConfig配置文件</a></li><li><a href="#13__MessageProcessAbstract_74" rel="nofollow">1.3 消息处理抽象类 MessageProcessAbstract</a></li><li><a href="#14___CoursePublishTask_172" rel="nofollow">1.4 课程发布任务类 CoursePublishTask</a></li><li><a href="#15__209" rel="nofollow">1.5 执行器配置信息</a></li><li><a href="#16__235" rel="nofollow">1.6 添加任务管理</a></li></ul> 
  </li><li><a href="#____245" rel="nofollow">二、 课程发布 - 页面静态化</a></li><li><ul><li><a href="#21__281" rel="nofollow">2.1 静态化测试</a></li><li><ul><li><a href="#211_Maven_283" rel="nofollow">2.1.1 Maven依赖</a></li><li><a href="#212__298" rel="nofollow">2.1.2 静态化测试</a></li></ul> 
   </li><li><a href="#22__345" rel="nofollow">2.2 上传文件测试</a></li><li><ul><li><a href="#221_Feign__365" rel="nofollow">2.2.1 Feign 远程调用</a></li><li><a href="#222__483" rel="nofollow">2.2.2 扩充上传文件接口</a></li><li><a href="#223__533" rel="nofollow">2.2.3 远程调用测试</a></li></ul> 
   </li><li><a href="#23____613" rel="nofollow">2.3 熔断 - 降级</a></li><li><ul><li><a href="#231__615" rel="nofollow">2.3.1 介绍</a></li><li><a href="#232____659" rel="nofollow">2.3.2 熔断 - 降级处理</a></li></ul> 
   </li><li><a href="#24__786" rel="nofollow">2.4 页面静态化任务</a></li><li><ul><li><a href="#241_CoursePublishServiceImpl_805" rel="nofollow">2.4.1 CoursePublishServiceImpl</a></li><li><a href="#242__CoursePublishTask_908" rel="nofollow">2.4.2 课程发布任务类 CoursePublishTask</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="___3"></a>一、课程发布 - 任务调度</h2> 
<p>下面完成这几步，这几步在消息的SDK中已经给我们提供了</p> 
<p><img src="https://images2.imgbox.com/ec/d0/3L1yHrBg_o.png" alt="image-20240118234457973"></p> 
<h3><a id="11_Maven_11"></a>1.1 添加Maven依赖</h3> 
<p><strong>content-service工程中添加xxl-job依赖</strong></p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.xuxueli<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>xxl-job-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="12__XxlJobConfig_22"></a>1.2 XxlJobConfig配置文件</h3> 
<p>content-service工程中添加XxlJobConfig配置文件</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XxlJobConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">XxlJobConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.admin.addresses}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> adminAddresses<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.accessToken}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessToken<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.appname}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appname<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.address}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.ip}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> ip<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.port}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.logpath}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> logPath<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxl.job.executor.logretentiondays}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> logRetentionDays<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">XxlJobSpringExecutor</span> <span class="token function">xxlJobExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XxlJobSpringExecutor</span> xxlJobSpringExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XxlJobSpringExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAdminAddresses</span><span class="token punctuation">(</span>adminAddresses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAppname</span><span class="token punctuation">(</span>appname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setAccessToken</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setLogPath</span><span class="token punctuation">(</span>logPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        xxlJobSpringExecutor<span class="token punctuation">.</span><span class="token function">setLogRetentionDays</span><span class="token punctuation">(</span>logRetentionDays<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> xxlJobSpringExecutor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="13__MessageProcessAbstract_74"></a>1.3 消息处理抽象类 MessageProcessAbstract</h3> 
<p>消息SDK给我们提供的，也就是下面这几步</p> 
<p><img src="https://images2.imgbox.com/96/ce/aXOK7KCR_o.png" alt="image-20240118234457973"></p> 
<p>SDK中唯一没有的就是抽象方法execute，也就是执行任务的逻辑没有，我们需要的是写一个类继承MessageProcessAbstract并实现execute方法，编写任务的具体执行逻辑</p> 
<p><img src="https://images2.imgbox.com/ab/17/H0LGe59J_o.png" alt="image-20240118235315216"></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @description 消息处理抽象类
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MessageProcessAbstract</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MqMessageService</span> mqMessageService<span class="token punctuation">;</span>


    <span class="token comment">/**
     * @param mqMessage 执行任务内容
     * @return boolean true:处理成功，false处理失败
     * @description 任务处理
     * @author Mr.M
     * @date 2022/9/21 19:47
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * @description 扫描消息表多线程执行任务
     * @param shardIndex 分片序号
     * @param shardTotal 分片总数
     * @param messageType  消息类型
     * @param count  一次取出任务总数
     * @param timeout 预估任务执行时间,到此时间如果任务还没有结束则强制结束 单位秒
     * @return void
     * @author Mr.M
     * @date 2022/9/21 20:35
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">int</span> shardIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> shardTotal<span class="token punctuation">,</span>  <span class="token class-name">String</span> messageType<span class="token punctuation">,</span><span class="token keyword">int</span> count<span class="token punctuation">,</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//扫描消息表获取任务清单</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MqMessage</span><span class="token punctuation">&gt;</span></span> messageList <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getMessageList</span><span class="token punctuation">(</span>shardIndex<span class="token punctuation">,</span> shardTotal<span class="token punctuation">,</span>messageType<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//任务个数</span>
            <span class="token keyword">int</span> size <span class="token operator">=</span> messageList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"取出待处理消息"</span><span class="token operator">+</span>size<span class="token operator">+</span><span class="token string">"条"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>size<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//创建线程池</span>
            <span class="token class-name">ExecutorService</span> threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//计数器</span>
            <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>message <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"开始任务:{}"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//处理任务</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token function">execute</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"任务执行成功:{})"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">//更新任务状态,删除消息表记录,添加到历史表</span>
                            <span class="token keyword">int</span> completed <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">completed</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>completed<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"任务执行成功:{}"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"任务执行失败:{}"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"任务出现异常:{},任务:{}"</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//计数</span>
                        countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"结束任务:{}"</span><span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span>
            countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"结束...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="14___CoursePublishTask_172"></a>1.4 课程发布任务类 CoursePublishTask</h3> 
<p>粗略写出课程发布的任务类的大体框架，后面完善</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 课程发布的任务类
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoursePublishTask</span> <span class="token keyword">extends</span> <span class="token class-name">MessageProcessAbstract</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//任务调度入口</span>
    <span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">"CoursePublishJobHandler"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">coursePublishJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 分片参数</span>
        <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//第几个分片</span>
        <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//分片总数</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"shardIndex="</span><span class="token operator">+</span>shardIndex<span class="token operator">+</span><span class="token string">",shardTotal="</span><span class="token operator">+</span>shardTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//参数:分片序号、分片总数、消息类型、一次最多取到的任务数量、一次任务调度执行的超时时间</span>
        <span class="token comment">//这个方法是MessageProcessAbstract抽象类的方法</span>
        <span class="token function">process</span><span class="token punctuation">(</span>shardIndex<span class="token punctuation">,</span>shardTotal<span class="token punctuation">,</span><span class="token string">"course_publish"</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    
        <span class="token comment">/*
     * 执行课程发布的任务逻辑
     * MqMessage 数据库实体类
     * 如果此方法抛出异常说明任务执行失败
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> mqMessage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//后面补充这个方法，现在只是一个模板</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>  
</code></pre> 
<h3><a id="15__209"></a>1.5 执行器配置信息</h3> 
<p>进入content-service的nacos配置执行器的配置信息</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">xxl</span><span class="token punctuation">:</span>
  <span class="token key atrule">job</span><span class="token punctuation">:</span>
    <span class="token key atrule">admin</span><span class="token punctuation">:</span> 
      <span class="token key atrule">addresses</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.101.65<span class="token punctuation">:</span>8088/xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin
    <span class="token key atrule">executor</span><span class="token punctuation">:</span>
      <span class="token key atrule">appname</span><span class="token punctuation">:</span> coursepublish<span class="token punctuation">-</span>job
      <span class="token key atrule">address</span><span class="token punctuation">:</span> 
      <span class="token key atrule">ip</span><span class="token punctuation">:</span> 
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8999</span>
      <span class="token key atrule">logpath</span><span class="token punctuation">:</span> /data/applogs/xxl<span class="token punctuation">-</span>job/jobhandler
      <span class="token key atrule">logretentiondays</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token key atrule">accessToken</span><span class="token punctuation">:</span> default_token

</code></pre> 
<p><img src="https://images2.imgbox.com/06/15/ZFiCWsdg_o.png" alt="image-20240119003537258"></p> 
<p><strong>重新启动content-service项目，观察调度中心</strong></p> 
<p><img src="https://images2.imgbox.com/30/b2/SENF7k7V_o.png" alt="image-20240119004154625"></p> 
<h3><a id="16__235"></a>1.6 添加任务管理</h3> 
<p><img src="https://images2.imgbox.com/ff/e5/bf6JtKwC_o.png" alt="image-20240119004223102"></p> 
<p><img src="https://images2.imgbox.com/f4/45/CmHmvdpw_o.png" alt="image-20240119004234008"></p> 
<h2><a id="____245"></a>二、 课程发布 - 页面静态化</h2> 
<blockquote> 
 <p>在这篇文章中有模板引擎技术framework</p> 
 <p><a href="https://blog.csdn.net/weixin_51351637/article/details/135612734?spm=1001.2014.3001.5501">5.1 内容管理模块 - 课程预览、提交审核</a></p> 
 <p>模板引擎两个因素：模板、数据，只要有模板和数据，就能生成静态页面</p> 
</blockquote> 
<p><strong>执行课程发布后要将课程详情信息页面静态化，生成html页面上传至文件系统。</strong></p> 
<blockquote> 
 <p>如果大量的请求访问课程发布完成的页面，然后再去查询数据库、拿到模板、生成页面响应，这样性能不是很好</p> 
 <p>下面的这个页面我们可以提前生成，然后再通过Nginx请求html。</p> 
 <p>因为Nginx的并发是非常高的，远远要大于Tomcat的性能</p> 
 <p><img src="https://images2.imgbox.com/27/c0/K3texmmR_o.png" alt="image-20240114144449211"></p> 
</blockquote> 
<ul><li><strong>什么是页面静态化</strong>？</li></ul> 
<p>课程预览功能通过模板引擎技术在页面模板中填充数据，生成html页面，这个过程是当客户端请求服务器时服务器才开始渲染生成html页面，最后响应给浏览器，服务端渲染的并发能力是有限的。</p> 
<p>页面静态化则强调将生成html页面的过程提前，<strong>提前使用模板引擎技术生成html页面</strong>，当客户端请求时直接请求html页面，由于是静态页面可以使用nginx、apache等高性能的web服务器，并发性能高。</p> 
<blockquote> 
 <p>强调的是提前生成Html页面，然后再把这个页面放到Nginx里面供用户进行访问</p> 
</blockquote> 
<ul><li><strong>什么时候能用页面静态化技术</strong>？</li></ul> 
<p><strong>当数据变化不频繁，一旦生成静态页面很长一段时间内很少变化，此时可以使用页面静态化</strong>。</p> 
<p>因为如果数据变化频繁，一旦改变就需要重新生成静态页面，导致维护静态页面的工作量很大。</p> 
<p>根据课程发布的业务需求，虽然<strong>课程发布后仍可以修改课程信息，但需要经过课程审核，且修改频度不大，所以适合使用页面静态化</strong>。</p> 
<h3><a id="21__281"></a>2.1 静态化测试</h3> 
<h4><a id="211_Maven_283"></a>2.1.1 Maven依赖</h4> 
<p>在content-service工程中添加freemarker依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-freemarker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="212__298"></a>2.1.2 静态化测试</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FreemarkerTest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">CoursePublishService</span> coursePublishService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testGenerateHtmlByTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">//TODO 准备模板</span>
        <span class="token comment">// import freemarker.template.Configuration</span>
        <span class="token comment">// new Configuration 实例时输入传入一下Configuration当前的版本</span>
        <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 找到模板路径</span>
        <span class="token class-name">String</span> classPath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定模板目录 (从哪个目录加载模板)</span>
        configuration<span class="token punctuation">.</span><span class="token function">setDirectoryForTemplateLoading</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>classPath <span class="token operator">+</span> <span class="token string">"/templates"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定编码</span>
        configuration<span class="token punctuation">.</span><span class="token function">setDefaultEncoding</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 得到模板</span>
        <span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">"course_template.ftl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//TODO 准备数据</span>
        <span class="token class-name">CoursePreviewDto</span> coursePreviewInfo <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span><span class="token number">120L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"model"</span><span class="token punctuation">,</span> coursePreviewInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//TODO 将一个页面（源代码）转换成字符串</span>
        <span class="token comment">// 参数1：模板  参数2：数据</span>
        <span class="token class-name">String</span> html <span class="token operator">=</span> <span class="token class-name">FreeMarkerTemplateUtils</span><span class="token punctuation">.</span><span class="token function">processTemplateIntoString</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//TODO 使用流将静态化内容输出到文件中</span>
        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">toInputStream</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//输出流</span>
        <span class="token class-name">FileOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"D:\\1.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22__345"></a>2.2 上传文件测试</h3> 
<p><strong>内容管理服务对页面静态化生成html文件需要调用媒资管理服务的上传文件接口</strong></p> 
<p><img src="https://images2.imgbox.com/1e/ff/c09dd1uf_o.png" alt="image-20240120143614600"></p> 
<blockquote> 
 <p>content-service模块会请求media模块然后上传静态化页面到Minio系统中</p> 
</blockquote> 
<p><strong>微服务之间难免会存在远程调用，在Spring Cloud中可以使用Feign进行远程调用</strong></p> 
<blockquote> 
 <p>Feign是一个声明式的http客户端</p> 
 <p>官方地址：https://github.com/OpenFeign/feign</p> 
 <p>学习资料：<a href="https://blog.csdn.net/weixin_51351637/article/details/129351750">HTTP客户端Feign</a></p> 
 <p>其作用就是帮助我们优雅的实现http请求的发送，解决上面提到的问题。</p> 
</blockquote> 
<h4><a id="221_Feign__365"></a>2.2.1 Feign 远程调用</h4> 
<ul><li><strong>内容管理content-service工程添加依赖</strong></li></ul> 
<p>之前Feign远程调用发送的是数据，而现在发送的是文件，所以我们需要一个组件要支撑Multipart格式传参</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- 这个其实之前已经加入了，Nacos服务注册中心--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- Spring Cloud 微服务远程调用 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--feign支持Multipart格式传参，这两个都是--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign.form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign.form<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-form-spring<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ul><li><strong>在nacos配置feign-dev.yaml公用配置文件</strong></li></ul> 
<p>远程调用的时候可能会发生熔断，这里面要把熔断的开关打开</p> 
<p>以免远程调用的时候对方可能网络慢、响应慢导致熔断</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token comment"># 这是一个框架</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token comment"># 开启熔断开关</span>
  <span class="token key atrule">circuitbreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">30000</span>  <span class="token comment">#熔断超时时间</span>
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token comment">#连接超时时间</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token comment">#读超时时间</span>
  <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment">#重试次数</span>
  <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#切换实例的重试次数</span>
</code></pre> 
<ul><li><strong>在内容管理service工程和内容管理api工程都引入此配置文件</strong></li></ul> 
<p>添加公用配置</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> feign<span class="token punctuation">-</span>$<span class="token punctuation">{<!-- --></span>spring.profiles.active<span class="token punctuation">}</span>.yaml
    <span class="token key atrule">group</span><span class="token punctuation">:</span> xuecheng<span class="token punctuation">-</span>plus<span class="token punctuation">-</span>common
    <span class="token key atrule">refresh</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<ul><li><strong>在内容管理service工程添加Reign配置文件</strong></li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MultipartSupportConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpMessageConverters</span><span class="token punctuation">&gt;</span></span> messageConverters<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 让传参支持Multipart类型
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Primary</span><span class="token comment">//注入相同类型的bean时优先使用</span>
    <span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span><span class="token string">"prototype"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Encoder</span> <span class="token function">feignEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SpringFormEncoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SpringEncoder</span><span class="token punctuation">(</span>messageConverters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * 可以将普通文件转换成Multipart
     * @param file
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">MultipartFile</span> <span class="token function">getMultipartFile</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">FileItem</span> item <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DiskFileItemFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createItem</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">,</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileInputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token class-name">OutputStream</span> outputStream <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonsMultipartFile</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="222__483"></a>2.2.2 扩充上传文件接口</h4> 
<p>现在需要将课程的静态文件上传到minio，单独存储到course目录下，文件的objectname为"课程id.html"，原有的上传文件接口需要增加一个参数 objectname</p> 
<ul><li><strong>修改media-api工程中MediaFilesController类upload方法</strong></li></ul> 
<blockquote> 
 <p>因为html不算是大文件，我们就修改之前“上传图片”接口即可</p> 
</blockquote> 
<p><strong>添加参数objectName</strong></p> 
<blockquote> 
 <p>如果调用接口时传入了“objectName”，那我们就往“course”目录下传，反之按照年月日实行的目录进行存储</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"上传图片"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/upload/coursefile"</span><span class="token punctuation">,</span> consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"filedata"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> filedata<span class="token punctuation">,</span>
                                  <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"objectName"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>修改media-service工程中MediaFilesController类upload方法</strong></li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 上传文件
 *
 * @param companyId           机构id
 * @param uploadFileParamsDto 上传文件信息
 * @param localFilePath       文件磁盘路径
 * @return 文件信息
 */</span>
<span class="token keyword">public</span> <span class="token class-name">UploadFileResultDto</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token class-name">Long</span> companyId<span class="token punctuation">,</span> <span class="token class-name">UploadFileParamsDto</span> uploadFileParamsDto<span class="token punctuation">,</span> <span class="token class-name">String</span> localFilePath<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">//存储到minio中的对象名(带目录)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>objectName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    objectName <span class="token operator">=</span>  defaultFolderPath <span class="token operator">+</span> fileMd5 <span class="token operator">+</span> extension<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/39/f4/TOMkYfzK_o.png" alt="image-20240120150953596"></p> 
<h4><a id="223__533"></a>2.2.3 远程调用测试</h4> 
<ul><li><strong>content-service下编写feign接口</strong></li></ul> 
<blockquote> 
 <p>内容管理服务中的content-service调用媒资管理服务中的media-api接口</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 远程调用媒资服务接口
 *  value:指定要调用的服务是media-api，也就是在配置文件中调用的spring.application.name的值
 *  configuration: 指定Feign的配置文件为MultipartSupportConfig.class
 * 原理：
 * 将来Spring会生成一个代理对象，在代理对象当中去实现远程调用
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"media-api"</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaServiceClient</span> <span class="token punctuation">{<!-- --></span>


    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/media-api/upload/coursefile"</span><span class="token punctuation">,</span> consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"filedata"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> filedata<span class="token punctuation">,</span>
                                      <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"objectName"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>在启动类添加@EnableFeignClients注解</strong></li></ul> 
<p>在哪里启动就在哪里添加这个注解即可，重要的是一定要扫描到feignclient包中的feign请求</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"com.xuecheng.content.feignclient"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/eb/15/QgGz8ahm_o.png" alt="image-20240120183245207"></p> 
<ul><li><strong>编写单元测试</strong></li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 测试远程调用媒资服务
 *
 * @description 测试使用feign远程上传文件
 */</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignUploadTest</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">MediaServiceClient</span> mediaServiceClient<span class="token punctuation">;</span>

    <span class="token comment">//远程调用，上传文件</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//将File类型转换成Multipart类型</span>
        <span class="token comment">//MultipartSupportConfig是我们自定义的config文件（getMultipartFile方法是我们一个工具类方法）</span>
        <span class="token class-name">MultipartFile</span> multipartFile <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token function">getMultipartFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:\\develop\\test.html"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaServiceClient<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>multipartFile<span class="token punctuation">,</span> <span class="token string">"course/1.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>配置Nginx</strong></li></ul> 
<p>在主栈中配置一下代理模式，凡是以/course打头的，都代理到fileserver，并请求fileserver下面的/mediafiles/course/</p> 
<pre><code>          location /course{  
                proxy_pass    http://fileserver/mediafiles/course/;
        } 
</code></pre> 
<p>重启Nginx，如下访问方式即可</p> 
<p><img src="https://images2.imgbox.com/8c/31/60ACM1o0_o.png" alt="image-20240120185128323"></p> 
<h3><a id="23____613"></a>2.3 熔断 - 降级</h3> 
<h4><a id="231__615"></a>2.3.1 介绍</h4> 
<p>当微服务运行不正常会导致无法正常调用微服务，此时会出现异常，如果这种异常不去处理可能导致雪崩效应</p> 
<p><strong>微服务的雪崩效应表现在服务与服务之间调用，当其中一个服务无法提供服务可能导致其它服务也死掉</strong></p> 
<p>比如：服务B调用服务A，由于A服务异常导致B服务响应缓慢，最后B、C等服务都不可用，像这样<strong>由一个服务所引起的一连串的多个服务无法提供服务即是微服务的雪崩效应</strong></p> 
<p><img src="https://images2.imgbox.com/62/ae/Ll1ffdRl_o.png" alt="image-20240120185557434"></p> 
<p><strong>如何解决由于微服务异常引起的雪崩效应呢</strong>？</p> 
<p>采用熔断、降级的方法去解决</p> 
<blockquote> 
 <p>熔断是当下游服务异常时一种保护系统的手段</p> 
 <p>降级是熔断后上游服务处理熔断的方法</p> 
 <p>所以先有的熔断再有的降级</p> 
</blockquote> 
<ul><li><strong>熔断</strong></li></ul> 
<p>当下游服务异常而断开与上游服务的交互，它就相当于保险丝，下游服务异常触发了熔断，从而保证上游服务不受影响</p> 
<blockquote> 
 <p>调用方是上游服务</p> 
 <p>被调方式下游服务</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/c4/85/lYqiCRM1_o.png" alt="image-20240120185829404"></p> 
<ul><li><strong>降级</strong></li></ul> 
<p>当下游服务异常触发熔断后，上游服务就不再去调用异常的微服务而是执行了降级处理逻辑，这个降级处理逻辑可以是本地一个单独的方法</p> 
<blockquote> 
 <p>相当于媒资管理服务走不通了之后就再走另外一条线路，这就是降级的意思</p> 
 <p>因为发生熔断了，上游服务走了降级的路线来调用降级方法，不再调用原来有问题的服务</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/28/d5/acBZAMem_o.png" alt="image-20240120185901228"></p> 
<h4><a id="232____659"></a>2.3.2 熔断 - 降级处理</h4> 
<p><strong>项目使用Hystrix框架实现熔断、降级处理，在feign-dev.yaml中配置</strong></p> 
<ul><li><strong>熔断处理</strong></li></ul> 
<ol><li><strong>开启Feign熔断保护</strong></li></ol> 
<pre><code class="prism language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">circuitbreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<ol start="2"><li><strong>设置熔断的超时时间，为了防止一次处理时间较长触发熔断这里还需要设置请求和连接的超时时间</strong></li></ol> 
<pre><code class="prism language-yaml"><span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">30000</span>  <span class="token comment">#熔断超时时间(30s)</span>
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token comment">#连接超时时间(60s)</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token comment">#读超时时间</span>
  <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment">#重试次数</span>
  <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#切换实例的重试次数</span>
</code></pre> 
<ul><li><strong>降级处理</strong></li></ul> 
<p><strong>第一种方案</strong>：<strong>fallback</strong></p> 
<p><strong>定义一个fallback类MediaServiceClientFallback，此类实现了MediaServiceClient接口</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"media-api"</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">MediaServiceClientFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaServiceClient</span><span class="token punctuation">{<!-- --></span>
    
   <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/media-api/upload/coursefile"</span><span class="token punctuation">,</span> consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"filedata"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> filedata<span class="token punctuation">,</span>
                                      <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"objectName"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p>只要是熔断了，就走下面的降级流程</p> 
<blockquote> 
 <p>因为目标的服务器有问题了，才会调用这个方法</p> 
</blockquote> 
<p>但是下面这种情况没法拿到熔断的异常，也就是为什么会导致熔断？什么导致了熔断？</p> 
<p>说白了拿不到熔断发生的原因</p> 
<pre><code class="prism language-java">
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaServiceClientFallback</span> <span class="token keyword">implements</span> <span class="token class-name">MediaServiceClient</span><span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">// 重写upload方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"filedata"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> filedata<span class="token punctuation">,</span>
                                      <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"objectName"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p>**第二种方案：fallbackFactory **</p> 
<p><strong>在FeignClient中指定fallbackFactory</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"media-api"</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>fallbackFactory  <span class="token operator">=</span> <span class="token class-name">MediaServiceClientFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MediaServiceClient</span><span class="token punctuation">{<!-- --></span>
    
   <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/media-api/upload/coursefile"</span><span class="token punctuation">,</span> consumes <span class="token operator">=</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">MULTIPART_FORM_DATA_VALUE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestPart</span><span class="token punctuation">(</span><span class="token string">"filedata"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> filedata<span class="token punctuation">,</span>
                                      <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"objectName"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>定义MediaServiceClientFallbackFactory</strong></p> 
<p>可以拿到熔断的异常信息</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MediaServiceClientFallbackFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaServiceClient</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">//可以拿到熔断的异常信息throwable</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MediaServiceClient</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MediaServiceClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 发生熔断，上游服务就会调用此方法来执行降级的逻辑</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> upload<span class="token punctuation">,</span> <span class="token class-name">String</span> objectName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//降级方法</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"调用媒资管理服务上传文件时发生熔断，异常信息:{}"</span><span class="token punctuation">,</span>throwable<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 返回值由我们来确定，走这里就说明走了降级逻辑了</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> 
<p>如果走了降级逻辑的话，我们就可以在调用的这里标注一下，然后降级的时候怎么个提示法，发出异常或者其他处理方式</p> 
<p><img src="https://images2.imgbox.com/90/53/pByHXd1U_o.png" alt="image-20240120202727158"></p> 
<h3><a id="24__786"></a>2.4 页面静态化任务</h3> 
<p>课程页面静态化和静态页面远程上传测试通过，下一步开发课程静态化功能，最终使用消息处理SDK去调度执行</p> 
<p>接下来就是完成这一步</p> 
<p><img src="https://images2.imgbox.com/57/d4/LqRPZ46b_o.png" alt=""></p> 
<p><strong>其实主要完成两步</strong></p> 
<ol><li>生成课程静态化页面</li><li>上传静态页面到文件系统</li></ol> 
<blockquote> 
 <p>Feign参考2.2</p> 
</blockquote> 
<h4><a id="241_CoursePublishServiceImpl_805"></a>2.4.1 CoursePublishServiceImpl</h4> 
<p><strong>在content-service工程</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * @description 课程静态化
 * @param courseId  课程id
 * @return File 静态化文件
 * @author Mr.M
 * @date 2022/9/23 16:59
 */</span>
<span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * @description 上传课程静态化页面
 * @param file  静态化文件
 * @return void
 * @author Mr.M
 * @date 2022/9/23 16:59
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">uploadCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">,</span><span class="token class-name">File</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li><strong>生成html页面</strong></li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 生成html页面
 *
 * @param courseId 课程id
 * @return File 静态化文件
 * @description 课程静态化
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//最终要返回的静态化文件</span>
    <span class="token class-name">File</span> htmlFile <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//TODO 准备模板</span>
        <span class="token comment">// import freemarker.template.Configuration</span>
        <span class="token comment">// new Configuration 实例时输入传入一下Configuration当前的版本</span>
        <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 找到模板路径</span>
        <span class="token class-name">String</span> classPath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定模板目录 (从哪个目录加载模板)</span>
        configuration<span class="token punctuation">.</span><span class="token function">setDirectoryForTemplateLoading</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>classPath <span class="token operator">+</span> <span class="token string">"/templates"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定编码</span>
        configuration<span class="token punctuation">.</span><span class="token function">setDefaultEncoding</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 得到模板</span>
        <span class="token class-name">Template</span> template <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getTemplate</span><span class="token punctuation">(</span><span class="token string">"course_template.ftl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//TODO 准备数据</span>
        <span class="token class-name">CoursePreviewDto</span> coursePreviewInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getCoursePreviewInfo</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"model"</span><span class="token punctuation">,</span> coursePreviewInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//TODO 将一个页面（源代码）转换成字符串</span>
        <span class="token comment">// 参数1：模板  参数2：数据</span>
        <span class="token class-name">String</span> html <span class="token operator">=</span> <span class="token class-name">FreeMarkerTemplateUtils</span><span class="token punctuation">.</span><span class="token function">processTemplateIntoString</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//TODO 使用流将静态化内容输出到文件中</span>
        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">toInputStream</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        htmlFile <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">"coursepublish"</span><span class="token operator">+</span>courseId<span class="token punctuation">,</span><span class="token string">".html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//输出流</span>
        <span class="token class-name">FileOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>htmlFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"课程静态化异常:{}，课程id：{}"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"课程静态化异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> htmlFile<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><strong>将静态html文件上传至minio</strong></li></ul> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * 将静态html文件上传至minio
     *
     * @param file 静态化文件
     * @return void
     * @description 上传课程静态化页面
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uploadCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">Long</span> courseId<span class="token punctuation">,</span> <span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">MultipartFile</span> multipartFile <span class="token operator">=</span> <span class="token class-name">MultipartSupportConfig</span><span class="token punctuation">.</span><span class="token function">getMultipartFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送Feign请求</span>
        <span class="token class-name">String</span> upload <span class="token operator">=</span> mediaServiceClient<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>multipartFile<span class="token punctuation">,</span> <span class="token string">"course/"</span> <span class="token operator">+</span> courseId <span class="token operator">+</span> <span class="token string">".html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>upload <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"远程调用走降级逻辑，得到的结果为null,课程id：{}"</span><span class="token punctuation">,</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"上传静态文件异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="242__CoursePublishTask_908"></a>2.4.2 课程发布任务类 CoursePublishTask</h4> 
<p><strong>任务调度入口</strong></p> 
<pre><code class="prism language-java"><span class="token comment">//任务调度入口</span>
<span class="token annotation punctuation">@XxlJob</span><span class="token punctuation">(</span><span class="token string">"CoursePublishJobHandler"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">coursePublishJobHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 分片参数</span>
    <span class="token keyword">int</span> shardIndex <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//第几个分片</span>
    <span class="token keyword">int</span> shardTotal <span class="token operator">=</span> <span class="token class-name">XxlJobHelper</span><span class="token punctuation">.</span><span class="token function">getShardTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//分片总数</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"shardIndex="</span><span class="token operator">+</span>shardIndex<span class="token operator">+</span><span class="token string">",shardTotal="</span><span class="token operator">+</span>shardTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//参数:分片序号、分片总数、消息类型、一次最多取到的任务数量、一次任务调度执行的超时时间</span>
    <span class="token comment">//这个方法是MessageProcessAbstract抽象类的方法</span>
    <span class="token function">process</span><span class="token punctuation">(</span>shardIndex<span class="token punctuation">,</span>shardTotal<span class="token punctuation">,</span><span class="token string">"course_publish"</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>会在此类的execute方法调用generateCourseHtml方法</p> 
<p><img src="https://images2.imgbox.com/37/ef/kBZwWp93_o.png" alt="image-20240120231135638"></p> 
<pre><code class="prism language-java">    <span class="token comment">// 实现课程静态化页面并上传至文件系统</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">generateCourseHtml</span><span class="token punctuation">(</span><span class="token class-name">MqMessage</span> message<span class="token punctuation">,</span> <span class="token keyword">long</span> courseId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 任务id（消息id）</span>
        <span class="token class-name">Long</span> taskId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过get方法获取MqMessageService消息实体类</span>
        <span class="token class-name">MqMessageService</span> mqMessageService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMqMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//TODO 做任务幂等性处理</span>
        <span class="token comment">//查询数据库取出该阶段执行状态。每一个阶段的完成都会将相应的结果写入到相应的字段</span>
        <span class="token comment">//这个地方其实就是取出的stageState1</span>
        <span class="token keyword">int</span> stageOne <span class="token operator">=</span> mqMessageService<span class="token punctuation">.</span><span class="token function">getStageOne</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stageOne <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"课程静态化任务完成，无需处理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//TODO 开始进行课程静态化</span>
<span class="token comment">//        int i = 1 / 0;//制造一个异常表示任务执行中有问题</span>
        <span class="token comment">// 1. 生成课程静态化页面</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> coursePublishService<span class="token punctuation">.</span><span class="token function">generateCourseHtml</span><span class="token punctuation">(</span>courseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">XueChengPlusException</span><span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token string">"生成的静态页面为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2. 上传静态页面到文件系统</span>
        coursePublishService<span class="token punctuation">.</span><span class="token function">uploadCourseHtml</span><span class="token punctuation">(</span>courseId<span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//TODO 任务处理完成写任务状态为完成</span>
        <span class="token comment">//也就是stageState1字段的值是1</span>
        mqMessageService<span class="token punctuation">.</span><span class="token function">completedStageOne</span><span class="token punctuation">(</span>taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/05c320adf11f1c84b63cda52a4ab3ece/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">awk做wordcount</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/227e2ec6b19c676a0e48a89992379c0e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Ubuntu 使用 git 能够 clone 但不能 push 的参考解决方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>