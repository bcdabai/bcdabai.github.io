<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>c#winform使用WebBrowser 大全 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="c#winform使用WebBrowser 大全" />
<meta property="og:description" content="C# WinForm WebBrowser (一) MSDN资料 1、主要用途：使用户可以在窗体中导航网页。
2、注意：WebBrowser 控件会占用大量资源。使用完该控件后一定要调用 Dispose 方法，以便确保及时释放所有资源。必须在附加事件的同一线程上调用 Dispose 方法，该线程应始终是消息或用户界面 (UI) 线程。
3、WebBrowser 使用下面的成员可以将控件导航到特定 URL、在导航历史记录列表中向后和向前移动，还可以加载当前用户的主页和搜索页：
1.URL属性：可读、可写，用于获取或设置当前文档的 URL。　WebBrowser 控件维护浏览会话期间访问的所有网页的历史记录列表。设置Url属性时，WebBrowser 控件导航到指定的 URL 并将该 URL 添加到历史记录列表的末尾。
WebBrowser 控件在本地硬盘的缓存中存储最近访问过的站点的网页。每个页面都可以指定一个到期日期，指示页面在缓存中保留的时间。当控件定位到某页时，如果该页具有缓存的版本，则直接显示缓存中的内容而不必重新下载该页，从而节省了时间。使用 Refresh 方法强制 WebBrowser控件通过下载来重新加载当前页，从而确保控件显示最新版本。
注意：即使已请求了另一个文档，该属性也包含当前文档的 URL。如果设置该属性的值，然后立即再次检索该值，要是 WebBrowser 控件尚未来得及加载新文档，则检索到的值可能与设置的值不同。
2.Navigate方法: 将指定位置的文档加载到 WebBrowser 控件中。
3.GoBack方法：如果导航历史记录中的上一页可用，则将 WebBrowser 控件导航到该页。
如果导航成功，则返回true；如果导航历史记录中的上一页不可用，则返回false。
WebBrowser 控件维护浏览会话期间访问的所有网页的历史记录列表。可以使用GoForward方法实现一个“后退”按钮。
使用 CanGoBack 属性确定导航历史记录是否可用以及是否包含上一页。处理 CanGoBackChanged 事件，在 CanGoBack 属性值更改时接收通知。
4.GoForward方法：如果导航历史记录中的下一页可用，则将 WebBrowser 控件导航到该页。
如果导航成功，则返回true；如果导航历史记录中的下一页不可用，则返回false。
WebBrowser 控件维护浏览会话期间访问的所有网页的历史记录列表。可以使用 GoForward 方法实现一个“前进”按钮.
使用 CanGoForward 属性确定导航历史记录是否可用以及是否包含当前页之后的页。处理 CanGoForwardChanged 事件，在 CanGoForward 属性值更改时接收通知 5.GoHome方法：将 WebBrowser 控件导航到当前用户的主页。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5e50d62f713134c1971ed4fd909f726d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2012-07-31T14:32:56+08:00" />
<meta property="article:modified_time" content="2012-07-31T14:32:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">c#winform使用WebBrowser 大全</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div> 
 <p><a href="http://www.cnblogs.com/08shiyan/archive/2011/04/21/2023679.html" rel="nofollow"><span style="color:rgb(57,154,178)">C# WinForm WebBrowser (<span style="font-family:宋体">一</span><span style="font-family:Verdana">) MSDN</span><span style="font-family:宋体">资料</span></span></a> </p> 
 <p><span style="color:rgb(51,51,51)">1<span style="font-family:宋体">、</span></span><span style="color:rgb(255,0,0)">主要用途</span><span style="color:rgb(51,51,51)">：使用户可以在窗体中导航网页。</span></p> 
 <p><span style="color:rgb(51,51,51)">2<span style="font-family:宋体">、</span></span><span style="color:rgb(255,0,0)">注意</span><span style="color:rgb(51,51,51)">：<span style="font-family:Verdana">WebBrowser </span><span style="font-family:宋体">控件会占用大量资源。使用完该控件后一定要调用</span><span style="font-family:Verdana"> Dispose </span><span style="font-family:宋体">方法，以便确保及时释放所有资源。必须在附加事件的同一线程上调用</span><span style="font-family:Verdana"> </span></span><span style="color:rgb(51,51,51)">Dispose</span><span style="color:rgb(51,51,51)"> <span style="font-family:宋体">方法，该线程应始终是消息或用户界面 </span><span style="font-family:Verdana">(UI) </span><span style="font-family:宋体">线程。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">3<span style="font-family:宋体">、</span><span style="font-family:Verdana">WebBrowser </span></span><span style="color:rgb(255,0,0)">使用下面的成员可以将控件导航到特定 <span style="font-family:Verdana">URL</span><span style="font-family:宋体">、在导航历史记录列表中向后和向前移动，还可以加载当前用户的主页和搜索页：</span></span></p> 
 <p><span style="color:rgb(51,51,51)">1.</span><span style="color:rgb(255,0,0)">URL<span style="font-family:宋体">属性</span></span><span style="color:rgb(51,51,51)">：可读、可写，用于获取或设置当前文档的 <span style="font-family:Verdana">URL</span><span style="font-family:宋体">。　</span></span></p> 
 <p><span style="color:rgb(51,51,51)">WebBrowser <span style="font-family:宋体">控件维护浏览会话期间访问的所有网页的历史记录列表。设置</span><span style="font-family:Verdana">Url</span><span style="font-family:宋体">属性时，</span><span style="font-family:Verdana">WebBrowser </span><span style="font-family:宋体">控件导航到指定的 </span><span style="font-family:Verdana">URL </span><span style="font-family:宋体">并将该 </span><span style="font-family:Verdana">URL </span><span style="font-family:宋体">添加到历史记录列表的末尾。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">WebBrowser <span style="font-family:宋体">控件在本地硬盘的缓存中存储最近访问过的站点的网页。每个页面都可以指定一个到期日期，指示页面在缓存中保留的时间。当控件定位到某页时，如果该页具有缓存的版本，则直接显示缓存中的内容而不必重新下载该页，从而节省了时间。使用</span><span style="font-family:Verdana"> Refresh </span><span style="font-family:宋体">方法强制</span><span style="font-family:Verdana"> WebBrowser</span><span style="font-family:宋体">控件通过下载来重新加载当前页，从而确保控件显示最新版本。</span></span></p> 
 <p><span style="color:rgb(255,0,0)">注意</span><span style="color:rgb(51,51,51)">：即使已请求了另一个文档，该属性也包含当前文档的 <span style="font-family:Verdana">URL</span><span style="font-family:宋体">。如果设置该属性的值，然后立即再次检索该值，要是</span><span style="font-family:Verdana"> WebBrowser </span><span style="font-family:宋体">控件尚未来得及加载新文档，则检索到的值可能与设置的值不同。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">2.</span><span style="color:rgb(255,0,0)">Navigate<span style="font-family:宋体">方法</span><span style="font-family:Verdana">: </span></span>将指定位置的文档加载到<span style="font-family:Verdana"> WebBrowser </span><span style="font-family:宋体">控件中。</span></p> 
 <p>3.<span style="color:rgb(255,0,0)">GoBack<span style="font-family:宋体">方法：</span></span>如果导航历史记录中的上一页可用，则将<span style="font-family:Verdana"> WebBrowser </span><span style="font-family:宋体">控件导航到该页。</span></p> 
 <p>如果导航成功，则返回<span style="font-family:Verdana">true</span><span style="font-family:宋体">；如果导航历史记录中的上一页不可用，则返回</span><span style="font-family:Verdana">false</span><span style="font-family:宋体">。</span></p> 
 <p> <span style="color:rgb(51,51,51)">WebBrowser <span style="font-family:宋体">控件维护浏览会话期间访问的所有网页的历史记录列表。可以使用</span><span style="font-family:Verdana">GoForward</span><span style="font-family:宋体">方法实现一个</span><span style="font-family:Verdana">“</span><span style="font-family:宋体">后退</span><span style="font-family:Verdana">”</span><span style="font-family:宋体">按钮。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">使用<span style="font-family:Verdana"> CanGoBack </span><span style="font-family:宋体">属性确定导航历史记录是否可用以及是否包含上一页。处理</span><span style="font-family:Verdana"> CanGoBackChanged </span><span style="font-family:宋体">事件，在</span><span style="font-family:Verdana"> CanGoBack </span><span style="font-family:宋体">属性值更改时接收通知。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">4.</span><span style="color:rgb(255,0,0)">GoForward<span style="font-family:宋体">方法：</span></span><span style="color:rgb(51,51,51)">如果导航历史记录中的下一页可用，则将<span style="font-family:Verdana"> WebBrowser </span><span style="font-family:宋体">控件导航到该页。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">如果导航成功，则返回<span style="font-family:Verdana">true</span><span style="font-family:宋体">；如果导航历史记录中的下一页不可用，则返回</span><span style="font-family:Verdana">false</span><span style="font-family:宋体">。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">WebBrowser <span style="font-family:宋体">控件维护浏览会话期间访问的所有网页的历史记录列表。可以使用</span><span style="font-family:Verdana"> GoForward </span><span style="font-family:宋体">方法实现一个</span><span style="font-family:Verdana">“</span><span style="font-family:宋体">前进</span><span style="font-family:Verdana">”</span><span style="font-family:宋体">按钮</span><span style="font-family:Verdana">.</span></span></p> 
 <p><span style="color:rgb(51,51,51)">使用<span style="font-family:Verdana"> CanGoForward </span><span style="font-family:宋体">属性确定导航历史记录是否可用以及是否包含当前页之后的页。处理</span><span style="font-family:Verdana"> CanGoForwardChanged </span><span style="font-family:宋体">事件，在</span><span style="font-family:Verdana"> CanGoForward </span><span style="font-family:宋体">属性值更改时接收通知</span><span style="font-family:Verdana"> </span></span></p> 
 <p><span style="color:rgb(51,51,51)">　　<span style="font-family:Verdana">5.</span></span><span style="color:rgb(255,0,0)">GoHome<span style="font-family:宋体">方法</span></span><span style="color:rgb(51,51,51)">：将<span style="font-family:Verdana"> WebBrowser </span><span style="font-family:宋体">控件导航到当前用户的主页。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">　　<span style="font-family:Verdana">6.</span></span><span style="color:rgb(255,0,0)">GoSearch<span style="font-family:宋体">方法</span></span><span style="color:rgb(51,51,51)">：将<span style="font-family:Verdana"> WebBrowser </span><span style="font-family:宋体">控件导航到当前用户的默认搜索页。</span><span style="font-family:Verdana"> </span></span></p> 
 <p><span style="color:rgb(51,51,51)">　　　　默认搜索页存储在注册表的<span style="font-family:Verdana"> </span></span><span style="color:rgb(51,51,51)">HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\Main\Search Page</span><span style="color:rgb(51,51,51)"> <span style="font-family:宋体">注册表项下。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">　　　　若要使用其他搜索页而不是默认搜索页，请调用<span style="font-family:Verdana"> Navigate </span><span style="font-family:宋体">方法或指定</span><span style="font-family:Verdana"> Url </span><span style="font-family:宋体">属性。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">　　<span style="font-family:Verdana">7.</span></span><span style="color:rgb(255,0,0)">Refresh<span style="font-family:宋体">方法</span></span><span style="color:rgb(51,51,51)">：重新加载当前显示在<span style="font-family:Verdana"> WebBrowser </span><span style="font-family:宋体">控件中的文档。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">　　<span style="font-family:Verdana">8.</span></span><span style="color:rgb(255,0,0)">Stop<span style="font-family:宋体">方法</span></span><span style="color:rgb(51,51,51)">：取消所有挂起的导航并停止所有动态页元素（如背景声音和动画）。</span></p> 
 <p><span style="color:rgb(51,51,51)">如果导航不成功，则显示一页指示出现的问题。使用这些成员中的任何一个进行导航都会导致在导航的不同阶段发生<span style="font-family:Verdana"> Navigating</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">Navigated </span><span style="font-family:宋体">和</span><span style="font-family:Verdana">DocumentCompleted </span><span style="font-family:宋体">事件。</span></span></p> 
 <p><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">4<span style="font-family:宋体">、</span></span><span style="color:rgb(255,0,0)">ObjectForScripting <span style="font-family:宋体">属性</span></span><span style="color:rgb(51,51,51)">：获取或设置一个对象，该对象可由显示在<span style="font-family:Verdana"> WebBrowser </span><span style="font-family:宋体">控件中的网页所包含的脚本代码访问。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">使用该属性启用<span style="font-family:Verdana"> WebBrowser </span><span style="font-family:宋体">控件承载的网页与包含</span><span style="font-family:Verdana"> WebBrowser </span><span style="font-family:宋体">控件的应用程序之间的通信。使用该属性可以将动态 </span><span style="font-family:Verdana">HTML (DHTML) </span><span style="font-family:宋体">代码与客户端应用程序代码集成在一起。为该属性指定的对象可作为</span><span style="font-family:Verdana"> window</span></span><span style="color:rgb(51,51,51)">.</span><span style="color:rgb(51,51,51)">external <span style="font-family:宋体">对象（用于主机访问的内置 </span><span style="font-family:Verdana">DOM </span><span style="font-family:宋体">对象）用于网页脚本。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">可以将此属性设置为希望其公共属性和方法可用于脚本代码的任何 <span style="font-family:Verdana">COM </span><span style="font-family:宋体">可见的对象。可以通过使用</span><span style="font-family:Verdana"> ComVisibleAttribute </span><span style="font-family:宋体">对类进行标记使其成为 </span><span style="font-family:Verdana">COM </span><span style="font-family:宋体">可见的类。</span></span></p> 
 <p><span style="color:rgb(255,0,0)">若要从客户端应用程序代码调用网页中定义的函数，请使用可从<span style="font-family:Verdana"> Document </span><span style="font-family:宋体">属性检索的</span><span style="font-family:Verdana"> HtmlDocument </span><span style="font-family:宋体">对象的</span><span style="font-family:Verdana"> HtmlDocument</span></span><a href="http://msdn.microsoft.com/zh-cn/library/system.windows.forms.htmldocument.invokescript%28v=vs.80%29.aspx" rel="nofollow"><span style="color:rgb(255,0,0)">.</span></a><span style="color:rgb(255,0,0)">InvokeScript <span style="font-family:宋体">方法</span></span><span style="color:rgb(128,0,0)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">5<span style="font-family:宋体">、</span></span><span style="color:rgb(255,0,0)">AllowNavigation<span style="font-family:宋体">属性</span></span><span style="color:rgb(51,51,51)">：获取或设置一个值，该值指示控件在加载其初始页之后是否可以导航到其他页。</span></p> 
 <p><span style="color:rgb(51,51,51)">6<span style="font-family:宋体">、</span></span><span style="color:rgb(255,0,0)">AllowWebBrowserDrop<span style="font-family:宋体">属性</span></span><span style="color:rgb(51,51,51)">：获取或设置一个值，该值指示<span style="font-family:Verdana"> WebBrowser </span><span style="font-family:宋体">控件是否导航到拖放到它上面的文档。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">7<span style="font-family:宋体">、</span><span style="font-family:Verdana">WebBrowserShortcutsEnabled</span><span style="font-family:宋体">属性：是否启用</span><span style="font-family:Verdana">WebBrowser</span><span style="font-family:宋体">自带的快捷键。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">8<span style="font-family:宋体">、</span><span style="font-family:Verdana">ScriptErrorsSuppressed </span><span style="font-family:宋体">属性：获取或设置一个值，该值指示出现脚本错误时，</span><span style="font-family:Verdana">WebBrowser </span><span style="font-family:宋体">控件是否显示错误对话框。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">9<span style="font-family:宋体">、</span><span style="font-family:Verdana">IsWebBrowserContextMenuEnabled</span><span style="font-family:宋体">属性：是否启用右键菜单。</span></span></p> 
 <p><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">源：<span style="font-family:Verdana">MSDN </span></span><a href="http://msdn.microsoft.com/zh-cn/library/system.windows.forms.webbrowser%28v=vs.80%29.aspx" rel="nofollow"><span style="color:rgb(0,0,0)">http://msdn.microsoft.com/zh-cn/library/system.windows.forms.webbrowser(v=vs.80).aspx</span></a></p> 
 <p></p> 
 <p><a href="http://www.cnblogs.com/08shiyan/archive/2011/04/22/2023861.html" rel="nofollow"><span style="color:rgb(57,154,178)">C#WinForm WebBrowser (<span style="font-family:宋体">二</span><span style="font-family:Verdana">) </span><span style="font-family:宋体">实用方法总结</span></span></a> </p> 
 <p><span style="color:rgb(255,0,0)">实用方法<span style="font-family:Verdana">1</span><span style="font-family:宋体">：获取状态栏信息</span></span></p> 
 <p style="background:rgb(245,245,245)"><span style="color:rgb(0,0,255)">void</span> webBrowser1_StatusTextChanged(<span style="color:rgb(0,0,255)">object</span> sender, EventArgs e)<br> {<!-- --><br>     label1.Text = webBrowser1.StatusText;<br> }</p> 
 <p><span style="color:rgb(255,0,0)">实用方法<span style="font-family:Verdana">2</span><span style="font-family:宋体">：页面跳转后改变地址栏地址</span></span></p> 
 <p style="background:rgb(245,245,245)">//<span style="font-family:宋体">在</span><span style="font-family:Courier New">Navigated</span><span style="font-family:宋体">事件处理函数中改变地址栏地址是最恰当的：</span><br> <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">void</span> webBrowser1_Navigated(<span style="color:rgb(0,0,255)">object</span> sender, WebBrowserNavigatedEventArgs e)<br> {<!-- --><br>     textBox1.Text = webBrowser1.Url.ToString();<br> }</p> 
 <p><span style="color:rgb(255,0,0)">实用方法<span style="font-family:Verdana">3</span><span style="font-family:宋体">：设置单选框</span></span></p> 
 <p style="background:rgb(245,245,245)">//<span style="font-family:宋体">建议使用执行单击事件的方式来设置单选框，而不是修改属性：</span><br> webBrowser1.Document.GetElementById(<span style="color:rgb(128,0,0)">"RBT_A"</span>).InvokeMember(<span style="color:rgb(128,0,0)">"click"</span>);</p> 
 <p><span style="color:rgb(255,0,0)">实用方法<span style="font-family:Verdana">4</span><span style="font-family:宋体">：设置联动型下拉列表</span></span></p> 
 <p style="background:rgb(245,245,245)">//<span style="font-family:宋体">比较常见的联动型多级下拉列表就是省</span><span style="font-family:Courier New">/</span><span style="font-family:宋体">市县选择了，这种情况下直接设置选择项的属性不会触发联动，需要在最后执行触发事件函数才能正常工作：</span><br> <br> <span style="color:rgb(0,0,255)">foreach</span> (HtmlElement f <span style="color:rgb(0,0,255)">in</span> s.GetElementsByTagName(<span style="color:rgb(128,0,0)">"option"</span>))<br> {<!-- --><br>     <span style="color:rgb(0,0,255)">if</span> (f.InnerText == <span style="color:rgb(128,0,0)">"<span style="font-family:宋体">北京</span><span style="font-family:Courier New">"</span></span>)<br>     {<!-- --><br>         f.SetAttribute(<span style="color:rgb(128,0,0)">"selected"</span>, <span style="color:rgb(128,0,0)">"selected"</span>);<br>     }<br>     <span style="color:rgb(0,0,255)">else</span><br>     {<!-- --><br>         f.SetAttribute(<span style="color:rgb(128,0,0)">"selected"</span>, <span style="color:rgb(128,0,0)">""</span>);<br>     }<br> }<br> s.RaiseEvent(<span style="color:rgb(128,0,0)">"onchange"</span>);</p> 
 <p><span style="color:rgb(51,51,51)">以上四种方法转于：</span><a href="http://www.cnblogs.com/SkyD/archive/2009/04/23/1441696.html" rel="nofollow"><span style="color:rgb(0,0,0)">http://www.cnblogs.com/SkyD/archive/2009/04/23/1441696.html</span></a></p> 
 <p><span style="color:rgb(255,0,0)">实用方法一：在<span style="font-family:Verdana">WinForm</span><span style="font-family:宋体">中相应</span><span style="font-family:Verdana">Web</span><span style="font-family:宋体">事件</span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">假设<span style="font-family:Verdana">HTML</span><span style="font-family:宋体">源代码如下：</span></span></p> 
 <p style="background:rgb(245,245,245)"><span style="color:rgb(0,0,255)">&lt;</span><span style="color:rgb(128,0,0)">html</span><span style="color:rgb(0,0,255)">&gt;</span> <br> <span style="color:rgb(0,0,255)">&lt;</span><span style="color:rgb(128,0,0)">body</span><span style="color:rgb(0,0,255)">&gt;</span> <br> <span style="color:rgb(0,0,255)">&lt;</span><span style="color:rgb(128,0,0)">input </span><span style="color:rgb(255,0,0)">type</span><span style="color:rgb(0,0,255)">="button"</span><span style="color:rgb(255,0,0)"> id</span><span style="color:rgb(0,0,255)">="btnClose"</span><span style="color:rgb(255,0,0)"> value</span><span style="color:rgb(0,0,255)">="<span style="font-family:宋体">关闭</span><span style="font-family:Courier New">"</span></span><span style="color:rgb(255,0,0)"> </span><span style="color:rgb(0,0,255)">/&gt;</span> <br> <span style="color:rgb(0,0,255)">&lt;/</span><span style="color:rgb(128,0,0)">body</span><span style="color:rgb(0,0,255)">&gt;</span> <br> <span style="color:rgb(0,0,255)">&lt;/</span><span style="color:rgb(128,0,0)">html</span><span style="color:rgb(0,0,255)">&gt;</span></p> 
 <p><span style="color:rgb(51,51,51)">  </span></p> 
 <p style="background:rgb(245,245,245)">HtmlDocument htmlDoc = webBrowser.Document; <br> HtmlElement btnElement = htmlDoc.All[<span style="color:rgb(128,0,0)">"btnClose"</span>]; <br> <span style="color:rgb(0,0,255)">if</span> (btnElement != <span style="color:rgb(0,0,255)">null</span>) <br> { <br>     btnElement.click += <span style="color:rgb(0,0,255)">new</span> HtmlElementEventHandler(HtmlBtnClose_Click); <br> }</p> 
 <p style="background:rgb(245,245,245)"><br> //<span style="font-family:宋体">很简单吧？那么稍稍高级一点的</span><span style="font-family:Courier New">——</span><span style="font-family:宋体">我们都知道一个</span><span style="font-family:Courier New">HTML</span><span style="font-family:宋体">元素可能有很多各种各样的事件，而</span><span style="font-family:Courier New">HtmlElement</span><span style="font-family:宋体">这个类只给出最常用、共通的几个。那么，如何响应其他事件呢？这也很简单，只需要调用</span><span style="font-family:Courier New">HtmlElement</span><span style="font-family:宋体">的</span><span style="font-family:Courier New">AttachEventHandler</span><span style="font-family:宋体">就可以了：</span></p> 
 <p style="background:rgb(245,245,245)"><span style="color:rgb(51,51,51)">btnElement.AttachEventHandler("onclick", new EventHandler(HtmlBtnClose_Click));  </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">//<span style="font-family:宋体">这一句等价于上面的</span><span style="font-family:Courier New">btnElement.click += new HtmlElementEventHandler(HtmlBtnClose_Click); </span></span><span style="color:rgb(51,51,51)"><br> </span></p> 
 <p><span style="color:rgb(51,51,51)">对于其他事件，把<span style="font-family:Verdana">"onclick"</span><span style="font-family:宋体">换成该事件的名字就可以了。例如：</span></span></p> 
 <p style="background:rgb(245,245,245)">formElement.AttachEventHandler(<span style="color:rgb(128,0,0)">"onsubmit"</span>, <span style="color:rgb(0,0,255)">new</span> EventHandler(HtmlForm_Submit)); </p> 
 <p><span style="color:rgb(51,51,51)">  </span></p> 
 <p><span style="color:rgb(255,0,0)">实用方法二：模拟表单自动填写和提交</span></p> 
 <p><span style="color:rgb(51,51,51)">假设有一个最简单的登录页面，输入用户名密码，点<span style="font-family:Verdana">“</span><span style="font-family:宋体">登录</span><span style="font-family:Verdana">”</span><span style="font-family:宋体">按钮即可登录。已知用户名输入框的</span><span style="font-family:Verdana">id</span><span style="font-family:宋体">（或</span><span style="font-family:Verdana">Name</span><span style="font-family:宋体">，下同）是</span><span style="font-family:Verdana">username</span><span style="font-family:宋体">，密码输入框的</span><span style="font-family:Verdana">id</span><span style="font-family:宋体">是</span><span style="font-family:Verdana">password</span><span style="font-family:宋体">，</span><span style="font-family:Verdana">“</span><span style="font-family:宋体">登录</span><span style="font-family:Verdana">”</span><span style="font-family:宋体">按钮的</span><span style="font-family:Verdana">id</span><span style="font-family:宋体">是</span><span style="font-family:Verdana">submitbutton</span><span style="font-family:宋体">，那么我们只需要在</span><span style="font-family:Verdana">webBrowser</span><span style="font-family:宋体">的</span><span style="font-family:Verdana">DocumentCompleted</span><span style="font-family:宋体">事件中使用下面的代码即可：</span></span></p> 
 <p style="background:rgb(245,245,245)">HtmlElement btnSubmit = webBrowser.Document.All[<span style="color:rgb(128,0,0)">"submitbutton"</span>]; <br> HtmlElement tbUserid = webBrowser.Document.All[<span style="color:rgb(128,0,0)">"username"</span>]; <br> HtmlElement tbPasswd = webBrowser.Document.All[<span style="color:rgb(128,0,0)">"password"</span>]; <br> <br> <span style="color:rgb(0,0,255)">if</span> (tbUserid == <span style="color:rgb(0,0,255)">null</span> || tbPasswd == <span style="color:rgb(0,0,255)">null</span> || btnSubmit == <span style="color:rgb(0,0,255)">null</span>) <br>     <span style="color:rgb(0,0,255)">return</span>; <br> <br> tbUserid.SetAttribute(<span style="color:rgb(128,0,0)">"value"</span>, <span style="color:rgb(128,0,0)">"smalldust"</span>); <br> tbPasswd.SetAttribute(<span style="color:rgb(128,0,0)">"value"</span>, <span style="color:rgb(128,0,0)">"12345678"</span>); <br> <br> btnSubmit.InvokeMember(<span style="color:rgb(128,0,0)">"click"</span>);</p> 
 <p><span style="color:rgb(51,51,51)">关于表单的提交，的确还有另一种方法就是获取<span style="font-family:Verdana">form</span><span style="font-family:宋体">元素而不是</span><span style="font-family:Verdana">button</span><span style="font-family:宋体">，并用</span><span style="font-family:Verdana">form</span><span style="font-family:宋体">元素的</span><span style="font-family:Verdana">submit</span><span style="font-family:宋体">方法：</span></span></p> 
 <p style="background:rgb(245,245,245)">HtmlElement formLogin = webBrowser.Document.Forms[<span style="color:rgb(128,0,0)">"loginForm"</span>];  <br> <span style="color:rgb(0,128,0)">//……  </span><span style="color:rgb(0,128,0)"><br> </span>formLogin.InvokeMember(<span style="color:rgb(128,0,0)">"submit"</span>); </p> 
 <p><span style="color:rgb(51,51,51)">本文之所以没有推荐这种方法，是因为现在的网页，很多都在<span style="font-family:Verdana">submit</span><span style="font-family:宋体">按钮上添加</span><span style="font-family:Verdana">onclick</span><span style="font-family:宋体">事件，以对提交的内容做最基本的验证。如果直接使用</span><span style="font-family:Verdana">form</span><span style="font-family:宋体">的</span><span style="font-family:Verdana">submit</span><span style="font-family:宋体">方法，这些验证代码就得不到执行，有可能会引起错误。</span><span style="font-family:Verdana"> </span></span></p> 
 <p><span style="color:rgb(255,0,0)">实用方法三</span><span style="color:rgb(51,51,51)">：调用脚本</span></p> 
 <p><span style="color:rgb(51,51,51)">首先是调用<span style="font-family:Verdana">Web</span><span style="font-family:宋体">页面的脚本中已经定义好的函数。假设</span><span style="font-family:Verdana">HTML</span><span style="font-family:宋体">中有如下</span><span style="font-family:Verdana">Javascript</span><span style="font-family:宋体">：</span></span></p> 
 <p style="background:rgb(245,245,245)"><span style="color:rgb(0,0,255)">function</span> DoAdd(a, b) {<!-- --><br>     <span style="color:rgb(0,0,255)">return</span> a + b;<br> }</p> 
 <p><span style="color:rgb(51,51,51)">那么，我们要在<span style="font-family:Verdana">WinForm</span><span style="font-family:宋体">调用它，只需如下代码即可：</span></span></p> 
 <p style="background:rgb(245,245,245)"><span style="color:rgb(0,0,255)">object</span> oSum = webBrowser.Document.InvokeScript(<span style="color:rgb(128,0,0)">"DoAdd"</span>, <span style="color:rgb(0,0,255)">new</span> <span style="color:rgb(0,0,255)">object</span>[] { <span style="color:rgb(128,0,128)">1</span>, <span style="color:rgb(128,0,128)">2</span> });<br> <span style="color:rgb(0,0,255)">int</span> sum = Convert.ToInt32(oSum);</p> 
 <p><span style="color:rgb(51,51,51)"> </span></p> 
 <p><span style="color:rgb(51,51,51)">其次，如果我们想执行一段<span style="font-family:Verdana">Web</span><span style="font-family:宋体">页面中原本没有的脚本，该怎么做呢？这次</span><span style="font-family:Verdana">.Net</span><span style="font-family:宋体">的类没有提供，看来还要依靠</span><span style="font-family:Verdana">COM</span><span style="font-family:宋体">了。</span><span style="font-family:Verdana">IHTMLWindow2</span><span style="font-family:宋体">可以将任意的字符串作为脚本代码来执行。</span></span></p> 
 <p style="background:rgb(245,245,245)"><span style="color:rgb(0,0,255)">string</span> scriptline01 = <span style="color:rgb(128,0,0)">@"function ShowPageInfo() {"</span>;<br> <span style="color:rgb(0,0,255)">string</span> scriptline02 = <span style="color:rgb(128,0,0)">@"     var numLinks = document.links.length; "</span>;<br> <span style="color:rgb(0,0,255)">string</span> scriptline03 = <span style="color:rgb(128,0,0)">@"     var numForms = document.forms.length; "</span>;<br> <span style="color:rgb(0,0,255)">string</span> scriptline04 = <span style="color:rgb(128,0,0)">@"     var numImages = document.images.length; "</span>;<br> <span style="color:rgb(0,0,255)">string</span> scriptline05 = <span style="color:rgb(128,0,0)">@"     var numScripts = document.scripts.length; "</span>;<br> <span style="color:rgb(0,0,255)">string</span> scriptline06 = <span style="color:rgb(128,0,0)">@"     alert('<span style="font-family:宋体">网页的统计结果：</span><span style="font-family:Courier New">\r\n</span><span style="font-family:宋体">链接数：</span><span style="font-family:Courier New">' + numLinks + "</span></span>;<br> <span style="color:rgb(0,0,255)">string</span> scriptline07 = <span style="color:rgb(128,0,0)">@"        '\r\n<span style="font-family:宋体">表单数：</span><span style="font-family:Courier New">' + numForms + "</span></span>;<br> <span style="color:rgb(0,0,255)">string</span> scriptline08 = <span style="color:rgb(128,0,0)">@"        '\r\n<span style="font-family:宋体">图像数：</span><span style="font-family:Courier New">' + numImages + "</span></span>;<br> <span style="color:rgb(0,0,255)">string</span> scriptline09 = <span style="color:rgb(128,0,0)">@"        '\r\n<span style="font-family:宋体">脚本数：</span><span style="font-family:Courier New">' + numScripts);}"</span></span>;<br> <span style="color:rgb(0,0,255)">string</span> scriptline10 = <span style="color:rgb(128,0,0)">@"ShowPageInfo();"</span>;<br> <br> <span style="color:rgb(0,0,255)">string</span> strScript = scriptline01 + scriptline02 + scriptline03 + scriptline04 + scriptline05 +<br>                    scriptline06 + scriptline07 + scriptline08 + scriptline09 + scriptline10;<br> <br> IHTMLWindow2 win = (IHTMLWindow2)webBrowser.Document.Window.DomWindow;<br> win.execScript(strScript, <span style="color:rgb(128,0,0)">"Javascript"</span>);<br>  </p> 
 <p><span style="color:rgb(51,51,51)">以上三种实用方法转于：</span><a href="http://www.cnblogs.com/smalldust/archive/2006/03/08/345561.html" rel="nofollow"><span style="color:rgb(0,0,0)">http://www.cnblogs.com/smalldust/archive/2006/03/08/345561.html</span></a></p> 
 <p><span style="color:rgb(51,51,51)">最后：</span><span style="color:rgb(255,0,0)">在脚本中调用<span style="font-family:Verdana">WinForm</span><span style="font-family:宋体">里的代码</span></span><span style="color:rgb(51,51,51)">，这个可能吗？ 呵呵，当然是可能的。</span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">下面的代码示例演示如何使用<span style="font-family:Verdana"> </span></span><span style="color:rgb(51,51,51)">ObjectForScripting</span><span style="color:rgb(51,51,51)"> <span style="font-family:宋体">属性。在该示例中，</span></span><span style="color:rgb(51,51,51)">ObjectForScripting</span><span style="color:rgb(51,51,51)"> <span style="font-family:宋体">属性被设置为当前窗体。</span></span></p> 
 <p><a href="#viewSource" rel="nofollow" title="view source"><span style="color:rgb(0,0,0)">view source</span></a><a href="#printSource" rel="nofollow" title="print"><span style="color:rgb(0,0,0)">print</span></a><a href="#about" rel="nofollow" title="?"><span style="color:rgb(0,0,0)">?</span></a></p> 
 <table><tbody><tr><td> <p><span style="color:rgb(51,51,51)">using</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">System; </span></p> </td></tr><tr><td width="218" colspan="2"> <p><span style="color:rgb(51,51,51)">using</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">System.Windows.Forms; </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td width="274" colspan="2"> <p><span style="color:rgb(51,51,51)">using</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">System.Security.Permissions; </span></p> </td></tr><tr><td> <p><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)"> </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td> <p><span style="color:rgb(51,51,51)">[PermissionSet(SecurityAction.Demand, Name="FullTrust")] </span></p> </td></tr><tr><td width="470" colspan="2"> <p><span style="color:rgb(51,51,51)">[System.Runtime.InteropServices.ComVisibleAttribute(true)] </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td width="199" colspan="2"> <p><span style="color:rgb(51,51,51)">public</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">class</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">Form1 : Form </span></p> </td></tr><tr><td> <p><span style="color:rgb(51,51,51)">{ </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td width="431" colspan="2"> <p><span style="color:rgb(51,51,51)">    private</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">WebBrowser webBrowser1 = new</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">WebBrowser(); </span></p> </td></tr><tr><td> <p><span style="color:rgb(51,51,51)">    private</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">Button button1 = new</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">Button(); </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td> <p><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)"> </span></p> </td></tr><tr><td width="126" colspan="2"> <p><span style="color:rgb(51,51,51)">    [STAThread] </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td width="228" colspan="2"> <p><span style="color:rgb(51,51,51)">    public</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">static</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">void</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">Main() </span></p> </td></tr><tr><td> <p><span style="color:rgb(51,51,51)">    { </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td width="334" colspan="2"> <p><span style="color:rgb(51,51,51)">        Application.EnableVisualStyles(); </span></p> </td></tr><tr><td> <p><span style="color:rgb(51,51,51)">        Application.Run(new</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">Form1()); </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td width="46" colspan="2"> <p><span style="color:rgb(51,51,51)">    } </span></p> </td></tr><tr><td> <p><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)"> </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td width="146" colspan="2"> <p><span style="color:rgb(51,51,51)">    public</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">Form1() </span></p> </td></tr><tr><td> <p><span style="color:rgb(51,51,51)">    { </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td width="478" colspan="2"> <p><span style="color:rgb(51,51,51)">        button1.Text = "call script code from client code"; </span></p> </td></tr><tr><td> <p><span style="color:rgb(51,51,51)">        button1.Dock = DockStyle.Top; </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td width="458" colspan="2"> <p><span style="color:rgb(51,51,51)">        button1.Click += new</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">EventHandler(button1_Click); </span></p> </td></tr><tr><td> <p><span style="color:rgb(51,51,51)">        webBrowser1.Dock = DockStyle.Fill; </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td width="278" colspan="2"> <p><span style="color:rgb(51,51,51)">        Controls.Add(webBrowser1); </span></p> </td></tr><tr><td> <p><span style="color:rgb(51,51,51)">        Controls.Add(button1); </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td width="362" colspan="2"> <p><span style="color:rgb(51,51,51)">        Load += new</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">EventHandler(Form1_Load); </span></p> </td></tr><tr><td> <p><span style="color:rgb(51,51,51)">    } </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td> <p><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)"> </span></p> </td></tr><tr><td width="436" colspan="2"> <p><span style="color:rgb(51,51,51)">    private</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">void</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">Form1_Load(object</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">sender, EventArgs e) </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td> <p><span style="color:rgb(51,51,51)">    { </span></p> </td></tr><tr><td width="390" colspan="2"> <p><span style="color:rgb(51,51,51)">        webBrowser1.AllowWebBrowserDrop = false; </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td width="478" colspan="2"> <p><span style="color:rgb(51,51,51)">        webBrowser1.IsWebBrowserContextMenuEnabled = false; </span></p> </td></tr><tr><td> <p><span style="color:rgb(51,51,51)">        webBrowser1.WebBrowserShortcutsEnabled = false; </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td> <p><span style="color:rgb(51,51,51)">        webBrowser1.ObjectForScripting = this; </span></p> </td></tr><tr><td width="559" colspan="2"> <p><span style="color:rgb(51,51,51)">        // Uncomment the following line when you are finished debugging. </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td width="422" colspan="2"> <p><span style="color:rgb(51,51,51)">        //webBrowser1.ScriptErrorsSuppressed = true; </span></p> </td></tr><tr><td> <p><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)"> </span></p> </td></tr></tbody></table> 
 <table><tbody><tr><td> <p><span style="color:rgb(51,51,51)">        webBrowser1.DocumentText = </span></p> </td></tr><tr><td width="290" colspan="2"> <p><span style="color:rgb(51,51,51)">            "&lt;html&gt;&lt;head&gt;&lt;script&gt;"</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">+ </span></p> </td></tr></tbody></table> 
 <p><a href="http://www.cnblogs.com/08shiyan/archive/2011/04/23/2024483.html" rel="nofollow"><span style="color:rgb(57,154,178)">C# WinForm WebBrowser (<span style="font-family:宋体">三</span><span style="font-family:Verdana">) </span><span style="font-family:宋体">编辑模式</span></span></a> </p> 
 <p><span style="color:rgb(51,51,51)">一、启用编辑模式、 浏览模式 及 自动换行</span></p> 
 <p style="background:rgb(245,245,245)"> <br>         <span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> </span><span style="color:rgb(128,128,128)">&lt;summary&gt;</span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(0,128,0)">        </span><span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> 编辑模式</span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(0,128,0)">        </span><span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> </span><span style="color:rgb(128,128,128)">&lt;/summary&gt;</span><span style="color:rgb(128,128,128)"><br> </span>        <span style="color:rgb(0,0,255)">public</span> <span style="color:rgb(0,0,255)">void</span> EditMode()<br>         {<!-- --><br>             <span style="color:rgb(0,0,255)">if</span> (<span style="color:rgb(0,0,255)">this</span>.webBrowser.Document != <span style="color:rgb(0,0,255)">null</span>)<br>             {<!-- --><br>                 mshtml.IHTMLDocument2 doc = <span style="color:rgb(0,0,255)">this</span>.webBrowser.Document.DomDocument <span style="color:rgb(0,0,255)">as</span> mshtml.IHTMLDocument2;<br>                 <span style="color:rgb(0,0,255)">if</span> (doc != <span style="color:rgb(0,0,255)">null</span>)<br>                 {<!-- --><br>                     doc.designMode = <span style="color:rgb(128,0,0)">"on"</span>;<br>                 }<br>             }<br>         }<br> <br>         <span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> </span><span style="color:rgb(128,128,128)">&lt;summary&gt;</span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(0,128,0)">        </span><span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> 启用浏览模式</span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(0,128,0)">        </span><span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> </span><span style="color:rgb(128,128,128)">&lt;/summary&gt;</span><span style="color:rgb(128,128,128)"><br> </span>        <span style="color:rgb(0,0,255)">public</span> <span style="color:rgb(0,0,255)">void</span> BrowseMode()<br>         {<!-- --><br>             <span style="color:rgb(0,0,255)">if</span> (<span style="color:rgb(0,0,255)">this</span>.webBrowser.Document != <span style="color:rgb(0,0,255)">null</span>)<br>             {<!-- --><br>                 mshtml.IHTMLDocument2 doc = <span style="color:rgb(0,0,255)">this</span>.webBrowser.Document.DomDocument <span style="color:rgb(0,0,255)">as</span> mshtml.IHTMLDocument2;<br>                 <span style="color:rgb(0,0,255)">if</span> (doc != <span style="color:rgb(0,0,255)">null</span>)<br>                 {<!-- --><br>                     doc.designMode = <span style="color:rgb(128,0,0)">"off"</span>;<br>                 }<br>             }<br>         }<br> <br>         <span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> </span><span style="color:rgb(128,128,128)">&lt;summary&gt;</span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(0,128,0)">        </span><span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> 设置自动换行</span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(0,128,0)">        </span><span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> </span><span style="color:rgb(128,128,128)">&lt;/summary&gt;</span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(0,128,0)">        </span><span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> </span><span style="color:rgb(128,128,128)">&lt;param name="value"&gt;&lt;/param&gt;</span><span style="color:rgb(128,128,128)"><br> </span>        <span style="color:rgb(0,0,255)">public</span> <span style="color:rgb(0,0,255)">void</span> SetAutoWrap(<span style="color:rgb(0,0,255)">bool</span> value)<br>         {<!-- --><br>             mshtml.HTMLDocument doc = <span style="color:rgb(0,0,255)">this</span>.webBrowser.Document.DomDocument <span style="color:rgb(0,0,255)">as</span> mshtml.HTMLDocument;<br>             <span style="color:rgb(0,0,255)">if</span> (doc != <span style="color:rgb(0,0,255)">null</span>)<br>             {<!-- --><br>                 mshtml.HTMLBody body = doc.body <span style="color:rgb(0,0,255)">as</span> mshtml.HTMLBody;<br>                 <span style="color:rgb(0,0,255)">if</span> (body != <span style="color:rgb(0,0,255)">null</span>)<br>                 {<!-- --><br>                     body.noWrap = !value;<br>                 }<br>             }<br>         }</p> 
 <p><span style="color:rgb(51,51,51)">在编辑模式下，可以使用：</span></p> 
 <p style="background:rgb(245,245,245)">  <span style="color:rgb(0,0,255)">this</span>.webBrowser.Document.ExecCommand([string],[bool],[object]);</p> 
 <p><span style="color:rgb(51,51,51)">方法来操作<span style="font-family:Verdana">WebBrowser</span><span style="font-family:宋体">中的</span><span style="font-family:Verdana">HTML</span><span style="font-family:宋体">。</span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">其中第一个字符串类型的参数为：</span><span style="color:rgb(255,0,0)">要执行的命令的名称<span style="font-family:Verdana"> </span></span><span style="color:rgb(51,51,51)">。</span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">第二个布尔类型的参数为：<span style="font-family:Verdana"> </span></span><span style="color:rgb(255,0,0)">是否向用户显示命令特定的对话框或消息框</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">第三个<span style="font-family:Verdana">Object</span><span style="font-family:宋体">类型的参数为：</span></span><span style="color:rgb(255,0,0)">要使用该命令分配的值。并非适用于所有命令</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">常见的命令有：</span></p> 
 <p style="background:rgb(245,245,245)"><span style="color:rgb(0,0,255)">        private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_BOLD = <span style="color:rgb(128,0,0)">"Bold"</span>;                       <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">加粗</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_UNDERLINE = <span style="color:rgb(128,0,0)">"Underline"</span>;             <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">下划线</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_ITALIC = <span style="color:rgb(128,0,0)">"Italic"</span>;                   <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">斜体</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_SUBSCRIPT = <span style="color:rgb(128,0,0)">"Subscript"</span>;             <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">下标</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_SUPERSCRIPT = <span style="color:rgb(128,0,0)">"Superscript"</span>;         <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">上标</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_STRIKE_THROUGH = <span style="color:rgb(128,0,0)">"StrikeThrough"</span>;    <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">删除线</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_FONT_NAME = <span style="color:rgb(128,0,0)">"FontName"</span>;              <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">字体</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_FONT_SIZE = <span style="color:rgb(128,0,0)">"FontSize"</span>;              <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">字号</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_FORE_COLOR = <span style="color:rgb(128,0,0)">"ForeColor"</span>;            <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">字体前景色</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_BACK_COLOR = <span style="color:rgb(128,0,0)">"BackColor"</span>;            <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">字体背景色</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_INSERT_FORMAT_BLOCK = <span style="color:rgb(128,0,0)">"FormatBlock"</span>; <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">加粗</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_REMOVE_FORMAT = <span style="color:rgb(128,0,0)">"RemoveFormat"</span>;      <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">清楚样式</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_JUSTIFY_LEFT = <span style="color:rgb(128,0,0)">"JustifyLeft"</span>;        <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">文本左对齐</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_JUSTIFY_CENTER = <span style="color:rgb(128,0,0)">"JustifyCenter"</span>;    <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">文本中间对齐</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_JUSTIFY_RIGHT = <span style="color:rgb(128,0,0)">"JustifyRight"</span>;      <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">文本右对齐</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_JUSTIFY_FULL = <span style="color:rgb(128,0,0)">"JustifyFull"</span>;        <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">文本两端对齐</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_INDENT = <span style="color:rgb(128,0,0)">"Indent"</span>;                   <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">增大缩进量</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_OUTDENT = <span style="color:rgb(128,0,0)">"Outdent"</span>;                 <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">减小缩进量</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_INSERT_LINE = <span style="color:rgb(128,0,0)">"InsertHorizontalRule"</span>;<span style="color:rgb(0,128,0)">//<span style="font-family:宋体">插入分割符</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_INSERT_LIST = <span style="color:rgb(128,0,0)">"Insert{0}List"</span>; <span style="color:rgb(0,128,0)">// replace with (Un)Ordered <span style="font-family:宋体">插入项目符号或项目编号</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_INSERT_IMAGE = <span style="color:rgb(128,0,0)">"InsertImage"</span>;         <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">插入图像</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_INSERT_LINK = <span style="color:rgb(128,0,0)">"CreateLink"</span>;           <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">插入链接</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_REMOVE_LINK = <span style="color:rgb(128,0,0)">"Unlink"</span>;               <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">移除链接</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_TEXT_CUT = <span style="color:rgb(128,0,0)">"Cut"</span>;                     <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">剪切</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_TEXT_COPY = <span style="color:rgb(128,0,0)">"Copy"</span>;                   <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">复制</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_TEXT_PASTE = <span style="color:rgb(128,0,0)">"Paste"</span>;                 <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">粘贴</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_TEXT_DELETE = <span style="color:rgb(128,0,0)">"Delete"</span>;               <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">删除</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_TEXT_UNDO = <span style="color:rgb(128,0,0)">"Undo"</span>;                   <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">撤销</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_TEXT_REDO = <span style="color:rgb(128,0,0)">"Redo"</span>;                   <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">恢复</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_TEXT_SELECT_ALL = <span style="color:rgb(128,0,0)">"SelectAll"</span>;        <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">全选</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_TEXT_UNSELECT = <span style="color:rgb(128,0,0)">"Unselect"</span>;           <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">取消选择</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_TEXT_PRINT = <span style="color:rgb(128,0,0)">"Print"</span>;                 <span style="color:rgb(0,128,0)">// <span style="font-family:宋体">打印</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_EDITMODE = <span style="color:rgb(128,0,0)">"EditMode"</span>;                <span style="color:rgb(0,128,0)">// <span style="font-family:宋体">编辑模式</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_BROWSEMODE = <span style="color:rgb(128,0,0)">"BrowseMode"</span>;            <span style="color:rgb(0,128,0)">// <span style="font-family:宋体">浏览模式</span></span><span style="color:rgb(0,128,0)"><br> </span>        <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">const</span> <span style="color:rgb(0,0,255)">string</span> HTML_COMMAND_OVERWRITE = <span style="color:rgb(128,0,0)">"OverWrite"</span>;             <span style="color:rgb(0,128,0)">//<span style="font-family:宋体">转换插入、覆写模式</span></span><span style="color:rgb(51,51,51)"><br> </span></p> 
 <p style="background:rgb(245,245,245)"><span style="color:rgb(0,128,0)">// </span><a href="http://msdn.microsoft.com/en-us/library/ms533049.aspx" rel="nofollow"><span style="color:rgb(0,0,0)">更多的命令请参见：</span></a></p> 
 <p style="background:rgb(245,245,245)"><a href="http://msdn.microsoft.com/en-us/library/ms533049.aspx" rel="nofollow"><span style="color:rgb(57,154,178)">http://msdn.microsoft.com/en-us/library/ms533049.aspx</span></a></p> 
 <p></p> 
 <h2><a href="http://www.cnblogs.com/08shiyan/archive/2011/04/29/2033040.html" rel="nofollow"><span style="color:rgb(57,154,178)">C# WinForm WebBrowser (<span style="font-family:宋体">四</span><span style="font-family:Verdana">) </span><span style="font-family:宋体">自定义操作【转】</span></span></a> </h2> 
 <p><span style="color:rgb(51,51,51)">————————————————————————————————————————————————————————————————</span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　由于本人在开发中经常要在程序中嵌入浏览器，为了符合自己的需求经常要对浏览器进行扩展和定制， 解决这些问题需在网上找资料和学习的过程，我想可能很多开发者或许会遇到同样的问题，特写此文，以供大家参考。<span style="font-family:Verdana"> </span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> <a name="%E5%9C%A8MFC%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%B5%8F%E8%A7%88%E5%99%A8"></a></span>在<span style="font-family:Verdana">MFC</span><span style="font-family:宋体">中使用浏览器</span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　在<span style="font-family:Verdana">MFC</span><span style="font-family:宋体">中微软为我们提供了</span><span style="font-family:Verdana">CHtmlView</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">CDHtmlDialog</span><span style="font-family:宋体">类让我们的程序很方便的嵌入浏览器和进行浏览器的二次开发，这比直 接使用</span><span style="font-family:Verdana">WebBrowser</span><span style="font-family:宋体">控件要方便很多，所以本文中讨论的浏览器的问题都是针对</span><span style="font-family:Verdana">CHtmlView</span><span style="font-family:宋体">来讨论的。文中将提到一个类</span><span style="font-family:Verdana">CLhpHtmlView, </span><span style="font-family:宋体">它是</span><span style="font-family:Verdana">CHtmlView</span><span style="font-family:宋体">的派生类，文中提及的扩展或定制都将在</span><span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">类</span><span style="font-family:Verdana">(</span><span style="font-family:宋体">或派生类</span><span style="font-family:Verdana">)</span><span style="font-family:宋体">上实现。</span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> <a name="%E6%80%8E%E6%A0%B7%E6%89%A9%E5%B1%95%E6%88%96%E5%AE%9A%E5%88%B6%E6%B5%8F%E8%A7%88%E5%99%A8"></a></span>怎样扩展或定制浏览器<span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　浏览器定义了一些扩展接口（如<span style="font-family:Verdana">IDocHostUIHandler</span><span style="font-family:宋体">可以定制浏览器界面有关的行为），以便开发者进行定制和扩展。浏览 器会在需要的时候向他的控制站点查询这些接口，在控制站点里实现相应的接口就可以进行相应的扩展。在</span><span style="font-family:Verdana">MFC7.01</span><span style="font-family:宋体">类 库中，</span><span style="font-family:Verdana">CHtmlView</span><span style="font-family:宋体">使用的控制站点是</span><span style="font-family:Verdana">CHtmlControlSite</span><span style="font-family:宋体">的，在</span><span style="font-family:Verdana">CHtmlControlSite</span><span style="font-family:宋体">类中 只实现了接口</span><span style="font-family:Verdana">IDocHostUIHandler</span><span style="font-family:宋体">， 而要实现更多的扩展接口，必须用自定义的控制站类来取代</span><span style="font-family:Verdana">CHtmlControlSite</span><span style="font-family:宋体">，在下文中提及的类</span><span style="font-family:Verdana">CDocHostSite</span><span style="font-family:宋体">即为自定义 的控制站类。</span><span style="font-family:Verdana"> </span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">关于接口的介绍请参考： </span></p> 
 <p><a href="http://dev.csdn.net/develop/article/48/48483.shtm" rel="nofollow"><span style="color:rgb(0,0,0)">http://dev.csdn.net/develop/article/48/48483.shtm</span></a><span style="color:rgb(51,51,51)"> </span></p> 
 <p><span style="color:rgb(51,51,51)">如何使自定义的控制站点来替换默认的控制站点呢？在<span style="font-family:Verdana">MFC7.0</span><span style="font-family:宋体">中只需重载</span><span style="font-family:Verdana">CHtmlView</span><span style="font-family:宋体">的虚函数</span><span style="font-family:Verdana">CreateControlSite</span><span style="font-family:宋体">即可：</span><span style="font-family:Verdana"> </span></span></p> 
 <p><span style="color:rgb(51,51,51)">BOOL CLhpHtmlView::CreateControlSite(COleControlContainer * pContainer, </span></p> 
 <p><span style="color:rgb(51,51,51)">COleControlSite ** ppSite, UINT /*nID*/, REFCLSID /*clsid*/)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">*ppSite = new CDocHostSite(pContainer, this);// 创建自己的控制站点实例</span></p> 
 <p><span style="color:rgb(51,51,51)">return (*ppSite) ? TRUE : FALSE;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">VC6.0<span style="font-family:宋体">要替换控制站要复杂的多，这里就不讨论了，如需要</span><span style="font-family:Verdana">6.0</span><span style="font-family:宋体">版本的请给我发邮件到</span><span style="font-family:Verdana">yourshine@21cn.com</span><span style="font-family:宋体">。</span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> <a name="%E5%AE%9A%E5%88%B6%E9%BC%A0%E6%A0%87%E5%8F%B3%E9%94%AE%E5%BC%B9%E5%87%BA%E5%87%BA%E8%8F%9C%E5%8D%95"></a></span>定制鼠标右键弹出出菜单<span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　要定制浏览器的鼠标右键弹出菜单，必须在自定义的控制站点类中实现<span style="font-family:Verdana">IDocHostUIHandler2</span><span style="font-family:宋体">接口，并且</span><span style="font-family:Verdana">IE</span><span style="font-family:宋体">的 版本是</span><span style="font-family:Verdana">5.5</span><span style="font-family:宋体">或以上。在接口</span><span style="font-family:Verdana">IDocHostUIHandler2</span><span style="font-family:宋体">的</span><span style="font-family:Verdana">ShowContextMenu</span><span style="font-family:宋体">方法中调用浏览器类的</span><span style="font-family:Verdana">OnShowContextMenu</span><span style="font-family:宋体">虚函数，我们 在浏览器类的派生类重载此虚函数即可实现右键菜单的定制，参见代码</span><span style="font-family:Verdana"> </span></span></p> 
 <p><span style="color:rgb(51,51,51)">HRESULT CDocHostSite::XDocHostUIHandler::ShowContextMenu(DWORD dwID,</span></p> 
 <p><span style="color:rgb(51,51,51)">                                                         POINT * ppt,</span></p> 
 <p><span style="color:rgb(51,51,51)">                                                         IUnknown * pcmdtReserved,</span></p> 
 <p><span style="color:rgb(51,51,51)">                                                         IDispatch * pdispReserved)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">METHOD_PROLOGUE(CDocHostSite, DocHostUIHandler);</span></p> 
 <p><span style="color:rgb(51,51,51)">return pThis-&gt;m_pView-&gt;OnShowContextMenu( dwID, ppt, pcmdtReserved,pdispReserved );</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">HRESULT CLhpHtmlView::OnShowContextMenu(DWORD dwID, </span></p> 
 <p><span style="color:rgb(51,51,51)">                                        LPPOINT ppt,</span></p> 
 <p><span style="color:rgb(51,51,51)">                                        LPUNKNOWN pcmdtReserved, </span></p> 
 <p><span style="color:rgb(51,51,51)">                                        LPDISPATCH pdispReserved)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">HRESULT result = S_FALSE;</span></p> 
 <p><span style="color:rgb(51,51,51)">switch(m_ContextMenuMode)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">case NoContextMenu:</span><span style="color:rgb(51,51,51)">// 无菜单</span></p> 
 <p><span style="color:rgb(51,51,51)">result=S_OK;</span></p> 
 <p><span style="color:rgb(51,51,51)">break;</span></p> 
 <p><span style="color:rgb(51,51,51)">case DefaultMenu:</span><span style="color:rgb(51,51,51)">// 默认菜单</span></p> 
 <p><span style="color:rgb(51,51,51)">break;</span></p> 
 <p><span style="color:rgb(51,51,51)">case TextSelectionOnly:</span><span style="color:rgb(51,51,51)">// 仅文本选择菜单</span></p> 
 <p><span style="color:rgb(51,51,51)">if(!(dwID == CONTEXT_MENU_TEXTSELECT || dwID == CONTEXT_MENU_CONTROL))</span></p> 
 <p><span style="color:rgb(51,51,51)">result=S_OK;</span></p> 
 <p><span style="color:rgb(51,51,51)">break;</span></p> 
 <p><span style="color:rgb(51,51,51)">case CustomMenu:</span><span style="color:rgb(51,51,51)">// 自定义菜单</span></p> 
 <p><span style="color:rgb(51,51,51)">if(dwID!=CONTEXT_MENU_TEXTSELECT)</span></p> 
 <p><span style="color:rgb(51,51,51)">result=OnShowCustomContextMenu(ppt,pcmdtReserved,pdispReserved);</span></p> 
 <p><span style="color:rgb(51,51,51)">break;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">return result;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">在<span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">中定义的枚举类型</span><span style="font-family:Verdana">CONTEXT_MENU_MODE</span><span style="font-family:宋体">举出了定制右键弹出菜单的四种类型</span><span style="font-family:Verdana"> </span></span></p> 
 <p><span style="color:rgb(51,51,51)">enum CONTEXT_MENU_MODE</span><span style="color:rgb(51,51,51)">// 上下文菜单</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">NoContextMenu,</span><span style="color:rgb(51,51,51)">// 无菜单</span></p> 
 <p><span style="color:rgb(51,51,51)">DefaultMenu,</span><span style="color:rgb(51,51,51)">// 默认菜单</span></p> 
 <p><span style="color:rgb(51,51,51)">TextSelectionOnly,</span><span style="color:rgb(51,51,51)">// 仅文本选择菜单</span></p> 
 <p><span style="color:rgb(51,51,51)">CustomMenu</span><span style="color:rgb(51,51,51)">// 自定义菜单</span></p> 
 <p><span style="color:rgb(51,51,51)">};</span></p> 
 <p><span style="color:rgb(51,51,51)">通过<span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">的函数</span><span style="font-family:Verdana">SetContextMenuMode</span><span style="font-family:宋体">来设置右键菜单的类型。如果设定的右键弹出菜单是</span><span style="font-family:Verdana">“</span><span style="font-family:宋体">自定义菜单</span><span style="font-family:Verdana">”</span><span style="font-family:宋体">类型， 我们只要在</span><span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">的派生类中重载</span><span style="font-family:Verdana">OnShowCustomContextMenu</span><span style="font-family:宋体">虚函数即可，如下代码 </span><span style="font-family:Verdana">CDemoView</span><span style="font-family:宋体">是</span><span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">的派生类 </span></span></p> 
 <p><span style="color:rgb(51,51,51)">HRESULT CDemoView::OnShowCustomContextMenu(LPPOINT ppt, LPUNKNOWN pcmdtReserved,LPDISPATCH pdispReserved)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">if ((ppt==NULL)||(pcmdtReserved==NULL)||(pcmdtReserved==NULL))</span></p> 
 <p><span style="color:rgb(51,51,51)">return S_OK;</span></p> 
 <p><span style="color:rgb(51,51,51)">HRESULT hr=0;</span></p> 
 <p><span style="color:rgb(51,51,51)">IOleWindow *oleWnd=NULL;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">hr=pcmdtReserved-&gt;QueryInterface(IID_IOleWindow, (void**)&amp;oleWnd);</span></p> 
 <p><span style="color:rgb(51,51,51)">if((hr != S_OK)||(oleWnd == NULL))</span></p> 
 <p><span style="color:rgb(51,51,51)">return S_OK;</span></p> 
 <p><span style="color:rgb(51,51,51)">HWND hwnd=NULL;</span></p> 
 <p><span style="color:rgb(51,51,51)">hr=oleWnd-&gt;GetWindow(&amp;hwnd);</span></p> 
 <p><span style="color:rgb(51,51,51)">if((hr!=S_OK)||(hwnd==NULL))</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">oleWnd-&gt;Release();</span></p> 
 <p><span style="color:rgb(51,51,51)">return S_OK;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">IHTMLElementPtr</span><span style="color:rgb(51,51,51)">pElem=NULL;</span></p> 
 <p><span style="color:rgb(51,51,51)">hr = pdispReserved-&gt;QueryInterface(IID_IHTMLElement, (void**)&amp;pElem);</span></p> 
 <p><span style="color:rgb(51,51,51)">if(hr != S_OK)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">oleWnd-&gt;Release();</span></p> 
 <p><span style="color:rgb(51,51,51)">return S_OK;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">IHTMLElementPtr</span><span style="color:rgb(51,51,51)">pParentElem=NULL;</span></p> 
 <p><span style="color:rgb(51,51,51)">_bstr_t</span><span style="color:rgb(51,51,51)">tagID;</span></p> 
 <p><span style="color:rgb(51,51,51)">BOOL go=TRUE;</span></p> 
 <p><span style="color:rgb(51,51,51)">pElem-&gt;get_id(&amp;tagID.GetBSTR());</span></p> 
 <p><span style="color:rgb(51,51,51)">while(go &amp;&amp; tagID.length()==0)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">hr=pElem-&gt;get_parentElement(&amp;pParentElem);</span></p> 
 <p><span style="color:rgb(51,51,51)">if(hr==S_OK &amp;&amp; pParentElem!=NULL)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">pElem-&gt;Release();</span></p> 
 <p><span style="color:rgb(51,51,51)">pElem=pParentElem;</span></p> 
 <p><span style="color:rgb(51,51,51)">pElem-&gt;get_id(&amp;tagID.GetBSTR());</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">else</span></p> 
 <p><span style="color:rgb(51,51,51)">go=FALSE;</span></p> 
 <p><span style="color:rgb(51,51,51)">};</span></p> 
 <p><span style="color:rgb(51,51,51)">if(tagID.length()==0)</span></p> 
 <p><span style="color:rgb(51,51,51)">tagID="no id";</span></p> 
 <p><span style="color:rgb(51,51,51)">CMenu Menu,SubMenu;</span></p> 
 <p><span style="color:rgb(51,51,51)">Menu.CreatePopupMenu();</span></p> 
 <p><span style="color:rgb(51,51,51)">CString strTagID = ToStr(tagID);</span></p> 
 <p><span style="color:rgb(51,51,51)">if(strTagID == "red")</span></p> 
 <p><span style="color:rgb(51,51,51)">Menu.AppendMenu(MF_BYPOSITION, ID_RED, "您点击的是红色");</span></p> 
 <p><span style="color:rgb(51,51,51)">else if(strTagID == "green")</span></p> 
 <p><span style="color:rgb(51,51,51)">Menu.AppendMenu(MF_BYPOSITION, ID_GREEN, "您点击的是绿色");</span></p> 
 <p><span style="color:rgb(51,51,51)">else if(strTagID == "blue")</span></p> 
 <p><span style="color:rgb(51,51,51)">Menu.AppendMenu(MF_BYPOSITION, ID_BLUE, "您点击的是蓝色");</span></p> 
 <p><span style="color:rgb(51,51,51)">else</span></p> 
 <p><span style="color:rgb(51,51,51)">Menu.AppendMenu(MF_BYPOSITION, ID_NONE, "你点了也白点，请在指定的地方点击");</span></p> 
 <p><span style="color:rgb(51,51,51)">int MenuID=Menu.TrackPopupMenu(TPM_RETURNCMD|TPM_LEFTALIGN|TPM_RIGHTBUTTON,ppt-&gt;x, ppt-&gt;y, this);</span></p> 
 <p><span style="color:rgb(51,51,51)">switch(MenuID)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">case ID_RED:</span></p> 
 <p><span style="color:rgb(51,51,51)">MessageBox("红色");</span></p> 
 <p><span style="color:rgb(51,51,51)">break;</span></p> 
 <p><span style="color:rgb(51,51,51)">case ID_GREEN:</span></p> 
 <p><span style="color:rgb(51,51,51)">MessageBox("红色");</span></p> 
 <p><span style="color:rgb(51,51,51)">break;</span></p> 
 <p><span style="color:rgb(51,51,51)">case ID_BLUE:</span></p> 
 <p><span style="color:rgb(51,51,51)">MessageBox("红色");</span></p> 
 <p><span style="color:rgb(51,51,51)">break;</span></p> 
 <p><span style="color:rgb(51,51,51)">case ID_NONE:</span></p> 
 <p><span style="color:rgb(51,51,51)">MessageBox("haha");</span></p> 
 <p><span style="color:rgb(51,51,51)">break;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">oleWnd-&gt;Release();</span></p> 
 <p><span style="color:rgb(51,51,51)">pElem-&gt;Release();</span></p> 
 <p><span style="color:rgb(51,51,51)">return S_OK;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)"><br> <a name="%E5%AE%9E%E7%8E%B0%E8%84%9A%E6%9C%AC%E6%89%A9%E5%B1%95(%E5%BE%88%E9%87%8D%E8%A6%81%E7%9A%84external%E6%8E%A5%E5%8F%A3)"></a></span>实现脚本扩展<span style="font-family:Verdana">(</span><span style="font-family:宋体">很重要的</span><span style="font-family:Verdana">external</span><span style="font-family:宋体">接口</span><span style="font-family:Verdana">)</span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　在你嵌入了浏览器的工程中，如果网页的脚本中能调用<span style="font-family:Verdana">C++</span><span style="font-family:宋体">代码，那将是一件很惬意的事情，要实现这种交互，就必须实现脚本扩展。实现脚本扩展就是在程序中实现一个</span><span style="font-family:Verdana">IDispatch</span><span style="font-family:宋体">接口，通过</span><span style="font-family:Verdana">CHtmlView</span><span style="font-family:宋体">类的</span><span style="font-family:Verdana">OnGetExternal</span><span style="font-family:宋体">虚函数返回此接口指针</span><span style="font-family:Verdana">,</span><span style="font-family:宋体">这样就可以在脚本中通过</span><span style="font-family:Verdana">window.external.XXX(</span><span style="font-family:宋体">关键字</span><span style="font-family:Verdana">window</span><span style="font-family:宋体">可以省略</span><span style="font-family:Verdana">)</span><span style="font-family:宋体">来 引用接口暴露的方法或属性</span><span style="font-family:Verdana">(XXX</span><span style="font-family:宋体">为方法或属性名</span><span style="font-family:Verdana">)</span><span style="font-family:宋体">。在</span><span style="font-family:Verdana">MFC</span><span style="font-family:宋体">中从</span><span style="font-family:Verdana">CCmdTarget</span><span style="font-family:宋体">派生的类都可以实现自动化，而不必在</span><span style="font-family:Verdana">MFC</span><span style="font-family:宋体">工程中引入繁杂的</span><span style="font-family:Verdana">ATL</span><span style="font-family:宋体">。从</span><span style="font-family:Verdana">CCmdTarget</span><span style="font-family:宋体">派生的类实现自动化接口的时候不要忘了在构造函数中调用</span><span style="font-family:Verdana">EnableAutomation</span><span style="font-family:宋体">函数。</span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　要使虚函数<span style="font-family:Verdana">OnGetExternal</span><span style="font-family:宋体">发挥作用必须在 自定义的控制站点类中实现</span><span style="font-family:Verdana">IDocHostUIHandler</span><span style="font-family:宋体">，在接口</span><span style="font-family:Verdana">IDocHostUIHandler</span><span style="font-family:宋体">的</span><span style="font-family:Verdana">GetExternal</span><span style="font-family:宋体">方法中调用浏览器类的</span><span style="font-family:Verdana">OnGetExternal</span><span style="font-family:宋体">虚函数，我们在浏览器类的派生类重载</span><span style="font-family:Verdana">OnGetExternal</span><span style="font-family:宋体">虚函数， 通过参数</span><span style="font-family:Verdana">lppDispatch</span><span style="font-family:宋体">返回一个</span><span style="font-family:Verdana">IDispatch</span><span style="font-family:宋体">指针</span><span style="font-family:Verdana">,</span><span style="font-family:宋体">这样脚本中引用</span><span style="font-family:Verdana">window.external</span><span style="font-family:宋体">时就是引用的返回的接口，参见代码 </span></span></p> 
 <p><span style="color:rgb(51,51,51)">HRESULT CDocHostSite::XDocHostUIHandler::GetExternal(IDispatch ** ppDispatch)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">METHOD_PROLOGUE(CDocHostSite, DocHostUIHandler);</span></p> 
 <p><span style="color:rgb(51,51,51)">return pThis-&gt;m_pView-&gt;OnGetExternal( ppDispatch );</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">CLhpHtmlView::CLhpHtmlView(BOOL isview)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">......</span></p> 
 <p><span style="color:rgb(51,51,51)">EnableAutomation();// 允许自动化</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">HRESULT CLhpHtmlView::OnGetExternal(LPDISPATCH *lppDispatch)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">*lppDispatch = GetIDispatch(TRUE);// 返回自身的IDispatch接口</span></p> 
 <p><span style="color:rgb(51,51,51)">return S_OK;</span></p> 
 <p><span style="color:rgb(51,51,51)">}      </span></p> 
 <p><span style="color:rgb(51,51,51)">请注意上面代码中，在<span style="font-family:Verdana">OnGetExternal</span><span style="font-family:宋体">返回的是自身</span><span style="font-family:Verdana">IDispatch</span><span style="font-family:宋体">接口， 这样就不比为脚本扩展而另外写一个从</span><span style="font-family:Verdana">CCmdTarget</span><span style="font-family:宋体">派生的新类， </span><span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">本身就是从</span><span style="font-family:Verdana">CCmdTarget</span><span style="font-family:宋体">派生，直接在上面实现接口就是。</span><span style="font-family:Verdana"> </span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">下用具体示例来说明怎样实现脚本扩展<span style="font-family:Verdana"> </span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">示例会在网页上点击一个按钮而使整个窗口发生抖动</span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">从<span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">派生一个类</span><span style="font-family:Verdana">CDemoView,</span><span style="font-family:宋体">在类中实现</span><span style="font-family:Verdana">IDispatch, </span><span style="font-family:宋体">并通过</span><span style="font-family:Verdana">IDispatch</span><span style="font-family:宋体">暴露方法</span><span style="font-family:Verdana">WobbleWnd </span></span></p> 
 <p><span style="color:rgb(51,51,51)">---------------------------------------------------------------------------</span></p> 
 <p><span style="color:rgb(51,51,51)">文件 DemoView.h</span></p> 
 <p><span style="color:rgb(51,51,51)">---------------------------------------------------------------------------</span></p> 
 <p><span style="color:rgb(51,51,51)">.......</span></p> 
 <p><span style="color:rgb(51,51,51)">class CDemoView : public CLhpHtmlView</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">......</span></p> 
 <p><span style="color:rgb(51,51,51)">DECLARE_DISPATCH_MAP() // 构建dispatch映射表以暴露方法或属性</span></p> 
 <p><span style="color:rgb(51,51,51)">......</span></p> 
 <p><span style="color:rgb(51,51,51)">void WobbleWnd();// 抖动窗口</span></p> 
 <p><span style="color:rgb(51,51,51)">};</span></p> 
 <p><span style="color:rgb(51,51,51)">---------------------------------------------------------------------------</span></p> 
 <p><span style="color:rgb(51,51,51)">文件 DemoView.cpp</span></p> 
 <p><span style="color:rgb(51,51,51)">---------------------------------------------------------------------------</span></p> 
 <p><span style="color:rgb(51,51,51)">......</span></p> 
 <p><span style="color:rgb(51,51,51)">// 把成员函数映射到Dispatch映射表中,暴露方法给脚本</span></p> 
 <p><span style="color:rgb(51,51,51)">BEGIN_DISPATCH_MAP(CDemoView, CLhpHtmlView)</span></p> 
 <p><span style="color:rgb(51,51,51)">DISP_FUNCTION(CDemoView, "WobbleWnd", WobbleWnd, VT_EMPTY, VTS_NONE)</span></p> 
 <p><span style="color:rgb(51,51,51)">END_DISPATCH_MAP()</span></p> 
 <p><span style="color:rgb(51,51,51)">......</span></p> 
 <p><span style="color:rgb(51,51,51)">void CDemoView::WobbleWnd()</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">// 在这里实现抖动窗口</span></p> 
 <p><span style="color:rgb(51,51,51)">......</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">---------------------------------------------------------------------------</span></p> 
 <p><span style="color:rgb(51,51,51)">文件 Demo.htm</span></p> 
 <p><span style="color:rgb(51,51,51)">---------------------------------------------------------------------------</span></p> 
 <p><span style="color:rgb(51,51,51)">...... οnclick="external.WobbleWnd()" ......</span></p> 
 <p><span style="color:rgb(51,51,51)">这里我要介绍一下<span style="font-family:Verdana">DISP_FUNCTION</span><span style="font-family:宋体">宏，它的作用是将一个函数映射到</span><span style="font-family:Verdana">Dispatch</span><span style="font-family:宋体">映射表中，我们看 </span></span></p> 
 <p><span style="color:rgb(51,51,51)">DISP_FUNCTION(CDemoView, "WobbleWnd", WobbleWnd, VT_EMPTY, VTS_NONE)</span></p> 
 <p><span style="color:rgb(51,51,51)">CDemoView<span style="font-family:宋体">是宿主类名， </span><span style="font-family:Verdana">"WobbleWnd"</span><span style="font-family:宋体">是暴露给外面的名字</span><span style="font-family:Verdana">(</span><span style="font-family:宋体">脚本调用时使用的名字</span><span style="font-family:Verdana">)</span><span style="font-family:宋体">， </span><span style="font-family:Verdana">VT_EMPTY</span><span style="font-family:宋体">是返回值得类型为空，</span><span style="font-family:Verdana">VTS_NONE</span><span style="font-family:宋体">说明此方法没有参数，如果要映射的函数有返回值和参数该 如何映射，通过下面举例来说明</span><span style="font-family:Verdana"> </span></span></p> 
 <p><span style="color:rgb(51,51,51)">DISP_FUNCTION(CCalendarView,"TestFunc",TestFunc,VT_BOOL,VTS_BSTR VTS_I4 VTS_I4)</span></p> 
 <p><span style="color:rgb(51,51,51)">BOOL TestFunc(LPCSTR param1, int param2, int param3)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">.....</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">参数表<span style="font-family:Verdana">VTS_BSTR VTS_I4 VTS_I4</span><span style="font-family:宋体">是用空格分隔，他们的类型映射请参考</span><span style="font-family:Verdana">MSDN</span><span style="font-family:宋体">，这要提醒的是不要把</span><span style="font-family:Verdana">VTS_BSTR</span><span style="font-family:宋体">与</span><span style="font-family:Verdana">CString</span><span style="font-family:宋体">对应，而应与</span><span style="font-family:Verdana">LPCSTR</span><span style="font-family:宋体">对应。</span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> <a name="C++%E4%BB%A3%E7%A0%81%E4%B8%AD%E5%A6%82%E4%BD%95%E8%B0%83%E7%94%A8%E7%BD%91%E9%A1%B5%E8%84%9A%E6%9C%AC%E4%B8%AD%E7%9A%84%E5%87%BD%E6%95%B0"></a></span>C++<span style="font-family:宋体">代码中如何调用网页脚本中的函数</span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　<span style="font-family:Verdana">IHTMLDocument2::scripts</span><span style="font-family:宋体">属性表示</span><span style="font-family:Verdana">HTML</span><span style="font-family:宋体">文档中所有脚本对象。使用脚本对象的</span><span style="font-family:Verdana">IDispatch</span><span style="font-family:宋体">接口的</span><span style="font-family:Verdana">GetIDsOfNames</span><span style="font-family:宋体">方法可以得到脚本函数的 </span><span style="font-family:Verdana">DispID</span><span style="font-family:宋体">，得到</span><span style="font-family:Verdana">DispID</span><span style="font-family:宋体">后，使用</span><span style="font-family:Verdana">IDispatch</span><span style="font-family:宋体">的</span><span style="font-family:Verdana">Invoke</span><span style="font-family:宋体">函数可以调用对应的脚本函数。</span><span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">提供了方便的调用</span><span style="font-family:Verdana">JavaScript</span><span style="font-family:宋体">的函数，请参考</span><span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">中有关键字</span><span style="font-family:Verdana">“JScript”</span><span style="font-family:宋体">的代码。</span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> <a name="%E5%AE%9A%E5%88%B6%E6%B6%88%E6%81%AF%E6%A1%86%E7%9A%84%E6%A0%87%E9%A2%98"></a></span>定制消息框的标题<span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　我们在脚本中调用<span style="font-family:Verdana">alert</span><span style="font-family:宋体">弹出消息框时，消息框的标题是微软预定义的</span><span style="font-family:Verdana">“Microsoft Internet Explorer”</span><span style="font-family:宋体">，如下图：</span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　在自定义的控制站点类中实现<span style="font-family:Verdana">IDocHostShowUI</span><span style="font-family:宋体">接口，在接口的</span><span style="font-family:Verdana">ShowMessage</span><span style="font-family:宋体">方法中调用浏览器的</span><span style="font-family:Verdana">OnShowMessage,</span><span style="font-family:宋体">我们重载 </span><span style="font-family:Verdana">OnShowMessage</span><span style="font-family:宋体">虚函数即可定制消息框的标题，实现代码如下：</span><span style="font-family:Verdana"> </span></span></p> 
 <p><span style="color:rgb(51,51,51)">// 窗口标题"Microsoft Internet Explorer"的资源标识</span></p> 
 <p><span style="color:rgb(51,51,51)">#define IDS_MESSAGE_BOX_TITLE 2213</span></p> 
 <p><span style="color:rgb(51,51,51)">HRESULT CLhpHtmlView::OnShowMessage(HWND hwnd,</span></p> 
 <p><span style="color:rgb(51,51,51)">                                    LPOLESTR lpstrText,</span></p> 
 <p><span style="color:rgb(51,51,51)">                                    LPOLESTR lpstrCaption,</span></p> 
 <p><span style="color:rgb(51,51,51)">                                    DWORD dwType,</span></p> 
 <p><span style="color:rgb(51,51,51)">                                    LPOLESTR lpstrHelpFile,</span></p> 
 <p><span style="color:rgb(51,51,51)">                                    DWORD dwHelpContext,</span></p> 
 <p><span style="color:rgb(51,51,51)">                                    LRESULT * plResult)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">    //载入Shdoclc.dll 和IE消息框标题字符串</span></p> 
 <p><span style="color:rgb(51,51,51)">    HINSTANCE hinstSHDOCLC = LoadLibrary(TEXT("SHDOCLC.DLL"));</span></p> 
 <p><span style="color:rgb(51,51,51)">    if (hinstSHDOCLC == NULL)</span></p> 
 <p><span style="color:rgb(51,51,51)">        return S_FALSE;</span></p> 
 <p><span style="color:rgb(51,51,51)">CString strBuf,strCaption(lpstrCaption);</span></p> 
 <p><span style="color:rgb(51,51,51)">strBuf.LoadString(hinstSHDOCLC, IDS_MESSAGE_BOX_TITLE);</span></p> 
 <p><span style="color:rgb(51,51,51)">    // 比较IE消息框标题字符串和lpstrCaption</span></p> 
 <p><span style="color:rgb(51,51,51)">    // 如果相同，用自定义标题替换</span></p> 
 <p><span style="color:rgb(51,51,51)">if(strBuf==lpstrCaption)</span></p> 
 <p><span style="color:rgb(51,51,51)">        strCaption = m_DefaultMsgBoxTitle;</span></p> 
 <p><span style="color:rgb(51,51,51)">    // 创建自己的消息框并且显示</span></p> 
 <p><span style="color:rgb(51,51,51)">    *plResult = MessageBox(CString(lpstrText), strCaption, dwType);</span></p> 
 <p><span style="color:rgb(51,51,51)">    //卸载Shdoclc.dll并且返回</span></p> 
 <p><span style="color:rgb(51,51,51)">    FreeLibrary(hinstSHDOCLC);</span></p> 
 <p><span style="color:rgb(51,51,51)">    return S_OK;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">从代码中可以看到通过设定<span style="font-family:Verdana">m_DefaultMsgBoxTitle</span><span style="font-family:宋体">的值来改变消息宽的标题，修改此值是同过</span><span style="font-family:Verdana">SetDefaultMsgBoxTitle</span><span style="font-family:宋体">来实现 </span></span></p> 
 <p><span style="color:rgb(51,51,51)">void CLhpHtmlView::SetDefaultMsgBoxTitle(CString strTitle)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">m_DefaultMsgBoxTitle=strTitle;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)"><br> <a name="%E6%80%8E%E6%A0%B7%E5%AE%9A%E5%88%B6%E3%80%81%E4%BF%AE%E6%94%B9%E6%B5%8F%E8%A7%88%E5%99%A8%E5%90%91Web%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8F%91%E9%80%81%E7%9A%84HTTP%E8%AF%B7%E6%B1%82%E5%A4%B4"></a></span>怎样定制、修改浏览器向<span style="font-family:Verdana">Web</span><span style="font-family:宋体">服务器发送的</span><span style="font-family:Verdana">HTTP</span><span style="font-family:宋体">请求头</span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　在集成了<span style="font-family:Verdana">WebBrowser</span><span style="font-family:宋体">控件的应用中，</span><span style="font-family:Verdana">Web</span><span style="font-family:宋体">服务器有时可能希望客户端</span><span style="font-family:Verdana">(</span><span style="font-family:宋体">浏览器</span><span style="font-family:Verdana">)</span><span style="font-family:宋体">发送的</span><span style="font-family:Verdana">HTTP</span><span style="font-family:宋体">请求中附带一些额外的信息或自定义的 </span><span style="font-family:Verdana">HTTP</span><span style="font-family:宋体">头字段，这样就必须在浏览器中控制向</span><span style="font-family:Verdana">Web</span><span style="font-family:宋体">服务器发送的</span><span style="font-family:Verdana">HTTP</span><span style="font-family:宋体">请求。 下面是捕获的一个普通的用浏览器发送的</span><span style="font-family:Verdana">HTTP</span><span style="font-family:宋体">请求头： </span></span></p> 
 <p><span style="color:rgb(51,51,51)">GET /text7.htm HTTP/1.0</span></p> 
 <p><span style="color:rgb(51,51,51)">Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, application/x-shockwave-flash, \</span></p> 
 <p><span style="color:rgb(51,51,51)">application/vnd.ms-excel, application/vnd.ms-powerpoint, application/msword, */*</span></p> 
 <p><span style="color:rgb(51,51,51)">Referer: http://localhost</span></p> 
 <p><span style="color:rgb(51,51,51)">Accept-Language: en-us</span></p> 
 <p><span style="color:rgb(51,51,51)">User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; Poco 0.31; LHP Browser 1.01; \</span></p> 
 <p><span style="color:rgb(51,51,51)">.NET CLR 1.1.4322)</span></p> 
 <p><span style="color:rgb(51,51,51)">Host: localhost</span></p> 
 <p><span style="color:rgb(51,51,51)">Connection: Keep-Alive</span></p> 
 <p><span style="color:rgb(51,51,51)">CHtmlView的 </span></p> 
 <p><span style="color:rgb(51,51,51)">void Navigate2(</span></p> 
 <p><span style="color:rgb(51,51,51)">   LPCTSTR lpszURL,</span></p> 
 <p><span style="color:rgb(51,51,51)">   DWORD dwFlags = 0,</span></p> 
 <p><span style="color:rgb(51,51,51)">   LPCTSTR lpszTargetFrameName = NULL,</span></p> 
 <p><span style="color:rgb(51,51,51)">   LPCTSTR lpszHeaders = NULL,</span></p> 
 <p><span style="color:rgb(51,51,51)">   LPVOID lpvPostData = NULL,</span></p> 
 <p><span style="color:rgb(51,51,51)">   DWORD dwPostDataLen = 0 </span></p> 
 <p><span style="color:rgb(51,51,51)">);</span></p> 
 <p><span style="color:rgb(51,51,51)">函数参数<span style="font-family:Verdana">lpszHeaders</span><span style="font-family:宋体">可以指定</span><span style="font-family:Verdana">HTTP</span><span style="font-family:宋体">请求头，示例如下</span><span style="font-family:Verdana">: </span></span></p> 
 <p><span style="color:rgb(51,51,51)">Navigate2(_T("http://localhost"),NULL,NULL, "MyDefineField: TestValue");</span></p> 
 <p><span style="color:rgb(51,51,51)">我们捕获的<span style="font-family:Verdana">HTTP</span><span style="font-family:宋体">头如下：</span><span style="font-family:Verdana"> </span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> <a name="%E6%80%8E%E6%A0%B7%E4%BF%AE%E6%94%B9%E6%B5%8F%E8%A7%88%E5%99%A8%E6%A0%87%E8%AF%86"></a></span>怎样修改浏览器标识<span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　在<span style="font-family:Verdana">HTTP</span><span style="font-family:宋体">请求头中</span><span style="font-family:Verdana">User-Agent</span><span style="font-family:宋体">字段表明了浏览器的版本以及操作系统的版本等信息。</span><span style="font-family:Verdana">WEB</span><span style="font-family:宋体">服务器经常需要知道用户请求页面时是来自</span><span style="font-family:Verdana">IE</span><span style="font-family:宋体">还是来自自己的客户端中的</span><span style="font-family:Verdana">WebBrowser</span><span style="font-family:宋体">控件， 以便分开处理，而</span><span style="font-family:Verdana">WebBrowser</span><span style="font-family:宋体">控件向</span><span style="font-family:Verdana">WEB</span><span style="font-family:宋体">服务器发送的浏览器标识</span><span style="font-family:Verdana">(User-Agent</span><span style="font-family:宋体">字段</span><span style="font-family:Verdana">)</span><span style="font-family:宋体">跟用</span><span style="font-family:Verdana">IE</span><span style="font-family:宋体">发送的是一样的，怎样区分自己的浏览器和</span><span style="font-family:Verdana">IE</span><span style="font-family:宋体">呢？ 微软没有提供现成的方法，要自己想法解决。 前面讨论的定制</span><span style="font-family:Verdana">HTTP</span><span style="font-family:宋体">请求头就是为这一节准备的。 思路是这样的： 在自己的浏览器里处理每一个</span><span style="font-family:Verdana">U</span><span style="font-family:宋体">页面请求，把请求头</span><span style="font-family:Verdana">User-Agent</span><span style="font-family:宋体">改成自己想要的。 在</span><span style="font-family:Verdana">CHtmlView</span><span style="font-family:宋体">的</span><span style="font-family:Verdana">OnBeforeNavigate2</span><span style="font-family:宋体">虚函数里来修改</span><span style="font-family:Verdana">HTTP</span><span style="font-family:宋体">请求是再好不过了， </span></span></p> 
 <p><span style="color:rgb(51,51,51)">#define WM_NVTO</span><span style="color:rgb(51,51,51)">(WM_USER+1000)</span></p> 
 <p><span style="color:rgb(51,51,51)">class NvToParam</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">public:</span></p> 
 <p><span style="color:rgb(51,51,51)">CString URL;</span></p> 
 <p><span style="color:rgb(51,51,51)">DWORD Flags;</span></p> 
 <p><span style="color:rgb(51,51,51)">CString TargetFrameName;</span></p> 
 <p><span style="color:rgb(51,51,51)">CByteArray PostedData;</span></p> 
 <p><span style="color:rgb(51,51,51)">CString Headers;</span></p> 
 <p><span style="color:rgb(51,51,51)">};</span></p> 
 <p><span style="color:rgb(51,51,51)">void CDemoView::OnBeforeNavigate2(LPCTSTR lpszURL, </span></p> 
 <p><span style="color:rgb(51,51,51)">                                  DWORD nFlags, </span></p> 
 <p><span style="color:rgb(51,51,51)">                                  LPCTSTR lpszTargetFrameName, </span></p> 
 <p><span style="color:rgb(51,51,51)">                                  CByteArray&amp; baPostedData, </span></p> 
 <p><span style="color:rgb(51,51,51)">                                  LPCTSTR lpszHeaders, </span></p> 
 <p><span style="color:rgb(51,51,51)">                                  BOOL* pbCancel)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">CString strHeaders(lpszHeaders);</span></p> 
 <p><span style="color:rgb(51,51,51)">if(strHeaders.Find("User-Agent:LHPBrowser 1.0") &lt; 0)// 检查头里有没有自定义的User-Agent串</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">*pbCancel = TRUE;// 没有，取消这次导航</span></p> 
 <p><span style="color:rgb(51,51,51)">if(!strHeaders.IsEmpty())</span></p> 
 <p><span style="color:rgb(51,51,51)">strHeaders += "\r\n";</span></p> 
 <p><span style="color:rgb(51,51,51)">strHeaders += "User-Agent:LHPBrowser 1.0";// 加上自定义的User-Agent串</span></p> 
 <p><span style="color:rgb(51,51,51)">NvToParam* pNvTo = new NvToParam;</span></p> 
 <p><span style="color:rgb(51,51,51)">pNvTo-&gt;URL = lpszURL;</span></p> 
 <p><span style="color:rgb(51,51,51)">pNvTo-&gt;Flags = nFlags;</span></p> 
 <p><span style="color:rgb(51,51,51)">pNvTo-&gt;TargetFrameName = lpszTargetFrameName;</span></p> 
 <p><span style="color:rgb(51,51,51)">baPostedData.Copy(pNvTo-&gt;PostedData);</span></p> 
 <p><span style="color:rgb(51,51,51)">pNvTo-&gt;Headers = strHeaders;</span></p> 
 <p><span style="color:rgb(51,51,51)">// 发送一个自定义的导航消息，并把参数发过去</span></p> 
 <p><span style="color:rgb(51,51,51)">PostMessage(WM_NVTO,(WPARAM)pNvTo);</span></p> 
 <p><span style="color:rgb(51,51,51)">return;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">CHtmlView::OnBeforeNavigate2(lpszURL, </span></p> 
 <p><span style="color:rgb(51,51,51)">                             nFlags, </span></p> 
 <p><span style="color:rgb(51,51,51)">                             lpszTargetFrameName, </span></p> 
 <p><span style="color:rgb(51,51,51)">                             baPostedData, </span></p> 
 <p><span style="color:rgb(51,51,51)">                             lpszHeaders, </span></p> 
 <p><span style="color:rgb(51,51,51)">                             pbCancel);</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">LRESULT CDemoView::OnNvTo(WPARAM wParam, LPARAM lParam)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">NvToParam* pNvTo = (NvToParam*)wParam;</span></p> 
 <p><span style="color:rgb(51,51,51)">Navigate2((LPCTSTR)pNvTo-&gt;URL, </span></p> 
 <p><span style="color:rgb(51,51,51)">           pNvTo-&gt;Flags, </span></p> 
 <p><span style="color:rgb(51,51,51)">           pNvTo-&gt;PostedData, </span></p> 
 <p><span style="color:rgb(51,51,51)">           (LPCTSTR)pNvTo-&gt;TargetFrameName, </span></p> 
 <p><span style="color:rgb(51,51,51)">           (LPCTSTR)pNvTo-&gt;Headers);</span></p> 
 <p><span style="color:rgb(51,51,51)">delete pNvTo;</span></p> 
 <p><span style="color:rgb(51,51,51)">return 1;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">在<span style="font-family:Verdana">OnBeforeNavigate2</span><span style="font-family:宋体">中如果发现没有自定义的</span><span style="font-family:Verdana">User-Agent</span><span style="font-family:宋体">串，就加上这个串，并取消本次导航，再</span><span style="font-family:Verdana">Post</span><span style="font-family:宋体">一个消息</span><span style="font-family:Verdana">(</span><span style="font-family:宋体">一定要</span><span style="font-family:Verdana">POST</span><span style="font-family:宋体">，让</span><span style="font-family:Verdana">OnBeforeNavigate2</span><span style="font-family:宋体">跳出以后再进行导航 </span><span style="font-family:Verdana">)</span><span style="font-family:宋体">，在消息中再次导航，再次导航时请求头已经有了自己的标识，所以能正常的导航。</span><span style="font-family:Verdana"> </span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> <a name="%E5%8E%BB%E6%8E%89%E8%AE%A8%E5%8E%8C%E7%9A%84%E5%BC%82%E5%B8%B8%E8%AD%A6%E5%91%8A"></a></span>去掉讨厌的异常警告<span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　在程序中使用了<span style="font-family:Verdana">CHtmlView</span><span style="font-family:宋体">以后，我们在调整窗口大小的时候经常会看到输出窗口输出的异常警告： </span><span style="font-family:Verdana">ReusingBrowser.exe </span><span style="font-family:宋体">中的 </span><span style="font-family:Verdana">0x77e53887 </span><span style="font-family:宋体">处最可能的异常</span><span style="font-family:Verdana">: Microsoft C++ exception: COleException @ 0x0012e348 </span><span style="font-family:宋体">。 </span></span></p> 
 <p><span style="color:rgb(51,51,51)">Warning: constructing COleException, scode = DISP_E_MEMBERNOTFOUND($80020003).</span></p> 
 <p><span style="color:rgb(51,51,51)">这是由于<span style="font-family:Verdana">CHtmlView</span><span style="font-family:宋体">在处理</span><span style="font-family:Verdana">WM_SIZE</span><span style="font-family:宋体">消息时的一点小问题引起的</span><span style="font-family:Verdana">,</span><span style="font-family:宋体">采用如下代码处理</span><span style="font-family:Verdana">WM_SIZE</span><span style="font-family:宋体">消息就不会有此警告了 </span></span></p> 
 <p><span style="color:rgb(51,51,51)">void CLhpHtmlView::OnSize(UINT nType, int cx, int cy)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">CFormView::OnSize(nType, cx, cy);</span></p> 
 <p><span style="color:rgb(51,51,51)">if (::IsWindow(m_wndBrowser.m_hWnd)) </span></p> 
 <p><span style="color:rgb(51,51,51)">{ </span></p> 
 <p><span style="color:rgb(51,51,51)">CRect rect; </span></p> 
 <p><span style="color:rgb(51,51,51)">GetClientRect(rect); </span></p> 
 <p><span style="color:rgb(51,51,51)">// 就这一句与CHtmlView的不同</span></p> 
 <p><span style="color:rgb(51,51,51)">::AdjustWindowRectEx(rect, GetStyle(), FALSE, WS_EX_CLIENTEDGE);</span></p> 
 <p><span style="color:rgb(51,51,51)">m_wndBrowser.SetWindowPos(NULL, </span></p> 
 <p><span style="color:rgb(51,51,51)">                          rect.left, </span></p> 
 <p><span style="color:rgb(51,51,51)">                          rect.top, </span></p> 
 <p><span style="color:rgb(51,51,51)">                          rect.Width(), </span></p> 
 <p><span style="color:rgb(51,51,51)">                          rect.Height(), </span></p> 
 <p><span style="color:rgb(51,51,51)">                          SWP_NOACTIVATE | SWP_NOZORDER); </span></p> 
 <p><span style="color:rgb(51,51,51)">} </span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)"><br> <a name="%E6%80%8E%E6%A0%B7%E5%A4%84%E7%90%86%E6%B5%8F%E8%A7%88%E5%99%A8%E5%86%85%E7%9A%84%E6%8B%96%E6%94%BE"></a></span>怎样处理浏览器内的拖放<span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　有时可能有这样的需求，我们希望在资源管理器里托一个文件到浏览器而做出相应的处理，甚至是将文件拖到某一个网页元素上来做出相应的处理，而浏览器默认的处理拖放文件操作是将文件打开，但<span style="font-family:Verdana">WebBrowser</span><span style="font-family:宋体">控件给了我们一个自己处理拖放的机会。 那就是在自定义的控制站点类中实现</span><span style="font-family:Verdana">IDocHostUIHandler</span><span style="font-family:宋体">，在接口</span><span style="font-family:Verdana">IDocHostUIHandler</span><span style="font-family:宋体">的</span><span style="font-family:Verdana">GetDropTarget</span><span style="font-family:宋体">方法中调用 浏览器类的</span><span style="font-family:Verdana">OnGetDropTarget</span><span style="font-family:宋体">虚函数。要处理网页内的拖放，必需在</span><span style="font-family:Verdana">OnGetDropTarget</span><span style="font-family:宋体">函数中返回一个自己定义的</span><span style="font-family:Verdana">IDropTarget</span><span style="font-family:宋体">接口指针， 所以我们自己写一个类</span><span style="font-family:Verdana">CMyOleDropTarget</span><span style="font-family:宋体">从</span><span style="font-family:Verdana">COleDropTarget</span><span style="font-family:宋体">类派生，并且在实现</span><span style="font-family:Verdana">IDropTarget</span><span style="font-family:宋体">接口，此类的代码在这就不列出了，请下载演示 程序，参考文件</span><span style="font-family:Verdana">MyOleDropTarget.h</span><span style="font-family:宋体">和</span><span style="font-family:Verdana">MyOleDropTarget.cpp</span><span style="font-family:宋体">。我们看</span><span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">中</span><span style="font-family:Verdana">OnGetDropTarget</span><span style="font-family:宋体">的代码 </span></span></p> 
 <p><span style="color:rgb(51,51,51)">HRESULT CLhpHtmlView::OnGetDropTarget(LPDROPTARGET pDropTarget, LPDROPTARGET* ppDropTarget )</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">m_DropTarget.SetIEDropTarget(pDropTarget);</span></p> 
 <p><span style="color:rgb(51,51,51)">LPDROPTARGET pMyDropTarget;</span></p> 
 <p><span style="color:rgb(51,51,51)">pMyDropTarget = (LPDROPTARGET)m_DropTarget.GetInterface(&amp;IID_IDropTarget);</span></p> 
 <p><span style="color:rgb(51,51,51)">if(pMyDropTarget)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">*ppDropTarget = pMyDropTarget;</span></p> 
 <p><span style="color:rgb(51,51,51)">pMyDropTarget-&gt;AddRef();</span></p> 
 <p><span style="color:rgb(51,51,51)">return S_OK;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">return S_FALSE;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">m_DropTarget<span style="font-family:宋体">即为自定义的处理拖放的对象。这样就能通过在从</span><span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">派生的类中重载</span><span style="font-family:Verdana">OnDragEnter</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">OnDragOver</span><span style="font-family:宋体">、 </span><span style="font-family:Verdana">OnDrop</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">OnDragLeave</span><span style="font-family:宋体">虚函数来处理拖放了。在这里顺带讲一下视图是怎样处理拖放的。 要使视图处理拖放，首先在视图里添加一个</span><span style="font-family:Verdana">COleDropTarget(</span><span style="font-family:宋体">或派生类</span><span style="font-family:Verdana">)</span><span style="font-family:宋体">成员变量，如</span><span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">中的</span><span style="font-family:Verdana">“CMyOleDropTarget m_DropTarget;”</span><span style="font-family:宋体">，再在 视图创建时调用</span><span style="font-family:Verdana">COleDropTarget</span><span style="font-family:宋体">对象的</span><span style="font-family:Verdana">Register</span><span style="font-family:宋体">，即把视图与</span><span style="font-family:Verdana">COleDropTarget</span><span style="font-family:宋体">对象关联起来，如</span><span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">中的</span><span style="font-family:Verdana">“m_DropTarget.Register(this);”</span><span style="font-family:宋体">，再对拖放 触发的事件进行相应的处理， </span><span style="font-family:Verdana">OnDragEnter </span><span style="font-family:宋体">把某对象拖入到视图时触发，在此检测拖入的对象是不是视图想接受的对象，如是返回</span><span style="font-family:Verdana">“DROPEFFECT_MOVE”</span><span style="font-family:宋体">表示接受此对象，如 </span></span></p> 
 <p><span style="color:rgb(51,51,51)">if(pDataObject-&gt;IsDataAvailable(CF_HDROP))// 被拖对象是文件吗？</span></p> 
 <p><span style="color:rgb(51,51,51)">return DROPEFFECT_MOVE;</span></p> 
 <p><span style="color:rgb(51,51,51)">OnDragOver <span style="font-family:宋体">被拖对象在视图上移动，同</span><span style="font-family:Verdana">OnDragEnter</span><span style="font-family:宋体">一样检测拖入对象，如果要接受此对象返回</span><span style="font-family:Verdana">“DROPEFFECT_MOVE”</span><span style="font-family:宋体">。 </span><span style="font-family:Verdana">OnDrop </span><span style="font-family:宋体">拖着被拖对象在视图上放开鼠标，在这里对拖入对象做出处理； </span><span style="font-family:Verdana">OnDragLeave </span><span style="font-family:宋体">拖着被拖对象离开视图。 </span><span style="font-family:Verdana">C++</span><span style="font-family:宋体">的代码写好了，但事情还没完，还必须在网页里用脚本对拖放事件进行处理， 即页面里哪个元素要接受拖放对象哪个元素就要处理</span><span style="font-family:Verdana">ondragenter</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">ondragover</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">ondrop</span><span style="font-family:宋体">，代码其实很简单，让事件的返回值为</span><span style="font-family:Verdana">false</span><span style="font-family:宋体">即可，这样 </span><span style="font-family:Verdana">C++</span><span style="font-family:宋体">的代码才有机会处理拖放事件，代码如下： </span></span></p> 
 <p><span style="color:rgb(51,51,51)">......</span></p> 
 <p><span style="color:rgb(51,51,51)">&lt;td οndragenter="event.returnValue = false" οndragοver="event.returnValue = false" \</span></p> 
 <p><span style="color:rgb(51,51,51)">οndrοp="event.returnValue = false"&gt;</span></p> 
 <p><span style="color:rgb(51,51,51)">......</span></p> 
 <p><span style="color:rgb(51,51,51)">如果要使整个视图都接受拖放，则在<span style="font-family:Verdana">Body</span><span style="font-family:宋体">元素中处理此三个事件。 注意：别忘了让工程对</span><span style="font-family:Verdana">OLE</span><span style="font-family:宋体">的支持即在初始化应用程序时调用</span><span style="font-family:Verdana">AfxOleInit()</span><span style="font-family:宋体">。</span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> <a name="%E6%80%8E%E6%A0%B7%E7%A6%81%E6%AD%A2%E7%BD%91%E9%A1%B5%E5%85%83%E7%B4%A0%E7%9A%84%E9%80%89%E5%8F%96"></a></span>怎样禁止网页元素的选取<span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">　　用网页做界面时多数情况下是不希望网页上的元素是能够被鼠标选中的， 要使网页元素不能被选中做法是：给浏览器的<span style="font-family:Verdana">“</span><span style="font-family:宋体">宿主信息标记</span><span style="font-family:Verdana">”</span><span style="font-family:宋体">加上</span><span style="font-family:Verdana">DOCHOSTUIFLAG_DIALOG</span><span style="font-family:宋体">标记。</span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">“<span style="font-family:宋体">宿主信息标记</span><span style="font-family:Verdana">”</span><span style="font-family:宋体">用</span><span style="font-family:Verdana">N</span><span style="font-family:宋体">个标记位来控制浏览器的许多性质，如： </span></span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">禁用浏览器的<span style="font-family:Verdana">3D</span><span style="font-family:宋体">的边缘； </span></span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">禁止滚动条； </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">禁用脚本； </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">定义双击处理的方式； </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">禁用浏览器的自动完成功能； </span></p> 
 <p><span style="color:rgb(51,51,51)">...... <span style="font-family:宋体">更多详情请参考</span><span style="font-family:Verdana">MSDN</span><span style="font-family:宋体">的</span><span style="font-family:Verdana">DOCHOSTUIFLAG</span><span style="font-family:宋体">帮助。</span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">怎样修改<span style="font-family:Verdana">“</span><span style="font-family:宋体">宿主信息标记</span><span style="font-family:Verdana">”</span><span style="font-family:宋体">？</span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">在<span style="font-family:Verdana">CDocHostSite</span><span style="font-family:宋体">中实现</span><span style="font-family:Verdana">IDocHostUIHandler</span><span style="font-family:宋体">， 在</span><span style="font-family:Verdana">GetHostInfo</span><span style="font-family:宋体">方法中调用浏览器的</span><span style="font-family:Verdana">OnGetHostInfo</span><span style="font-family:宋体">虚函数，在虚函数</span><span style="font-family:Verdana">OnGetHostInfo</span><span style="font-family:宋体">中便可指定</span><span style="font-family:Verdana">“</span><span style="font-family:宋体">宿主信息标记</span><span style="font-family:Verdana">”</span><span style="font-family:宋体">，如：</span></span></p> 
 <p><span style="color:rgb(51,51,51)">HRESULT CLhpHtmlView::OnGetHostInfo(DOCHOSTUIINFO * pInfo)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">pInfo-&gt;cbSize = sizeof(DOCHOSTUIINFO);</span></p> 
 <p><span style="color:rgb(51,51,51)">pInfo-&gt;dwFlags = DOCHOSTUIFLAG_DIALOG | </span></p> 
 <p><span style="color:rgb(51,51,51)">                    DOCHOSTUIFLAG_THEME  | </span></p> 
 <p><span style="color:rgb(51,51,51)">                    DOCHOSTUIFLAG_NO3DBORDER | </span></p> 
 <p><span style="color:rgb(51,51,51)">                    DOCHOSTUIFLAG_SCROLL_NO;</span></p> 
 <p><span style="color:rgb(51,51,51)">pInfo-&gt;dwDoubleClick = DOCHOSTUIDBLCLK_DEFAULT;</span></p> 
 <p><span style="color:rgb(51,51,51)">return S_OK;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">用脚本也可实现： 在<span style="font-family:Verdana">Head</span><span style="font-family:宋体">中加入脚本</span><span style="font-family:Verdana">: </span></span></p> 
 <p><span style="color:rgb(51,51,51)">document.onselectstart=new Function(''return false'');</span></p> 
 <p><span style="color:rgb(51,51,51)">或者 </span></p> 
 <p><span style="color:rgb(51,51,51)">&lt;body onselectstart="return false"&gt;。</span></p> 
 <p><span style="color:rgb(51,51,51)"><br> <a name="%E5%85%B6%E5%AE%83"></a></span>其它<span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">在<span style="font-family:Verdana">CLhpHtmlView</span><span style="font-family:宋体">中还提供了几个函数， 修改网页元素的内容： </span></span></p> 
 <p><span style="color:rgb(51,51,51)">BOOL PutElementHtml(CString ElemID,CString Html);</span></p> 
 <p><span style="color:rgb(51,51,51)">取表单元素的值： </span></p> 
 <p><span style="color:rgb(51,51,51)">BOOL GetElementValue(CString ElemID,CString&amp; Value);</span></p> 
 <p><span style="color:rgb(51,51,51)">设置表单元素的值： </span></p> 
 <p><span style="color:rgb(51,51,51)">BOOL PutElementValue(CString ElemID,CString Value);</span></p> 
 <p><span style="color:rgb(51,51,51)">给表单元素设置焦点： </span></p> 
 <p><span style="color:rgb(51,51,51)">void ElementSetFocus(CString EleName);</span></p> 
 <p><span style="color:rgb(51,51,51)">转载：</span><a href="http://www.vckbase.com/document/viewdoc/?id=1486" rel="nofollow"><span style="color:rgb(0,0,0)">http://www.vckbase.com/document/viewdoc/?id=1486</span></a></p> 
 <p><span style="color:rgb(51,51,51)">————————————————————————————————————————————————————————————————</span></p> 
 <p>自定义浏览器</p> 
 <p><span style="color:rgb(51,51,51)">本教程提供了自定义浏览器控件的行为和外观的一些方法。你将看到高级的宿主接口，IDocHostUIHandler, IDocHostUIHandler2, IDocHostShowUI, 和ICustomDoc。本文也讨论其他自定义方法，例如在宿主的IDispatch实现中处理DISPID_AMBIENT_DLCONTROL来进行下载控制；以及使用IHostDialogHelper。</span></p> 
 <p><span style="color:rgb(51,51,51)">本文分为如下章节</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">前提和需求</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">介绍</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">浏览器自定义架构</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">IDocHostUIHandler</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">IDocHostUIHandler2</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">GetOptionKeyPath 和 GetOverrideKeyPath</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">比较</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">控制导航</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">IDocHostShowUI</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">控制下载和</span><span style="color:rgb(51,51,51)">执行</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">IHostDialogHelper</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">控制新</span><span style="color:rgb(51,51,51)">的窗口</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">显示证书对话框</span><span style="color:rgb(255,0,0)">(New！)</span><span style="color:rgb(51,51,51)"> </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">信息栏</span><span style="color:rgb(255,0,0)">(New！)</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">结论</span></p> 
 <p>前提和需求</p> 
 <p><span style="color:rgb(51,51,51)">为了理解和使用本教程，你需要</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">对C++和COM的深入了解</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">熟悉</span><span style="color:rgb(51,51,51)">活动模板库 (ATL)</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">安装了Microsoft(R) Internet Explorer （IE）6 或更高版本</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">开发环境具有用于IE6或更高版本的头文件和库文件；特别是Mshtmhst.h.</span><span style="color:rgb(51,51,51)">（</span><span style="color:rgb(51,51,51)">译者注：可以在</span><a href="http://www.microsoft.com/msdownload/platformsdk/sdkupdate/" rel="nofollow"><span style="color:rgb(128,0,128)">http://www.microsoft.com/msdownload/platformsdk/sdkupdate/</span></a><span style="color:rgb(51,51,51)"> 这里下载最新的</span><span style="color:rgb(51,51,51)">Internet Development SDK</span><span style="color:rgb(51,51,51)">）</span></p> 
 <p><span style="color:rgb(51,51,51)">许多自定义特性是在IE5或者5.5版本就可以使用的，但是有几个特性需要IE6。一些特性需要IE6的Windows XP SP2版本。使用某个特性之前，应该检查参考文档以获得版本信息。</span></p> 
 <p>介绍</p> 
 <p><span style="color:rgb(51,51,51)">集成浏览器控件是快速软件开发的强有力的工具。通过成为浏览器的宿主，你可以利用便于使用的Dynamic HTML (DHTML), HTML, 和Extensible Markup Language (XML)来显示信息和开发一个用户界面。但是，浏览器控件的行为可能不确切符合你的需求。例如，默认的状态允许用户通过快捷菜单的查看源代码选项查看一个显示的页面的源代码，你可能需要禁用或者干脆去掉这个选项。你可能更进一步，需要用你自己的快捷菜单替换默认的快捷菜单。</span></p> 
 <p><span style="color:rgb(51,51,51)">在刚刚提到的自定义特性之外，高级宿主特性允许</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">在显示的页面上的按钮和其他控件可以调用你的应用程序的内建方法，有效地扩展DHTML对象模型(DOM)。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">改变拖放的行为</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">限制浏览器的导航，例如，限制于指定的页面/域，或者站点</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">捕获用户键入，并且在需要的时候处理。比如说，你可能需要捕获CTRL+O来阻止用户在新的IE中打开网页而不是使用你的程序打开，</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">改变默认字体和显示设置</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">控制下载内容，以及当下载完成之后浏览器的处理。例如，你可能禁用视频的播放，脚本的执行，点击链接时打开新的窗口，或者Microsoft(R) ActiveX 控件的下载和执行。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">限制查看源代码</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">捕获搜索</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">捕获导航错误</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">替代/修改快捷菜单或者禁用，替代，自定义，或者添加快捷菜单项</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">为你的应用程序改变注册表设定</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">控制和修改浏览器控件显示的消息框</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">控制新窗口的创建方式</span></p> 
 <p><span style="color:rgb(51,51,51)">在下列</span><span style="color:rgb(51,51,51)">节</span><span style="color:rgb(51,51,51)">中，我们将会</span><span style="color:rgb(51,51,51)">看到</span><span style="color:rgb(51,51,51)">多数</span><span style="color:rgb(51,51,51)">，但是不是全部</span><span style="color:rgb(51,51,51)">的这些可能性而且讨论该如何实现他们。</span></p> 
 <p>浏览器自定义架构</p> 
 <h4>介绍 <span style="font-family:Calibri">IDocHostUIHandler </span><span style="font-family:宋体">， </span><span style="font-family:Calibri">IDocHostUIHander2 </span><span style="font-family:宋体">， </span><span style="font-family:Calibri">IDocHostShowUI </span><span style="font-family:宋体">和 </span><span style="font-family:Calibri">ICustomDoc</span></h4> 
 <p><span style="color:rgb(51,51,51)">下面</span><span style="color:rgb(51,51,51)">三个</span><span style="color:rgb(51,51,51)">接口是浏览器控件用户界面的自定义</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">核心</span><span style="color:rgb(51,51,51)">:IDocHostUIHandler ，IDocHostUIHandler2 和 IDocHostShowUI。当你修改</span><span style="color:rgb(51,51,51)">浏览器控件</span><span style="color:rgb(51,51,51)">的时候 , 这些是你在你的应用程序中实现的</span><span style="color:rgb(51,51,51)">接口</span><span style="color:rgb(51,51,51)">。也有一些服务</span><span style="color:rgb(51,51,51)">接口</span><span style="color:rgb(51,51,51)">。 ICustomDoc 被MSHTML实现并且提供一个方法</span><span style="color:rgb(51,51,51)">在某些情况下能够自定义浏览器控件</span><span style="color:rgb(51,51,51)">。IHostDialogHelper提供一个方法</span><span style="color:rgb(51,51,51)">打开可信</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">对话框</span><span style="color:rgb(51,51,51)">,没有</span><span style="color:rgb(51,51,51)">像IE对话框那样</span><span style="color:rgb(51,51,51)">为他们</span><span style="color:rgb(51,51,51)">（译者注：在标题栏上）</span><span style="color:rgb(51,51,51)">作标记。</span></p> 
 <p><span style="color:rgb(51,51,51)">除了使用这些</span><span style="color:rgb(51,51,51)">接口</span><span style="color:rgb(51,51,51)">,</span><span style="color:rgb(51,51,51)">你还可以</span><span style="color:rgb(51,51,51)">做其他</span><span style="color:rgb(51,51,51)">两</span><span style="color:rgb(51,51,51)">件事。</span><span style="color:rgb(51,51,51)">其</span><span style="color:rgb(51,51,51)">一，你能</span><span style="color:rgb(51,51,51)">通过在</span><span style="color:rgb(51,51,51)">IDispatch</span><span style="color:rgb(51,51,51)">实现中</span><span style="color:rgb(51,51,51)">拦截</span><span style="color:rgb(51,51,51)">环境</span><span style="color:rgb(51,51,51)">特性</span><span style="color:rgb(51,51,51)">的变化来</span><span style="color:rgb(51,51,51)">控制下载</span><span style="color:rgb(51,51,51)">；</span><span style="color:rgb(51,51,51)">其次，你能</span><span style="color:rgb(51,51,51)">通过在</span><span style="color:rgb(51,51,51)">IDispatch</span><span style="color:rgb(51,51,51)">实现中</span><span style="color:rgb(51,51,51)">拦截DISPID_NEWWINDOW2</span><span style="color:rgb(51,51,51)">来</span><span style="color:rgb(51,51,51)">控制</span><span style="color:rgb(51,51,51)">窗口的创建方式</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">译者注：MFC7中的DHTML类，例如CHtmlView和CDHtmlDialog实现了这些接口，但是对于使用其他的类库的程序员，可能需要自己实现这些接口。</span></p> 
 <h4>如何工作</h4> 
 <p><span style="color:rgb(51,51,51)">当一个容器提供对ActiveX </span><span style="color:rgb(51,51,51)">控件</span><span style="color:rgb(51,51,51)">支持</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">时候 , </span><span style="color:rgb(51,51,51)">浏览器控件自定义</span><span style="color:rgb(51,51,51)">机制被设计</span><span style="color:rgb(51,51,51)">为被</span><span style="color:rgb(51,51,51)">自动化。</span><span style="color:rgb(51,51,51)">当浏览器控件</span><span style="color:rgb(51,51,51)">被实例化</span><span style="color:rgb(51,51,51)">的时候</span><span style="color:rgb(51,51,51)">,如果</span><span style="color:rgb(51,51,51)">可能的话，</span><span style="color:rgb(51,51,51)">它尝试找来自</span><span style="color:rgb(51,51,51)">宿主</span><span style="color:rgb(51,51,51)">的 IDocHostUIHandler ， IDocHostUIHandler2 和 IDocHostShowUI </span><span style="color:rgb(51,51,51)">实现</span><span style="color:rgb(51,51,51)">。</span><span style="color:rgb(51,51,51)">浏览器控件通过调用宿主的</span><span style="color:rgb(51,51,51)">IOleClientSite</span><span style="color:rgb(51,51,51)">接口</span><span style="color:rgb(51,51,51)">的一个QueryInterface</span><span style="color:rgb(51,51,51)">方法来查找。</span></p> 
 <p><span style="color:rgb(51,51,51)">译者注：IE5.5有个Bug,没有查询</span><span style="color:rgb(51,51,51)">IDocHostUIHandler2 </span><span style="color:rgb(51,51,51)">接口的实现，这使得宿主程序不能覆盖默认的参数。需要更多信息的话，参考微软知识库文章 </span><span style="color:rgb(51,51,51)">Q272968 BUG:</span><span style="color:rgb(51,51,51)">IDocHostUIHandler2 </span><span style="color:rgb(51,51,51)">没有在浏览器控件中调用。</span></p> 
 <p><span style="color:rgb(51,51,51)">这一个结构为一个实现一个IOleClientSite</span><span style="color:rgb(51,51,51)">接口</span><span style="color:rgb(51,51,51)">的应用程序自动地工作</span><span style="color:rgb(51,51,51)">，通过调用</span><span style="color:rgb(51,51,51)">浏览器的IOleObject::SetClientSite</span><span style="color:rgb(51,51,51)">方法传递给浏览器控件</span><span style="color:rgb(51,51,51)">一个IOleClientSite</span><span style="color:rgb(51,51,51)">接口。浏览器控件</span><span style="color:rgb(51,51,51)">的一个典型的实例化可能看起来像这样:</span></p> 
 <p><span style="color:rgb(51,51,51)">例子</span></p> 
 <p><span style="color:rgb(0,128,0)">//</span><span style="color:rgb(0,128,0)">为了明确起见，</span><span style="color:rgb(0,128,0)">省略错误检查</span></p> 
 <p><span style="color:rgb(0,0,255)">CComPtr</span><span style="color:rgb(51,51,51)">&lt;</span><span style="color:rgb(0,0,255)">IOleObject</span><span style="color:rgb(51,51,51)">&gt; spOleObj;</span></p> 
 <p><span style="color:rgb(0,128,0)">//</span><span style="color:rgb(0,128,0)">创建</span><span style="color:rgb(0,128,0)"> WebBrowser--</span><span style="color:rgb(0,128,0)">在</span><span style="color:rgb(0,128,0)">类成员</span><span style="color:rgb(0,128,0)">变量</span><span style="color:rgb(0,128,0)"> m_spWebBrowser</span><span style="color:rgb(0,128,0)">中保存指针</span></p> 
 <p><span style="color:rgb(0,0,255)">CoCreateInstance</span><span style="color:rgb(51,51,51)">(CLSID_WebBrowser, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">CLSCTX_INPROC</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">IID_IWebBrowser2</span><span style="color:rgb(51,51,51)">, (</span><span style="color:rgb(0,0,255)">void</span><span style="color:rgb(51,51,51)">**)&amp;m_spWebBrowser);</span></p> 
 <p><span style="color:rgb(0,128,0)">// </span><span style="color:rgb(0,128,0)">查询</span><span style="color:rgb(0,128,0)">WebBrowser</span><span style="color:rgb(0,128,0)">的</span><span style="color:rgb(0,128,0)">IOleObject</span><span style="color:rgb(0,128,0)">接口</span></p> 
 <p><span style="color:rgb(51,51,51)">m_spWebBrowser-&gt;</span><span style="color:rgb(0,0,255)">QueryInterface</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">IID_IOleObject</span><span style="color:rgb(51,51,51)">, (</span><span style="color:rgb(0,0,255)">void</span><span style="color:rgb(51,51,51)">**)&amp;spOleObj);</span></p> 
 <p><span style="color:rgb(0,128,0)">//</span><span style="color:rgb(0,128,0)">设置用户站点</span></p> 
 <p><span style="color:rgb(51,51,51)">spOleObj-&gt;</span><span style="color:rgb(0,0,255)">SetClientSite</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">this</span><span style="color:rgb(51,51,51)">);</span></p> 
 <p><span style="color:rgb(0,128,0)">//</span><span style="color:rgb(0,128,0)">本地激活浏览器控件</span></p> 
 <p><span style="color:rgb(0,0,255)">RECT</span><span style="color:rgb(51,51,51)"> rcClient</span></p> 
 <p><span style="color:rgb(0,0,255)">GetClientRect</span><span style="color:rgb(51,51,51)">(&amp;rcClient);</span></p> 
 <p><span style="color:rgb(51,51,51)">spOleObj-&gt;</span><span style="color:rgb(0,0,255)">DoVerb</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">OLEIVERB_INPLACEACTIVATE</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">this</span><span style="color:rgb(51,51,51)">, 0, </span><span style="color:rgb(0,0,255)">GetTopLevelWindow</span><span style="color:rgb(51,51,51)">(), &amp;rcClient);</span></p> 
 <p><span style="color:rgb(0,128,0)">//容器拦截</span><span style="color:rgb(0,128,0)">浏览器</span><span style="color:rgb(0,128,0)">事件</span><span style="color:rgb(0,128,0)">的注册</span></p> 
 <p><span style="color:rgb(0,0,255)">AtlAdvise</span><span style="color:rgb(51,51,51)">(m_spWebBrowser,</span><span style="color:rgb(0,0,255)">GetUnknown</span><span style="color:rgb(51,51,51)">(), </span><span style="color:rgb(0,0,255)">DIID_DWebBrowserEvents2</span><span style="color:rgb(51,51,51)">,&amp;m_dwCookie);</span></p> 
 <p><span style="color:rgb(0,128,0)">//</span><span style="color:rgb(0,128,0)">导航到</span><span style="color:rgb(0,128,0)">启动页</span></p> 
 <p><span style="color:rgb(51,51,51)">m_spWebBrowser-&gt;</span><span style="color:rgb(0,0,255)">Navigate</span><span style="color:rgb(51,51,51)">(L"res://webhost.exe/startpage.htm", </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">);</span></p> 
 <p><span style="color:rgb(51,51,51)">然而，如果你的应用程序没有一个IOleClientSite接口,你并没失去全部希望。IE提供ICustomDoc接口，这样你能自己传递你的IDocHostUIHandler接口给浏览器。你不能使用IDocHostUIHandler2和 IDocHostShowUI接口而不提供一个</span><span style="color:rgb(51,51,51)">浏览器控件宿主的</span><span style="color:rgb(51,51,51)">IOleClientSite接口。</span></p> 
 <p><span style="color:rgb(51,51,51)">译者注：</span></p> 
 <p><span style="color:rgb(51,51,51)">MFC7中引入的类COleControlContainer和一大堆DHTML类曾经搞得我晕头转向，最后我不得不放弃了自己对</span><span style="color:rgb(51,51,51)">IOleClientSite</span><span style="color:rgb(51,51,51)">的实现，而通过ICustomDoc来显式地设置</span><span style="color:rgb(51,51,51)">IDocHostUIHandler</span><span style="color:rgb(51,51,51)">接口。这样必须在第一个页面下载完成之后才能够开始自定义浏览器，因为暴露ICustomDoc接口的对象只有在第一个页面下载完成之后才可用。一个ICustomDoc的示例可以在CSDN文档中心找到，网址是</span><a href="http://www.csdn.net/develop/Read_Article.asp?Id=8813"><span style="color:rgb(0,0,0)">http://www.csdn.net/develop/Read_Article.asp?Id=8813</span></a></p> 
 <p><span style="color:rgb(51,51,51)">当浏览器控件获得了对这些接口之中的任何一个的一个指针的时候,接口的方法在适当的时候在浏览器控件的生命期中被调用。举例来说, 当用户右击在浏览器控件的客户区的任何地点时,在IE显示它的默认快捷菜单之前，你的IDocHostUIHandler::ShowContextMenu的实现将会被调用。这给你一个机会显示你自己的快捷菜单而且取消IE的快捷菜单显示。</span></p> 
 <p><span style="color:rgb(51,51,51)">译者注：一些</span><span style="color:rgb(51,51,51)">屏蔽快捷菜单</span><span style="color:rgb(51,51,51)">的示例可以在CSDN文档中心找到，网址是</span><a href="http://www.csdn.net/develop/article/18/18541.shtm"><span style="color:rgb(0,0,0)">http://www.csdn.net/develop/article/18/18541.shtm</span></a></p> 
 <p><span style="color:rgb(51,51,51)">当初始化浏览器控件的时候 ,记住几个重点。你的应用程序应该使用 OleInitialize而不是CoInitialize启动COM。OleInitialize启用剪贴簿支持，拖放，对象连接与嵌入(OLE)和本地激活。当你的应用程序结束的时候使用OleUninitialize关闭COM库。</span></p> 
 <p><span style="color:rgb(51,51,51)">ATL COM 向导使用 CoInitialize而不是OleInitialize打开COM库。 如果你使用这一个向导建立一个可运行的程序,你需要将 CoInitialize 和 CoUninitialize 调用换成 OleInitialize 和 OleUninitialize。对于一个微软基础类 (MFC) 应用程序, 确定你的应用程序调用 AfxOleInit, 它在它的初始化程序中调用OleInitialize。</span></p> 
 <p><span style="color:rgb(51,51,51)">如果你不需要在你的应用程序中支持拖放,你可以调用IWebBrowser2::RegisterAsDropTarget,传递VARIANT_TRUE(</span><span style="color:rgb(51,51,51)">译者注：原文如此，按照接口</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">文档，似乎应该传递VARIANT_FALSE</span><span style="color:rgb(51,51,51)">), 避免任何在你的浏览器控件实例上的拖放操作。</span></p> 
 <p><span style="color:rgb(51,51,51)">一个浏览器控件宿主应用程序也需要IOleInPlaceSite的一个实现, 由于 IOleInPlaceSite派生自IOleWindow，应用程序将需要IOleWindow的一个实现。你需要这些实现使得你的应用程序具有一个窗口，显示浏览器控件，以及处理它的显示设置。</span></p> 
 <p><span style="color:rgb(51,51,51)">这些接口和IOleClientSite的实现在许多情况可能是最小的或不存在的。IOleClientSite的所有方法都可以返回E_NOTIMPL。 一些IOleInPlaceSite和IOleWindow的方法需要一个实现来覆盖返回值。可以在示例代码中查看IOleInPlaceSite和IOleWindow的最小实现的样例代码。</span></p> 
 <p><span style="color:rgb(51,51,51)">既然我们已经完成了初始化的准备,让我们看一看浏览器控件自定义的每一个接口。</span></p> 
 <p>IDocHostUIHandler</p> 
 <p><span style="color:rgb(51,51,51)">IDocHostUIHandler自IE5以后已经是可用的。它提供15个方法。大体上，一些较重要的方法是IDocHostUIHandler::GetExternal, IDocHostUIHandler::GetHostInfo, IDocHostUIHandler::GetOptionKeyPath, IDocHostUIHandler::ShowContextMenu, 和 IDocHostUIHandler::TranslateAccelerator。当然，方法对你的重要性将会依赖于你的应用程序。</span></p> 
 <h4>IDocHostUIHandler::GetHostInfo</h4> 
 <p><span style="color:rgb(51,51,51)">你使用IDocHostUIHandler::GetHostInfo</span><span style="color:rgb(51,51,51)">告诉</span><span style="color:rgb(51,51,51)">MSHTML有关你的应用程序的能力和需求。</span><span style="color:rgb(51,51,51)">通过</span><span style="color:rgb(51,51,51)">它你能控制</span><span style="color:rgb(51,51,51)">很多东西</span><span style="color:rgb(51,51,51)">, 举例来说。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">你能</span><span style="color:rgb(51,51,51)">禁用</span><span style="color:rgb(51,51,51)">浏览器的3D的边缘。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">你能避免</span><span style="color:rgb(51,51,51)">滚动条</span><span style="color:rgb(51,51,51)">或改变他们的</span><span style="color:rgb(51,51,51)">外观</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">你能</span><span style="color:rgb(51,51,51)">禁用脚本</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">你能定义</span><span style="color:rgb(51,51,51)">双击</span><span style="color:rgb(51,51,51)">处理</span><span style="color:rgb(51,51,51)">的方式</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">你能禁用浏览器的自动完成功能。</span></p> 
 <p><span style="color:rgb(51,51,51)">IDocHostUIHandler::GetHostInfo有一个</span><span style="color:rgb(51,51,51)">参数</span><span style="color:rgb(51,51,51)">，被 MSHTML</span><span style="color:rgb(51,51,51)">分配</span><span style="color:rgb(51,51,51)">的DOCHOSTUIINFO 结构的一个</span><span style="color:rgb(51,51,51)">指针</span><span style="color:rgb(51,51,51)">。你的工作</span><span style="color:rgb(51,51,51)">是</span><span style="color:rgb(51,51,51)">要将</span><span style="color:rgb(51,51,51)">在</span><span style="color:rgb(51,51,51)">结构</span><span style="color:rgb(51,51,51)">中填充</span><span style="color:rgb(51,51,51)">你传给MSHTML的信息。</span></p> 
 <p><span style="color:rgb(51,51,51)">DOCHOSTUIINFO结构有四个成员。第一个成员是 cbSize,是结构的大小。你应该自己</span><span style="color:rgb(51,51,51)">像下面的示例代码那样设置</span><span style="color:rgb(51,51,51)">。第二个成员是dwFlags</span><span style="color:rgb(51,51,51)">，由</span><span style="color:rgb(51,51,51)">来自DOCHOSTUIFLAG</span><span style="color:rgb(51,51,51)">枚举的数值位与组成。</span><span style="color:rgb(51,51,51)">第三</span><span style="color:rgb(51,51,51)">个</span><span style="color:rgb(51,51,51)">成员是dwDoubleClick,来自DOCHOSTUIDBLCLK</span><span style="color:rgb(51,51,51)">枚举</span><span style="color:rgb(51,51,51)">的一个数值。第四个成员是pchHostCss。你</span><span style="color:rgb(51,51,51)">可以</span><span style="color:rgb(51,51,51)">将pchHostCss设定为浏览器控件显示</span><span style="color:rgb(51,51,51)">的页面中应用的全局</span><span style="color:rgb(51,51,51)">样式表(CSS)</span><span style="color:rgb(51,51,51)">规则的一个字符串的指针。</span><span style="color:rgb(51,51,51)">DOCHOSTUIINFO 的最后</span><span style="color:rgb(51,51,51)">一个</span><span style="color:rgb(51,51,51)">成员是pchHostNs。</span><span style="color:rgb(51,51,51)">你可以设置为你提供的</span><span style="color:rgb(51,51,51)">分号</span><span style="color:rgb(51,51,51)">分隔的命名空间列表字符串</span><span style="color:rgb(51,51,51)">。在你正在浏览器控件中显示的页上</span><span style="color:rgb(51,51,51)">使用自定义标签</span><span style="color:rgb(51,51,51)">的时候使用这一个成员。这样你能</span><span style="color:rgb(51,51,51)">声明一个全局的命名空间列表，</span><span style="color:rgb(51,51,51)">而不需要在每个显示</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">页</span><span style="color:rgb(51,51,51)">面</span><span style="color:rgb(51,51,51)">上</span><span style="color:rgb(51,51,51)">声明</span><span style="color:rgb(51,51,51)">他们。</span></p> 
 <p><span style="color:rgb(51,51,51)">确定使用CoTaskMemAlloc为pchHostCss或pchHostNS</span><span style="color:rgb(51,51,51)">分配字符串</span><span style="color:rgb(51,51,51)">。</span><span style="color:rgb(51,51,51)">（</span><span style="color:rgb(51,51,51)">译者注：看起来调用者用CoTaskMemFree释放这些字符串</span><span style="color:rgb(51,51,51)">）。</span></p> 
 <p><span style="color:rgb(51,51,51)">例子</span></p> 
 <p><span style="color:rgb(51,51,51)">HRESULT GetHostInfo( </span><span style="color:rgb(0,0,255)">DOCHOSTUIINFO</span><span style="color:rgb(51,51,51)">* pInfo)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">WCHAR</span><span style="color:rgb(51,51,51)">* szCSS = L"BODY {background-color:#ffcccc}";</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">WCHAR</span><span style="color:rgb(51,51,51)">* szNS = L"IE;MyTags;MyTags2='www.microsoft.com'";</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">#define CCHMAX 256</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">size_t</span><span style="color:rgb(51,51,51)"> cchLengthCSS,cchLengthszNS;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">HRESULT</span><span style="color:rgb(51,51,51)"> hr=</span><span style="color:rgb(0,0,255)">StringCchLengthW</span><span style="color:rgb(51,51,51)">(szCSS, CCHMAX,&amp;cchLengthCSS)</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//TODO: 在这里处理错误。</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">OLECHAR</span><span style="color:rgb(51,51,51)">* pCSSBuffer=(</span><span style="color:rgb(0,0,255)">OLECHAR</span><span style="color:rgb(51,51,51)">*) </span><span style="color:rgb(0,0,255)">CoTaskMemAlloc</span><span style="color:rgb(51,51,51)">((cchLengthCSS+1)*</span><span style="color:rgb(0,0,255)">sizeof</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">OLECHAR</span><span style="color:rgb(51,51,51)">));</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//TODO: 在这里处理错误</span><span style="color:rgb(0,128,0)">，</span><span style="color:rgb(0,128,0)">确定</span><span style="color:rgb(0,128,0)">内存</span><span style="color:rgb(0,128,0)">成功地被</span><span style="color:rgb(0,128,0)">分配</span><span style="color:rgb(0,128,0)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">hr=</span><span style="color:rgb(0,0,255)">StringCchLengthW</span><span style="color:rgb(51,51,51)">(szNS, CCHMAX,&amp;cchLengthszNS)</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//TODO: 在这里处理错误。</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">OLECHAR</span><span style="color:rgb(51,51,51)">* pNSBuffer=(</span><span style="color:rgb(0,0,255)">OLECHAR</span><span style="color:rgb(51,51,51)">*) </span><span style="color:rgb(0,0,255)">CoTaskMemAlloc</span><span style="color:rgb(51,51,51)">((cchLengthszNS+1)*</span><span style="color:rgb(0,0,255)">sizeof</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">OLECHAR</span><span style="color:rgb(51,51,51)">));</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//TODO: 在这里处理错误</span><span style="color:rgb(0,128,0)">，</span><span style="color:rgb(0,128,0)">确定</span><span style="color:rgb(0,128,0)">内存</span><span style="color:rgb(0,128,0)">成功地被</span><span style="color:rgb(0,128,0)">分配</span><span style="color:rgb(0,128,0)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">hr=</span><span style="color:rgb(0,0,255)">StringCchCopyW</span><span style="color:rgb(51,51,51)">(pCSSBuffer ， cchLengthCSS+1,szCSS)</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//TODO: 在这里处理错误。</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">hr=</span><span style="color:rgb(0,0,255)">StringCchCopyW</span><span style="color:rgb(51,51,51)">(pNSBuffer ， cchLengthszNS+1,szNS)</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//TODO: 在这里处理错误。</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">pInfo-&gt; cbSize= </span><span style="color:rgb(0,0,255)">sizeof</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">DOCHOSTUIINFO</span><span style="color:rgb(51,51,51)">)</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">pInfo-&gt; dwFlags=</span><span style="color:rgb(0,0,255)">DOCHOSTUIFLAG_NO3DBORDER</span><span style="color:rgb(51,51,51)">|</span><span style="color:rgb(0,0,255)">DOCHOSTUIFLAG_SCROLL_NO|DOCHOSTUIFLAG_ENABLE_FORMS_AUTOCOMPLETE</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">pInfo-&gt; dwDoubleClick= </span><span style="color:rgb(0,0,255)">DOCHOSTUIDBLCLK_DEFAULT</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">pInfo-&gt; pchHostCss= pCSSBuffer;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">pInfo-&gt; pchHostNS= pNSBuffer;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">return</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(0,0,255)">S_OK</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">如果你</span><span style="color:rgb(51,51,51)">没有什么需要告诉</span><span style="color:rgb(51,51,51)">MSHTML</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">,你</span><span style="color:rgb(51,51,51)">可以在这</span><span style="color:rgb(51,51,51)">个方法</span><span style="color:rgb(51,51,51)">中返回</span><span style="color:rgb(51,51,51)">E_NOTIMPL 。</span></p> 
 <p>IDocHostUIHandler::ShowContextMenu</p> 
 <p><span style="color:rgb(51,51,51)">通过实现这一个方法, 你</span><span style="color:rgb(51,51,51)">获得</span><span style="color:rgb(51,51,51)">在</span><span style="color:rgb(51,51,51)">当</span><span style="color:rgb(51,51,51)">一个</span><span style="color:rgb(51,51,51)">用户</span><span style="color:rgb(51,51,51)">右击</span><span style="color:rgb(51,51,51)">时</span><span style="color:rgb(51,51,51)">被浏览器控件显示的快捷菜单的控制。你能通过</span><span style="color:rgb(51,51,51)">在</span><span style="color:rgb(51,51,51)">这个方法</span><span style="color:rgb(51,51,51)">中</span><span style="color:rgb(51,51,51)">返回S_OK 阻止IE显示它的默认快捷菜单。返回一些其他的数值 , 像S_FALSE或E_NOTIMPL,允许IE</span><span style="color:rgb(51,51,51)">继续执行</span><span style="color:rgb(51,51,51)">它的默认快捷菜单行为。</span></p> 
 <p><span style="color:rgb(51,51,51)">如果你</span><span style="color:rgb(51,51,51)">仅仅</span><span style="color:rgb(51,51,51)">在这个方法中</span><span style="color:rgb(51,51,51)">返回</span><span style="color:rgb(51,51,51)">S_OK, 你能避免任何浏览器控件的右击行为。 这可能是你在许多</span><span style="color:rgb(51,51,51)">场合</span><span style="color:rgb(51,51,51)">中的全部</span><span style="color:rgb(51,51,51)">需求</span><span style="color:rgb(51,51,51)">，但是你能做</span><span style="color:rgb(51,51,51)">到</span><span style="color:rgb(51,51,51)">更多。</span><span style="color:rgb(51,51,51)">通常</span><span style="color:rgb(51,51,51)">,你使用这一个方法在返回 S_OK 之前产生并且显示你自己的快捷菜单。如果你</span><span style="color:rgb(51,51,51)">知道</span><span style="color:rgb(51,51,51)">浏览器控件显示</span><span style="color:rgb(51,51,51)">的菜单的</span><span style="color:rgb(51,51,51)">资源，而且它如何选择他们,你能也有效地</span><span style="color:rgb(51,51,51)">自定义</span><span style="color:rgb(51,51,51)">默认的浏览器控件快捷菜单。让我们</span><span style="color:rgb(51,51,51)">看看它如何工作</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">浏览器控件由Shdoclc.dll</span><span style="color:rgb(51,51,51)">获得</span><span style="color:rgb(51,51,51)">它的快捷菜单资源。</span><span style="color:rgb(51,51,51)">这个</span><span style="color:rgb(51,51,51)">知识和一些 #</span><span style="color:rgb(51,51,51)">define</span><span style="color:rgb(51,51,51)">给予你一个机会操纵浏览器的</span><span style="color:rgb(51,51,51)">菜单</span><span style="color:rgb(51,51,51)">。让我们举例来说</span><span style="color:rgb(51,51,51)">，假定</span><span style="color:rgb(51,51,51)">你对默认菜单感到满意,除了你想要除去</span><span style="color:rgb(51,51,51)">查看</span><span style="color:rgb(51,51,51)">源</span><span style="color:rgb(51,51,51)">代码</span><span style="color:rgb(51,51,51)">项</span><span style="color:rgb(51,51,51)">之外</span><span style="color:rgb(51,51,51)">。下列</span><span style="color:rgb(51,51,51)">代码</span><span style="color:rgb(51,51,51)">载入来自Shdoclc.dll的浏览器控件快捷菜单资源,根据环境选择正确的菜单,移除IDM_VIEWSOURCE</span><span style="color:rgb(51,51,51)">命令</span><span style="color:rgb(51,51,51)">对</span><span style="color:rgb(51,51,51)">应的菜单项</span><span style="color:rgb(51,51,51)">,然后显示</span><span style="color:rgb(51,51,51)">菜单</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">例子</span></p> 
 <p><span style="color:rgb(0,0,255)">HRESULT</span><span style="color:rgb(51,51,51)"> CBrowserHost::</span><span style="color:rgb(0,0,255)">ShowContextMenu</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">DWORD</span><span style="color:rgb(51,51,51)"> dwID,</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">POINT</span><span style="color:rgb(51,51,51)"> *ppt,</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">IUnknown</span><span style="color:rgb(51,51,51)"> *pcmdTarget,</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">IDispatch</span><span style="color:rgb(51,51,51)"> *pdispObject)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">#define IDR_BROWSE_CONTEXT_MENU 24641</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">#define IDR_FORM_CONTEXT_MENU 24640</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">#define SHDVID_GETMIMECSETMENU 27</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">#define SHDVID_ADDMENUEXTENSIONS 53</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">HRESULT</span><span style="color:rgb(51,51,51)"> hr;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">HINSTANCE</span><span style="color:rgb(51,51,51)"> hinstSHDOCLC;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">HWND</span><span style="color:rgb(51,51,51)"> hwnd;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">HMENU</span><span style="color:rgb(51,51,51)"> hMenu;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">CComPtr</span><span style="color:rgb(51,51,51)">&lt;</span><span style="color:rgb(0,0,255)">IOleCommandTarget</span><span style="color:rgb(51,51,51)">&gt; spCT;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">CComPtr</span><span style="color:rgb(51,51,51)">&lt;</span><span style="color:rgb(0,0,255)">IOleWindow</span><span style="color:rgb(51,51,51)">&gt; spWnd;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">MENUITEMINFO</span><span style="color:rgb(51,51,51)"> mii={0};</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">CComVariant</span><span style="color:rgb(51,51,51)"> var, var1, var2;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">hr = pcmdTarget-&gt;</span><span style="color:rgb(0,0,255)">QueryInterface</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">IID_IOleCommandTarget</span><span style="color:rgb(51,51,51)">, (</span><span style="color:rgb(0,0,255)">void</span><span style="color:rgb(51,51,51)">**)&amp;spCT);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">hr = pcmdTarget-&gt;</span><span style="color:rgb(0,0,255)">QueryInterface</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">IID_IOleWindow</span><span style="color:rgb(51,51,51)">, (</span><span style="color:rgb(0,0,255)">void</span><span style="color:rgb(51,51,51)">**)&amp;spWnd);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">hr = spWnd-&gt;</span><span style="color:rgb(0,0,255)">GetWindow</span><span style="color:rgb(51,51,51)">(&amp;hwnd);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">hinstSHDOCLC = </span><span style="color:rgb(0,0,255)">LoadLibrary</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">TEXT</span><span style="color:rgb(51,51,51)">("SHDOCLC.DLL"));</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">if</span><span style="color:rgb(51,51,51)"> (hinstSHDOCLC == </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">)</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(0,128,0)">        </span><span style="color:rgb(0,128,0)">// 载入模块错误 -- 尽可能安全地失败</span></p> 
 <p><span style="color:rgb(0,0,255)">        </span><span style="color:rgb(0,0,255)">return</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">hMenu=</span><span style="color:rgb(0,0,255)">LoadMenu</span><span style="color:rgb(51,51,51)">(hinstSHDOCLC,</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">    MAKEINTRESOURCE</span><span style="color:rgb(51,51,51)">(IDR_BROWSE_CONTEXT_MENU));</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">hMenu=</span><span style="color:rgb(0,0,255)">GetSubMenu</span><span style="color:rgb(51,51,51)">(hMenu,dwID)</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//</span><span style="color:rgb(0,128,0)">获得</span><span style="color:rgb(0,128,0)">语言子菜单</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">hr = spCT-&gt;</span><span style="color:rgb(0,0,255)">Exec</span><span style="color:rgb(51,51,51)">(&amp;</span><span style="color:rgb(0,0,255)">CGID_ShellDocView</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">SHDVID_GETMIMECSETMENU</span><span style="color:rgb(51,51,51)">, 0, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, &amp;var);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">mii.cbSize = </span><span style="color:rgb(0,0,255)">sizeof</span><span style="color:rgb(51,51,51)">(mii);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">mii.fMask = MIIM_SUBMENU;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">mii.hSubMenu = (</span><span style="color:rgb(0,0,255)">HMENU</span><span style="color:rgb(51,51,51)">) var.byref;</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//加入语言子菜单</span><span style="color:rgb(0,128,0)">到编码</span><span style="color:rgb(0,128,0)">上下文</span><span style="color:rgb(0,128,0)">菜单</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">SetMenuItemInfo</span><span style="color:rgb(51,51,51)">(hMenu, IDM_LANGUAGE, </span><span style="color:rgb(0,0,255)">FALSE</span><span style="color:rgb(51,51,51)">, &amp;mii);</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//插入来自</span><span style="color:rgb(0,128,0)">注册表</span><span style="color:rgb(0,128,0)">的快捷菜单</span><span style="color:rgb(0,128,0)">扩展</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">V_VT</span><span style="color:rgb(51,51,51)">(&amp;var1) = </span><span style="color:rgb(0,0,255)">VT_INT_PTR</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">V_BYREF</span><span style="color:rgb(51,51,51)">(&amp;var1) = hMenu;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">V_VT</span><span style="color:rgb(51,51,51)">(&amp;var2) = </span><span style="color:rgb(0,0,255)">VT_I4</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">V_I4</span><span style="color:rgb(51,51,51)">(&amp;var2) = dwID;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">hr = spCT-&gt;</span><span style="color:rgb(0,0,255)">Exec</span><span style="color:rgb(51,51,51)">(&amp;</span><span style="color:rgb(0,0,255)">CGID_ShellDocView</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">SHDVID_ADDMENUEXTENSIONS</span><span style="color:rgb(51,51,51)">, 0, &amp;var1, &amp;var2);</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//</span><span style="color:rgb(0,128,0)">删除查看源代码</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">DeleteMenu</span><span style="color:rgb(51,51,51)">(hMenu, IDM_VIEWSOURCE, </span><span style="color:rgb(0,0,255)">MF_BYCOMMAND</span><span style="color:rgb(51,51,51)">);</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//</span><span style="color:rgb(0,128,0)">显示</span><span style="color:rgb(0,128,0)">快捷菜单</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">int iSelection = ::</span><span style="color:rgb(0,0,255)">TrackPopupMenu</span><span style="color:rgb(51,51,51)">(hMenu,</span></p> 
 <p><span style="color:rgb(0,0,255)">        </span><span style="color:rgb(0,0,255)">TPM_LEFTALIGN</span><span style="color:rgb(51,51,51)"> | </span><span style="color:rgb(0,0,255)">TPM_RIGHTBUTTON</span><span style="color:rgb(51,51,51)"> | </span><span style="color:rgb(0,0,255)">TPM_RETURNCMD</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">    ppt-&gt;x,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">ppt-&gt;y,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">0,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">hwnd,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">RECT</span><span style="color:rgb(51,51,51)">*)</span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">);</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//</span><span style="color:rgb(0,128,0)">发送选定的</span><span style="color:rgb(0,128,0)">快捷菜单项目指令</span><span style="color:rgb(0,128,0)">到外</span><span style="color:rgb(0,128,0)">壳</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">LRESULT</span><span style="color:rgb(51,51,51)"> lr = ::</span><span style="color:rgb(0,0,255)">SendMessage</span><span style="color:rgb(51,51,51)">(hwnd, </span><span style="color:rgb(0,0,255)">WM_COMMAND</span><span style="color:rgb(51,51,51)">, iSelection, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">);</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">FreeLibrary</span><span style="color:rgb(51,51,51)">(hinstSHDOCLC);</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">return</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(0,0,255)">S_OK</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">安全</span><span style="color:rgb(51,51,51)">警告</span><span style="color:rgb(51,51,51)">：</span><span style="color:rgb(51,51,51)">不正确地使用LoadLibrary能载入错误的动态链接库(DLL)</span><span style="color:rgb(51,51,51)">来威胁</span><span style="color:rgb(51,51,51)">你的应用程序的安全</span><span style="color:rgb(51,51,51)">。</span><span style="color:rgb(51,51,51)">关于该如何正确地用微软Windows 的不同版本载入DLL的</span><span style="color:rgb(51,51,51)">信息，</span><span style="color:rgb(51,51,51)">参照LoadLibrary</span><span style="color:rgb(51,51,51)">的文档</span><span style="color:rgb(51,51,51)">。</span></p> 
 <h4>IDocHostUIHandler::GetExternal: <span style="font-family:宋体">扩充</span>文档对象模型</h4> 
 <p><span style="color:rgb(51,51,51)">IDocHostUIHandler 提供一个让你用在你自己的应用程序中实现</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">你自己的</span><span style="color:rgb(51,51,51)">对象</span><span style="color:rgb(51,51,51)">，方法和特性扩充IE文档对象模型 (</span><span style="color:rgb(51,51,51)">DOM</span><span style="color:rgb(51,51,51)">)的方法。你的实现是提供给MSHTML一个IDispatch接口指针，指向你</span><span style="color:rgb(51,51,51)">自定义的</span><span style="color:rgb(51,51,51)">COM自动化对象，实现你自定义的对象、属性和方法。这些对象，特性和方法</span><span style="color:rgb(51,51,51)">之后可以</span><span style="color:rgb(51,51,51)">在浏览器控件</span><span style="color:rgb(51,51,51)">显示的</span><span style="color:rgb(51,51,51)">任何页面</span><span style="color:rgb(51,51,51)">中通过文档的</span><span style="color:rgb(51,51,51)">外部对象</span><span style="color:rgb(51,51,51)">访问</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">这一个方法的实现</span><span style="color:rgb(51,51,51)">可以</span><span style="color:rgb(51,51,51)">是非常简单的, 假定你的IDispatch接口在实现IDocHostUIHandler的相同对象上。</span></p> 
 <p><span style="color:rgb(0,0,255)">HRESULT</span><span style="color:rgb(51,51,51)"> CBrowserHost::</span><span style="color:rgb(0,0,255)">GetExternal</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">IDispatch</span><span style="color:rgb(51,51,51)"> **ppDispatch)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">*ppDispatch = </span><span style="color:rgb(0,0,255)">this</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">return</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(0,0,255)">S_OK</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">只要</span><span style="color:rgb(51,51,51)"> MSHTML有对你的 IDispatch 的一个指针,MSHTML将会</span><span style="color:rgb(51,51,51)">传递网</span><span style="color:rgb(51,51,51)">页上对任何外部对象的调用</span><span style="color:rgb(51,51,51)">到</span><span style="color:rgb(51,51,51)">你的应用程序的自动化方法:</span></p> 
 <p><span style="color:rgb(51,51,51)">&lt;</span><span style="color:rgb(0,0,255)">SCRIPT</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(0,0,255)">language</span><span style="color:rgb(51,51,51)">="</span><span style="color:rgb(0,0,255)">JScript</span><span style="color:rgb(51,51,51)">"&gt;</span></p> 
 <p><span style="color:rgb(0,0,255)">function</span><span style="color:rgb(51,51,51)"> MyFunc(iSomeData)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">external</span><span style="color:rgb(51,51,51)">.MyCustomMethod("Some text", iSomeData);</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">&lt;/</span><span style="color:rgb(0,0,255)">SCRIPT</span><span style="color:rgb(51,51,51)">&gt;</span></p> 
 <p><span style="color:rgb(51,51,51)">你也能使用这技术</span><span style="color:rgb(51,51,51)">传递</span><span style="color:rgb(51,51,51)">整个对象</span><span style="color:rgb(51,51,51)">到</span><span style="color:rgb(51,51,51)">一个</span><span style="color:rgb(51,51,51)">网</span><span style="color:rgb(51,51,51)">页。</span><span style="color:rgb(51,51,51)">为了实现它，在</span><span style="color:rgb(51,51,51)">你的IDispatch实现中</span><span style="color:rgb(51,51,51)">创建</span><span style="color:rgb(51,51,51)">一个方法</span><span style="color:rgb(51,51,51)">，传递</span><span style="color:rgb(51,51,51)">回你</span><span style="color:rgb(51,51,51)">的网页可以用的</span><span style="color:rgb(51,51,51)">对象。</span></p> 
 <p><span style="color:rgb(51,51,51)">&lt;</span><span style="color:rgb(0,0,255)">SCRIPT</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(0,0,255)">language</span><span style="color:rgb(51,51,51)">="</span><span style="color:rgb(0,0,255)">JScript</span><span style="color:rgb(51,51,51)">"&gt;</span></p> 
 <p><span style="color:rgb(51,51,51)">function MyFunc(iSomeData)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">var oCustCalendarObj;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">external</span><span style="color:rgb(51,51,51)">.GetCustomCalender(oCustCalenderObj);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">oCustCalerdarObj.doStuffWithIt();</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">&lt;/</span><span style="color:rgb(0,0,255)">SCRIPT</span><span style="color:rgb(51,51,51)">&gt;</span></p> 
 <p><span style="color:rgb(51,51,51)">可以看看示例代码中</span><span style="color:rgb(51,51,51)">使用 ATL</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">IDispatch自动化实现的一个例子 。</span></p> 
 <p><span style="color:rgb(51,51,51)">译者注：IE也扩展了浏览器的文档对象模型，使得你在脚本中可以通过</span><span style="color:rgb(51,51,51)">扩展对象</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">menuArguments</span><span style="color:rgb(51,51,51)">属性访问当前窗口对象。</span></p> 
 <p>IDocHostUIHandler::GetOptionKeyPath</p> 
 <p><span style="color:rgb(51,51,51)">IDocHostUIHandler::GetOptionKeyPath是</span><span style="color:rgb(51,51,51)">自定义</span><span style="color:rgb(51,51,51)">浏览器控件的一个非常有力的工具。 许多浏览器控件显示</span><span style="color:rgb(51,51,51)">和</span><span style="color:rgb(51,51,51)">行为设定被储存在</span><span style="color:rgb(51,51,51)">注册表</span><span style="color:rgb(51,51,51)">中HKEY_CURRENT_USER键的下面。IDocHostUIHandler::GetOptionKeyPath给你一个机会为你的浏览器控件的特定</span><span style="color:rgb(51,51,51)">实例覆盖</span><span style="color:rgb(51,51,51)">这些</span><span style="color:rgb(51,51,51)">注册表</span><span style="color:rgb(51,51,51)">设定。它通过</span><span style="color:rgb(51,51,51)">让</span><span style="color:rgb(51,51,51)">你</span><span style="color:rgb(51,51,51)">提供</span><span style="color:rgb(51,51,51)">一个</span><span style="color:rgb(51,51,51)">替代的注册表</span><span style="color:rgb(51,51,51)">位置</span><span style="color:rgb(51,51,51)">来实现，</span><span style="color:rgb(51,51,51)">浏览器控件将会在</span><span style="color:rgb(51,51,51)">这里读取注册表设置</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">IDocHostUIHandler::GetOptionKeyPath的一个实现</span><span style="color:rgb(51,51,51)">传递给</span><span style="color:rgb(51,51,51)">你</span><span style="color:rgb(51,51,51)">让</span><span style="color:rgb(51,51,51)">浏览器控件读</span><span style="color:rgb(51,51,51)">取注册表设置的位置的</span><span style="color:rgb(51,51,51)">一个字符串。浏览器控件将会找寻在HKEY_CURRENT_USER键下面的这一个键。</span></p> 
 <p><span style="color:rgb(51,51,51)">例子</span></p> 
 <p><span style="color:rgb(0,0,255)">HRESULT</span><span style="color:rgb(51,51,51)"> CBrowserHost::GetOptionKeyPath(LPOLESTR *pchKey,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">DWORD dwReserved)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">HRESULT</span><span style="color:rgb(51,51,51)"> hr;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">#define CCHMAX 256</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">size_t</span><span style="color:rgb(51,51,51)"> cchLength;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">if</span><span style="color:rgb(51,51,51)"> (pchKey)</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(0,0,255)">        </span><span style="color:rgb(0,0,255)">WCHAR</span><span style="color:rgb(51,51,51)">* szMyKey = L"Software\MyCompany\MyApp";</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">hr = </span><span style="color:rgb(0,0,255)">StringCchLengthW</span><span style="color:rgb(51,51,51)">(szMyKey, CCHMAX, &amp;cchLength);</span></p> 
 <p><span style="color:rgb(0,128,0)">        </span><span style="color:rgb(0,128,0)">//TODO: 在这里处理错误。</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">*pchKey = (</span><span style="color:rgb(0,0,255)">LPOLESTR</span><span style="color:rgb(51,51,51)">)</span><span style="color:rgb(0,0,255)">CoTaskMemAlloc</span><span style="color:rgb(51,51,51)">((cchLength + 1) * </span><span style="color:rgb(0,0,255)">sizeof</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">WCHAR</span><span style="color:rgb(51,51,51)">));</span></p> 
 <p><span style="color:rgb(0,0,255)">        </span><span style="color:rgb(0,0,255)">if</span><span style="color:rgb(51,51,51)"> (*pchKey)</span></p> 
 <p><span style="color:rgb(51,51,51)">            </span><span style="color:rgb(51,51,51)">hr = </span><span style="color:rgb(0,0,255)">StringCchCopyW</span><span style="color:rgb(51,51,51)">(*pchKey, cchLength + 1, szKey);</span></p> 
 <p><span style="color:rgb(0,128,0)">        </span><span style="color:rgb(0,128,0)">//TODO: 在这里处理错误。</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">hr = (*pchKey) ? </span><span style="color:rgb(0,0,255)">S_OK</span><span style="color:rgb(51,51,51)"> : </span><span style="color:rgb(0,0,255)">E_OUTOFMEMORY</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">else</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">hr = </span><span style="color:rgb(0,0,255)">E_INVALIDARG</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">return</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(0,0,255)">hr</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">和</span><span style="color:rgb(51,51,51)">IDocHostUIHandler::GetHostInfo</span><span style="color:rgb(51,51,51)">一样，确保</span><span style="color:rgb(51,51,51)">为你的字符串使用 CoTaskMemAlloc</span><span style="color:rgb(51,51,51)">分配内</span><span style="color:rgb(51,51,51)">存。</span></p> 
 <p><span style="color:rgb(51,51,51)">告诉浏览器控件该</span><span style="color:rgb(51,51,51)">在</span><span style="color:rgb(51,51,51)">哪里找寻你的</span><span style="color:rgb(51,51,51)">注册表设置</span><span style="color:rgb(51,51,51)">实际上是第一步</span><span style="color:rgb(51,51,51)">——</span><span style="color:rgb(51,51,51)">就程序运行来说</span><span style="color:rgb(51,51,51)">是</span><span style="color:rgb(51,51,51)">第二步。 你的程序</span><span style="color:rgb(51,51,51)">必须在</span><span style="color:rgb(51,51,51)">被IDocHostUIHandler::GetOptionKeyPath</span><span style="color:rgb(51,51,51)">告诉的</span><span style="color:rgb(51,51,51)">位置</span><span style="color:rgb(51,51,51)">设置一个注册表</span><span style="color:rgb(51,51,51)">键</span><span style="color:rgb(51,51,51)">，这样</span><span style="color:rgb(51,51,51)">浏览器控件</span><span style="color:rgb(51,51,51)">才可以去读取</span><span style="color:rgb(51,51,51)">。有多种方法</span><span style="color:rgb(51,51,51)">来完成这个步骤</span><span style="color:rgb(51,51,51)">。</span><span style="color:rgb(51,51,51)">一个方法是</span><span style="color:rgb(51,51,51)">当应用程序被安装的时候</span><span style="color:rgb(51,51,51)">执行一个注册表脚本</span><span style="color:rgb(51,51,51)">。另外的一个方法</span><span style="color:rgb(51,51,51)">是</span><span style="color:rgb(51,51,51)">当应用程序启动的时候,</span><span style="color:rgb(51,51,51)">用代码来完成</span><span style="color:rgb(51,51,51)">。这里是改变默认值字体，大小和颜色的一个设定。</span></p> 
 <p><span style="color:rgb(51,51,51)">例子</span></p> 
 <p><span style="color:rgb(0,0,255)">HRESULT</span><span style="color:rgb(51,51,51)"> SetSomeKeys()</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">HKEY</span><span style="color:rgb(51,51,51)"> hKey = </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">HKEY</span><span style="color:rgb(51,51,51)"> hKey2 = </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">HKEY</span><span style="color:rgb(51,51,51)"> hKey3 = </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">DWORD</span><span style="color:rgb(51,51,51)"> dwDisposition = </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">LONG</span><span style="color:rgb(51,51,51)"> lResult = </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">#define CBMAX 256</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">size_t</span><span style="color:rgb(51,51,51)"> cbLength;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegCreateKeyEx</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">HKEY_CURRENT_USER</span><span style="color:rgb(51,51,51)">, _T("Software\MyCompany\MyApp"),</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">REG_OPTION_NON_VOLATILE</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">KEY_SET_VALUE</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, &amp;hKey, &amp;dwDisposition);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegCreateKeyEx</span><span style="color:rgb(51,51,51)">(hKey, _T("Main"), </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">REG_OPTION_NON_VOLATILE</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(0,0,255)">KEY_SET_VALUE</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, &amp;hKey2, &amp;dwDisposition);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegSetValueEx</span><span style="color:rgb(51,51,51)">(hKey2, _T("Use_DlgBox_Colors"), </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">REG_SZ</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">CONST BYTE</span><span style="color:rgb(51,51,51)">*)_T("no"), </span><span style="color:rgb(0,0,255)">sizeof</span><span style="color:rgb(51,51,51)">(_T("no")));</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegCloseKey</span><span style="color:rgb(51,51,51)">(hKey2);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegCreateKeyEx</span><span style="color:rgb(51,51,51)">(hKey, _T("Settings"), </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">REG_OPTION_NON_VOLATILE</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(0,0,255)">KEY_SET_VALUE</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, &amp;hKey2, &amp;dwDisposition);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegSetValueEx</span><span style="color:rgb(51,51,51)">(hKey2, _T("Anchor Color"), </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">REG_SZ</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">CONST BYTE</span><span style="color:rgb(51,51,51)">*)_T("0,255,255"), </span><span style="color:rgb(0,0,255)">sizeof</span><span style="color:rgb(51,51,51)">(_T("0,255,255")));</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegSetValueEx</span><span style="color:rgb(51,51,51)">(hKey2, _T("Text Color"), </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">REG_SZ</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">CONST BYTE</span><span style="color:rgb(51,51,51)">*)_T("255,0,255"), </span><span style="color:rgb(0,0,255)">sizeof</span><span style="color:rgb(51,51,51)">(_T("255,0,255")));</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegCloseKey</span><span style="color:rgb(51,51,51)">(hKey2);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegCreateKeyEx</span><span style="color:rgb(51,51,51)">(hKey, _T("International\Scripts"), </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(0,0,255)">REG_OPTION_NON_VOLATILE</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">KEY_SET_VALUE</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">&amp;hKey2, &amp;dwDisposition);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">BYTE</span><span style="color:rgb(51,51,51)"> bDefaultScript = 0x3;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegSetValueEx</span><span style="color:rgb(51,51,51)">(hKey2, _T("Default_Script"), </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">REG_BINARY</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">&amp;bDefaultScript, </span><span style="color:rgb(0,0,255)">sizeof</span><span style="color:rgb(51,51,51)">(bDefaultScript));</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegCreateKeyEx</span><span style="color:rgb(51,51,51)">(hKey2, _T("3"), </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">REG_OPTION_NON_VOLATILE</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(0,0,255)">KEY_SET_VALUE</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, &amp;hKey3, &amp;dwDisposition);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">BYTE</span><span style="color:rgb(51,51,51)"> bSize = 0x4; // Value from 0 - 4. 2 is medium.</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">TCHAR</span><span style="color:rgb(51,51,51)">* szFontName = _T("Comic Sans MS");</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">TCHAR</span><span style="color:rgb(51,51,51)">* szFixedFontName = _T("Courier");</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">HRESULT</span><span style="color:rgb(51,51,51)"> hr = </span><span style="color:rgb(0,0,255)">StringCbLength</span><span style="color:rgb(51,51,51)">(szFontName, CBMAX, &amp;cbLength);</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//TODO: 在这里处理错误。</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegSetValueEx</span><span style="color:rgb(51,51,51)">(hKey3, _T("IEPropFontName"), </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">REG_SZ</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">CONST BYTE</span><span style="color:rgb(51,51,51)">*)szFontName, cbLength + </span><span style="color:rgb(0,0,255)">sizeof</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">TCHAR</span><span style="color:rgb(51,51,51)">));</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">hr = </span><span style="color:rgb(0,0,255)">StringCbLength</span><span style="color:rgb(51,51,51)">(szFixedFontName, CBMAX, &amp;cbLength);</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//TODO: 在这里处理错误。</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegSetValueEx</span><span style="color:rgb(51,51,51)">(hKey3, _T("IEFixedFontName"), </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">REG_SZ</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">CONST BYTE</span><span style="color:rgb(51,51,51)">*)szFixedFontName, cbLength + </span><span style="color:rgb(0,0,255)">sizeof</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">TCHAR</span><span style="color:rgb(51,51,51)">));</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegSetValueEx</span><span style="color:rgb(51,51,51)">(hKey3, _T("IEFontSize"), </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">REG_BINARY</span><span style="color:rgb(51,51,51)">, &amp;bSize, </span><span style="color:rgb(0,0,255)">sizeof</span><span style="color:rgb(51,51,51)">(bSize));</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegCloseKey</span><span style="color:rgb(51,51,51)">(hKey3);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegCloseKey</span><span style="color:rgb(51,51,51)">(hKey2);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">RegCloseKey</span><span style="color:rgb(51,51,51)">(hKey);</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">return</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(0,0,255)">S_OK</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p>IDocHostUIHandler2</p> 
 <p><span style="color:rgb(51,51,51)">IDocHostUIHandler2 只有一个方法，IDocHostUIHandler2::GetOverrideKeyPath。它运行非常</span><span style="color:rgb(51,51,51)">类似于</span><span style="color:rgb(51,51,51)">IDocHostUIHandler::GetOptionKeyPath的一个功能。它指出</span><span style="color:rgb(51,51,51)">你修改自默认</span><span style="color:rgb(51,51,51)">注册表设置</span><span style="color:rgb(51,51,51)">的集成浏览器使用的</span><span style="color:rgb(51,51,51)">注册表设置</span><span style="color:rgb(51,51,51)">的位置。</span><span style="color:rgb(51,51,51)">IDocHostUIHandler2::GetOverrideKeyPath 的一个实现</span><span style="color:rgb(51,51,51)">看起来会很类似于</span><span style="color:rgb(51,51,51)">IDocHostUIHandler::GetOptionKeyPath的一个实现。</span></p> 
 <p>GetOptionKeyPath 和 GetOverrideKeyPath 的比较</p> 
 <p><span style="color:rgb(51,51,51)">你或许没</span><span style="color:rgb(51,51,51)">看到</span><span style="color:rgb(51,51,51)">IDocHostUIHandler::GetOptionKeyPath和IDocHostUIHandler2::GetOverrideKeyPath之间的任何不同。在他们之间的不同是</span><span style="color:rgb(51,51,51)">微妙</span><span style="color:rgb(51,51,51)">的, 但是重要的。如果你实现 IDocHostUIHandler::GetOptionKeyPath,你的浏览器控件</span><span style="color:rgb(51,51,51)">实例</span><span style="color:rgb(51,51,51)">将会</span><span style="color:rgb(51,51,51)">忽略</span><span style="color:rgb(51,51,51)">任何</span><span style="color:rgb(51,51,51)">IE</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">用户</span><span style="color:rgb(51,51,51)">设定。这些设定被储存在注册表</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">HKEY_CURRENT_USER/Software/Microsoft/Internet Explorer下面。如果你实现IDocHostUIHandler2::GetOverrideKeyPath,你的浏览器控件</span><span style="color:rgb(51,51,51)">实例</span><span style="color:rgb(51,51,51)">将会合并任何的</span><span style="color:rgb(51,51,51)">用户</span><span style="color:rgb(51,51,51)">设定—字体设定，菜单扩展,</span><span style="color:rgb(51,51,51)">诸如此类——到</span><span style="color:rgb(51,51,51)">它</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">显示</span><span style="color:rgb(51,51,51)">和行为中</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">举例说明在IDocHostUIHandler::GetOptionKeyPath和IDocHostUIHandler2::GetOverrideKeyPath之间的不同,</span><span style="color:rgb(51,51,51)">让我们重新看看</span><span style="color:rgb(51,51,51)">IDocHostUIHandler::ShowContextMenu</span><span style="color:rgb(51,51,51)">那段的示例代码</span><span style="color:rgb(51,51,51)">。</span><span style="color:rgb(51,51,51)">记住这一行</span><span style="color:rgb(51,51,51)">:</span></p> 
 <p><span style="color:rgb(51,51,51)">spCT-&gt;Exec(&amp;CGID_ShellDocView, SHDVID_ADDMENUEXTENSIONS, 0, &amp;var1, &amp;var2);</span></p> 
 <p><span style="color:rgb(51,51,51)">如果你已经实现IDocHostUIHandler::GetOptionKeyPath,因为菜单扩展信息被储存在</span><span style="color:rgb(51,51,51)">当前用户的注册表信息中</span><span style="color:rgb(51,51,51)">,所以这一</span><span style="color:rgb(51,51,51)">行</span><span style="color:rgb(51,51,51)">不</span><span style="color:rgb(51,51,51)">会</span><span style="color:rgb(51,51,51)">加入</span><span style="color:rgb(51,51,51)">任何自定义项目到</span><span style="color:rgb(51,51,51)">快捷菜单。如果你已经实现IDocHostUIHandler2::GetOverrideKeyPath, 这一个</span><span style="color:rgb(51,51,51)">行</span><span style="color:rgb(51,51,51)">会</span><span style="color:rgb(51,51,51)">添加</span><span style="color:rgb(51,51,51)">在HKEY_CURRENT_USER/Software/Microsoft/Internet Explorer/MenuExt面</span><span style="color:rgb(51,51,51)">定义</span><span style="color:rgb(51,51,51)">的任何</span><span style="color:rgb(51,51,51)">目前用户定义的菜单扩展</span><span style="color:rgb(51,51,51)">, 除非你明确地</span><span style="color:rgb(51,51,51)">在你的自定义注册信息位置提供一个</span><span style="color:rgb(51,51,51)">空的或</span><span style="color:rgb(51,51,51)">替代的</span><span style="color:rgb(51,51,51)">MenuExt键。</span></p> 
 <p>控制导航</p> 
 <p><span style="color:rgb(51,51,51)">你可能想知道在IDocHostUIHandler</span><span style="color:rgb(51,51,51)">那一节</span><span style="color:rgb(51,51,51)">为什么不提到 IDocHostUIHandler::TranslateUrl，作为</span><span style="color:rgb(51,51,51)">在</span><span style="color:rgb(51,51,51)">你</span><span style="color:rgb(51,51,51)">希望</span><span style="color:rgb(51,51,51)">控</span><span style="color:rgb(51,51,51)">制页面</span><span style="color:rgb(51,51,51)">导航</span><span style="color:rgb(51,51,51)">时</span><span style="color:rgb(51,51,51)">实现</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">方法。原因是这一个方法不是控制导航</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">最</span><span style="color:rgb(51,51,51)">通用的</span><span style="color:rgb(51,51,51)">技术。 除非你直接地</span><span style="color:rgb(51,51,51)">集成</span><span style="color:rgb(51,51,51)">MSHTML,这一个方法将</span><span style="color:rgb(51,51,51)">没有控制</span><span style="color:rgb(51,51,51)">导航的效果。</span><span style="color:rgb(51,51,51)">作为替代</span><span style="color:rgb(51,51,51)">，通过实现IDispatch::Invoke，处理DISPID_BEFORENAVIGATE2，你</span><span style="color:rgb(51,51,51)">可以</span><span style="color:rgb(51,51,51)">控制导航。</span><span style="color:rgb(51,51,51)">例如</span><span style="color:rgb(51,51,51)">，下列</span><span style="color:rgb(51,51,51)">代码</span><span style="color:rgb(51,51,51)">避免导航</span><span style="color:rgb(51,51,51)">到</span><span style="color:rgb(51,51,51)">一个特别的网址,如果使用者尝试这么做</span><span style="color:rgb(51,51,51)">，会</span><span style="color:rgb(51,51,51)">显示 "没有允许导航" 错误页。</span></p> 
 <p><span style="color:rgb(51,51,51)">例子</span></p> 
 <p><span style="color:rgb(0,0,255)">case</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(0,0,255)">DISPID_BEFORENAVIGATE2</span><span style="color:rgb(51,51,51)">:</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">CComBSTR</span><span style="color:rgb(51,51,51)"> url = ((*pDispParams).rgvarg)[5].pvarVal-&gt;bstrVal;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">if (url == "http://www.adatum.com" || url == "http://www.adatum.com/")</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(0,0,255)">        </span><span style="color:rgb(0,0,255)">CComPtr</span><span style="color:rgb(51,51,51)">&lt;</span><span style="color:rgb(0,0,255)">IWebBrowser2</span><span style="color:rgb(51,51,51)">&gt; spBrowser;</span></p> 
 <p><span style="color:rgb(0,0,255)">        </span><span style="color:rgb(0,0,255)">CComPtr</span><span style="color:rgb(51,51,51)">&lt;</span><span style="color:rgb(0,0,255)">IDispatch</span><span style="color:rgb(51,51,51)">&gt; spDisp = ((*pDispParams).rgvarg)[6].pdispVal;</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">spDisp-&gt;</span><span style="color:rgb(0,0,255)">QueryInterface</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">IID_IWebBrowser2</span><span style="color:rgb(51,51,51)">, (void**)&amp;spBrowser);</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">spBrowser-&gt;</span><span style="color:rgb(0,0,255)">Stop</span><span style="color:rgb(51,51,51)">();</span></p> 
 <p><span style="color:rgb(0,0,255)">        </span><span style="color:rgb(0,0,255)">CComBSTR</span><span style="color:rgb(51,51,51)"> newURL = "L"res://webhost.exe/nonavigate.htm";</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">spBrowser-&gt;</span><span style="color:rgb(0,0,255)">Navigate</span><span style="color:rgb(51,51,51)">(newURL, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">);</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">((*pDispParams).rgvarg)[0].boolVal = </span><span style="color:rgb(0,0,255)">TRUE</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">break</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p>IDocHostShowUI</p> 
 <p><span style="color:rgb(51,51,51)">这个接口给你对浏览器控件显示</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">信息</span><span style="color:rgb(51,51,51)">对话框和帮助的控制</span><span style="color:rgb(51,51,51)">。它工作</span><span style="color:rgb(51,51,51)">机理和</span><span style="color:rgb(51,51,51)">IDocHostUIHandler和IDocHostUIHandler2</span><span style="color:rgb(51,51,51)">一样，</span><span style="color:rgb(51,51,51)">你实现它，</span><span style="color:rgb(51,51,51)">这样</span><span style="color:rgb(51,51,51)">在浏览器控件显示它自己的任何的信息或</span><span style="color:rgb(51,51,51)">帮助</span><span style="color:rgb(51,51,51)">之前 ,能调用你的IDocHostShowUI</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">方法。这给你一个机会阻止浏览器控件显示任何</span><span style="color:rgb(51,51,51)">东西，</span><span style="color:rgb(51,51,51)">而且使你能够改为显示你自己的</span><span style="color:rgb(51,51,51)">自定义</span><span style="color:rgb(51,51,51)">信息或</span><span style="color:rgb(51,51,51)">帮助</span><span style="color:rgb(51,51,51)">。 IDocHostShowUI有两个方法，IDocHostShowUI::ShowMessage和IDocHostShowUI::ShowHelp。</span></p> 
 <h4>IDocHostShowUI::ShowMessage</h4> 
 <p><span style="color:rgb(51,51,51)">返回 S_OK</span><span style="color:rgb(51,51,51)">禁用</span><span style="color:rgb(51,51,51)">浏览器控件</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">信息</span><span style="color:rgb(51,51,51)">对话框</span><span style="color:rgb(51,51,51)">。任何其他的返回数值,像S_FALSE或E_NOTIMPL,允许浏览器控件显示它的信息</span><span style="color:rgb(51,51,51)">对话框</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">你</span><span style="color:rgb(51,51,51)">通过</span><span style="color:rgb(51,51,51)">这个方法能做的一件</span><span style="color:rgb(51,51,51)">好</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">事情</span><span style="color:rgb(51,51,51)">是为你的应用程序</span><span style="color:rgb(51,51,51)">自定义</span><span style="color:rgb(51,51,51)">信息</span><span style="color:rgb(51,51,51)">框标题，替代</span><span style="color:rgb(51,51,51)"> "Microsoft Internet Explorer" 。你能通过比较lpstrCaption和储存在Shdoclc.dll</span><span style="color:rgb(51,51,51)">中的</span><span style="color:rgb(51,51,51)">IE使用的字符串资源</span><span style="color:rgb(51,51,51)">来完成它</span><span style="color:rgb(51,51,51)">。它的ID是IDS_MESSAGE_BOX_TITLE,数值是2213。下列示例代码</span><span style="color:rgb(51,51,51)">演示</span><span style="color:rgb(51,51,51)">你可能</span><span style="color:rgb(51,51,51)">需要做的工作</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">例子</span></p> 
 <p><span style="color:rgb(0,0,255)">HRESULT</span><span style="color:rgb(51,51,51)"> CBrowserHost::</span><span style="color:rgb(0,0,255)">ShowMessage</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">HWND</span><span style="color:rgb(51,51,51)"> hwnd,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">LPOLESTR</span><span style="color:rgb(51,51,51)"> lpstrText,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">LPOLESTR</span><span style="color:rgb(51,51,51)"> lpstrCaption,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">DWORD</span><span style="color:rgb(51,51,51)"> dwType,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">LPOLESTR</span><span style="color:rgb(51,51,51)"> lpstrHelpFile,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">DWORD</span><span style="color:rgb(51,51,51)"> dwHelpContext,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">LRESULT</span><span style="color:rgb(51,51,51)"> *plResult)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">USES_CONVERSION</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">TCHAR pBuffer[50];</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">// </span><span style="color:rgb(51,51,51)">窗口标题</span><span style="color:rgb(51,51,51)">"Microsoft Internet Explorer"</span><span style="color:rgb(51,51,51)">的资源标识</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">#define IDS_MESSAGE_BOX_TITLE 2213</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">//</span><span style="color:rgb(51,51,51)">载入</span><span style="color:rgb(51,51,51)">Shdoclc.dll </span><span style="color:rgb(51,51,51)">和</span><span style="color:rgb(51,51,51)">IE</span><span style="color:rgb(51,51,51)">消息框标题字符串</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">HINSTANCE hinstSHDOCLC = LoadLibrary(TEXT("SHDOCLC.DLL"));</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">if (hinstSHDOCLC == NULL)</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(0,128,0)">        </span><span style="color:rgb(0,128,0)">// 载入模块错误 -- 尽可能安全地失败</span></p> 
 <p><span style="color:rgb(0,0,255)">        </span><span style="color:rgb(0,0,255)">return</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">LoadString</span><span style="color:rgb(51,51,51)">(hinstSHDOCLC, IDS_MESSAGE_BOX_TITLE, pBuffer, 50);</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">// </span><span style="color:rgb(0,128,0)">比较IE消息框标题字符串和</span><span style="color:rgb(0,128,0)">lpstrCaption</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">// </span><span style="color:rgb(0,128,0)">如果相同，用自定义标题替换</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">if (</span><span style="color:rgb(0,0,255)">_tcscmp</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">OLE2T</span><span style="color:rgb(51,51,51)">(lpstrCaption), pBuffer) == 0)</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">lpstrCaption = L"Custom Caption";</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">// </span><span style="color:rgb(0,128,0)">创建自己的消息框并且显示</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">*plResult = </span><span style="color:rgb(0,0,255)">MessageBox</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">OLE2T</span><span style="color:rgb(51,51,51)">(lpstrText), </span><span style="color:rgb(0,0,255)">OLE2T</span><span style="color:rgb(51,51,51)">(lpstrCaption), dwType);</span></p> 
 <p><span style="color:rgb(0,128,0)">    </span><span style="color:rgb(0,128,0)">//</span><span style="color:rgb(0,128,0)">卸载</span><span style="color:rgb(0,128,0)">Shdoclc.dll</span><span style="color:rgb(0,128,0)">并且返回</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">FreeLibrary</span><span style="color:rgb(51,51,51)">(hinstSHDOCLC);</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">return S_OK</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">安全</span><span style="color:rgb(51,51,51)">警告</span><span style="color:rgb(51,51,51)">：</span><span style="color:rgb(51,51,51)">不正确地使用LoadLibrary能载入错误的动态链接库(DLL)</span><span style="color:rgb(51,51,51)">来威胁</span><span style="color:rgb(51,51,51)">你的应用程序的安全</span><span style="color:rgb(51,51,51)">。</span><span style="color:rgb(51,51,51)">关于该如何正确地用微软Windows的不同版本载入DLL的</span><span style="color:rgb(51,51,51)">信息，</span><span style="color:rgb(51,51,51)">参照 LoadLibrary</span><span style="color:rgb(51,51,51)">的文档</span><span style="color:rgb(51,51,51)">。</span></p> 
 <h4>IDocHostShowUI::ShowHelp</h4> 
 <p><span style="color:rgb(51,51,51)">这一个方法</span><span style="color:rgb(51,51,51)">在</span><span style="color:rgb(51,51,51)">当IE</span><span style="color:rgb(51,51,51)">需要显示帮助时被调用，</span><span style="color:rgb(51,51,51)">举例来说当 F1 键被</span><span style="color:rgb(51,51,51)">按下时</span><span style="color:rgb(51,51,51)">,而且</span><span style="color:rgb(51,51,51)">工作方式和</span><span style="color:rgb(51,51,51)">IDocHostShowUI::ShowMessage</span><span style="color:rgb(51,51,51)">类似。</span><span style="color:rgb(51,51,51)">返回S_OK</span><span style="color:rgb(51,51,51)">覆盖</span><span style="color:rgb(51,51,51)">IE</span><span style="color:rgb(51,51,51)">的帮助</span><span style="color:rgb(51,51,51)">,或另外的HRESULT值</span><span style="color:rgb(51,51,51)">让</span><span style="color:rgb(51,51,51)">IE</span><span style="color:rgb(51,51,51)">执行自己的帮助</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p>控制下载和执行</p> 
 <p><span style="color:rgb(51,51,51)">浏览器控件给你它</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">下载,显示</span><span style="color:rgb(51,51,51)">设置和</span><span style="color:rgb(51,51,51)">执行的控制</span><span style="color:rgb(51,51,51)">权</span><span style="color:rgb(51,51,51)">。 为了要得到这</span><span style="color:rgb(51,51,51)">些</span><span style="color:rgb(51,51,51)">控制,你实现你的宿主的IDispatch接口</span><span style="color:rgb(51,51,51)">，使得</span><span style="color:rgb(51,51,51)">它处理DISPID_AMBIENT_DLCONTROL。当浏览器控件被</span><span style="color:rgb(51,51,51)">实例化</span><span style="color:rgb(51,51,51)">的时候,它将会以这一个</span><span style="color:rgb(51,51,51)">ID</span><span style="color:rgb(51,51,51)">调用你的IDispatch::Invoke。将pvarResult</span><span style="color:rgb(51,51,51)">设置</span><span style="color:rgb(51,51,51)">为下列的</span><span style="color:rgb(51,51,51)">标识的</span><span style="color:rgb(51,51,51)">一个</span><span style="color:rgb(51,51,51)">位与的</span><span style="color:rgb(51,51,51)">组合,</span><span style="color:rgb(51,51,51)">指明你的配置</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">DLCTL_DLIMAGES ， DLCTL_VIDEOS 和 DLCTL_BGSOUNDS: </span><span style="color:rgb(51,51,51)">如果</span><span style="color:rgb(51,51,51)">这些</span><span style="color:rgb(51,51,51)">标识</span><span style="color:rgb(51,51,51)">被设定</span><span style="color:rgb(51,51,51)">，</span><span style="color:rgb(51,51,51)">图像，</span><span style="color:rgb(51,51,51)">视频</span><span style="color:rgb(51,51,51)">和</span><span style="color:rgb(51,51,51)">背景音乐</span><span style="color:rgb(51,51,51)">将会被从服务器下载并且显示或</span><span style="color:rgb(51,51,51)">播放，否则</span><span style="color:rgb(51,51,51)">将不被下载</span><span style="color:rgb(51,51,51)">和</span><span style="color:rgb(51,51,51)">显示。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">DLCTL_NO_SCRIPTS 和 DLCTL_NO_JAVA: </span><span style="color:rgb(51,51,51)">脚本</span><span style="color:rgb(51,51,51)">和</span><span style="color:rgb(51,51,51)">Java</span><span style="color:rgb(51,51,51)">小</span><span style="color:rgb(51,51,51)">程序</span><span style="color:rgb(51,51,51)">将不被运行。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">DLCTL_NO_DLACTIVEXCTLS 和 DLCTL_NO_RUNACTIVEXCTLS: ActiveX </span><span style="color:rgb(51,51,51)">控件</span><span style="color:rgb(51,51,51)">将不被下载</span><span style="color:rgb(51,51,51)">或者</span><span style="color:rgb(51,51,51)">运行。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">DLCTL_DOWNLOADONLY: </span><span style="color:rgb(51,51,51)">网页</span><span style="color:rgb(51,51,51)">只将会被下载,不显示。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">DLCTL_NO_FRAMEDOWNLOAD:浏览器控件将会下载并且</span><span style="color:rgb(51,51,51)">解析框架集页面</span><span style="color:rgb(51,51,51)">，但是</span><span style="color:rgb(51,51,51)">不会下载和解析框架集中单独的</span><span style="color:rgb(51,51,51)">框架。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">DLCTL_RESYNCHRONIZE 和 DLCTL_PRAGMA_NO_CACHE: 这些标志</span><span style="color:rgb(51,51,51)">导致Internet</span><span style="color:rgb(51,51,51)">缓冲</span><span style="color:rgb(51,51,51)">的刷新</span><span style="color:rgb(51,51,51)">。通过 DLCTL_RESYNCHRONIZE，服务器将会被</span><span style="color:rgb(51,51,51)">请求</span><span style="color:rgb(51,51,51)">更新状态。如果服务器指出</span><span style="color:rgb(51,51,51)">缓存</span><span style="color:rgb(51,51,51)">信息是最新</span><span style="color:rgb(51,51,51)">的，</span><span style="color:rgb(51,51,51)">将会</span><span style="color:rgb(51,51,51)">使用 缓存</span><span style="color:rgb(51,51,51)">文件。通过DLCTL_PRAGMA_NO_CACHE，不管文件的更新状态</span><span style="color:rgb(51,51,51)">如何，</span><span style="color:rgb(51,51,51)">文件</span><span style="color:rgb(51,51,51)">都会</span><span style="color:rgb(51,51,51)">被从服务器</span><span style="color:rgb(51,51,51)">重新</span><span style="color:rgb(51,51,51)">下载。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">DLCTL_NO_BEHAVIORS: 行为不被下载并且在文件中被禁用。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">DLCTL_NO_METACHARSET_HTML: </span><span style="color:rgb(51,51,51)">忽略</span><span style="color:rgb(51,51,51)">在</span><span style="color:rgb(51,51,51)">META元素中指明的字符集</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">DLCTL_URL_ENCODING_DISABLE_UTF8 和 DLCTL_URL_ENCODING_ENABLE_UTF8: 这些</span><span style="color:rgb(51,51,51)">标志的功能类似于</span><span style="color:rgb(51,51,51)">IDocHostUIHandler::GetHostInfo</span><span style="color:rgb(51,51,51)">中</span><span style="color:rgb(51,51,51)">使用</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">DOCHOSTUIFLAG_URL_ENCODING_DISABLE_UTF8</span><span style="color:rgb(51,51,51)">和</span><span style="color:rgb(51,51,51)">DOCHOSTUIFLAG_URL_ENCODING_ENABLE_UTF8</span><span style="color:rgb(51,51,51)">标志</span><span style="color:rgb(51,51,51)">。不同是只有</span><span style="color:rgb(51,51,51)">在</span><span style="color:rgb(51,51,51)">浏览器控件</span><span style="color:rgb(51,51,51)">被初始化</span><span style="color:rgb(51,51,51)">的时候,DOCHOSTUIFLAG标志</span><span style="color:rgb(51,51,51)">才会</span><span style="color:rgb(51,51,51)">被检查。这里</span><span style="color:rgb(51,51,51)">的环境</span><span style="color:rgb(51,51,51)">特性变化</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">下载标志</span><span style="color:rgb(51,51,51)">在</span><span style="color:rgb(51,51,51)">每当浏览器控件需要运行一个下载</span><span style="color:rgb(51,51,51)">时</span><span style="color:rgb(51,51,51)">被检查。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">DLCTL_NO_CLIENTPULL: 不运行客户端重定位页面操作</span><span style="color:rgb(51,51,51)">（译者注：例如&lt;meta http-equiv="refresh" content="30"&gt; 的默认行为）</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">DLCTL_SILENT: 在下载期间没有</span><span style="color:rgb(51,51,51)">用户界面</span><span style="color:rgb(51,51,51)">显示。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">DLCTL_FORCEOFFLINE: 浏览器控件总是在脱机模式中操作。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">DLCTL_OFFLINEIFNOTCONNECTED 和 DLCTL_OFFLINE: 这些标志是相同的。如果不连接到英特网</span><span style="color:rgb(51,51,51)">，</span><span style="color:rgb(51,51,51)">浏览器控件将会在脱机模式中操作。</span></p> 
 <p><span style="color:rgb(51,51,51)">DISPID_AMBIENT_DLCONTROL和标志</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">数值</span><span style="color:rgb(51,51,51)">是</span><span style="color:rgb(51,51,51)">在mshtmdid.h被定义</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">最初,当对IDispatch::Invoke调用开始</span><span style="color:rgb(51,51,51)">的时候</span><span style="color:rgb(51,51,51)">, pvarResult</span><span style="color:rgb(51,51,51)">参数指向的</span><span style="color:rgb(51,51,51)">VARIANT</span><span style="color:rgb(51,51,51)">是</span><span style="color:rgb(51,51,51)">VT_EMPTY</span><span style="color:rgb(51,51,51)">类型</span><span style="color:rgb(51,51,51)">。 你</span><span style="color:rgb(51,51,51)">必须</span><span style="color:rgb(51,51,51)">为任何有效的设定</span><span style="color:rgb(51,51,51)">设置它为</span><span style="color:rgb(51,51,51)">VT_I4</span><span style="color:rgb(51,51,51)">类型</span><span style="color:rgb(51,51,51)">。你</span><span style="color:rgb(51,51,51)">可以在</span><span style="color:rgb(51,51,51)">VARIANT的lVal成员</span><span style="color:rgb(51,51,51)">中存储</span><span style="color:rgb(51,51,51)">标志数值。</span></p> 
 <p><span style="color:rgb(51,51,51)">大部份标志数值有否定的效果,也就是说，他们避免行为正常地发生。举例来说，如果你</span><span style="color:rgb(51,51,51)">不</span><span style="color:rgb(51,51,51)">自定义浏览器控件行为</span><span style="color:rgb(51,51,51)">，那么通常</span><span style="color:rgb(51,51,51)">脚本会被执行。 但是如果你设定DLCTL_NOSCRIPTS 标志,脚本将不会在控制的</span><span style="color:rgb(51,51,51)">那个实例</span><span style="color:rgb(51,51,51)">中运行。然而，三</span><span style="color:rgb(51,51,51)">个</span><span style="color:rgb(51,51,51)">标志— DLCTL_DLIMAGES ， DLCTL_VIDEOS 和 DLCTL_BGSOUNDS</span><span style="color:rgb(51,51,51)">的作用正好相反</span><span style="color:rgb(51,51,51)">。你</span><span style="color:rgb(51,51,51)">必须全部设置</span><span style="color:rgb(51,51,51)">标志,</span><span style="color:rgb(51,51,51)">使得</span><span style="color:rgb(51,51,51)">浏览器控件以它的默认</span><span style="color:rgb(51,51,51)">行为执行关于</span><span style="color:rgb(51,51,51)">图像，</span><span style="color:rgb(51,51,51)">视频</span><span style="color:rgb(51,51,51)">和声音</span><span style="color:rgb(51,51,51)">的处理。</span></p> 
 <p><span style="color:rgb(51,51,51)">下列示例代码</span><span style="color:rgb(51,51,51)">使得</span><span style="color:rgb(51,51,51)">一个浏览器控件</span><span style="color:rgb(51,51,51)">实例</span><span style="color:rgb(51,51,51)">下载并且显示图像和视频，但是不</span><span style="color:rgb(51,51,51)">处理背景音乐</span><span style="color:rgb(51,51,51)">,</span><span style="color:rgb(51,51,51)">因为</span><span style="color:rgb(51,51,51)">DLCTL_BGSOUNDS</span><span style="color:rgb(51,51,51)">没有</span><span style="color:rgb(51,51,51)">被明确地设定。浏览器控件显示的页上</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">脚本运行被</span><span style="color:rgb(51,51,51)">禁用</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(0,0,255)">STDMETHODIMP</span><span style="color:rgb(51,51,51)"> CAtlBrCon::</span><span style="color:rgb(0,0,255)">Invoke</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">DISPID</span><span style="color:rgb(51,51,51)"> dispidMember, </span><span style="color:rgb(0,0,255)">REFIID</span><span style="color:rgb(51,51,51)"> riid,</span></p> 
 <p><span style="color:rgb(0,0,255)">    </span><span style="color:rgb(0,0,255)">LCID</span><span style="color:rgb(51,51,51)"> lcid, </span><span style="color:rgb(0,0,255)">WORD</span><span style="color:rgb(51,51,51)"> wFlags,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">DISPPARAMS</span><span style="color:rgb(51,51,51)">* pDispParams,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">VARIANT</span><span style="color:rgb(51,51,51)">* pvarResult,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">EXCEPINFO</span><span style="color:rgb(51,51,51)">* pExcepInfo,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">UINT</span><span style="color:rgb(51,51,51)">* puArgErr)</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">switch</span><span style="color:rgb(51,51,51)"> (dispidMember)</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">case </span><span style="color:rgb(0,0,255)">DISPID_AMBIENT_DLCONTROL</span><span style="color:rgb(51,51,51)">:</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">    pvarResult-&gt;vt = </span><span style="color:rgb(0,0,255)">VT_I4</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">            </span><span style="color:rgb(51,51,51)">pvarResult-&gt;lVal = </span><span style="color:rgb(0,0,255)">DLCTL_DLIMAGES</span><span style="color:rgb(51,51,51)"> | </span><span style="color:rgb(0,0,255)">DLCTL_VIDEOS</span><span style="color:rgb(51,51,51)"> | </span><span style="color:rgb(0,0,255)">DLCTL_NO_SCRIPTS</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">            </span><span style="color:rgb(51,51,51)">break;</span></p> 
 <p><span style="color:rgb(51,51,51)">        </span><span style="color:rgb(51,51,51)">default:</span></p> 
 <p><span style="color:rgb(51,51,51)">            </span><span style="color:rgb(0,0,255)">return</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(0,0,255)">DISP_E_MEMBERNOTFOUND</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">}</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">return</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(0,0,255)">S_OK</span><span style="color:rgb(51,51,51)">;</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p>IHostDialogHelper</p> 
 <p><span style="color:rgb(51,51,51)">IHostDialogHelper是一个你能</span><span style="color:rgb(51,51,51)">根据</span><span style="color:rgb(51,51,51)">你的爱好</span><span style="color:rgb(51,51,51)">创建对话框的</span><span style="color:rgb(51,51,51)">接口。这一个接口有一个方法，IHostDialogHelper::ShowHTMLDialog。这一个方法提供如同功能ShowHTMLDialog一般的服务，但是使用</span><span style="color:rgb(51,51,51)">起来</span><span style="color:rgb(51,51,51)">稍微比较容易</span><span style="color:rgb(51,51,51)">一点</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">为了要使用IHostDialogHelper,你从头产生</span><span style="color:rgb(51,51,51)">对话框</span><span style="color:rgb(51,51,51)">辅助对象。在这里是你使用CoCreateInstance的方式</span><span style="color:rgb(51,51,51)">创建它</span><span style="color:rgb(51,51,51)">。接口和ID在 mshtmhst.h </span><span style="color:rgb(51,51,51)">中</span><span style="color:rgb(51,51,51)">被定义。</span></p> 
 <p><span style="color:rgb(51,51,51)">例子</span></p> 
 <p><span style="color:rgb(0,0,255)">IHostDialogHelper</span><span style="color:rgb(51,51,51)">* pHDH;</span></p> 
 <p><span style="color:rgb(0,0,255)">IMoniker</span><span style="color:rgb(51,51,51)">* pUrlMoniker;</span></p> 
 <p><span style="color:rgb(0,0,255)">BSTR</span><span style="color:rgb(51,51,51)"> bstrOptions = </span><span style="color:rgb(0,0,255)">SysAllocString</span><span style="color:rgb(51,51,51)">(L"dialogHeight:30;dialogWidth:40");</span></p> 
 <p><span style="color:rgb(0,0,255)">BSTR</span><span style="color:rgb(51,51,51)"> bstrPath = </span><span style="color:rgb(0,0,255)">SysAllocString</span><span style="color:rgb(51,51,51)">(L"c:\dialog.htm");</span></p> 
 <p><span style="color:rgb(0,0,255)">CreateURLMoniker</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">, bstrPath, &amp;pUrlMoniker);</span></p> 
 <p><span style="color:rgb(0,128,0)">// </span><span style="color:rgb(0,128,0)">创建对话框</span><span style="color:rgb(0,128,0)">辅助对象</span></p> 
 <p><span style="color:rgb(0,0,255)">CoCreateInstance</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">CLSID_HostDialogHelper</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">CLSCTX_INPROC</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">IID_IHostDialogHelper,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">void</span><span style="color:rgb(51,51,51)">**)&amp;pHDH);</span></p> 
 <p><span style="color:rgb(0,128,0)">//</span><span style="color:rgb(0,128,0)">调用</span><span style="color:rgb(0,128,0)">ShowHTMLDialog </span><span style="color:rgb(0,128,0)">创建对话框</span></p> 
 <p><span style="color:rgb(51,51,51)">pHDH-&gt;</span><span style="color:rgb(0,0,255)">ShowHTMLDialog</span><span style="color:rgb(51,51,51)">(</span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">pUrlMoniker,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(51,51,51)">bstrOptions,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">,</span></p> 
 <p><span style="color:rgb(51,51,51)">    </span><span style="color:rgb(0,0,255)">NULL</span><span style="color:rgb(51,51,51)">);</span></p> 
 <p><span style="color:rgb(0,128,0)">//</span><span style="color:rgb(0,128,0)">释放资源</span></p> 
 <p><span style="color:rgb(0,0,255)">SysFreeString</span><span style="color:rgb(51,51,51)">(bstrPath);</span></p> 
 <p><span style="color:rgb(0,0,255)">SysFreeString</span><span style="color:rgb(51,51,51)">(bstrOptions);</span></p> 
 <p><span style="color:rgb(51,51,51)">pUrlMoniker-&gt;</span><span style="color:rgb(0,0,255)">Release</span><span style="color:rgb(51,51,51)">();</span></p> 
 <p><span style="color:rgb(51,51,51)">pHDH-&gt;</span><span style="color:rgb(0,0,255)">Release</span><span style="color:rgb(51,51,51)">();</span></p> 
 <p><span style="color:rgb(51,51,51)">译者注：如果要使用对话框来获得用户输入，你可能需要传递两个参数到</span><span style="color:rgb(51,51,51)">ShowHTMLDialog</span><span style="color:rgb(51,51,51)">。关于</span><span style="color:rgb(51,51,51)">ShowHTMLDialog</span><span style="color:rgb(51,51,51)">参数的说明，参见Platform SDK文档。ShowHTMLDialog和ShowHTMLDialogEx 似乎一直是MSHTML.DLL导出的两个函数，微软把它封装为接口，可能是在为未来的兼容性作准备。</span></p> 
 <p>控制新的窗口</p> 
 <p><span style="color:rgb(51,51,51)">控制浏览器控件的一个重要的方法</span><span style="color:rgb(51,51,51)">是</span><span style="color:rgb(51,51,51)">控制导航。你</span><span style="color:rgb(51,51,51)">在前面已经看</span><span style="color:rgb(51,51,51)">见</span><span style="color:rgb(51,51,51)">如何在</span><span style="color:rgb(51,51,51)">IDispatch::</span><span style="color:rgb(51,51,51)">Invoke中</span><span style="color:rgb(51,51,51)">拦截DISPID_BEFORENAVIGATE2</span><span style="color:rgb(51,51,51)">来</span><span style="color:rgb(51,51,51)">实现控制你的浏览器控件</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">导航</span><span style="color:rgb(51,51,51)">位置</span><span style="color:rgb(51,51,51)">。另外</span><span style="color:rgb(51,51,51)">一个</span><span style="color:rgb(51,51,51)">导航的重要的方面</span><span style="color:rgb(51,51,51)">是</span><span style="color:rgb(51,51,51)">要控制导航发生</span><span style="color:rgb(51,51,51)">方式</span><span style="color:rgb(51,51,51)">, 尤其</span><span style="color:rgb(51,51,51)">是</span><span style="color:rgb(51,51,51)">打开新的</span><span style="color:rgb(51,51,51)">窗口的</span><span style="color:rgb(51,51,51)">时候。让我们举例来说, 使用者</span><span style="color:rgb(51,51,51)">右击</span><span style="color:rgb(51,51,51)">一个</span><span style="color:rgb(51,51,51)">链接，</span><span style="color:rgb(51,51,51)">选择 "在新窗囗中</span><span style="color:rgb(51,51,51)">打开</span><span style="color:rgb(51,51,51)">" 或</span><span style="color:rgb(51,51,51)">某</span><span style="color:rgb(51,51,51)">一页包含像这样的脚本:</span></p> 
 <p><span style="color:rgb(51,51,51)">window.open("www.msn.com")</span></p> 
 <p><span style="color:rgb(51,51,51)">默认</span><span style="color:rgb(51,51,51)">地，浏览器控件</span><span style="color:rgb(51,51,51)">对</span><span style="color:rgb(51,51,51)">这</span><span style="color:rgb(51,51,51)">行代码的</span><span style="color:rgb(51,51,51)">处理</span><span style="color:rgb(51,51,51)">是</span><span style="color:rgb(51,51,51)">通过打开IE的一个新的</span><span style="color:rgb(51,51,51)">实例来</span><span style="color:rgb(51,51,51)">显示</span><span style="color:rgb(51,51,51)">网</span><span style="color:rgb(51,51,51)">页。这可能正好是你的应用程序需要的</span><span style="color:rgb(51,51,51)">，</span><span style="color:rgb(51,51,51)">但是</span><span style="color:rgb(51,51,51)">也可能不是</span><span style="color:rgb(51,51,51)">。也许你</span><span style="color:rgb(51,51,51)">需要在当前的</span><span style="color:rgb(51,51,51)">浏览器控件实例中</span><span style="color:rgb(51,51,51)">打开所有链接，</span><span style="color:rgb(51,51,51)">或</span><span style="color:rgb(51,51,51)">者</span><span style="color:rgb(51,51,51)">你将在你控制下的</span><span style="color:rgb(51,51,51)">浏览器控件</span><span style="color:rgb(51,51,51)">的一个新的实例——</span><span style="color:rgb(51,51,51)">具有</span><span style="color:rgb(51,51,51)">你的</span><span style="color:rgb(51,51,51)">用户界面和你的商标——打开链接</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">你</span><span style="color:rgb(51,51,51)">可以</span><span style="color:rgb(51,51,51)">在你的IDispatch实现中拦截一个事件——DWebBrowserEvents2::NewWindow2——来控制</span><span style="color:rgb(51,51,51)">它</span><span style="color:rgb(51,51,51)">。你的控制需要</span><span style="color:rgb(51,51,51)">连接到</span><span style="color:rgb(51,51,51)">DWebBrowserEvents2</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">连接点</span><span style="color:rgb(51,51,51)">来</span><span style="color:rgb(51,51,51)">拦截这一个事件。</span></p> 
 <p><span style="color:rgb(51,51,51)">你连接到</span><span style="color:rgb(51,51,51)">了</span><span style="color:rgb(51,51,51)">DWebBrowserEvents2之后,实现你的IDispatch::Invoke以处理 DISPID_NEWWINDOW2。在为DISPID_NEWWINDOW2</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">IDispatch::Invoke</span><span style="color:rgb(51,51,51)">函数调用中，数组</span><span style="color:rgb(51,51,51)">pDispParams包含两个参数。第一个,序号是零, 是一个布尔类型的数值，告诉浏览器控件是否取消新的窗囗。默认它是假值，而且将会打开一个新的窗囗。如果你要完全取消新窗囗的创建, 设定标志到真值。</span></p> 
 <p><span style="color:rgb(51,51,51)">序号为一的参数是一个IDispatch接口的指针。你</span><span style="color:rgb(51,51,51)">可以</span><span style="color:rgb(51,51,51)">将这一个参数设定为你已经创建的浏览器控件的IDispatch。当你</span><span style="color:rgb(51,51,51)">传回</span><span style="color:rgb(51,51,51)">这样</span><span style="color:rgb(51,51,51)">一个</span><span style="color:rgb(51,51,51)">IDispatch之后,MSHTML将会使用你给</span><span style="color:rgb(51,51,51)">出的控件打开链接</span><span style="color:rgb(51,51,51)">。</span></p> 
 <p><span style="color:rgb(51,51,51)">译者注：MFC中的DHTML类和类向导默认支持这个事件。需要更多信息的话，参见MSJ1998年7月份的文章</span><span style="color:rgb(51,51,51)">Keeping an Eye on Your Browser by Monitoring Internet Explorer 4.0 Events</span><span style="color:rgb(51,51,51)">，以及</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">微软知识库文章</span><span style="color:rgb(51,51,51)"> </span><span style="color:rgb(51,51,51)">Q184876 HOWTO: Use the WebBrowser Control NewWindow2 Event</span></p> 
 <p>显示一个正数对话框</p> 
 <p><span style="color:rgb(51,51,51)">IE6或者更高版本中，你可以在用户浏览一个合法的安全超文本传输协议(HTTPS)站点的时候显示证书对话框。这和用户点击IE中的锁图标效果相同。你可以通过</span><a href="http://msdn.microsoft.com/workshop/browser/webbrowser/reference/ifaces/dwebbrowserevents2/setsecurelockicon.asp" rel="nofollow"><span style="color:rgb(0,0,0)"> DWebBrowserEvents2::SetSecureLockIcon</span></a><span style="color:rgb(51,51,51)">事件来显示你自己的图标。</span></p> 
 <p><span style="color:rgb(51,51,51)">#define SHDVID_SSLSTATUS 33</span></p> 
 <p><span style="color:rgb(51,51,51)">IOleCommandTarget *pct;</span></p> 
 <p><span style="color:rgb(51,51,51)">if (SUCCEEDED(pWebBrowser2-&gt;QueryInterface(IID_IOleCommandTarget, (void **) &amp;pct)))</span></p> 
 <p><span style="color:rgb(51,51,51)">{<!-- --></span></p> 
 <p><span style="color:rgb(51,51,51)">   pct-&gt;Exec(&amp;CGID_ShellDocView, SHDVID_SSLSTATUS, 0, NULL, NULL);</span></p> 
 <p><span style="color:rgb(51,51,51)">   pct-&gt;Release();</span></p> 
 <p><span style="color:rgb(51,51,51)">}</span></p> 
 <p>信息栏</p> 
 <p><span style="color:rgb(51,51,51)">Windows XP SP2 中的Internet Explorer 6 引入了一个新的安全用户界面元素，称为信息栏。在特定操作被阻止的时候，信息栏给用户显示一个用户界面元素。特别的，它会在以下操作被阻止的时候显示。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">弹出窗口初始化(参见 </span><a href="#popup" rel="nofollow"><span style="color:rgb(0,0,0)">弹出窗口杀手</span></a><span style="color:rgb(51,51,51)">)</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">文件下载 (see </span><a href="#download" rel="nofollow"><span style="color:rgb(0,0,0)">文件下载的限制</span></a><span style="color:rgb(51,51,51)">)</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">安装ActiveX 控件(see </span><a href="#activex" rel="nofollow"><span style="color:rgb(0,0,0)">ActiveX 的限制</span></a><span style="color:rgb(51,51,51)">)</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">ActiveX控件安全提示的原因是用户安全设置或者是控件未标记为脚本安全的。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">文件的扩展名和多用途因特网邮件扩展类型(MIME)不符的(参见 </span><a href="#mime" rel="nofollow"><span style="color:rgb(0,0,0)">MIME 处理</span></a><span style="color:rgb(51,51,51)">)</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">网络协议锁死的内容(参见 </span><a href="#protocol" rel="nofollow"><span style="color:rgb(0,0,0)">协议</span></a><span style="color:rgb(51,51,51)">)</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">信息栏是Windows XP SP2 中的Internet Explorer 6引入的安全特性之一。和其他安全特性控制一样，可以通过一个注册表键来控制：(</span><a href="#FEATURE_SECURITYBAND" rel="nofollow"><span style="color:rgb(0,0,0)">FEATURE_SECURITYBAND</span></a><span style="color:rgb(51,51,51)">). 默认情况下IE(iexplorer.exe) 和Windows 资源管理器(explorer.exe) 在这个安全特性控制下。下面显示注册表键和启用过程：</span></p> 
 <p><span style="color:rgb(51,51,51)">HKEY_LOCAL_MACHINE (or HKEY_CURRENT_USER)</span></p> 
 <p><span style="color:rgb(51,51,51)">SOFTWARE</span></p> 
 <p><span style="color:rgb(51,51,51)">Microsoft</span></p> 
 <p><span style="color:rgb(51,51,51)">Internet Explorer</span></p> 
 <p><span style="color:rgb(51,51,51)">Main</span></p> 
 <p><span style="color:rgb(51,51,51)">FeatureControl</span></p> 
 <p><span style="color:rgb(51,51,51)">FEATURE_SECURITYBAND</span></p> 
 <p><span style="color:rgb(51,51,51)">iexplorer.exe</span><span style="color:rgb(51,51,51)">=</span><span style="color:rgb(51,51,51)"> 0x00000001</span></p> 
 <p><span style="color:rgb(51,51,51)">explorer.exe</span><span style="color:rgb(51,51,51)">=</span><span style="color:rgb(51,51,51)"> 0x00000001</span></p> 
 <p><span style="color:rgb(51,51,51)">process name.exe</span><span style="color:rgb(51,51,51)">=</span><span style="color:rgb(51,51,51)">0x00000001</span></p> 
 <p><span style="color:rgb(51,51,51)">这个FEATURE_SECURITYBAND 安全特性控制影响IE是否显示信息栏，信息栏在一个操作被阻止的时候提示用户。它不控制操作的阻止过程。</span></p> 
 <p><span style="color:rgb(51,51,51)">一个集成</span><span style="color:rgb(51,51,51)">浏览器控件</span><span style="color:rgb(51,51,51)">的程序可以通过将其进程添加到这个注册表键来启用信息栏。这可以通过调用</span><a href="http://msdn.microsoft.com/workshop/security/szone/reference/functions/CoInternetSetFeatureEnabled.asp" rel="nofollow"><span style="color:rgb(0,0,0)">CoInternetSetFeatureEnabled</span></a><span style="color:rgb(51,51,51)">函数来在运行时执行。如果一个应用程序并未在这个安全特性控制下，那么</span><span style="color:rgb(51,51,51)">浏览器控件</span><span style="color:rgb(51,51,51)">的行为和Internet Explorer 6 SP1b中的一样.</span></p> 
 <p><span style="color:rgb(51,51,51)">没有方法通过脚本来访问这个特性。</span></p> 
 <p><span style="color:rgb(51,51,51)">在FEATURE_SECURITYBAND及相关安全特性控制下的应用程序可以使用信息栏应用程序编程接口(API)来在一个</span><a href="http://msdn.microsoft.com/workshop/security/szone/reference/constants/urlaction.asp" rel="nofollow"><span style="color:rgb(0,0,0)">URL 操作</span></a><span style="color:rgb(51,51,51)">被禁止时自定义显示的用户界面。为信息栏引入了很多新的</span><a href="http://msdn.microsoft.com/library/en-us/com/htm/oen_a2z_22sk.asp" rel="nofollow"><span style="color:rgb(0,0,0)">OLECMDID</span></a><span style="color:rgb(51,51,51)">命令。头三个是属于CGID_DocHostCommandHandler组。宿主应用程序应该在它们的</span><span style="color:rgb(51,51,51)">IDocHostUIHandler</span><span style="color:rgb(51,51,51)">实现的同一个对象中实现</span><a href="http://msdn.microsoft.com/library/en-us/com/htm/oin_oc_9bg4.asp" rel="nofollow"><span style="color:rgb(0,0,0)">IOleCommandTarget</span></a><span style="color:rgb(51,51,51)"> ，以接受来自</span><span style="color:rgb(51,51,51)">浏览器控件</span><span style="color:rgb(51,51,51)">的</span><a href="http://msdn.microsoft.com/library/en-us/com/htm/oin_oc_33j7.asp" rel="nofollow"><span style="color:rgb(0,0,0)">IOleCommandTarget::Exec</span></a><span style="color:rgb(51,51,51)">调用。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">OLECMDID_PAGEACTIONBLOCKED</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">OLECMDID_PAGEACTIONUIQUERY</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">OLECMDID_FOCUSVIEWCONTROLS</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">宿主应用程序可以使用下面两个新的</span><span style="color:rgb(51,51,51)">OLECMDID</span><span style="color:rgb(51,51,51)"> 命令来执行</span><span style="color:rgb(51,51,51)">浏览器控件</span><span style="color:rgb(51,51,51)">的</span><span style="color:rgb(51,51,51)">IOleCommandTarget::Exec</span><span style="color:rgb(51,51,51)">调用。</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">OLECMDID_FOCUSVIEWCONTROLSQUERY</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">· </span><span style="color:rgb(51,51,51)">OLECMDID_SHOWPAGEACTIONMENU</span></p> 
 <p><span style="color:rgb(51,51,51)">· </span></p> 
 <p><span style="color:rgb(51,51,51)">这个示例使用</span><a href="http://msdn.microsoft.com/workshop/browser/webbrowser/reference/ifaces/iwebbrowser2/execwb.asp" rel="nofollow"><span style="color:rgb(0,0,0)">IWebBrowser2::ExecWB</span></a><span style="color:rgb(51,51,51)"> 来执行</span><a href="http://msdn.microsoft.com/library/en-us/com/htm/oen_a2z_22sk.asp" rel="nofollow"><span style="color:rgb(0,0,0)">OLECMDID_SHOWPAGEACTIONMENU</span></a><span style="color:rgb(51,51,51)"> 命令。</span></p> 
 <p><span style="color:rgb(51,51,51)">   POINT pt = { 0 };</span></p> 
 <p><span style="color:rgb(51,51,51)">   GetCursorPos(&amp;pt);</span></p> 
 <p><span style="color:rgb(51,51,51)">   CComVariant varHwnd((LONG)hwnd);</span></p> 
 <p><span style="color:rgb(51,51,51)">   CComVariant varX(pt.x);</span></p> 
 <p><span style="color:rgb(51,51,51)">   CComVariant varY(pt.y);</span></p> 
 <p><span style="color:rgb(51,51,51)">   SAFEARRAY* psa = SafeArrayCreateVector(VT_VARIANT, 0, 3);</span></p> 
 <p><span style="color:rgb(51,51,51)">   LONG lIndex = 0;</span></p> 
 <p><span style="color:rgb(51,51,51)">   SafeArrayPutElement(psa, &amp;lIndex, &amp;varHwnd);</span></p> 
 <p><span style="color:rgb(51,51,51)">   lIndex++;</span></p> 
 <p><span style="color:rgb(51,51,51)">   SafeArrayPutElement(psa, &amp;lIndex, &amp;varX);</span></p> 
 <p><span style="color:rgb(51,51,51)">   lIndex++;</span></p> 
 <p><span style="color:rgb(51,51,51)">   SafeArrayPutElement(psa, &amp;lIndex, &amp;varY);</span></p> 
 <p><span style="color:rgb(51,51,51)">   CComVariant varArgIn;</span></p> 
 <p><span style="color:rgb(51,51,51)">   V_VT(&amp;varArgIn) = VT_ARRAY | VT_I4;</span></p> 
 <p><span style="color:rgb(51,51,51)">   V_ARRAY(&amp;varArgIn) = psa;</span></p> 
 <p><span style="color:rgb(51,51,51)">   pBrowser-&gt;ExecWB(OLECMDID_SHOWPAGEACTIONMENU, (OLECMDEXECOPT)dwPageActionFlags, &amp;varArgIn, NULL);</span></p> 
 <p><span style="color:rgb(51,51,51)">另外，应用程序可以实现</span><a href="http://msdn.microsoft.com/workshop/security/szone/reference/ifaces/iinternetsecuritymanager/iinternetsecuritymanager.asp" rel="nofollow"><span style="color:rgb(0,0,0)">IInternetSecurityManager</span></a><span style="color:rgb(51,51,51)">来重载默认的安全区域设置，参见</span><a href="#Creating_a_Customize" rel="nofollow"><span style="color:rgb(0,0,0)">创建一个自定义URL安全管理器</span></a><span style="color:rgb(51,51,51)">以获得更多信息.</span></p> 
 <p>结论</p> 
 <p><span style="color:rgb(51,51,51)">你现在有许多技术，可以</span><span style="color:rgb(51,51,51)">根据你的</span><span style="color:rgb(51,51,51)">处理来自定义浏览器控件。这个文章</span><span style="color:rgb(51,51,51)">决不是没有遗漏的</span><span style="color:rgb(51,51,51)">,但是希望</span><span style="color:rgb(51,51,51)">你</span><span style="color:rgb(51,51,51)">现在可以自行发现超越本文的技术。检查IE</span><span style="color:rgb(51,51,51)">注册表设置中那些你可以用</span><span style="color:rgb(51,51,51)">IDocHostUIHandler::GetOptionKeyPath或IDocHostUIHandler2::GetOverrideKeyPath修改的信息。记住许多注册表设置相互依赖。你可能必须做一些实验</span><span style="color:rgb(51,51,51)">来</span><span style="color:rgb(51,51,51)">发现注册表设置</span><span style="color:rgb(51,51,51)">可以</span><span style="color:rgb(51,51,51)">多么的有效地</span><span style="color:rgb(51,51,51)">自定义；</span><span style="color:rgb(51,51,51)">如果</span><span style="color:rgb(51,51,51)">需要</span><span style="color:rgb(51,51,51)">控制浏览器控件</span><span style="color:rgb(51,51,51)">的拖放行为，</span><span style="color:rgb(51,51,51)">你也</span><span style="color:rgb(51,51,51)">可以去看看</span><span style="color:rgb(51,51,51)">IDocHostUIHandler::GetDropTarget。</span></p> 
 <p><a href="http://www.cnblogs.com/08shiyan/archive/2011/05/24/2055770.html" rel="nofollow"><span style="color:rgb(57,154,178)">C# WinForm WebBrowser (<span style="font-family:宋体">五</span><span style="font-family:Verdana">) </span><span style="font-family:宋体">讨厌的问题</span></span></a> </p> 
 <p><span style="color:rgb(51,51,51)">WebBrowse <span style="font-family:宋体">编辑模式 中几个讨厌的问题：</span></span></p> 
 <p><span style="color:rgb(255,102,0)">1<span style="font-family:宋体">、当设置</span><span style="font-family:Verdana">DocumentText</span><span style="font-family:宋体">属性值时会一直弹出一个</span><span style="font-family:Verdana">“</span><span style="font-family:宋体">可恶的保存对话框</span><span style="font-family:Verdana">”</span></span></p> 
 <p><span style="color:rgb(51,51,51)">现我已知的较好的策略有：</span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">1<span style="font-family:宋体">）在设置两个</span><span style="font-family:Verdana">DocumentText</span><span style="font-family:宋体">属性值之间使用</span><span style="font-family:Verdana">webBrowser1.Document.OpenNew(true)</span><span style="font-family:宋体">方法，但这个方法会引发一些问题。详细内容见下。</span></span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">2<span style="font-family:宋体">）在设置</span><span style="font-family:Verdana">DocumentText</span><span style="font-family:宋体">属性之前将编辑模式改为浏览模式，设置完后再将浏览模式改为编辑模式。</span></span></p> 
 <p><span style="color:rgb(255,102,0)"><br> </span><span style="color:rgb(255,102,0)">2<span style="font-family:宋体">、监控</span><span style="font-family:Verdana">Html</span><span style="font-family:宋体">内容的改变。</span></span></p> 
 <p><a href="http://www.cnblogs.com/08shiyan/archive/2011/02/18/1957995.html" rel="nofollow"><span style="color:rgb(0,0,0)">监控 <span style="font-family:Verdana">WebBrowser </span><span style="font-family:宋体">控件内容的改变</span></span></a></p> 
 <p><span style="color:rgb(255,102,0)"><br> </span><span style="color:rgb(255,102,0)">3<span style="font-family:宋体">、</span><span style="font-family:Verdana">WebBrowse</span><span style="font-family:宋体">的</span><span style="font-family:Verdana">Mouse</span><span style="font-family:宋体">事件。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">WebBrowse<span style="font-family:宋体">本身没有</span><span style="font-family:Verdana">Mouse</span><span style="font-family:宋体">的相关事件，但是我们可以借助</span><span style="font-family:Verdana">WebBrowse</span><span style="font-family:宋体">中的</span><span style="font-family:Verdana">Body</span><span style="font-family:宋体">元素来模拟一些简单的相关事件。</span></span></p> 
 <p style="background:rgb(245,245,245)"><span style="color:rgb(0,128,0)">//<span style="font-family:宋体">在</span><span style="font-family:Courier New">WinForm</span><span style="font-family:宋体">中注册</span><span style="font-family:Courier New">Web</span><span style="font-family:宋体">事件</span></span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(0,128,0)">//<span style="font-family:宋体">假设</span><span style="font-family:Courier New">HTML</span><span style="font-family:宋体">源代码如下：</span></span><span style="color:rgb(0,128,0)"><br> </span>&lt;html&gt; <br> &lt;body&gt; <br> &lt;input type=<span style="color:rgb(128,0,0)">"button"</span> id=<span style="color:rgb(128,0,0)">"btnClose"</span> value=<span style="color:rgb(128,0,0)">"<span style="font-family:宋体">关闭</span><span style="font-family:Courier New">"</span></span> /&gt; <br> &lt;/body&gt; <br> &lt;/html&gt;<br>  <br> <span style="color:rgb(0,128,0)">// WinForm<span style="font-family:宋体">中注册</span><span style="font-family:Courier New">Web</span><span style="font-family:宋体">事件</span></span><span style="color:rgb(0,128,0)"><br> </span>HtmlDocument htmlDoc = webBrowser.Document; <br> HtmlElement btnElement = htmlDoc.All[<span style="color:rgb(128,0,0)">"btnClose"</span>]; <br> <span style="color:rgb(0,0,255)">if</span> (btnElement != <span style="color:rgb(0,0,255)">null</span>) <br> { <br>     btnElement.click += <span style="color:rgb(0,0,255)">new</span> HtmlElementEventHandler(HtmlBtnClose_Click); <br> }</p> 
 <p><span style="color:rgb(51,51,51)">WebBrowse<span style="font-family:宋体">中更多的实用方法参见：</span></span><a href="http://www.cnblogs.com/08shiyan/archive/2011/04/22/2023861.html" rel="nofollow"><span style="color:rgb(0,0,0)">C#WinForm WebBrowser (<span style="font-family:宋体">二</span><span style="font-family:Verdana">) </span><span style="font-family:宋体">实用方法总结</span></span></a></p> 
 <p><span style="color:rgb(255,102,0)"><br> </span><span style="color:rgb(255,102,0)">4<span style="font-family:宋体">、</span><span style="font-family:Verdana">webBrowser1.Document.OpenNew(true)</span><span style="font-family:宋体">的</span><span style="font-family:Verdana">Bug</span></span></p> 
 <p><span style="color:rgb(51,51,51)">相关链接：</span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">1<span style="font-family:宋体">）</span></span><a href="http://www.cnblogs.com/08shiyan/archive/2011/03/17/1986977.html" rel="nofollow"><span style="color:rgb(0,0,0)">追踪导致 <span style="font-family:Verdana">WebBrowser</span><span style="font-family:宋体">控件 编辑模式下 </span><span style="font-family:Verdana">Ctrl + Z </span><span style="font-family:宋体">失效的原因 【求大侠佐证，这算不算是微软的</span><span style="font-family:Verdana">Bug</span><span style="font-family:宋体">呢？】</span></span></a></p> 
 <p><a href="http://www.cnblogs.com/08shiyan/archive/2011/03/17/1986977.html" rel="nofollow"><span style="color:rgb(57,154,178)">追踪导致 <span style="font-family:Verdana">WebBrowser</span><span style="font-family:宋体">控件 编辑模式下 </span><span style="font-family:Verdana">Ctrl + Z </span><span style="font-family:宋体">失效的原因 【求大侠佐证，这算不算是微软的</span><span style="font-family:Verdana">Bug</span><span style="font-family:宋体">呢？】</span></span></a> </p> 
 <p><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">导致<span style="font-family:Verdana">Ctrl  + Z</span><span style="font-family:宋体">失效的原因由以下</span><span style="font-family:Verdana">2</span><span style="font-family:宋体">点连锁引发而导致：</span></span></p> 
 <p><span style="color:rgb(51,51,51)">1<span style="font-family:宋体">、为了解决 </span><span style="font-family:Verdana">WebBrowser </span><span style="font-family:宋体">控件导航时弹出</span><span style="font-family:Verdana">“</span><span style="font-family:宋体">保存对话框</span><span style="font-family:Verdana">”</span><span style="font-family:宋体">，使用了 </span><span style="font-family:Verdana">this.webBrowser.Document.OpenNew(true); // </span><span style="font-family:宋体">防止 弹出保存对话框， 该方法指示新的文本改变将会在新窗口中打开。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">2<span style="font-family:宋体">、 由原因</span><span style="font-family:Verdana">1</span><span style="font-family:宋体">导致 </span><span style="font-family:Verdana">webBrowser </span><span style="font-family:宋体">控件的编辑模式失效， 表面上看上去还是可以编辑的，但实际上新窗口内部已经不支持编辑了。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">注：这里涉及到了<span style="font-family:Verdana">WebBrowser</span><span style="font-family:宋体">控件的特殊性，它是由三层控件嵌套而成的，外面的两层是大概负责容器、 及 响应用户操作的， 而最内层的则是承载</span><span style="font-family:Verdana">HTML</span><span style="font-family:宋体">标记，并通过渲染引擎展示</span><span style="font-family:Verdana">HTML</span><span style="font-family:宋体">内容。用黑盒测试的方法推断，当使用</span><span style="font-family:Verdana">webBrowser.Document.OpenNew(true);  </span><span style="font-family:宋体">方法时，最内层控件应该是一个新的实例， 表面上看上去还是可以编辑的，但实际上内部的新窗口已经不支持编辑了，进而导致了</span><span style="font-family:Verdana">Ctrl + Z</span><span style="font-family:宋体">的失效！</span></span></p> 
 <p><span style="color:rgb(51,51,51)">测试代码如下：</span></p> 
 <p style="background:rgb(245,245,245)"><span style="color:rgb(0,0,255)">public</span> <span style="color:rgb(0,0,255)">partial</span> <span style="color:rgb(0,0,255)">class</span> FrmTest : Form<br> {<!-- --><br> <span style="color:rgb(0,128,0)">// <span style="font-family:宋体">界面上有一个</span><span style="font-family:Courier New">WebBrowser </span><span style="font-family:宋体">和 </span><span style="font-family:Courier New">4</span><span style="font-family:宋体">个</span><span style="font-family:Courier New">Button</span></span><span style="color:rgb(0,128,0)"><br> </span><br> <span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">string</span> strUrl = <span style="color:rgb(128,0,0)">"http://www.cnblogs.com/08shiyan"</span>;<br> <br> <span style="color:rgb(0,0,255)">public</span> FrmTest()<br> {<!-- --><br> InitializeComponent();<br> }<br> <br> <span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> </span><span style="color:rgb(128,128,128)">&lt;summary&gt;</span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> 编辑模式</span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> </span><span style="color:rgb(128,128,128)">&lt;/summary&gt;</span><span style="color:rgb(128,128,128)"><br> </span><span style="color:rgb(0,0,255)">public</span> <span style="color:rgb(0,0,255)">void</span> EditMode()<br> {<!-- --><br> <span style="color:rgb(0,0,255)">if</span> (<span style="color:rgb(0,0,255)">this</span>.webBrowser1.Document != <span style="color:rgb(0,0,255)">null</span>)<br> {<!-- --><br> mshtml.IHTMLDocument2 doc = <span style="color:rgb(0,0,255)">this</span>.webBrowser1.Document.DomDocument <span style="color:rgb(0,0,255)">as</span> mshtml.IHTMLDocument2;<br> doc.designMode = <span style="color:rgb(128,0,0)">"on"</span>;<br> }<br> }<br> <br> <span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> </span><span style="color:rgb(128,128,128)">&lt;summary&gt;</span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> 启用浏览模式</span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(128,128,128)">///</span><span style="color:rgb(0,128,0)"> </span><span style="color:rgb(128,128,128)">&lt;/summary&gt;</span><span style="color:rgb(128,128,128)"><br> </span><span style="color:rgb(0,0,255)">public</span> <span style="color:rgb(0,0,255)">void</span> BrowseMode()<br> {<!-- --><br> <span style="color:rgb(0,0,255)">if</span> (<span style="color:rgb(0,0,255)">this</span>.webBrowser1.Document != <span style="color:rgb(0,0,255)">null</span>)<br> {<!-- --><br> mshtml.IHTMLDocument2 doc = <span style="color:rgb(0,0,255)">this</span>.webBrowser1.Document.DomDocument <span style="color:rgb(0,0,255)">as</span> mshtml.IHTMLDocument2;<br> doc.designMode = <span style="color:rgb(128,0,0)">"off"</span>;<br> }<br> }<br> <br> <span style="color:rgb(0,128,0)">// <span style="font-family:宋体">请确保该按钮是应用程序启动后第一次被点击</span></span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">void</span> button1_Click(<span style="color:rgb(0,0,255)">object</span> sender, EventArgs e)<br> {<!-- --><br> <span style="color:rgb(0,0,255)">this</span>.webBrowser1.DocumentText = <span style="color:rgb(0,0,255)">string</span>.Empty;<br> <span style="color:rgb(0,0,255)">this</span>.webBrowser1.Document.Write(<span style="color:rgb(0,0,255)">string</span>.Format(<span style="color:rgb(128,0,0)">"&lt;BODY&gt;{0}<span style="font-family:宋体">我的誓言博客</span><span style="font-family:Courier New">2&lt;/BODY&gt;"</span></span>, <span style="color:rgb(0,0,255)">this</span>.strUrl));<br> <span style="color:rgb(0,0,255)">this</span>.EditMode();<br> <br> <span style="color:rgb(0,0,255)">this</span>.webBrowser1.Document.OpenNew(<span style="color:rgb(0,0,255)">true</span>);<br> <span style="color:rgb(0,0,255)">this</span>.webBrowser1.Document.Write(<span style="color:rgb(0,0,255)">string</span>.Format(<span style="color:rgb(128,0,0)">"&lt;BODY&gt;{0}<span style="font-family:宋体">我的誓言博客</span><span style="font-family:Courier New">2&lt;/BODY&gt;"</span></span>, <span style="color:rgb(0,0,255)">this</span>.strUrl));<br> <br> <span style="color:rgb(0,128,0)">// <span style="font-family:宋体">注意此时</span><span style="font-family:Courier New">Ctrl + Z </span><span style="font-family:宋体">撤销操作将会失效</span></span><span style="color:rgb(0,128,0)"><br> </span>}<br> <br> <span style="color:rgb(0,128,0)">// <span style="font-family:宋体">请确保该按钮是应用程序启动后第一次被点击</span></span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">void</span> button2_Click(<span style="color:rgb(0,0,255)">object</span> sender, EventArgs e)<br> {<!-- --><br> <span style="color:rgb(0,0,255)">this</span>.webBrowser1.DocumentText = <span style="color:rgb(0,0,255)">string</span>.Empty;<br> <span style="color:rgb(0,0,255)">this</span>.webBrowser1.Document.Write(<span style="color:rgb(0,0,255)">string</span>.Format(<span style="color:rgb(128,0,0)">"&lt;BODY&gt;{0}<span style="font-family:宋体">我的誓言博客</span><span style="font-family:Courier New">2&lt;/BODY&gt;"</span></span>, <span style="color:rgb(0,0,255)">this</span>.strUrl));<br> <span style="color:rgb(0,0,255)">this</span>.EditMode();<br> <br> <span style="color:rgb(0,0,255)">this</span>.webBrowser1.Document.OpenNew(<span style="color:rgb(0,0,255)">true</span>);<br> <span style="color:rgb(0,0,255)">this</span>.webBrowser1.Document.Write(<span style="color:rgb(0,0,255)">string</span>.Format(<span style="color:rgb(128,0,0)">"&lt;BODY&gt;{0}<span style="font-family:宋体">我的誓言博客</span><span style="font-family:Courier New">2&lt;/BODY&gt;"</span></span>, <span style="color:rgb(0,0,255)">this</span>.strUrl));<br> <br> <span style="color:rgb(0,0,255)">this</span>.EditMode(); <span style="color:rgb(0,128,0)">// <span style="font-family:宋体">与</span><span style="font-family:Courier New">button1</span><span style="font-family:宋体">的差别是再次启用编辑模式 </span><span style="font-family:Courier New">// </span><span style="font-family:宋体">注意此时</span><span style="font-family:Courier New">Ctrl + Z </span><span style="font-family:宋体">撤销操作也会失效</span></span><span style="color:rgb(0,128,0)"><br> </span>}<br> <br> <span style="color:rgb(0,128,0)">// <span style="font-family:宋体">请确保该按钮是应用程序启动后第一次被点击</span></span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">void</span> button3_Click(<span style="color:rgb(0,0,255)">object</span> sender, EventArgs e)<br> {<!-- --><br> <span style="color:rgb(0,0,255)">this</span>.webBrowser1.DocumentText = <span style="color:rgb(0,0,255)">string</span>.Empty;<br> <span style="color:rgb(0,0,255)">this</span>.webBrowser1.Document.Write(<span style="color:rgb(0,0,255)">string</span>.Format(<span style="color:rgb(128,0,0)">"&lt;BODY&gt;{0}<span style="font-family:宋体">我的誓言博客</span><span style="font-family:Courier New">2&lt;/BODY&gt;"</span></span>, <span style="color:rgb(0,0,255)">this</span>.strUrl));<br> <span style="color:rgb(0,0,255)">this</span>.EditMode();<br> <br> <span style="color:rgb(0,0,255)">this</span>.webBrowser1.Document.OpenNew(<span style="color:rgb(0,0,255)">true</span>);<br> <span style="color:rgb(0,0,255)">this</span>.webBrowser1.Document.Write(<span style="color:rgb(0,0,255)">string</span>.Format(<span style="color:rgb(128,0,0)">"&lt;BODY&gt;{0}<span style="font-family:宋体">我的誓言博客</span><span style="font-family:Courier New">2&lt;/BODY&gt;"</span></span>, <span style="color:rgb(0,0,255)">this</span>.strUrl));<br> <br> <span style="color:rgb(0,0,255)">this</span>.BrowseMode(); <span style="color:rgb(0,128,0)">// <span style="font-family:宋体">与</span><span style="font-family:Courier New">button2 </span><span style="font-family:宋体">的区别是 先关闭编辑模式，再启用编辑模式</span></span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(0,0,255)">this</span>.EditMode();<br> <br> <span style="color:rgb(0,128,0)">// <span style="font-family:宋体">此时 </span><span style="font-family:Courier New">Ctrl + Z </span><span style="font-family:宋体">可以使用</span></span><span style="color:rgb(0,128,0)"><br> </span>}<br> <br> <span style="color:rgb(0,128,0)">// <span style="font-family:宋体">重启应用程序</span></span><span style="color:rgb(0,128,0)"><br> </span><span style="color:rgb(0,0,255)">private</span> <span style="color:rgb(0,0,255)">void</span> button4_Click(<span style="color:rgb(0,0,255)">object</span> sender, EventArgs e)<br> {<!-- --><br> Application.Restart();<br> }<br> <br> }</p> 
 <p><span style="color:rgb(51,51,51)">根据以上得出结论：</span><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)">在<span style="font-family:Verdana">“</span><span style="font-family:宋体">编辑模式</span><span style="font-family:Verdana">”</span><span style="font-family:宋体">下： </span><span style="font-family:Verdana">this.webBrowser.Document.OpenNew(true); </span><span style="font-family:宋体">方法会打开一个新的</span><span style="font-family:Verdana">“</span><span style="font-family:宋体">内部窗口</span><span style="font-family:Verdana">”</span><span style="font-family:宋体">，而新窗口中</span><span style="font-family:Verdana">“</span><span style="font-family:宋体">编辑模式</span><span style="font-family:Verdana">”</span><span style="font-family:宋体">出现问题，导致</span><span style="font-family:Verdana">Ctrl + Z ,Ctrl +Y</span><span style="font-family:宋体">操作失效。 此时 需要先关闭 </span><span style="font-family:Verdana">“</span><span style="font-family:宋体">编辑模式</span><span style="font-family:Verdana">” </span><span style="font-family:宋体">然后再打开</span><span style="font-family:Verdana">“</span><span style="font-family:宋体">编辑模式</span><span style="font-family:Verdana">” Ctrl + Z, Ctrl +Y </span><span style="font-family:宋体">才能正常使用。</span></span></p> 
 <p><span style="color:rgb(51,51,51)">求佐证。。。</span></p> 
 <p><span style="color:rgb(51,51,51)">原创 转载请标明出处： </span><a href="http://www.cnblogs.com/08shiyan" rel="nofollow"><span style="color:rgb(0,0,0)">http://www.cnblogs.com/08shiyan</span></a></p> 
 <p><span style="color:rgb(51,51,51)">2<span style="font-family:宋体">）</span></span><a href="http://topic.csdn.net/u/20110318/14/e3744686-3dae-4152-a1d8-c0011e8f355c.html" rel="nofollow"><span style="color:rgb(57,154,178)">http://topic.csdn.net/u/20110318/14/e3744686-3dae-4152-a1d8-c0011e8f355c.html</span></a></p> 
 <p><span style="color:rgb(51,51,51)"><br> </span><span style="color:rgb(51,51,51)"><br> </span><a href="http://www.google.com.hk/custom?hl=zh-CN&amp;newwindow=1&amp;safe=strict&amp;client=pub-4210569241504288&amp;cof=FORID%3A1%3BGL%3A1%3BS%3Ahttp%3A%2F%2Fwww.cnblogs.com%2F%3BL%3Ahttp%3A%2F%2Fwww.cnblogs.com%2Fimages%2Flogo_small.gif%3BLH%3A50%3BLW%3A129%3BLBGC%3AFFFFFF%3BLC%3A%230000ff%3BVLC%3A%23663399%3BGFNT%3A%230000ff%3BGIMP%3A%230000ff%3BDIV%3A%23336699%3B&amp;domains=cnblogs.com&amp;channel=5875741252&amp;q=site%3Awww.cnblogs.com%2F08shiyan%2F+webbrowser&amp;btnG=Google+%E6%90%9C%E7%B4%A2&amp;sitesearch=cnblogs.com&amp;meta=" rel="nofollow"><span style="color:rgb(0,0,0)">更多的关于<span style="font-family:Verdana">WebBrowse</span><span style="font-family:宋体">的问题。</span></span></a></p> 
 <p></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4b70a449898ed06bdc85d9ca443c7d53/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">不是iPhone5的话，还是别玩营销花招吧：华为D1四核将开卖</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4d5dc6b3bedcaad2b26ed213d3678f4a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">linux更改文件权限</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>