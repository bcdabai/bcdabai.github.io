<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Redisï¼šåŸç†é€Ÿæˆ&#43;é¡¹ç›®å®æˆ˜â€”â€”Rediså®æˆ˜9ï¼ˆç§’æ€ä¼˜åŒ–ï¼‰ - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Redisï¼šåŸç†é€Ÿæˆ&#43;é¡¹ç›®å®æˆ˜â€”â€”Rediså®æˆ˜9ï¼ˆç§’æ€ä¼˜åŒ–ï¼‰" />
<meta property="og:description" content="ğŸ‘¨â€ğŸ“ä½œè€…ç®€ä»‹ï¼šä¸€ä½å¤§å››ã€ç ”0å­¦ç”Ÿï¼Œæ­£åœ¨åŠªåŠ›å‡†å¤‡å¤§å››æš‘å‡çš„å®ä¹ 
ğŸŒŒä¸ŠæœŸæ–‡ç« ï¼šRedisï¼šåŸç†é€Ÿæˆ&#43;é¡¹ç›®å®æˆ˜â€”â€”Rediså®æˆ˜8ï¼ˆåŸºäºRedisçš„åˆ†å¸ƒå¼é”åŠä¼˜åŒ–ï¼‰
ğŸ“šè®¢é˜…ä¸“æ ï¼šRedisï¼šåŸç†é€Ÿæˆ&#43;é¡¹ç›®å®æˆ˜
å¸Œæœ›æ–‡ç« å¯¹ä½ ä»¬æœ‰æ‰€å¸®åŠ©
ç®€å•å›é¡¾ä¸€ä¸‹ä¹‹å‰å®ç°ç§’æ€çš„æ€è·¯ï¼Œå…¶å®æ— éå°±æ˜¯2ç‚¹ï¼š
1ã€åº“å­˜å¤Ÿä¸å¤Ÿï¼Œè¯¥ç”¨æˆ·æœ‰æ²¡æœ‰ä¹°è¿‡
2ã€æ“ä½œæ•°æ®åº“ï¼ˆæ‰£åº“å­˜ã€åˆ›å»ºè®¢å•ï¼‰
ä¹‹å‰çš„ä¸šåŠ¡ç”±äºæ¶‰åŠäº†å¤§é‡æ•°æ®åº“çš„æ“ä½œï¼Œæ‰€ä»¥æ€§èƒ½å¹¶ä¸æ˜¯å¤ªå¥½ã€‚
ç§’æ€ä¼˜åŒ– å¼‚æ­¥ç§’æ€æ€è·¯Rediså®ç°ç§’æ€èµ„æ ¼çš„åˆ¤æ–­åˆ†æå®ç° åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€å¼‚æ­¥ä¸‹å•æ€»ç»“åŠå‘ç°é—®é¢˜ å¼‚æ­¥ç§’æ€æ€è·¯ ä¹‹å‰çš„ä¸šåŠ¡ï¼Œå¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š
å¯ä»¥å‘ç°ï¼ŒTomcatä¸­é¡ºåºæ‰§è¡Œçš„æ“ä½œé‡Œé¢æœ‰4ä¸ªéœ€è¦å¯¹æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢æˆ–ä¿®æ”¹æ“ä½œï¼Œè€ŒMySQLæœ¬èº«çš„å¹¶å‘èƒ½åŠ›å°±æ˜¯å¾ˆå·®çš„ï¼Œæ—¶é—´æ˜¯æ‰€æœ‰æ—¶é—´ä¹‹å’Œï¼Œè¿™ç§è§£å†³æ–¹å¼å¹¶ä¸å¥½ã€‚
å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°†æ“ä½œæ•°æ®åº“çš„æ­¥éª¤åˆ†ç»™å¤šä¸ªçº¿ç¨‹æ¥åšï¼Œè€Œåº“å­˜é‡åˆ¤æ–­ã€æ˜¯å¦å…·æœ‰è´­ä¹°èµ„æ ¼çš„åˆ¤æ–­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å…¶äº¤ç»™Redisï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚
æ—¢ç„¶æ˜¯å°†æ­¥éª¤åˆ†ç»™å¤šä¸ªçº¿ç¨‹æ¥åšï¼Œæˆ‘ä»¬è¦å¼€è¾Ÿçº¿ç¨‹ï¼Œå¹¶ä¸”è¦ä½¿å¾—å¼€è¾Ÿçš„çº¿ç¨‹èƒ½å¤Ÿæ­£ç¡®æ‰§è¡Œä¸šåŠ¡ï¼š
æ•´ä¸ªä¸šåŠ¡çš„æµç¨‹è¢«åˆ†å¼€äº†ï¼Œæ‰€éœ€è¦çš„æ—¶é—´ä¸å†æ˜¯æ‰€æœ‰çš„è¿‡ç¨‹æ—¶é—´ä¹‹å’Œï¼ˆå®Œæˆä¸‹å•çš„æ“ä½œæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼‰ï¼Œè€Œä¸”æ•´ä¸ªä¸šåŠ¡åŸºäºRedisï¼Œå°†ä¼šå¤§å¤§æå‡ä¸šåŠ¡çš„æ€§èƒ½ã€‚
ä½†è¿™éœ€è¦è€ƒè™‘2ä¸ªéš¾ç‚¹é—®é¢˜ï¼šå¦‚ä½•åœ¨Redisé‡Œé¢å®Œæˆåˆ¤æ–­åº“å­˜ä»¥åŠä¸€äººä¸€å•çš„æ ¡éªŒï¼Ÿå¦‚ä½•åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€å¼‚æ­¥ä¸‹å•ï¼Ÿ
Rediså®ç°ç§’æ€èµ„æ ¼çš„åˆ¤æ–­ åˆ†æ è¦åœ¨Redisé‡Œé¢åˆ¤æ–­åº“å­˜é‡ä»¥åŠä¸€äººä¸€å•ï¼Œæˆ‘ä»¬è‚¯å®šéœ€è¦å°†ä¼˜æƒ åˆ¸çš„åº“å­˜ä¿¡æ¯ä»¥åŠç›¸å…³è®¢å•ä¿¡æ¯ç¼“å­˜åˆ°Redisä¸­å»ï¼Œæˆ‘ä»¬éœ€è¦é€‰å–åˆé€‚çš„æ•°æ®ç»“æ„æ¥ä¿å­˜è¿™ä¸¤ä¸ªä¿¡æ¯ã€‚
åº“å­˜å¾ˆå®¹æ˜“ï¼Œå› ä¸ºåªåŒ…å«äº†åº“å­˜é‡è¿™ä¸ªä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨Stringç±»å‹è¿›è¡Œå­˜å‚¨å³å¯ã€‚
ä½†è¦å®ç°ä¸€äººä¸€å•ï¼Œæˆ‘ä»¬è¦åˆ¤æ–­è¿™ä¸ªä¼˜æƒ åˆ¸è¢«å“ªäº›ç”¨æˆ·è´­ä¹°è¿‡ã€‚æ‰€ä»¥è¿™ä¸ªæ•°æ®ç»“æ„éœ€è¦èƒ½å¤Ÿä¿å­˜å¤šä¸ªå€¼ï¼Œè€Œåˆå› ä¸ºä¸€äººä¸€å•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿å­˜çš„ç”¨æˆ·çš„idæ˜¾ç„¶æ˜¯ä¸èƒ½é‡å¤çš„ã€‚æ‰€ä»¥ï¼Œsetæ˜¯å¾ˆé€‚åˆçš„ã€‚
å› æ­¤ä¸šåŠ¡æµç¨‹å¯ä»¥å¾ˆå®¹æ˜“çŸ¥é“ï¼š
å¯ä»¥å‘ç°ä¸šåŠ¡çš„æ­¥éª¤è¿˜æ˜¯æœ‰å¾ˆå¤šæ­¥çš„ï¼Œå› æ­¤æˆ‘ä»¬è¦ä¿è¯æ­¥éª¤çš„åŸå­æ€§ï¼Œå› æ­¤ä¸Šè¿°çš„å†…å®¹åº”å½“ç”¨Luaè„šæœ¬æ¥å†™ã€‚
å®ç° éœ€æ±‚ï¼š
1ã€æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸çš„ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­
2ã€åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ã€å†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ
3ã€è‹¥æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idä¸ç”¨æˆ·idè¿›è¡Œå°è£…ï¼Œå†å­˜å…¥é˜»å¡é˜Ÿåˆ—
4ã€å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•
1ã€åœ¨VoucherServiceImplç±»ä¸­æ–°å¢ä¼˜æƒ åˆ¸ï¼ŒåŒæ—¶ä¿å­˜åˆ°Redisä¸­ï¼š
@Resource private StringRedisTemplate stringRedisTemplate; @Override @Transactional public void addSeckillVoucher(Voucher voucher) { // ä¿å­˜ä¼˜æƒ åˆ¸ save(voucher); // ä¿å­˜ç§’æ€ä¿¡æ¯ SeckillVoucher seckillVoucher = new SeckillVoucher(); seckillVoucher.setVoucherId(voucher.getId()); seckillVoucher.setStock(voucher.getStock()); seckillVoucher.setBeginTime(voucher.getBeginTime()); seckillVoucher.setEndTime(voucher.getEndTime()); seckillVoucherService.save(seckillVoucher); //ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­, SECKILL_STOCK_KEY = &#34;seckill:stock:&#34; stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY &#43; voucher.getId(), voucher.getStock().toString()); } æ‰“å¼€postmanï¼Œè¿›è¡Œæµ‹è¯•ï¼š
æ·»åŠ æˆåŠŸï¼š" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4e5cc51ff2081bd02eb5bc7fd615fbef/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-10T21:42:17+08:00" />
<meta property="article:modified_time" content="2024-01-10T21:42:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Redisï¼šåŸç†é€Ÿæˆ&#43;é¡¹ç›®å®æˆ˜â€”â€”Rediså®æˆ˜9ï¼ˆç§’æ€ä¼˜åŒ–ï¼‰</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>ğŸ‘¨â€ğŸ“ä½œè€…ç®€ä»‹ï¼šä¸€ä½å¤§å››ã€ç ”0å­¦ç”Ÿï¼Œæ­£åœ¨åŠªåŠ›å‡†å¤‡å¤§å››æš‘å‡çš„å®ä¹ <br> ğŸŒŒä¸ŠæœŸæ–‡ç« ï¼š<a href="https://blog.csdn.net/m0_52380556/article/details/135445915?spm=1001.2014.3001.5502">Redisï¼šåŸç†é€Ÿæˆ+é¡¹ç›®å®æˆ˜â€”â€”Rediså®æˆ˜8ï¼ˆåŸºäºRedisçš„åˆ†å¸ƒå¼é”åŠä¼˜åŒ–ï¼‰</a><br> ğŸ“šè®¢é˜…ä¸“æ ï¼š<a href="https://blog.csdn.net/m0_52380556/category_12538486.html?spm=1001.2014.3001.5482">Redisï¼šåŸç†é€Ÿæˆ+é¡¹ç›®å®æˆ˜</a><br> å¸Œæœ›æ–‡ç« å¯¹ä½ ä»¬æœ‰æ‰€å¸®åŠ©</p> 
</blockquote> 
<blockquote> 
 <p>ç®€å•å›é¡¾ä¸€ä¸‹ä¹‹å‰å®ç°ç§’æ€çš„æ€è·¯ï¼Œå…¶å®æ— éå°±æ˜¯2ç‚¹ï¼š<br> 1ã€åº“å­˜å¤Ÿä¸å¤Ÿï¼Œè¯¥ç”¨æˆ·æœ‰æ²¡æœ‰ä¹°è¿‡<br> 2ã€æ“ä½œæ•°æ®åº“ï¼ˆæ‰£åº“å­˜ã€åˆ›å»ºè®¢å•ï¼‰</p> 
</blockquote> 
<p>ä¹‹å‰çš„ä¸šåŠ¡ç”±äºæ¶‰åŠäº†å¤§é‡æ•°æ®åº“çš„æ“ä½œï¼Œæ‰€ä»¥æ€§èƒ½å¹¶ä¸æ˜¯å¤ªå¥½ã€‚</p> 
<p></p> 
<div class="toc"> 
 <h4>ç§’æ€ä¼˜åŒ–</h4> 
 <ul><li><a href="#_13" rel="nofollow">å¼‚æ­¥ç§’æ€æ€è·¯</a></li><li><a href="#Redis_23" rel="nofollow">Rediså®ç°ç§’æ€èµ„æ ¼çš„åˆ¤æ–­</a></li><li><ul><li><a href="#_24" rel="nofollow">åˆ†æ</a></li><li><a href="#_31" rel="nofollow">å®ç°</a></li></ul> 
  </li><li><a href="#_132" rel="nofollow">åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€å¼‚æ­¥ä¸‹å•</a></li><li><a href="#_277" rel="nofollow">æ€»ç»“åŠå‘ç°é—®é¢˜</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_13"></a>å¼‚æ­¥ç§’æ€æ€è·¯</h2> 
<p>ä¹‹å‰çš„ä¸šåŠ¡ï¼Œå¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºï¼š<br> <img src="https://images2.imgbox.com/98/97/WMnCVlT7_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> å¯ä»¥å‘ç°ï¼ŒTomcatä¸­é¡ºåºæ‰§è¡Œçš„æ“ä½œé‡Œé¢æœ‰4ä¸ªéœ€è¦å¯¹æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢æˆ–ä¿®æ”¹æ“ä½œï¼Œè€ŒMySQLæœ¬èº«çš„å¹¶å‘èƒ½åŠ›å°±æ˜¯å¾ˆå·®çš„ï¼Œæ—¶é—´æ˜¯æ‰€æœ‰æ—¶é—´ä¹‹å’Œï¼Œè¿™ç§è§£å†³æ–¹å¼å¹¶ä¸å¥½ã€‚<br> å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°†æ“ä½œæ•°æ®åº“çš„æ­¥éª¤åˆ†ç»™å¤šä¸ªçº¿ç¨‹æ¥åšï¼Œè€Œåº“å­˜é‡åˆ¤æ–­ã€æ˜¯å¦å…·æœ‰è´­ä¹°èµ„æ ¼çš„åˆ¤æ–­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å…¶äº¤ç»™Redisï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚<br> æ—¢ç„¶æ˜¯å°†æ­¥éª¤åˆ†ç»™å¤šä¸ªçº¿ç¨‹æ¥åšï¼Œæˆ‘ä»¬è¦å¼€è¾Ÿçº¿ç¨‹ï¼Œå¹¶ä¸”è¦ä½¿å¾—å¼€è¾Ÿçš„çº¿ç¨‹èƒ½å¤Ÿæ­£ç¡®æ‰§è¡Œä¸šåŠ¡ï¼š</p> 
<p><img src="https://images2.imgbox.com/e5/1f/dQ3hN5JH_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> æ•´ä¸ªä¸šåŠ¡çš„æµç¨‹è¢«åˆ†å¼€äº†ï¼Œæ‰€éœ€è¦çš„æ—¶é—´ä¸å†æ˜¯æ‰€æœ‰çš„è¿‡ç¨‹æ—¶é—´ä¹‹å’Œï¼ˆå®Œæˆä¸‹å•çš„æ“ä½œæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼‰ï¼Œè€Œä¸”æ•´ä¸ªä¸šåŠ¡åŸºäºRedisï¼Œå°†ä¼šå¤§å¤§æå‡ä¸šåŠ¡çš„æ€§èƒ½ã€‚<br> ä½†è¿™éœ€è¦è€ƒè™‘2ä¸ªéš¾ç‚¹é—®é¢˜ï¼šå¦‚ä½•åœ¨Redisé‡Œé¢å®Œæˆåˆ¤æ–­åº“å­˜ä»¥åŠä¸€äººä¸€å•çš„æ ¡éªŒï¼Ÿå¦‚ä½•åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€å¼‚æ­¥ä¸‹å•ï¼Ÿ</p> 
<h2><a id="Redis_23"></a>Rediså®ç°ç§’æ€èµ„æ ¼çš„åˆ¤æ–­</h2> 
<h3><a id="_24"></a>åˆ†æ</h3> 
<p>è¦åœ¨Redisé‡Œé¢åˆ¤æ–­åº“å­˜é‡ä»¥åŠä¸€äººä¸€å•ï¼Œæˆ‘ä»¬è‚¯å®šéœ€è¦å°†ä¼˜æƒ åˆ¸çš„åº“å­˜ä¿¡æ¯ä»¥åŠç›¸å…³è®¢å•ä¿¡æ¯ç¼“å­˜åˆ°Redisä¸­å»ï¼Œæˆ‘ä»¬éœ€è¦é€‰å–åˆé€‚çš„æ•°æ®ç»“æ„æ¥ä¿å­˜è¿™ä¸¤ä¸ªä¿¡æ¯ã€‚<br> åº“å­˜å¾ˆå®¹æ˜“ï¼Œå› ä¸ºåªåŒ…å«äº†åº“å­˜é‡è¿™ä¸ªä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨Stringç±»å‹è¿›è¡Œå­˜å‚¨å³å¯ã€‚<br> ä½†è¦å®ç°ä¸€äººä¸€å•ï¼Œæˆ‘ä»¬è¦åˆ¤æ–­è¿™ä¸ªä¼˜æƒ åˆ¸è¢«å“ªäº›ç”¨æˆ·è´­ä¹°è¿‡ã€‚æ‰€ä»¥è¿™ä¸ªæ•°æ®ç»“æ„éœ€è¦èƒ½å¤Ÿä¿å­˜å¤šä¸ªå€¼ï¼Œè€Œåˆå› ä¸ºä¸€äººä¸€å•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿å­˜çš„ç”¨æˆ·çš„idæ˜¾ç„¶æ˜¯ä¸èƒ½é‡å¤çš„ã€‚æ‰€ä»¥ï¼Œsetæ˜¯å¾ˆé€‚åˆçš„ã€‚<br> å› æ­¤ä¸šåŠ¡æµç¨‹å¯ä»¥å¾ˆå®¹æ˜“çŸ¥é“ï¼š<br> <img src="https://images2.imgbox.com/5a/a7/IFYVJoJs_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> å¯ä»¥å‘ç°ä¸šåŠ¡çš„æ­¥éª¤è¿˜æ˜¯æœ‰å¾ˆå¤šæ­¥çš„ï¼Œå› æ­¤æˆ‘ä»¬è¦ä¿è¯æ­¥éª¤çš„åŸå­æ€§ï¼Œå› æ­¤ä¸Šè¿°çš„å†…å®¹åº”å½“ç”¨Luaè„šæœ¬æ¥å†™ã€‚</p> 
<h3><a id="_31"></a>å®ç°</h3> 
<p>éœ€æ±‚ï¼š</p> 
<blockquote> 
 <p>1ã€æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸çš„ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­<br> 2ã€åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ã€å†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ<br> 3ã€è‹¥æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idä¸ç”¨æˆ·idè¿›è¡Œå°è£…ï¼Œå†å­˜å…¥é˜»å¡é˜Ÿåˆ—<br> 4ã€å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•</p> 
</blockquote> 
<p>1ã€åœ¨VoucherServiceImplç±»ä¸­æ–°å¢ä¼˜æƒ åˆ¸ï¼ŒåŒæ—¶ä¿å­˜åˆ°Redisä¸­ï¼š</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addSeckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Voucher</span> voucher<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span>
        <span class="token function">save</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span>
        <span class="token class-name">SeckillVoucher</span> seckillVoucher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeckillVoucher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillVoucher<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillVoucher<span class="token punctuation">.</span><span class="token function">setStock</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillVoucher<span class="token punctuation">.</span><span class="token function">setBeginTime</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillVoucher<span class="token punctuation">.</span><span class="token function">setEndTime</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillVoucherService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­, SECKILL_STOCK_KEY = "seckill:stock:"</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">SECKILL_STOCK_KEY</span> <span class="token operator">+</span> voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>æ‰“å¼€postmanï¼Œè¿›è¡Œæµ‹è¯•ï¼š<br> <img src="https://images2.imgbox.com/10/50/7EkmkGVW_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> æ·»åŠ æˆåŠŸï¼š<br> <img src="https://images2.imgbox.com/a0/9a/5S8wVnUW_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> 2ã€åœ¨resourcesä¸‹åˆ›å»ºseckill.luaï¼Œå†³å®šç”¨æˆ·èƒ½å¦æŠ¢åˆ¸æˆåŠŸï¼š</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 1 å‚æ•°åˆ—è¡¨</span>
<span class="token comment">-- 1.1 ä¼˜æƒ åˆ¸id</span>
<span class="token keyword">local</span> voucherId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- 1.2 ç”¨æˆ·id</span>
<span class="token keyword">local</span> userId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

<span class="token comment">-- 2 æ•°æ®key</span>
<span class="token comment">-- 2.1 åº“å­˜key</span>
<span class="token keyword">local</span> stockKey <span class="token operator">=</span> <span class="token string">'seckill:stock:'</span> <span class="token operator">..</span> voucherId
<span class="token comment">-- 2.2 è®¢å•key</span>
<span class="token keyword">local</span> orderKey <span class="token operator">=</span> <span class="token string">'seckill:order:'</span> <span class="token operator">..</span> voucherId

<span class="token comment">-- 3 è„šæœ¬ä¸šåŠ¡</span>
<span class="token comment">-- 3.1 åˆ¤æ–­åº“å­˜æ˜¯å¤Ÿå……è¶³</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">-- 3.2 åº“å­˜ä¸è¶³ï¼Œè¿”å›1</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token keyword">end</span>
<span class="token comment">--3.2 åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å•ï¼Œå³åˆ¤æ–­ç”¨æˆ·idæ˜¯ä¸æ˜¯è¿™ä¸ªseté›†åˆçš„æˆå‘˜</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'sismember'</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">-- 3.2 å­˜åœ¨ï¼Œè¯´æ˜é‡å¤ä¸‹å•</span>
    <span class="token keyword">return</span> <span class="token number">2</span>
<span class="token keyword">end</span>
<span class="token comment">-- 3.4 æ‰£åº“å­˜</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'incrby'</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">-- 3.5 ä¸‹å•ï¼ˆä¿å­˜ç”¨æˆ·ï¼‰</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'sadd'</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token number">0</span>
</code></pre> 
<p>3ã€åœ¨VoucherOrderServiceImplä¸­ä¿®æ”¹seckillVoucherï¼Œä¿®æ”¹ä¸šåŠ¡ï¼Œå…ˆè°ƒç”¨Luaè„šæœ¬æ‰§è¡Œï¼Œè¿”å›0å³å¯å°†ä¸‹å•ä¿¡æ¯å­˜å…¥é˜»å¡é˜Ÿåˆ—ï¼ˆå­˜å…¥é˜»å¡é˜Ÿåˆ—çš„ä»£ç ç¼–å†™è¾ƒä¸ºéº»çƒ¦ï¼Œæš‚æ—¶æ”¾ç€ï¼‰ï¼š</p> 
<pre><code class="prism language-java">    <span class="token comment">//ç§’æ€ä¼˜åŒ–ï¼Œè°ƒç”¨Luaçš„ä»£ç </span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//è·å–ç”¨æˆ·</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æ‰§è¡ŒLuaè„šæœ¬ï¼Œè¿™é‡Œä½¿ç”¨äº†é™æ€ä»£ç å—</span>
        <span class="token class-name">Long</span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
                <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">,</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰keyä¼ ï¼Œåªéœ€è¦ä¼ é€ä¸€ä¸ªç©ºé›†åˆå³å¯</span>
                voucherId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//ä¼ å…¶ä»–ç±»å‹çš„å‚æ•°</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span>
        <span class="token keyword">int</span> r <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//ä¸ä¸º0ï¼Œæ²¡æœ‰è´­ä¹°èµ„æ ¼</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">"åº“å­˜ä¸è¶³"</span> <span class="token operator">:</span> <span class="token string">"ä¸èƒ½é‡å¤ä¸‹å•"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//ä¸º0ï¼Œæœ‰è´­ä¹°èµ„æ ¼ï¼Œå°†ä¸‹å•ä¿¡æ¯ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//TODO ä¿å­˜é˜»å¡é˜Ÿåˆ—ï¼Œè¿™è¾¹å…ˆç©ºç€ï¼Œä¸‹ä¸€éƒ¨åˆ†å•ç‹¬ç¼–å†™</span>

        <span class="token comment">//è¿”å›è®¢å•id</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>æ‰“å¼€postmanè¿›è¡Œæµ‹è¯•ï¼Œè¿ç»­ä¸‹å•ä¸¤æ¬¡ï¼Œè¯æ˜ä¸‹å•èµ„æ ¼åˆ¤æ–­çš„å¯è¡Œæ€§ï¼š<br> <img src="https://images2.imgbox.com/83/fb/Ek7us6aJ_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> <img src="https://images2.imgbox.com/e8/51/xNA0AA9r_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> <img src="https://images2.imgbox.com/b2/3f/OJ35ZNdl_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> å½“ç„¶æ•°æ®åº“ä¸­çš„æ•°æ®è¿˜æ˜¯æ²¡æœ‰æ”¹å˜çš„ï¼Œ å¼‚æ­¥ä¸‹å•è¿˜æ²¡åšã€‚</p> 
<blockquote> 
 <p>å¦‚æœè¦è¿›è¡Œå‹åŠ›æµ‹è¯•çš„è¯ï¼Œå¤§å®¶è¦è‡ªå·±æ„å»ºå‡ºå‡ ç™¾ä¸ªç”¨æˆ·ï¼Œç„¶åè¿™äº›ç”¨æˆ·åˆ†åˆ«å ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œä¸‹å•ï¼Œç”¨jmeterè¿›è¡Œæµ‹è¯•ï¼Œå®Œæˆè¿™äº›æµ‹è¯•è¿˜æ˜¯å¾ˆç¹ççš„ï¼Œä½†æ˜¯å› ä¸ºè¿™äº›æ“ä½œéƒ½æ˜¯åŸºäºRedisçš„ï¼Œå®¹æ˜“çŸ¥é“ååç‡è‚¯å®šæ˜¯å˜å¤§äº†ä¸å°‘çš„ã€‚</p> 
</blockquote> 
<h2><a id="_132"></a>åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€å¼‚æ­¥ä¸‹å•</h2> 
<p>å¯¹äºç”¨æˆ·èµ„æ ¼çš„åˆ¤æ–­å·²ç»å®Œæˆäº†ï¼Œå‡è®¾ç”¨æˆ·å…·æœ‰ç§’æ€çš„èµ„æ ¼ï¼Œè¿™æ—¶å€™æˆ‘ä»¬åªéœ€è¦ç‹¬ç«‹å¼€è¾Ÿä¸€ä¸ªçº¿ç¨‹ï¼Œå»å¼‚æ­¥å®ç°ä¸‹å•ã€‚å› ä¸ºç”¨æˆ·åªè¦å…·æœ‰è¿™ä¸ªèµ„æ ¼ï¼Œç›´æ¥è¿”å›è®¢å•çš„idä»è€Œè®©ç”¨æˆ·å»æ‰§è¡Œä»˜æ¬¾å³å¯ï¼Œè€Œå°†è®¢å•çš„ä¿¡æ¯å­˜å…¥æ•°æ®åº“å¹¶ä¸éœ€è¦ä¸¥æ ¼çš„æ—¶æ•ˆæ€§ï¼Œå› æ­¤ä¸šåŠ¡å¯è¡Œï¼š<br> <img src="https://images2.imgbox.com/c0/36/14erE7uu_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> æ¥ä¸‹æ¥ï¼Œå¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°ä¸‹å•ï¼Œè¿™æ˜¯æ•´ä½“æ€§èƒ½å˜é«˜çš„å…³é”®ã€‚<br> ä»£ç çš„å®ç°ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥é€‰æ‹©é˜»å¡é˜Ÿåˆ—ï¼Œæ˜¯å› ä¸ºé˜»å¡é˜Ÿåˆ—å…·æœ‰ä¸€ä¸ªé‡è¦çš„æ€§è´¨ï¼šå½“çº¿ç¨‹å°è¯•è·å–é˜»å¡é˜Ÿåˆ—çš„å…ƒç´ æ—¶ï¼Œè‹¥é˜Ÿåˆ—ä¸­æ²¡æœ‰å…ƒç´ ï¼Œè¯¥çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­è·å–åˆ°è¿™ä¸ªå…ƒç´ äº†ã€‚<br> å¦å¤–ä»£ç ä¸­å› ä¸ºæ¶‰åŠäº†å¼€è¾Ÿç‹¬ç«‹çº¿ç¨‹å»å®ç°å¼‚æ­¥ä¸‹å•ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å‡†å¤‡å¥½çº¿ç¨‹æ± ä¸çº¿ç¨‹ä»»åŠ¡ã€‚<br> æœ€ç»ˆä¸šåŠ¡çš„å…¨éƒ¨ä»£ç å®ç°å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrderMapper</span><span class="token punctuation">,</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IVoucherOrderService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//æ³¨å…¥ç§’æ€ä¼˜æƒ åˆ¸çš„service</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> redisIdWorker<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
        <span class="token constant">SECKILL_SCRIPT</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"seckill.lua"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®è„šæœ¬ä½ç½®</span>
        <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é…ç½®è¿”å›å€¼</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//é˜»å¡é˜Ÿåˆ—ï¼šå½“çº¿ç¨‹å°è¯•ä»è¿™ä¸ªé˜Ÿåˆ—ä¸­è·å–å…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰å…ƒç´ ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­è·å–åˆ°å…ƒç´ </span>
    <span class="token keyword">private</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> orderTasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//çº¿ç¨‹æ± </span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> <span class="token constant">SECKILL_ORDER_EXECUTOR</span> <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//çº¿ç¨‹ä»»åŠ¡ï¼Œç”¨æˆ·éšæ—¶éƒ½èƒ½æŠ¢å•ï¼Œæ‰€ä»¥åº”è¯¥è¦åœ¨è¿™ä¸ªç±»è¢«åˆå§‹åŒ–çš„æ—¶å€™é©¬ä¸Šå¼€å§‹æ‰§è¡Œ</span>
    <span class="token annotation punctuation">@PostConstruct</span>  <span class="token comment">//è¯¥æ³¨è§£è¡¨ç¤ºåœ¨å½“å‰ç±»åˆå§‹åŒ–å®Œæ¯•ä»¥åç«‹å³æ‰§è¡Œ</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token constant">SECKILL_ORDER_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoucherOrderHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{<!-- --></span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//ä¸æ–­ä»é˜Ÿåˆ—ä¸­å–è®¢å•ä¿¡æ¯</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> orderTasks<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//åˆ›å»ºè®¢å•ï¼Œæµç¨‹é‡Œé¢æ— é¡»å†åŠ é”ï¼ŒåŠ ä¸ªé”å°±æ˜¯åšä¸ªå…œåº•</span>
                    <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//e.printStackTrace();</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"åˆ›å»ºè®¢å•å¼‚å¸¸"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">IVoucherOrderService</span> proxy<span class="token punctuation">;</span>

    <span class="token comment">//ç§’æ€ä¼˜åŒ–ï¼Œè°ƒç”¨Luaçš„ä»£ç </span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//è·å–ç”¨æˆ·</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æ‰§è¡ŒLuaè„šæœ¬ï¼Œè¿™é‡Œä½¿ç”¨äº†é™æ€ä»£ç å—</span>
        <span class="token class-name">Long</span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
                <span class="token constant">SECKILL_SCRIPT</span><span class="token punctuation">,</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰keyä¼ ï¼Œåªéœ€è¦ä¼ é€ä¸€ä¸ªç©ºé›†åˆå³å¯</span>
                voucherId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//ä¼ å…¶ä»–ç±»å‹çš„å‚æ•°</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span>
        <span class="token keyword">int</span> r <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//ä¸ä¸º0ï¼Œæ²¡æœ‰è´­ä¹°èµ„æ ¼</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">"åº“å­˜ä¸è¶³"</span> <span class="token operator">:</span> <span class="token string">"ä¸èƒ½é‡å¤ä¸‹å•"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//ä¸º0ï¼Œæœ‰è´­ä¹°èµ„æ ¼ï¼Œå°†ä¸‹å•ä¿¡æ¯ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//TODO ä¿å­˜é˜»å¡é˜Ÿåˆ—</span>
        <span class="token comment">//å…ˆå°†ç”¨æˆ·idä¸è®¢å•idå°è£…èµ·æ¥</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æ”¾å…¥é˜»å¡é˜Ÿåˆ—</span>
        orderTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è·å–ä»£ç†å¯¹è±¡</span>
        proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//è¿”å›è®¢å•id</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> voucherOrder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//è·å–ç”¨æˆ·ï¼Œç”¨æˆ·idä¸èƒ½å†ä»UserHolderä¸­å–äº†ï¼Œå› ä¸ºç°åœ¨æ˜¯ä»çº¿ç¨‹æ± è·å–çš„å…¨æ–°çº¿ç¨‹ï¼Œä¸æ˜¯ä¸»çº¿ç¨‹</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆ›å»ºé”å¯¹è±¡</span>
        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">"lock:order:"</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è·å–é”</span>
        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"ä¸å…è®¸é‡å¤ä¸‹å•"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç†è®ºä¸Šä¸ä¼šå‘ç”Ÿ</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//è¿™æ˜¯ä¸»çº¿ç¨‹çš„ä¸€ä¸ªå­çº¿ç¨‹ï¼Œæ— æ³•ç›´æ¥è·å¾—ä»£ç†å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡éœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸­è·å–ï¼Œå¹¶è®¾ç½®æˆæˆå‘˜å˜é‡ä½¿å¾—è¯¥å­çº¿ç¨‹èƒ½å¤Ÿè·å–</span>
            <span class="token comment">//createVoucherOrderçš„æ–¹æ³•ä½“ç›´æ¥ä¿®æ”¹ï¼Œä¸å†éœ€è¦é‡æ–°æ ¹æ®idåˆ›å»ºè®¢å•ï¼Œè€Œæ˜¯ç›´æ¥å°†è®¢å•ä¼ è¿›å»</span>
            proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> voucherOrder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æŸ¥è¯¢è®¢å•</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getVoucherId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"ä¸å¯é‡å¤è´­ä¹°"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//æ‰£å‡åº“å­˜</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"stock = stock - 1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getVoucherId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">"stock"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"åº“å­˜ä¸è¶³"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//ä¸éœ€è¦å†åˆ›å»ºè®¢å•ï¼Œç›´æ¥save</span>
        <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2><a id="_277"></a>æ€»ç»“åŠå‘ç°é—®é¢˜</h2> 
<p>1ã€ç§’æ€ä¸šåŠ¡çš„ä¼˜åŒ–æ€è·¯</p> 
<blockquote> 
 <p>ï¼ˆ1ï¼‰å…ˆç”¨Rediså®Œæˆåº“å­˜é‡ä»¥åŠä¸€äººä¸€å•åˆ¤æ–­ï¼Œå®ŒæˆæŠ¢å•<br> ï¼ˆ2ï¼‰ä¸‹å•çš„ä¸šåŠ¡ï¼ˆæ“ä½œæ•°æ®åº“çš„ä¸šåŠ¡ï¼‰æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¹¶ç”¨ç‹¬ç«‹çº¿ç¨‹å®Œæˆå¼‚æ­¥ä¸‹å•</p> 
</blockquote> 
<p>2ã€åŸºäºé˜»å¡é˜Ÿåˆ—çš„å¼‚æ­¥ç§’æ€å­˜åœ¨çš„é—®é¢˜</p> 
<blockquote> 
 <p>ï¼ˆ1ï¼‰å†…å­˜é™åˆ¶é—®é¢˜ï¼šæˆ‘ä»¬ä½¿ç”¨äº†JDKçš„é˜»å¡é˜Ÿåˆ—ï¼Œå ç”¨çš„æ˜¯JVMå†…å­˜ï¼Œè‹¥ä¸åŠ ä»¥é™åˆ¶ï¼Œä¼šæœ‰å¾ˆå¤šçš„è®¢å•å¯¹è±¡åˆ›å»ºçº¿ç¨‹å¹¶ä¸”å°†å¤§é‡ä¿¡æ¯æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¯èƒ½ä¼šå†…å­˜æº¢å‡º<br> ï¼ˆ2ï¼‰æ•°æ®å®‰å…¨é—®é¢˜ï¼šè¦ç”¨äºä¸‹å•çš„ä¸šåŠ¡ä¿¡æ¯éƒ½å­˜åˆ°äº†å†…å­˜ä¸­ï¼Œä¸‡ä¸€æœåŠ¡å®•æœºï¼Œé‚£ä¹ˆç”¨æˆ·å®Œæˆäº†æŠ¢å•ï¼Œä½†æ˜¯æ•°æ®åº“å´æ²¡æœ‰åšå‡ºç›¸åº”çš„ä¿®æ”¹ï¼Œå°†ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´</p> 
</blockquote> 
<p>è§£å†³çš„æ–¹æ³•å°†åœ¨ä¸‹ä¸€èŠ‚è¿›è¡Œåˆ†æ</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/08e1ec75e9b22afc71d4d45c20976827/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">Spring MVC çš„controlleræ–¹æ³•è¿”å›å€¼</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/65a2e5c0e23d2144bf9dbe102d74b330/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">Cè¯­è¨€ç»ƒä¹ â€”â€”ä¸‰å­æ£‹</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>