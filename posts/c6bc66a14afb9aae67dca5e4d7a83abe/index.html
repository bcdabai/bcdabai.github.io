<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Delphi 的RTTI机制浅探 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Delphi 的RTTI机制浅探" />
<meta property="og:description" content="====================================================== 注：本文源代码点此下载 ====================================================== 目 录
===============================================================================
⊙ dfm 文件与持续机制(persistent)
⊙ readcomponentresfile / writecomponentresfile 函数
⊙ delphi 持续机制框架简述
⊙ 一个 tform 对象的创建过程
⊙ tstream class 和 tstream.readcomponent 方法
⊙ treader class 和 treader.readrootcomponent 方法
⊙ treader.readprefix 方法
⊙ tcomponent.readstate 虚方法
⊙ treader.readdata 方法
⊙ treader.readdatainner 方法
⊙ treader.readproperty 方法
⊙ tpersistent.defineproperties 虚方法
⊙ treader.readcomponent 方法
⊙ treader.readvalue / treader.nextvalue 系列方法
⊙ treader.readstr 方法
⊙ treader.readinteger / readstring / readboolean 系列方法" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c6bc66a14afb9aae67dca5e4d7a83abe/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2012-02-01T07:23:29+08:00" />
<meta property="article:modified_time" content="2012-02-01T07:23:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Delphi 的RTTI机制浅探</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <br> ====================================================== 
<br> 
<b>注：本文源代码<u><a href="http://www.51zxw.net/study.asp?vip=1447215" rel="nofollow">点此下载</a></u></b> 
<br> ====================================================== 
<br> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">目 录</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ dfm 文件与持续机制(persistent)</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ readcomponentresfile / writecomponentresfile 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ delphi 持续机制框架简述</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ 一个 tform 对象的创建过程</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ tstream class 和 tstream.readcomponent 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader class 和 treader.readrootcomponent 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readprefix 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ tcomponent.readstate 虚方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readdata 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readdatainner 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readproperty 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ tpersistent.defineproperties 虚方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readcomponent 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readvalue / treader.nextvalue 系列方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readstr 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readinteger / readstring / readboolean 系列方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.read 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ objectbinarytotext / objecttexttobinary 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">本文排版格式为:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">正文由窗口自动换行;所有代码以 80 字符为边界;中英文字符以空格符分隔。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">(作者保留对本文的所有权利,未经作者同意请勿在在任何公共媒体转载。)</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">正 文</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ dfm 文件与持续机制(persistent)</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">我们在使用 delphi 的 ide 进行快速开发的时候,可以方便地从元件面板上拖放元件(component)至表单,完成表单的界面和事件设计。delphi 将这些界面的设计期信息保存在表单相应的 dfm 文件中,方便程序员随时读取和修改。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">dfm 文件根据元件在表单上的嵌套层次存放元件属性,以下是一个 dfm 文件的示例:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">object form1: tform1</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">...</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">left = 192</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">top = 107</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">width = 544</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">caption = 'form1'</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">object button1: tbutton</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">left = 24</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">top = 16</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">caption = 'button1'</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">onclick = button1click</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">...</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">应用程序编译之后,dfm 文件的信息被二进制化了,这些二进制信息存储在应用程序的资源(resource)段中。每个表单(也就是 class)及表单上的元件在资源段中存储为与表单同名的资源,可以使用 findresource api 获得。应用程序在运行期创建表单实例的时候,会从资源段中读取表单的属性,还原设计期的设置。这种将类型信息保存在文件中,并且可以在运行期恢复类型的操作,在本文中被称之为持续(persistent)机制。持续机制是 delphi 成为 rad 工具的原因之一。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">持续机制和 rtti 是紧密结合的,但本文不讨论 rtti(关于 rtti 可参考我前几天写的两篇笔记),只讨论实现持续机制的总体框架及相关类(class)。这些类包括 tstream、tfiler、treader、twriter、tparser、tpersisetent、tcomponent、tcustomform 等。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ readcomponentresfile / writecomponentresfile 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">让我们从一个比较直观的例子开始。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">classes.pas 中定义了两个函数 readcomponentresfile 和 writecomponentresfile,它们的功能是“把元件的属性信息保存到文件”和“从文件中恢复元件属性信息”。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">先做个试验。新建一个项目,在 form1 上放置两个 button 和一个 memo。button 的 click 事件代码如下。按 f9 运行该项目,先在 memo1 中输入一些字符,然后按下 button1,再按下 button2,你会看一个新建的 form。它的属性几乎和 form1 一样,甚至连 memo1 中的字符都保存下来了,唯一的不同只是它的 name 属性变成了“form1_1”。你可以查看 form1.res 文件的内容看看 delphi 是如何存储元件信息的。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure tform1.button1click(sender: tobject);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">writecomponentresfile('c:\form1.res', form1);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure tform1.button2click(sender: tobject);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">var</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">newform: tform1;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">newform := tform1.createnew(application);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readcomponentresfile('c:\form1.res', newform);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">newform.left := newform.left + 100;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">writecomponentresfile 函数的代码如下,它只是调用 stream 对象的 writecomponentres 方法将对象属性保存到资源文件中的:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure writecomponentresfile(const filename: string; instance: tcomponent);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">stream := tfilestream.create(filename, fmcreate);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">stream.writecomponentres(instance.classname, instance);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">stream.free;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readcomponentresfile 函数也是调用 stream 的方法实现从文件中读取对属信息:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readcomponentresfile(const filename: string; instance: tcomponent):</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tcomponent;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">stream := tfilestream.create(filename, fmopenread or fmsharedenywrite);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">result := stream.readcomponentres(instance);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">stream.free;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readcomponentresfile 函数可以通过 instance 参数传入对象句柄,也可以通过返回值获得对象句柄。instance 参数只能是已实例化的对象或 nil。如果是 nil,那么 readcomponentresfile 会自动根据文件信息创建对象实例,但必须使用 registerclass 函数注册将要被载入的类,否则会触发异常。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">有个类似的函数 readcomponentres,它从应用程序的资源段中恢复对象的属性信息。它的 resname 参数就是表单类的名称:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readcomponentres(const resname: string; instance: tcomponent):</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tcomponent;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ delphi 持续机制框架简述</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">持续机制的实现必须由 ide、编译器、表单类、元件类和辅助类合作完成。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">这里的表单类不是指一般所指的 tform class,在 delphi 的帮助文件中,称之为“root class”。root class 是指能在设计期被 form designer 作为最上层编辑表单的类(如 tcustomform、tframe、tdatamodule 等)。delphi 在设计期将元件的 published 属性的值保存在 .dfm 文件中,也只有 published 的属性才能被 object insepector 设置赋值。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">form designer 设计的 root class 对象在编译时,delphi 将对象的属性以及其所包含的元件的属性保存在应用程序的资源段(rt_rcdata)中。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">辅助类包括 tstream、treader、twriter、tparser 等。这些类起着中间层的作用,用于存储和读取对象属性的信息。虽然我称它们为辅助类,但是保存和恢复对象信息的实际操作是由它们完成的。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ 一个 tform 对象的创建过程</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">下面是一个典型的表单 form1 的创建过程,缩进代表调用关系(form1.readstate 例外,防止缩进太多),带“?”的函数表示我尚未仔细考察的部分,带“*”表示元件编写者需要注意的函数。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">application.createform(tform1, form1);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-form1.newinstance;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-form1.create(application);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-form1.createnew(application);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-initinheritedcomponent(form1, tform);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-internalreadcomponentres(form1.classname, form1reshinst, form1);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-tresourcestream.create(form1reshinst, form1.classname, rt_rcdata);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-tresourcestream.readcomponent(form1);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-treader.create(resourcestream, 4096);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-treader.readrootcomponent(form1);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-treader.readsignature;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">*|-treader.readprefix(flags, childpos);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-if form1 = nil then form1 := findclass(readstr).create;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-include(form1.fcomponentstate, csloading);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-include(form1.fcomponentstate, csreading);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-form1.name := finduniquename(readstr);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">?|-ffinder := tclassfinder.create;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">*|-form1.readstate(reader);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-tcustomform.readstate(reader);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ disablealign; }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-twincontrol.readstate(reader);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ disablealign; }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">*|-tcontrol.readstate(reader);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ include(fcontrolstate, csreadingstate); }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ parent := twincontrol(reader.parent);}</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">*|-tcomponent.readstate(reader);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-reader.readdata(form1);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-reader.readdatainner(form1);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-while not endoflist do reader.readproperty(form1);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">|-if propinfotreader.readdata -&gt; readdatainner -&gt; treader.readproperty,重复 readrootcomponent 的过程。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">treader.readcomponent 和 tcomponent.readstate 形成递归调用过程,把表单上嵌套的元件创建出来。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">最后 initinheritedcomponent 函数返回,一个 root class 对象从资源中实例化的过程完成。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ tstream class 和 tstream.readcomponent 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tstream 在对象持续机制扮演的角色是提供一种存储媒介,由 tfiler 对象使用。tstream 是一个虚类,它定义了数据的“流式”读写方法。它的继承类 tfilestream、tmemorystream、tresourcestream 等实现对不同媒体的读写。对象的 persistent 信息可以存储在任何 tstream 类中,也可以从任何 tstream 中获得。由于 delphi 缺省的对象信息存储在应用程序的资源段中,因此,可以从程序的资源段中读取数据的 tresourcestream 类就显得更加重要。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tstream 定义两个读写缓冲的方法:readbuffer 和 writebuffer。这两个方法封装了 tstream.read 和 tstream.write 纯虚方法(必须被后继类重载)。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ tstream }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure readbuffer(var buffer; count: longint);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure writebuffer(const buffer; count: longint);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">可以看到这两个方法的 buffer 参数都是无类型的,也就是使用引用的方式传入的,所以不管是使用单个字符或自定义的结构都是正确的(当然,不能使用常量)。count 指示要读或写入的 buffer 的大小(bytes)。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tstream 还定义了两个元件信息的读写方法:readcomponent 和 writecomponent。由于 writecomponent 通常是由 delphi 的 ide/编译器调用的,很难跟踪它的执行过程,所以我们以后主要考察 readcomponent 方法。我们可以很容易想像这两个方法互为逆过程,理解了其中一个也就能知道另一个所做的工作。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ tstream }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readcomponent(instance: tcomponent): tcomponent;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure writecomponent(instance: tcomponent);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tstream.readcomponent 创建了一个 treader 对象,将自己的对象地址作为参数传递给 reader,并调用 reader.readrootcomponent 创建对象实例。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function tstream.readcomponent(instance: tcomponent): tcomponent;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">var</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">reader: treader;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">reader := treader.create(self, 4096);// 4096 是缓冲区大小</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">result := reader.readrootcomponent(instance);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">reader.free;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tstream 把自己的对象句柄交给 treader 之后,就成了 treader 读取对象属性资料的来源。此后 tstream 对象只由 treader 来掌控,自己不再主动进行其它工作。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader class 和 treader.readrootcomponent 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">treader 和 twriter 都是从 tfiler 继承下来的类。tfiler 是个纯虚类,它的构造函数被 treader 和 twrite 共享。tfiler.create 先把 stream 参数保存在 fstream 字段中,然后生成一个自己的缓冲区:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">constructor tfiler.create(stream: tstream; bufsize: integer);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">fstream := stream;// 保存 stream 对象</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getmem(fbuffer, bufsize);// 创建自己的缓冲区,加速数据访问</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">fbufsize := bufsize;// 设置缓冲区大小</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">上面说到 tstream.readcomponent 在创建 treader 对象之后,立即调用 treader.readrootcomponent 方法。treader.readrootcomponent 方法的功能是从 stream 中读取 root class 对象的属性。并返回该对象的指针。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ treader }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readrootcomponent(root: tcomponent): tcomponent;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readrootcomponent 先调用 treader.readsignature。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">treader.readsignature 方法从 stream 中读取 4 字节的内容,如果读出来的内容不是 'tpf0',则触发异常(sinvalidimage),表示该 stream 的内容是错误的。'tpf0' 就是 root class 对象的标记。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">然后 readrootcomponent 调用 readprefix 读取元件的继承信息。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">如果 root 参数是 nil,也就是说 root 对象还没被创建,则直接从流中读取 root 的类名,再使用 findclass 函数找到该类在内存中的地址,并调用该类的构造函数创建 root 的实例。如果 root 实例已存在,则调用内嵌的 finduniquname 函数检查 root.name 是否与已有的实例重复,如有重复则在 root.name 后加上序号使其唯一。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">接下来 readrootcomponent 调用 root 的 readstate 虚方法从流中读取 root 对象的属性。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readprefix 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readprefix 方法用于读取元件的状态信息,这些信息是由 writer 在写入元件属性之前写入的。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ treader }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure readprefix(var flags: tfilerflags; var achildpos: integer); virtual;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">flags 参数是以引用方式传递的,用于设置元件的在表单中的状态,元件的状态在这里包含三种情况:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ffinherited:表示元件存在于表单的父类之中</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ffchildpos :表示元件在表单中的创建次序(creation order)是重要的</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ffinline:表示元件是最上级(top-level)的元件,比如表单或数据模块</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">如果元件的状态中包含 ffchildpos,readprefix 还会读取元件的创建次序值,存放在 achildpos 参数中。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ tcomponent.readstate 虚方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">设置 readstate 方法的主要目的是在读取属性信息的前后可以让元件进行一些处理工作。readstate 是 component writer 需要注意的方法。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ tcomponent }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure readstate(reader: treader); virtual;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">由于 readstate 是虚函数,在 tcontrol、twincontrol、tcustomform 等后续类中都被重载,进行自己需要的操作(比如 disablealign、updatecontrolstate)。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tcomponent.readstate 只有一行代码:reader.readdata(self);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">注意:自己重载 readstate 方法必须调用 inherited 。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readdata 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">上面说到 tcomponent.readstate 又回头调用 treader.readdata 方法。它的主要代码如下:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ treader }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure treader.readdata(instance: tcomponent);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">...</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readdatainner(instance);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">dofixupreferences;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">...</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">treader.readdata 基本上是个包装函数,它调用 treader.readdatainner 读取 root 对象及 root 所包含的元件的属性信息。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readdatainner 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readdatainner 负责读取元件的属性和子元件的属性,它的主要代码如下:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure treader.readdatainner(instance: tcomponent);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">...</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">while not endoflist do readproperty(instance);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">...</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">while not endoflist do readcomponent(nil);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">...</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readdatainner 先循环调用 readproperty 从流中读取对象的属性,直到遇到 endoflist 标志(vanull)。再循环调用 readcomponent(nil) 读取子元件的信息。这两个方法都是 treader 的重要方法,后面分两节讨论。readdatainner 在readproperty 调用之后还设置了元件的 parent 和 owner 关系。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readproperty 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readproperty 使用 rtti 函数将从流中读出的数据设置为对象的属性。它先解析从流中读出的属性名称,然后判断该属性是否有 rtti 信息,如果有则调用 treader.readpropvalue 方法从流中读取属性值;如果该属性没有 rtti 信息,说明该属性不属于 published 段,而是由元件自己写入的,因此调用 tpersistent.defineproperties 读取自定义的元件信息。readproperty 的关键代码:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure treader.readproperty(ainstance: tpersistent);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">...</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">propinfo := getpropinfo(instance.classinfo, fpropname);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">if propinfo'' then propertyerror(fpropname); // 注意这里</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">...</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readpropvalue 方法基本上是使用 setordprop、setfloatprop、setstrprop、getenumvalue 等 rtti 函数设置元件的属性值,它的代码冗长而简单,不再单独列出。下面介绍比较重要的 defineproperties 函数。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ tpersistent.defineproperties 虚方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">defineproperties 虚方法用于元件设计者自定义非 published 属性的存储和读取方法。 tpersistent 定义的该方法是个空方法,到 tcomponent 之后被重载。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure tpersistent.defineproperties(filer: tfiler); virtual;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">下面以 tcomponent 为例说明该方法的用法:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure tcomponent.defineproperties(filer: tfiler);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">var</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ancestor: tcomponent;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">info: longint;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">info := 0;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ancestor := tcomponent(filer.ancestor);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">if ancestorlongrec(info).lo);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">filer.defineproperty('top', readtop, writetop,</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">longrec(fdesigninfo).hitreader.readdata -&gt; readdatainner -&gt; treader.readproperty,重复 readrootcomponent 的过程。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ treader }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readcomponent(component: tcomponent): tcomponent;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">treader.readcomponent 和 tcomponent.readstate 形成递归调用过程,把表单上嵌套的元件创建出来。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readvalue / treader.nextvalue 系列方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readvalue 方法从流中读出一个 tvaluetype 类型的数据,它主要由其它的方法调用。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tvaluetype 中只有 valist 比较特殊,它表示后面的数据是一个属性值系列,以 vanull 结束。其余的枚举值的都是指属性的数据类型或值。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tvaluetype = (vanull, valist, vaint8, vaint16, vaint32, vaextended,</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">vastring, vaident, vafalse, vatrue, vabinary, vaset, valstring,</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">vanil, vacollection, vasingle, vacurrency, vadate, vawstring,</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">vaint64, vautf8string);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function treader.readvalue: tvaluetype;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">read(result, sizeof(result));</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">nextvalue 方法调用 readvalue 返回流中下一个数据的类型,然后将流指针回退至读数据之前。通常用于检测流中下一个数据的类型。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function treader.nextvalue: tvaluetype;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">result := readvalue;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">dec(fbufpos);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">checkvalue 方法调用 readvalue 检查下一个数据类型是否是指定的类型,如果不是则触发异常。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readlistbegin 方法检查下一个数据是否是 valist,它调用 checkvalue 方法。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readlistend 方法检查下一个数据是否是 vanull,它调用 checkvalue 方法。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">skipvalue 方法使用 readvalue 获得下一个数据的类型,然后将流指针跳过这个数据。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readstr 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">readstr 方法读出流中的短字符串,treader 内部使用它读取属性名称等字符串,元件设计者应该使用 readstring 函数读取属性值。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readstr: string;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.readinteger / readstring / readboolean 系列方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">treader 有一系列读取属性值的函数,可供元件设计者使用。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readinteger: longint;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readint64: int64;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readboolean: boolean;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readchar: char;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure readcollection(collection: tcollection);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readfloat: extended;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readsingle: single;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readcurrency: currency;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readdate: tdatetime;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readident: string;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readstring: string;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readwidestring: widestring;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function readvariant: variant;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ treader.read 方法</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">treader 中所有的数据都是通过 treader.read 方法读取的。treader 不直接调用 tstream 的读方法是因为 treader 的读数据操作很频繁,它自己建立了一个缓冲区(4k),只有当缓冲区中的数据读完之后才会调用 tstream.read 再读入下一段数据,这样可以极大地加快读取速度。read 是个汇编函数,编写得很巧妙,它的代码及注释如下:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure treader.read(var buf; count: longint); assembler;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">asm</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">pushesi</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">pushedi</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">pushebx</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">movedi,edx; edifbufpos jmp @@2</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ja@@2</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">moveax,esi; else eaxnil) and child.inheritsfrom(parent);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">_isclass 很简单,它使用 tobject 的 inheritsform 函数判断该对象是否是从某个类或它的父类中继承下来的。每个类的 vmt 中都有一项 vmtparent 指针,指向该类的父类的 vmt。tobject.inheritsfrom 实际上是通过[递归]判断父类 vmt 指针是否等于自己的 vmt 指针来判断是否是从该类继承的。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ system.pas }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">class function tobject.inheritsfrom(aclass: tclass): boolean;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">var</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">classptr: tclass;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">classptr := self;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">while (classptraclass) do</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">classptr := ppointer(integer(classptr) + vmtparent)^;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">result := classptr = aclass;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">as 操作符实际上是由 system.pas 中的 _asclass 函数完成的。它简单地调用 is 操作符判断对象是否属于某个类,如果不是就触发异常。虽然 _asclass 返回值为 tobject 类型,但编译器会自动把返回的对象改变为 parent 类,否则返回的对象没有办法使用 tobject 之外的方法和数据。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ system.pas }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function _asclass(child: tobject; parent: tclass): tobject;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">result := child;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">if not (child is parent) then</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">error(reinvalidcast);// loses return address</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ ttypeinfo – rtti 信息的结构</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">rtti 信息的结构定义在 typinfo.pas 中:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ttypeinfo = record// ttypeinfo 是 rtti 信息的结构</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">kind: ttypekind;// rtti 信息的数据类型</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">name: shortstring;// 数据类型的名称</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{typedata: ttypedata}// rtti 的内容</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ttypeinfo 就是 rtti 信息的结构。tobject.classinfo 返回指向存放 class ttypeinfo 信息的指针。kind 是枚举类型,它表示 rtti 结构中所包含数据类型。name 是数据类型的名称。注意,最后一个字段 typedata 被注释掉了,这说明该处的结构内容根据不同的数据类型有所不同。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ttypekind 枚举定义了可以使用 rtti 信息的数据类型,它几乎包含了所有的 delphi 数据类型,其中包括 tkclass。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ttypekind = (tkunknown, tkinteger, tkchar, tkenumeration, tkfloat,</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tkstring, tkset, tkclass, tkmethod, tkwchar, tklstring, tkwstring,</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tkvariant, tkarray, tkrecord, tkinterface, tkint64, tkdynarray);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ttypedata 是个巨大的记录类型,在此不再列出,后文会根据需要列出该记录的内容。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ 获取类(class)的属性(property)信息</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">这一段是 rtti 中最复杂的部分,努力把本段吃透,后面的内容都是非常简单的。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">下面是一个获取类的属性的例子:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure getclassproperties(aclass: tclass; astrings: tstrings);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">var</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">propcount, i: smallint;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">proplist: pproplist;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">propstr: string;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">propcount := gettypedata(aclass.classinfo).propcount;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getproplist(aclass.classinfo, proplist);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">for i := 0 to propcount - 1 do</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">case proplist[i]^.proptype^.kind of</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tkclass: propstr := '[class] ';</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tkmethod: propstr := '[method]';</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tkset: propstr := '[set]';</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tkenumeration: propstr := '[enum]';</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">else</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">propstr := '[field] ';</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">propstr := propstr + proplist[i]^.name;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">propstr := propstr + ': ' + proplist[i]^.proptype^.name;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">astrings.add(propstr);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">freemem(proplist);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">你可以在表单上放置一个 tlistbox ,然后执行以下语句观察执行结果:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getclassproperties(tform1, listbox1.items);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">该函数先使用 gettypedata 函数获得类的属性数量。gettypedata 是 typinfo.pas 中的一个函数,它的功能是返回 ttypeinfo 的 typedata 数据的指针:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ typinfo.pas }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function gettypedata(typeinfo: ptypeinfo): ptypedata; assembler;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">class 的 ttypedata 结构如下:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ttypedata = packed record</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">case ttypekind of</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tkclass: (</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">classtype: tclass;// 类 (vmtptr)</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">parentinfo: pptypeinfo;// 父类的 rtti 指针</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">propcount: smallint;// 属性数量</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">unitname: shortstringbase; // 单元的名称</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{propdata: tpropdata});// 属性的详细信息</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">其中的 propdata 又是一个大小可变的字段。tpropdata 的定义如下:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tpropdata = packed record</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">propcount: word;// 属性数量</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">proplist: record end;// 占位符,真正的意义在下一行</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{proplist: array[1..propcount] of tpropinfo}</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">每个属性信息在内存中的结构就是 tpropinfo,它的定义如下:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ppropinfo = ^tpropinfo;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tpropinfo = packed record</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">proptype: pptypeinfo;// 属性类型信息指针的指针</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getproc: pointer;// 属性的 get 方法指针</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">setproc: pointer;// 属性的 set 方法指针</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">storedproc: pointer;// 属性的 storedproc 指针</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">index: integer;// 属性的 index 值</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">default: longint;// 属性的 default 值</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">nameindex: smallint;// 属性的名称索引(以 0 开始计数)</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">name: shortstring;// 属性的名称</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">为了方便访问属性信息,typinfo.pas 中还定义了指向 tpropinfo 数组的指针:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">pproplist = ^tproplist;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tproplist = array[0..16379] of ppropinfo;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">我们可以使用 getproplist 获得所有属性信息的指针数组,数组用完以后要记得用 freemem 把数组的内存清除。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ typinfo.pas }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getproplist(typeinfo: ptypeinfo; out proplist: pproplist): integer;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getproplist 传入类的 ttypeinfo 指针和 tproplist 的指针,它为 proplist 分配一块内存后把该内存填充为指向 tpropinfo 的指针数组,最后返回属性的数量。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">上面的例子演示了如何获得类的所有属性信息,也可以根据属性的名称单独获得属性信息:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ typinfo.pas }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getpropinfo(typeinfo: ptypeinfo; const propname: string): ppropinfo;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getpropinfo 根据类的 rtti 指针和属性的名称字符串,返回属性的信息 tpropinfo 的指针。如果没有找到该属性,则返回 nil。getpropinfo 很容易使用,举个例子:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">showmessage(getpropinfo(tform, 'name')^.proptype^.name);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">这句调用显示了 tform 类的 name 属性的类型名称:tcomponentname。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ 获取方法(method)的类型信息</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">所谓方法就是以 of object 关键字声明的函数指针,下面的函数可以显示一个方法的类型信息:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure getmethodtypeinfo(atypeinfo: ptypeinfo; astrings: tstrings);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">type</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">pparamdata = ^tparamdata;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tparamdata = record// 函数参数的数据结构</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">flags: tparamflags;// 参数传递规则</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">paramname: shortstring; // 参数的名称</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">typename: shortstring;// 参数的类型名称</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getparamflagsname(aparamflags: tparamflags): string;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">var</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">i: integer;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">result := '';</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">for i := integer(pfvar) to integer(pfout) do begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">if i = integer(pfaddress) then continue;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">if tparamflag(i) in aparamflags then</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">result := result + ' ' + getenumname(typeinfo(tparamflag), i);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">var</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">methodtypedata: ptypedata;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">paramdata: pparamdata;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">typestr: pshortstring;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">i: integer;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">methodtypedata := gettypedata(atypeinfo);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">astrings.add('---------------------------------');</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">astrings.add('method name: ' + atypeinfo^.name);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">astrings.add('method kind: ' + getenumname(typeinfo(tmethodkind),</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">integer(methodtypedata^.methodkind)));</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">astrings.add('params count: '+ inttostr(methodtypedata^.paramcount));</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">astrings.add('params list:');</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">paramdata := pparamdata(@methodtypedata^.paramlist);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">for i := 1 to methodtypedata^.paramcount do</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">typestr := pointer(integer(@paramdata^.paramname) +</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">length(paramdata^.paramname) + 1);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">astrings.add(format('[%s] %s: %s',[getparamflagsname(paramdata^.flags),</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">paramdata^.paramname, typestr^]));</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">paramdata := pparamdata(integer(paramdata) + sizeof(tparamflags) +</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">length(paramdata^.paramname) + length(typestr^) + 2);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">if methodtypedata^.methodkind = mkfunction then</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">astrings.add('result value: ' + pshortstring(paramdata)^);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">作为实验,在表单上放置一个 tlistbox,然后执行以下代码,观察执行结果:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">type</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tmymethod = function(a: array of char; var b: tobject): integer of object;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure tform1.formcreate(sender: tobject);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getmethodtypeinfo(typeinfo(tmymethod), listbox1.items);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getmethodtypeinfo(typeinfo(tmouseevent), listbox1.items);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getmethodtypeinfo(typeinfo(tkeypressevent), listbox1.items);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getmethodtypeinfo(typeinfo(tmousewheelevent), listbox1.items);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">由于获取方法的类型信息比较复杂,我尽量压缩代码也还是有这么长,让我们看看它的实现原理。getmethodtypeinfo 的第一个参数是 ptypeinfo 类型,表示方法的类型信息地址。第二个参数是一个字符串列表,可以使用任何实现 tstrings 操作的对象。我们可以使用 system.pas 中的 typeinfo 函数获得任何类型的 rtti 信息指针。typeinfo 函数像 sizeof 一样,是内置于编译器中的。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getmethodtypeinfo 还用到了 typinfo.pas 中的 getenumname 函数。这个函数通过枚举类型的整数值得到枚举类型的名称。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getenumname(typeinfo: ptypeinfo; value: integer): string;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">与获取类(class)的属性信息类似,方法的类型信息也在 ttypedata 结构中</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ttypedata = packed record</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">case ttypekind of</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tkmethod: (</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">methodkind: tmethodkind;// 方法指针的类型</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">paramcount: byte;// 参数数量</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">paramlist: array[0..1023] of char// 参数详细信息,见下行注释</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{paramlist: array[1..paramcount] of</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">record</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">flags: tparamflags;// 参数传递规则</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">paramname: shortstring;// 参数的名称</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">typename: shortstring;// 参数的类型</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">resulttype: shortstring});// 返回值的名称</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tmethodkind 是方法的类型,定义如下:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tmethodkind = (mkprocedure, mkfunction, mkconstructor, mkdestructor,</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">mkclassprocedure, mkclassfunction,</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ obsolete }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">mksafeprocedure, mksafefunction);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tparamsflags 是参数传递的规则,定义如下:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tparamflag = (pfvar, pfconst, pfarray, pfaddress, pfreference, pfout);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tparamflags = set of tparamflag;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">由于 paramname 和 typename 是变长字符串,不能直接取用该字段的值,而应该使用指针步进的方法,取出参数信息,所以上面的代码显得比较长。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ 获取有序类型(ordinal)、集合(set)类型的 rtti 信息</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">讨论完了属性和方法的 rtti 信息之后再来看其它数据类型的 rtti 就简单多了。所有获取 rtti 的原理都是通过 gettypedata 函数得到 ttypedata 的指针,再通过 ttypeinfo.typekind 来解析 ttypedata。任何数据类型的 ttypeinfo 指针可以通过 typeinfo 函数获得。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">有序类型的 ttypedata 定义如下:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ttypedata = packed record</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tkinteger, tkchar, tkenumeration, tkset, tkwchar: (</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ordtype: tordtype;// 有序数值类型</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">case ttypekind of</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">case ttypekind of</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tkinteger, tkchar, tkenumeration, tkwchar: (</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">minvalue: longint;// 类型的最小值</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">maxvalue: longint;// 类型的最大值</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">case ttypekind of</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tkinteger, tkchar, tkwchar: ();</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tkenumeration: (</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">basetype: pptypeinfo;// 指针的指针,它指向枚举的 ptypeinfo</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">namelist: shortstringbase;// 枚举的名称字符串(不能直接取用)</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">enumunitname: shortstringbase)); // 所在的单元名称(不能直接取用)</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">tkset: (</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">comptype: pptypeinfo));// 指向集合基类 rtti 指针的指针</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">下面是一个获取有序类型和集合类型的 rtti 信息的函数:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure getordtypeinfo(atypeinfo: ptypeinfo; astrings: tstrings);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">var</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ordtypedata: ptypedata;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">i: integer;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">begin</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ordtypedata := gettypedata(atypeinfo);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">astrings.add('------------------------------------');</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">astrings.add('type name: ' + atypeinfo^.name);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">astrings.add('type kind: ' + getenumname(typeinfo(ttypekind),</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">integer(atypeinfo^.kind)));</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">astrings.add('data type: ' + getenumname(typeinfo(tordtype),</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">integer(ordtypedata^.ordtype)));</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">if atypeinfo^.kind</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">[作者:<a href="http://blog.csdn.net/javazhuanzai"><font color="#000000">savetime</font></a>转贴自:delphibbs.com点击数:574更新时间:2004-12-28文章录入:<a href="http://blog.csdn.net/javazhuanzai"><font color="#000000">aleyn</font></a>]</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">本文上篇基本上是 rtti 入门介绍,续篇介绍了所有 typinfo.pas 中的函数,附加了 classes.pas、graphics.pas、controls.pas 中的几个 rtti 相关函数。对于关键函数的代码提供汇编注释。希望本文覆盖了 delphi 中 80% 的 rtti 函数。时间仓促,错误难免,敬请批评指正。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">本文排版格式为:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">正文由窗口自动换行;所有代码以 80 字符为边界;中英文字符以空格符分隔。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">(作者保留对本文的所有权利,未经作者同意请勿在在任何公共媒体转载。)</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">目 录</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ gettypedata 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getpropinfo 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ findpropinfo 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getpropinfos 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ sortproplist 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getproplist 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">------------------------------------------------------</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getobjectpropclass 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ proptype / propistype 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ ispublishedprop 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ isstoredprop 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ freeandnilproperties 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ settostring / stringtoset 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getenumname / getenumvalue / getenumnamevalue 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">------------------------------------------------------</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getordprop 函数详解</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ setordprop 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getenumprop / setenumprop 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getsetprop / setsetprop 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getobjectprop / setobjectprop 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getstrprop / setstrprop 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getfloatprop / setfloatprop 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getpropvalue / setpropvalue 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ tpublishablevarianttype class</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">------------------------------------------------------</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ registerclass / findclass 系列函数 (classes.pas)</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ identtoint / inttoident 系列函数 (classes.pas)</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">正 文</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ gettypedata 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">gettypedata 函数根据 ttypeinfo 指针获得 ttypedata 的地址。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function gettypedata(typeinfo: ptypeinfo): ptypedata;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">asm</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">xoredx,edx; edx 清零</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">movdl,[eax].ttypeinfo.name.byte[0]; 获得 name 字符串长度</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">leaeax,[eax].ttypeinfo.name[edx+1]; 获得 ttypedata 的地址</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">end;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getpropinfo 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getpropinfo 函数用于获得属性的 rtti 指针 ppropinfo。它有四种重载形式,后面三种重载的实现都是调用第一种形式。akinds 参数用于限制属性的类型,如果得到的 ppropinfo 不属于指定的类型,则返回 nil。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getpropinfo(typeinfo: ptypeinfo; const propname: string): ppropinfo;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getpropinfo(instance: tobject; const propname: string;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">akinds: ttypekinds = []): ppropinfo;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getpropinfo(aclass: tclass; const propname: string;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">akinds: ttypekinds = []): ppropinfo;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getpropinfo(typeinfo: ptypeinfo; const propname: string;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">akinds: ttypekinds): ppropinfo;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ findpropinfo 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">findpropinfo 函数根据属性名称获得属性的 rtti 指针,它只是在 getpropinfo 函数的基础上加上了错误检查功能,如果没有属性 rtti 信息,则触发 epropertyerror 异常。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function findpropinfo(instance: tobject; const propname: string): ppropinfo;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function findpropinfo(aclass: tclass; const propname: string): ppropinfo;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getpropinfos 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getpropinfos 函数的功能是把一个类(class)所有属性 rtti 指针 ppropinfo 填充至传入的参数 pproplist 数组中。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">注意:这个函数不负责分配该数组的内容,使用前必须根据属性的数量分配足够的空间。该数组结束后必须清除分配的内容。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure getpropinfos(typeinfo: ptypeinfo; proplist: pproplist);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">注:使用 getproplist 实现相同的功能更方便。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ sortproplist 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">sortproplist 可以对 getpropinfos 函数填充的属性信息指针数组按属性名称排序。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure sortproplist(proplist: pproplist; propcount: integer);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">在 vcl 中 sortproplist 只被 getproplist 函数使用。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getproplist 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getproplist 函数同 getpropinfos 一样,填充 pproplist 数组。getproplist 实际上是调用 getpropinfos 进行填充工作,最后返回已填充的属性的数量。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getproplist(typeinfo: ptypeinfo; typekinds: ttypekinds;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">proplist: pproplist; sortlist: boolean): integer;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getproplist(typeinfo: ptypeinfo; out proplist: pproplist): integer;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getproplist(aobject: tobject; out proplist: pproplist): integer;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">注意:getproplist 的内存分配有点混乱,上面第一个 getproplist 必须自己分配 pprplist 数组的内存,后面二个 getproplist 会自动分配 pproplist 数组的内存。造成这种情况的原因是:第一个 getproplist 可以设置 typekinds 参数限制只返回指定类型的属性,这样就不能直接得到可能返回的属性数量。typekinds 参数可以设置为 tkany,表示返回所有数据类型的属性。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">第一个 getproplist 函数可以设置 sortlist 参数对属性名称进行排序。它实际上是调用第二个 getproplist 并调用 sortproplist 函数执行排序。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">注意:pproplist 不再使用的时候,要记得使用 freemem 函数清除数组内存(根据返回值是否大于1)。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getobjectpropclass 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getobjectpropclass 函数用于返回对象类型的属性所属的类(class)。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getobjectpropclass(instance: tobject; propinfo: ppropinfo): tclass;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getobjectpropclass(instance: tobject; const propname: string): tclass;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getobjectpropclass(propinfo: ppropinfo): tclass;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">这个函数被 setobjectprop 函数使用,用于参数检验。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ proptype / propistype 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">proptype 函数用于获得属性的数据类型。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function proptype(instance: tobject; const propname: string): ttypekind;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function proptype(aclass: tclass; const propname: string): ttypekind;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">propistype 判断属性是否属于某种数据类型。它调用 proptype 实现功能。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function propistype(instance: tobject; const propname: string;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">typekind: ttypekind): boolean;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function propistype(aclass: tclass; const propname: string;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">typekind: ttypekind): boolean;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ ispublishedprop 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ispublishedprop 函数用于判断属性是否是 published 属性,它通过检查该属性 rtti 指针是否等于 nil 来实现功能。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function ispublishedprop(instance: tobject; const propname: string): boolean;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function ispublishedprop(aclass: tclass; const propname: string): boolean;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">ispublishedprop 函数没有被 vcl 使用。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ isstoredprop 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">isstoredprop 函数使用属性信息中的 tpropinfo.storedprop 函数指针来调用属性定义时用 stored 关键字定义的函数的结果。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">这个函数被用于 delphi 持续机制,twriter.writeproperties 方法调用 isstoredprop 判断是否需要把该属性的值写入流中。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function isstoredprop(instance: tobject; propinfo: ppropinfo): boolean;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function isstoredprop(instance: tobject; const propname: string): boolean;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ freeandnilproperties 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">freeandnilproperties 函数用于清除一个对象的所有 published 的对象类型的属性的对象。这个函数调用 getobjectprop 执行获得对象属性的对象句柄,并调用对象的 free 方法清除这个对象,然后调用 setobjectprop 设置该属性为 nil。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">procedure freeandnilproperties(aobject: tobject);</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">我不知道这个函数能用在哪里,至少 vcl 中没有使用这个函数。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ settostring / stringtoset 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">settostring 和 stringtoset 是两个 rtti 辅助函数,它们把集合值转换为字符串,或者把字符串转换为集合值。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function settostring(propinfo: ppropinfo; value: integer;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">brackets: boolean = false): string;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function stringtoset(propinfo: ppropinfo; const value: string): integer;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">注意:这里的集合值最多只能包含 32 个元素(4 bytes),这是集合 rtti 的限制。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getenumname / getenumvalue / getenumnamevalue 函数</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getenumname 函数根据枚举整数值返回枚举字符串。它可以返回以下三种枚举名称:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">integer:直接返回 inttostr(integer)</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">boolean:返回 true/false</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">enum:返回 ttypedata^.namelist 中存储的枚举名称</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getenumname(typeinfo: ptypeinfo; value: integer): string;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getenumvalue 函数根据枚举字符串返回枚举整数值。它与 getenumname 类似,可以返回三种枚举的整数值,但对于 enum 类型,它调用了 getenumnamevalue 函数。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getenumvalue(typeinfo: ptypeinfo; const name: string): integer;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getenumnamevalue 函数与 getenumvalue 函数功能差不多,但它是个汇编函数,只能返回纯枚举类型的值。其工作原理也是匹配 ttypedata^.namelist 值。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getenumnamevalue(typeinfo: ptypeinfo; const name: string): integer;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">注意:getenumnamevalue 隐藏在 implementation 段,不能直接使用,它是为 getenumvalue 函数服务的。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">⊙ getordprop 函数详解</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">===============================================================================</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getordprop 是 delphi rtti 中使用频繁的函数。getordprop 根据对象句柄和对象属性的 tpropinfo 指针获得对象的属性值。它的返回值是 longint,需要强制转换成相应的属性类型才能使用。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">function getordprop(instance: tobject; propinfo: ppropinfo): longint;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">getordprop 调用 tpropinfo.getproc 函数指针得到属性的返回值。它的工作过程是:</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">如果该属性的类型是 class 类型,那么返回值是 4 个字节(对象句柄)。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">否则通过 ttypedata.ordtype 得到返回值的类型,存储在 bl 中。</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">{ tordtype = (otsbyte, otubyte, otsword, otuword, otslong, otulong); }</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">检查 tpropinfo.getproc 的第一个字节(注意是 getproc 指针的第一个字节):</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">如果 getproc[0] = $ff,说明 getproc 是 field offset;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">如果 getproc[0] = $fe,说明 getproc 是 virtual method offset;</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">如果 getproc[0] = otslong</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">jae@@exit; exit</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">cmpbl,otsword; if ordtype &gt;= otsword</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">jae@@word; jmp @@word</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">cmpbl,otsbyte; if ordtype = otsbyte</p> 
<p style="text-indent:2em; padding:0px; margin:0px; line-height:240%">movsxeax,al; al</p> 
<br> ====================================================== 
<br> 
<b>在最后，我邀请大家参加新浪APP，就是新浪免费送大家的一个空间，支持PHP+MySql，免费二级域名，免费域名绑定 <a href="http://sae.sina.com.cn/activity/invite/80242/weibo" rel="nofollow"> 这个是我邀请的地址</a>，您通过这个链接注册即为我的好友，并获赠云豆500个，价值5元哦！短网址是<a href="http://t.cn/SXOiLh" rel="nofollow">http://t.cn/SXOiLh</a>我创建的小站每天访客已经达到2000+了，每天挂广告赚50+元哦，呵呵，饭钱不愁了，\(^o^)/</b>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/452c6a04ecd9e6ef8debeb48bf5155ec/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">《深入浅出MFC》学习笔记之Win32程序设计原理（一）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b7cc6ac7c7065f9ae4c2a43dd0088276/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JAVA数据结构课后习题——2的100次方（mod5）是多少？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>