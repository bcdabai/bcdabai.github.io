<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>分布式搜索——Elasticsearch - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="分布式搜索——Elasticsearch" />
<meta property="og:description" content="Elasticsearch 文章目录 Elasticsearch简介ELK技术栈Elasticsearch和Lucene 倒排索引正向索引倒排索引正向和倒排 ES概念文档和字段索引和映射Mysql与Elasticsearch 安装ES、Kibana安装单点ES创建网络拉取镜像运行 部署kibana拉取镜像部署 安装Ik插件扩展词词典停用词词典 索引库操作ping映射属性索引库的CRUD 文档操作新增文档查询文档删除文档修改文档 RestAPImapping映射分析初始化RestClient创建索引表删除索引库判断索引库是否存在总结 RestClient操作文档查询文档删除文档修改文档批量导入文档 DSL查询文档DSL查询分类全文检索查询基本语法 精准查询term查询range查询 地理坐标查询矩形范围查询附近查询 复合查询相关性算分算分函数查询布尔查询 搜索结果处理排序分页 高亮原理实现 RestClient查询文档查询请求解析响应match查询精确查询布尔查询排序与分页 3.6.高亮3.6.1.高亮请求构建3.6.2.高亮结果解析 数据聚合聚合的种类DSL实现聚合Bucket聚合语法聚合结果排序限定聚合范围Metric聚合语法 RestAPI实现聚合API语法 自动补全拼音分词器自定义分词器自动补全查询自动补全查询的JavaAPI 数据同步同步调用异步通知监听binlog ES集群搭建集群创建索引库集群节点角色集群的脑裂问题分布式存储分布式查询集群故障转移 简介 Elasticsearch是一款非常强大的开源搜索引擎，具备非常多强大功能，可以帮助用户从海量数据中快速找到需要的内容。例如：在GitHub搜索代码、在百度搜索问题的答案、在打车软件搜索附近的车。
ELK技术栈 elasticsearch结合kibana、Logstash、Beats，也就是elastic stack（ELK）。被广泛应用在日志数据分析、实时监控等领域：
而elasticsearch是elastic stack的核心，负责存储、搜索、分析数据。
Elasticsearch和Lucene elasticsearch底层是基于lucene来实现的。
Lucene是一个Java语言的搜索引擎类库，是Apache公司的顶级项目，由DougCutting于1999年研发。是Apache的开源搜索引擎类库，提供了搜索引擎的核心API。
官网地址：https://lucene.apache.org/
elasticsearch的发展历史：
2004年Shay Banon基于Lucene开发了Compass2010年Shay Banon 重写了Compass，取名为Elasticsearch。 官网地址: https://www.elastic.co/cn/
倒排索引 倒排索引的概念是基于MySQL这样的正向索引而言的。
正向索引 那么什么是正向索引呢？例如给下表（tb_goods）中的id创建索引：
如果是根据id查询，那么直接走索引，查询速度非常快。
但如果是基于title做模糊查询，只能是逐行扫描数据，流程如下：
1）用户搜索数据，条件是title符合&#34;%手机%&#34;。
2）逐行获取数据，比如id为1的数据。
3）判断数据中的title是否符合用户搜索条件。
4）如果符合则放入结果集，不符合则丢弃。回到步骤1。
逐行扫描，也就是全表扫描，随着数据量增加，其查询效率也会越来越低。当数据量达到数百万时，就是一场灾难。
倒排索引 倒排索引中有两个非常重要的概念：
文档（Document）：用来搜索的数据，其中的每一条数据就是一个文档。例如一个网页、一个商品信息词条（Term）：对文档数据或用户搜索数据，利用某种算法分词，得到的具备含义的词语就是词条。例如：我是中国人，就可以分为：我、是、中国人、中国、国人这样的几个词条 创建倒排索引是对正向索引的一种特殊处理，流程如下：
将每一个文档的数据利用算法分词，得到一个个词条创建表，每行数据包括词条、词条所在文档id、位置等信息因为词条唯一性，可以给词条创建索引，例如hash表结构索引 倒排索引的搜索流程如下（以搜索&#34;华为手机&#34;为例）：
1）用户输入条件&#34;华为手机&#34;进行搜索。
2）对用户输入内容分词，得到词条：华为、手机。
3）拿着词条在倒排索引中查找，可以得到包含词条的文档id：1、2、3。
4）拿着文档id到正向索引中查找具体文档。
虽然要先查询倒排索引，再查询倒排索引，但是无论是词条、还是文档id都建立了索引，查询速度非常快！无需全表扫描。
正向和倒排 那么为什么一个叫做正向索引，一个叫做倒排索引呢？
正向索引是最传统的，根据id索引的方式。但根据词条查询时，必须先逐条获取每个文档，然后判断文档中是否包含所需要的词条，是根据文档找词条的过程。
而倒排索引则相反，是先找到用户要搜索的词条，根据词条得到保护词条的文档的id，然后根据id获取文档。是根据词条找文档的过程。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f1cc6dbc601786c5ccde87b59277840c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-15T19:41:44+08:00" />
<meta property="article:modified_time" content="2024-01-15T19:41:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">分布式搜索——Elasticsearch</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Elasticsearch_0"></a>Elasticsearch</h2> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Elasticsearch_0" rel="nofollow">Elasticsearch</a></li><li><ul><li><a href="#_2" rel="nofollow">简介</a></li><li><ul><li><a href="#ELK_6" rel="nofollow">ELK技术栈</a></li><li><a href="#ElasticsearchLucene_16" rel="nofollow">Elasticsearch和Lucene</a></li></ul> 
   </li><li><a href="#_35" rel="nofollow">倒排索引</a></li><li><ul><li><a href="#_39" rel="nofollow">正向索引</a></li><li><a href="#_59" rel="nofollow">倒排索引</a></li><li><a href="#_88" rel="nofollow">正向和倒排</a></li></ul> 
   </li><li><a href="#ES_112" rel="nofollow">ES概念</a></li><li><ul><li><a href="#_116" rel="nofollow">文档和字段</a></li><li><a href="#_124" rel="nofollow">索引和映射</a></li><li><a href="#MysqlElasticsearch_140" rel="nofollow">Mysql与Elasticsearch</a></li></ul> 
   </li><li><a href="#ESKibana_166" rel="nofollow">安装ES、Kibana</a></li><li><ul><li><a href="#ES_168" rel="nofollow">安装单点ES</a></li><li><ul><li><a href="#_170" rel="nofollow">创建网络</a></li><li><a href="#_178" rel="nofollow">拉取镜像</a></li><li><a href="#_186" rel="nofollow">运行</a></li></ul> 
    </li><li><a href="#kibana_221" rel="nofollow">部署kibana</a></li><li><ul><li><a href="#_225" rel="nofollow">拉取镜像</a></li><li><a href="#_231" rel="nofollow">部署</a></li></ul> 
   </li></ul> 
   </li><li><a href="#Ik_262" rel="nofollow">安装Ik插件</a></li><li><ul><li><a href="#_283" rel="nofollow">扩展词词典</a></li><li><a href="#_325" rel="nofollow">停用词词典</a></li></ul> 
   </li><li><a href="#_366" rel="nofollow">索引库操作</a></li><li><ul><li><a href="#ping_370" rel="nofollow">ping映射属性</a></li><li><a href="#CRUD_384" rel="nofollow">索引库的CRUD</a></li></ul> 
   </li><li><a href="#_477" rel="nofollow">文档操作</a></li><li><ul><li><a href="#_479" rel="nofollow">新增文档</a></li><li><a href="#_496" rel="nofollow">查询文档</a></li><li><a href="#_506" rel="nofollow">删除文档</a></li><li><a href="#_514" rel="nofollow">修改文档</a></li></ul> 
   </li><li><a href="#RestAPI_554" rel="nofollow">RestAPI</a></li><li><ul><li><a href="#mapping_567" rel="nofollow">mapping映射分析</a></li><li><a href="#RestClient_671" rel="nofollow">初始化RestClient</a></li><li><a href="#_715" rel="nofollow">创建索引表</a></li><li><a href="#_801" rel="nofollow">删除索引库</a></li><li><a href="#_833" rel="nofollow">判断索引库是否存在</a></li><li><a href="#_859" rel="nofollow">总结</a></li></ul> 
   </li><li><a href="#RestClient_870" rel="nofollow">RestClient操作文档</a></li><li><ul><li><a href="#_987" rel="nofollow">查询文档</a></li><li><a href="#_1023" rel="nofollow">删除文档</a></li><li><a href="#_1045" rel="nofollow">修改文档</a></li><li><a href="#_1084" rel="nofollow">批量导入文档</a></li></ul> 
   </li><li><a href="#DSL_1141" rel="nofollow">DSL查询文档</a></li><li><ul><li><a href="#DSL_1145" rel="nofollow">DSL查询分类</a></li><li><a href="#_1196" rel="nofollow">全文检索查询</a></li><li><ul><li><a href="#_1206" rel="nofollow">基本语法</a></li></ul> 
    </li><li><a href="#_1240" rel="nofollow">精准查询</a></li><li><ul><li><a href="#term_1247" rel="nofollow">term查询</a></li><li><a href="#range_1267" rel="nofollow">range查询</a></li></ul> 
    </li><li><a href="#_1288" rel="nofollow">地理坐标查询</a></li><li><ul><li><a href="#_1300" rel="nofollow">矩形范围查询</a></li><li><a href="#_1331" rel="nofollow">附近查询</a></li></ul> 
    </li><li><a href="#_1354" rel="nofollow">复合查询</a></li><li><ul><li><a href="#_1361" rel="nofollow">相关性算分</a></li><li><a href="#_1375" rel="nofollow">算分函数查询</a></li><li><a href="#_1412" rel="nofollow">布尔查询</a></li></ul> 
    </li><li><a href="#_1428" rel="nofollow">搜索结果处理</a></li><li><ul><li><a href="#_1432" rel="nofollow">排序</a></li><li><a href="#_1488" rel="nofollow">分页</a></li></ul> 
    </li><li><a href="#_1578" rel="nofollow">高亮</a></li><li><ul><li><a href="#_1580" rel="nofollow">原理</a></li><li><a href="#_1591" rel="nofollow">实现</a></li></ul> 
   </li></ul> 
   </li><li><a href="#RestClient_1620" rel="nofollow">RestClient查询文档</a></li><li><ul><li><a href="#_1629" rel="nofollow">查询请求</a></li><li><a href="#_1669" rel="nofollow">解析响应</a></li><li><a href="#match_1740" rel="nofollow">match查询</a></li><li><a href="#_1774" rel="nofollow">精确查询</a></li><li><a href="#_1787" rel="nofollow">布尔查询</a></li><li><a href="#_1819" rel="nofollow">排序与分页</a></li></ul> 
   </li><li><a href="#36_1852" rel="nofollow">3.6.高亮</a></li><li><ul><li><a href="#361_1859" rel="nofollow">3.6.1.高亮请求构建</a></li><li><a href="#362_1889" rel="nofollow">3.6.2.高亮结果解析</a></li></ul> 
   </li><li><a href="#_1937" rel="nofollow">数据聚合</a></li><li><ul><li><a href="#_1945" rel="nofollow">聚合的种类</a></li><li><a href="#DSL_1962" rel="nofollow">DSL实现聚合</a></li><li><ul><li><a href="#Bucket_1966" rel="nofollow">Bucket聚合语法</a></li><li><a href="#_1985" rel="nofollow">聚合结果排序</a></li><li><a href="#_2009" rel="nofollow">限定聚合范围</a></li><li><a href="#Metric_2037" rel="nofollow">Metric聚合语法</a></li></ul> 
   </li></ul> 
   </li><li><a href="#RestAPI_2069" rel="nofollow">RestAPI实现聚合</a></li><li><ul><li><a href="#API_2071" rel="nofollow">API语法</a></li></ul> 
   </li><li><a href="#_2083" rel="nofollow">自动补全</a></li><li><ul><li><a href="#_2093" rel="nofollow">拼音分词器</a></li><li><a href="#_2177" rel="nofollow">自定义分词器</a></li><li><a href="#_2229" rel="nofollow">自动补全查询</a></li><li><a href="#JavaAPI_2294" rel="nofollow">自动补全查询的JavaAPI</a></li></ul> 
   </li><li><a href="#_2304" rel="nofollow">数据同步</a></li><li><ul><li><a href="#_2316" rel="nofollow">同步调用</a></li><li><a href="#_2325" rel="nofollow">异步通知</a></li><li><a href="#binlog_2334" rel="nofollow">监听binlog</a></li></ul> 
   </li><li><a href="#ES_2361" rel="nofollow">ES集群</a></li><li><ul><li><a href="#_2404" rel="nofollow">搭建集群</a></li><li><a href="#_2507" rel="nofollow">创建索引库</a></li><li><a href="#_2526" rel="nofollow">集群节点角色</a></li><li><a href="#_2549" rel="nofollow">集群的脑裂问题</a></li><li><a href="#_2569" rel="nofollow">分布式存储</a></li><li><a href="#_2594" rel="nofollow">分布式查询</a></li><li><a href="#_2604" rel="nofollow">集群故障转移</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_2"></a>简介</h3> 
<p>Elasticsearch是一款非常强大的开源搜索引擎，具备非常多强大功能，可以帮助用户从海量数据中快速找到需要的内容。例如：在GitHub搜索代码、在百度搜索问题的答案、在打车软件搜索附近的车。</p> 
<h4><a id="ELK_6"></a>ELK技术栈</h4> 
<p>elasticsearch结合kibana、Logstash、Beats，也就是elastic stack（ELK）。被广泛应用在日志数据分析、实时监控等领域：</p> 
<p><img src="https://images2.imgbox.com/35/91/eURu6D0O_o.png" alt=""></p> 
<p>而elasticsearch是elastic stack的核心，负责存储、搜索、分析数据。</p> 
<p><img src="https://images2.imgbox.com/6d/82/Cx6jjZ3U_o.png" alt=""></p> 
<h4><a id="ElasticsearchLucene_16"></a>Elasticsearch和Lucene</h4> 
<p>elasticsearch底层是基于<strong>lucene</strong>来实现的。</p> 
<p><strong>Lucene</strong>是一个Java语言的搜索引擎类库，是Apache公司的顶级项目，由DougCutting于1999年研发。是Apache的开源搜索引擎类库，提供了搜索引擎的核心API。</p> 
<p>官网地址：<a href="https://lucene.apache.org/" rel="nofollow">https://lucene.apache.org/</a></p> 
<p><img src="https://images2.imgbox.com/53/dd/CCbxyyhm_o.png" alt=""></p> 
<p><strong>elasticsearch</strong>的发展历史：</p> 
<ul><li>2004年Shay Banon基于Lucene开发了Compass</li><li>2010年Shay Banon 重写了Compass，取名为Elasticsearch。</li></ul> 
<p>官网地址: <a href="https://www.elastic.co/cn/" rel="nofollow">https://www.elastic.co/cn/</a></p> 
<p><img src="https://images2.imgbox.com/c6/20/RvVRWW6Q_o.png" alt="image-20230829102317218"></p> 
<h3><a id="_35"></a>倒排索引</h3> 
<p>倒排索引的概念是基于MySQL这样的正向索引而言的。</p> 
<h4><a id="_39"></a>正向索引</h4> 
<p>那么什么是正向索引呢？例如给下表（tb_goods）中的id创建索引：</p> 
<p><img src="https://images2.imgbox.com/56/46/yj82JNtd_o.png" alt=""></p> 
<p>如果是根据id查询，那么直接走索引，查询速度非常快。</p> 
<p>但如果是基于title做模糊查询，只能是逐行扫描数据，流程如下：</p> 
<p>1）用户搜索数据，条件是title符合<code>"%手机%"</code>。</p> 
<p>2）逐行获取数据，比如id为1的数据。</p> 
<p>3）判断数据中的title是否符合用户搜索条件。</p> 
<p>4）如果符合则放入结果集，不符合则丢弃。回到步骤1。</p> 
<p>逐行扫描，也就是全表扫描，随着数据量增加，其查询效率也会越来越低。当数据量达到数百万时，就是一场灾难。</p> 
<h4><a id="_59"></a>倒排索引</h4> 
<p>倒排索引中有两个非常重要的概念：</p> 
<ul><li>文档（<code>Document</code>）：用来搜索的数据，其中的每一条数据就是一个文档。例如一个网页、一个商品信息</li><li>词条（<code>Term</code>）：对文档数据或用户搜索数据，利用某种算法分词，得到的具备含义的词语就是词条。例如：我是中国人，就可以分为：我、是、中国人、中国、国人这样的几个词条</li></ul> 
<p><strong>创建倒排索引</strong>是对正向索引的一种特殊处理，流程如下：</p> 
<ul><li>将每一个文档的数据利用算法分词，得到一个个词条</li><li>创建表，每行数据包括词条、词条所在文档id、位置等信息</li><li>因为词条唯一性，可以给词条创建索引，例如hash表结构索引</li></ul> 
<p><img src="https://images2.imgbox.com/a8/06/aAsLzHMp_o.png" alt=""></p> 
<p>倒排索引的<strong>搜索流程</strong>如下（以搜索"华为手机"为例）：</p> 
<p>1）用户输入条件<code>"华为手机"</code>进行搜索。</p> 
<p>2）对用户输入内容<strong>分词</strong>，得到词条：<code>华为</code>、<code>手机</code>。</p> 
<p>3）拿着词条在倒排索引中查找，可以得到包含词条的文档id：1、2、3。</p> 
<p>4）拿着文档id到正向索引中查找具体文档。</p> 
<p><img src="https://images2.imgbox.com/86/bd/CoShz4wF_o.png" alt=""></p> 
<p>虽然要先查询倒排索引，再查询倒排索引，但是无论是词条、还是文档id都建立了索引，查询速度非常快！无需全表扫描。</p> 
<h4><a id="_88"></a>正向和倒排</h4> 
<p>那么为什么一个叫做正向索引，一个叫做倒排索引呢？</p> 
<ul><li> <p><strong>正向索引</strong>是最传统的，根据id索引的方式。但根据词条查询时，必须先逐条获取每个文档，然后判断文档中是否包含所需要的词条，是<strong>根据文档找词条的过程</strong>。</p> </li><li> <p>而<strong>倒排索引</strong>则相反，是先找到用户要搜索的词条，根据词条得到保护词条的文档的id，然后根据id获取文档。是<strong>根据词条找文档的过程</strong>。</p> </li></ul> 
<p><strong>正向索引</strong>：</p> 
<ul><li>优点： 
  <ul><li>可以给多个字段创建索引</li><li>根据索引字段搜索、排序速度非常快</li></ul> </li><li>缺点： 
  <ul><li>根据非索引字段，或者索引字段中的部分词条查找时，只能全表扫描。</li></ul> </li></ul> 
<p><strong>倒排索引</strong>：</p> 
<ul><li>优点： 
  <ul><li>根据词条搜索、模糊搜索时，速度非常快</li></ul> </li><li>缺点： 
  <ul><li>只能给词条创建索引，而不是字段</li><li>无法根据字段做排序</li></ul> </li></ul> 
<h3><a id="ES_112"></a>ES概念</h3> 
<p>elasticsearch中有很多独有的概念，与mysql中略有差别，但也有相似之处。</p> 
<h4><a id="_116"></a>文档和字段</h4> 
<p>elasticsearch是面向**文档（Document）**存储的，可以是数据库中的一条商品数据，一个订单信息。文档数据会被序列化为json格式后存储在elasticsearch中：</p> 
<p><img src="https://images2.imgbox.com/5f/e3/cLO0UENx_o.png" alt=""></p> 
<p>而Json文档中往往包含很多的<strong>字段（Field）</strong>，类似于数据库中的列。</p> 
<h4><a id="_124"></a>索引和映射</h4> 
<p><strong>索引（Index）</strong>，就是相同类型的文档的集合。</p> 
<p>例如：</p> 
<ul><li>所有用户文档，就可以组织在一起，称为用户的索引；</li><li>所有商品的文档，可以组织在一起，称为商品的索引；</li><li>所有订单的文档，可以组织在一起，称为订单的索引；</li></ul> 
<p><img src="https://images2.imgbox.com/4f/06/LAOCaY9M_o.png" alt=""></p> 
<p>因此，可以把索引当做是数据库中的表。</p> 
<p>数据库的表会有约束信息，用来定义表的结构、字段的名称、类型等信息。因此，索引库中就有<strong>映射（mapping）</strong>，是索引中文档的字段约束信息，类似表的结构约束。</p> 
<h4><a id="MysqlElasticsearch_140"></a>Mysql与Elasticsearch</h4> 
<p>我们统一的把mysql与elasticsearch的概念做一下对比：</p> 
<table><thead><tr><th align="center"><strong>MySQL</strong></th><th align="center"><strong>Elasticsearch</strong></th><th align="center"><strong>说明</strong></th></tr></thead><tbody><tr><td align="center">Table</td><td align="center">Index</td><td align="center">索引(index)，就是文档的集合，类似数据库的表(table)</td></tr><tr><td align="center">Row</td><td align="center">Document</td><td align="center">文档（Document），就是一条条的数据，类似数据库中的行（Row），文档都是JSON格式</td></tr><tr><td align="center">Column</td><td align="center">Field</td><td align="center">字段（Field），就是JSON文档中的字段，类似数据库中的列（Column）</td></tr><tr><td align="center">Schema</td><td align="center">Mapping</td><td align="center">Mapping（映射）是索引中文档的约束，例如字段类型约束。类似数据库的表结构（Schema）</td></tr><tr><td align="center">SQL</td><td align="center">DSL</td><td align="center">DSL是elasticsearch提供的JSON风格的请求语句，用来操作elasticsearch，实现CRUD</td></tr></tbody></table> 
<p>MySQL与Elasticsearch两者各自有自己的长处：</p> 
<ul><li> <p>Mysql：擅长事务类型操作，可以确保数据的安全和一致性</p> </li><li> <p>Elasticsearch：擅长海量数据的搜索、分析、计算</p> </li></ul> 
<p>因此在企业中，往往是两者结合使用：</p> 
<ul><li>对安全性要求较高的写操作，使用mysql实现</li><li>对查询性能要求较高的搜索需求，使用elasticsearch实现</li><li>两者再基于某种方式，实现数据的同步，保证一致性</li></ul> 
<p><img src="https://images2.imgbox.com/ef/82/hrtWqQOn_o.png" alt=""></p> 
<h3><a id="ESKibana_166"></a>安装ES、Kibana</h3> 
<h4><a id="ES_168"></a>安装单点ES</h4> 
<h5><a id="_170"></a>创建网络</h5> 
<p>后续还要部署kibana容器，因此需要让es和kibana容器互联。这里先创建一个网络：</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> network create es-net
</code></pre> 
<h5><a id="_178"></a>拉取镜像</h5> 
<p>镜像文件比较大，可能需要等待一会</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> pull elasticsearch:7.12.1
</code></pre> 
<h5><a id="_186"></a>运行</h5> 
<p>运行docker命令，部署单点es：</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
	<span class="token parameter variable">--name</span> es <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token string">"ES_JAVA_OPTS=-Xms1024m -Xmx1024m"</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-e</span> <span class="token string">"discovery.type=single-node"</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">-v</span> es-data:/usr/share/elasticsearch/data <span class="token punctuation">\</span>
    <span class="token parameter variable">-v</span> es-plugins:/usr/share/elasticsearch/plugins <span class="token punctuation">\</span>
    <span class="token parameter variable">--privileged</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--network</span> es-net <span class="token punctuation">\</span>
    <span class="token parameter variable">-p</span> <span class="token number">9200</span>:9200 <span class="token punctuation">\</span>
    <span class="token parameter variable">-p</span> <span class="token number">9300</span>:9300 <span class="token punctuation">\</span>
elasticsearch:7.12.1
</code></pre> 
<p>命令解释：</p> 
<ul><li><code>-e "cluster.name=es-docker-cluster"</code>：设置集群名称</li><li><code>-e "http.host=0.0.0.0"</code>：监听的地址，可以外网访问</li><li><code>-e "ES_JAVA_OPTS=-Xms1024m -Xmx1024m"</code>：内存大小(根据虚拟机内存大小配置，最小不要小于512M，否则后续会出现内存不足的情况)。</li><li><code>-e "discovery.type=single-node"</code>：非集群模式</li><li><code>-v es-data:/usr/share/elasticsearch/data</code>：挂载逻辑卷，绑定es的数据目录</li><li><code>-v es-logs:/usr/share/elasticsearch/logs</code>：挂载逻辑卷，绑定es的日志目录</li><li><code>-v es-plugins:/usr/share/elasticsearch/plugins</code>：挂载逻辑卷，绑定es的插件目录</li><li><code>--privileged</code>：授予逻辑卷访问权</li><li><code>--network es-net</code> ：加入一个名为es-net的网络中</li><li><code>-p 9200:9200</code>：端口映射配置</li></ul> 
<p>访问http://192.168.xxx.xxx:9200，如果看到以下页面，则证明elasticsearch安装成功。</p> 
<p><img src="https://images2.imgbox.com/00/4e/khpdSl75_o.png" alt="image-20230630103645520"></p> 
<h4><a id="kibana_221"></a>部署kibana</h4> 
<p>kibana可以提供一个elasticsearch的可视化界面，便于学习。</p> 
<h5><a id="_225"></a>拉取镜像</h5> 
<pre><code class="prism language-shell"><span class="token function">docker</span> pull kibana:7.12.1
</code></pre> 
<h5><a id="_231"></a>部署</h5> 
<p>运行docker命令，部署kibana</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--name</span> kibana <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">ELASTICSEARCH_HOSTS</span><span class="token operator">=</span>http://es:9200 <span class="token punctuation">\</span>
<span class="token parameter variable">--network</span><span class="token operator">=</span>es-net <span class="token punctuation">\</span>
<span class="token parameter variable">-p</span> <span class="token number">5601</span>:5601  <span class="token punctuation">\</span>
kibana:7.12.1
</code></pre> 
<ul><li><code>--network es-net</code> ：加入一个名为es-net的网络中，与elasticsearch在同一个网络中</li><li><code>-e ELASTICSEARCH_HOSTS=http://es:9200"</code>：设置elasticsearch的地址，因为kibana已经与elasticsearch在一个网络，因此可以用容器名直接访问elasticsearch</li><li><code>-p 5601:5601</code>：端口映射配置</li></ul> 
<p>kibana启动一般比较慢，需要多等待一会，可以通过命令：</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> logs <span class="token parameter variable">-f</span> kibana
</code></pre> 
<p>查看运行日志，当查看到下面的日志，说明成功：</p> 
<p><img src="https://images2.imgbox.com/bd/05/ESbfrZvW_o.png" alt="image-20230630104912450"></p> 
<p>此时，在浏览器输入地址访问：http://192.168.xxx.xxx:5601，即可看到结果</p> 
<p>kibana中提供了一个DevTools界面，这个界面中可以编写DSL来操作elasticsearch。并且对DSL语句有自动补全功能。</p> 
<h3><a id="Ik_262"></a>安装Ik插件</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 进入容器内部</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> es /bin/bash

<span class="token comment"># 在线下载并安装</span>
./bin/elasticsearch-plugin  <span class="token function">install</span> https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.12.1/elasticsearch-analysis-ik-7.12.1.zip

<span class="token comment">#退出</span>
<span class="token builtin class-name">exit</span>
<span class="token comment">#重启容器</span>
<span class="token function">docker</span> restart es
</code></pre> 
<p>IK分词器包含两种模式：</p> 
<ul><li> <p><code>ik_smart</code>：最少切分</p> </li><li> <p><code>ik_max_word</code>：最细切分</p> </li></ul> 
<h4><a id="_283"></a>扩展词词典</h4> 
<p>随着互联网的发展，“造词运动”也越发的频繁。出现了很多新的词语，在原有的词汇列表中并不存在。如：“泰酷辣”、“永远的神”等。</p> 
<p>所以我们的词汇也需要不断的更新，IK分词器提供了扩展词汇的功能。</p> 
<p>1）打开IK分词器config目录(前置目录：<code>/var/lib/docker/volumes/es-plugins/_data </code>)：</p> 
<p><img src="https://images2.imgbox.com/1a/7c/P73gHm18_o.png" alt=""></p> 
<p>2）在IKAnalyzer.cfg.xml配置文件内容添加：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">properties</span> <span class="token name">SYSTEM</span> <span class="token string">"http://java.sun.com/dtd/properties.dtd"</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>IK Analyzer 扩展配置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--用户可以在这里配置自己的扩展字典 *** 添加扩展词典--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ext_dict<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>ext.dic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<blockquote> 
 <p>3）新建一个 ext.dic，可以参考config目录下复制一个配置文件进行修改</p> 
</blockquote> 
<pre><code class="prism language-properties">泰酷辣
永远的神
</code></pre> 
<blockquote> 
 <p>4）重启elasticsearch</p> 
</blockquote> 
<pre><code class="prism language-sh"><span class="token function">docker</span> restart es

<span class="token comment"># 查看 日志</span>
<span class="token function">docker</span> logs <span class="token parameter variable">-f</span> es
</code></pre> 
<p><img src="https://images2.imgbox.com/ca/3a/eYuOt7bV_o.png" alt=""></p> 
<p>日志中已经成功加载ext.dic配置文件。</p> 
<h4><a id="_325"></a>停用词词典</h4> 
<p>在互联网项目中，在网络间传输的速度很快，所以很多语言是不允许在网络上传递的，如：关于宗教、政治等敏感词语，那么我们在搜索时也应该忽略当前词汇。</p> 
<p>IK分词器也提供了强大的停用词功能，让我们在索引时就直接忽略当前的停用词汇表中的内容。</p> 
<p>1）IKAnalyzer.cfg.xml配置文件内容添加：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">properties</span> <span class="token name">SYSTEM</span> <span class="token string">"http://java.sun.com/dtd/properties.dtd"</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>IK Analyzer 扩展配置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--用户可以在这里配置自己的扩展字典--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ext_dict<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>ext.dic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
         <span class="token comment">&lt;!--用户可以在这里配置自己的扩展停止词字典  *** 添加停用词词典--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ext_stopwords<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>stopword.dic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>3）在 stopword.dic 添加停用词</p> 
<pre><code class="prism language-properties">“一些敏感词汇”(该内容过于敏感，不宜显示)
</code></pre> 
<p>4）重启elasticsearch</p> 
<pre><code class="prism language-sh"><span class="token comment"># 重启服务</span>
<span class="token function">docker</span> restart es
<span class="token function">docker</span> restart kibana

<span class="token comment"># 查看 日志</span>
<span class="token function">docker</span> logs <span class="token parameter variable">-f</span> es
</code></pre> 
<p>日志中已经成功加载stopword.dic配置文件</p> 
<p><code>注</code>：当前文件的编码必须是UTF- 8格式，严禁使用Windows记事本编辑。</p> 
<h3><a id="_366"></a>索引库操作</h3> 
<p>索引库就类似数据库表，mapping映射就类似表的结构。要向es中存储数据，必须先创建“库”和“表”。</p> 
<h4><a id="ping_370"></a>ping映射属性</h4> 
<p>mapping是对索引库中文档的约束，常见的mapping属性包括：</p> 
<ul><li>type：字段数据类型，常见的简单类型有： 
  <ul><li>字符串：text（可分词的文本）、keyword（精确值，例如：品牌、国家、ip地址）</li><li>数值：long、integer、short、byte、double、float、</li><li>布尔：boolean</li><li>日期：date</li><li>对象：object</li></ul> </li><li>index：是否创建索引，默认为true</li><li>analyzer：使用哪种分词器</li><li>properties：该字段的子字段</li></ul> 
<h4><a id="CRUD_384"></a>索引库的CRUD</h4> 
<p>统一使用Kibana编写DSL的方式来演示。</p> 
<blockquote> 
 <p>创建索引库和映射</p> 
</blockquote> 
<ul><li>请求方式：PUT</li><li>请求路径：/索引库名，可以自定义</li><li>请求参数：mapping映射</li></ul> 
<p>格式：</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>索引库名称
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"字段名"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"字段名2"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token string">"false"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"字段名3"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"子字段"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// ...略</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>查询索引库</p> 
</blockquote> 
<ul><li> <p>请求方式：GET</p> </li><li> <p>请求路径：/索引库名</p> </li><li> <p>请求参数：无</p> </li></ul> 
<p>格式：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>索引库名
</code></pre> 
<blockquote> 
 <p>修改索引库</p> 
</blockquote> 
<p>倒排索引结构虽然不复杂，但是一旦数据结构改变（比如改变了分词器），就需要重新创建倒排索引，这简直是灾难。因此索引库<strong>一旦创建，无法修改mapping</strong>。</p> 
<p>虽然无法修改mapping中已有的字段，但是却允许添加新的字段到mapping中，因为不会对倒排索引产生影响。</p> 
<p><strong>格式</strong>：</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>索引库名<span class="token operator">/</span>_mapping
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"新字段名"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>删除索引库</p> 
</blockquote> 
<ul><li> <p>请求方式：DELETE</p> </li><li> <p>请求路径：/索引库名</p> </li><li> <p>请求参数：无</p> </li></ul> 
<p><strong>格式：</strong></p> 
<pre><code class="prism language-json"><span class="token constant">DELETE</span> <span class="token operator">/</span>索引库名
</code></pre> 
<blockquote> 
 <p>添加字段</p> 
</blockquote> 
<p>格式</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>索引库名<span class="token operator">/</span>_mapping
</code></pre> 
<h3><a id="_477"></a>文档操作</h3> 
<h4><a id="_479"></a>新增文档</h4> 
<p>语法格式</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>索引库名<span class="token operator">/</span>_doc<span class="token operator">/</span>文档id
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"字段1"</span><span class="token operator">:</span> <span class="token string">"值1"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"字段2"</span><span class="token operator">:</span> <span class="token string">"值2"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"字段3"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"子属性1"</span><span class="token operator">:</span> <span class="token string">"值3"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"子属性2"</span><span class="token operator">:</span> <span class="token string">"值4"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_496"></a>查询文档</h4> 
<p>根据rest风格，新增是post，查询应该是get，不过查询一般都需要条件，这里我们把文档id带上。</p> 
<p><strong>语法格式：</strong></p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span><span class="token punctuation">{<!-- --></span>索引库名称<span class="token punctuation">}</span><span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>id<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_506"></a>删除文档</h4> 
<p><strong>语法格式：</strong></p> 
<pre><code class="prism language-js"><span class="token constant">DELETE</span> <span class="token operator">/</span><span class="token punctuation">{<!-- --></span>索引库名<span class="token punctuation">}</span><span class="token operator">/</span>_doc<span class="token operator">/</span>id值
</code></pre> 
<h4><a id="_514"></a>修改文档</h4> 
<p>修改文档有两种方式，一种是全量修改，另一种是增量修改。</p> 
<blockquote> 
 <p>全量修改</p> 
</blockquote> 
<p>全量修改是覆盖原来的文档，其本质是：</p> 
<ul><li>根据指定的id删除文档</li><li>新增一个相同id的文档</li></ul> 
<p><strong>注意</strong>：如果根据id删除时，id不存在，第二步的新增也会执行，也就从修改变成了新增操作了。</p> 
<p><strong>语法格式：</strong></p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span><span class="token punctuation">{<!-- --></span>索引库名<span class="token punctuation">}</span><span class="token operator">/</span>_doc<span class="token operator">/</span>文档id
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"字段1"</span><span class="token operator">:</span> <span class="token string">"值1"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"字段2"</span><span class="token operator">:</span> <span class="token string">"值2"</span><span class="token punctuation">,</span>
    <span class="token comment">// ... 略</span>
<span class="token punctuation">}</span>

</code></pre> 
<blockquote> 
 <p>增量修改</p> 
</blockquote> 
<p>增量修改是只修改指定id匹配的文档中的部分字段。</p> 
<p><strong>语法格式：</strong></p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span><span class="token punctuation">{<!-- --></span>索引库名<span class="token punctuation">}</span><span class="token operator">/</span>_update<span class="token operator">/</span>文档id
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"doc"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
         <span class="token string-property property">"字段名"</span><span class="token operator">:</span> <span class="token string">"新的值"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="RestAPI_554"></a>RestAPI</h3> 
<p>ES官方提供了各种不同语言的客户端，用来操作ES。这些客户端的本质就是组装DSL语句，通过http请求发送给ES。</p> 
<p>官方文档地址：<a href="https://www.elastic.co/guide/en/elasticsearch/client/index.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/client/index.html</a></p> 
<p>其中的Java Rest Client又包括两种：</p> 
<ul><li>Java Low Level Rest Client</li><li>Java High Level Rest Client</li></ul> 
<p><img src="https://images2.imgbox.com/2c/93/BdndBxoL_o.png" alt=""></p> 
<h4><a id="mapping_567"></a>mapping映射分析</h4> 
<p>创建索引库，最关键的是mapping映射，而mapping映射要考虑的信息包括：</p> 
<ul><li>字段名</li><li>字段数据类型</li><li>是否参与搜索</li><li>是否需要分词</li><li>如果分词，分词器是什么？</li></ul> 
<p>其中：</p> 
<ul><li>字段名、字段数据类型，可以参考数据表结构的名称和类型</li><li>是否参与搜索需要分析业务来判断，例如图片地址，就无需参与搜索</li><li>是否分词需要看内容，内容如果是一个整体就无需分词，反之则要分词</li><li>分词器，可以统一使用ik_max_word</li></ul> 
<p>以下面数据结构表为例：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>tb_hotel<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'酒店id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'酒店名称'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>address<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'酒店地址'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'酒店价格'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>score<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'酒店评分'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>brand<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'酒店品牌'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>city<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'所在城市'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>star_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'酒店星级，1星到5星，1钻到5钻'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>business<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商圈'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>latitude<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'纬度'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>longitude<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'经度'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pic<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'酒店图片'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Compact<span class="token punctuation">;</span>
</code></pre> 
<p>创建的对应索引库结构为：</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>hotel
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"address"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"price"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"score"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"brand"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"city"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"copy_to"</span><span class="token operator">:</span> <span class="token string">"all"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"starName"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"business"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"location"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"pic"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"all"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中上面的location字段为地理坐标，包含经度、纬度。</p> 
<p>地理坐标说明：</p> 
<p><img src="https://images2.imgbox.com/9c/1c/5MBK0jGA_o.png" alt=""></p> 
<p>all字段为组合字段，其目的是将多字段的值利用copy_to合并，提供给用户搜索。</p> 
<p>copy_to说明：</p> 
<p><img src="https://images2.imgbox.com/d1/29/pvtKJYIX_o.png" alt=""></p> 
<h4><a id="RestClient_671"></a>初始化RestClient</h4> 
<p>在elasticsearch提供的API中，与elasticsearch一切交互都封装在一个名为RestHighLevelClient的类中，必须先完成这个对象的初始化，建立与elasticsearch的连接。</p> 
<blockquote> 
 <p>引入es的RestHighLevelClient依赖：</p> 
</blockquote> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch.client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch-rest-high-level-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>因为springboot默认控制的ES版本为7.6.2，不满足使用需求，所以需要覆盖默认的ES版本</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>7.12.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<blockquote> 
 <p>初始化RestHighLevelClient</p> 
</blockquote> 
<p>初始化代码</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelIndexTest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.xxx.xxx:9200"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_715"></a>创建索引表</h4> 
<p>创建索引库的API如下：</p> 
<p><img src="https://images2.imgbox.com/6b/0b/TZHGCE7o_o.png" alt=""></p> 
<p>代码分为三步：</p> 
<ol><li> <p><strong>创建Request对象</strong>。因为是创建索引库的操作，因此Request是CreateIndexRequest。</p> </li><li> <p><strong>添加请求参数</strong>，其实就是DSL的JSON参数部分。因为json字符串很长，可以定义为静态字符串常量，让代码看起来更加优雅。</p> </li><li> <p><strong>发送请求</strong>，client.indices()方法的返回值是IndicesClient类型，封装了所有与索引库操作有关的方法。</p> </li></ol> 
<p>根据上面的索引库结构，实现创建索引</p> 
<blockquote> 
 <p>创建一个常量类，定义mapping映射的JSON字符串常量</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelConstants</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MAPPING_TEMPLATE</span> <span class="token operator">=</span> <span class="token string">"{\n"</span> <span class="token operator">+</span>
            <span class="token string">"  \"mappings\": {\n"</span> <span class="token operator">+</span>
            <span class="token string">"    \"properties\": {\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"id\": {\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"name\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"text\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"analyzer\": \"ik_max_word\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"copy_to\": \"all\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"address\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"index\": false\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"price\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"integer\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"score\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"integer\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"brand\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"copy_to\": \"all\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"city\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"copy_to\": \"all\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"starName\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"business\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"location\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"geo_point\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"pic\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"keyword\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"index\": false\n"</span> <span class="token operator">+</span>
            <span class="token string">"      },\n"</span> <span class="token operator">+</span>
            <span class="token string">"      \"all\":{\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"type\": \"text\",\n"</span> <span class="token operator">+</span>
            <span class="token string">"        \"analyzer\": \"ik_max_word\"\n"</span> <span class="token operator">+</span>
            <span class="token string">"      }\n"</span> <span class="token operator">+</span>
            <span class="token string">"    }\n"</span> <span class="token operator">+</span>
            <span class="token string">"  }\n"</span> <span class="token operator">+</span>
            <span class="token string">"}"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>编写单元测试，实现创建索引</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">createHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.创建Request对象</span>
    <span class="token class-name">CreateIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备请求的参数：DSL语句</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token constant">MAPPING_TEMPLATE</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_801"></a>删除索引库</h4> 
<p>删除索引库的DSL语句非常简单：</p> 
<pre><code class="prism language-json"><span class="token constant">DELETE</span> <span class="token operator">/</span>hotel
</code></pre> 
<p>与创建索引库相比有以下几点变化：</p> 
<ul><li>请求方式从PUT变为DELTE</li><li>请求路径不变</li><li>无请求参数</li></ul> 
<p>所以代码的差异，注意体现在Request对象上。</p> 
<ul><li>创建Request对象。这次是DeleteIndexRequest对象</li><li>准备参数。这里是无参</li><li>发送请求。改用delete方法</li></ul> 
<blockquote> 
 <p>编写单元测试，实现删除索引：</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testDeleteHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.创建Request对象</span>
    <span class="token class-name">DeleteIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteIndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.发送请求</span>
    client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_833"></a>判断索引库是否存在</h4> 
<p>判断索引库是否存在，本质就是查询，对应的DSL是：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>hotel
</code></pre> 
<p>因此与删除的Java代码流程是类似的。依然是三步走：</p> 
<ul><li>创建Request对象。这次是GetIndexRequest对象</li><li>准备参数。这里是无参</li><li>发送请求。改用exists方法</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testExistsHotelIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.创建Request对象</span>
    <span class="token class-name">GetIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetIndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.发送请求</span>
    <span class="token keyword">boolean</span> exists <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.输出</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>exists <span class="token operator">?</span> <span class="token string">"索引库已经存在！"</span> <span class="token operator">:</span> <span class="token string">"索引库不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_859"></a>总结</h4> 
<p>JavaRestClient操作elasticsearch的流程基本类似。核心是client.indices()方法来获取索引库的操作对象。</p> 
<p>索引库操作的基本步骤：</p> 
<ul><li>初始化RestHighLevelClient</li><li>创建XxxIndexRequest。XXX是Create、Get、Delete</li><li>准备DSL（ Create时需要，其它是无参）</li><li>发送请求。调用RestHighLevelClient#indices().xxx()方法，xxx是create、exists、delete</li></ul> 
<h3><a id="RestClient_870"></a>RestClient操作文档</h3> 
<p>为了与索引库操作分离，再次添加一个测试类</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelDocumentTest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IHotelService</span> hotelService<span class="token punctuation">;</span> <span class="token comment">// 利用IHotelService去查询酒店数据</span>
    
	<span class="token comment">// 初始化RestHighLevelClient</span>
    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> client<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span><span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                <span class="token class-name">HttpHost</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"http://192.168.150.101:9200"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">void</span> <span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>定义一个酒店实体类</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HotelDoc</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> price<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> score<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> brand<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> city<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> starName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> business<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> location<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> pic<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span><span class="token class-name">Hotel</span> hotel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>address <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brand <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getBrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>city <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>starName <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getStarName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>business <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getBusiness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>location <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> hotel<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pic <span class="token operator">=</span> hotel<span class="token punctuation">.</span><span class="token function">getPic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>前面已经知道了新增文档的DSL的语法格式</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>索引库名<span class="token operator">/</span>_doc<span class="token operator">/</span>文档id

<span class="token comment">// 举例说明</span>
<span class="token constant">POST</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"Jack"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"age"</span><span class="token operator">:</span> <span class="token number">21</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其对应的Java代码为</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testIndexDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.创建request对象</span>
    <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 2.准备JSON文档</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token string">"{\"name\": \"Jack\", \"age\": 21}"</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从代码中可以看出与创建索引库类似，也分为三步：</p> 
<ol><li>创建Request对象。</li><li>准备请求参数(DSL中的JSON文档)。</li><li>发送请求。</li></ol> 
<p>主要的变化在于，此处直接使用了client的API，不再使用client.indices()。</p> 
<p>这里结合了数据库查询的数据，将查询出来的数据转换成JSON的形式新增为文档。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testAddDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.根据id查询酒店数据</span>
    <span class="token class-name">Hotel</span> hotel <span class="token operator">=</span> hotelService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.转换为文档类型</span>
    <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.将HotelDoc转json</span>
    <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.准备Request对象</span>
    <span class="token class-name">IndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备Json文档</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_987"></a>查询文档</h4> 
<p>查询的DSL语句如下：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>id<span class="token punctuation">}</span>
</code></pre> 
<p>非常简单，因此代码大概分两步：</p> 
<ul><li>准备Request对象</li><li>发送请求</li></ul> 
<p>不过查询的目的是得到结果，解析为HotelDoc，因此难点是结果的解析。完整代码如下：</p> 
<p><img src="https://images2.imgbox.com/68/b3/IB4wMkjp_o.png" alt=""></p> 
<p>可以看到，结果是一个JSON，其中文档放在一个<code>_source</code>属性中，因此解析就是拿到<code>_source</code>，反序列化为Java对象即可。</p> 
<p>在测试类中，编写单元测试</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testGetDocumentById</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">GetRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">,</span> <span class="token string">"61082"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.发送请求，得到响应</span>
    <span class="token class-name">GetResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.解析响应结果</span>
    <span class="token class-name">String</span> json <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1023"></a>删除文档</h4> 
<p>删除的DSL的</p> 
<pre><code class="prism language-json"><span class="token constant">DELETE</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>id<span class="token punctuation">}</span>
</code></pre> 
<p>与查询相比，仅仅是请求方式从DELETE变成GET。</p> 
<p>单元测试方法</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testDeleteDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">DeleteRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">,</span> <span class="token string">"61083"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.发送请求</span>
    client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1045"></a>修改文档</h4> 
<p>修改有两种方式：</p> 
<ul><li>全量修改：本质是先根据id删除，再新增</li><li>增量修改：修改文档中的指定字段值</li></ul> 
<p>在RestClient的API中，全量修改与新增的API完全一致，判断依据是ID：</p> 
<ul><li>如果新增时，ID已经存在，则修改</li><li>如果新增时，ID不存在，则新增</li></ul> 
<p>这里主要关注增量修改。</p> 
<p>代码示例</p> 
<p><img src="https://images2.imgbox.com/36/e6/qQu54Nqs_o.png" alt=""></p> 
<ul><li>准备Request对象。这次是修改，所以是UpdateRequest</li><li>准备参数。也就是JSON文档，里面包含要修改的字段</li><li>更新文档。这里调用client.update()方法</li></ul> 
<p>单元测试方法</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testUpdateDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">UpdateRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">,</span> <span class="token string">"61083"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备请求参数</span>
    request<span class="token punctuation">.</span><span class="token function">doc</span><span class="token punctuation">(</span>
        <span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token string">"952"</span><span class="token punctuation">,</span>
        <span class="token string">"starName"</span><span class="token punctuation">,</span> <span class="token string">"四钻"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    client<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1084"></a>批量导入文档</h4> 
<p>批量处理BulkRequest，其本质就是将多个普通的CRUD请求组合在一起发送。</p> 
<p>其中提供了一个add方法，用来添加其他请求：</p> 
<p><img src="https://images2.imgbox.com/ae/49/DVHfLAGk_o.png" alt=""></p> 
<p>可以看到，能添加的请求包括：</p> 
<ul><li>IndexRequest，也就是新增</li><li>UpdateRequest，也就是修改</li><li>DeleteRequest，也就是删除</li></ul> 
<p>因此Bulk中添加了多个IndexRequest，就是批量新增功能了。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testBulk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.创建Bulk请求</span>
    <span class="token class-name">BulkRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 2.添加要批量提交的请求：这里添加了两个新增文档的请求</span>
    request<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"101"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token string">"json source"</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"102"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token string">"json source2"</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发起bulk请求</span>
    client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里与上面的不同之处在于Request对象为BulkRequest。调用的请求方法为client.bulk()。</p> 
<p>单元测试方法</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testBulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 批量查询酒店数据</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hotel</span><span class="token punctuation">&gt;</span></span> hotels <span class="token operator">=</span> hotelService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.创建Request</span>
    <span class="token class-name">BulkRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备参数，添加多个新增的Request</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Hotel</span> hotel <span class="token operator">:</span> hotels<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 2.1.转换为文档类型HotelDoc</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">(</span>hotel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.2.创建新增文档的Request对象</span>
        request<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>hotelDoc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span><span class="token constant">JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.发送请求</span>
    client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="DSL_1141"></a>DSL查询文档</h3> 
<p>Elasticsearch的查询依然是基于JSON风格的DSL来实现的。</p> 
<h4><a id="DSL_1145"></a>DSL查询分类</h4> 
<p>Elasticsearch提供了基于JSON的DSL（<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" rel="nofollow">Domain Specific Language</a>）来定义查询。常见的查询类型包括：</p> 
<ul><li> <p><strong>查询所有</strong>：查询出所有数据，一般测试用。例如：match_all</p> </li><li> <p><strong>全文检索（full text）查询</strong>：利用分词器对用户输入内容分词，然后去倒排索引库中匹配。例如：</p> 
  <ul><li>match_query</li><li>multi_match_query</li></ul> </li><li> <p><strong>精确查询</strong>：根据精确词条值查找数据，一般是查找keyword、数值、日期、boolean等类型字段。例如：</p> 
  <ul><li>ids</li><li>range</li><li>term</li></ul> </li><li> <p><strong>地理（geo）查询</strong>：根据经纬度查询。例如：</p> 
  <ul><li>geo_distance</li><li>geo_bounding_box</li></ul> </li><li> <p><strong>复合（compound）查询</strong>：复合查询可以将上述各种查询条件组合起来，合并查询条件。例如：</p> 
  <ul><li>bool</li><li>function_score</li></ul> </li></ul> 
<p>语法格式：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"查询类型"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"查询条件"</span><span class="token operator">:</span> <span class="token string">"条件值"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们以查询所有为例，其中：</p> 
<ul><li>查询类型为match_all</li><li>没有查询条件</li></ul> 
<pre><code class="prism language-json"><span class="token comment">// 查询所有</span>
<span class="token constant">GET</span> <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其它查询无非就是<strong>查询类型</strong>、<strong>查询条件</strong>的变化。</p> 
<h4><a id="_1196"></a>全文检索查询</h4> 
<p>全文检索查询的基本流程如下：</p> 
<ul><li>对用户搜索的内容做分词，得到词条。</li><li>根据词条去倒排索引库中匹配，得到文档id。</li><li>根据文档id找到文档，返回给用户。</li></ul> 
<p>因为是拿着词条去匹配，因此参与搜索的字段也必须是可分词的text类型的字段。</p> 
<h5><a id="_1206"></a>基本语法</h5> 
<p>常见的全文检索查询包括：</p> 
<ul><li><strong>match</strong>查询：单字段查询(根据一个字段查询)</li><li><strong>multi_match</strong>查询：多字段查询，任意一个字段符合条件就算符合查询条件(根据多个字段查询，参与查询字段越多，查询性能越差)。</li></ul> 
<p>match查询语法格式：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"TEXT"</span> <span class="token comment">// FIELD：字段名</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>mulit_match语法格式：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"multi_match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"TEXT"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"FIELD1"</span><span class="token punctuation">,</span> <span class="token string">" FIELD12"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1240"></a>精准查询</h4> 
<p>精确查询一般是查找keyword、数值、日期、boolean等类型字段。所以<strong>不会</strong>对搜索条件分词。常见的有：</p> 
<ul><li>term：根据词条精确查询，一般搜索keyword类型、数值类型、布尔类型、日期类型字段</li><li>range：根据值的范围查询，可以是数值、日期的范围</li></ul> 
<h5><a id="term_1247"></a>term查询</h5> 
<p>因为精确查询的字段搜是不分词的字段，因此查询的条件也必须是<strong>不分词</strong>的词条。查询时，用户输入的内容跟自动值完全匹配时才认为符合条件。如果用户输入的内容过多，反而搜索不到数据。</p> 
<p>语法格式：</p> 
<pre><code class="prism language-json"><span class="token comment">// term查询</span>
<span class="token constant">GET</span> <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// FIELD：字段名</span>
        <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"VALUE"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="range_1267"></a>range查询</h5> 
<p>范围查询，一般应用在对数值类型做范围过滤的时候。比如做价格范围过滤。</p> 
<p>语法格式：</p> 
<pre><code class="prism language-json"><span class="token comment">// range查询</span>
<span class="token constant">GET</span> <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// FIELD：字段名</span>
        <span class="token string-property property">"gte"</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token comment">// 这里的gte代表大于等于，gt则代表大于</span>
        <span class="token string-property property">"lte"</span><span class="token operator">:</span> <span class="token number">200</span> <span class="token comment">// lte代表小于等于，lt则代表小于</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1288"></a>地理坐标查询</h4> 
<p>所谓的地理坐标查询，其实就是根据经纬度查询。</p> 
<p>官方文档：https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-queries.html</p> 
<p>常见的使用场景包括：</p> 
<ul><li>携程：搜索附近的酒店。</li><li>滴滴：搜索附近的出租车。</li><li>微信：搜索附近的人。</li></ul> 
<h5><a id="_1300"></a>矩形范围查询</h5> 
<p>矩形范围查询，也就是geo_bounding_box查询，查询坐标落在某个矩形范围的所有文档：</p> 
<p><img src="https://images2.imgbox.com/64/02/5CJTFJkw_o.gif" alt=""></p> 
<p>查询时，需要指定矩形的<strong>左上</strong>、<strong>右下</strong>两个点的坐标，然后画出一个矩形，落在该矩形内的都是符合条件的点。</p> 
<p>语法格式：</p> 
<pre><code class="prism language-json"><span class="token comment">// geo_bounding_box查询</span>
<span class="token constant">GET</span> <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"geo_bounding_box"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"top_left"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 左上点</span>
          <span class="token string-property property">"lat"</span><span class="token operator">:</span> <span class="token number">31.1</span><span class="token punctuation">,</span>
          <span class="token string-property property">"lon"</span><span class="token operator">:</span> <span class="token number">121.5</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"bottom_right"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 右下点</span>
          <span class="token string-property property">"lat"</span><span class="token operator">:</span> <span class="token number">30.9</span><span class="token punctuation">,</span>
          <span class="token string-property property">"lon"</span><span class="token operator">:</span> <span class="token number">121.7</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_1331"></a>附近查询</h5> 
<p>附近查询，也叫做距离查询（geo_distance）：查询到指定中心点小于某个距离值的所有文档。</p> 
<p>在地图上找一个点作为圆心，以指定距离为半径，画一个圆，落在圆内的坐标都算符合条件：</p> 
<p><img src="https://images2.imgbox.com/2f/4e/UdFECof1_o.gif" alt=""></p> 
<p>语法说明：</p> 
<pre><code class="prism language-json"><span class="token comment">// geo_distance 查询</span>
<span class="token constant">GET</span> <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"geo_distance"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"distance"</span><span class="token operator">:</span> <span class="token string">"15km"</span><span class="token punctuation">,</span> <span class="token comment">// 半径</span>
      <span class="token string-property property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"31.21,121.5"</span> <span class="token comment">// 圆心</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1354"></a>复合查询</h4> 
<p>复合（compound）查询：复合查询可以将其它简单查询组合起来，实现更复杂的搜索逻辑。常见的有两种：</p> 
<ul><li>fuction score：算分函数查询，可以控制文档相关性算分，控制文档排名。</li><li>bool query：布尔查询，利用逻辑关系组合多个其它的查询，实现复杂搜索。</li></ul> 
<h5><a id="_1361"></a>相关性算分</h5> 
<p>在Elasticsearch中，早期使用的打分算法是TF-IDF算法，公式如下：</p> 
<p><img src="https://images2.imgbox.com/51/2a/FYZfBlp8_o.png" alt=""></p> 
<p>在后来的5.1版本升级中，elasticsearch将算法改进为BM25算法，公式如下：</p> 
<p><img src="https://images2.imgbox.com/4b/38/crp3Gyvi_o.png" alt=""></p> 
<p>TF-IDF算法有一各缺陷，就是词条频率越高，文档得分也会越高，单个词条对文档影响较大。而BM25则会让单个词条的算分有一个上限，曲线更加平滑：</p> 
<p><img src="https://images2.imgbox.com/46/d0/vF1ZA0u4_o.png" alt=""></p> 
<h5><a id="_1375"></a>算分函数查询</h5> 
<p>根据相关度打分是比较合理的需求，但<strong>合理的不一定是产品经理需要</strong>的。</p> 
<p>要想认为控制相关性算分，就需要利用elasticsearch中的function score 查询了。</p> 
<blockquote> 
 <p>语法说明</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/c0/81/j2qVuk32_o.png" alt=""></p> 
<p>function score 查询中包含四部分内容：</p> 
<ul><li><strong>原始查询</strong>条件：query部分，基于这个条件搜索文档，并且基于BM25算法给文档打分，<strong>原始算分</strong>（query score)</li><li><strong>过滤条件</strong>：filter部分，符合该条件的文档才会重新算分</li><li><strong>算分函数</strong>：符合filter条件的文档要根据这个函数做运算，得到的<strong>函数算分</strong>（function score），有四种函数 
  <ul><li>weight：函数结果是常量</li><li>field_value_factor：以文档中的某个字段值作为函数结果</li><li>random_score：以随机数作为函数结果</li><li>script_score：自定义算分函数算法</li></ul> </li><li><strong>运算模式</strong>：算分函数的结果、原始查询的相关性算分，两者之间的运算方式，包括： 
  <ul><li>multiply：相乘</li><li>replace：用function score替换query score</li><li>其它，例如：sum、avg、max、min</li></ul> </li></ul> 
<p>function score的运行流程如下：</p> 
<ul><li>1）根据<strong>原始条件</strong>查询搜索文档，并且计算相关性算分，称为<strong>原始算分</strong>（query score）</li><li>2）根据<strong>过滤条件</strong>，过滤文档</li><li>3）符合<strong>过滤条件</strong>的文档，基于<strong>算分函数</strong>运算，得到<strong>函数算分</strong>（function score）</li><li>4）将<strong>原始算分</strong>（query score）和<strong>函数算分</strong>（function score）基于<strong>运算模式</strong>做运算，得到最终结果，作为相关性算分。</li></ul> 
<p>因此，其中的关键点是：</p> 
<ul><li>过滤条件：决定哪些文档的算分被修改</li><li>算分函数：决定函数算分的算法</li><li>运算模式：决定最终算分结果</li></ul> 
<h5><a id="_1412"></a>布尔查询</h5> 
<p>布尔查询是一个或多个查询子句的组合，每一个子句就是一个<strong>子查询</strong>。子查询的组合方式有：</p> 
<ul><li>must：必须匹配每个子查询，类似“与”</li><li>should：选择性匹配子查询，类似“或”</li><li>must_not：必须不匹配，<strong>不参与算分</strong>，类似“非”</li><li>filter：必须匹配，<strong>不参与算分</strong></li></ul> 
<p>每一个不同的字段，其查询的条件、方式都不一样，必须是多个不同的查询，而要组合这些查询，就必须用bool查询了。</p> 
<p>需要注意的是，搜索时，参与<strong>打分的字段越多，查询的性能也越差</strong>。因此这种多条件查询时，建议这样做：</p> 
<ul><li>搜索框的关键字搜索，是全文检索查询，使用must查询，参与算分</li><li>其它过滤条件，采用filter查询。不参与算分</li></ul> 
<h4><a id="_1428"></a>搜索结果处理</h4> 
<p>搜索的结果可以按照用户指定的方式去处理或展示。</p> 
<h5><a id="_1432"></a>排序</h5> 
<p>Elasticsearch默认是根据相关度算分（_score）来排序，但是也支持自定义方式对搜索<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html" rel="nofollow">结果排序</a>。可以排序字段类型有：keyword类型、数值类型、地理坐标类型、日期类型等。</p> 
<blockquote> 
 <p>普通字段排序</p> 
</blockquote> 
<p>keyword、数值、日期类型排序的语法基本一致。</p> 
<p><strong>语法</strong>：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"desc"</span>  <span class="token comment">// 排序字段、排序方式ASC、DESC</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>排序条件是一个数组，也就是可以写多个排序条件。按照声明的顺序，当第一个条件相等时，再按照第二个条件排序，以此类推。</p> 
<blockquote> 
 <p>地理坐标排序</p> 
</blockquote> 
<p>这个查询的含义是：</p> 
<ul><li>指定一个坐标，作为目标点(中心点)</li><li>计算每一个文档中，指定字段（必须是geo_point类型）的坐标到目标点的距离是多少</li><li>根据距离排序</li></ul> 
<p><strong>语法说明</strong>：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>indexName<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"_geo_distance"</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"FIELD"</span> <span class="token operator">:</span> <span class="token string">"纬度，经度"</span><span class="token punctuation">,</span> <span class="token comment">// 文档中geo_point类型的字段名、目标坐标点</span>
          <span class="token string-property property">"order"</span> <span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">,</span> <span class="token comment">// 排序方式</span>
          <span class="token string-property property">"unit"</span> <span class="token operator">:</span> <span class="token string">"km"</span> <span class="token comment">// 排序的距离单位</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>获取你的位置的经纬度的方式：<a href="https://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat/" rel="nofollow">https://lbs.amap.com/demo/jsapi-v2/example/map/click-to-get-lnglat/</a></p> 
<h5><a id="_1488"></a>分页</h5> 
<p>Elasticsearch 默认情况下只返回top10的数据。而如果要查询更多数据就需要修改分页参数了。elasticsearch中通过修改from、size参数来控制要返回的分页结果：</p> 
<ul><li>from：从第几个文档开始</li><li>size：总共查询几个文档</li></ul> 
<blockquote> 
 <p>基础分页</p> 
</blockquote> 
<p>语法格式</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"from"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 分页开始的位置，默认为0</span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 期望获取的文档总数</span>
  <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>深度分页问题</p> 
</blockquote> 
<p>要查询9900~10000的数据，查询逻辑应该这么写</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"from"</span><span class="token operator">:</span> <span class="token number">9900</span><span class="token punctuation">,</span> <span class="token comment">// 分页开始的位置，默认为0</span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// 期望获取的文档总数</span>
  <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token string">"asc"</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里是查询9900开始的数据，也就是 第9900~第10000条 数据。</p> 
<p>不过，Elasticsearch内部分页时，必须先查询 0~10000条，然后截取其中的9900 ~ 10000的这10条</p> 
<p><img src="https://images2.imgbox.com/26/61/GpEd2SmX_o.png" alt="image-20230701171746194"></p> 
<p>查询TOP10000，如果ES是单点模式，这并无太大影响。</p> 
<p>但是Elasticsearch将来一定是集群，例如我集群有10个节点，我要查询TOP10000的数据，并不是每个节点查询1000条就可以了。</p> 
<p>因为节点A的TO1P000，在另一个节点可能排到100000名以外了。</p> 
<p>因此要想获取整个集群的TOP10000，必须先查询出每个节点的TOP10000，汇总结果后，重新排名，重新截取TOP10000。</p> 
<p><img src="https://images2.imgbox.com/d4/47/BGuvIzeS_o.png" alt="image-20230701171941022"></p> 
<p>当查询分页深度较大时，汇总数据过多，对内存和CPU会产生非常大的压力，因此elasticsearch会禁止from+ size 超过10000的请求。</p> 
<p>针对深度分页，ES提供了两种解决方案，</p> 
<p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html</a></p> 
<ul><li>search after：分页时需要排序，原理是从上一次的排序值开始，查询下一页数据。官方推荐使用的方式。</li><li>scroll：原理将排序后的文档id形成快照，保存在内存(官方已经不推荐使用)。</li></ul> 
<blockquote> 
 <p>三种分页查询的实现方案及其优缺点</p> 
</blockquote> 
<p><code>from + size</code>：</p> 
<ul><li>优点：支持随机翻页</li><li>缺点：深度分页问题，默认查询上限（from + size）是10000</li><li>场景：百度、京东、谷歌、淘宝这样的随机翻页搜索</li></ul> 
<p><code>after search</code>：</p> 
<ul><li>优点：没有查询上限（单次查询的size不超过10000）</li><li>缺点：只能向后逐页查询，不支持随机翻页</li><li>场景：没有随机翻页需求的搜索，例如手机向下滚动翻页</li></ul> 
<p><code>scroll</code>：</p> 
<ul><li>优点：没有查询上限（单次查询的size不超过10000）</li><li>缺点：会有额外内存消耗，并且搜索结果是非实时的</li><li>场景：海量数据的获取和迁移。从ES7.1开始不推荐，建议用 after search方案。</li></ul> 
<h4><a id="_1578"></a>高亮</h4> 
<h5><a id="_1580"></a>原理</h5> 
<p>日常生活中，在百度搜索时，关键字会变成红色，比较醒目，这便是高亮显示。</p> 
<p><img src="https://images2.imgbox.com/db/f1/OxxHr9Qq_o.png" alt=""></p> 
<p>高亮显示的实现分为两步：</p> 
<ul><li>给文档中的所有关键字都添加一个标签，例如<code>&lt;em&gt;</code>标签</li><li>页面给<code>&lt;em&gt;</code>标签编写CSS样式</li></ul> 
<h5><a id="_1591"></a>实现</h5> 
<p><strong>高亮的语法</strong>：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"FIELD"</span><span class="token operator">:</span> <span class="token string">"TEXT"</span> <span class="token comment">// 查询条件，高亮一定要使用全文检索查询</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 指定要高亮的字段</span>
      <span class="token string-property property">"FIELD"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"pre_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;em&gt;"</span><span class="token punctuation">,</span>  <span class="token comment">// 用来标记高亮字段的前置标签</span>
        <span class="token string-property property">"post_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;/em&gt;"</span> <span class="token comment">// 用来标记高亮字段的后置标签</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>注意：</strong></p> 
<ul><li>高亮是对关键字高亮，因此<strong>搜索条件必须带有关键字</strong>，而不能是范围这样的查询。</li><li>默认情况下，<strong>高亮的字段，必须与搜索指定的字段一致</strong>，否则无法高亮</li><li>如果要对非搜索字段高亮，则需要添加一个属性：required_field_match=false</li></ul> 
<h3><a id="RestClient_1620"></a>RestClient查询文档</h3> 
<p>文档的查询同样适用昨天学习的 RestHighLevelClient对象，基本步骤包括：</p> 
<ul><li>1）准备Request对象</li><li>2）准备请求参数</li><li>3）发起请求</li><li>4）解析响应</li></ul> 
<h4><a id="_1629"></a>查询请求</h4> 
<p>代码演示：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testMatchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.组织DSL参数 </span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求，得到响应结果</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...解析响应结果</span>
<span class="token punctuation">}</span>

<span class="token comment">// 对比DSL的查询请求</span>
<span class="token comment">//GET /indexName/_search</span>
<span class="token comment">//{<!-- --></span>
<span class="token comment">//  "query": {<!-- --></span>
<span class="token comment">//    "match_all": {}</span>
<span class="token comment">//  }</span>
<span class="token comment">//}</span>
</code></pre> 
<ul><li> <p>第一步，创建<code>SearchRequest</code>对象，指定索引库名。</p> </li><li> <p>第二步，利用<code>request.source()</code>构建DSL，DSL中可以包含查询、分页、排序、高亮等。</p> 
  <ul><li><code>query()</code>：代表查询条件，利用<code>QueryBuilders.matchAllQuery()</code>构建一个match_all查询的DSL。</li></ul> </li><li> <p>第三步，利用client.search()发送请求，得到响应。</p> </li></ul> 
<p>这里关键的API有两个，一个是<code>request.source()</code>，其中包含了查询、排序、分页、高亮等所有功能：</p> 
<p><img src="https://images2.imgbox.com/e0/48/zB1LNQLY_o.png" alt=""></p> 
<p>另一个是<code>QueryBuilders</code>，其中包含match、term、function_score、bool等各种查询：</p> 
<p><img src="https://images2.imgbox.com/92/fb/XDPZSUse_o.png" alt=""></p> 
<h4><a id="_1669"></a>解析响应</h4> 
<p>响应结果的解析：</p> 
<p><img src="https://images2.imgbox.com/d3/ce/ZmdjXg80_o.png" alt="image-20230701173852465"></p> 
<p>elasticsearch返回的结果是一个JSON字符串，结构包含：</p> 
<ul><li><code>hits</code>：命中的结果 
  <ul><li><code>total</code>：总条数，其中的value是具体的总条数值</li><li><code>max_score</code>：所有结果中得分最高的文档的相关性算分</li><li><code>hits</code>：搜索结果的文档数组，其中的每个文档都是一个json对象 
    <ul><li><code>_source</code>：文档中的原始数据，也是json对象</li></ul> </li></ul> </li></ul> 
<p>因此，解析响应结果，就是逐层解析JSON字符串，流程如下：</p> 
<ul><li><code>SearchHits</code>：通过response.getHits()获取，就是JSON中的最外层的hits，代表命中的结果。 
  <ul><li><code>SearchHits.getTotalHits().value</code>：获取总条数信息。</li><li><code>SearchHits.getHits()</code>：获取SearchHit数组，也就是文档数组。 
    <ul><li><code>SearchHit.getSourceAsString()</code>：获取文档结果中的_source，也就是原始的json文档数据。</li></ul> </li></ul> </li></ul> 
<blockquote> 
 <p>完整的查询代码</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testMatchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备DSL</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4.解析响应</span>
    <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.1.获取总条数</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> total <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.2.文档数组</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.3.遍历</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取文档source</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 反序列化</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc = "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>查询的基本步骤是：</p> 
<ol><li> <p>创建SearchRequest对象</p> </li><li> <p>准备Request.source()，也就是DSL。</p> <p>① QueryBuilders来构建查询条件</p> <p>② 传入Request.source() 的 query() 方法</p> </li><li> <p>发送请求，得到结果</p> </li><li> <p>解析结果（参考JSON结果，从外到内，逐层解析）</p> </li></ol> 
<h4><a id="match_1740"></a>match查询</h4> 
<p>全文检索的match和multi_match查询与match_all的API基本一致。差别是查询条件，也就是query的部分。</p> 
<p><img src="https://images2.imgbox.com/8a/d3/8pP2Lwjq_o.png" alt=""></p> 
<p>因此，Java代码上的差异主要是request.source().query()中的参数了。同样是利用QueryBuilders提供的方法：</p> 
<p><img src="https://images2.imgbox.com/88/1f/VPpRarrl_o.png" alt=""></p> 
<p>而结果解析代码则完全一致，可以抽取并共享。</p> 
<p>完整代码：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备DSL</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span> <span class="token string">"如家"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1774"></a>精确查询</h4> 
<p>精确查询主要是两者：</p> 
<ul><li>term：词条精确匹配</li><li>range：范围查询</li></ul> 
<p>与之前的查询相比，差异同样在查询条件，其它都一样。</p> 
<p>查询条件构造的API如下：</p> 
<p><img src="https://images2.imgbox.com/65/e0/Y911Ndl2_o.png" alt=""></p> 
<h4><a id="_1787"></a>布尔查询</h4> 
<p>布尔查询是用must、must_not、filter等方式组合其它查询，代码示例如下：</p> 
<p><img src="https://images2.imgbox.com/7e/7e/5U5alM6a_o.png" alt=""></p> 
<p>可以看到，API与其它查询的差别同样是在查询条件的构建，QueryBuilders，结果解析等其他代码完全不变。</p> 
<p>完整代码：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testBool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备DSL</span>
    <span class="token comment">// 2.1.准备BooleanQuery</span>
    <span class="token class-name">BoolQueryBuilder</span> boolQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.2.添加term</span>
    boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">,</span> <span class="token string">"杭州"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.3.添加range</span>
    boolQuery<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1819"></a>排序与分页</h4> 
<p>搜索结果的排序和分页是与query同级的参数，因此同样是使用request.source()来设置。</p> 
<p>对应的API如下：</p> 
<p><img src="https://images2.imgbox.com/91/bb/Vb0vjR9R_o.png" alt=""></p> 
<p>完整代码：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testPageAndSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 页码，每页大小</span>
    <span class="token keyword">int</span> page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备DSL</span>
    <span class="token comment">// 2.1.query</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchAllQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.2.排序 sort</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">,</span> <span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">ASC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.3.分页 from、size</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="36_1852"></a>3.6.高亮</h3> 
<p>高亮的代码与之前代码有两点差异较大：</p> 
<ul><li>查询的DSL：其中除了查询条件，还需要添加高亮条件，同样是与query同级。</li><li>结果解析：结果除了要解析_source文档数据，还要解析高亮结果</li></ul> 
<h4><a id="361_1859"></a>3.6.1.高亮请求构建</h4> 
<p>高亮请求的构建API如下：</p> 
<p><img src="https://images2.imgbox.com/35/70/O6rIbJkB_o.png" alt=""></p> 
<p>高亮查询必须使用全文检索查询，并且要有搜索关键字，将来才可以对关键字高亮。</p> 
<p>完整代码：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testHighlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.准备Request</span>
    <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">"hotel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.准备DSL</span>
    <span class="token comment">// 2.1.query</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">,</span> <span class="token string">"如家"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.2.高亮</span>
    request<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requireFieldMatch</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3.发送请求</span>
    <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token function">handleResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="362_1889"></a>3.6.2.高亮结果解析</h4> 
<p>高亮的结果与查询的文档结果默认是分离的，并不在一起。</p> 
<p>因此解析高亮的代码需要额外处理：</p> 
<ul><li>第一步：从结果中获取source。hit.getSourceAsString()，这部分是非高亮结果，json字符串。还需要反序列为HotelDoc对象</li><li>第二步：获取高亮结果。hit.getHighlightFields()，返回值是一个Map，key是高亮字段名称，值是HighlightField对象，代表高亮值</li><li>第三步：从map中根据高亮字段名称，获取高亮字段值对象HighlightField</li><li>第四步：从HighlightField中获取Fragments，并且转为字符串。这部分就是真正的高亮字符串了</li><li>第五步：用高亮的结果替换HotelDoc中的非高亮结果</li></ul> 
<p><img src="https://images2.imgbox.com/04/b6/M4KFBWuF_o.png" alt=""></p> 
<p>完整代码：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 4.解析响应</span>
    <span class="token class-name">SearchHits</span> searchHits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.1.获取总条数</span>
    <span class="token keyword">long</span> total <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"共搜索到"</span> <span class="token operator">+</span> total <span class="token operator">+</span> <span class="token string">"条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.2.文档数组</span>
    <span class="token class-name">SearchHit</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hits <span class="token operator">=</span> searchHits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.3.遍历</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取文档source</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 反序列化</span>
        <span class="token class-name">HotelDoc</span> hotelDoc <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">HotelDoc</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取高亮结果</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HighlightField</span><span class="token punctuation">&gt;</span></span> highlightFields <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>highlightFields<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 根据字段名获取高亮结果</span>
            <span class="token class-name">HighlightField</span> highlightField <span class="token operator">=</span> highlightFields<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>highlightField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 获取高亮值</span>
                <span class="token class-name">String</span> name <span class="token operator">=</span> highlightField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 覆盖非高亮结果</span>
                hotelDoc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hotelDoc = "</span> <span class="token operator">+</span> hotelDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_1937"></a>数据聚合</h3> 
<p>聚合可以极其方便的实现对数据的统计、分析、运算。</p> 
<p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html</a></p> 
<p>实现这些统计功能的比数据库的sql要方便的多，而且查询速度非常快，可以实现近实时搜索效果。</p> 
<h4><a id="_1945"></a>聚合的种类</h4> 
<p>**注意：**参加聚合的字段必须是keyword、日期、数值、布尔类型</p> 
<p>聚合常见的有三类：</p> 
<ul><li> <p>**桶（Bucket）**聚合：用来对文档做分组</p> 
  <ul><li>TermAggregation：按照文档字段值分组，例如按照品牌值分组、按照国家分组</li><li>Date Histogram：按照日期阶梯分组，例如一周为一组，或者一月为一组</li></ul> </li><li> <p>**度量（Metric）**聚合：用以计算一些值，比如：最大值、最小值、平均值等</p> 
  <ul><li>Avg：求平均值</li><li>Max：求最大值</li><li>Min：求最小值</li><li>Stats：同时求max、min、avg、sum等</li></ul> </li><li> <p>**管道（pipeline）**聚合：其它聚合的结果为基础做聚合</p> </li></ul> 
<h4><a id="DSL_1962"></a>DSL实现聚合</h4> 
<p>日常中要统计所有数据中的分类有几种，其实就是要按照分类对数据分组，也就是Bucket聚合。</p> 
<h5><a id="Bucket_1966"></a>Bucket聚合语法</h5> 
<p>语法格式</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">// 设置size为0，结果中不包含文档，只包含聚合结果</span>
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 定义聚合</span>
    <span class="token string-property property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//给聚合起个名字</span>
      <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 聚合的类型，按照品牌值聚合，所以选择term</span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span> <span class="token comment">// 参与聚合的字段</span>
        <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token comment">// 希望获取的聚合结果数量</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_1985"></a>聚合结果排序</h5> 
<p>默认情况下，Bucket聚合会 Bucket 内的文档数量，记为_count，并且按照_count降序排序。</p> 
<p>可以指定order属性，自定义聚合的排序方式。</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"order"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"_count"</span><span class="token operator">:</span> <span class="token string">"asc"</span> <span class="token comment">// 按照_count升序排列</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_2009"></a>限定聚合范围</h5> 
<p>默认情况下，Bucket聚合是对索引库的所有文档做聚合，但真实场景下，用户会输入搜索条件，因此聚合必须是对搜索结果聚合。那么聚合必须添加限定条件。</p> 
<p>可以限定要聚合的文档范围，只要添加query条件即可</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"lte"</span><span class="token operator">:</span> <span class="token number">200</span> <span class="token comment">// 只对200元以下的文档聚合</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="Metric_2037"></a>Metric聚合语法</h5> 
<p>可以对桶内的数据进行运算，获得每个品牌的用户评分的min、max、avg等值。</p> 
<p>这里就要用到Metric聚合，例如stat聚合：就可以获取min、max、avg等结果。</p> 
<p>语法格式如下：</p> 
<pre><code class="prism language-json"><span class="token constant">GET</span> <span class="token operator">/</span>hotel<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
  <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"brandAgg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> 
      <span class="token string-property property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"brand"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">20</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 是brands聚合的子聚合，也就是分组后对每组分别计算</span>
        <span class="token string-property property">"score_stats"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 聚合名称</span>
          <span class="token string-property property">"stats"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 聚合类型，这里stats可以计算min、max、avg等</span>
            <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"score"</span> <span class="token comment">// 聚合字段，这里是score</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这次的score_stats聚合是在brandAgg的聚合内部嵌套的子聚合。因此需要在每个桶分别计算。</p> 
<h3><a id="RestAPI_2069"></a>RestAPI实现聚合</h3> 
<h4><a id="API_2071"></a>API语法</h4> 
<p>聚合条件与query条件同级别，因此需要使用request.source()来指定聚合条件。</p> 
<p>聚合条件的语法格式：</p> 
<p><img src="https://images2.imgbox.com/16/f9/G0XGE6U0_o.png" alt=""></p> 
<p>聚合的结果也与查询结果不同，API也比较特殊。不过同样是JSON逐层解析：</p> 
<p><img src="https://images2.imgbox.com/82/c2/7dddeR6I_o.png" alt=""></p> 
<h3><a id="_2083"></a>自动补全</h3> 
<p>在日常的搜索中，当用户在搜索框中输入字符时，就会提示出相关的搜索项。</p> 
<p><img src="https://images2.imgbox.com/bc/9e/08ZP18Bh_o.png" alt="image-20230702130143229"></p> 
<p>这种根据用户输入的字母，提示完整词条的功能即为自动补全。</p> 
<p>因为可能需要根据拼音字母来推断，因此要用到拼音分词功能。</p> 
<h4><a id="_2093"></a>拼音分词器</h4> 
<p>要实现根据字母做补全，就必须对文档按照拼音分词。在GitHub上恰好有elasticsearch的拼音分词插件。</p> 
<p>地址：<a href="https://github.com/medcl/elasticsearch-analysis-pinyin">https://github.com/medcl/elasticsearch-analysis-pinyin</a></p> 
<p><img src="https://images2.imgbox.com/41/63/XhU82eR3_o.png" alt=""></p> 
<p>安装方式：</p> 
<ol><li>下载解压(注意要与elasticsearch的版本保持一致：7.12.1)。</li><li>上传至虚拟机中的elasticsearch的plugin目录。</li><li>重启elasticsearch</li></ol> 
<p><mark>详细安装步骤可以查看IK分词器的安装过程。</mark></p> 
<blockquote> 
 <p>测试用法</p> 
</blockquote> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>_analyze
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"今天天气真好"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试结果</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"tokens"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"jin"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"jttqzh"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"tian"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"tian"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"qi"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"zhen"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">4</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"token"</span> <span class="token operator">:</span> <span class="token string">"hao"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"start_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"end_offset"</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token string-property property">"type"</span> <span class="token operator">:</span> <span class="token string">"word"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"position"</span> <span class="token operator">:</span> <span class="token number">5</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_2177"></a>自定义分词器</h4> 
<p>默认的拼音分词器会将每个汉字单独分为拼音，而我们希望的是每个词条形成一组拼音，需要对拼音分词器做个性化定制，形成自定义分词器。</p> 
<p>elasticsearch中分词器（analyzer）的组成包含三部分：</p> 
<ul><li>character filters：在tokenizer之前对文本进行处理。例如删除字符、替换字符</li><li>tokenizer：将文本按照一定的规则切割成词条（term）。例如keyword，就是不分词；还有ik_smart</li><li>tokenizer filter：将tokenizer输出的词条做进一步处理。例如大小写转换、同义词处理、拼音处理等</li></ul> 
<p>文档分词时会依次由这三部分来处理文档：</p> 
<p><img src="https://images2.imgbox.com/69/39/q5haqVH4_o.png" alt="image-20230702150508682"></p> 
<p>声明自定义分词器的语法格式：</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>test
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 自定义分词器</span>
        <span class="token string-property property">"my_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">// 分词器名称</span>
          <span class="token string-property property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"ik_max_word"</span><span class="token punctuation">,</span>
          <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token string">"py"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 自定义tokenizer filter</span>
        <span class="token string-property property">"py"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 过滤器名称</span>
          <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"pinyin"</span><span class="token punctuation">,</span> <span class="token comment">// 过滤器类型，这里是pinyin</span>
		  <span class="token string-property property">"keep_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token string-property property">"keep_joined_full_pinyin"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token string-property property">"keep_original"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token string-property property">"limit_first_letter_length"</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
          <span class="token string-property property">"remove_duplicated_term"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token string-property property">"none_chinese_pinyin_tokenize"</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"my_analyzer"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"search_analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_2229"></a>自动补全查询</h4> 
<p>elasticsearch提供了Completion Suggester查询来实现自动补全功能。这个查询会匹配以用户输入内容开头的词条并返回。为了提高补全查询的效率，对于文档中字段的类型有一些约束：</p> 
<ul><li> <p>参与补全查询的字段必须是<strong>completion</strong>类型。</p> </li><li> <p>字段的内容一般是用来补全的多个词条形成的数组。</p> </li></ul> 
<p>官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html" rel="nofollow">https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html</a></p> 
<blockquote> 
 <p>举例</p> 
</blockquote> 
<p>一个这样的索引库：</p> 
<pre><code class="prism language-json"><span class="token comment">// 创建索引库</span>
<span class="token constant">PUT</span> test
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"title"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"completion"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后插入下面的数据：</p> 
<pre><code class="prism language-json"><span class="token comment">// 示例数据</span>
<span class="token constant">POST</span> test<span class="token operator">/</span>_doc
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Sony"</span><span class="token punctuation">,</span> <span class="token string">"WH-1000XM3"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">POST</span> test<span class="token operator">/</span>_doc
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"SK-II"</span><span class="token punctuation">,</span> <span class="token string">"PITERA"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token constant">POST</span> test<span class="token operator">/</span>_doc
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Nintendo"</span><span class="token punctuation">,</span> <span class="token string">"switch"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>查询的DSL语句如下：</p> 
<pre><code class="prism language-json"><span class="token comment">// 自动补全查询</span>
<span class="token constant">GET</span> <span class="token operator">/</span>test<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"suggest"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"title_suggest"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token comment">// 关键字</span>
      <span class="token string-property property">"completion"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"field"</span><span class="token operator">:</span> <span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token comment">// 补全查询的字段</span>
        <span class="token string-property property">"skip_duplicates"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 跳过重复的</span>
        <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token comment">// 获取前10条结果</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="JavaAPI_2294"></a>自动补全查询的JavaAPI</h4> 
<p>对照自动补全查询的DSL，对应的推出JavaAPI的使用方法</p> 
<p><img src="https://images2.imgbox.com/2b/1f/iEf2WEaL_o.png" alt=""></p> 
<p>而自动补全的结果也比较特殊，解析的代码格式：</p> 
<p><img src="https://images2.imgbox.com/59/56/bMPixt32_o.png" alt=""></p> 
<h3><a id="_2304"></a>数据同步</h3> 
<p>Elasticsearch中的酒店数据来自于mysql数据库，因此mysql数据发生改变时，elasticsearch也必须跟着改变，这个就是elasticsearch与mysql之间的<strong>数据同步</strong>。</p> 
<p><img src="https://images2.imgbox.com/29/a0/1B3FOBpx_o.png" alt="image-20230702162647795"></p> 
<p>常见的数据同步方案有三种：</p> 
<ul><li>同步调用</li><li>异步通知</li><li>监听binlog</li></ul> 
<h4><a id="_2316"></a>同步调用</h4> 
<p><img src="https://images2.imgbox.com/07/71/doy02udq_o.png" alt="image-20230702162842615"></p> 
<p>基本步骤：</p> 
<ul><li>demo对外提供接口，用来修改elasticsearch中的数据。</li><li>后台管理服务在完成数据库操作后，直接调用demo提供的接口</li></ul> 
<h4><a id="_2325"></a>异步通知</h4> 
<p><img src="https://images2.imgbox.com/ce/90/JcgAQ5ex_o.png" alt="image-20230702163000375"></p> 
<p>基本流程：</p> 
<ul><li>admin对mysql数据库数据完成增、删、改后，发送MQ消息。</li><li>demo监听MQ，接收到消息后完成elasticsearch数据修改。</li></ul> 
<h4><a id="binlog_2334"></a>监听binlog</h4> 
<p><img src="https://images2.imgbox.com/d3/19/1XQ2cp8P_o.png" alt="image-20230702163133626"></p> 
<p>基本流程：</p> 
<ul><li>给mysql开启binlog功能。</li><li>mysql完成增、删、改操作都会记录在binlog中。</li><li>demo基于canal监听binlog变化，实时更新elasticsearch中的内容。</li></ul> 
<blockquote> 
 <p>三种方式的优缺点</p> 
</blockquote> 
<p>方式一：同步调用</p> 
<ul><li>优点：实现简单，粗暴</li><li>缺点：业务耦合度高</li></ul> 
<p>方式二：异步通知</p> 
<ul><li>优点：低耦合，实现难度一般</li><li>缺点：依赖mq的可靠性</li></ul> 
<p>方式三：监听binlog</p> 
<ul><li>优点：完全解除服务间耦合</li><li>缺点：开启binlog增加数据库负担、实现复杂度高</li></ul> 
<h3><a id="ES_2361"></a>ES集群</h3> 
<p>单机的elasticsearch做数据存储，必然面临两个问题：海量数据存储问题、单点故障问题。</p> 
<ul><li>海量数据存储问题：将索引库从逻辑上拆分为N个分片（shard），存储到多个节点</li><li>单点故障问题：将分片数据在不同节点备份（replica ）</li></ul> 
<p><strong>ES集群相关概念</strong>:</p> 
<ul><li> <p>集群（cluster）：一组拥有共同的 cluster name 的 节点。</p> </li><li> <p><font color="red">节点（node)</font> ：集群中的一个 Elasticearch 实例</p> </li><li> <p><font color="red">分片（shard）</font>：索引可以被拆分为不同的部分进行存储，称为分片。在集群环境下，一个索引的不同分片可以拆分到不同的节点中</p> <p>解决问题：数据量太大，单点存储量有限的问题。</p> <p><img src="https://images2.imgbox.com/f6/92/I65xg3u9_o.png" alt=""></p> 
  <blockquote> 
   <p>此处把数据分成3片：shard0、shard1、shard2</p> 
  </blockquote> </li><li> <p>主分片（Primary shard）：相对于副本分片的定义。</p> </li><li> <p>副本分片（Replica shard）每个主分片可以有一个或者多个副本，数据和主分片一样。</p> </li></ul> 
<p>数据备份可以保证高可用，但是每个分片备份一份，所需要的节点数量就会翻一倍，成本实在是太高</p> 
<p>为了在高可用和成本间寻求平衡，可以这样做：</p> 
<ul><li>首先对数据分片，存储到不同节点</li><li>然后对每个分片进行备份，放到对方节点，完成互相备份</li></ul> 
<p>这样可以大大减少所需要的服务节点数量，如图，以3分片，每个分片备份一份为例：</p> 
<p><img src="https://images2.imgbox.com/39/02/TAzYgOC2_o.png" alt=""></p> 
<p>现在，每个分片都有1个备份，存储在3个节点：</p> 
<ul><li>node0：保存了分片0和1</li><li>node1：保存了分片0和2</li><li>node2：保存了分片1和2</li></ul> 
<h4><a id="_2404"></a>搭建集群</h4> 
<p>部署es集群可以直接使用docker-compose来完成，不过要求Linux虚拟机至少有<strong>4G</strong>的内存空间</p> 
<p>首先编写一个docker-compose文件，内容如下：</p> 
<pre><code class="prism language-sh">version: <span class="token string">'2.2'</span>
services:
  es01:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.12.1
    container_name: es01
    environment:
      - <span class="token assign-left variable">node.name</span><span class="token operator">=</span>es01
      - <span class="token assign-left variable">cluster.name</span><span class="token operator">=</span>es-docker-cluster
      - <span class="token assign-left variable">discovery.seed_hosts</span><span class="token operator">=</span>es02,es03
      - <span class="token assign-left variable">cluster.initial_master_nodes</span><span class="token operator">=</span>es01,es02,es03
      - <span class="token assign-left variable">bootstrap.memory_lock</span><span class="token operator">=</span>true
      - <span class="token string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span>
    ulimits:
      memlock:
        soft: <span class="token parameter variable">-1</span>
        hard: <span class="token parameter variable">-1</span>
    volumes:
      - data01:/usr/share/elasticsearch/data
    ports:
      - <span class="token number">9200</span>:9200
    networks:
      - elastic
  es02:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.12.1
    container_name: es02
    environment:
      - <span class="token assign-left variable">node.name</span><span class="token operator">=</span>es02
      - <span class="token assign-left variable">cluster.name</span><span class="token operator">=</span>es-docker-cluster
      - <span class="token assign-left variable">discovery.seed_hosts</span><span class="token operator">=</span>es01,es03
      - <span class="token assign-left variable">cluster.initial_master_nodes</span><span class="token operator">=</span>es01,es02,es03
      - <span class="token assign-left variable">bootstrap.memory_lock</span><span class="token operator">=</span>true
      - <span class="token string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span>
    ulimits:
      memlock:
        soft: <span class="token parameter variable">-1</span>
        hard: <span class="token parameter variable">-1</span>
    volumes:
      - data02:/usr/share/elasticsearch/data
    networks:
      - elastic
  es03:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.12.1
    container_name: es03
    environment:
      - <span class="token assign-left variable">node.name</span><span class="token operator">=</span>es03
      - <span class="token assign-left variable">cluster.name</span><span class="token operator">=</span>es-docker-cluster
      - <span class="token assign-left variable">discovery.seed_hosts</span><span class="token operator">=</span>es01,es02
      - <span class="token assign-left variable">cluster.initial_master_nodes</span><span class="token operator">=</span>es01,es02,es03
      - <span class="token assign-left variable">bootstrap.memory_lock</span><span class="token operator">=</span>true
      - <span class="token string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span>
    ulimits:
      memlock:
        soft: <span class="token parameter variable">-1</span>
        hard: <span class="token parameter variable">-1</span>
    volumes:
      - data03:/usr/share/elasticsearch/data
    networks:
      - elastic

volumes:
  data01:
    driver: <span class="token builtin class-name">local</span>
  data02:
    driver: <span class="token builtin class-name">local</span>
  data03:
    driver: <span class="token builtin class-name">local</span>

networks:
  elastic:
    driver: bridge
</code></pre> 
<p>es运行前需要修改一些Linux系统权限，修改<code>/etc/sysctl.conf</code>文件</p> 
<pre><code class="prism language-shell"><span class="token function">vi</span> /etc/sysctl.conf
</code></pre> 
<p>添加以下内容</p> 
<pre><code class="prism language-shell"><span class="token assign-left variable">vm.max_map_count</span><span class="token operator">=</span><span class="token number">262144</span>
</code></pre> 
<p>执行命令使配置生效</p> 
<pre><code class="prism language-shell"><span class="token function">sysctl</span> <span class="token parameter variable">-p</span>
</code></pre> 
<p>通过<code>docker-compose</code>启动集群:</p> 
<pre><code class="prism language-shell"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span>
</code></pre> 
<h4><a id="_2507"></a>创建索引库</h4> 
<p>在DevTools中输入命令</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>item
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"number_of_shards"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// 分片数量</span>
        <span class="token string-property property">"number_of_replicas"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token comment">// 副本数量</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// mapping映射定义。。。</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_2526"></a>集群节点角色</h4> 
<p>elasticsearch中集群节点有着不同的职责划分：</p> 
<table><thead><tr><th align="center">节点类型</th><th align="center">配置参数</th><th>默认值</th><th align="center">节点职责</th></tr></thead><tbody><tr><td align="center">master eligible</td><td align="center">node.master</td><td>true</td><td align="center">备选主节点：主节点可以管理和记录集群状态，决定分片在哪个节点、处理创建和删除库索引的请求</td></tr><tr><td align="center">data</td><td align="center">node.data</td><td>true</td><td align="center">数据节点：存储数据、搜索、聚合、CRUD</td></tr><tr><td align="center">ingest</td><td align="center">node.ingest</td><td>true</td><td align="center">数据存储之前的预处理</td></tr><tr><td align="center">coordinating</td><td align="center">上面三个参数都为false，则coordinating节点</td><td>无</td><td align="center">协调节点：路由请求到其它节点，合并到其它节点处理的结果，返回给用户</td></tr></tbody></table> 
<p>真实的集群一定要将集群职责分离：</p> 
<ul><li>master节点：对CPU要求高，但是内存要求第</li><li>data节点：对CPU和内存要求都高</li><li>coordinating节点：对网络带宽、CPU要求高</li></ul> 
<p>职责分离可以根据不同节点的需求分配不同的硬件去部署。而且避免业务之间的互相干扰。</p> 
<p>Elasticsearch中的每个节点角色都有自己不同的职责，因此建议集群部署时，每个节点都有独立的角色。</p> 
<p><img src="https://images2.imgbox.com/ce/b1/jtxLxgF5_o.png" alt="image-20230703112842869"></p> 
<h4><a id="_2549"></a>集群的脑裂问题</h4> 
<p>默认情况下，每个节点都是master eligible节点，因此一旦master节点宕机，其它候选节点会选举一个成为主节点。当主节点与其他节点网络故障时，可能发生脑裂问题。</p> 
<p>例如一个集群中，主节点与其它节点失联：</p> 
<p><img src="https://images2.imgbox.com/26/b3/Tm2J5ctM_o.png" alt=""></p> 
<p>此时，node2和node3认为node1宕机，就会重新选主：</p> 
<p><img src="https://images2.imgbox.com/7b/eb/xZKnAvcE_o.png" alt=""></p> 
<p>当node3当选后，集群继续对外提供服务，node2和node3自成集群，node1自成集群，两个集群数据不同步，出现数据差异。</p> 
<p>当网络恢复后，因为集群中有两个master节点，集群状态的不一致，出现脑裂的情况：</p> 
<p><img src="https://images2.imgbox.com/78/b3/34fPvLZu_o.png" alt=""></p> 
<p>为了避免脑裂，需要要求选票超过 <mark>( eligible节点数量 + 1 ）/ 2</mark>才能当选为主，因此eligible节点数量最好是奇数。对应配置项是discovery.zen.minimum_master_nodes，在es7.0以后，已经成为默认配置，因此一般不会发生脑裂问题。</p> 
<h4><a id="_2569"></a>分布式存储</h4> 
<p>当新增文档时，应该保存到不同分片，保证数据均衡，那么coordinating node如何确定数据该存储到哪个分片呢？</p> 
<p>Elasticsearch会通过hash算法来计算文档应该存储到哪个分片：</p> 
<p><img src="https://images2.imgbox.com/00/9b/I9gcn1B8_o.png" alt="image-20230703160151743"></p> 
<p>说明：</p> 
<p>•_routing默认是文档的id</p> 
<p>•算法与分片数量有关，因此索引库一旦创建，分片数量就不能修改。</p> 
<p>新增文档的流程：</p> 
<p><img src="https://images2.imgbox.com/7d/01/Dc0fjB0p_o.png" alt="image-20230703160239495"></p> 
<ol><li>新增一个id=1的文档</li><li>对id做hash运算，假如得到的是2，则应该存储到shard-2</li><li>shard-2的主分片在node3节点，将数据路由到node3</li><li>保存文档</li><li>同步给shard-2的副本replica-2，在node2节点</li><li>返回结果给coordinating-node节点</li></ol> 
<h4><a id="_2594"></a>分布式查询</h4> 
<p>elasticsearch的查询分成两个阶段：</p> 
<ul><li> <p>scatter phase：分散阶段，coordinating node会把请求分发到每一个分片</p> </li><li> <p>gather phase：聚集阶段，coordinating node汇总data node的搜索结果，并处理为最终结果集返回给用户</p> </li></ul> 
<p><img src="https://images2.imgbox.com/e9/b8/2C74pfxQ_o.png" alt=""></p> 
<h4><a id="_2604"></a>集群故障转移</h4> 
<p>集群的master节点会监控集群中的节点状态，如果发现有节点宕机，会立即将宕机节点的分片数据迁移到其它节点，确保数据安全，这个叫做故障转移。</p> 
<p>1）假设一个集群结构如图：</p> 
<p><img src="https://images2.imgbox.com/e9/e1/5B8UbMFv_o.png" alt=""></p> 
<p>现在，node1是主节点，其它两个节点是从节点。</p> 
<p>2）由于发生特殊情况，node1发生了故障：</p> 
<p><img src="https://images2.imgbox.com/cb/cf/LlwajZWh_o.png" alt=""></p> 
<p>宕机后的第一件事，需要重新选主，例如选中了node2：</p> 
<p><img src="https://images2.imgbox.com/93/f1/aTtifBpd_o.png" alt=""></p> 
<p>node2成为主节点后，会检测集群监控状态，发现：shard-1、shard-0没有副本节点。因此需要将node1上的数据迁移到node2、node3：</p> 
<p><img src="https://images2.imgbox.com/66/f0/siIjvmCQ_o.png" alt=""></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7eaf10fbddaaff6557207e5bff917805/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">springCloud使用apache的http类和RestTemplate以及Eureka</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a3a2b8d289bf094ec370f30b71aa3857/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AI嵌入式K210项目（3）-GPIO控制</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>