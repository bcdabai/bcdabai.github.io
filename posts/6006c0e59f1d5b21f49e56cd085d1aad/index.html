<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RTP工具改进(五)--使用qt - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="RTP工具改进(五)--使用qt" />
<meta property="og:description" content="前篇 第四篇
RTP工具改进(四) - rtmp协议推送
前面使用的工具一直为mfc，今天将使用qt 来做界面，使用qt 来进行程序和协议的编写，qt部分目前还不包括rtp ps流和rtmp，暂时只有rtp 直接传输，关于rtmp协议和ps流协议，先使用vs的mfc。增加和改变的模块为rtp，和 rtp_recv，如下图，以前的vs MFC版本都放到vs下面，有关于qt的 gb28181 的sip server 和 rtp 发送接收等都放到qt下面，所有可执行都放到外层的bin下面
代码地址
https://gitee.com/guanzhi0319/rtp
QT 加入 除了gb28181 的可视化界面，增加了两个程序，一个qt_rtp,一个qt_rtp_recv,打开后如下所示
2.1 发送端 目前制作还是比较简陋，先以能执行为主，使用qt 5.14，mingw，不依赖于vs，所以读者可以不安装vs就可以使用该代码,首先制作一个CameraVideoSurface类，用来读摄像头
#include &#34;c_cameravideo.h&#34; #include &lt;QDebug&gt; //c_cameravideo::c_cameravideo(QObject * parent) //{ //} CameraVideoSurface::CameraVideoSurface(QObject *parent) : QAbstractVideoSurface(parent) { //this-&gt;InitEncoder(); } CameraVideoSurface::~CameraVideoSurface() { // avformat_close_input(&amp;pOutputFormatCtx); // av_frame_free(&amp;yuvFrame); // av_packet_free(&amp;packet); // avcodec_close(pCodecCtx); } void CameraVideoSurface::setCameraResolution(const QSize &amp;size) { this-&gt;setNativeResolution(size); } QList&lt;QVideoFrame::PixelFormat&gt; CameraVideoSurface::supportedPixelFormats (QAbstractVideoBuffer::HandleType handleType) const { QList&lt;QVideoFrame::PixelFormat &gt; pixelFormats; pixelFormats." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/6006c0e59f1d5b21f49e56cd085d1aad/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-27T14:47:18+08:00" />
<meta property="article:modified_time" content="2024-01-27T14:47:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RTP工具改进(五)--使用qt</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前篇</h2> 
<p>第四篇<br> <a href="https://blog.csdn.net/qianbo042311/article/details/135762240">RTP工具改进(四) - rtmp协议推送</a></p> 
<p>前面使用的工具一直为mfc，今天将使用qt 来做界面，使用qt 来进行程序和协议的编写，qt部分目前还不包括rtp ps流和rtmp，暂时只有rtp 直接传输，关于rtmp协议和ps流协议，先使用vs的mfc。增加和改变的模块为rtp，和 rtp_recv，如下图，以前的vs MFC版本都放到vs下面，有关于qt的 gb28181 的sip server 和 rtp 发送接收等都放到qt下面，所有可执行都放到外层的bin下面<br> <img src="https://images2.imgbox.com/8c/0a/FnZSpAqA_o.png" alt="在这里插入图片描述"></p> 
<p>代码地址<br> <a href="https://gitee.com/guanzhi0319/rtp" rel="nofollow">https://gitee.com/guanzhi0319/rtp</a></p> 
<h2><a id="QT__17"></a>QT 加入</h2> 
<p>除了gb28181 的可视化界面，增加了两个程序，一个qt_rtp,一个qt_rtp_recv,打开后如下所示<br> <img src="https://images2.imgbox.com/90/a0/NDFApIP4_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="21__21"></a>2.1 发送端</h3> 
<p><img src="https://images2.imgbox.com/15/df/J1dG3Nh2_o.png" alt="在这里插入图片描述"><br> 目前制作还是比较简陋，先以能执行为主，使用qt 5.14，mingw，不依赖于vs，所以读者可以不安装vs就可以使用该代码,首先制作一个CameraVideoSurface类，用来读摄像头</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"c_cameravideo.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QDebug&gt;</span></span>
<span class="token comment">//c_cameravideo::c_cameravideo(QObject * parent)</span>
<span class="token comment">//{<!-- --></span>

<span class="token comment">//}</span>
CameraVideoSurface<span class="token operator">::</span><span class="token function">CameraVideoSurface</span><span class="token punctuation">(</span>QObject <span class="token operator">*</span>parent<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">QAbstractVideoSurface</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//this-&gt;InitEncoder();</span>
<span class="token punctuation">}</span>

CameraVideoSurface<span class="token operator">::</span><span class="token operator">~</span><span class="token function">CameraVideoSurface</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">//    avformat_close_input(&amp;pOutputFormatCtx);</span>
<span class="token comment">//    av_frame_free(&amp;yuvFrame);</span>
<span class="token comment">//    av_packet_free(&amp;packet);</span>
<span class="token comment">//    avcodec_close(pCodecCtx);</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> CameraVideoSurface<span class="token operator">::</span><span class="token function">setCameraResolution</span><span class="token punctuation">(</span><span class="token keyword">const</span> QSize <span class="token operator">&amp;</span>size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    this<span class="token operator">-&gt;</span><span class="token function">setNativeResolution</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
QList<span class="token operator">&lt;</span>QVideoFrame<span class="token operator">::</span>PixelFormat<span class="token operator">&gt;</span> CameraVideoSurface<span class="token operator">::</span><span class="token function">supportedPixelFormats</span>
<span class="token punctuation">(</span>QAbstractVideoBuffer<span class="token operator">::</span>HandleType handleType<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    QList<span class="token operator">&lt;</span>QVideoFrame<span class="token operator">::</span>PixelFormat <span class="token operator">&gt;</span> pixelFormats<span class="token punctuation">;</span>
    pixelFormats<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>QVideoFrame<span class="token operator">::</span>Format_BGR24<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pixelFormats<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>QVideoFrame<span class="token operator">::</span>Format_RGB32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pixelFormats<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>QVideoFrame<span class="token operator">::</span>Format_YUV420P<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pixelFormats<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bool CameraVideoSurface<span class="token operator">::</span><span class="token function">present</span><span class="token punctuation">(</span><span class="token keyword">const</span> QVideoFrame <span class="token operator">&amp;</span>frame<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        QVideoFrame <span class="token function">cloneFrame</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cloneFrame<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>QAbstractVideoBuffer<span class="token operator">::</span>ReadOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
        QImage <span class="token function">image</span><span class="token punctuation">(</span>cloneFrame<span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cloneFrame<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cloneFrame<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     QVideoFrame<span class="token operator">::</span><span class="token function">imageFormatFromPixelFormat</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">pixelFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        QImage image2(cloneFrame.bits(), cloneFrame.width(), cloneFrame.height(),</span>
<span class="token comment">//                     QVideoFrame::imageFormatFromPixelFormat(QVideoFrame::Format_BGR24));</span>


        image <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">mirrored</span><span class="token punctuation">(</span>true<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// rgb 转 yuv</span>
<span class="token comment">//        uint8_t *data[AV_NUM_DATA_POINTERS] = {0};</span>
<span class="token comment">//        data[0] = (uint8_t *)image.constBits();</span>
<span class="token comment">//        int linesize[AV_NUM_DATA_POINTERS] = {0};</span>
<span class="token comment">//        linesize[0] = pCodecCtx-&gt;width * 4;</span>
<span class="token comment">//        sws_scale(image_convert_ctx, data, linesize, 0, pCodecCtx-&gt;height,</span>
<span class="token comment">//                  yuvFrame-&gt;data, yuvFrame-&gt;linesize);</span>
<span class="token comment">//        // 编码</span>
<span class="token comment">//        this-&gt;Encode(yuvFrame);</span>
        emit <span class="token function">showFrame</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cloneFrame<span class="token punctuation">.</span><span class="token function">unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> true<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> false<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token keyword">void</span> CameraVideoSurface<span class="token operator">::</span><span class="token function">InitEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//av_register_all();</span>
    <span class="token function">avformat_network_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">avcodec_register_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    QString outputFileName <span class="token operator">=</span> <span class="token string">"output.h264"</span><span class="token punctuation">;</span>
    QString encoderName <span class="token operator">=</span> <span class="token string">"libx264"</span><span class="token punctuation">;</span>
    <span class="token comment">//QString rtmpAddress = "rtmp://192.168.1.111/live/livestream";</span>

    pCodec <span class="token operator">=</span> <span class="token function">avcodec_find_encoder_by_name</span><span class="token punctuation">(</span>encoderName<span class="token punctuation">.</span><span class="token function">toStdString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> pCodec<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"查找视频编码器失败！"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pCodecCtx <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span>pCodec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> pCodecCtx<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"开辟编解码器上下文"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 输入样本参数</span>
    pCodecCtx<span class="token operator">-&gt;</span>bit_rate <span class="token operator">=</span> <span class="token number">400000</span><span class="token punctuation">;</span>
    pCodecCtx<span class="token operator">-&gt;</span>width <span class="token operator">=</span> <span class="token number">1280</span><span class="token punctuation">;</span>
    pCodecCtx<span class="token operator">-&gt;</span>height <span class="token operator">=</span> <span class="token number">720</span><span class="token punctuation">;</span>
    pCodecCtx<span class="token operator">-&gt;</span>time_base <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    pCodecCtx<span class="token operator">-&gt;</span>framerate <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    pCodecCtx<span class="token operator">-&gt;</span>gop_size <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    pCodecCtx<span class="token operator">-&gt;</span>max_b_frames <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    pCodecCtx<span class="token operator">-&gt;</span>qmin <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    pCodecCtx<span class="token operator">-&gt;</span>qmax <span class="token operator">=</span> <span class="token number">51</span><span class="token punctuation">;</span>
    pCodecCtx<span class="token operator">-&gt;</span>pix_fmt <span class="token operator">=</span> AV_PIX_FMT_YUV420P<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>AV_CODEC_ID_H264 <span class="token operator">==</span> pCodecCtx<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">av_opt_set</span><span class="token punctuation">(</span>pCodecCtx<span class="token operator">-&gt;</span>priv_data<span class="token punctuation">,</span> <span class="token string">"preset"</span><span class="token punctuation">,</span> <span class="token string">"slow"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_opt_set</span><span class="token punctuation">(</span>pCodecCtx<span class="token operator">-&gt;</span>priv_data<span class="token punctuation">,</span> <span class="token string">"tune"</span><span class="token punctuation">,</span> <span class="token string">"zerolatency"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 打开编码器</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>pCodecCtx<span class="token punctuation">,</span> pCodec<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"打开编码器失败 !"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    pOutputFormatCtx <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> pOutputFormatCtx<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"视频封装器开辟失败!"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    AVOutputFormat <span class="token operator">*</span>outputFormat <span class="token operator">=</span> <span class="token function">av_guess_format</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> outputFileName<span class="token punctuation">.</span><span class="token function">toStdString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> outputFormat<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"猜测outputformat失败 !"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pOutputFormatCtx<span class="token operator">-&gt;</span>oformat <span class="token operator">=</span> outputFormat<span class="token punctuation">;</span>



    <span class="token comment">// oprn url</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avio_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pOutputFormatCtx<span class="token operator">-&gt;</span>pb<span class="token punctuation">,</span> outputFileName<span class="token punctuation">.</span><span class="token function">toStdString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> AVIO_FLAG_READ_WRITE<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"打开输出文件失败!"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    pOutputStream <span class="token operator">=</span> <span class="token function">avformat_new_stream</span><span class="token punctuation">(</span>pOutputFormatCtx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> pOutputStream<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"新建输出流失败 !"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 输出详细信息</span>
    <span class="token function">av_dump_format</span><span class="token punctuation">(</span>pOutputFormatCtx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> outputFileName<span class="token punctuation">.</span><span class="token function">toStdString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 新建数据包</span>
    packet <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> packet<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"新建数据包失败 !"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// yuvFrame 初始化</span>
    yuvFrame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> yuvFrame<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"开辟AVFrame失败 !"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    yuvFrame<span class="token operator">-&gt;</span>width <span class="token operator">=</span> pCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
    yuvFrame<span class="token operator">-&gt;</span>height <span class="token operator">=</span> pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
    yuvFrame<span class="token operator">-&gt;</span>format <span class="token operator">=</span> pCodecCtx<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">;</span>
    <span class="token comment">// 初始化 image 空间</span>
    <span class="token function">av_image_alloc</span><span class="token punctuation">(</span>yuvFrame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> yuvFrame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">,</span> yuvFrame<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> yuvFrame<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span>
                   pCodecCtx<span class="token operator">-&gt;</span>pix_fmt<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 转换上下文</span>
    image_convert_ctx <span class="token operator">=</span> <span class="token function">sws_getContext</span><span class="token punctuation">(</span>pCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> AV_PIX_FMT_RGB32<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-&gt;</span>width<span class="token punctuation">,</span>
                                       pCodecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> AV_PIX_FMT_YUV420P<span class="token punctuation">,</span>
                                       SWS_BICUBIC<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> image_convert_ctx<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"转换上下文失败 !"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 写封装头</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_write_header</span><span class="token punctuation">(</span>pOutputFormatCtx<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"视频封装头写失败 !"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 编码为 h.264</span>
<span class="token keyword">void</span> CameraVideoSurface<span class="token operator">::</span><span class="token function">Encode</span><span class="token punctuation">(</span>AVFrame <span class="token operator">*</span>frame<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    frame<span class="token operator">-&gt;</span>pts <span class="token operator">=</span> index<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">avcodec_send_frame</span><span class="token punctuation">(</span>pCodecCtx<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">"avcodec_send_frame 失败 !"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">avcodec_receive_packet</span><span class="token punctuation">(</span>pCodecCtx<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span> <span class="token operator">||</span> ret <span class="token operator">==</span> AVERROR_EOF<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span>  <span class="token string">"编码时出错"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        packet<span class="token operator">-&gt;</span>stream_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">av_interleaved_write_frame</span><span class="token punctuation">(</span>pOutputFormatCtx<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// write frame</span>
        <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token keyword">void</span> CameraVideoSurface<span class="token operator">::</span><span class="token function">cameraStopSlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">qDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">"关闭close"</span><span class="token punctuation">;</span>
    <span class="token comment">// av_write_trailer(pOutputFormatCtx);</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后就需要使用udp进行发送，使用 QUdpSocket 类来发送，把c_rtp类从QObject类去继承</p> 
<pre><code class="prism language-c">class c_rtp<span class="token operator">:</span>public QObject
<span class="token punctuation">{<!-- --></span>
     Q_OBJECT
private<span class="token operator">:</span>

    QUdpSocket <span class="token operator">*</span>v_udpSocket <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    QHostAddress v_host<span class="token punctuation">;</span>
    <span class="token comment">//QString  v_host_str;</span>
    quint16 v_port<span class="token punctuation">;</span>
private<span class="token operator">:</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span> _seq_num <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> sendbuf<span class="token punctuation">[</span>MAX_LENGTH<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> v_ssrc <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span><span class="token comment">//the default value must hash("live/1001")</span>


public<span class="token operator">:</span>
    <span class="token function">c_rtp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	<span class="token operator">~</span><span class="token function">c_rtp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>v_udpSocket<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            v_udpSocket<span class="token operator">-&gt;</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            delete v_udpSocket<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">func_init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ip<span class="token punctuation">,</span><span class="token class-name">uint16_t</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span>  <span class="token function">func_send_video</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span> data<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//发送ps流</span>
    <span class="token keyword">int</span>  <span class="token function">func_send_video_ps</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> data<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="22__280"></a>2.2 接收端</h3> 
<p>接收端主要使用IO_Thread 来接收包，拼接包，也就是意味着可以有多个接收，同时显示<br> <img src="https://images2.imgbox.com/5d/2b/3L3fwiYD_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c">class MainWindow <span class="token operator">:</span> public QMainWindow
<span class="token punctuation">{<!-- --></span>
    Q_OBJECT

public<span class="token operator">:</span>
    <span class="token function">MainWindow</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent <span class="token operator">=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

private slots<span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">on_pushButton_clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

private<span class="token operator">:</span>
    <span class="token comment">//ssrc--&gt;s_rtp_context</span>
    std<span class="token operator">::</span>unordered_map<span class="token operator">&lt;</span><span class="token class-name">uint32_t</span><span class="token punctuation">,</span> IO_Thread<span class="token operator">*</span><span class="token operator">&gt;</span> v_ctxs<span class="token punctuation">;</span>
    Ui<span class="token operator">::</span>MainWindow <span class="token operator">*</span>ui<span class="token punctuation">;</span>
    QUdpSocket <span class="token operator">*</span>v_udpSocket <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">//IO_Thread* v_iothd = NULL;</span>
    IO_Thread <span class="token operator">*</span> <span class="token function">getctx</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> ssrc<span class="token punctuation">)</span><span class="token punctuation">;</span>


    QTimer<span class="token operator">*</span> v_timer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">//int v_id1; //定时器1的唯一标示</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>实现使用QUdpSocket 去产生一个服务端来接收数据，根据不同的ssrc来分发，显示在不同的QLabel组件上</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mainwindow.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ui_mainwindow.h"</span></span>


MainWindow<span class="token operator">::</span><span class="token function">MainWindow</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">QMainWindow</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">ui</span><span class="token punctuation">(</span>new Ui<span class="token operator">::</span>MainWindow<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ui<span class="token operator">-&gt;</span><span class="token function">setupUi</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ui<span class="token operator">-&gt;</span>iptext<span class="token operator">-&gt;</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ui<span class="token operator">-&gt;</span>porttext<span class="token operator">-&gt;</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"6000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v_udpSocket <span class="token operator">=</span> new <span class="token function">QUdpSocket</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//v_udpSocket-&gt;bind(QHostAddress::LocalHost, 6000);</span>
   v_udpSocket<span class="token operator">-&gt;</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//收包程序</span>
   <span class="token function">connect</span><span class="token punctuation">(</span>v_udpSocket<span class="token punctuation">,</span><span class="token operator">&amp;</span>QUdpSocket<span class="token operator">::</span>readyRead<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           <span class="token comment">// 获取报文长度大小</span>
           qint64 size <span class="token operator">=</span> v_udpSocket<span class="token operator">-&gt;</span><span class="token function">pendingDatagramSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">// 读取报文</span>
           QByteArray array <span class="token operator">=</span> <span class="token function">QByteArray</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           v_udpSocket<span class="token operator">-&gt;</span><span class="token function">readDatagram</span><span class="token punctuation">(</span>array<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token class-name">uint8_t</span><span class="token operator">*</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>array<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">int</span> inlen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>size<span class="token punctuation">;</span>
           <span class="token keyword">int</span> outlen <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
           <span class="token class-name">uint32_t</span> last_ts<span class="token punctuation">,</span>ssrc<span class="token punctuation">;</span>
           <span class="token class-name">uint16_t</span> seq<span class="token punctuation">;</span>
           <span class="token class-name">uint8_t</span> payloadtype<span class="token punctuation">;</span>
           <span class="token class-name">uint8_t</span> <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token function">rtp_payload</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> inlen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>outlen<span class="token punctuation">,</span> last_ts<span class="token punctuation">,</span> ssrc<span class="token punctuation">,</span>
               seq<span class="token punctuation">,</span> payloadtype<span class="token punctuation">)</span><span class="token punctuation">;</span>



           IO_Thread<span class="token operator">*</span> ctx <span class="token operator">=</span> <span class="token function">getctx</span><span class="token punctuation">(</span>ssrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
           ctx<span class="token operator">-&gt;</span>v_last_ts <span class="token operator">=</span> last_ts<span class="token punctuation">;</span>
           ctx<span class="token operator">-&gt;</span>v_seq <span class="token operator">=</span> seq<span class="token punctuation">;</span>
           ctx<span class="token operator">-&gt;</span>v_payloadtype <span class="token operator">=</span> payloadtype<span class="token punctuation">;</span>
           <span class="token comment">//ctx-&gt;v_ssrc = ssrc;</span>
           <span class="token function">live_rtp_unpack</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>ctx<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>outlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   v_timer <span class="token operator">=</span> new <span class="token function">QTimer</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//启动定时器</span>
   v_timer<span class="token operator">-&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token function">connect</span><span class="token punctuation">(</span>v_timer<span class="token punctuation">,</span><span class="token operator">&amp;</span>QTimer<span class="token operator">::</span>timeout<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">=</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       <span class="token comment">//static int num = 1;</span>
       <span class="token keyword">auto</span> iter <span class="token operator">=</span> v_ctxs<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>iter<span class="token operator">!=</span> v_ctxs<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">{<!-- --></span>
          IO_Thread<span class="token operator">*</span> ctx <span class="token operator">=</span> iter<span class="token operator">-&gt;</span>second<span class="token punctuation">;</span>
          ctx<span class="token operator">-&gt;</span><span class="token function">LockBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//显示</span>

          <span class="token class-name">uint8_t</span><span class="token operator">*</span> rgbBuffer <span class="token operator">=</span> ctx<span class="token operator">-&gt;</span>out_buffer_out<span class="token punctuation">;</span>

          <span class="token keyword">int</span> w <span class="token operator">=</span> ctx<span class="token operator">-&gt;</span>m_w<span class="token punctuation">;</span>
          <span class="token keyword">int</span> h <span class="token operator">=</span> ctx<span class="token operator">-&gt;</span>m_h<span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>rgbBuffer<span class="token operator">!=</span><span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> w<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> h <span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">int</span> iw <span class="token operator">=</span> ui<span class="token operator">-&gt;</span>label_showv<span class="token operator">-&gt;</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">int</span> ih <span class="token operator">=</span> ui<span class="token operator">-&gt;</span>label_showv<span class="token operator">-&gt;</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             QImage <span class="token function">tmpImg</span><span class="token punctuation">(</span>rgbBuffer<span class="token punctuation">,</span>w<span class="token punctuation">,</span>h<span class="token punctuation">,</span>QImage<span class="token operator">::</span>Format_RGB32<span class="token punctuation">)</span><span class="token punctuation">;</span>
             QImage imageScale <span class="token operator">=</span> tmpImg<span class="token punctuation">.</span><span class="token function">scaled</span><span class="token punctuation">(</span><span class="token function">QSize</span><span class="token punctuation">(</span>iw<span class="token punctuation">,</span>ih<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             QImage image <span class="token operator">=</span> imageScale<span class="token punctuation">.</span><span class="token function">mirrored</span><span class="token punctuation">(</span>true<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
             QPixmap pixmap <span class="token operator">=</span> QPixmap<span class="token operator">::</span><span class="token function">fromImage</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span>
             ui<span class="token operator">-&gt;</span>label_showv<span class="token operator">-&gt;</span><span class="token function">setPixmap</span><span class="token punctuation">(</span>pixmap<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          ctx<span class="token operator">-&gt;</span><span class="token function">UnLockBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

MainWindow<span class="token operator">::</span><span class="token operator">~</span><span class="token function">MainWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    delete ui<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


IO_Thread <span class="token operator">*</span> MainWindow<span class="token operator">::</span><span class="token function">getctx</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> ssrc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> it <span class="token operator">=</span> v_ctxs<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>ssrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">!=</span> v_ctxs<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> it<span class="token operator">-&gt;</span>second<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        IO_Thread <span class="token operator">*</span>sc <span class="token operator">=</span> new <span class="token function">IO_Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v_ctxs<span class="token punctuation">[</span>ssrc<span class="token punctuation">]</span> <span class="token operator">=</span> sc<span class="token punctuation">;</span>
        sc<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2><a id="_408"></a>后续</h2> 
<p>改进的地方为：<br> 1 MFC 版本增加音频，包括rtp的音频和rtmp协议的音频<br> 2 QT 版本修改为player，将会丰富QT版本<br> 3 增加rtmp服务器，有想法的同志可以加入一起做。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fbee321322cc12065e1c1bec331b68cb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">R语言【taxlist】——match_names()：字符和 taxlist 对象之间的搜索匹配</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b8a4d6e8b602cba368452e0af2411530/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">《微信小程序开发从入门到实战》学习九十五</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>