<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Jetpack CameraX - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Jetpack CameraX" />
<meta property="og:description" content="文章目录 Jetpack CameraX概述添加依赖库使用预览拍照录视频 代码下载文档 Jetpack CameraX 概述 CameraX 是一个 Jetpack 库，旨在帮助您更轻松地开发相机应用。如果您要开发新应用，我们建议您从 CameraX 开始。它提供了一个一致且易于使用的 API，该 API 适用于绝大多数 Android 设备，并向后兼容 Android 5.0（API 级别 21）。
添加依赖库 // CameraX core library using the camera2 implementation def camerax_version = &#34;1.2.0-alpha02&#34; //1.2.0-alpha02 // The following line is optional, as the core library is included indirectly by camera-camera2 implementation &#34;androidx.camera:camera-core:${camerax_version}&#34; implementation &#34;androidx.camera:camera-camera2:${camerax_version}&#34; // If you want to additionally use the CameraX Lifecycle library implementation &#34;androidx.camera:camera-lifecycle:${camerax_version}&#34; // If you want to additionally use the CameraX VideoCapture library implementation &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/fd92963809199ad6203553e4f50a4ae0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-11T17:04:33+08:00" />
<meta property="article:modified_time" content="2024-01-11T17:04:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Jetpack CameraX</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Jetpack_CameraX_2" rel="nofollow">Jetpack CameraX</a></li><li><ul><li><a href="#_4" rel="nofollow">概述</a></li><li><a href="#_10" rel="nofollow">添加依赖库</a></li><li><a href="#_32" rel="nofollow">使用</a></li><li><ul><li><a href="#_34" rel="nofollow">预览</a></li><li><a href="#_164" rel="nofollow">拍照</a></li><li><a href="#_220" rel="nofollow">录视频</a></li></ul> 
   </li><li><a href="#httpsgithubcomxiangxiongflyAndroid_JetpackProjecttreemaincameraxdemo_336" rel="nofollow">代码下载</a></li><li><a href="#_340" rel="nofollow">文档</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Jetpack_CameraX_2"></a>Jetpack CameraX</h2> 
<h3><a id="_4"></a>概述</h3> 
<p>CameraX 是一个 Jetpack 库，旨在帮助您更轻松地开发相机应用。如果您要开发新应用，我们建议您从 CameraX 开始。它提供了一个一致且易于使用的 API，该 API 适用于绝大多数 Android 设备，并向后兼容 Android 5.0（API 级别 21）。</p> 
<h3><a id="_10"></a>添加依赖库</h3> 
<pre><code class="prism language-groovy"><span class="token comment">// CameraX core library using the camera2 implementation</span>
<span class="token keyword">def</span> camerax_version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"1.2.0-alpha02"</span></span> <span class="token comment">//1.2.0-alpha02</span>
<span class="token comment">// The following line is optional, as the core library is included indirectly by camera-camera2</span>
implementation <span class="token interpolation-string"><span class="token string">"androidx.camera:camera-core:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">camerax_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
implementation <span class="token interpolation-string"><span class="token string">"androidx.camera:camera-camera2:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">camerax_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
<span class="token comment">// If you want to additionally use the CameraX Lifecycle library</span>
implementation <span class="token interpolation-string"><span class="token string">"androidx.camera:camera-lifecycle:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">camerax_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
<span class="token comment">// If you want to additionally use the CameraX VideoCapture library</span>
implementation <span class="token interpolation-string"><span class="token string">"androidx.camera:camera-video:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">camerax_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
<span class="token comment">// If you want to additionally use the CameraX View class</span>
implementation <span class="token interpolation-string"><span class="token string">"androidx.camera:camera-view:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">camerax_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
<span class="token comment">// If you want to additionally add CameraX ML Kit Vision Integration</span>
implementation <span class="token interpolation-string"><span class="token string">"androidx.camera:camera-mlkit-vision:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">camerax_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
<span class="token comment">// If you want to additionally use the CameraX Extensions library</span>
implementation <span class="token interpolation-string"><span class="token string">"androidx.camera:camera-extensions:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">camerax_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
</code></pre> 
<h3><a id="_32"></a>使用</h3> 
<h4><a id="_34"></a>预览</h4> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> PictureActivity <span class="token operator">:</span> <span class="token function">BaseActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mBinding<span class="token operator">:</span> ActivityPictureBinding

    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mPreview<span class="token operator">:</span> Preview
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mCamera<span class="token operator">:</span> Camera
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mCameraProvider<span class="token operator">:</span> ProcessCameraProvider
    <span class="token keyword">private</span> <span class="token keyword">var</span> singleTapDetector<span class="token operator">:</span> GestureDetector<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> mExecutor<span class="token operator">:</span> Executor <span class="token keyword">by</span> lazy <span class="token punctuation">{<!-- --></span>
        ContextCompat<span class="token punctuation">.</span><span class="token function">getMainExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> isBack <span class="token operator">=</span> <span class="token boolean">true</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        mBinding <span class="token operator">=</span> ActivityPictureBinding<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>layoutInflater<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>mBinding<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
        mBinding<span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">post</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">initCameraX</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">initCameraX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 请求CameraProvider</span>
        <span class="token keyword">val</span> cameraProviderFuture <span class="token operator">=</span> ProcessCameraProvider<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        cameraProviderFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            mCameraProvider <span class="token operator">=</span> cameraProviderFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">bindPreview</span><span class="token punctuation">(</span>mCameraProvider<span class="token punctuation">,</span> mBinding<span class="token punctuation">.</span>previewView<span class="token punctuation">)</span>
            <span class="token function">listenGesture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> mExecutor<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">bindPreview</span><span class="token punctuation">(</span>cameraProvider<span class="token operator">:</span> ProcessCameraProvider<span class="token punctuation">,</span> previewView<span class="token operator">:</span> PreviewView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 切换前后摄像头</span>
        <span class="token keyword">val</span> cameraSelector <span class="token operator">=</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isBack<span class="token punctuation">)</span> CameraSelector<span class="token punctuation">.</span>DEFAULT_BACK_CAMERA <span class="token keyword">else</span> CameraSelector<span class="token punctuation">.</span>DEFAULT_FRONT_CAMERA

        <span class="token comment">// 创建Preview</span>
        mPreview <span class="token operator">=</span> Preview<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      

        <span class="token comment">// 绑定前确保解除了所有绑定，防止CameraProvider重复绑定到Lifecycle发生异常</span>
        cameraProvider<span class="token punctuation">.</span><span class="token function">unbindAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// 绑定生命周期</span>
        mCamera <span class="token operator">=</span> cameraProvider<span class="token punctuation">.</span><span class="token function">bindToLifecycle</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">,</span>
            cameraSelector<span class="token punctuation">,</span>
            mPreview
        <span class="token punctuation">)</span>

        <span class="token comment">// 将Preview连接到PreviewView</span>
        mPreview<span class="token punctuation">.</span><span class="token function">setSurfaceProvider</span><span class="token punctuation">(</span>previewView<span class="token punctuation">.</span>surfaceProvider<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 监听手势
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">listenGesture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mBinding<span class="token punctuation">.</span>previewView<span class="token punctuation">.</span><span class="token function">setOnTouchListener</span> <span class="token punctuation">{<!-- --></span> view<span class="token punctuation">,</span> event <span class="token operator">-&gt;</span>
            <span class="token function">singleTapForFocus</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
            <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token function">focusOnPosition</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>mBinding<span class="token punctuation">.</span>previewView<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>mBinding<span class="token punctuation">.</span>previewView<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据坐标聚焦
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">focusOnPosition</span><span class="token punctuation">(</span>x<span class="token operator">:</span> Float<span class="token punctuation">,</span> y<span class="token operator">:</span> Float<span class="token punctuation">,</span> isShowTapView<span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">logE</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"position: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">x</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">y</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token function">logE</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"width: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">mBinding<span class="token punctuation">.</span>previewView<span class="token punctuation">.</span>width</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">  height: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">mBinding<span class="token punctuation">.</span>previewView<span class="token punctuation">.</span>height</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> action <span class="token operator">=</span> FocusMeteringAction<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>
            mBinding<span class="token punctuation">.</span>previewView<span class="token punctuation">.</span>meteringPointFactory<span class="token punctuation">.</span><span class="token function">createPoint</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isShowTapView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">showTapView</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        mCamera<span class="token punctuation">.</span>cameraControl<span class="token punctuation">.</span><span class="token function">startFocusAndMetering</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 显示聚焦的图标
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">showTapView</span><span class="token punctuation">(</span>x<span class="token operator">:</span> Int<span class="token punctuation">,</span> y<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> imageView <span class="token operator">=</span> <span class="token function">ImageView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">setImageResource</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>ic_focus_view<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">val</span> popupWindow <span class="token operator">=</span> <span class="token function">PopupWindow</span><span class="token punctuation">(</span>
            ViewGroup<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>WRAP_CONTENT<span class="token punctuation">,</span>
            ViewGroup<span class="token punctuation">.</span>LayoutParams<span class="token punctuation">.</span>WRAP_CONTENT
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
            contentView <span class="token operator">=</span> imageView
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> offset <span class="token operator">=</span> <span class="token function">dp2px</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
        popupWindow<span class="token punctuation">.</span><span class="token function">showAsDropDown</span><span class="token punctuation">(</span>mBinding<span class="token punctuation">.</span>previewView<span class="token punctuation">,</span> x <span class="token operator">-</span> offset <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> y <span class="token operator">-</span> offset <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
        mBinding<span class="token punctuation">.</span>previewView<span class="token punctuation">.</span><span class="token function">postDelayed</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> popupWindow<span class="token punctuation">.</span><span class="token function">dismiss</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500L</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 单击聚焦
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">singleTapForFocus</span><span class="token punctuation">(</span>event<span class="token operator">:</span> MotionEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>singleTapDetector <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            singleTapDetector <span class="token operator">=</span> <span class="token function">GestureDetector</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token label symbol">@PictureActivity</span><span class="token punctuation">,</span>
                <span class="token keyword">object</span> <span class="token operator">:</span> GestureDetector<span class="token punctuation">.</span><span class="token function">SimpleOnGestureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onSingleTapConfirmed</span><span class="token punctuation">(</span>e<span class="token operator">:</span> MotionEvent<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{<!-- --></span>
                        <span class="token function">focusOnPosition</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>x<span class="token punctuation">,</span> event<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onSingleTapConfirmed</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        singleTapDetector<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">onTouchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 前后摄像头切换
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">changeCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        isBack <span class="token operator">=</span> <span class="token operator">!</span>isBack
        <span class="token function">bindPreview</span><span class="token punctuation">(</span>mCameraProvider<span class="token punctuation">,</span> mBinding<span class="token punctuation">.</span>previewView<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_164"></a>拍照</h4> 
<pre><code class="prism language-kotlin"><span class="token comment">// 设置图片拍摄</span>
mImageCapture <span class="token operator">=</span> ImageCapture<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setTargetRotation</span><span class="token punctuation">(</span>previewView<span class="token punctuation">.</span>display<span class="token punctuation">.</span>rotation<span class="token punctuation">)</span>
<span class="token comment">//            .setCaptureMode() // 设置拍摄模式</span>
<span class="token comment">//            .setFlashMode() // 设置闪光模式</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 设置图片质量</span>
mImageAnalysis <span class="token operator">=</span> ImageAnalysis<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setTargetRotation</span><span class="token punctuation">(</span>previewView<span class="token punctuation">.</span>display<span class="token punctuation">.</span>rotation<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setTargetResolution</span><span class="token punctuation">(</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">720</span><span class="token punctuation">,</span> <span class="token number">1440</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setBackpressureStrategy</span><span class="token punctuation">(</span>ImageAnalysis<span class="token punctuation">.</span>STRATEGY_KEEP_ONLY_LATEST<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 绑定生命周期</span>
mCamera <span class="token operator">=</span> cameraProvider<span class="token punctuation">.</span><span class="token function">bindToLifecycle</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token punctuation">,</span>
    cameraSelector<span class="token punctuation">,</span>
    mPreview<span class="token punctuation">,</span>
    mImageCapture<span class="token punctuation">,</span>
    mImageAnalysis
<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-kotlin"><span class="token comment">// 拍照</span>
<span class="token keyword">val</span> contentValues <span class="token operator">=</span> <span class="token function">ContentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">put</span><span class="token punctuation">(</span>
            MediaStore<span class="token punctuation">.</span>MediaColumns<span class="token punctuation">.</span>DISPLAY_NAME<span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"my_capture_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token punctuation">)</span>
        <span class="token function">put</span><span class="token punctuation">(</span>MediaStore<span class="token punctuation">.</span>MediaColumns<span class="token punctuation">.</span>MIME_TYPE<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"image/jpeg"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token keyword">val</span> outputFileOptions <span class="token operator">=</span> ImageCapture<span class="token punctuation">.</span>OutputFileOptions<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>
    contentResolver<span class="token punctuation">,</span>
    MediaStore<span class="token punctuation">.</span>Images<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>EXTERNAL_CONTENT_URI<span class="token punctuation">,</span> contentValues
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
mImageCapture<span class="token punctuation">.</span><span class="token function">takePicture</span><span class="token punctuation">(</span>
    outputFileOptions<span class="token punctuation">,</span>
    mExecutor<span class="token punctuation">,</span>
    <span class="token keyword">object</span> <span class="token operator">:</span> ImageCapture<span class="token punctuation">.</span><span class="token function">OnImageSavedCallback</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onImageSaved</span><span class="token punctuation">(</span>outputFileResults<span class="token operator">:</span> ImageCapture<span class="token punctuation">.</span>OutputFileResults<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> uri <span class="token operator">=</span> outputFileResults<span class="token punctuation">.</span>savedUri <span class="token operator">?:</span> <span class="token keyword">return</span>
            <span class="token function">showPicture</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>exception<span class="token operator">:</span> ImageCaptureException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">logE</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"onError: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">exception<span class="token punctuation">.</span>imageCaptureError</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_220"></a>录视频</h4> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> VideoActivity <span class="token operator">:</span> <span class="token function">BaseActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mBinding<span class="token operator">:</span> ActivityVideoBinding

    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mPreview<span class="token operator">:</span> Preview
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mCamera<span class="token operator">:</span> Camera
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mCameraProvider<span class="token operator">:</span> ProcessCameraProvider
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mVideoCapture<span class="token operator">:</span> VideoCapture
    <span class="token keyword">private</span> <span class="token keyword">val</span> mExecutor<span class="token operator">:</span> Executor <span class="token keyword">by</span> lazy <span class="token punctuation">{<!-- --></span>
        ContextCompat<span class="token punctuation">.</span><span class="token function">getMainExecutor</span><span class="token punctuation">(</span>mContext<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> isRecording <span class="token operator">=</span> <span class="token boolean">false</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        mBinding <span class="token operator">=</span> ActivityVideoBinding<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>layoutInflater<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>mBinding<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
        mBinding<span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">post</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">initCameraX</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        mBinding<span class="token punctuation">.</span>ivVideo<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRecording<span class="token punctuation">)</span> <span class="token function">startRecordVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token function">stopRecordVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">initCameraX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> listenableFuture <span class="token operator">=</span> ProcessCameraProvider<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        listenableFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            mCameraProvider <span class="token operator">=</span> listenableFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">bindPreview</span><span class="token punctuation">(</span>mCameraProvider<span class="token punctuation">,</span> mBinding<span class="token punctuation">.</span>previewView<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> mExecutor<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">bindPreview</span><span class="token punctuation">(</span>cameraProvider<span class="token operator">:</span> ProcessCameraProvider<span class="token punctuation">,</span> previewView<span class="token operator">:</span> PreviewView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 设置摄像头</span>
        <span class="token keyword">val</span> cameraSelector <span class="token operator">=</span> CameraSelector<span class="token punctuation">.</span>DEFAULT_BACK_CAMERA

        <span class="token comment">// 创建Preview</span>
        mPreview <span class="token operator">=</span> Preview<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        mVideoCapture <span class="token operator">=</span> VideoCapture<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setTargetRotation</span><span class="token punctuation">(</span>previewView<span class="token punctuation">.</span>display<span class="token punctuation">.</span>rotation<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setVideoFrameRate</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setBitRate</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// 绑定前确保解除了所有绑定，防止CameraProvider重复绑定到Lifecycle发生异常</span>
        cameraProvider<span class="token punctuation">.</span><span class="token function">unbindAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// 绑定生命周期</span>
        mCamera <span class="token operator">=</span> cameraProvider<span class="token punctuation">.</span><span class="token function">bindToLifecycle</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">,</span>
            cameraSelector<span class="token punctuation">,</span>
            mPreview<span class="token punctuation">,</span>
            mVideoCapture
        <span class="token punctuation">)</span>

        <span class="token comment">// 将Preview连接到PreviewView</span>
        mPreview<span class="token punctuation">.</span><span class="token function">setSurfaceProvider</span><span class="token punctuation">(</span>previewView<span class="token punctuation">.</span>surfaceProvider<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">startRecordVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        isRecording <span class="token operator">=</span> <span class="token boolean">true</span>
        mBinding<span class="token punctuation">.</span>tvVideo<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"停止录制"</span></span>

        <span class="token keyword">val</span> contentValues <span class="token operator">=</span> <span class="token function">ContentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">put</span><span class="token punctuation">(</span>MediaStore<span class="token punctuation">.</span>MediaColumns<span class="token punctuation">.</span>DISPLAY_NAME<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"my_video"</span></span> <span class="token operator">+</span> <span class="token string-literal singleline"><span class="token string">"_"</span></span> <span class="token operator">+</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">put</span><span class="token punctuation">(</span>MediaStore<span class="token punctuation">.</span>MediaColumns<span class="token punctuation">.</span>MIME_TYPE<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"video/mp4"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> options <span class="token operator">=</span> VideoCapture<span class="token punctuation">.</span>OutputFileOptions<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span>
            contentResolver<span class="token punctuation">,</span>
            MediaStore<span class="token punctuation">.</span>Video<span class="token punctuation">.</span>Media<span class="token punctuation">.</span>EXTERNAL_CONTENT_URI<span class="token punctuation">,</span>
            contentValues
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ActivityCompat<span class="token punctuation">.</span><span class="token function">checkSelfPermission</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span>
                Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>RECORD_AUDIO
            <span class="token punctuation">)</span> <span class="token operator">!=</span> PackageManager<span class="token punctuation">.</span>PERMISSION_GRANTED
        <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        mVideoCapture<span class="token punctuation">.</span><span class="token function">startRecording</span><span class="token punctuation">(</span>
            options<span class="token punctuation">,</span>
            mExecutor<span class="token punctuation">,</span>
            <span class="token keyword">object</span> <span class="token operator">:</span> VideoCapture<span class="token punctuation">.</span><span class="token function">OnVideoSavedCallback</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onVideoSaved</span><span class="token punctuation">(</span>outputFileResults<span class="token operator">:</span> VideoCapture<span class="token punctuation">.</span>OutputFileResults<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">val</span> uri <span class="token operator">=</span> outputFileResults<span class="token punctuation">.</span>savedUri
                    uri<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">val</span> path <span class="token operator">=</span> it<span class="token punctuation">.</span>path
                        path<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token function">showToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"视频保存在：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">path</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                            <span class="token function">logE</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"视频保存在：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">path</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>videoCaptureError<span class="token operator">:</span> Int<span class="token punctuation">,</span> message<span class="token operator">:</span> String<span class="token punctuation">,</span> cause<span class="token operator">:</span> Throwable<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">showToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"保存失败：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">message</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                    <span class="token function">logE</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"保存失败：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">message</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">stopRecordVideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        isRecording <span class="token operator">=</span> <span class="token boolean">false</span>
        mBinding<span class="token punctuation">.</span>tvVideo<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"开始录制"</span></span>
        mVideoCapture<span class="token punctuation">.</span><span class="token function">stopRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="httpsgithubcomxiangxiongflyAndroid_JetpackProjecttreemaincameraxdemo_336"></a><a href="https://github.com/xiangxiongfly/Android_JetpackProject/tree/main/cameraxdemo">代码下载</a></h3> 
<h3><a id="_340"></a>文档</h3> 
<p>https://juejin.cn/post/7267840969605382198</p> 
<p>https://juejin.cn/post/6951017751457005576</p> 
<p>https://blog.csdn.net/EthanCo/article/details/125603671</p> 
<p>https://developer.android.google.cn/media/camera/camerax?hl=zh-cn</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fcaac64b5d6fc3c6461610d924f6bc13/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【C&#43;&#43;题解】传球游戏(ball)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9981f2c1b39d40ee49f14db9aef04e14/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">城市分站系统与站群系统的区别是什么？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>