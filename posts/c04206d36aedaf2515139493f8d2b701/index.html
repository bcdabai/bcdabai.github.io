<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>umi命令行工具源码解读，umi build打包 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="umi命令行工具源码解读，umi build打包" />
<meta property="og:description" content="以umi build为例，查看umi命令行工具的逻辑
首先查看package.json文件的bin字段，找到umi可执行文件的位置：
&#34;bin&#34;: { &#34;umi&#34;: &#34;./bin/umi.js&#34; }, 查看umi/bin/umi.js文件，实际逻辑是在umi/src/cli.js文件中，执行umi build
// umi/src/cli.js switch (script) { case &#39;build&#39;: case &#39;dev&#39;: case &#39;test&#39;: case &#39;inspect&#39;: case &#39;ui&#39;: // eslint-disable-next-line import/no-dynamic-require // build进来 require(&#39;./scripts/build&#39;) require(`./scripts/${script}`); break; default: { const Service = require(&#39;umi-build-dev/lib/Service&#39;).default; new Service(buildDevOpts(args)).run(aliasMap[script] || script, args); break; } } build命令会动态导入umi/src/scripts/build.js
umi/src/scripts/build.js import yParser from &#39;yargs-parser&#39;; import buildDevOpts from &#39;../buildDevOpts&#39;; process.env.NODE_ENV = &#39;production&#39;; process.env.UMI_UI = &#39;none&#39;; // 设置两个环境变量 const args = yParser(process.argv.slice(2)); const Service = require(&#39;umi-build-dev/lib/Service&#39;)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c04206d36aedaf2515139493f8d2b701/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-11-19T10:41:07+08:00" />
<meta property="article:modified_time" content="2019-11-19T10:41:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">umi命令行工具源码解读，umi build打包</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>以<code>umi build</code>为例，查看umi命令行工具的逻辑</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/71/cd/flLwnpS4_o.png" alt="在这里插入图片描述"></p> 
<p>首先查看package.json文件的<code>bin</code>字段，找到umi可执行文件的位置：</p> 
<pre><code class="prism language-json"> <span class="token string">"bin"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"umi"</span><span class="token punctuation">:</span> <span class="token string">"./bin/umi.js"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<p>查看<code>umi/bin/umi.js</code>文件，实际逻辑是在<code>umi/src/cli.js</code>文件中，执行<code>umi build</code></p> 
<pre><code class="prism language-js"><span class="token comment">// umi/src/cli.js</span>
<span class="token keyword">switch</span> <span class="token punctuation">(</span>script<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">case</span> <span class="token string">'build'</span><span class="token punctuation">:</span>
  <span class="token keyword">case</span> <span class="token string">'dev'</span><span class="token punctuation">:</span>
  <span class="token keyword">case</span> <span class="token string">'test'</span><span class="token punctuation">:</span>
  <span class="token keyword">case</span> <span class="token string">'inspect'</span><span class="token punctuation">:</span>
  <span class="token keyword">case</span> <span class="token string">'ui'</span><span class="token punctuation">:</span>
    <span class="token comment">// eslint-disable-next-line import/no-dynamic-require</span>
    <span class="token comment">// build进来  require('./scripts/build')</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`./scripts/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>script<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'umi-build-dev/lib/Service'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token function">buildDevOpts</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>aliasMap<span class="token punctuation">[</span>script<span class="token punctuation">]</span> <span class="token operator">||</span> script<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>build命令会动态导入<code>umi/src/scripts/build.js</code></p> 
<h3><a id="umisrcscriptsbuildjs_35"></a>umi/src/scripts/build.js</h3> 
<pre><code class="prism language-js"><span class="token keyword">import</span> yParser <span class="token keyword">from</span> <span class="token string">'yargs-parser'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> buildDevOpts <span class="token keyword">from</span> <span class="token string">'../buildDevOpts'</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">=</span> <span class="token string">'production'</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">UMI_UI</span> <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>
<span class="token comment">// 设置两个环境变量</span>

<span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">yParser</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'umi-build-dev/lib/Service'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token function">buildDevOpts</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 生成一个service实例，整个打包的逻辑都在里面(包括注册各个插件，生成webpack配置，webpack打包)，然后运行实例的run函数</span>
</code></pre> 
<p>先看生成实例的参数是<code>buildDevOpts(args)</code>，<code>buildDevOpts</code>来自<code>umi/src/buildDevOpts.js</code>：</p> 
<pre><code class="prism language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span>opts <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">loadDotEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析.env,.env.local文件里的环境变量到process.env中</span>

  <span class="token keyword">let</span> cwd <span class="token operator">=</span> opts<span class="token punctuation">.</span>cwd <span class="token operator">||</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">APP_ROOT</span> <span class="token operator">||</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cwd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      cwd <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cwd <span class="token operator">=</span> <span class="token function">winPath</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 原因：webpack 的 include 规则得是 \ 才能判断出是绝对路径</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      cwd <span class="token operator">=</span> cwd<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\//g</span><span class="token punctuation">,</span> <span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 返回项目的目录路径，上面也有针对windows路径作不同处理</span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
    cwd<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">loadDotEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> baseEnvPath <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'.env'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> localEnvPath <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>baseEnvPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.local`</span></span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">loadEnv</span> <span class="token operator">=</span> envPath <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">existsSync</span><span class="token punctuation">(</span>envPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> parsed <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>envPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>parsed<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// eslint-disable-next-line no-prototype-builtins</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          process<span class="token punctuation">.</span>env<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> parsed<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">loadEnv</span><span class="token punctuation">(</span>baseEnvPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">loadEnv</span><span class="token punctuation">(</span>localEnvPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="umibuilddevsrcServicejs_96"></a>再进入<code>umi-build-dev/src/Service.js</code></h3> 
<p>首先看下Service的构造函数：</p> 
<pre><code class="prism language-js"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> cwd <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//  用户传入的 cmd 不可信任 转化一下</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cwd <span class="token operator">=</span> cwd <span class="token operator">||</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 首先将项目的package.json文件放到实例的`pkg`变量中</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cwd<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pkg <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// babel编译所有的配置文件，防止有不兼容的语法</span>
    <span class="token function">registerBabel</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      cwd<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cwd<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>commands <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 存放build,dev等命令函数，具体函数来自内置插件，umi-build-dev/src/plugins/commands</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pluginHooks <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 存放打包时的一些钩子函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pluginMethods <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>generators <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 存放umi g的模板生成器，生成页面文件等</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>UmiError <span class="token operator">=</span> UmiError<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>printUmiError <span class="token operator">=</span> printUmiError<span class="token punctuation">;</span>

    <span class="token comment">// 解析用户配置</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> UserConfig<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      cwd<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cwd<span class="token punctuation">,</span>
      service<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`user config: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 解析插件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>plugins <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolvePlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>extraPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`plugins: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' | '</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 存储相关文件的具体路径</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>paths <span class="token operator">=</span> <span class="token function">getPaths</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>看下<code>registerBabel</code>函数：</p> 
<pre><code class="prism language-js"><span class="token comment">// umi-build-dev/src/registerBabel.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> join<span class="token punctuation">,</span> isAbsolute <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> existsSync <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> registerBabel <span class="token keyword">from</span> <span class="token string">'af-webpack/registerBabel'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> winPath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'umi-utils'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> getConfigPaths <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'umi-core/lib/getUserConfig'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> uniq <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">initFiles</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  files <span class="token operator">=</span> <span class="token function">uniq</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">getConfigPaths</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">addBabelRegisterFiles</span><span class="token punctuation">(</span>extraFiles<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> cwd <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">initFiles</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  files <span class="token operator">=</span> <span class="token function">uniq</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>extraFiles<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> cwd <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">initFiles</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取所有的配置文件路径，存到files变量中</span>
  <span class="token keyword">const</span> only <span class="token operator">=</span> files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>f <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> fullPath <span class="token operator">=</span> <span class="token function">isAbsolute</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">?</span> f <span class="token punctuation">:</span> <span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">winPath</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> absSrcPath <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">existsSync</span><span class="token punctuation">(</span>absSrcPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    absSrcPath <span class="token operator">=</span> cwd<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

    <span class="token comment">// 运行`af-webpack/registerBabel`函数转义所有的配置文件，防止配置文件中有不兼容的语法。</span>
  <span class="token function">registerBabel</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// only suport glob</span>
    <span class="token comment">// ref: https://babeljs.io/docs/en/next/babel-core.html#configitem-type</span>
    only<span class="token punctuation">,</span>
    babelPreset<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'babel-preset-umi'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">{<!-- --></span>
        env<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span> targets<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span> node<span class="token punctuation">:</span> <span class="token number">8</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        transformRuntime<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    babelPlugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">[</span>
        require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'babel-plugin-module-resolver'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span>
          alias<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'@'</span><span class="token punctuation">:</span> absSrcPath<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>af-webpack/registerBabel.js中使用<code>@babel/register</code>编译:</p> 
<pre><code class="prism language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">registerBabel</span><span class="token punctuation">(</span>opts <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> only<span class="token punctuation">,</span> ignore<span class="token punctuation">,</span> babelPreset<span class="token punctuation">,</span> babelPlugins<span class="token punctuation">,</span> disablePreventTest <span class="token punctuation">}</span> <span class="token operator">=</span> opts<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>disablePreventTest <span class="token operator">||</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'test'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/register'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      presets<span class="token punctuation">:</span> <span class="token punctuation">[</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'@babel/preset-typescript'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> babelPreset<span class="token punctuation">]</span><span class="token punctuation">,</span>
      plugins<span class="token punctuation">:</span> babelPlugins <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      only<span class="token punctuation">,</span>
      ignore<span class="token punctuation">,</span>
      extensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'.es6'</span><span class="token punctuation">,</span> <span class="token string">'.es'</span><span class="token punctuation">,</span> <span class="token string">'.jsx'</span><span class="token punctuation">,</span> <span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.mjs'</span><span class="token punctuation">,</span> <span class="token string">'.ts'</span><span class="token punctuation">,</span> <span class="token string">'.tsx'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      babelrc<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      cache<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>配置文件有这些，<a href="https://umijs.org/zh/guide/config.html#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" rel="nofollow">umi文档</a>中也有讲：</p> 
<pre><code class="prism language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getConfigPaths</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> env <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">UMI_ENV</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'config/'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'.umirc.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'.umirc.ts'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'.umirc.local.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'.umirc.local.ts'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token punctuation">(</span>env <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`.umirc.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`.umirc.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>env<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.ts`</span></span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>再看解析插件<code>resolvePlugins</code>，<code>umi-build-dev/src/getPlugins.js</code>：</p> 
<pre><code class="prism language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span>opts <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> cwd<span class="token punctuation">,</span> plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token operator">=</span> opts<span class="token punctuation">;</span>

  <span class="token comment">// 内置插件</span>
  <span class="token keyword">const</span> builtInPlugins <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'./plugins/commands/dev'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/commands/build'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/commands/inspect'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/commands/test'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/commands/help'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/commands/generate'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/commands/rm'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/commands/config'</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">UMI_UI</span> <span class="token operator">===</span> <span class="token string">'none'</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'umi-plugin-ui'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/commands/block'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/commands/version'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/global-js'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/global-css'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/mountElementId'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/mock'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/proxy'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/history'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/afwebpack-config'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/404'</span><span class="token punctuation">,</span> <span class="token comment">// 404 must after mock</span>
    <span class="token string">'./plugins/targets'</span><span class="token punctuation">,</span>
    <span class="token string">'./plugins/importFromUmi'</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 将内置插件和用户给的插件合并后返回</span>
  <span class="token keyword">const</span> pluginsObj <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment">// builtIn 的在最前面</span>
    <span class="token operator">...</span>builtInPlugins<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> opts<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* eslint-disable prefer-destructuring */</span>
        opts <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        p <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">/* eslint-enable prefer-destructuring */</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> apply <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line</span>
      <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
        id<span class="token punctuation">:</span> p<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/^.\//</span><span class="token punctuation">,</span> <span class="token string">'built-in:'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        apply<span class="token punctuation">:</span> apply<span class="token punctuation">.</span><span class="token keyword">default</span> <span class="token operator">||</span> apply<span class="token punctuation">,</span> <span class="token comment">// apply方法执行对应的内置插件</span>
        opts<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token function">getUserPlugins</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">UMI_PLUGINS</span> <span class="token operator">?</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">UMI_PLUGINS</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> cwd <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token function">getUserPlugins</span><span class="token punctuation">(</span>plugins<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> cwd <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`plugins: \n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>pluginsObj<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> `  $<span class="token punctuation">{<!-- --></span>p<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>`<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> pluginsObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>构造函数完毕后，就会执行<code>service.run</code>函数：</p> 
<pre><code class="prism language-js"> <span class="token function">run</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'help'</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>name是命令的名称，此时是<code>build</code>，可以看到默认会执行<code>umi help</code>命令</p> 
<p><code>this.init()</code>：</p> 
<pre><code class="prism language-js"><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 加载环境变量</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化插件 这里很重要，会填充this.commands、this.pluginHooks、this.pluginMethods等对象，方便调用</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 重新加载用户配置</span>
    <span class="token keyword">const</span> userConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> config <span class="token operator">=</span> userConfig<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> force<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mergeConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>userConfig <span class="token operator">=</span> userConfig<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>browserslist<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">deprecate</span><span class="token punctuation">(</span><span class="token string">'config.browserslist'</span><span class="token punctuation">,</span> <span class="token string">'use config.targets instead'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'got user config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// assign user's outputPath config to paths object</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>outputPath<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> paths <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      paths<span class="token punctuation">.</span>outputPath <span class="token operator">=</span> config<span class="token punctuation">.</span>outputPath<span class="token punctuation">;</span>
      paths<span class="token punctuation">.</span>absOutputPath <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>paths<span class="token punctuation">.</span>cwd<span class="token punctuation">,</span> config<span class="token punctuation">.</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'got paths'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>paths<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><code>this.initPlugins</code>只需要看最重要的部分：</p> 
<pre><code class="prism language-js">plugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>plugin <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 每个插件都调用initPlugin</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initPlugin</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// reset count</span>
  count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">initExtraPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>this.initPlugin</code>：</p> 
<pre><code class="prism language-js"><span class="token function">initPlugin</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> id<span class="token punctuation">,</span> apply<span class="token punctuation">,</span> opts <span class="token punctuation">}</span> <span class="token operator">=</span> plugin<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">assert</span><span class="token punctuation">(</span>
        <span class="token keyword">typeof</span> apply <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token string">`
plugin must export a function, e.g.

  export default function(api) {
    // Implement functions via api
  }
        `</span></span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 生成PluginAPI实例,包含插件会使用到的一些公用方法</span>
      <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PluginAPI</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pluginMethods<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pluginMethods<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>
            <span class="token punctuation">[</span>
              <span class="token comment">// methods</span>
              <span class="token string">'changePluginOption'</span><span class="token punctuation">,</span>
              <span class="token string">'applyPlugins'</span><span class="token punctuation">,</span>
              <span class="token string">'_applyPluginsAsync'</span><span class="token punctuation">,</span>
              <span class="token string">'writeTmpFile'</span><span class="token punctuation">,</span>
              <span class="token string">'getRoutes'</span><span class="token punctuation">,</span>
              <span class="token string">'getRouteComponents'</span><span class="token punctuation">,</span>
              <span class="token comment">// properties</span>
              <span class="token string">'cwd'</span><span class="token punctuation">,</span>
              <span class="token string">'config'</span><span class="token punctuation">,</span>
              <span class="token string">'webpackConfig'</span><span class="token punctuation">,</span>
              <span class="token string">'pkg'</span><span class="token punctuation">,</span>
              <span class="token string">'paths'</span><span class="token punctuation">,</span>
              <span class="token string">'routes'</span><span class="token punctuation">,</span>
              <span class="token comment">// error handler</span>
              <span class="token string">'UmiError'</span><span class="token punctuation">,</span>
              <span class="token string">'printUmiError'</span><span class="token punctuation">,</span>
              <span class="token comment">// dev methods</span>
              <span class="token string">'restart'</span><span class="token punctuation">,</span>
              <span class="token string">'printError'</span><span class="token punctuation">,</span>
              <span class="token string">'printWarn'</span><span class="token punctuation">,</span>
              <span class="token string">'refreshBrowser'</span><span class="token punctuation">,</span>
              <span class="token string">'rebuildTmpFiles'</span><span class="token punctuation">,</span>
              <span class="token string">'rebuildHTML'</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span>
          <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> target<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      api<span class="token punctuation">.</span><span class="token function-variable function">onOptionChange</span> <span class="token operator">=</span> fn <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">assert</span><span class="token punctuation">(</span>
          <span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">,</span>
          <span class="token template-string"><span class="token string">`The first argument for api.onOptionChange should be function in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        plugin<span class="token punctuation">.</span>onOptionChange <span class="token operator">=</span> fn<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token comment">// 执行插件函数</span>
      <span class="token function">apply</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
      plugin<span class="token punctuation">.</span>_api <span class="token operator">=</span> api<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">UMI_TEST</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        signale<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token string">`
Plugin </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>chalk<span class="token punctuation">.</span>cyan<span class="token punctuation">.</span><span class="token function">underline</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> initialize failed

</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token function">getCodeFrame</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> cwd<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cwd <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)}
        `</span></span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">debug</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>initPlugin的最后会执行apply函数，以内置插件为例，apply就是运行内置插件的函数(<code>上面有提到</code>)，查看build内置插件：</p> 
<pre><code class="prism language-js"><span class="token comment">// umi-build-dev/src/plugins/commands/build/index.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// api是pluginAPI类的实例</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> service<span class="token punctuation">,</span> debug<span class="token punctuation">,</span> config<span class="token punctuation">,</span> UmiError<span class="token punctuation">,</span> printUmiError <span class="token punctuation">}</span> <span class="token operator">=</span> api<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> cwd<span class="token punctuation">,</span> paths <span class="token punctuation">}</span> <span class="token operator">=</span> service<span class="token punctuation">;</span>

    <span class="token comment">// 调用pluginApi实例的registerCommand方法，将build命令需要执行的函数方法放置到service.commands中，也就是下面的第三个参数</span>
  api<span class="token punctuation">.</span><span class="token function">registerCommand</span><span class="token punctuation">(</span>
    <span class="token string">'build'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      webpack<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      description<span class="token punctuation">:</span> <span class="token string">'building for production'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    args <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> watch <span class="token operator">=</span> args<span class="token punctuation">.</span>w <span class="token operator">||</span> args<span class="token punctuation">.</span>watch<span class="token punctuation">;</span>
      notify<span class="token punctuation">.</span><span class="token function">onBuildStart</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> name<span class="token punctuation">:</span> <span class="token string">'umi'</span><span class="token punctuation">,</span> version<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> RoutesManager <span class="token operator">=</span> <span class="token function">getRouteManager</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
      RoutesManager<span class="token punctuation">.</span><span class="token function">fetchRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">=</span> <span class="token string">'production'</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">applyPlugins</span><span class="token punctuation">(</span><span class="token string">'onStart'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">_applyPluginsAsync</span><span class="token punctuation">(</span><span class="token string">'onStartAsync'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          service<span class="token punctuation">.</span><span class="token function-variable function">rebuildTmpFiles</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            filesGenerator<span class="token punctuation">.</span><span class="token function">rebuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          service<span class="token punctuation">.</span><span class="token function-variable function">rebuildHTML</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            service<span class="token punctuation">.</span><span class="token function">applyPlugins</span><span class="token punctuation">(</span><span class="token string">'onHTMLRebuild'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>

          <span class="token keyword">const</span> filesGenerator <span class="token operator">=</span> <span class="token function">getFilesGenerator</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            RoutesManager<span class="token punctuation">,</span>
            mountElementId<span class="token punctuation">:</span> config<span class="token punctuation">.</span>mountElementId<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          filesGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">function</span> <span class="token function">startWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            filesGenerator<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span>userConfig<span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span>userConfig<span class="token punctuation">.</span><span class="token function">watchWithDevServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">HTML</span> <span class="token operator">!==</span> <span class="token string">'none'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> HtmlGeneratorPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../getHtmlGeneratorPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// move html-webpack-plugin to the head, so that</span>
            <span class="token comment">// other plugins (like workbox-webpack-plugin)</span>
            <span class="token comment">// which listen to `emit` event can detect assets</span>
            service<span class="token punctuation">.</span>webpackConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HtmlGeneratorPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          service<span class="token punctuation">.</span><span class="token function">_applyPluginsAsync</span><span class="token punctuation">(</span><span class="token string">'beforeBuildCompileAsync'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'af-webpack/build'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              cwd<span class="token punctuation">,</span>
              watch<span class="token punctuation">,</span>
              <span class="token comment">// before: service.webpackConfig</span>
              <span class="token comment">// now: [ service.webpackConfig, ... ] , for ssr or more configs</span>
              webpackConfig<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                service<span class="token punctuation">.</span>webpackConfig<span class="token punctuation">,</span>
                <span class="token operator">...</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span>ssrWebpackConfig <span class="token operator">?</span> <span class="token punctuation">[</span>service<span class="token punctuation">.</span>ssrWebpackConfig<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token comment">// stats now is Array MultiStats</span>
              <span class="token comment">// [ clientStats, ...otherStats ]</span>
              <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> stats <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Build success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>watch<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token function">startWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">RM_TMPDIR</span> <span class="token operator">!==</span> <span class="token string">'none'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>watch<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Clean tmp dir </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>service<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>tmpDirPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  rimraf<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>paths<span class="token punctuation">.</span>absTmpDirPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>service<span class="token punctuation">.</span>ssrWebpackConfig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token comment">// replace using manifest</span>
                  <span class="token comment">// __UMI_SERVER__.js/css =&gt; umi.${hash}.js/css</span>
                  <span class="token keyword">const</span> clientStat <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>stats<span class="token punctuation">)</span> <span class="token operator">?</span> stats<span class="token punctuation">.</span>stats<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> stats<span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>clientStat<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">replaceChunkMaps</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> clientStat<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                service<span class="token punctuation">.</span><span class="token function">applyPlugins</span><span class="token punctuation">(</span><span class="token string">'onBuildSuccess'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
                  args<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    stats<span class="token punctuation">,</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                service
                  <span class="token punctuation">.</span><span class="token function">_applyPluginsAsync</span><span class="token punctuation">(</span><span class="token string">'onBuildSuccessAsync'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
                    args<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                      stats<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Build success end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    notify<span class="token punctuation">.</span><span class="token function">onBuildComplete</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> name<span class="token punctuation">:</span> <span class="token string">'umi'</span><span class="token punctuation">,</span> version<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> err<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token comment">// stats now is Array MultiStats</span>
              <span class="token comment">// [ clientStats, ...otherStats ]</span>
              <span class="token function">onFail</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> err<span class="token punctuation">,</span> stats <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                service<span class="token punctuation">.</span><span class="token function">applyPlugins</span><span class="token punctuation">(</span><span class="token string">'onBuildFail'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
                  args<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    err<span class="token punctuation">,</span>
                    stats<span class="token punctuation">,</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                notify<span class="token punctuation">.</span><span class="token function">onBuildComplete</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> name<span class="token punctuation">:</span> <span class="token string">'umi'</span><span class="token punctuation">,</span> version<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> err <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printUmiError</span><span class="token punctuation">(</span>
                  <span class="token keyword">new</span> <span class="token class-name">UmiError</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    message<span class="token punctuation">:</span> err <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
                    context<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                      err<span class="token punctuation">,</span>
                      stats<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token punctuation">{<!-- --></span> detailsOnly<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>上面的api.registerCommand最后实际是调用的service的registerCommand方法：</p> 
<pre><code class="prism language-js"><span class="token function">registerCommand</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> opts<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> opts <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      fn <span class="token operator">=</span> opts<span class="token punctuation">;</span>
      opts <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    opts <span class="token operator">=</span> opts <span class="token operator">||</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>name <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commands<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`Command </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> exists, please select another one.`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 以build内置插件为例，将build需要执行的函数和参数放置到this.commands中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>commands<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> fn<span class="token punctuation">,</span> opts <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>然后执行build命令，<code>this.runCommand(name, args)</code>：</p> 
<pre><code class="prism language-js"><span class="token function">runCommand</span><span class="token punctuation">(</span>rawName<span class="token punctuation">,</span> rawArgs <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> remoteLog<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`raw command name: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>rawName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, args: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>rawArgs<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> name<span class="token punctuation">,</span> args <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">applyPlugins</span><span class="token punctuation">(</span><span class="token string">'_modifyCommand'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      initialValue<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        name<span class="token punctuation">:</span> rawName<span class="token punctuation">,</span>
        args<span class="token punctuation">:</span> rawArgs<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`run </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> with args </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> command <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commands<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>command<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      signale<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Command </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>chalk<span class="token punctuation">.</span>underline<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> does not exists`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> fn<span class="token punctuation">,</span> opts <span class="token punctuation">}</span> <span class="token operator">=</span> command<span class="token punctuation">;</span> <span class="token comment">// 取出build命令的执行函数和参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>webpack<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// opts.webpack也是在调用api.registerCommand时配置的</span>
      <span class="token comment">// webpack config 获取webpack配置，打包时会用到</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>webpackConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./getWebpackConfig'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        watch<span class="token punctuation">:</span> rawArgs<span class="token punctuation">.</span>w <span class="token operator">||</span> rawArgs<span class="token punctuation">.</span>watch<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>ssr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// when use ssr, push client-manifest plugin into client webpackConfig</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>webpackConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
          <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./plugins/commands/getChunkMapPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// server webpack config</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ssrWebpackConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./getWebpackConfig'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
          ssr<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>ssr<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 执行</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      remoteLog<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到最后运行的build命令就是存放到<code>this.commands</code>中的，来看看build命令的执行函数：</p> 
<pre><code class="prism language-js"><span class="token comment">// umi-build-dev/src/plugins/commands/build/index.js中api.registerCommand的第三个参数</span>
args <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> watch <span class="token operator">=</span> args<span class="token punctuation">.</span>w <span class="token operator">||</span> args<span class="token punctuation">.</span>watch<span class="token punctuation">;</span>
      notify<span class="token punctuation">.</span><span class="token function">onBuildStart</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> name<span class="token punctuation">:</span> <span class="token string">'umi'</span><span class="token punctuation">,</span> version<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> RoutesManager <span class="token operator">=</span> <span class="token function">getRouteManager</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
      RoutesManager<span class="token punctuation">.</span><span class="token function">fetchRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">=</span> <span class="token string">'production'</span><span class="token punctuation">;</span>
        <span class="token comment">// appluPlugins执行的是service.pluginHooks里的钩子函数，这也是在生产pluginAPI实例时初始化的</span>
        service<span class="token punctuation">.</span><span class="token function">applyPlugins</span><span class="token punctuation">(</span><span class="token string">'onStart'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">_applyPluginsAsync</span><span class="token punctuation">(</span><span class="token string">'onStartAsync'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          service<span class="token punctuation">.</span><span class="token function-variable function">rebuildTmpFiles</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            filesGenerator<span class="token punctuation">.</span><span class="token function">rebuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          service<span class="token punctuation">.</span><span class="token function-variable function">rebuildHTML</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            service<span class="token punctuation">.</span><span class="token function">applyPlugins</span><span class="token punctuation">(</span><span class="token string">'onHTMLRebuild'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>

          <span class="token keyword">const</span> filesGenerator <span class="token operator">=</span> <span class="token function">getFilesGenerator</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            RoutesManager<span class="token punctuation">,</span>
            mountElementId<span class="token punctuation">:</span> config<span class="token punctuation">.</span>mountElementId<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          filesGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">function</span> <span class="token function">startWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            filesGenerator<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span>userConfig<span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span>userConfig<span class="token punctuation">.</span><span class="token function">watchWithDevServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">HTML</span> <span class="token operator">!==</span> <span class="token string">'none'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> HtmlGeneratorPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../getHtmlGeneratorPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// move html-webpack-plugin to the head, so that</span>
            <span class="token comment">// other plugins (like workbox-webpack-plugin)</span>
            <span class="token comment">// which listen to `emit` event can detect assets</span>
            service<span class="token punctuation">.</span>webpackConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HtmlGeneratorPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          service<span class="token punctuation">.</span><span class="token function">_applyPluginsAsync</span><span class="token punctuation">(</span><span class="token string">'beforeBuildCompileAsync'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 最关键内容，调用af-webpack/build进行打包</span>
            <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'af-webpack/build'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              cwd<span class="token punctuation">,</span>
              watch<span class="token punctuation">,</span>
              <span class="token comment">// before: service.webpackConfig</span>
              <span class="token comment">// now: [ service.webpackConfig, ... ] , for ssr or more configs</span>
              webpackConfig<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                service<span class="token punctuation">.</span>webpackConfig<span class="token punctuation">,</span>
                <span class="token operator">...</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span>ssrWebpackConfig <span class="token operator">?</span> <span class="token punctuation">[</span>service<span class="token punctuation">.</span>ssrWebpackConfig<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token comment">// stats now is Array MultiStats</span>
              <span class="token comment">// [ clientStats, ...otherStats ]</span>
              <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> stats <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Build success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>watch<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token function">startWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">RM_TMPDIR</span> <span class="token operator">!==</span> <span class="token string">'none'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>watch<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Clean tmp dir </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>service<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>tmpDirPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  rimraf<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>paths<span class="token punctuation">.</span>absTmpDirPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>service<span class="token punctuation">.</span>ssrWebpackConfig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token comment">// replace using manifest</span>
                  <span class="token comment">// __UMI_SERVER__.js/css =&gt; umi.${hash}.js/css</span>
                  <span class="token keyword">const</span> clientStat <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>stats<span class="token punctuation">)</span> <span class="token operator">?</span> stats<span class="token punctuation">.</span>stats<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> stats<span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>clientStat<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">replaceChunkMaps</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> clientStat<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                service<span class="token punctuation">.</span><span class="token function">applyPlugins</span><span class="token punctuation">(</span><span class="token string">'onBuildSuccess'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
                  args<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    stats<span class="token punctuation">,</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                service
                  <span class="token punctuation">.</span><span class="token function">_applyPluginsAsync</span><span class="token punctuation">(</span><span class="token string">'onBuildSuccessAsync'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
                    args<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                      stats<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Build success end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    notify<span class="token punctuation">.</span><span class="token function">onBuildComplete</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> name<span class="token punctuation">:</span> <span class="token string">'umi'</span><span class="token punctuation">,</span> version<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> err<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token comment">// stats now is Array MultiStats</span>
              <span class="token comment">// [ clientStats, ...otherStats ]</span>
              <span class="token function">onFail</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> err<span class="token punctuation">,</span> stats <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                service<span class="token punctuation">.</span><span class="token function">applyPlugins</span><span class="token punctuation">(</span><span class="token string">'onBuildFail'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
                  args<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    err<span class="token punctuation">,</span>
                    stats<span class="token punctuation">,</span>
                  <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                notify<span class="token punctuation">.</span><span class="token function">onBuildComplete</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> name<span class="token punctuation">:</span> <span class="token string">'umi'</span><span class="token punctuation">,</span> version<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> err <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printUmiError</span><span class="token punctuation">(</span>
                  <span class="token keyword">new</span> <span class="token class-name">UmiError</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    message<span class="token punctuation">:</span> err <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
                    context<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                      err<span class="token punctuation">,</span>
                      stats<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token punctuation">{<!-- --></span> detailsOnly<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>其中最重要的就是调用<code>af-webpack/build</code>进行webpack打包，并且传入对应的webpack配置，在上面的代码<code>42行</code>。</p> 
<h3><a id="_750"></a>总结</h3> 
<p>整个打包过程的核心就是注册多个插件，而我们平时执行的<code>build</code> <code>dev</code> <code>g</code> 等命令都是位于<code>umi-build-dev/src/plugins/commands/</code>目录下的内置插件。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ddd29a364395343760c21302449fc123/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">千万不要招实习生啊！！！！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0d72f7300d28941b9220432afb1129b2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">poi(easypoi)导出excel（xls，xlsx）后，文件打开错误或乱码的解决方法（亲测）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>