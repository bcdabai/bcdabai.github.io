<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sentinel系列(8)-Sentinel使用 Nacos 配置规则 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Sentinel系列(8)-Sentinel使用 Nacos 配置规则" />
<meta property="og:description" content="动态规则 规则 Sentinel 的理念是开发者只需要关注资源的定义，当资源定义成功后可以动态增加各种流控降级规则。
在实际使用过程中，设置规则之后，保存在内存中，应用重启后，规则失效，而目前sentinel并没有直接提供持久化保存规则的功能，需要自己实现。
Sentinel 提供两种方式修改规则：
通过 API 直接修改 (loadRules)通过 DataSource 适配不同数据源修改 手动通过 API 修改比较直观，可以通过以下几个 API 修改不同的规则：
FlowRuleManager.loadRules(List&lt;FlowRule&gt; rules); // 修改流控规则 DegradeRuleManager.loadRules(List&lt;DegradeRule&gt; rules); // 修改降级规则 手动修改规则（硬编码方式）一般仅用于测试和演示，生产上一般通过动态规则源的方式来动态管理规则。
DataSource 扩展 上述 loadRules() 方法只接受内存态的规则对象，但更多时候规则应该存储在文件、数据库或者配置中心当中。DataSource 接口给我们提供了对接任意配置源的能力。相比直接通过 API 修改规则，实现 DataSource 接口是更加可靠的做法。
推荐通过控制台设置规则后将规则推送到统一的规则中心，客户端实现 ReadableDataSource 接口端监听规则中心实时获取变更，流程如下：
DataSource 扩展常见的实现方式有:
拉模式：客户端主动向某个规则管理中心定期轮询拉取规则，这个规则中心可以是 RDBMS、文件，甚至是 VCS 等。这样做的方式是简单，缺点是无法及时获取变更；推模式：规则中心统一推送，客户端通过注册监听器的方式时刻监听变化，比如使用 Nacos、Zookeeper 等配置中心。这种方式有更好的实时性和一致性保证。 Sentinel 目前支持以下数据源扩展：
Pull-based: 动态文件数据源、Consul, EurekaPush-based: ZooKeeper, Redis, Nacos, Apollo, etcd 推模式：使用 Nacos 配置规则 Nacos 是阿里中间件团队开源的服务发现和动态配置中心。Sentinel 针对 Nacos 作了适配，底层可以采用 Nacos 作为规则配置数据源。
测试案例 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/b8f953ca80468595e4d03be06d96473c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-27T15:40:53+08:00" />
<meta property="article:modified_time" content="2021-08-27T15:40:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Sentinel系列(8)-Sentinel使用 Nacos 配置规则</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>动态规则</h2> 
<h3><a id="_1"></a>规则</h3> 
<p>Sentinel 的理念是开发者只需要关注资源的定义，当资源定义成功后可以动态增加各种流控降级规则。</p> 
<p>在实际使用过程中，设置规则之后，保存在内存中，应用重启后，规则失效，而目前sentinel并没有直接提供持久化保存规则的功能，需要自己实现。</p> 
<p>Sentinel 提供两种方式修改规则：</p> 
<ul><li>通过 API 直接修改 (loadRules)</li><li>通过 DataSource 适配不同数据源修改</li></ul> 
<p>手动通过 API 修改比较直观，可以通过以下几个 API 修改不同的规则：</p> 
<pre><code class="prism language-java"><span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span></span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改流控规则</span>
<span class="token class-name">DegradeRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRule</span><span class="token punctuation">&gt;</span></span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改降级规则</span>
</code></pre> 
<p>手动修改规则（硬编码方式）一般仅用于测试和演示，生产上一般通过动态规则源的方式来动态管理规则。</p> 
<h3><a id="DataSource__20"></a>DataSource 扩展</h3> 
<p>上述 loadRules() 方法只接受内存态的规则对象，但更多时候规则应该存储在文件、数据库或者配置中心当中。DataSource 接口给我们提供了对接任意配置源的能力。相比直接通过 API 修改规则，实现 DataSource 接口是更加可靠的做法。</p> 
<p>推荐通过控制台设置规则后将规则推送到统一的规则中心，客户端实现 ReadableDataSource 接口端监听规则中心实时获取变更，流程如下：<br> <img src="https://images2.imgbox.com/33/94/IDvo9mTF_o.png" alt="在这里插入图片描述"></p> 
<p>DataSource 扩展常见的实现方式有:</p> 
<ul><li>拉模式：客户端主动向某个规则管理中心定期轮询拉取规则，这个规则中心可以是 RDBMS、文件，甚至是 VCS 等。这样做的方式是简单，缺点是无法及时获取变更；</li><li>推模式：规则中心统一推送，客户端通过注册监听器的方式时刻监听变化，比如使用 Nacos、Zookeeper 等配置中心。这种方式有更好的实时性和一致性保证。</li></ul> 
<p>Sentinel 目前支持以下数据源扩展：</p> 
<ul><li>Pull-based: 动态文件数据源、Consul, Eureka</li><li>Push-based: ZooKeeper, Redis, Nacos, Apollo, etcd</li></ul> 
<h2><a id="_Nacos__36"></a>推模式：使用 Nacos 配置规则</h2> 
<p>Nacos 是阿里中间件团队开源的服务发现和动态配置中心。Sentinel 针对 Nacos 作了适配，底层可以采用 Nacos 作为规则配置数据源。</p> 
<h3><a id="_39"></a>测试案例</h3> 
<h4><a id="1_Sentinel_40"></a>1. 启动Sentinel控制台</h4> 
<p>为了后续深入研究，这里直接克隆sentinel源码，<a href="https://github.com/alibaba/Sentinel.git">地址</a>，切换到1.8分支，导入IDEA，并启动控制台，使用sentinel/sentinel登录。</p> 
<p><img src="https://images2.imgbox.com/8b/ea/eYqJ9r3d_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2_nacos_45"></a>2. 启动nacos</h4> 
<p><a href="https://blog.csdn.net/qq_43437874/article/details/107850368">单机部署Nacos1.3.2</a></p> 
<h4><a id="3__Spring_Cloud_48"></a>3. 创建Spring Cloud项目</h4> 
<p>参考文档，创建一个spring cloud项目，并初步集成nacos、sentinel控制台。<br> <a href="https://blog.csdn.net/qq_43437874/article/details/107852072">集成Nacos注册中心</a><br> <a href="https://blog.csdn.net/qq_43437874/article/details/108267895">集成Nacos配置中心</a><br> <a href="https://blog.csdn.net/qq_43437874/article/details/109130710">集成Sentinel</a></p> 
<h4><a id="4_Nacos_54"></a>4. 使用Nacos持久化规则</h4> 
<h5><a id="1_55"></a>（1）添加依赖</h5> 
<p>首先需要添加sentinel对Nacos数据源的支持依赖。</p> 
<pre><code class="prism language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-datasource-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="2nacos_64"></a>（2）nacos中添加流控规则</h5> 
<p>新建一个配置，配置Data ID为服务名（spring.application.name）加上后缀，Group为DEFAULT_GROUP（默认分组）。</p> 
<p>特别注意的是配置内容，需要使用JSON格式。这里是一个数组，数组中每个Json对象表示一条流控规则。<br> <img src="https://images2.imgbox.com/d0/ed/eW3pL1Yp_o.png" alt="在这里插入图片描述"><br> 每个规则类型不同，其格式也不同。所以一个配置文件，只能对应一种规则类型，当你想配置所有的规则时，需要创建不同的配置文件。<br> <img src="https://images2.imgbox.com/3e/7a/evPu1iZN_o.png" alt="在这里插入图片描述"><br> 这里创建两个配置，一个是流控规则，一个是降级规则，配置内容如下：</p> 
<p>sentinel-demo-sentinel文件流控规则：</p> 
<pre><code class="prism language-json"><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"resource"</span><span class="token operator">:</span> <span class="token string">"/**"</span><span class="token punctuation">,</span>
        <span class="token string">"limitApp"</span><span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>
        <span class="token string">"grade"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"count"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"strategy"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">"controlBehavior"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">"clusterMode"</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>sentinel-demo-sentinel-degrade文件降级规则：</p> 
<pre><code class="prism language-json"><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"count"</span><span class="token operator">:</span><span class="token number">500</span><span class="token punctuation">,</span>
        <span class="token string">"grade"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">"limitApp"</span><span class="token operator">:</span><span class="token string">"default"</span><span class="token punctuation">,</span>
        <span class="token string">"minRequestAmount"</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token string">"resource"</span><span class="token operator">:</span><span class="token string">"/test"</span><span class="token punctuation">,</span>
        <span class="token string">"slowRatioThreshold"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"statIntervalMs"</span><span class="token operator">:</span><span class="token number">1000</span><span class="token punctuation">,</span>
        <span class="token string">"timeWindow"</span><span class="token operator">:</span><span class="token number">100</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<h5><a id="3_103"></a>（3）服务配置</h5> 
<p>规则在nacos中配置完成后，需要在yml中配置nacos-datasource，这里配置了两个datasource，一个是流控规则，一个是降级规则。</p> 
<pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> sentinel<span class="token punctuation">-</span>demo
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span>       <span class="token comment"># sentinel注册地址</span>
      <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
        <span class="token key atrule">r1</span><span class="token punctuation">:</span>
          <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
          	<span class="token comment"># nacos地址</span>
            <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
            <span class="token comment"># nacos中配置文件的data-id</span>
            <span class="token key atrule">data-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span><span class="token punctuation">-</span>sentinel
            <span class="token comment"># nacos 分组</span>
            <span class="token key atrule">group-id</span><span class="token punctuation">:</span> DEFAULT_GROUP
            <span class="token comment"># 规则类型 流控</span>
            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> flow
        <span class="token key atrule">r2</span><span class="token punctuation">:</span>
          <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
            <span class="token key atrule">data-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.application.name<span class="token punctuation">}</span><span class="token punctuation">-</span>sentinel<span class="token punctuation">-</span>degrade
            <span class="token key atrule">group-id</span><span class="token punctuation">:</span> DEFAULT_GROUP
            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> degrade
</code></pre> 
<p>这里需要注意rule-type的配置，需要根据不同的配置规则文件配置，比如${spring.application.name}-sentinel这个配置文件是流控规则，就需要配置为flow。</p> 
<p>rule-type的配置项对应RuleType 枚举类。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">RuleType</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">FLOW</span><span class="token punctuation">(</span><span class="token string">"flow"</span><span class="token punctuation">,</span> <span class="token class-name">FlowRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">DEGRADE</span><span class="token punctuation">(</span><span class="token string">"degrade"</span><span class="token punctuation">,</span> <span class="token class-name">DegradeRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">PARAM_FLOW</span><span class="token punctuation">(</span><span class="token string">"param-flow"</span><span class="token punctuation">,</span> <span class="token class-name">ParamFlowRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">SYSTEM</span><span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token class-name">SystemRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">AUTHORITY</span><span class="token punctuation">(</span><span class="token string">"authority"</span><span class="token punctuation">,</span> <span class="token class-name">AuthorityRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">GW_FLOW</span><span class="token punctuation">(</span><span class="token string">"gw-flow"</span><span class="token punctuation">,</span> <span class="token string">"com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayFlowRule"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">GW_API_GROUP</span><span class="token punctuation">(</span><span class="token string">"gw-api-group"</span><span class="token punctuation">,</span> <span class="token string">"com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiDefinition"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_146"></a>测试</h3> 
<h4><a id="1__147"></a>1. 启动</h4> 
<p>我们启动nacos、sentinel、服务后台，查看规则，发现Ncaos中的规则能够在控制台中显示。</p> 
<p><img src="https://images2.imgbox.com/72/61/449rJHjE_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1e/13/NzKYpwkA_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2___152"></a>2. 访问流控接口</h4> 
<p>访问流控接口，触发限流规则，发现规则生效<br> <img src="https://images2.imgbox.com/04/6a/uDDzhtEX_o.png" alt="我们配置的流控规则为"></p> 
<h4><a id="3_Nacos_156"></a>3. 修改Nacos流控规则</h4> 
<p>修改Nacos中的流控规则，然后查看sentinel控制台，发现规则会自动更新。<br> <img src="https://images2.imgbox.com/2b/4b/kMT6QQcQ_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="4_sentinel_160"></a>4. sentinel添加流控规则</h4> 
<p>在sentinel控制台添加流控规则，发现新加规则并没有在Nacos配置中更新，那么肯定是保存在内存中了。。。过一会儿就会被清理掉。<br> <img src="https://images2.imgbox.com/68/ed/MrwGbIXg_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_165"></a>遗留问题</h2> 
<p>通过实践发现，基于以上方案，可以实现在Nacos中持久化规则，但是实际开发，我们更需要的是在控制台中直接添加规则，然后持久化到Nacos中，实现双向同步。如何实现呢？后续深入分析。。。<br> <img src="https://images2.imgbox.com/62/f3/eKEt8Gtz_o.png" alt="在这里插入图片描述"></p> 
<p>想要的：</p> 
<p><img src="https://images2.imgbox.com/58/fe/nMwsxvr5_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b32c66b0c3dd34c23a71fd86e2bdd4af/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux下安装Lua，基础入门</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dfd591e435756e26f578231819a87c9f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Python】使用C语言编写Python扩展模块，史诗级详细</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>