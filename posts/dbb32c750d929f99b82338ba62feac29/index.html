<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kubernetes二进制部署（多节点） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kubernetes二进制部署（多节点）" />
<meta property="og:description" content="文章目录 实验环境实验过程部署master02节点部署nginx负载均衡集群 实验故障 实验环境 角色分配：
主机名 IP地址 安装软件包 Master01：14.0.0.50 kube-apiserver kube-controller-manager kube-scheduler etcd Master02：14.0.0.80 kube-apiserver kube-controller-manager kube-scheduler Node01： 14.0.0.60 kubelet kube-proxy docker flannel etcd Node02： 14.0.0.70 kubelet kube-proxy docker flannel etcd Nginx01&#43;keepalived：14.0.0.90 nginx、keepalived Nginx02&#43;keepalived：14.0.0.100 nginx、keepalived 实验过程 在部署完单节点集群后，继续部署多节点，前面的操作可以参考上一篇博客：
https://blog.csdn.net/chengu04/article/details/108899870
部署master02节点 1.关闭防火墙，关闭核心防护，关闭网络管理功能（生成环境中一定要关闭它） [root@localhost ~]# hostnamectl set-hostname master02	#修改主机名 [root@localhost ~]# su [root@master02 ~]# systemctl stop firewalld	#关闭防火墙 [root@master02 ~]# setenforce 0 &amp;&amp; sed -i &#34;s/SELINUX=enforcing/SELNIUX=disabled/g&#34; /etc/selinux/config	#关闭核心防护 [root@master02 ~]# systemctl stop NetworkManager &amp;&amp; systemctl disable NetworkManager #关闭网络管理功能 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/dbb32c750d929f99b82338ba62feac29/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-04T16:42:57+08:00" />
<meta property="article:modified_time" content="2020-10-04T16:42:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kubernetes二进制部署（多节点）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">实验环境</a></li><li><a href="#_13" rel="nofollow">实验过程</a></li><li><ul><li><a href="#master02_17" rel="nofollow">部署master02节点</a></li><li><a href="#nginx_63" rel="nofollow">部署nginx负载均衡集群</a></li></ul> 
  </li><li><a href="#_232" rel="nofollow">实验故障</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>实验环境</h2> 
<p><img src="https://images2.imgbox.com/72/2e/kh1qF2rS_o.png" alt="在这里插入图片描述"><br> 角色分配：</p> 
<pre><code class="prism language-python">主机名       IP地址        安装软件包
Master01：<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.50</span>     kube<span class="token operator">-</span>apiserver kube<span class="token operator">-</span>controller<span class="token operator">-</span>manager kube<span class="token operator">-</span>scheduler etcd
Master02：<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.80</span>     kube<span class="token operator">-</span>apiserver kube<span class="token operator">-</span>controller<span class="token operator">-</span>manager kube<span class="token operator">-</span>scheduler 
Node01：  <span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.60</span>     kubelet kube<span class="token operator">-</span>proxy docker flannel etcd
Node02：  <span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.70</span>     kubelet kube<span class="token operator">-</span>proxy docker flannel etcd
Nginx01<span class="token operator">+</span>keepalived：<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.90</span>   nginx、keepalived
Nginx02<span class="token operator">+</span>keepalived：<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.100</span>  nginx、keepalived
</code></pre> 
<h2><a id="_13"></a>实验过程</h2> 
<p>在部署完单节点集群后，继续部署多节点，前面的操作可以参考上一篇博客：<br> <a href="https://blog.csdn.net/chengu04/article/details/108899870">https://blog.csdn.net/chengu04/article/details/108899870</a></p> 
<h3><a id="master02_17"></a>部署master02节点</h3> 
<pre><code class="prism language-javascript">
<span class="token number">1.</span>关闭防火墙，关闭核心防护，关闭网络管理功能（生成环境中一定要关闭它）
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># hostnamectl <span class="token keyword">set</span><span class="token operator">-</span>hostname master02	#修改主机名
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># su
<span class="token punctuation">[</span>root@master02 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl stop firewalld	#关闭防火墙
<span class="token punctuation">[</span>root@master02 <span class="token operator">~</span><span class="token punctuation">]</span>#  setenforce <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sed <span class="token operator">-</span>i <span class="token string">"s/SELINUX=enforcing/SELNIUX=disabled/g"</span> <span class="token operator">/</span>etc<span class="token operator">/</span>selinux<span class="token operator">/</span>config	#关闭核心防护
<span class="token punctuation">[</span>root@master02 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl stop NetworkManager <span class="token operator">&amp;&amp;</span> systemctl disable NetworkManager  #关闭网络管理功能

<span class="token number">2.</span>将master01节点的kubernetes配置文件和启动脚本复制到master02节点
<span class="token punctuation">[</span>root@master <span class="token operator">~</span><span class="token punctuation">]</span># scp <span class="token operator">-</span>r <span class="token operator">/</span>opt<span class="token operator">/</span>kubernetes<span class="token operator">/</span> root@<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.80</span><span class="token punctuation">:</span><span class="token regex">/opt/</span>
<span class="token punctuation">[</span>root@master <span class="token operator">~</span><span class="token punctuation">]</span># scp <span class="token operator">/</span>usr<span class="token operator">/</span>lib<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>kube<span class="token operator">-</span>apiserver<span class="token punctuation">,</span>kube<span class="token operator">-</span>controller<span class="token operator">-</span>manager<span class="token punctuation">,</span>kube<span class="token operator">-</span>scheduler<span class="token punctuation">}</span><span class="token punctuation">.</span>service root@<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.80</span><span class="token punctuation">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>lib<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span>

<span class="token number">3.</span>将master01节点的etcd证书复制到master02节点（master02上一定要有etcd证书，用来与etcd通信）
<span class="token punctuation">[</span>root@master <span class="token operator">~</span><span class="token punctuation">]</span># scp <span class="token operator">-</span>r <span class="token operator">/</span>opt<span class="token operator">/</span>etcd<span class="token operator">/</span> root@<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.80</span><span class="token punctuation">:</span><span class="token operator">/</span>opt

<span class="token number">4.</span>master02上修改apiserver配置文件中的<span class="token constant">IP</span>地址
<span class="token punctuation">[</span>root@master02 <span class="token operator">~</span><span class="token punctuation">]</span># cd <span class="token operator">/</span>opt<span class="token operator">/</span>kubernetes<span class="token operator">/</span>cfg<span class="token operator">/</span>
<span class="token punctuation">[</span>root@master02 cfg<span class="token punctuation">]</span># ls
kube<span class="token operator">-</span>apiserver  kube<span class="token operator">-</span>controller<span class="token operator">-</span>manager  kube<span class="token operator">-</span>scheduler  token<span class="token punctuation">.</span>csv
<span class="token punctuation">[</span>root@master02 cfg<span class="token punctuation">]</span># vim kube<span class="token operator">-</span>apiserver

<span class="token constant">KUBE_APISERVER_OPTS</span><span class="token operator">=</span>"<span class="token operator">--</span>logtostderr<span class="token operator">=</span><span class="token boolean">true</span> \
<span class="token operator">--</span>v<span class="token operator">=</span><span class="token number">4</span> \
<span class="token operator">--</span>etcd<span class="token operator">-</span>servers<span class="token operator">=</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.50</span><span class="token punctuation">:</span><span class="token number">2379</span><span class="token punctuation">,</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.60</span><span class="token punctuation">:</span><span class="token number">2379</span><span class="token punctuation">,</span>https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.70</span><span class="token punctuation">:</span><span class="token number">2379</span> \
<span class="token operator">--</span>bind<span class="token operator">-</span>address<span class="token operator">=</span><span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.80</span> \	#修改此处的绑定<span class="token constant">IP</span>地址
<span class="token operator">--</span>secure<span class="token operator">-</span>port<span class="token operator">=</span><span class="token number">6443</span> \
<span class="token operator">--</span>advertise<span class="token operator">-</span>address<span class="token operator">=</span><span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.80</span> \	#修改此处的<span class="token constant">IP</span>地址
<span class="token operator">...</span>省略

<span class="token number">5.</span>启动master02中的三个组件服务
<span class="token punctuation">[</span>root@localhost cfg<span class="token punctuation">]</span># systemctl start kube<span class="token operator">-</span>apiserver<span class="token punctuation">.</span>service
<span class="token punctuation">[</span>root@localhost cfg<span class="token punctuation">]</span># systemctl start kube<span class="token operator">-</span>controller<span class="token operator">-</span>manager<span class="token punctuation">.</span>service
<span class="token punctuation">[</span>root@localhost cfg<span class="token punctuation">]</span># systemctl start kube<span class="token operator">-</span>scheduler<span class="token punctuation">.</span>service

<span class="token number">6.</span>添加环境变量并查看状态
<span class="token punctuation">[</span>root@master02 <span class="token operator">~</span><span class="token punctuation">]</span># echo <span class="token keyword">export</span> <span class="token constant">PATH</span><span class="token operator">=</span>$<span class="token constant">PATH</span><span class="token punctuation">:</span><span class="token operator">/</span>opt<span class="token operator">/</span>kubernetes<span class="token operator">/</span>bin <span class="token operator">&gt;&gt;</span> <span class="token operator">/</span>etc<span class="token operator">/</span>profile
<span class="token punctuation">[</span>root@master02 <span class="token operator">~</span><span class="token punctuation">]</span># source <span class="token operator">/</span>etc<span class="token operator">/</span>profile
<span class="token punctuation">[</span>root@master02 <span class="token operator">~</span><span class="token punctuation">]</span># kubectl <span class="token keyword">get</span> node
<span class="token constant">NAME</span>              <span class="token constant">STATUS</span>   <span class="token constant">ROLES</span>    <span class="token constant">AGE</span>   <span class="token constant">VERSION</span>
<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.60</span>   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   <span class="token number">23</span>h   v1<span class="token punctuation">.</span><span class="token number">12.3</span>
<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.70</span>   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   <span class="token number">23</span>h   v1<span class="token punctuation">.</span><span class="token number">12.3</span>
#看到两个node节点Ready说明master02部署成功
</code></pre> 
<h3><a id="nginx_63"></a>部署nginx负载均衡集群</h3> 
<pre><code class="prism language-javascript"><span class="token number">1.</span>两个nginx主机关闭防火墙和核心防护，编辑nginx的yum源
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># hostnamectl <span class="token keyword">set</span><span class="token operator">-</span>hostname nginx01	#修改主机名
<span class="token punctuation">[</span>root@localhost <span class="token operator">~</span><span class="token punctuation">]</span># su
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl stop firewalld <span class="token operator">&amp;&amp;</span> systemctl disable firewalld	#关闭防火墙与核心防护
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># setenforce <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sed <span class="token operator">-</span>i <span class="token string">"s/SELINUX=enforcing/SELNIUX=disabled/g"</span> <span class="token operator">/</span>etc<span class="token operator">/</span>selinux<span class="token operator">/</span>config	
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># vi <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>nginx<span class="token punctuation">.</span>repo 	#编辑nginx的yum源
<span class="token punctuation">[</span>nginx<span class="token punctuation">]</span>
name<span class="token operator">=</span>nginx<span class="token punctuation">.</span>repo
baseurl<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>nginx<span class="token punctuation">.</span>org<span class="token operator">/</span>packages<span class="token operator">/</span>centos<span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span>$basearch<span class="token operator">/</span>
enabled<span class="token operator">=</span><span class="token number">1</span>
gpgcheck<span class="token operator">=</span><span class="token number">0</span>
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># yum list

<span class="token number">2.</span>两台nginx主机安装nginx并开启四层转发（仅展示nginx01的操作）
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># yum <span class="token operator">-</span>y install nginx	<span class="token string">'//安装nginx'</span>
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># vi <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf 
<span class="token operator">...</span>省略内容
events <span class="token punctuation">{<!-- --></span>
    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

  stream <span class="token punctuation">{<!-- --></span>
    log_format  main  <span class="token string">'$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent'</span><span class="token punctuation">;</span>
            #定义日志格式；
    access_log  <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span>
             upstream k8s<span class="token operator">-</span>apiserver <span class="token punctuation">{<!-- --></span>        #定义代理的<span class="token constant">IP</span>地址及端口
                      server <span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.50</span><span class="token punctuation">:</span><span class="token number">6443</span><span class="token punctuation">;</span>
                      server <span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.80</span><span class="token punctuation">:</span><span class="token number">6443</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
              server <span class="token punctuation">{<!-- --></span>
                      listen <span class="token number">6443</span><span class="token punctuation">;</span>
                      proxy_pass k8s<span class="token operator">-</span>apiserver<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
http <span class="token punctuation">{<!-- --></span>
    include       <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>mime<span class="token punctuation">.</span>types<span class="token punctuation">;</span>
    default_type  application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>
<span class="token operator">...</span>省略内容

<span class="token number">3.</span>启动nginx服务
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># nginx <span class="token operator">-</span>t	#检查nginx语法
nginx<span class="token punctuation">:</span> the configuration file <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf syntax is ok
nginx<span class="token punctuation">:</span> configuration file <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf test is successful
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl start nginx	    #开启服务
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl status nginx
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># netstat <span class="token operator">-</span>ntap <span class="token operator">|</span>grep nginx	#会检测出来<span class="token number">6443</span>端口
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">6443</span>            <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token operator">*</span>               <span class="token constant">LISTEN</span>      <span class="token number">1849</span><span class="token operator">/</span>nginx<span class="token punctuation">:</span> master  
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">80</span>              <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token operator">*</span>               <span class="token constant">LISTEN</span>      <span class="token number">1849</span><span class="token operator">/</span>nginx<span class="token punctuation">:</span> master 

<span class="token number">4.</span>两台nginx主机部署keepalived服务（仅展示节点nginx01的配置）
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># yum <span class="token operator">-</span>y install keepalived 
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># vim <span class="token operator">/</span>etc<span class="token operator">/</span>keepalived<span class="token operator">/</span>keepalived<span class="token punctuation">.</span>conf
<span class="token operator">!</span> Configuration File <span class="token keyword">for</span> keepalived

vrrp_script check_nginx <span class="token punctuation">{<!-- --></span>                           #定义一个函数check_nginx
    script <span class="token string">"/usr/local/nginx/sbin/check_nginx.sh"</span>       #函数内容为一个检测nginx服务是否存活的脚本
<span class="token punctuation">}</span>

global_defs <span class="token punctuation">{<!-- --></span>
   notification_email <span class="token punctuation">{<!-- --></span>
     acassen@firewall<span class="token punctuation">.</span>loc
     failover@firewall<span class="token punctuation">.</span>loc
     sysadmin@firewall<span class="token punctuation">.</span>loc
   <span class="token punctuation">}</span>
   notification_email_from Alexandre<span class="token punctuation">.</span>Cassen@firewall<span class="token punctuation">.</span>loc
   smtp_server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span>
   smtp_connect_timeout <span class="token number">30</span>
   router_id <span class="token constant">LVS_DEVEL01</span>         #定义该主机在群集中的id，nginx02需要命名为不一样的
<span class="token punctuation">}</span>

vrrp_instance <span class="token constant">VI_1</span> <span class="token punctuation">{<!-- --></span>
    state <span class="token constant">MASTER</span>              #nginx02节点命名为<span class="token constant">BACKUP</span>
    <span class="token keyword">interface</span> <span class="token class-name">ens33</span>             #修改网卡名，centos7开始为ens33，centos6为eth0
    virtual_router_id <span class="token number">51</span>
    priority <span class="token number">100</span>                    #nginx02节点优先级设为<span class="token number">90</span>
    advert_int <span class="token number">1</span>
    authentication <span class="token punctuation">{<!-- --></span>
        auth_type <span class="token constant">PASS</span>
        auth_pass <span class="token number">1111</span>
    <span class="token punctuation">}</span>
    virtual_ipaddress <span class="token punctuation">{<!-- --></span>      #设置<span class="token constant">VIP</span>
        <span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.88</span>
    <span class="token punctuation">}</span>
    track_script <span class="token punctuation">{<!-- --></span>             #该vrrp实例<span class="token constant">VI_1</span>调用上面定义的函数check_nginx
        check_nginx
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token number">5.</span>创建监控nginx进程的脚本，启动keepalived服务，查看<span class="token constant">VIP</span>地址
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># mkdir <span class="token operator">-</span>p <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>sbin<span class="token operator">/</span>	#创建监控脚本目录
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># vim <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>sbin<span class="token operator">/</span>check_nginx<span class="token punctuation">.</span>sh	   #编写监控脚本配置文件
count<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>ps <span class="token operator">-</span>ef <span class="token operator">|</span>grep nginx <span class="token operator">|</span>egrep <span class="token operator">-</span>cv <span class="token string">"grep|$$"</span><span class="token punctuation">)</span>    #查看nginx进程
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"$count"</span> <span class="token operator">-</span>eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>then                 #如果nginx进程关闭了，则关闭keepalived服务
    systemctl stop keepalived
fi
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># chmod <span class="token operator">+</span>x <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>sbin<span class="token operator">/</span>check_nginx<span class="token punctuation">.</span>sh
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl start keepalived	#开启服务
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl status keepalived
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># ip a	#两个nginx服务器查看<span class="token constant">IP</span>地址
可以发现<span class="token constant">VIP</span>在节点nginx01上
<span class="token punctuation">[</span>root@nginx02 <span class="token operator">~</span><span class="token punctuation">]</span># ip a

<span class="token number">6.</span>验证漂移地址
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># pkill nginx	   #关闭nginx01节点的nginx服务
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl status keepalived	#发现keepalived服务关闭了
<span class="token punctuation">[</span>root@nginx02 <span class="token operator">~</span><span class="token punctuation">]</span># ip a	#现在发现<span class="token constant">VIP</span>地址漂移到nginx02上了

<span class="token number">7.</span>恢复漂移地址的操作
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl start nginx
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl start keepalived	#先开启nginx，在启动keepalived服务
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># ip a	#再次查看，发现<span class="token constant">VIP</span>又回到了nginx01节点上

<span class="token number">8.</span>修改两个node节点配置文件（bootstrap<span class="token punctuation">.</span>kubeconfig ），使用<span class="token constant">VIP</span>地址，仅展示node01节点的操作
<span class="token punctuation">[</span>root@node01 <span class="token operator">~</span><span class="token punctuation">]</span># vi <span class="token operator">/</span>opt<span class="token operator">/</span>kubernetes<span class="token operator">/</span>cfg<span class="token operator">/</span>bootstrap<span class="token punctuation">.</span>kubeconfig 
    server<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.88</span><span class="token punctuation">:</span><span class="token number">6443</span>	   #此地址修改为<span class="token constant">VIP</span>地址
<span class="token punctuation">[</span>root@node01 <span class="token operator">~</span><span class="token punctuation">]</span># vi <span class="token operator">/</span>opt<span class="token operator">/</span>kubernetes<span class="token operator">/</span>cfg<span class="token operator">/</span>kubelet<span class="token punctuation">.</span>kubeconfig 
    server<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.88</span><span class="token punctuation">:</span><span class="token number">6443</span>    	  #此地址修改为<span class="token constant">VIP</span>地址
<span class="token punctuation">[</span>root@node01 <span class="token operator">~</span><span class="token punctuation">]</span># vi <span class="token operator">/</span>opt<span class="token operator">/</span>kubernetes<span class="token operator">/</span>cfg<span class="token operator">/</span>kube<span class="token operator">-</span>proxy<span class="token punctuation">.</span>kubeconfig 
    server<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.88</span><span class="token punctuation">:</span><span class="token number">6443</span>	  #此地址修改为<span class="token constant">VIP</span>地址
    
<span class="token number">9.</span>重启两个node节点的服务
<span class="token punctuation">[</span>root@node01 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl restart kubelet
<span class="token punctuation">[</span>root@node01 <span class="token operator">~</span><span class="token punctuation">]</span># systemctl restart kube<span class="token operator">-</span>proxy
<span class="token punctuation">[</span>root@node01 <span class="token operator">~</span><span class="token punctuation">]</span># cd <span class="token operator">/</span>opt<span class="token operator">/</span>kubernetes<span class="token operator">/</span>cfg<span class="token operator">/</span>
<span class="token punctuation">[</span>root@node01 cfg<span class="token punctuation">]</span># grep <span class="token number">88</span> <span class="token operator">*</span>	        #过滤当前目录下所有内容中是否包含<span class="token number">88</span>，如下代表<span class="token constant">VIP</span>修改成功
bootstrap<span class="token punctuation">.</span>kubeconfig<span class="token punctuation">:</span>    server<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.88</span><span class="token punctuation">:</span><span class="token number">6443</span>
kubelet<span class="token punctuation">.</span>kubeconfig<span class="token punctuation">:</span>    server<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.88</span><span class="token punctuation">:</span><span class="token number">6443</span>
kube<span class="token operator">-</span>proxy<span class="token punctuation">.</span>kubeconfig<span class="token punctuation">:</span>    server<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.88</span><span class="token punctuation">:</span><span class="token number">6443</span>

<span class="token number">10.</span>在节点nginx01上查看nginx的日志，查看负载均衡是否生效
<span class="token punctuation">[</span>root@nginx01 <span class="token operator">~</span><span class="token punctuation">]</span># vim <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log	#下面的日志是重启服务后产生的
<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.60</span> <span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.50</span><span class="token punctuation">:</span><span class="token number">6443</span> <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token operator">/</span>Sep<span class="token operator">/</span><span class="token number">2020</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token number">01</span><span class="token punctuation">:</span><span class="token number">22</span> <span class="token operator">+</span><span class="token number">0800</span><span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">15319</span>
<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.60</span> <span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.50</span><span class="token punctuation">:</span><span class="token number">6443</span> <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token operator">/</span>Sep<span class="token operator">/</span><span class="token number">2020</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token number">01</span><span class="token punctuation">:</span><span class="token number">23</span> <span class="token operator">+</span><span class="token number">0800</span><span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">1115</span>
<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.60</span> <span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.80</span><span class="token punctuation">:</span><span class="token number">6443</span> <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token operator">/</span>Sep<span class="token operator">/</span><span class="token number">2020</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token number">01</span><span class="token punctuation">:</span><span class="token number">23</span> <span class="token operator">+</span><span class="token number">0800</span><span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">1115</span>
<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.60</span> <span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.80</span><span class="token punctuation">:</span><span class="token number">6443</span> <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token operator">/</span>Sep<span class="token operator">/</span><span class="token number">2020</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token number">01</span><span class="token punctuation">:</span><span class="token number">31</span> <span class="token operator">+</span><span class="token number">0800</span><span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">3010</span>
<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.70</span> <span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.50</span><span class="token punctuation">:</span><span class="token number">6443</span> <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token operator">/</span>Sep<span class="token operator">/</span><span class="token number">2020</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token number">01</span><span class="token punctuation">:</span><span class="token number">38</span> <span class="token operator">+</span><span class="token number">0800</span><span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">1115</span>
<span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.70</span> <span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.50</span><span class="token punctuation">:</span><span class="token number">6443</span> <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token operator">/</span>Sep<span class="token operator">/</span><span class="token number">2020</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token number">01</span><span class="token punctuation">:</span><span class="token number">38</span> <span class="token operator">+</span><span class="token number">0800</span><span class="token punctuation">]</span> <span class="token number">200</span> <span class="token number">1114</span>
#nginx负载均衡生效后，会进行状态检查

<span class="token number">11.</span>master节点测试创建pod
<span class="token punctuation">[</span>root@master01 <span class="token operator">~</span><span class="token punctuation">]</span># kubectl run nginx <span class="token operator">--</span>image<span class="token operator">=</span>nginx	#创建一个运行nginx服务的pod
kubectl run <span class="token operator">--</span>generator<span class="token operator">=</span>deployment<span class="token operator">/</span>apps<span class="token punctuation">.</span>v1beta1 is <span class="token constant">DEPRECATED</span> and will be removed <span class="token keyword">in</span> a future version<span class="token punctuation">.</span> Use kubectl create instead<span class="token punctuation">.</span>
deployment<span class="token punctuation">.</span>apps<span class="token operator">/</span>nginx created
<span class="token punctuation">[</span>root@master01 <span class="token operator">~</span><span class="token punctuation">]</span># kubectl <span class="token keyword">get</span> pods	      #查看状态，是正在创建
<span class="token constant">NAME</span>                    <span class="token constant">READY</span>   <span class="token constant">STATUS</span>              <span class="token constant">RESTARTS</span>   <span class="token constant">AGE</span>
nginx<span class="token operator">-</span>dbddb74b8<span class="token operator">-</span><span class="token number">5</span>s6h7   <span class="token number">0</span><span class="token operator">/</span><span class="token number">1</span>     ContainerCreating   <span class="token number">0</span>          <span class="token number">13</span>s
<span class="token punctuation">[</span>root@master01 <span class="token operator">~</span><span class="token punctuation">]</span># kubectl <span class="token keyword">get</span> pods	     #过会儿再次查看，发现pod已经创建完成，在master02节点也可以查看到
<span class="token constant">NAME</span>                    <span class="token constant">READY</span>   <span class="token constant">STATUS</span>    <span class="token constant">RESTARTS</span>   <span class="token constant">AGE</span>
nginx<span class="token operator">-</span>dbddb74b8<span class="token operator">-</span><span class="token number">5</span>s6h7   <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">0</span>          <span class="token number">23</span>s

<span class="token number">12.</span>查看刚才创建的运行nginx服务的pod的日志
<span class="token punctuation">[</span>root@master01 <span class="token operator">~</span><span class="token punctuation">]</span># kubectl logs nginx<span class="token operator">-</span>dbddb74b8<span class="token operator">-</span><span class="token number">5</span>s6h   #查看pod日志
Error <span class="token keyword">from</span> <span class="token function">server</span> <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token function">Forbidden</span> <span class="token punctuation">(</span>user<span class="token operator">=</span>system<span class="token punctuation">:</span>anonymous<span class="token punctuation">,</span> verb<span class="token operator">=</span><span class="token keyword">get</span><span class="token punctuation">,</span> resource<span class="token operator">=</span>nodes<span class="token punctuation">,</span> subresource<span class="token operator">=</span>proxy<span class="token punctuation">)</span> <span class="token punctuation">(</span> pods<span class="token operator">/</span>log nginx<span class="token operator">-</span>dbddb74b8<span class="token operator">-</span><span class="token number">5</span>s6h7<span class="token punctuation">)</span>
#发现是因为使用了system<span class="token punctuation">:</span>anonymous（匿名）用户进行操作，没有权限

<span class="token punctuation">[</span>root@master01 <span class="token operator">~</span><span class="token punctuation">]</span># kubectl create clusterrolebinding cluster<span class="token operator">-</span>system<span class="token operator">-</span>anonymous <span class="token operator">--</span>clusterrole<span class="token operator">=</span>cluster<span class="token operator">-</span>admin <span class="token operator">--</span>user<span class="token operator">=</span>system<span class="token punctuation">:</span>anonymous	
                        #将集群中的匿名用户绑定到管理员用户，使其拥有权限
<span class="token punctuation">[</span>root@master <span class="token operator">~</span><span class="token punctuation">]</span># kubectl logs nginx<span class="token operator">-</span>dbddb74b8<span class="token operator">-</span><span class="token number">5</span>s6h  #此时可以查看，这时没有日志产生

<span class="token number">13.</span>访问node节点的pod中的web业务，从而产生日志，并在两个master节点查看
<span class="token punctuation">[</span>root@master <span class="token operator">~</span><span class="token punctuation">]</span># kubectl <span class="token keyword">get</span> pods <span class="token operator">-</span>o wide	#查看pod的完整信息（<span class="token constant">IP</span>信息）
<span class="token constant">NAME</span>                    <span class="token constant">READY</span>   <span class="token constant">STATUS</span>    <span class="token constant">RESTARTS</span>   <span class="token constant">AGE</span>     <span class="token constant">IP</span>            <span class="token constant">NODE</span>              <span class="token constant">NOMINATED</span> <span class="token constant">NODE</span>
nginx<span class="token operator">-</span>dbddb74b8<span class="token operator">-</span><span class="token number">5</span>s6h7   <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">0</span>          <span class="token number">6</span>m29s   <span class="token number">172.17</span><span class="token number">.26</span><span class="token number">.2</span>   <span class="token number">14.0</span><span class="token number">.0</span><span class="token number">.60</span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
<span class="token punctuation">[</span>root@node01 <span class="token operator">~</span><span class="token punctuation">]</span># curl <span class="token number">172.17</span><span class="token number">.26</span><span class="token number">.2</span>	#在对应的node节点访问pod
<span class="token punctuation">[</span>root@master <span class="token operator">~</span><span class="token punctuation">]</span># kubectl logs nginx<span class="token operator">-</span>dbddb74b8<span class="token operator">-</span><span class="token number">5</span>s6h7	#再次在master节点查看日志情况，master02节点同样可以查看到
<span class="token number">172.17</span><span class="token number">.26</span><span class="token number">.1</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token operator">/</span>Apr<span class="token operator">/</span><span class="token number">2020</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">:</span><span class="token number">38</span><span class="token punctuation">:</span><span class="token number">48</span> <span class="token operator">+</span><span class="token number">0000</span><span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">"-"</span> <span class="token string">"curl/7.29.0"</span> <span class="token string">"-"</span>
</code></pre> 
<h2><a id="_232"></a>实验故障</h2> 
<p>搭建完k8s集群后，在master01上创建了一个运行nginx服务的pod，查看其日志时出现如下报错：</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span>root@master01 <span class="token operator">~</span><span class="token punctuation">]</span># kubectl logs nginx<span class="token operator">-</span>dbddb74b8<span class="token operator">-</span><span class="token number">5</span>s6h   #查看pod日志命令
Error <span class="token keyword">from</span> <span class="token function">server</span> <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token function">Forbidden</span> <span class="token punctuation">(</span>user<span class="token operator">=</span>system<span class="token punctuation">:</span>anonymous<span class="token punctuation">,</span> verb<span class="token operator">=</span><span class="token keyword">get</span><span class="token punctuation">,</span> resource<span class="token operator">=</span>nodes<span class="token punctuation">,</span> subresource<span class="token operator">=</span>proxy<span class="token punctuation">)</span> <span class="token punctuation">(</span> pods<span class="token operator">/</span>log nginx<span class="token operator">-</span>dbddb74b8<span class="token operator">-</span><span class="token number">5</span>s6h7<span class="token punctuation">)</span>
</code></pre> 
<p>故障原因：<br> 默认会使用system:anonymous（匿名）用户进行操作，而该用户没有权限</p> 
<p>解决方法：</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">[</span>root@master01 <span class="token operator">~</span><span class="token punctuation">]</span># kubectl create clusterrolebinding cluster<span class="token operator">-</span>system<span class="token operator">-</span>anonymous <span class="token operator">--</span>clusterrole<span class="token operator">=</span>cluster<span class="token operator">-</span>admin <span class="token operator">--</span>user<span class="token operator">=</span>system<span class="token punctuation">:</span>anonymous	
                               #将集群中的匿名用户绑定到管理员用户，使其拥有权限
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6f86b2a01e964e264366a421b99f0965/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ASP.NET MVC预览4-使用Ajax和Ajax.Form</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4e261ae09f6c1c988d23712816c95184/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">相机相关参数及视野计算</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>