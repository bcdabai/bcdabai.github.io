<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【mmdetection3d】——04自定义模型 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【mmdetection3d】——04自定义模型" />
<meta property="og:description" content="教程 4: 自定义模型 我们通常把模型的各个组成成分分成6种类型：
编码器（encoder）：包括 voxel layer、voxel encoder 和 middle encoder 等进入 backbone 前所使用的基于 voxel 的方法，如 HardVFE 和 PointPillarsScatter。骨干网络（backbone）：通常采用 FCN 网络来提取特征图，如 ResNet 和 SECOND。颈部网络（neck）：位于 backbones 和 heads 之间的组成模块，如 FPN 和 SECONDFPN。检测头（head）：用于特定任务的组成模块，如检测框的预测和掩码的预测。RoI 提取器（RoI extractor）：用于从特征图中提取 RoI 特征的组成模块，如 H3DRoIHead 和 PartAggregationROIHead。损失函数（loss）：heads 中用于计算损失函数的组成模块，如 FocalLoss、L1Loss 和 GHMLoss。 开发新的组成模块 添加新建 encoder 接下来我们以 HardVFE 为例展示如何开发新的组成模块。
1. 定义一个新的 voxel encoder（如 HardVFE：即 DV-SECOND 中所提出的 Voxel 特征提取器） 创建一个新文件 mmdet3d/models/voxel_encoders/voxel_encoder.py ：
import torch.nn as nn from ..builder import VOXEL_ENCODERS @VOXEL_ENCODERS.register_module() class HardVFE(nn." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a55366c6069ea9e44e782f33de3d9e94/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-08T20:40:44+08:00" />
<meta property="article:modified_time" content="2021-11-08T20:40:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【mmdetection3d】——04自定义模型</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_4__0"></a>教程 4: 自定义模型</h2> 
<p>我们通常把模型的各个组成成分分成6种类型：</p> 
<ul><li><strong>编码器（encoder）</strong>：包括 voxel layer、voxel encoder 和 middle encoder 等进入 backbone 前所使用的基于 voxel 的方法，如 HardVFE 和 PointPillarsScatter。</li><li><strong>骨干网络（backbone）</strong>：通常采用 FCN 网络来提取特征图，如 ResNet 和 SECOND。</li><li><strong>颈部网络（neck）</strong>：位于 backbones 和 heads 之间的组成模块，如 FPN 和 SECONDFPN。</li><li><strong>检测头（head）</strong>：用于特定任务的组成模块，如检测框的预测和掩码的预测。</li><li><strong>RoI 提取器（RoI extractor）</strong>：用于从特征图中提取 RoI 特征的组成模块，如 H3DRoIHead 和 PartAggregationROIHead。</li><li><strong>损失函数（loss）</strong>：heads 中用于计算损失函数的组成模块，如 FocalLoss、L1Loss 和 GHMLoss。</li></ul> 
<h3><a id="_11"></a>开发新的组成模块</h3> 
<h4><a id="_encoder_13"></a>添加新建 encoder</h4> 
<p>接下来我们以 HardVFE 为例展示如何开发新的组成模块。</p> 
<h5><a id="1__voxel_encoder_HardVFE_DVSECOND__Voxel__17"></a>1. 定义一个新的 voxel encoder（如 HardVFE：即 DV-SECOND 中所提出的 Voxel 特征提取器）</h5> 
<p>创建一个新文件 <code>mmdet3d/models/voxel_encoders/voxel_encoder.py</code> ：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn

<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>builder <span class="token keyword">import</span> VOXEL_ENCODERS


<span class="token decorator annotation punctuation">@VOXEL_ENCODERS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">HardVFE</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># should return a tuple</span>
        <span class="token keyword">pass</span>
</code></pre> 
<h5><a id="2__37"></a>2. 导入新建模块</h5> 
<p>用户可以通过添加下面这行代码到 <code>mmdet3d/models/voxel_encoders/__init__.py</code> 中</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>voxel_encoder <span class="token keyword">import</span> HardVFE
</code></pre> 
<p>或者添加以下的代码到配置文件中，从而能够在避免修改源码的情况下导入新建模块。</p> 
<pre><code class="prism language-python">custom_imports <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    imports<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'mmdet3d.models.voxel_encoders.HardVFE'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_failed_imports<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="3__voxel_encoder_53"></a>3. 在配置文件中使用 voxel encoder</h5> 
<pre><code class="prism language-python">model <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    voxel_encoder<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'HardVFE'</span><span class="token punctuation">,</span>
        arg1<span class="token operator">=</span>xxx<span class="token punctuation">,</span>
        arg2<span class="token operator">=</span>xxx<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h4><a id="_backbone_65"></a>添加新建 backbone</h4> 
<p>接下来我们以 <a href="https://www.mdpi.com/1424-8220/18/10/3337" rel="nofollow">SECOND</a>（Sparsely Embedded Convolutional Detection） 为例展示如何开发新的组成模块。</p> 
<h5><a id="1__backbone_SECOND_69"></a>1. 定义一个新的 backbone（如 SECOND）</h5> 
<p>创建一个新文件 <code>mmdet3d/models/backbones/second.py</code> ：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn

<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>builder <span class="token keyword">import</span> BACKBONES


<span class="token decorator annotation punctuation">@BACKBONES<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">SECOND</span><span class="token punctuation">(</span>BaseModule<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># should return a tuple</span>
        <span class="token keyword">pass</span>
</code></pre> 
<h5><a id="2__89"></a>2. 导入新建模块</h5> 
<p>用户可以通过添加下面这行代码到 <code>mmdet3d/models/backbones/__init__.py</code> 中</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>second <span class="token keyword">import</span> SECOND
</code></pre> 
<p>或者添加以下的代码到配置文件中，从而能够在避免修改源码的情况下导入新建模块。</p> 
<pre><code class="prism language-python">custom_imports <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    imports<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'mmdet3d.models.backbones.second'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_failed_imports<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="3__backbone_105"></a>3. 在配置文件中使用 backbone</h5> 
<pre><code class="prism language-python">model <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    backbone<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'SECOND'</span><span class="token punctuation">,</span>
        arg1<span class="token operator">=</span>xxx<span class="token punctuation">,</span>
        arg2<span class="token operator">=</span>xxx<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h4><a id="_necks_117"></a>添加新建 necks</h4> 
<h5><a id="1__neck_SECONDFPN_119"></a>1. 定义一个新的 neck（如 SECONDFPN）</h5> 
<p>创建一个新文件 <code>mmdet3d/models/necks/second_fpn.py</code> ：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>builder <span class="token keyword">import</span> NECKS

<span class="token decorator annotation punctuation">@NECKS<span class="token punctuation">.</span>register</span>
<span class="token keyword">class</span> <span class="token class-name">SECONDFPN</span><span class="token punctuation">(</span>BaseModule<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 in_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                 out_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                 upsample_strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                 norm_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'BN'</span><span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 upsample_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'deconv'</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 conv_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Conv2d'</span><span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 use_conv_for_no_stride<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 init_cfg<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># implementation is ignored</span>
        <span class="token keyword">pass</span>
</code></pre> 
<h5><a id="2__145"></a>2. 导入新建模块</h5> 
<p>用户可以通过添加下面这行代码到 <code>mmdet3D/models/necks/__init__.py</code> 中</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>second_fpn <span class="token keyword">import</span> SECONDFPN
</code></pre> 
<p>或者添加以下的代码到配置文件中，从而能够在避免修改源码的情况下导入新建模块。</p> 
<pre><code class="prism language-python">custom_imports <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    imports<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'mmdet3d.models.necks.second_fpn'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_failed_imports<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="3__neck_161"></a>3. 在配置文件中使用 neck</h5> 
<pre><code class="prism language-python">model <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    neck<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'SECONDFPN'</span><span class="token punctuation">,</span>
        in_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        upsample_strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        out_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h4><a id="_heads_174"></a>添加新建 heads</h4> 
<p>接下来我们以 <a href="https://arxiv.org/abs/1907.03670" rel="nofollow">PartA2 Head</a> 为例展示如何开发新的组成模块。</p> 
<p><strong>注意</strong>：此处展示的 PartA2 RoI Head 将应用于双阶段检测器中，对于单阶段检测器，请参考 <code>mmdet3d/models/dense_heads/</code> 中所展示的例子。由于这些 heads 简单高效，因此这些 heads 普遍应用在自动驾驶场景下的 3D 检测任务中。</p> 
<p>首先，在 <code>mmdet3d/models/roi_heads/bbox_heads/parta2_bbox_head.py</code> 中创建一个新的 bbox head。<br> PartA2 RoI Head 实现一个新的 bbox head ，并用于目标检测的任务中。<br> 为了实现一个新的 bbox head，通常需要在其中实现三个功能，如下所示，有时该模块还需要实现其他相关的功能，如 <code>loss</code> 和 <code>get_targets</code>。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> mmdet<span class="token punctuation">.</span>models<span class="token punctuation">.</span>builder <span class="token keyword">import</span> HEADS
<span class="token keyword">from</span> <span class="token punctuation">.</span>bbox_head <span class="token keyword">import</span> BBoxHead

<span class="token decorator annotation punctuation">@HEADS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">PartA2BboxHead</span><span class="token punctuation">(</span>BaseModule<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""PartA2 RoI head."""</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 num_classes<span class="token punctuation">,</span>
                 seg_in_channels<span class="token punctuation">,</span>
                 part_in_channels<span class="token punctuation">,</span>
                 seg_conv_channels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 part_conv_channels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 merge_conv_channels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 down_conv_channels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 shared_fc_channels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 cls_channels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 reg_channels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 dropout_ratio<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
                 roi_feat_size<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span>
                 with_corner_loss<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                 bbox_coder<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'DeltaXYZWLHRBBoxCoder'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 conv_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Conv1d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 norm_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'BN1d'</span><span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 loss_bbox<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
                     <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'SmoothL1Loss'</span><span class="token punctuation">,</span> beta<span class="token operator">=</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">9.0</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 loss_cls<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
                     <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span>
                     use_sigmoid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                     reduction<span class="token operator">=</span><span class="token string">'none'</span><span class="token punctuation">,</span>
                     loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 init_cfg<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>PartA2BboxHead<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>init_cfg<span class="token operator">=</span>init_cfg<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> seg_feats<span class="token punctuation">,</span> part_feats<span class="token punctuation">)</span><span class="token punctuation">:</span>

</code></pre> 
<p>其次，如果有必要的话，用户还需要实现一个新的 RoI Head，此处我们从 <code>Base3DRoIHead</code> 中继承得到一个新类 <code>PartAggregationROIHead</code>，此时我们就能发现 <code>Base3DRoIHead</code> 已经实现了下面的功能：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> abc <span class="token keyword">import</span> ABCMeta<span class="token punctuation">,</span> abstractmethod
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn <span class="token keyword">as</span> nn


<span class="token decorator annotation punctuation">@HEADS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Base3DRoIHead</span><span class="token punctuation">(</span>BaseModule<span class="token punctuation">,</span> metaclass<span class="token operator">=</span>ABCMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Base class for 3d RoIHeads."""</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 bbox_head<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 mask_roi_extractor<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 mask_head<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 train_cfg<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 test_cfg<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 init_cfg<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">with_bbox</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">with_mask</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token decorator annotation punctuation">@abstractmethod</span>
    <span class="token keyword">def</span> <span class="token function">init_weights</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pretrained<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token decorator annotation punctuation">@abstractmethod</span>
    <span class="token keyword">def</span> <span class="token function">init_bbox_head</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token decorator annotation punctuation">@abstractmethod</span>
    <span class="token keyword">def</span> <span class="token function">init_mask_head</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token decorator annotation punctuation">@abstractmethod</span>
    <span class="token keyword">def</span> <span class="token function">init_assigner_sampler</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token decorator annotation punctuation">@abstractmethod</span>
    <span class="token keyword">def</span> <span class="token function">forward_train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                      x<span class="token punctuation">,</span>
                      img_metas<span class="token punctuation">,</span>
                      proposal_list<span class="token punctuation">,</span>
                      gt_bboxes<span class="token punctuation">,</span>
                      gt_labels<span class="token punctuation">,</span>
                      gt_bboxes_ignore<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                      <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">simple_test</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                    x<span class="token punctuation">,</span>
                    proposal_list<span class="token punctuation">,</span>
                    img_metas<span class="token punctuation">,</span>
                    proposals<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                    rescale<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                    <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Test without augmentation."""</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">aug_test</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> proposal_list<span class="token punctuation">,</span> img_metas<span class="token punctuation">,</span> rescale<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Test with augmentations.
        If rescale is False, then returned bboxes and masks will fit the scale
        of imgs[0].
        """</span>
        <span class="token keyword">pass</span>

</code></pre> 
<p>接着将会对 bbox_forward 的逻辑进行修改，同时，bbox_forward 还会继承来自 <code>Base3DRoIHead</code> 的其他逻辑，在 <code>mmdet3d/models/roi_heads/part_aggregation_roi_head.py</code> 中，我们实现了新的 RoI Head，如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">import</span> functional <span class="token keyword">as</span> F

<span class="token keyword">from</span> mmdet3d<span class="token punctuation">.</span>core <span class="token keyword">import</span> AssignResult
<span class="token keyword">from</span> mmdet3d<span class="token punctuation">.</span>core<span class="token punctuation">.</span>bbox <span class="token keyword">import</span> bbox3d2result<span class="token punctuation">,</span> bbox3d2roi
<span class="token keyword">from</span> mmdet<span class="token punctuation">.</span>core <span class="token keyword">import</span> build_assigner<span class="token punctuation">,</span> build_sampler
<span class="token keyword">from</span> mmdet<span class="token punctuation">.</span>models <span class="token keyword">import</span> HEADS
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>builder <span class="token keyword">import</span> build_head<span class="token punctuation">,</span> build_roi_extractor
<span class="token keyword">from</span> <span class="token punctuation">.</span>base_3droi_head <span class="token keyword">import</span> Base3DRoIHead


<span class="token decorator annotation punctuation">@HEADS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">PartAggregationROIHead</span><span class="token punctuation">(</span>Base3DRoIHead<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Part aggregation roi head for PartA2.
    Args:
        semantic_head (ConfigDict): Config of semantic head.
        num_classes (int): The number of classes.
        seg_roi_extractor (ConfigDict): Config of seg_roi_extractor.
        part_roi_extractor (ConfigDict): Config of part_roi_extractor.
        bbox_head (ConfigDict): Config of bbox_head.
        train_cfg (ConfigDict): Training config.
        test_cfg (ConfigDict): Testing config.
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 semantic_head<span class="token punctuation">,</span>
                 num_classes<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
                 seg_roi_extractor<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 part_roi_extractor<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 bbox_head<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 train_cfg<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 test_cfg<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 init_cfg<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>PartAggregationROIHead<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>
            bbox_head<span class="token operator">=</span>bbox_head<span class="token punctuation">,</span>
            train_cfg<span class="token operator">=</span>train_cfg<span class="token punctuation">,</span>
            test_cfg<span class="token operator">=</span>test_cfg<span class="token punctuation">,</span>
            init_cfg<span class="token operator">=</span>init_cfg<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>num_classes <span class="token operator">=</span> num_classes
        <span class="token keyword">assert</span> semantic_head <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>semantic_head <span class="token operator">=</span> build_head<span class="token punctuation">(</span>semantic_head<span class="token punctuation">)</span>

        <span class="token keyword">if</span> seg_roi_extractor <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>seg_roi_extractor <span class="token operator">=</span> build_roi_extractor<span class="token punctuation">(</span>seg_roi_extractor<span class="token punctuation">)</span>
        <span class="token keyword">if</span> part_roi_extractor <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>part_roi_extractor <span class="token operator">=</span> build_roi_extractor<span class="token punctuation">(</span>part_roi_extractor<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>init_assigner_sampler<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_bbox_forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> seg_feats<span class="token punctuation">,</span> part_feats<span class="token punctuation">,</span> voxels_dict<span class="token punctuation">,</span> rois<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Forward function of roi_extractor and bbox_head used in both
        training and testing.
        Args:
            seg_feats (torch.Tensor): Point-wise semantic features.
            part_feats (torch.Tensor): Point-wise part prediction features.
            voxels_dict (dict): Contains information of voxels.
            rois (Tensor): Roi boxes.
        Returns:
            dict: Contains predictions of bbox_head and
                features of roi_extractor.
        """</span>
        pooled_seg_feats <span class="token operator">=</span> self<span class="token punctuation">.</span>seg_roi_extractor<span class="token punctuation">(</span>seg_feats<span class="token punctuation">,</span>
                                                  voxels_dict<span class="token punctuation">[</span><span class="token string">'voxel_centers'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                  voxels_dict<span class="token punctuation">[</span><span class="token string">'coors'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                  rois<span class="token punctuation">)</span>
        pooled_part_feats <span class="token operator">=</span> self<span class="token punctuation">.</span>part_roi_extractor<span class="token punctuation">(</span>
            part_feats<span class="token punctuation">,</span> voxels_dict<span class="token punctuation">[</span><span class="token string">'voxel_centers'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            voxels_dict<span class="token punctuation">[</span><span class="token string">'coors'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rois<span class="token punctuation">)</span>
        cls_score<span class="token punctuation">,</span> bbox_pred <span class="token operator">=</span> self<span class="token punctuation">.</span>bbox_head<span class="token punctuation">(</span>pooled_seg_feats<span class="token punctuation">,</span>
                                              pooled_part_feats<span class="token punctuation">)</span>

        bbox_results <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
            cls_score<span class="token operator">=</span>cls_score<span class="token punctuation">,</span>
            bbox_pred<span class="token operator">=</span>bbox_pred<span class="token punctuation">,</span>
            pooled_seg_feats<span class="token operator">=</span>pooled_seg_feats<span class="token punctuation">,</span>
            pooled_part_feats<span class="token operator">=</span>pooled_part_feats<span class="token punctuation">)</span>
        <span class="token keyword">return</span> bbox_results
</code></pre> 
<p>此处我们省略了与其他功能相关的细节，请参考 <a href="https://github.com/open-mmlab/mmdetection3d/blob/master/mmdet3d/models/roi_heads/part_aggregation_roi_head.py">此处</a> 获取更多细节。</p> 
<p>最后，用户需要在 <code>mmdet3d/models/bbox_heads/__init__.py</code> 和 <code>mmdet3d/models/roi_heads/__init__.py</code> 中添加新模块，使得对应的注册器能够发现并加载该模块。</p> 
<p>此外，用户也可以添加以下的代码到配置文件中，从而实现相同的目标。</p> 
<pre><code class="prism language-python">custom_imports<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
    imports<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'mmdet3d.models.roi_heads.part_aggregation_roi_head'</span><span class="token punctuation">,</span> <span class="token string">'mmdet3d.models.roi_heads.bbox_heads.parta2_bbox_head'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>PartAggregationROIHead 的配置文件如下所示：</p> 
<pre><code class="prism language-python">model <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    roi_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
        <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'PartAggregationROIHead'</span><span class="token punctuation">,</span>
        num_classes<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
        semantic_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'PointwiseSemanticHead'</span><span class="token punctuation">,</span>
            in_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
            extra_width<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span>
            seg_score_thr<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
            num_classes<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
            loss_seg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'FocalLoss'</span><span class="token punctuation">,</span>
                use_sigmoid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                reduction<span class="token operator">=</span><span class="token string">'sum'</span><span class="token punctuation">,</span>
                gamma<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">,</span>
                alpha<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>
                loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            loss_part<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span> use_sigmoid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        seg_roi_extractor<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Single3DRoIAwareExtractor'</span><span class="token punctuation">,</span>
            roi_layer<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RoIAwarePool3d'</span><span class="token punctuation">,</span>
                out_size<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span>
                max_pts_per_voxel<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span>
                mode<span class="token operator">=</span><span class="token string">'max'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        part_roi_extractor<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'Single3DRoIAwareExtractor'</span><span class="token punctuation">,</span>
            roi_layer<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'RoIAwarePool3d'</span><span class="token punctuation">,</span>
                out_size<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span>
                max_pts_per_voxel<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">,</span>
                mode<span class="token operator">=</span><span class="token string">'avg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        bbox_head<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'PartA2BboxHead'</span><span class="token punctuation">,</span>
            num_classes<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
            seg_in_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>
            part_in_channels<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
            seg_conv_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            part_conv_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            merge_conv_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            down_conv_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            bbox_coder<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'DeltaXYZWLHRBBoxCoder'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            shared_fc_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            cls_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            reg_channels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            dropout_ratio<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
            roi_feat_size<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span>
            with_corner_loss<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            loss_bbox<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'SmoothL1Loss'</span><span class="token punctuation">,</span>
                beta<span class="token operator">=</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">9.0</span><span class="token punctuation">,</span>
                reduction<span class="token operator">=</span><span class="token string">'sum'</span><span class="token punctuation">,</span>
                loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            loss_cls<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
                <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'CrossEntropyLoss'</span><span class="token punctuation">,</span>
                use_sigmoid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                reduction<span class="token operator">=</span><span class="token string">'sum'</span><span class="token punctuation">,</span>
                loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">)</span>
</code></pre> 
<p>MMDetection 2.0 支持配置文件之间的继承，使得用户能够更加关注自己的配置文件的修改。<br> PartA2 Head 的第二阶段主要使用新建的 <code>PartAggregationROIHead</code> 和 <code>PartA2BboxHead</code>，需要根据对应模块的 <code>__init__</code> 参数来设置对应的参数。</p> 
<h4><a id="_loss_451"></a>添加新建 loss</h4> 
<p>假定用户想要新添一个用于检测框回归的 loss，并命名为 <code>MyLoss</code>。<br> 为了添加一个新的 loss ，用于需要在 <code>mmdet3d/models/losses/my_loss.py</code> 中实现对应的逻辑。<br> 装饰器 <code>weighted_loss</code> 能够保证对 batch 中每个样本的 loss 进行加权平均。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn

<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>builder <span class="token keyword">import</span> LOSSES
<span class="token keyword">from</span> <span class="token punctuation">.</span>utils <span class="token keyword">import</span> weighted_loss

<span class="token decorator annotation punctuation">@weighted_loss</span>
<span class="token keyword">def</span> <span class="token function">my_loss</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">assert</span> pred<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> target<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">and</span> target<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
    loss <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>pred <span class="token operator">-</span> target<span class="token punctuation">)</span>
    <span class="token keyword">return</span> loss

<span class="token decorator annotation punctuation">@LOSSES<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">MyLoss</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">'mean'</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MyLoss<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>reduction <span class="token operator">=</span> reduction
        self<span class="token punctuation">.</span>loss_weight <span class="token operator">=</span> loss_weight

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                pred<span class="token punctuation">,</span>
                target<span class="token punctuation">,</span>
                weight<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                avg_factor<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                reduction_override<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> reduction_override <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'none'</span><span class="token punctuation">,</span> <span class="token string">'mean'</span><span class="token punctuation">,</span> <span class="token string">'sum'</span><span class="token punctuation">)</span>
        reduction <span class="token operator">=</span> <span class="token punctuation">(</span>
            reduction_override <span class="token keyword">if</span> reduction_override <span class="token keyword">else</span> self<span class="token punctuation">.</span>reduction<span class="token punctuation">)</span>
        loss_bbox <span class="token operator">=</span> self<span class="token punctuation">.</span>loss_weight <span class="token operator">*</span> my_loss<span class="token punctuation">(</span>
            pred<span class="token punctuation">,</span> target<span class="token punctuation">,</span> weight<span class="token punctuation">,</span> reduction<span class="token operator">=</span>reduction<span class="token punctuation">,</span> avg_factor<span class="token operator">=</span>avg_factor<span class="token punctuation">)</span>
        <span class="token keyword">return</span> loss_bbox
</code></pre> 
<p>接着，用户需要将 loss 添加到 <code>mmdet3d/models/losses/__init__.py</code>：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>my_loss <span class="token keyword">import</span> MyLoss<span class="token punctuation">,</span> my_loss

</code></pre> 
<p>此外，用户也可以添加以下的代码到配置文件中，从而实现相同的目标。</p> 
<pre><code class="prism language-python">custom_imports<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>
    imports<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'mmdet3d.models.losses.my_loss'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>为了使用该 loss，需要对 <code>loss_xxx</code> 域进行修改。<br> 因为 MyLoss 主要用于检测框的回归，因此需要在对应的 head 中修改 <code>loss_bbox</code> 域的值。</p> 
<pre><code class="prism language-python">loss_bbox<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'MyLoss'</span><span class="token punctuation">,</span> loss_weight<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e7b29779c436bd8fe348e44b3d8537c4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java面向对象--方法重写和多态</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3fb8b57592c2189c909a51b7d824b5b3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">window nvm安装踩坑</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>