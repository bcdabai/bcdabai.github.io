<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>学习C&#43;&#43;项目—— 搭建多线程网络服务框架，性能测试（并发性能测试，业务性能测试，客户端响应时间测试，网络带宽测试） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="学习C&#43;&#43;项目—— 搭建多线程网络服务框架，性能测试（并发性能测试，业务性能测试，客户端响应时间测试，网络带宽测试）" />
<meta property="og:description" content="学习计算机网络编程 一、思路和学习方法 本文学习于：C语言技术网（www.freecplus.net），在 b 站学习于 C 语言技术网，并加以自己的一些理解和复现，如有侵权会删除。
接下来对网络编程继续深入学习。通过上篇文章学习，感觉对每个点都记录会很花费时间，但是不记录又对有些地方理解一知半解，综合考虑，先运行出来，对每行代码如何执行要明白，实现什么功能也要明白，freecplus 框架里面知识，后面再仔细学习。
二、网络编程继续深入 2.1 搭建多线程网络服务框架 使用多线程方式搭建网络服务框架，在实际应用中会广泛一些，但是难度也会高一些。下面开始进行学习，在这之前有一些前置知识，要对多线程网络通信等知识进行学习。其中服务端程序如下，
/* * 程序功能： * 作者：C语言技术网(www.freecplus.net) 日期：20190525 */ #include &#34;_freecplus.h&#34; void *pthmain(void * arg); // 线程主函数 vector&lt;long&gt; vpthid; // 存放线程 id 的容器 void mainexit(int sig); // 信号 2 和 15 的处理函数 void pthmainexit(void * arg); // 线程清理函数 CLogFile logfile; CTcpServer TcpServer; // 创建服务端对象 // 处理业务的主函数 bool _main(const char *strrecvbuffer, char *strsendbuffer); // 心跳报文 bool biz000(const char *strrecvbuffer, char *strsendbuffer); // 身份验证业务处理函数 bool biz001(const char *strrecvbuffer, char *strsendbuffer); // 查询余业务处理函数 bool biz002(const char *strrecvbuffer, char *strsendbuffer); int main(int argc, char *argv[]){ if(argc !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/3d2d2dc959cbfd142755abfd018a7c0c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-31T19:01:06+08:00" />
<meta property="article:modified_time" content="2021-10-31T19:01:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">学习C&#43;&#43;项目—— 搭建多线程网络服务框架，性能测试（并发性能测试，业务性能测试，客户端响应时间测试，网络带宽测试）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>学习计算机网络编程</h3> 
<h3><a id="_1"></a>一、思路和学习方法</h3> 
<p>  本文学习于：<strong>C语言技术网（www.freecplus.net）</strong>，在 b 站学习于 <strong>C 语言技术网</strong>，并加以自己的一些理解和复现，如有侵权会删除。<br>   接下来对网络编程继续深入学习。通过上篇文章学习，感觉对每个点都记录会很花费时间，但是不记录又对有些地方理解一知半解，综合考虑，先运行出来，对每行代码如何执行要明白，实现什么功能也要明白，freecplus 框架里面知识，后面再仔细学习。</p> 
<h3><a id="_5"></a>二、网络编程继续深入</h3> 
<h5><a id="21__6"></a>2.1 搭建多线程网络服务框架</h5> 
<p>  使用多线程方式搭建网络服务框架，在实际应用中会广泛一些，但是难度也会高一些。下面开始进行学习，在这之前有一些前置知识，<strong>要对多线程网络通信等知识进行学习</strong>。其中服务端程序如下，</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*
 * 程序功能：
 * 作者：C语言技术网(www.freecplus.net) 日期：20190525
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"_freecplus.h"</span></span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pthmain</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 线程主函数</span>
vector<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">&gt;</span> vpthid<span class="token punctuation">;</span>  <span class="token comment">// 存放线程 id 的容器</span>
<span class="token keyword">void</span> <span class="token function">mainexit</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 信号 2 和 15 的处理函数</span>
<span class="token keyword">void</span> <span class="token function">pthmainexit</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 线程清理函数</span>

CLogFile logfile<span class="token punctuation">;</span>
CTcpServer TcpServer<span class="token punctuation">;</span>  <span class="token comment">// 创建服务端对象</span>

<span class="token comment">//  处理业务的主函数</span>
<span class="token keyword">bool</span> <span class="token function">_main</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strrecvbuffer<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  心跳报文</span>
<span class="token keyword">bool</span> <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strrecvbuffer<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  身份验证业务处理函数</span>
<span class="token keyword">bool</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strrecvbuffer<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  查询余业务处理函数</span>
<span class="token keyword">bool</span> <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strrecvbuffer<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using:./ExitAndFreeServer port logfile\nExample:./ExitAndFreeServer 5005 /tmp/ExitAndFreeServer.log\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token comment">// 关闭全部的信号，也把僵尸进程关闭</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;=</span> <span class="token number">64</span><span class="token punctuation">;</span> ii<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">signal</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">// 打开日志文件</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>logfile<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"a+"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"logfile.Open(%s) failed.\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token comment">// 设置信号，在 shell 状态下可用 “kill + 进程号”正常终止些进程 Ctrl + c</span>
     <span class="token comment">// 但请不要用 “kill -9 + 进程号”</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> mainexit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> mainexit<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">// 初始化 TcpServer 的通信端口</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>TcpServer<span class="token punctuation">.</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	 logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"TcpServer.InitServer(%s) failed. \n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>TcpServer<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">// 等待客户端连接</span>
	   logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"TcpServer.Accept() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

         <span class="token comment">// 以下是子进程，负责与客户端通信</span>
       logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"客户端（%s）已连接。 \n"</span><span class="token punctuation">,</span> TcpServer<span class="token punctuation">.</span><span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       pthread_t pthid<span class="token punctuation">;</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> pthid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pthmain<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>TcpServer<span class="token punctuation">.</span>m_connfd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
         logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"pthread_create failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 
         <span class="token punctuation">}</span>
       vpthid<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>pthid<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//  把线程 id 保存到 vpthid 容器中</span>
    <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">pthmain</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token function">pthread_cleanup_push</span><span class="token punctuation">(</span>pthmainexit<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//  设置线程清理函数</span>
  <span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//  分离线程</span>
  <span class="token function">pthread_setcanceltype</span><span class="token punctuation">(</span>PTHREAD_CANCEL_DISABLE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//  设置取消方式为立即取消</span>

  <span class="token keyword">int</span> socket <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>  <span class="token comment">//  客户端的 socket 连接</span>

  <span class="token keyword">int</span> ibuflen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span> strrecvbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> strsendbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">//  存放数据的缓冲区</span>

  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token function">memset</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">memset</span><span class="token punctuation">(</span>strsendbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// 接收客户端发过来的请求报文</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">TcpRead</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> strrecvbuffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ibuflen<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
     logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"接收：%s \n"</span><span class="token punctuation">,</span> strrecvbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// 处理业务的主函数</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">_main</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span> strsendbuffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

     logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"发送：%s \n"</span><span class="token punctuation">,</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">TcpWrite</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> strsendbuffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 向客户端回应报文</span>
    <span class="token punctuation">}</span>
   <span class="token function">pthread_cleanup_pop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pthmainexit</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> arg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"pthmainexit begin.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//  关闭与客户端的 socket</span>
   <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//  从 vpthid 中删除本线程的 id</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> vpthid<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ii<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>vpthid<span class="token punctuation">[</span>ii<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        vpthid<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>vpthid<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ii<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
   logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"pthmainexit end.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//  信号 2 和 15 的处理函数</span>
<span class="token keyword">void</span> <span class="token function">mainexit</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"mainexit begin. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
   <span class="token comment">//  关闭监听的 socket</span>
  TcpServer<span class="token punctuation">.</span><span class="token function">CloseListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//  取消全部的线程</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> vpthid<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ii<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"cancel %ld\n"</span><span class="token punctuation">,</span> vpthid<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">pthread_cancel</span><span class="token punctuation">(</span>vpthid<span class="token punctuation">[</span>ii<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

  logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"mainexit end.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">_main</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token comment">// 处理业务的主函数</span>
   <span class="token keyword">int</span> ibizcode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

   <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span> <span class="token string">"bizcode"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ibizcode<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">switch</span><span class="token punctuation">(</span>ibizcode<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token comment">// 心跳</span>
       <span class="token function">biz000</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token comment">// 身份验证</span>
       <span class="token function">biz001</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token comment">// 余额查询</span>
       <span class="token function">biz002</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

     <span class="token keyword">default</span><span class="token operator">:</span>
       logfile<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"非法报文：%s\n"</span><span class="token punctuation">,</span> strrecvbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//  身份验证业务处理函数</span>
<span class="token keyword">bool</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> strrecvbuffer<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   <span class="token keyword">char</span> username<span class="token punctuation">[</span><span class="token number">51</span><span class="token punctuation">]</span><span class="token punctuation">,</span> password<span class="token punctuation">[</span><span class="token number">51</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token function">memset</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">memset</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span> <span class="token string">"username"</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token string">"wucz"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token string">"p@ssw0rd"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
     <span class="token function">sprintf</span><span class="token punctuation">(</span>strsendbuffer<span class="token punctuation">,</span> <span class="token string">"&lt;retcode&gt;0&lt;/retcode&gt;&lt;message&gt;成功。&lt;/message&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">else</span>
     <span class="token function">sprintf</span><span class="token punctuation">(</span>strsendbuffer<span class="token punctuation">,</span> <span class="token string">"&lt;retcode&gt;-1&lt;/retcode&gt;&lt;message&gt;用户名或密码不正确。&lt;/message&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strrecvbuffer<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   <span class="token keyword">char</span> cardid<span class="token punctuation">[</span><span class="token number">51</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token function">memset</span><span class="token punctuation">(</span>cardid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cardid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strrecvbuffer<span class="token punctuation">,</span> <span class="token string">"cardid"</span><span class="token punctuation">,</span> cardid<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cardid<span class="token punctuation">,</span> <span class="token string">"62620000000001"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token function">sprintf</span><span class="token punctuation">(</span>strsendbuffer<span class="token punctuation">,</span> <span class="token string">"&lt;retcode&gt;0&lt;/retcode&gt;&lt;message&gt;成功。&lt;/message&gt;&lt;ye&gt;100.50&lt;/ye&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">else</span>
     <span class="token function">sprintf</span><span class="token punctuation">(</span>strsendbuffer<span class="token punctuation">,</span> <span class="token string">"&lt;retcode&gt;-1&lt;/retcode&gt;&lt;message&gt;卡号不存在。&lt;/message&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>strrecvbuffer<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>strsendbuffer<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   <span class="token function">sprintf</span><span class="token punctuation">(</span>strsendbuffer<span class="token punctuation">,</span> <span class="token string">"&lt;retcode&gt;0&lt;/retcode&gt;&lt;message&gt;成功。&lt;/message&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  客户端程序不变化，然后运行结果如下，<br> <img src="https://images2.imgbox.com/f4/cf/akz3Klry_o.png" alt="在这里插入图片描述"><br>   可以看出实现功能满足和多进程实现的一样。里面线程的一些知识，在后面会继续学习，但是其功能能够大致看懂。接下来继续学习。<br>   其中要注意的点有，使用多进程中和 socketfd 和多线程里面的 socketfd 是不一样的，因此用两种方式来进行通信。这些在 up 主前面视频都讲过。</p> 
<h5><a id="22__193"></a>2.2 性能测试的重要性</h5> 
<p>  在实际项目开发中，除了完成程序的功能，还需要测试性能。 <strong>在充分了解服务端的性能后，才能决定如何选择服务端的框架，还有网络带宽、硬件配置等。</strong> 服务端的性能指标是面试中必问的。如果不了解性能指标，面试官会认为你没有实际开发经验或对网络编程一知半解。主要性能指标如下：<strong>1. 服务端的并发能力；(可以同时响应多少业务) 2. 服务端的业务处理能力；(每段时间可以响应多少业务请求) 3. 客户端业务响应时效；(响应需要的时间) 4. 网络宽带。(和网络流量请求)</strong></p> 
<h5><a id="23__195"></a>2.3 服务端并发性能测试</h5> 
<p>  服务端最大并发量，即可以接受客户端连接的最大数量。注意客户端业务请求不要太频繁。重视 CPU 和内存使用率的变化(磁盘 I/O，网络 I/O)。在性能测试时，<strong>最好是客户端用一台独立的虚拟机，服务端测试程序用另外一台独立的虚拟机，不然会导致测试不准确</strong>。为了学习过程，我就在同一台虚拟机上面跑了，以后在正式测试中再使用其他方法。这里需要注意几个语句，</p> 
<pre><code class="prism language-cpp"><span class="token comment">//  查看进程数量</span>
ps <span class="token operator">-</span>ef <span class="token operator">|</span>grep ExitAndFreeServer<span class="token operator">|</span>wc  

<span class="token comment">//  运行 sh 脚本文件，和 touch 配合使用 </span>
touch test<span class="token punctuation">.</span>sh  <span class="token comment">//  加入运行脚本文件</span>
sh test<span class="token punctuation">.</span>h

<span class="token comment">//  查看资源内存</span>
free <span class="token operator">-</span>m

<span class="token comment">//  查看 cpu 资源</span>
top
</code></pre> 
<p>  其中客户端程序改为如下，只有心跳程序开启，然后运行，</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*
 * 程序功能：
 * 作者：C语言技术网(www.freecplus.net) 日期：20190525
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"_freecplus.h"</span></span>

CTcpClient TcpClient<span class="token punctuation">;</span>  <span class="token comment">// 创建服务端对象</span>

<span class="token keyword">bool</span> <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 发送心跳报文</span>
<span class="token keyword">bool</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 身份验证</span>
<span class="token keyword">bool</span> <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 余额查询</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using:./client ip port\n Example:./client 127.0.0.1 5005\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">ConnectToServer</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//  向服务端发起连接请求</span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpClient.ConnectToServer(\"%s\", %s) failed.\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/*
   // 身份验证
  if(biz001() == false){
     printf("biz001() failed.\n"); return -1; 
  }
  sleep(10); 
  biz002();  // 余额查询

  sleep(5);
  biz002();  // 余额查询
   */</span>
   
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> ii<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">//  程序直接退出，析构函数会释放资源</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">// </span>
  <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放数据的缓存区</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"&lt;bizcode&gt;1&lt;/bizcode&gt;&lt;username&gt;wucz&lt;/username&gt;&lt;password&gt;p@ssw0rd&lt;/password&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 向服务端发送请求报文</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 接收服务端的回应报文</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收：%s\n"</span><span class="token punctuation">,</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> iretcode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token string">"retcode"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>iretcode<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>iretcode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"身份验证成功。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"身份验证失败。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">bool</span> <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 存放数据的缓冲区</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"&lt;bizcode&gt;2&lt;/bizcode&gt;&lt;cardid&gt;62620000000001&lt;/cardid&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span> strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 向服务端发送请求报文</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 接收服务端的回应报文</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收：%s\n"</span><span class="token punctuation">,</span> strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> iretcode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token string">"retcode"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>iretcode<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>iretcode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"查询余额成功。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"查询余额成功。\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">// 发送心跳报文</span>
  <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放数据的缓存区</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"&lt;bizcode&gt;0&lt;/bizcode&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// printf("发送：%s\n",strbuffer);</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 向服务端发送请求报文</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 接收服务端的回应报文</span>
  <span class="token comment">// printf("接收：%s\n",strbuffer);</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  在这里建立了一个 sh 文件脚本，把客户端程序运行个数 * 4000 ，然后放在 test.sh 文件脚本里，其效果如下。一定要注意的一点，在测试中，最高一次性不要太多，一点一点的加，我为了出效果，直接运行那么多，<br> <img src="https://images2.imgbox.com/87/16/ceXC8D9r_o.png" alt="在这里插入图片描述"><br>   在同一台虚拟机运行，第一次运行 test.sh 文件时，虚拟机开始有点卡；后来第二次运行 test.sh 文件时，资源不够，然后运行卡壳，系统承载不了那么多进程，其运行结果如下，<br> <img src="https://images2.imgbox.com/ec/f1/QCkARt8x_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="24__315"></a>2.4 服务端业务性能测试</h5> 
<p>  服务端最大业务处理能力，即每秒可以处理的业务请求数量。注重客户端的数量不要太多。重视 CPU 和内存使用率的变化。<br>   这里对客户端程序改为，</p> 
<pre><code class="prism language-cpp"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> ii<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>  把 sh 文件中客户端程序运行脚本改为，<br> <img src="https://images2.imgbox.com/c9/f8/HjHY9Cij_o.png" alt="在这里插入图片描述"><br>   运行结果如下，<br> <img src="https://images2.imgbox.com/74/be/Lpd72812_o.png" alt="在这里插入图片描述"><br>   可以看出 CPU 消耗和内存消耗，及其进程的情况。然后为了测试每秒接受信号情况，对接收进行抓包，使用 linux 语句为，</p> 
<pre><code class="prism language-cpp">grep <span class="token string">"2021-10-30 22:11:19 接收"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>ExitAndFreeServer<span class="token punctuation">.</span>log<span class="token operator">|</span>wc
</code></pre> 
<p>  这是在运行过一段时间以后的了，有些客户端程序运行结束了，少了一些，所以运行结果如下，<br> <img src="https://images2.imgbox.com/76/f4/RRjc8Mjg_o.png" alt="在这里插入图片描述"><br>   这就是从日志里面抓取的数据接收情况，分析上面运行结果就能够知道，在当下 19 s 接收的情况，相当于 1s 有 60 条记录。可以看出，这样客户端的压力还不够，继续加压，把测试客户端程序改为，</p> 
<pre><code class="prism language-cpp"><span class="token comment">// 用 killall client 杀死所有相关进程</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> ii<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>  再运行 test.sh 脚本，在运行两次以后，观察到结果如下，<br> <img src="https://images2.imgbox.com/52/76/fN3V1wx5_o.png" alt="在这里插入图片描述"><br>   能够看到，这样测试时候，CPU 资源已经被占用的还剩 16% 多了，现在压力已经相当大了，也可以查看到相应的进程数和内存情况。在过一会后又恢复到了正常情况。<br>   为了能够看出处理业务情况，查看服务端数据报文，然后看 1 s 中报文情况，使用语句</p> 
<pre><code class="prism language-cpp">grep <span class="token string">"2021-10-30 22:41:25 接收"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>ExitAndFreeServer<span class="token punctuation">.</span>log<span class="token operator">|</span>wc
grep <span class="token string">"2021-10-30 22:41:21 接收"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>ExitAndFreeServer<span class="token punctuation">.</span>log<span class="token operator">|</span>wc
</code></pre> 
<p>  使用语句查看服务端报文情况结果如下<br> <img src="https://images2.imgbox.com/66/a1/ettQCCv4_o.png" alt="在这里插入图片描述">  可以看出，在 1s 中接收到 18107 报文，然后 CPU 还剩资源 10% 多，因此知道服务端压力差不多是 18107 。</p> 
<h5><a id="25__352"></a>2.5 多线程/线程服务端性能差异</h5> 
<p>  用相同的方法来测试多进程/多线程。测试的方法是一样的，没有什么变化。需要关注内存，CPU 的情况，这里为了学习进度就不进行实践了。<strong>得出结论，多线程比多进程在 CPU 和内存消耗情况都是占有优势的。</strong></p> 
<h5><a id="26__354"></a>2.6 测试客户端的响应时间</h5> 
<p>  客户端业务的响应时间，即是发出业务请求与收到服务端回应的时间间隔，关系到用户的体验。测试环境：1. 业务的闲时时/忙时；2. 不同的网络环境(局域网、互联网、移动通信网络)。<strong>需要测试需要一个计时器，需要精确到 微秒。</strong><br>   这里测试每个业务运行时间，用到了计时器功能，freecplus 把计时器封装好了，然后直接使用就行。用了定时器，来查看每个业务运行的时间，其中客户端程序如下，</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*
 * 程序功能：
 * 作者：C语言技术网(www.freecplus.net) 日期：20190525
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"_freecplus.h"</span></span>

CTcpClient TcpClient<span class="token punctuation">;</span>  <span class="token comment">// 创建服务端对象</span>

<span class="token keyword">bool</span> <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 发送心跳报文</span>
<span class="token keyword">bool</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 身份验证</span>
<span class="token keyword">bool</span> <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 余额查询</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using:./client ip port\n Example:./client 127.0.0.1 5005\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

  CTimer Timer<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">ConnectToServer</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//  向服务端发起连接请求</span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpClient.ConnectToServer(\"%s\", %s) failed.\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpClient.ConnectToServer() 耗时%lf\n"</span><span class="token punctuation">,</span> Timer<span class="token punctuation">.</span><span class="token function">Elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// 身份验证</span>
  <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"biz001() 耗时%lf\n"</span><span class="token punctuation">,</span> Timer<span class="token punctuation">.</span><span class="token function">Elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 余额查询</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"biz002() 耗时%lf\n"</span><span class="token punctuation">,</span> Timer<span class="token punctuation">.</span><span class="token function">Elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 余额查询</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"biz000() 耗时%lf\n"</span><span class="token punctuation">,</span> Timer<span class="token punctuation">.</span><span class="token function">Elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//  程序直接退出，析构函数会释放资源</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">// </span>
  <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放数据的缓存区</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"&lt;bizcode&gt;1&lt;/bizcode&gt;&lt;username&gt;wucz&lt;/username&gt;&lt;password&gt;p@ssw0rd&lt;/password&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// printf("发送：%s\n",strbuffer);</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 向服务端发送请求报文</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 接收服务端的回应报文</span>
  <span class="token comment">// printf("接收：%s\n",strbuffer);</span>

  <span class="token keyword">int</span> iretcode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token string">"retcode"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>iretcode<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>iretcode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//{ printf("身份验证成功。\n"); }</span>
  <span class="token comment">// printf("身份验证失败。\n");</span>

  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">bool</span> <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 存放数据的缓冲区</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"&lt;bizcode&gt;2&lt;/bizcode&gt;&lt;cardid&gt;62620000000001&lt;/cardid&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// printf("发送：%s\n", strbuffer);</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 向服务端发送请求报文</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 接收服务端的回应报文</span>

  <span class="token comment">// printf("接收：%s\n", strbuffer);</span>

  <span class="token keyword">int</span> iretcode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token string">"retcode"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>iretcode<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>iretcode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment">// {printf("查询余额成功。\n"); return true; }</span>

  <span class="token comment">// printf("查询余额成功。\n"); </span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">// 发送心跳报文</span>
  <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放数据的缓存区</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"&lt;bizcode&gt;0&lt;/bizcode&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// printf("发送：%s\n",strbuffer);</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 向服务端发送请求报文</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 接收服务端的回应报文</span>
  <span class="token comment">// printf("接收：%s\n",strbuffer);</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  结果如下所示，<br> <img src="https://images2.imgbox.com/76/9c/kja9Ld2s_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="27__453"></a>2.7 网络带宽测试</h5> 
<p>  测试的目的是根据业务的 需求，判断出对网络带宽的要求。测试网络带宽，参考这篇文章：https://www.linuxprobe.com/speedtest-network-in-linux.html。测试网络带宽能承载的业务量，不同的业务对宽带的利用率不一样。要求测试环境的各环节不能存在性能的瓶颈，唯一瓶颈就是网络带宽。<strong>注意是只发送数据，不接受回应；上行和下行分开测试。</strong> 其中测试服务端程序为，</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*
 * 程序功能：
 * 作者：C语言技术网(www.freecplus.net) 日期：20190525
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"_freecplus.h"</span></span>

CTcpServer TcpServer<span class="token punctuation">;</span>  <span class="token comment">// 创建服务端对象</span>

<span class="token comment">// 程序退出时调用的函数</span>
<span class="token keyword">void</span> <span class="token function">FathEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 父进程退出函数</span>
<span class="token keyword">void</span> <span class="token function">ChldEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 子进程退出函数</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token comment">// 关闭全部的信号，也把僵尸进程关闭</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;=</span> <span class="token number">64</span><span class="token punctuation">;</span> ii<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token function">signal</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">// 设置信号，在 shell 状态下可用 “kill + 进程号”正常终止些进程 Ctrl + c</span>
     <span class="token comment">// 但请不要用 “kill -9 + 进程号”</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> FathEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> FathEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">// 初始化 TcpServer 的通信端口</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>TcpServer<span class="token punctuation">.</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token number">5005</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	 <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpServer.InitServer(5005) failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">FathEXIT</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>TcpServer<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">// 等待客户端连接</span>
	     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpServer.Accept() failed. \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
	 <span class="token comment">// 父进程返回到循环首部</span>
	 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>TcpServer<span class="token punctuation">.</span><span class="token function">CloseClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

	 <span class="token comment">// 子进程重新设置退出信号</span>
       <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> ChldEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> ChldEXIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

       TcpServer<span class="token punctuation">.</span><span class="token function">CloseListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     
         <span class="token comment">// 以下是子进程，负责与客户端通信</span>
       <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端（%s）已连接。 \n"</span><span class="token punctuation">,</span> TcpServer<span class="token punctuation">.</span><span class="token function">GetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 存放数据的缓冲区</span>

       <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
         <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">// 接收客户端发过来的请求报文</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>TcpServer<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收：%s \n"</span><span class="token punctuation">,</span> strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

     	   <span class="token function">strcat</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在客户端的报文后加上“ok”</span>
	   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送：%s \n"</span><span class="token punctuation">,</span> strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	   <span class="token keyword">if</span><span class="token punctuation">(</span>TcpServer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 向客户端回应报文</span>
         <span class="token punctuation">}</span>
       <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端已断开。 \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 程序直接退出，析构函数会释放资源</span>
       <span class="token function">ChldEXIT</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通信完成后，子进程退出。</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">FathEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">// 父进程退出函数</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sig <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
         <span class="token comment">// 免除不再受到其他信号的打扰</span>
       <span class="token function">signal</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"catching the signal(%d). \n"</span><span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

    <span class="token function">kill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 通知其它的子进程退出。</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"父进程退出。 \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 编写善后代码（释放资源、提交或回滚事务）</span>
   TcpServer<span class="token punctuation">.</span><span class="token function">CloseClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ChldEXIT</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token comment">// 子进程退出函数</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>sig <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
       <span class="token function">signal</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">signal</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"子进程退出。 \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 编写善后代码（释放资源、提交或回滚事务）</span>
   TcpServer<span class="token punctuation">.</span><span class="token function">CloseClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  测试客户端程序为，</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*
 * 程序功能：
 * 作者：C语言技术网(www.freecplus.net) 日期：20190525
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"_freecplus.h"</span></span>

CTcpClient TcpClient<span class="token punctuation">;</span>  <span class="token comment">// 创建服务端对象</span>

<span class="token keyword">bool</span> <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 发送心跳报文</span>
<span class="token keyword">bool</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 身份验证</span>
<span class="token keyword">bool</span> <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 余额查询</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using:./client ip port\n Example:./client 127.0.0.1 5005\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

  CTimer Timer<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">ConnectToServer</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//  向服务端发起连接请求</span>
     <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpClient.ConnectToServer(\"%s\", %s) failed.\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"TcpClient.ConnectToServer() 耗时%lf\n"</span><span class="token punctuation">,</span> Timer<span class="token punctuation">.</span><span class="token function">Elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> ii<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token punctuation">}</span>

   <span class="token comment">// 身份验证</span>
  <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"biz001() 耗时%lf\n"</span><span class="token punctuation">,</span> Timer<span class="token punctuation">.</span><span class="token function">Elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
   
  <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 余额查询</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"biz002() 耗时%lf\n"</span><span class="token punctuation">,</span> Timer<span class="token punctuation">.</span><span class="token function">Elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 余额查询</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"biz000() 耗时%lf\n"</span><span class="token punctuation">,</span> Timer<span class="token punctuation">.</span><span class="token function">Elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//  程序直接退出，析构函数会释放资源</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">// </span>
  <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放数据的缓存区</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"&lt;bizcode&gt;1&lt;/bizcode&gt;&lt;username&gt;wucz&lt;/username&gt;&lt;password&gt;p@ssw0rd&lt;/password&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// printf("发送：%s\n",strbuffer);</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 向服务端发送请求报文</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 接收服务端的回应报文</span>
  <span class="token comment">// printf("接收：%s\n",strbuffer);</span>

  <span class="token keyword">int</span> iretcode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token string">"retcode"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>iretcode<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>iretcode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//{ printf("身份验证成功。\n"); }</span>
  <span class="token comment">// printf("身份验证失败。\n");</span>

  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">bool</span> <span class="token function">biz002</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 存放数据的缓冲区</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"&lt;bizcode&gt;2&lt;/bizcode&gt;&lt;cardid&gt;62620000000001&lt;/cardid&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// printf("发送：%s\n", strbuffer);</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 向服务端发送请求报文</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">// 接收服务端的回应报文</span>

  <span class="token comment">// printf("接收：%s\n", strbuffer);</span>

  <span class="token keyword">int</span> iretcode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token string">"retcode"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>iretcode<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>iretcode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token comment">// {printf("查询余额成功。\n"); return true; }</span>

  <span class="token comment">// printf("查询余额成功。\n"); </span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token function">biz000</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">// 发送心跳报文</span>
  <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放数据的缓存区</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"&lt;bizcode&gt;0&lt;/bizcode&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// printf("发送：%s\n",strbuffer);</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 向服务端发送请求报文</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 接收服务端的回应报文</span>
  <span class="token comment">// printf("接收：%s\n",strbuffer);</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  运行结果如下，<br> <img src="https://images2.imgbox.com/4b/d8/0WqnlNzQ_o.png" alt="在这里插入图片描述"><br>   可以看出在双向发送和接收数据时，发送 10000 个心跳业务双向时间情况。现在改为单向测试，客户端只发送不接收了；服务端只接收不发送了。</p> 
<pre><code class="prism language-cpp"><span class="token comment">// 服务端</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 接收客户端发过来的请求报文</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>TcpServer<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收：%s \n"</span><span class="token punctuation">,</span> strbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">/*
  strcat(strbuffer, "ok"); // 在客户端的报文后加上“ok”
printf("发送：%s \n", strbuffer);
if(TcpServer.Write(strbuffer) == false)break; // 向客户端回应报文
     */</span>
<span class="token punctuation">}</span>

<span class="token comment">// 客户端</span>
<span class="token keyword">bool</span> <span class="token function">biz001</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">// </span>
  <span class="token keyword">char</span> strbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存放数据的缓存区</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"&lt;bizcode&gt;1&lt;/bizcode&gt;&lt;username&gt;wucz&lt;/username&gt;&lt;password&gt;p@ssw0rd&lt;/password&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// printf("发送：%s\n",strbuffer);</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 向服务端发送请求报文</span>
  
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  
  <span class="token function">memset</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TcpClient<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 接收服务端的回应报文</span>
  <span class="token comment">// printf("接收：%s\n",strbuffer);</span>

  <span class="token keyword">int</span> iretcode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">GetXMLBuffer</span><span class="token punctuation">(</span>strbuffer<span class="token punctuation">,</span> <span class="token string">"retcode"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>iretcode<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span>iretcode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//{ printf("身份验证成功。\n"); }</span>
  <span class="token comment">// printf("身份验证失败。\n");</span>

  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  现在查看运行效果，<br> <img src="https://images2.imgbox.com/a3/e6/l45Utcu0_o.png" alt="在这里插入图片描述"><br>   可以看出单向测试效果还是不错的，直接体现了 TCP 单向传输带宽业务情况。我感觉 UP 主要讲了网络测试的方法，还是比较直接但是不太深入，以后至少遇到时候知道怎么处理，学习还在比较表面，以后在项目中再继续理解。</p> 
<h3><a id="_689"></a>三、总结</h3> 
<p>  最近马上就要中期答辩了，在 11 月 6 号，今天准备开始写中期答辩文档和答辩 PPT 了。最近工作先签了海康微视，做一个保底工作，后面继续学习去找一个更好的工作。或者考虑考试公务员或者事业单位，后面看情况吧，C++继续学习着，等 C++ 网络编程，数据库部分学习完，然后肝完项目，深入学习算法，理解这些知识时候再看行测和申论。继续加油。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/97ab0fc97f348bdc4f54eb20076ece64/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">2021-10-31【数据结构练习题】【删除表中值大于min且小于max的节点】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d08e0cbf73b4ab2be5a23dac213b2b75/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java面向对象--类和对象</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>