<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32MP157 u-boot2021.10移植 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32MP157 u-boot2021.10移植" />
<meta property="og:description" content="STM32MP157 u-boot2021.10移植 1. 初次编译2. 移植2.1 添加自己的板子2.2 修改设备树2.2.1 修改串口Uart2.2.2 修改时钟2.2.3 修改电源2.2.4 修改DDR2.2.5 删除LCD HDMI和音频2.2.6 修改EMMC和SD卡2.2.6 修改USB2.2.7 修改ethernet2.2.8 修改LED 3. 编译下载3.1 编译3.2 下载 4. 总结 参考母板是STM32MP157D-DK1开发板，移植开发板为100ASK_STM32MP157_V11。 STM32MP157 tf-a2.6 optee3.16 u-boot2021.10 linux5.15移植STM32MP157启动流程STM32MP157 tf-a2.6移植STM32MP157 optee3.16移植STM32MP157 u-boot2021.10移植STM32MP157 linux5.15移植STM32MP157 buildroot-2022.02.5构建根文件系统 1. 初次编译 解压源码，并打补丁。可以参考README.HOW_TO.txt文件，里面说了怎么解压和打补丁，并且还说了如何编译。
#解压源码 $ tar -xvf u-boot-stm32mp-v2021.10-stm32mp1-r1-r0.tar.xz #进入源码目录 $ cd u-boot-stm32mp-v2021.10-stm32mp1-r1/ #打补丁 $ for p in `ls -1 ../*.patch`; do patch -p1 &lt; $p; done 执行以下命令完成编译，DEPLOYDIR=$FIP_DEPLOYDIR_ROOT/u-boot是U-Boot编译结果存放的目录，如果不设置就会在上一级产生deploy目录存放编译结果，同级目录下生成的build目录存放编译中间文件。
#设置编译器 $ source ../../../../toolchain/environment-setup-cortexa7t2hf-neon-vfpv4-ostl-linux-gnueabi #设置FIP目录 $ export FIP_DEPLOYDIR_ROOT=$PWD/../../FIP_artifacts #编译 $ make -f $PWD/." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/16005a3e0efe7664840238d1d529cc4b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-28T21:13:09+08:00" />
<meta property="article:modified_time" content="2023-06-28T21:13:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32MP157 u-boot2021.10移植</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>STM32MP157 u-boot2021.10移植</h4> 
 <ul><li><a href="#1__9" rel="nofollow">1. 初次编译</a></li><li><a href="#2__43" rel="nofollow">2. 移植</a></li><li><ul><li><a href="#21__44" rel="nofollow">2.1 添加自己的板子</a></li><li><a href="#22__117" rel="nofollow">2.2 修改设备树</a></li><li><ul><li><a href="#221_Uart_119" rel="nofollow">2.2.1 修改串口Uart</a></li><li><a href="#222__179" rel="nofollow">2.2.2 修改时钟</a></li><li><a href="#223__190" rel="nofollow">2.2.3 修改电源</a></li><li><a href="#224_DDR_352" rel="nofollow">2.2.4 修改DDR</a></li><li><a href="#225_LCD_HDMI_465" rel="nofollow">2.2.5 删除LCD HDMI和音频</a></li><li><a href="#226_EMMCSD_553" rel="nofollow">2.2.6 修改EMMC和SD卡</a></li><li><a href="#226_USB_587" rel="nofollow">2.2.6 修改USB</a></li><li><a href="#227_ethernet_660" rel="nofollow">2.2.7 修改ethernet</a></li><li><a href="#228_LED_702" rel="nofollow">2.2.8 修改LED</a></li></ul> 
  </li></ul> 
  </li><li><a href="#3__746" rel="nofollow">3. 编译下载</a></li><li><ul><li><a href="#31__747" rel="nofollow">3.1 编译</a></li><li><a href="#32__752" rel="nofollow">3.2 下载</a></li></ul> 
  </li><li><a href="#4__815" rel="nofollow">4. 总结</a></li></ul> 
</div> 
<br> 参考母板是STM32MP157D-DK1开发板，移植开发板为100ASK_STM32MP157_V11。 
<p></p> 
<ol><li>STM32MP157 tf-a2.6 optee3.16 u-boot2021.10 linux5.15移植</li><li>STM32MP157启动流程</li><li>STM32MP157 tf-a2.6移植</li><li>STM32MP157 optee3.16移植</li><li><strong>STM32MP157 u-boot2021.10移植</strong></li><li>STM32MP157 linux5.15移植</li><li>STM32MP157 buildroot-2022.02.5构建根文件系统</li></ol> 
<h2><a id="1__9"></a>1. 初次编译</h2> 
<p>解压源码，并打补丁。可以参考<code>README.HOW_TO.txt</code>文件，里面说了怎么解压和打补丁，并且还说了如何编译。</p> 
<pre><code class="prism language-bash"><span class="token comment">#解压源码</span>
$ <span class="token function">tar</span> -xvf u-boot-stm32mp-v2021.10-stm32mp1-r1-r0.tar.xz
<span class="token comment">#进入源码目录</span>
$ <span class="token builtin class-name">cd</span> u-boot-stm32mp-v2021.10-stm32mp1-r1/
<span class="token comment">#打补丁</span>
$ <span class="token keyword">for</span> <span class="token for-or-select variable">p</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> -1 <span class="token punctuation">..</span>/*.patch<span class="token variable">`</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> patch -p1 <span class="token operator">&lt;</span> <span class="token variable">$p</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> 
<p>执行以下命令完成编译，<code>DEPLOYDIR=$FIP_DEPLOYDIR_ROOT/u-boot</code>是U-Boot编译结果存放的目录，如果不设置就会在上一级产生<em>deploy</em>目录存放编译结果，同级目录下生成的<em>build</em>目录存放编译中间文件。</p> 
<pre><code class="prism language-bash"><span class="token comment">#设置编译器</span>
$ <span class="token builtin class-name">source</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/toolchain/environment-setup-cortexa7t2hf-neon-vfpv4-ostl-linux-gnueabi
<span class="token comment">#设置FIP目录</span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">FIP_DEPLOYDIR_ROOT</span><span class="token operator">=</span><span class="token environment constant">$PWD</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/FIP_artifacts
<span class="token comment">#编译</span>
$ <span class="token function">make</span> -f <span class="token environment constant">$PWD</span>/<span class="token punctuation">..</span>/Makefile.sdk <span class="token assign-left variable">DEPLOYDIR</span><span class="token operator">=</span><span class="token variable">$FIP_DEPLOYDIR_ROOT</span>/u-boot -j12 all
$ <span class="token function">make</span> -f <span class="token environment constant">$PWD</span>/<span class="token punctuation">..</span>/Makefile.sdk -j12 all
</code></pre> 
<p>因为TF_A和OPTEE我们只编译了参考母板和自己的板子，所以我们删除其他板子。编译还是有错误，没搞懂我们稍加修改，编译通过。但是FIP生成了两次，这是因为<code>UBOOT_CONFIGS += trusted</code>出现了两次，删掉一个即可。<br> <img src="https://images2.imgbox.com/47/19/6kZRueoN_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash"><span class="token comment">#在86行，deploy-targets变量定义之后添加如下代码，定义fip_devicetree变量</span>
fip_devicetree :<span class="token operator">=</span> <span class="token variable"><span class="token variable">$(</span>foreach config, <span class="token punctuation">$(</span>if <span class="token punctuation">$(</span>UBOOT_CONFIG<span class="token punctuation">)</span>,<span class="token punctuation">$(</span>UBOOT_CONFIG<span class="token punctuation">)</span>,<span class="token punctuation">$(</span>UBOOT_CONFIGS<span class="token punctuation">)</span><span class="token variable">)</span></span>, <span class="token punctuation">\</span>
					<span class="token variable"><span class="token variable">$(</span>foreach defconfig, <span class="token punctuation">$(</span>if <span class="token punctuation">$(</span>UBOOT_DEFCONFIG<span class="token punctuation">)</span>,<span class="token punctuation">$(</span>UBOOT_DEFCONFIG<span class="token punctuation">)</span>,<span class="token punctuation">$(</span>UBOOT_DEFCONFIG_<span class="token punctuation">$(</span>config<span class="token punctuation">)</span><span class="token variable">)</span></span><span class="token punctuation">)</span>, <span class="token variable"><span class="token variable">$(</span><span class="token keyword">if</span> <span class="token punctuation">$(</span>DEVICETREE<span class="token punctuation">)</span>,<span class="token punctuation">$(</span>DEVICETREE<span class="token punctuation">)</span>,<span class="token punctuation">$(</span>UBOOT_DEVICETREE_<span class="token punctuation">$(</span>defconfig<span class="token punctuation">)</span><span class="token variable">)</span></span><span class="token punctuation">))</span> <span class="token punctuation">\</span>
					<span class="token punctuation">)</span>

fip: <span class="token variable"><span class="token variable">$(</span>deploy-targets<span class="token variable">)</span></span>
	<span class="token assign-left variable">FIP_DEPLOYDIR_UBOOT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>DEPLOYDIR<span class="token variable">)</span></span> <span class="token assign-left variable">FIP_DEVICETREE</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>DEVICETREE<span class="token variable">)</span></span>"</span> fiptool-stm32mp
<span class="token comment">#将上面两行改为</span>
fip: <span class="token variable"><span class="token variable">$(</span>deploy-targets<span class="token variable">)</span></span>
	<span class="token assign-left variable">FIP_DEPLOYDIR_UBOOT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>DEPLOYDIR<span class="token variable">)</span></span> <span class="token assign-left variable">FIP_DEVICETREE</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>fip_devicetree<span class="token variable">)</span></span>"</span> fiptool-stm32mp
</code></pre> 
<h2><a id="2__43"></a>2. 移植</h2> 
<h3><a id="21__44"></a>2.1 添加自己的板子</h3> 
<p>执行一下命令完成自己的板子文件的创建</p> 
<pre><code class="prism language-bash">$ <span class="token builtin class-name">cd</span> configs/
$ <span class="token function">cp</span> stm32mp15_defconfig stm32mp15_100ask_defconfig
$ <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/arch/arm/dts/
$ <span class="token function">cp</span> stm32mp15xx-dkx.dtsi stm32mp15xx-100ask.dtsi
$ <span class="token function">cp</span> stm32mp157d-dk1.dts stm32mp157d-100ask.dts
<span class="token comment">#因为stm32mp157d-dk1-u-boot.dtsi只包含了stm32mp157a-dk1-u-boot.dtsi</span>
$ <span class="token function">cp</span> stm32mp157a-dk1-u-boot.dtsi stm32mp157d-100ask-u-boot.dtsi
$ <span class="token function">cp</span> stm32mp15-ddr3-2x4Gb-1066-binG.dtsi stm32mp15-ddr3-2x2Gb-1066-binG.dtsi
</code></pre> 
<p>修改设备树dts目录的Makefile，添加自己的设备树</p> 
<pre><code class="prism language-c"><span class="token comment">//dtb-$(CONFIG_STM32MP15x)变量后追加stm32mp157d-100ask</span>
dtb<span class="token operator">-</span>$<span class="token punctuation">(</span>CONFIG_STM32MP15x<span class="token punctuation">)</span> <span class="token operator">+=</span> \
	stm32mp157a<span class="token operator">-</span>avenger96<span class="token punctuation">.</span>dtb \
	stm32mp157a<span class="token operator">-</span>dk1<span class="token punctuation">.</span>dtb \
	stm32mp157a<span class="token operator">-</span>ed1<span class="token punctuation">.</span>dtb \
	stm32mp157a<span class="token operator">-</span>ev1<span class="token punctuation">.</span>dtb \
	stm32mp157a<span class="token operator">-</span>icore<span class="token operator">-</span>stm32mp1<span class="token operator">-</span>ctouch2<span class="token punctuation">.</span>dtb \
	stm32mp157a<span class="token operator">-</span>icore<span class="token operator">-</span>stm32mp1<span class="token operator">-</span>edimm2<span class="token punctuation">.</span><span class="token number">2.</span>dtb \
	stm32mp157a<span class="token operator">-</span>microgea<span class="token operator">-</span>stm32mp1<span class="token operator">-</span>microdev2<span class="token punctuation">.</span><span class="token number">0.</span>dtb \
	stm32mp157a<span class="token operator">-</span>microgea<span class="token operator">-</span>stm32mp1<span class="token operator">-</span>microdev2<span class="token punctuation">.</span><span class="token number">0</span><span class="token operator">-</span>of7<span class="token punctuation">.</span>dtb \
	stm32mp157c<span class="token operator">-</span>dk2<span class="token punctuation">.</span>dtb \
	stm32mp157c<span class="token operator">-</span>ed1<span class="token punctuation">.</span>dtb \
	stm32mp157c<span class="token operator">-</span>ev1<span class="token punctuation">.</span>dtb \
	stm32mp157c<span class="token operator">-</span>odyssey<span class="token punctuation">.</span>dtb \
	stm32mp15xx<span class="token operator">-</span>dhcom<span class="token operator">-</span>drc02<span class="token punctuation">.</span>dtb \
	stm32mp157d<span class="token operator">-</span>dk1<span class="token punctuation">.</span>dtb \
	stm32mp157d<span class="token operator">-</span>ed1<span class="token punctuation">.</span>dtb \
	stm32mp157d<span class="token operator">-</span>ev1<span class="token punctuation">.</span>dtb \
	stm32mp157f<span class="token operator">-</span>dk2<span class="token punctuation">.</span>dtb \
	stm32mp157f<span class="token operator">-</span>ed1<span class="token punctuation">.</span>dtb \
	stm32mp157f<span class="token operator">-</span>ev1<span class="token punctuation">.</span>dtb \
	stm32mp15xx<span class="token operator">-</span>dhcom<span class="token operator">-</span>pdk2<span class="token punctuation">.</span>dtb \
	stm32mp15xx<span class="token operator">-</span>dhcom<span class="token operator">-</span>picoitx<span class="token punctuation">.</span>dtb \
	stm32mp15xx<span class="token operator">-</span>dhcor<span class="token operator">-</span>avenger96<span class="token punctuation">.</span>dtb \
	stm32mp157d<span class="token operator">-</span><span class="token number">100</span>ask<span class="token punctuation">.</span>dtb
</code></pre> 
<p>对设备树做简单的修改，修改<code>stm32mp157d-100ask.dts</code>文件</p> 
<pre><code class="prism language-c"><span class="token number">13</span> #include <span class="token string">"stm32mp15xx-dkx.dtsi"</span>
<span class="token comment">//改为</span>
<span class="token number">13</span> #include <span class="token string">"stm32mp15xx-100ask.dtsi"</span>

<span class="token number">16</span> model <span class="token operator">=</span> <span class="token string">"STMicroelectronics STM32MP157D-DK1 Discovery Board"</span><span class="token punctuation">;</span>
<span class="token number">17</span> compatible <span class="token operator">=</span> <span class="token string">"st,stm32mp157d-dk1"</span><span class="token punctuation">,</span> <span class="token string">"st,stm32mp157"</span><span class="token punctuation">;</span>
<span class="token comment">//改为</span>
<span class="token number">16</span> model <span class="token operator">=</span> <span class="token string">"STMicroelectronics STM32MP157D-100ASK Discovery Board"</span><span class="token punctuation">;</span>
<span class="token number">17</span> compatible <span class="token operator">=</span> <span class="token string">"st,stm32mp157d-100ask"</span><span class="token punctuation">,</span> <span class="token string">"st,stm32mp157"</span><span class="token punctuation">;</span>
</code></pre> 
<p>修改<code>stm32mp157d-100ask-u-boot.dtsi</code>文件</p> 
<pre><code class="prism language-c"><span class="token number">8</span> #include <span class="token string">"stm32mp15-ddr3-1x4Gb-1066-binG.dtsi"</span>
<span class="token comment">//改为</span>
<span class="token number">8</span> #include <span class="token string">"stm32mp15-ddr3-2x2Gb-1066-binG.dtsi"</span>
</code></pre> 
<p>在<code>Makefile.sdk</code>文件中添加自己的板子，删除<code>stm32mp13_defconfig</code>添加<code>stm32mp15_100ask_defconfig</code></p> 
<pre><code class="prism language-bash">UBOOT_CONFIGS <span class="token operator">+=</span> trusted
<span class="token comment"># Init default config settings</span>
UBOOT_DEFCONFIG_trusted <span class="token operator">+=</span> stm32mp15_defconfig
UBOOT_BINARY_stm32mp15_defconfig ?<span class="token operator">=</span> u-boot.dtb
UBOOT_DEVICETREE_stm32mp15_defconfig ?<span class="token operator">=</span>  stm32mp157d-dk1
<span class="token comment"># Init default config settings</span>
UBOOT_DEFCONFIG_trusted <span class="token operator">+=</span> stm32mp15_100ask_defconfig
UBOOT_BINARY_stm32mp15_100ask_defconfig ?<span class="token operator">=</span> u-boot.dtb
UBOOT_DEVICETREE_stm32mp15_100ask_defconfig ?<span class="token operator">=</span>  stm32mp157d-100ask
</code></pre> 
<p>编译生成了<code>u-boot-stm32mp157d-100ask-trusted.dtb</code>文件<br> <img src="https://images2.imgbox.com/a4/f1/5u7npbLp_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22__117"></a>2.2 修改设备树</h3> 
<p>U-Boot的SPL和TF-A的功能有重合，所以有一部分设备树是一样的。ST并没有使用U-Boot的SPL，和SPL相关的有些设备树不做修改也不影响，比如内存。这里我都做了修改，因为我也不知道具体哪些可以不改，<code>stm32mp157d-100ask-u-boot.dtsi</code>文件中基本是和SPL相关的。这篇文章的目的是启动Linux内核，所以LCD、HDMI和音频等驱动不会实现，但是会实现type-c和网络方便下载和调试。</p> 
<h4><a id="221_Uart_119"></a>2.2.1 修改串口Uart</h4> 
<p>100ASK_STM32MP157_V11开发板的串口和参考母板的串口都使用的是uart4，但是用的引脚不同。在<code>stm32mp157d-100ask.dts</code>文件中引用<code>pinctrl</code>节点，在其下追加<code>uart4_pins_d</code>、<code>uart4_idle_pins_d</code>和<code>uart4_sleep_pins_d</code>节点。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp157d-100ask.dts文件</span>

<span class="token operator">&amp;</span>pinctrl <span class="token punctuation">{<!-- --></span>
	uart4_pins_d<span class="token operator">:</span> uart4<span class="token operator">-</span><span class="token number">3</span> <span class="token punctuation">{<!-- --></span>
		pins1 <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token function">STM32_PINMUX</span><span class="token punctuation">(</span><span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> AF6<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token comment">/* UART4_TX */</span>
			bias<span class="token operator">-</span>disable<span class="token punctuation">;</span>
			drive<span class="token operator">-</span>push<span class="token operator">-</span>pull<span class="token punctuation">;</span>
			slew<span class="token operator">-</span>rate <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		pins2 <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token function">STM32_PINMUX</span><span class="token punctuation">(</span><span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> AF6<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token comment">/* UART4_RX */</span>
			bias<span class="token operator">-</span>disable<span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	uart4_idle_pins_d<span class="token operator">:</span> uart4<span class="token operator">-</span>idle<span class="token operator">-</span><span class="token number">3</span> <span class="token punctuation">{<!-- --></span>
		pins1 <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token function">STM32_PINMUX</span><span class="token punctuation">(</span><span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> ANALOG<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token comment">/* UART4_TX */</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		pins2 <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token function">STM32_PINMUX</span><span class="token punctuation">(</span><span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> AF6<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token comment">/* UART4_RX */</span>
			bias<span class="token operator">-</span>disable<span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	uart4_sleep_pins_d<span class="token operator">:</span> uart4<span class="token operator">-</span>sleep<span class="token operator">-</span><span class="token number">3</span> <span class="token punctuation">{<!-- --></span>
		pins <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token function">STM32_PINMUX</span><span class="token punctuation">(</span><span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> ANALOG<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">/* UART4_TX */</span>
				<span class="token operator">&lt;</span><span class="token function">STM32_PINMUX</span><span class="token punctuation">(</span><span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> ANALOG<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token comment">/* UART4_RX */</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>修改uart4对引脚的配置，把<code>uart4_pins_a</code>改为<code>uart4_pins_d</code>。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp15xx-100ask.dtsi文件</span>
<span class="token operator">&amp;</span>uart4 <span class="token punctuation">{<!-- --></span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"sleep"</span><span class="token punctuation">,</span> <span class="token string">"idle"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>uart4_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>uart4_sleep_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>uart4_idle_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token operator">/</span>delete<span class="token operator">-</span>property<span class="token operator">/</span>dmas<span class="token punctuation">;</span>
	<span class="token operator">/</span>delete<span class="token operator">-</span>property<span class="token operator">/</span>dma<span class="token operator">-</span>names<span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//改为</span>
<span class="token operator">&amp;</span>uart4 <span class="token punctuation">{<!-- --></span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"sleep"</span><span class="token punctuation">,</span> <span class="token string">"idle"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>uart4_pins_d<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>uart4_sleep_pins_d<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>uart4_idle_pins_d<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token operator">/</span>delete<span class="token operator">-</span>property<span class="token operator">/</span>dmas<span class="token punctuation">;</span>
	<span class="token operator">/</span>delete<span class="token operator">-</span>property<span class="token operator">/</span>dma<span class="token operator">-</span>names<span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="222__179"></a>2.2.2 修改时钟</h4> 
<p>由于我们参考的官方母板采用的是有源晶振，100ASK_STM32MP157_V11开发板采用了无源晶振。上图是官方晶振原理图，下图为100ASK_STM32MP157_V11开发板原理图。U-Boot时钟为SPL阶段初始化，所以可以不改。<br> <img src="https://images2.imgbox.com/21/14/wsSdFYM3_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/d0/f0/NQe9ocZo_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token comment">//删除stm32mp157d-100ask-u-boot.dtsi文件如下代码</span>
<span class="token operator">&amp;</span>clk_hse <span class="token punctuation">{<!-- --></span>
	st<span class="token punctuation">,</span>digbypass<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="223__190"></a>2.2.3 修改电源</h4> 
<p>由于我们参考的官方母板使用了STPMIC1电源管理芯片，但是100ASK_STM32MP157_V11开发板没有使用电源管理芯片，使用的是固定电源。我们需要删除STPMIC1相关的东西，然后添加一些固定电源域完善设备树。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp15xx-100ask.dtsi文件</span>

<span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 此处代码已省略</span>
	
	vin<span class="token operator">:</span> vin <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"regulator-fixed"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>name <span class="token operator">=</span> <span class="token string">"vin"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>min<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">5000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>max<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">5000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>always<span class="token operator">-</span>on<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">//此处添加以下这些固定电源域</span>
	vddcore<span class="token operator">:</span> regulator<span class="token operator">-</span>vddcore <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"regulator-fixed"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>name <span class="token operator">=</span> <span class="token string">"vddcore"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>min<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1200000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>max<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1350000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>always<span class="token operator">-</span>on<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	vdd<span class="token operator">:</span> regulator<span class="token operator">-</span>vdd <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"regulator-fixed"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>name <span class="token operator">=</span> <span class="token string">"vdd"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>min<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3300000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>max<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3300000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>always<span class="token operator">-</span>on<span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>boot<span class="token operator">-</span>on<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	
	v3v3<span class="token operator">:</span> regulator<span class="token operator">-</span>v3v3 <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"regulator-fixed"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>name <span class="token operator">=</span> <span class="token string">"v3v3"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>min<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3300000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>max<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3300000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>always<span class="token operator">-</span>on<span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>boot<span class="token operator">-</span>on<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	
	vdd_usb<span class="token operator">:</span> regulator<span class="token operator">-</span>vdd<span class="token operator">-</span>usb <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"regulator-fixed"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>name <span class="token operator">=</span> <span class="token string">"vdd_usb"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>min<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3300000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>max<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3300000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>always<span class="token operator">-</span>on<span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>boot<span class="token operator">-</span>on<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>i2c4 <span class="token punctuation">{<!-- --></span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"sleep"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>i2c4_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>i2c4_sleep_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	i2c<span class="token operator">-</span>scl<span class="token operator">-</span>rising<span class="token operator">-</span>time<span class="token operator">-</span>ns <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">185</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	i2c<span class="token operator">-</span>scl<span class="token operator">-</span>falling<span class="token operator">-</span>time<span class="token operator">-</span>ns <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">20</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	clock<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">400000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
	<span class="token comment">/* spare dmas for other usage */</span>
	<span class="token operator">/</span>delete<span class="token operator">-</span>property<span class="token operator">/</span>dmas<span class="token punctuation">;</span>
	<span class="token operator">/</span>delete<span class="token operator">-</span>property<span class="token operator">/</span>dma<span class="token operator">-</span>names<span class="token punctuation">;</span>

	stusb1600@<span class="token number">28</span> <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"st,stusb1600"</span><span class="token punctuation">;</span>
		reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x28</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">11</span> IRQ_TYPE_LEVEL_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpioi<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
		pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>stusb1600_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
		vdd<span class="token operator">-</span>supply <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>vin<span class="token operator">&gt;</span><span class="token punctuation">;</span>

		connector <span class="token punctuation">{<!-- --></span>
			compatible <span class="token operator">=</span> <span class="token string">"usb-c-connector"</span><span class="token punctuation">;</span>
			label <span class="token operator">=</span> <span class="token string">"USB-C"</span><span class="token punctuation">;</span>
			power<span class="token operator">-</span>role <span class="token operator">=</span> <span class="token string">"dual"</span><span class="token punctuation">;</span>
			typec<span class="token operator">-</span>power<span class="token operator">-</span>opmode <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>

			port <span class="token punctuation">{<!-- --></span>
				con_usbotg_hs_ep<span class="token operator">:</span> endpoint <span class="token punctuation">{<!-- --></span>
					remote<span class="token operator">-</span>endpoint <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>usbotg_hs_ep<span class="token operator">&gt;</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/* 删除这部分注释代码
	pmic: stpmic@33 {
		compatible = "st,stpmic1";
		reg = &lt;0x33&gt;;
		interrupts-extended = &lt;&amp;exti_pwr 55 IRQ_TYPE_EDGE_FALLING&gt;;
		interrupt-controller;
		#interrupt-cells = &lt;2&gt;;
		status = "okay";

		regulators {
			// 此处代码已省略
	};
*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* 删除这个节点
&amp;vrefbuf {
	// 此处代码已省略;
};
*/</span>
</code></pre> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp157d-100ask-u-boot.dtsi文件</span>

<span class="token comment">/* 删除这个节点
&amp;pmic {
	u-boot,dm-pre-reloc;
};
*/</span>
</code></pre> 
<p>官方开发板上电U-Boot利用ADC检测了供电type-c的供电电压是否正常，100ASK_STM32MP157_V11没有这个设计需要去掉，我们直接删除ADC设备树。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp15xx-100ask.dtsi文件</span>

<span class="token comment">/* 删除这个节点
&amp;adc {
	pinctrl-names = "default";
	pinctrl-0 = &lt;&amp;adc12_usb_cc_pins_a&gt;;
	vdd-supply = &lt;&amp;vdd&gt;;
	vdda-supply = &lt;&amp;vdd&gt;;
	vref-supply = &lt;&amp;vrefbuf&gt;;
	status = "okay";
	adc1: adc@0 {
		// 此处代码已省略
	};
	adc2: adc@100 {
		// 此处代码已省略
	};
};
*/</span>
</code></pre> 
<p>最关键的一行<code>st,adc_usb_pd = &lt;&amp;adc1 18&gt;, &lt;&amp;adc1 19&gt;;</code>，ADC是用来检查上电电压，删了这一行就不会检测了，但是我们板子没ADC的设计直接删除。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp157d-100ask-u-boot.dtsi文件</span>

<span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
	config <span class="token punctuation">{<!-- --></span>
		u<span class="token operator">-</span>boot<span class="token punctuation">,</span>boot<span class="token operator">-</span>led <span class="token operator">=</span> <span class="token string">"heartbeat"</span><span class="token punctuation">;</span>
		u<span class="token operator">-</span>boot<span class="token punctuation">,</span>error<span class="token operator">-</span>led <span class="token operator">=</span> <span class="token string">"error"</span><span class="token punctuation">;</span>
		u<span class="token operator">-</span>boot<span class="token punctuation">,</span>mmc<span class="token operator">-</span>env<span class="token operator">-</span>partition <span class="token operator">=</span> <span class="token string">"u-boot-env"</span><span class="token punctuation">;</span>
		<span class="token comment">//st,adc_usb_pd = &lt;&amp;adc1 18&gt;, &lt;&amp;adc1 19&gt;;  删除这行</span>
		st<span class="token punctuation">,</span>fastboot<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpioa <span class="token number">13</span> <span class="token punctuation">(</span>GPIO_ACTIVE_LOW <span class="token operator">|</span> GPIO_PULL_UP<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		st<span class="token punctuation">,</span>stm32prog<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpioa <span class="token number">14</span> <span class="token punctuation">(</span>GPIO_ACTIVE_LOW <span class="token operator">|</span> GPIO_PULL_UP<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* 删除这个节点
&amp;adc {
	status = "okay";
};
*/</span>
</code></pre> 
<h4><a id="224_DDR_352"></a>2.2.4 修改DDR</h4> 
<p>DDR是在TF-A中初始化的可以不改，直接复制TF_A中的stm32mp15-ddr3-2x2Gb-1066-binG.dtsi文件。</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * Copyright (C) 2015-2018, STMicroelectronics - All Rights Reserved
 *
 * SPDX-License-Identifier:	GPL-2.0+	BSD-3-Clause
 *
 */</span>

<span class="token comment">/*
 * File generated by STMicroelectronics STM32CubeMX DDR Tool for MPUs
 * DDR type: DDR3 / DDR3L
 * DDR width: 32bits
 * DDR density: 4Gb
 * System frequency: 533000kHz
 * Relaxed Timing Mode: false
 * Address mapping type: RBC
 *
 * Save Date: 2022.08.28, save Time: 00:42:46
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MEM_NAME</span>	<span class="token string">"DDR3-DDR3L 32bits 533000kHz"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MEM_SPEED</span>	<span class="token expression"><span class="token number">533000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MEM_SIZE</span>	<span class="token expression"><span class="token number">0x20000000</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MSTR</span> <span class="token expression"><span class="token number">0x00040401</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MRCTRL0</span> <span class="token expression"><span class="token number">0x00000010</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MRCTRL1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DERATEEN</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DERATEINT</span> <span class="token expression"><span class="token number">0x00800000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PWRCTL</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PWRTMG</span> <span class="token expression"><span class="token number">0x00400010</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_HWLPCTL</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_RFSHCTL0</span> <span class="token expression"><span class="token number">0x00210000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_RFSHCTL3</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_RFSHTMG</span> <span class="token expression"><span class="token number">0x0081008B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_CRCPARCTL0</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG0</span> <span class="token expression"><span class="token number">0x121B2414</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG1</span> <span class="token expression"><span class="token number">0x000A041C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG2</span> <span class="token expression"><span class="token number">0x0608090F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG3</span> <span class="token expression"><span class="token number">0x0050400C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG4</span> <span class="token expression"><span class="token number">0x08040608</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG5</span> <span class="token expression"><span class="token number">0x06060403</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG6</span> <span class="token expression"><span class="token number">0x02020002</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG7</span> <span class="token expression"><span class="token number">0x00000202</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG8</span> <span class="token expression"><span class="token number">0x00001005</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG14</span> <span class="token expression"><span class="token number">0x000000A0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ZQCTL0</span> <span class="token expression"><span class="token number">0xC2000040</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFITMG0</span> <span class="token expression"><span class="token number">0x02060105</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFITMG1</span> <span class="token expression"><span class="token number">0x00000202</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFILPCFG0</span> <span class="token expression"><span class="token number">0x07000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFIUPD0</span> <span class="token expression"><span class="token number">0xC0400003</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFIUPD1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFIUPD2</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFIPHYMSTR</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ODTCFG</span> <span class="token expression"><span class="token number">0x06000600</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ODTMAP</span> <span class="token expression"><span class="token number">0x00000001</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_SCHED</span> <span class="token expression"><span class="token number">0x00000C01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_SCHED1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PERFHPR1</span> <span class="token expression"><span class="token number">0x01000001</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PERFLPR1</span> <span class="token expression"><span class="token number">0x08000200</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PERFWR1</span> <span class="token expression"><span class="token number">0x08000400</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DBG0</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DBG1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DBGCMD</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_POISONCFG</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCCFG</span> <span class="token expression"><span class="token number">0x00000010</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGR_0</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGW_0</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGQOS0_0</span> <span class="token expression"><span class="token number">0x02100C03</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGQOS1_0</span> <span class="token expression"><span class="token number">0x00800100</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGWQOS0_0</span> <span class="token expression"><span class="token number">0x01100C03</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGWQOS1_0</span> <span class="token expression"><span class="token number">0x01000200</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGR_1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGW_1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGQOS0_1</span> <span class="token expression"><span class="token number">0x02100C03</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGQOS1_1</span> <span class="token expression"><span class="token number">0x00800040</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGWQOS0_1</span> <span class="token expression"><span class="token number">0x01100C03</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGWQOS1_1</span> <span class="token expression"><span class="token number">0x01000200</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP1</span> <span class="token expression"><span class="token number">0x00080808</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP2</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP3</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP4</span> <span class="token expression"><span class="token number">0x00001F1F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP5</span> <span class="token expression"><span class="token number">0x07070707</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP6</span> <span class="token expression"><span class="token number">0x0F0F0707</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP9</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP10</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP11</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PGCR</span> <span class="token expression"><span class="token number">0x01442E02</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PTR0</span> <span class="token expression"><span class="token number">0x0022AA5B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PTR1</span> <span class="token expression"><span class="token number">0x04841104</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PTR2</span> <span class="token expression"><span class="token number">0x042DA068</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ACIOCR</span> <span class="token expression"><span class="token number">0x10400812</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DXCCR</span> <span class="token expression"><span class="token number">0x00000C40</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DSGCR</span> <span class="token expression"><span class="token number">0xF200011F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DCR</span> <span class="token expression"><span class="token number">0x0000000B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DTPR0</span> <span class="token expression"><span class="token number">0x38D488D0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DTPR1</span> <span class="token expression"><span class="token number">0x098B00D8</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DTPR2</span> <span class="token expression"><span class="token number">0x10023600</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MR0</span> <span class="token expression"><span class="token number">0x00000840</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MR1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MR2</span> <span class="token expression"><span class="token number">0x00000208</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MR3</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ODTCR</span> <span class="token expression"><span class="token number">0x00010000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ZQ0CR1</span> <span class="token expression"><span class="token number">0x00000038</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DX0GCR</span> <span class="token expression"><span class="token number">0x0000CE81</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DX1GCR</span> <span class="token expression"><span class="token number">0x0000CE81</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DX2GCR</span> <span class="token expression"><span class="token number">0x0000CE81</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DX3GCR</span> <span class="token expression"><span class="token number">0x0000CE81</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32mp15-ddr.dtsi"</span></span>
</code></pre> 
<h4><a id="225_LCD_HDMI_465"></a>2.2.5 删除LCD HDMI和音频</h4> 
<p>U-Boot主要是为了启动Linux内核，所以音频和视频我并不打算实现，先将这些节点删除。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp157d-100ask.dtsi文件</span>

<span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* 删除这个节点
	sound: sound {
		compatible = "audio-graph-card";
		label = "STM32MP15-DK";
		routing =
			"Playback" , "MCLK",
			"Capture" , "MCLK",
			"MICL" , "Mic Bias";
		dais = &lt;&amp;sai2a_port &amp;sai2b_port &amp;i2s2_port&gt;;
		status = "okay";
	};
	*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>i2c1 <span class="token punctuation">{<!-- --></span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"sleep"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>i2c1_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>i2c1_sleep_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	i2c<span class="token operator">-</span>scl<span class="token operator">-</span>rising<span class="token operator">-</span>time<span class="token operator">-</span>ns <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">100</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	i2c<span class="token operator">-</span>scl<span class="token operator">-</span>falling<span class="token operator">-</span>time<span class="token operator">-</span>ns <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">7</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
	<span class="token operator">/</span>delete<span class="token operator">-</span>property<span class="token operator">/</span>dmas<span class="token punctuation">;</span>
	<span class="token operator">/</span>delete<span class="token operator">-</span>property<span class="token operator">/</span>dma<span class="token operator">-</span>names<span class="token punctuation">;</span>
	
	<span class="token comment">/* 删除这两个节点
	hdmi-transmitter@39 {
		// 此处代码已省略
	};

	cs42l51: cs42l51@4a {
		// 此处代码已省略
	};
	*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>i2s2 <span class="token punctuation">{<!-- --></span>
	clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>rcc SPI2<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>rcc SPI2_K<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>rcc PLL3_Q<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>rcc PLL3_R<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	clock<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"pclk"</span><span class="token punctuation">,</span> <span class="token string">"i2sclk"</span><span class="token punctuation">,</span> <span class="token string">"x8k"</span><span class="token punctuation">,</span> <span class="token string">"x11k"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"sleep"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>i2s2_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>i2s2_sleep_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>

	<span class="token comment">/* 删除这个节点
	i2s2_port: port {
		// 此处代码已省略
	};
	*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>ltdc <span class="token punctuation">{<!-- --></span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"sleep"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ltdc_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ltdc_sleep_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>

	<span class="token comment">/* 删除这个节点
	port {
		// 此处代码已省略
	};
	*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>sai2 <span class="token punctuation">{<!-- --></span>
	clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>rcc SAI2<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>rcc PLL3_Q<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>rcc PLL3_R<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	clock<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"pclk"</span><span class="token punctuation">,</span> <span class="token string">"x8k"</span><span class="token punctuation">,</span> <span class="token string">"x11k"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"sleep"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>sai2a_pins_a<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>sai2b_pins_b<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>sai2a_sleep_pins_a<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>sai2b_sleep_pins_b<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>

	<span class="token comment">/* 删除这两个节点
	sai2a: audio-controller@4400b004 {
		// 此处代码已省略
	};

	sai2b: audio-controller@4400b024 {
		// 此处代码已省略
	};
	*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="226_EMMCSD_553"></a>2.2.6 修改EMMC和SD卡</h4> 
<p>100ASK_STM32MP157_V11开发板设计有EMMC，需要添加EMMC设备。100ASK_STM32MP157_V11开发板SD卡的设计和官方开发板的设计也有区别需要修改。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp157d-100ask.dtsi文件</span>

<span class="token comment">//SD卡修改为</span>
<span class="token operator">&amp;</span>sdmmc1 <span class="token punctuation">{<!-- --></span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"opendrain"</span><span class="token punctuation">,</span> <span class="token string">"sleep"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>sdmmc1_b4_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>sdmmc1_b4_od_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>sdmmc1_b4_sleep_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	broken<span class="token operator">-</span>cd<span class="token punctuation">;</span>
	st<span class="token punctuation">,</span>neg<span class="token operator">-</span>edge<span class="token punctuation">;</span>
	bus<span class="token operator">-</span>width <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">4</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	vmmc<span class="token operator">-</span>supply <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>v3v3<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//增加EMMC节点</span>
<span class="token operator">&amp;</span>sdmmc2 <span class="token punctuation">{<!-- --></span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"opendrain"</span><span class="token punctuation">,</span> <span class="token string">"sleep"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>sdmmc2_b4_pins_a <span class="token operator">&amp;</span>sdmmc2_d47_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>sdmmc2_b4_od_pins_a <span class="token operator">&amp;</span>sdmmc2_d47_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>sdmmc2_b4_sleep_pins_a <span class="token operator">&amp;</span>sdmmc2_d47_sleep_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	non<span class="token operator">-</span>removable<span class="token punctuation">;</span>
	no<span class="token operator">-</span>sd<span class="token punctuation">;</span>
	no<span class="token operator">-</span>sdio<span class="token punctuation">;</span>
	st<span class="token punctuation">,</span>dirpol<span class="token punctuation">;</span>
	st<span class="token punctuation">,</span>negedge<span class="token punctuation">;</span> 
	bus<span class="token operator">-</span>width <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">8</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	vmmc<span class="token operator">-</span>supply <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>v3v3<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	vqmmc<span class="token operator">-</span>supply <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>v3v3<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="226_USB_587"></a>2.2.6 修改USB</h4> 
<p>在<code>pinctrl</code>节点中添加<code>fusb302_pins_a</code>节点。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp157d-100ask.dts文件</span>

<span class="token operator">&amp;</span>pinctrl <span class="token punctuation">{<!-- --></span>
	<span class="token comment">//增加这个节点</span>
	fusb302_pins_a<span class="token operator">:</span> fusb302<span class="token operator">-</span><span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		pins <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token function">STM32_PINMUX</span><span class="token punctuation">(</span><span class="token char">'F'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> GPIO<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
			bias<span class="token operator">-</span>pull<span class="token operator">-</span>up<span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>官方开发板使用的是他们自己的USB芯片stusb1600，100ASK_STM32MP157_V11开发板用的是fusb302，但是他们好像是兼容的。100ASK_STM32MP157_V11开发板的usb芯片是在i2c1下地址是22，并且i2c1使用的复用引脚是<code>i2c1_pins_b</code>这一组，将"a"改为"b"。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp157d-100ask.dtsi文件</span>

<span class="token operator">&amp;</span>i2c1 <span class="token punctuation">{<!-- --></span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"sleep"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>i2c1_pins_b<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>i2c1_sleep_pins_b<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	i2c<span class="token operator">-</span>scl<span class="token operator">-</span>rising<span class="token operator">-</span>time<span class="token operator">-</span>ns <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">100</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	i2c<span class="token operator">-</span>scl<span class="token operator">-</span>falling<span class="token operator">-</span>time<span class="token operator">-</span>ns <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">7</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
	<span class="token operator">/</span>delete<span class="token operator">-</span>property<span class="token operator">/</span>dmas<span class="token punctuation">;</span>
	<span class="token operator">/</span>delete<span class="token operator">-</span>property<span class="token operator">/</span>dma<span class="token operator">-</span>names<span class="token punctuation">;</span>
	
	<span class="token comment">//增加这个节点</span>
	fusb302@<span class="token number">22</span> <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"fcs,fusb302"</span><span class="token punctuation">,</span> <span class="token string">"st,stusb1600"</span><span class="token punctuation">;</span>
		reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x22</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">10</span> IRQ_TYPE_EDGE_FALLING<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		interrupt<span class="token operator">-</span>parent <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpiof<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
		pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>fusb302_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
	
		typec_con<span class="token operator">:</span> connector <span class="token punctuation">{<!-- --></span>
			compatible <span class="token operator">=</span> <span class="token string">"usb-c-connector"</span><span class="token punctuation">;</span>
			label <span class="token operator">=</span> <span class="token string">"USB-C"</span><span class="token punctuation">;</span>
			power<span class="token operator">-</span>role <span class="token operator">=</span> <span class="token string">"dual"</span><span class="token punctuation">;</span>
			power<span class="token operator">-</span>opmode <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>

			port <span class="token punctuation">{<!-- --></span>
				con_usbotg_hs_ep<span class="token operator">:</span> endpoint <span class="token punctuation">{<!-- --></span>
					remote<span class="token operator">-</span>endpoint <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>usbotg_hs_ep<span class="token operator">&gt;</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>i2c4 <span class="token punctuation">{<!-- --></span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"sleep"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>i2c4_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>i2c4_sleep_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	i2c<span class="token operator">-</span>scl<span class="token operator">-</span>rising<span class="token operator">-</span>time<span class="token operator">-</span>ns <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">185</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	i2c<span class="token operator">-</span>scl<span class="token operator">-</span>falling<span class="token operator">-</span>time<span class="token operator">-</span>ns <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">20</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	clock<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">400000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
	<span class="token comment">/* spare dmas for other usage */</span>
	<span class="token operator">/</span>delete<span class="token operator">-</span>property<span class="token operator">/</span>dmas<span class="token punctuation">;</span>
	<span class="token operator">/</span>delete<span class="token operator">-</span>property<span class="token operator">/</span>dma<span class="token operator">-</span>names<span class="token punctuation">;</span>

	<span class="token comment">/* 删除这个节点
	stusb1600@28 {
		// 此处代码已省略
	};
	*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="227_ethernet_660"></a>2.2.7 修改ethernet</h4> 
<p>100ASK_STM32MP157_V11开发板使用的phy芯片是AR8035，而且复位引脚是连接在G0引脚上的，所以要添加reset这些属性。<code>qca,clk-out-frequency = &lt;125000000&gt;; qca,keep-pll-enabled;</code>是AR8035的属性，应该添加在phy节点里，但是U-Boot得添加在这里，Linux里是添加在phy节点里的。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp157d-100ask.dtsi文件</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;dt-bindings/net/qca-ar803x.h&gt;</span> <span class="token comment">//增加这个头文件</span></span>

<span class="token operator">&amp;</span>ethernet0 <span class="token punctuation">{<!-- --></span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ethernet0_rgmii_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ethernet0_rgmii_sleep_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"sleep"</span><span class="token punctuation">;</span>
	phy<span class="token operator">-</span>mode <span class="token operator">=</span> <span class="token string">"rgmii-id"</span><span class="token punctuation">;</span>
	max<span class="token operator">-</span>speed <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	phy<span class="token operator">-</span>handle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>phy0<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	nvmem<span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ethernet_mac_address<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	nvmem<span class="token operator">-</span>cell<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"mac-address"</span><span class="token punctuation">;</span>

	qca<span class="token punctuation">,</span>clk<span class="token operator">-</span>out<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">125000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	qca<span class="token punctuation">,</span>keep<span class="token operator">-</span>pll<span class="token operator">-</span>enabled<span class="token punctuation">;</span>

	mdio0 <span class="token punctuation">{<!-- --></span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
		compatible <span class="token operator">=</span> <span class="token string">"snps,dwmac-mdio"</span><span class="token punctuation">;</span>
		phy0<span class="token operator">:</span> ethernet<span class="token operator">-</span>phy@<span class="token number">6</span> <span class="token punctuation">{<!-- --></span>
			reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">6</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
			reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpiog <span class="token number">0</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
			reset<span class="token operator">-</span>assert<span class="token operator">-</span>us <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
			reset<span class="token operator">-</span>deassert<span class="token operator">-</span>us <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">2000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>添加AR8035驱动，将REALTEK改为ATHEROS。</p> 
<pre><code class="prism language-bash"><span class="token comment">#修改stm32mp15_100ask_defconfig文件</span>

<span class="token assign-left variable">CONFIG_PHY_REALTEK</span><span class="token operator">=</span>y
<span class="token comment">#改为</span>
<span class="token assign-left variable">CONFIG_PHY_ATHEROS</span><span class="token operator">=</span>y
</code></pre> 
<h4><a id="228_LED_702"></a>2.2.8 修改LED</h4> 
<p>设置我们的LED，U-Boot正常运行这个灯常亮，Linux下这个灯是心跳灯。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp157d-100ask.dtsi文件</span>

<span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
	led <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"gpio-leds"</span><span class="token punctuation">;</span>
		led<span class="token operator">-</span>blue <span class="token punctuation">{<!-- --></span>
			label <span class="token operator">=</span> <span class="token string">"heartbeat"</span><span class="token punctuation">;</span>
			<span class="token comment">//gpios = &lt;&amp;gpiod 11 GPIO_ACTIVE_HIGH&gt;;改为下面这行</span>
			gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpioa <span class="token number">10</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
			linux<span class="token punctuation">,</span><span class="token keyword">default</span><span class="token operator">-</span>trigger <span class="token operator">=</span> <span class="token string">"heartbeat"</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">-</span>state <span class="token operator">=</span> <span class="token string">"off"</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>出现错误，这个灯会闪烁。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp157d-100ask-u-boot.dtsi文件</span>

<span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
	config <span class="token punctuation">{<!-- --></span>
		u<span class="token operator">-</span>boot<span class="token punctuation">,</span>boot<span class="token operator">-</span>led <span class="token operator">=</span> <span class="token string">"heartbeat"</span><span class="token punctuation">;</span>
		u<span class="token operator">-</span>boot<span class="token punctuation">,</span>error<span class="token operator">-</span>led <span class="token operator">=</span> <span class="token string">"error"</span><span class="token punctuation">;</span>
		u<span class="token operator">-</span>boot<span class="token punctuation">,</span>mmc<span class="token operator">-</span>env<span class="token operator">-</span>partition <span class="token operator">=</span> <span class="token string">"u-boot-env"</span><span class="token punctuation">;</span>
		<span class="token comment">//st,fastboot-gpios = &lt;&amp;gpiog 2 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)&gt;; 按键不知道干什么，改成我们自己的</span>
		<span class="token comment">//st,stm32prog-gpios = &lt;&amp;gpiog 3 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)&gt;;按键不知道干什么，改成我们自己的</span>
		st<span class="token punctuation">,</span>fastboot<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpioa <span class="token number">13</span> <span class="token punctuation">(</span>GPIO_ACTIVE_LOW <span class="token operator">|</span> GPIO_PULL_UP<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		st<span class="token punctuation">,</span>stm32prog<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpioa <span class="token number">14</span> <span class="token punctuation">(</span>GPIO_ACTIVE_LOW <span class="token operator">|</span> GPIO_PULL_UP<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	led <span class="token punctuation">{<!-- --></span>
		led<span class="token operator">-</span>red <span class="token punctuation">{<!-- --></span>
			label <span class="token operator">=</span> <span class="token string">"error"</span><span class="token punctuation">;</span>
			<span class="token comment">//gpios = &lt;&amp;gpiog 8 GPIO_ACTIVE_LOW&gt;; 错误指示灯</span>
			gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpioa <span class="token number">13</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">-</span>state <span class="token operator">=</span> <span class="token string">"off"</span><span class="token punctuation">;</span>
			status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="3__746"></a>3. 编译下载</h2> 
<h3><a id="31__747"></a>3.1 编译</h3> 
<p>执行编译命令，进行编译。</p> 
<pre><code class="prism language-bash">$ <span class="token function">make</span> -f <span class="token environment constant">$PWD</span>/<span class="token punctuation">..</span>/Makefile.sdk <span class="token assign-left variable">DEPLOYDIR</span><span class="token operator">=</span><span class="token variable">$FIP_DEPLOYDIR_ROOT</span>/u-boot -j12 all
</code></pre> 
<h3><a id="32__752"></a>3.2 下载</h3> 
<p>烧写验证，烧写脚本如下。烧写SD或EMMC如果超时，勾选掉最底下的两行檫除。</p> 
<pre><code class="prism language-bash"><span class="token comment">#EMMC烧写脚本FlashLayout_emmc_stm32mp157d-100ask-trusted.tsv</span>
<span class="token comment">#Opt	Id		Name		Type		IP		Offset		Binary</span>
-		0x01	fsbl-boot	Binary		none	0x0			arm-trusted-firmware/tf-a-stm32mp157d-100ask-usb.stm32
-		0x03	fip-boot	FIP			none	0x0			fip/fip-stm32mp157d-100ask-trusted.bin
P		0x04	fsbl1		Binary		mmc1	boot1		arm-trusted-firmware/tf-a-stm32mp157d-100ask-emmc.stm32
P		0x05	fsbl2		Binary		mmc1	boot2		arm-trusted-firmware/tf-a-stm32mp157d-100ask-emmc.stm32
P		0x06	metadata1	Binary		mmc1	0x00080000	arm-trusted-firmware/metadata.bin
P		0x07	metadata2	Binary		mmc1	0x00100000	arm-trusted-firmware/metadata.bin
P		0x08	fip-a		FIP			mmc1	0x00180000	fip/fip-stm32mp157d-100ask-trusted.bin
PED		0x09	fip-b		FIP			mmc1	0x00580000	none
PED		0x0A	u-boot-env	Binary		mmc1	0x00980000	none

<span class="token comment">#EMMC烧写脚本FlashLayout_emmc_stm32mp157d-100ask-optee.tsv</span>
<span class="token comment">#Opt	Id		Name		Type		IP		Offset		Binary</span>
-		0x01	fsbl-boot	Binary		none	0x0			arm-trusted-firmware/tf-a-stm32mp157d-100ask-usb.stm32
-		0x03	fip-boot	FIP			none	0x0			fip/fip-stm32mp157d-100ask-optee.bin
P		0x04	fsbl1		Binary		mmc1	boot1		arm-trusted-firmware/tf-a-stm32mp157d-100ask-emmc.stm32
P		0x05	fsbl2		Binary		mmc1	boot2		arm-trusted-firmware/tf-a-stm32mp157d-100ask-emmc.stm32
P		0x06	metadata1	Binary		mmc1	0x00080000	arm-trusted-firmware/metadata.bin
P		0x07	metadata2	Binary		mmc1	0x00100000	arm-trusted-firmware/metadata.bin
P		0x08	fip-a		FIP			mmc1	0x00180000	fip/fip-stm32mp157d-100ask-optee.bin
PED		0x09	fip-b		FIP			mmc1	0x00580000	none
PED		0x0A	u-boot-env	Binary		mmc1	0x00980000	none

<span class="token comment">#SD卡烧写脚本FlashLayout_sdcard_stm32mp157d-100ask-trusted.tsv</span>
<span class="token comment">#Opt	Id		Name		Type		IP		Offset		Binary</span>
-		0x01	fsbl-boot	Binary		none	0x0			arm-trusted-firmware/tf-a-stm32mp157d-100ask-usb.stm32
-		0x03	fip-boot	FIP			none	0x0			fip/fip-stm32mp157d-100ask-trusted.bin
P		0x04	fsbl1		Binary		mmc0	0x00004400	arm-trusted-firmware/tf-a-stm32mp157d-100ask-sdcard.stm32
P		0x05	fsbl2		Binary		mmc0	0x00044400	arm-trusted-firmware/tf-a-stm32mp157d-100ask-sdcard.stm32
P		0x06	metadata1	Binary		mmc0	0x00084400	arm-trusted-firmware/metadata.bin
P		0x07	metadata2	Binary		mmc0	0x000C4400	arm-trusted-firmware/metadata.bin
P		0x08	fip-a		FIP			mmc0	0x00104400	fip/fip-stm32mp157d-100ask-trusted.bin
PED		0x09	fip-b		FIP			mmc0	0x00504400	none
PED		0x0A	u-boot-env	Binary		mmc0	0x00904400	none

<span class="token comment">#SD卡烧写脚本FlashLayout_sdcard_stm32mp157d-100ask-optee.tsv</span>
<span class="token comment">#Opt	Id		Name		Type		IP		Offset		Binary</span>
-		0x01	fsbl-boot	Binary		none	0x0			arm-trusted-firmware/tf-a-stm32mp157d-100ask-usb.stm32
-		0x03	fip-boot	FIP			none	0x0			fip/fip-stm32mp157d-100ask-optee.bin
P		0x04	fsbl1		Binary		mmc0	0x00004400	arm-trusted-firmware/tf-a-stm32mp157d-100ask-sdcard.stm32
P		0x05	fsbl2		Binary		mmc0	0x00044400	arm-trusted-firmware/tf-a-stm32mp157d-100ask-sdcard.stm32
P		0x06	metadata1	Binary		mmc0	0x00084400	arm-trusted-firmware/metadata.bin
P		0x07	metadata2	Binary		mmc0	0x000C4400	arm-trusted-firmware/metadata.bin
P		0x08	fip-a		FIP			mmc0	0x00104400	fip/fip-stm32mp157d-100ask-optee.bin
PED		0x09	fip-b		FIP			mmc0	0x00504400	none
PED		0x0A	u-boot-env	Binary		mmc0	0x00904400	none
</code></pre> 
<p>烧写并设置好拨码开关，启动。错误是因为没有设置MAC地址，设置地址并保存。<br> <img src="https://images2.imgbox.com/db/07/lEvvIDZF_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash">setenv ipaddr <span class="token number">192.168</span>.0.250
setenv ethaddr 00:04:9f:04:d2:33
setenv gatewayip <span class="token number">192.168</span>.0.1
setenv netmask <span class="token number">255.255</span>.255.0
setenv serverip <span class="token number">192.168</span>.0.100
saveenv
</code></pre> 
<p>重启没有错误，dhcp向路由器从新申请一个IP，ping服务器成功。<br> <img src="https://images2.imgbox.com/a1/e4/5lpMq1hJ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="4__815"></a>4. 总结</h2> 
<p>对于上层代码兼容要更好些，无需修改源码就调好了这些驱动，Linux移植我们将直接使用U-Boot的设备树。这些代码只启动板子，其他功能问题并没有解决。</p> 
<p>学习笔记仅供参考，欢迎指正错误，如有侵权请及时联系。<strong>移植源码获取：</strong></p> 
<pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/Sonboy97/arm-ostl-linux-gnueabi.git
版本：9ae04fa8dbea4c984243179d1faa6e39cd18d2dd
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a1b4d6d5a41e5235711bce6026c720a7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">STM32MP157 tf-a2.6移植</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/920ec0700f9be8a17aa1414e1ce7701d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">STM32MP157 AP6236 WiFi蓝牙模块</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>