<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>微信公众号的二次开发（一  订阅号没有获取网页授权的解决方法） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="微信公众号的二次开发（一  订阅号没有获取网页授权的解决方法）" />
<meta property="og:description" content="前言 应公司开发需求，最近需要进行公众号的二次开发。经过系列讨论，最后确定为使用订阅号来开发。
因为公众号开发要获取微信用户的基本信息，需要通过用户授权获取code,然后去换取openid,最后在获取用户信息。
同时在获取code时需要配置回调域名。那么问题就来：
？？？ 这时的我就是一脸黑人问号。没有权限怎么办，难道要重新再申请一个服务号，但是服务号并不符合我们业务场景。在经过查阅资料之后，总结下来主要有两种方法来解决这个问题。
一、在微信公众平台配置自动回复。然后在微信开放平台注册网站应用的AppID，大概意思就是 用订阅号借用其他拥有网页授权权限的服务号等。参考文章：https://blog.csdn.net/vbirdbest/article/details/51217478 。（因为要重新申请服务号等 所以没有采用）。
二、在用户关注或者点击菜单等交互行为时。微信服务器将POST消息的XML数据包到开发者填写的URL上。
通过这种交互行为，我们可以在用户关注时就获取到它的FromUserName即OpenId。从而获取用户信息。
微信公众平台开发配置 在进行微信开发之前，要在微信公众平台上 开发的基本配置 服务器配置。
官方文档：https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421135319
下面贴代码：
@ApiOperation(&#34;Used to Verify the Signature of Wechat Public Platform&#34;) @RequestMapping(value = &#34;checkSignature&#34;, method = RequestMethod.GET) public void checkSignature(@RequestParam(&#34;signature&#34;) String signature, @RequestParam(&#34;timestamp&#34;) String timestamp, @RequestParam(&#34;nonce&#34;) String nonce, @RequestParam(&#34;echostr&#34;) String echostr, HttpServletResponse response) { try { PrintWriter out = response.getWriter(); // 通过检验signature对请求进行校验，若校验成功则原样返回echostr，表示接入成功，否则接入失败 if (SignUtil.checkSignature(signature, timestamp, nonce)) { out.print(echostr); } out.close(); } catch (IOException e) { e." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/bb7f62436f84dc84483fb0a77061039b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-06-24T11:02:32+08:00" />
<meta property="article:modified_time" content="2019-06-24T11:02:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">微信公众号的二次开发（一  订阅号没有获取网页授权的解决方法）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>前言</h3> 
<p>应公司开发需求，最近需要进行公众号的二次开发。经过系列讨论，最后确定为使用订阅号来开发。<br> 因为公众号开发要获取微信用户的基本信息，需要通过用户授权获取code,然后去换取openid,最后在获取用户信息。<br> 同时在获取code时需要配置回调域名。那么问题就来：<br> <img src="https://images2.imgbox.com/cf/80/WElxNI9q_o.png" alt="登录微信公众平台，开发下面的接口权限"><br> ？？？ 这时的我就是一脸黑人问号。没有权限怎么办，难道要重新再申请一个服务号，但是服务号并不符合我们业务场景。在经过查阅资料之后，总结下来主要有两种方法来解决这个问题。</p> 
<p>一、在微信公众平台配置自动回复。然后在微信开放平台注册网站应用的AppID，大概意思就是 用订阅号借用其他拥有网页授权权限的服务号等。参考文章：<a href="https://blog.csdn.net/vbirdbest/article/details/51217478">https://blog.csdn.net/vbirdbest/article/details/51217478</a> 。（因为要重新申请服务号等 所以没有采用）。</p> 
<p>二、在用户关注或者点击菜单等交互行为时。微信服务器将POST消息的XML数据包到开发者填写的URL上。<br> <img src="https://images2.imgbox.com/66/f8/CO27JT9t_o.png" alt=""><br> 通过这种交互行为，我们可以在用户关注时就获取到它的FromUserName即OpenId。从而获取用户信息。</p> 
<h3><a id="_13"></a>微信公众平台开发配置</h3> 
<p>在进行微信开发之前，要在微信公众平台上 开发的基本配置 服务器配置。<br> <img src="https://images2.imgbox.com/1e/7a/btPkwQs1_o.png" alt=""><br> 官方文档：<a href="https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421135319" rel="nofollow">https://mp.weixin.qq.com/wiki?t=resource/res_main&amp;id=mp1421135319</a><br> 下面贴代码：</p> 
<pre><code>    @ApiOperation("Used to Verify the Signature of Wechat Public Platform")
    @RequestMapping(value = "checkSignature", method = RequestMethod.GET)
    public void checkSignature(@RequestParam("signature") String signature,
                               @RequestParam("timestamp") String timestamp,
                               @RequestParam("nonce") String nonce,
                               @RequestParam("echostr") String echostr,
                               HttpServletResponse response) {

        try {
            PrintWriter out = response.getWriter();
            // 通过检验signature对请求进行校验，若校验成功则原样返回echostr，表示接入成功，否则接入失败
            if (SignUtil.checkSignature(signature, timestamp, nonce)) {
                out.print(echostr);
            }
            out.close();
        } catch (IOException e) {
            e.printStackTrace();
        }

     }
</code></pre> 
<p>SignUtil类</p> 
<pre><code>import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.Arrays;

/**
 * 微信公众号开发 检验signature工具类
 */
public class SignUtil {

    //与微信公众平台上配置的token要一致
    private static String token = "你自己配的token";


    /*
     *  验证签名
     */
    public static boolean checkSignature(String signature, String timestamp, String nonce) {
        // 1.将token、timestamp、nonce三个参数进行字典序排序
        String[] arr = new String[]{token, timestamp, nonce};
        Arrays.sort(arr);

        // 2. 将三个参数字符串拼接成一个字符串进行sha1加密
        StringBuilder content = new StringBuilder();
        for (int i = 0; i &lt; arr.length; i++) {
            content.append(arr[i]);
        }
        MessageDigest md = null;
        String tmpStr = null;
        try {
            md = MessageDigest.getInstance("SHA-1");
            // 将三个参数字符串拼接成一个字符串进行sha1加密
            byte[] digest = md.digest(content.toString().getBytes());
            tmpStr = byteToStr(digest);
        } catch (NoSuchAlgorithmException e) {
            e.printStackTrace();
        }

        content = null;
        // 3.将sha1加密后的字符串可与signature对比，标识该请求来源于微信
        return tmpStr != null ? tmpStr.equals(signature.toUpperCase()) : false;
    }

    /**
     * 方法名：byteToStr
     * 详述：将字节数组转换为十六进制字符串
     */
    private static String byteToStr(byte[] byteArray) {
        String strDigest = "";
        for (int i = 0; i &lt; byteArray.length; i++) {
            strDigest += byteToHexStr(byteArray[i]);
        }
        return strDigest;
    }

    /**
     * 方法名：byteToHexStr&lt;/br&gt;
     * 详述：将字节转换为十六进制字符串&lt;/br&gt;
     */
    private static String byteToHexStr(byte mByte) {
        char[] Digit = {'0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'};
        char[] tempArr = new char[2];
        tempArr[0] = Digit[(mByte &gt;&gt;&gt; 4) &amp; 0X0F];
        tempArr[1] = Digit[mByte &amp; 0X0F];
        String s = new String(tempArr);
        return s;
    }


}

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2f3dd2e56ccc42adc6b5488f2adff470/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C51串口通讯--学习总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f137faf8910d54094b9fbf5ef744b653/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">适用于Webstorm的25个最佳Javascript插件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>