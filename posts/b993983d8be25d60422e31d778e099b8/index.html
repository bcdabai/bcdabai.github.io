<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>gateway网关的理解和使用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="gateway网关的理解和使用" />
<meta property="og:description" content="一、概述 spring-cloud-gateway是一个库，可以在spring webflux之上建立一个API网关，它的目的是提供一个简单，有效的方式去路由到APIS并且提供：安全、监控和弹性。gateway构建于spring boot2.x，spring webFlux，and Project Reactor，所以，许多同步库如spring Data和spring security不适用于gateway项目中。因为gateway是异步非阻塞的。
gateway要求spring boot和spring webFlux提供Netty运行环境。它不能工作在传统的servlet容器或打成一个War包。
二、特点 1、能够对任意的请求属性进行路由匹配
2、能对路由进行断言和过滤
3、集成了熔断器
4、集成了spring-cloud-discoveryclient
5、很容易的写断言和过滤
6、限流
7、路径重写
三、三大组件 1、Route。是构建网关的基本模块，他是ID，目标URL，一系列的断言和过滤器组成，如果断言为true，则匹配该路由
2、Rredicate。参考的是Java8的Predicate，开发人员可以匹配HTTP请求中的所有内容，如果请求与断言相匹配则进行路由
3、Filter。指的是spring框架中GatewayFileter的实例，使用过滤器，可以在请求被路由前由前或者之后对请求进行修改。
四、gateway的工作流程 客户端将请求发给spring cloud gateway，如果gateway handle mapping 确定这个请求和一个路由匹配，它将此请求发给 gateway web handle. 这个 handle 运行这个请求，通过一个filter chain，这个 filter chain在请求路由前后都能执行。
五、gateway的限流 gateway作为网关，与其他网关技术不同的是它能实现限流。gateway使用的是令牌桶算法实现限流。常见的限流算法有：
1、计数器算法：以QPS为100举例，如果1秒钟内钱200ms请求数量到达了100，后面800ms中的请求都会被拒绝，这种情况称为”突刺现象“
2、漏桶算法：可以解决突刺现象。比如创建一个很大的队列来接收请求，一个较小的线程池来处理请求。但是也有极限情况，当队列满了时， 请求也会拒绝掉。
3、令牌桶算法：可以说是漏桶算法的改进。在桶中放令牌，请求获取令牌后才能继续执行。如果桶中无令牌，请求可以选择进行等待或直接拒绝。
在项目中使用gateway网关做限流一般结合的redis，使用令牌桶算法。
六、gateway的断言 gateway包含了许多内置的路由断言工厂。所有的这些断言匹配不同的HTTP请求属性。你能组合这些路由断言工厂。我们一般是在配置文件中配置predicates，当然我们也可以自定义Predicate，如下：
@Component public class CustomeRoutePredicateFactory extends AbstractRoutePredicateFactory&lt;PathRoutePredicateFactory.Config&gt; { public CustomeRoutePredicateFactory() { super(PathRoutePredicateFactory.Config.class); } @Override public Predicate&lt;ServerWebExchange&gt; apply(PathRoutePredicateFactory.Config config) { System.out.println(&#34;TokenRoutePredicateFactory Start...&#34;); return exchange -&gt; { ServerHttpRequest request = exchange." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/b993983d8be25d60422e31d778e099b8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-24T15:30:24+08:00" />
<meta property="article:modified_time" content="2022-03-24T15:30:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">gateway网关的理解和使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_0"></a>一、概述</h4> 
<p>spring-cloud-gateway是一个库，可以在spring webflux之上建立一个API网关，它的目的是提供一个简单，有效的方式去路由到APIS并且提供：安全、监控和弹性。gateway构建于spring boot2.x，spring webFlux，and Project Reactor，所以，许多同步库如spring Data和spring security不适用于gateway项目中。因为gateway是异步非阻塞的。<br> gateway要求spring boot和spring webFlux提供Netty运行环境。它不能工作在传统的servlet容器或打成一个War包。</p> 
<h4><a id="_5"></a>二、特点</h4> 
<p>1、能够对任意的请求属性进行路由匹配</p> 
<p>2、能对路由进行断言和过滤</p> 
<p>3、集成了熔断器</p> 
<p>4、集成了spring-cloud-discoveryclient</p> 
<p>5、很容易的写断言和过滤</p> 
<p>6、限流</p> 
<p>7、路径重写</p> 
<h4><a id="_21"></a>三、三大组件</h4> 
<p>1、Route。是构建网关的基本模块，他是ID，目标URL，一系列的断言和过滤器组成，如果断言为true，则匹配该路由</p> 
<p>2、Rredicate。参考的是Java8的Predicate，开发人员可以匹配HTTP请求中的所有内容，如果请求与断言相匹配则进行路由</p> 
<p>3、Filter。指的是spring框架中GatewayFileter的实例，使用过滤器，可以在<strong>请求被路由前由前或者之后</strong>对请求进行修改。</p> 
<h4><a id="gateway_28"></a>四、gateway的工作流程</h4> 
<p><img src="https://images2.imgbox.com/df/64/tZ8hJyEx_o.png" alt="在这里插入图片描述"><br> 客户端将请求发给spring cloud gateway，如果gateway handle mapping 确定这个请求和一个路由匹配，它将此请求发给 gateway web handle. 这个 handle 运行这个请求，通过一个filter chain，这个 filter chain在请求路由前后都能执行。</p> 
<h4><a id="gateway_33"></a>五、gateway的限流</h4> 
<p>gateway作为网关，与其他网关技术不同的是它能实现限流。gateway使用的是令牌桶算法实现限流。常见的限流算法有：</p> 
<p>1、<strong>计数器算法</strong>：以QPS为100举例，如果1秒钟内钱200ms请求数量到达了100，后面800ms中的请求都会被拒绝，这种情况称为”突刺现象“</p> 
<p>2、<strong>漏桶算法</strong>：可以解决突刺现象。比如创建一个很大的队列来接收请求，一个较小的线程池来处理请求。但是也有极限情况，当队列满了时， 请求也会拒绝掉。</p> 
<p>3、<strong>令牌桶算法</strong>：可以说是漏桶算法的改进。在桶中放令牌，请求获取令牌后才能继续执行。如果桶中无令牌，请求可以选择进行等待或直接拒绝。</p> 
<p>在项目中使用gateway网关做限流一般结合的redis，使用令牌桶算法。</p> 
<h4><a id="gateway_44"></a>六、gateway的断言</h4> 
<p>gateway包含了许多内置的路由断言工厂。所有的这些断言匹配不同的HTTP请求属性。你能组合这些路由断言工厂。我们一般是在配置文件中配置predicates，当然我们也可以自定义Predicate，如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomeRoutePredicateFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRoutePredicateFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PathRoutePredicateFactory<span class="token punctuation">.</span>Config</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token class-name">CustomeRoutePredicateFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">PathRoutePredicateFactory<span class="token punctuation">.</span>Config</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerWebExchange</span><span class="token punctuation">&gt;</span></span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">PathRoutePredicateFactory<span class="token punctuation">.</span>Config</span> config<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TokenRoutePredicateFactory Start..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> exchange <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//take information from the request to see if it</span>
            <span class="token comment">//matches configuration.</span>
            <span class="token keyword">return</span> <span class="token function">matches</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">PathRoutePredicateFactory<span class="token punctuation">.</span>Config</span> config<span class="token punctuation">,</span> <span class="token class-name">ServerHttpRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RequestPath</span> path <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"gateway"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

yml
routes<span class="token operator">:</span>
        <span class="token operator">-</span> id<span class="token operator">:</span> path_route
          uri<span class="token operator">:</span> lb<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>PROVIDER  # lb的意思是负载均衡
          predicates<span class="token operator">:</span>
            <span class="token operator">-</span> <span class="token class-name">Custome</span><span class="token operator">=</span><span class="token operator">/</span>gateway<span class="token comment">/**    #这个Custome就是自定义类CustomeRoutePredicateFactory的前缀，仿照PathRoutePredicateFactory写的
          filters:
            - name: Hystrix    #表示filter中使用Hystrix来做熔断降级
              args:
                name: fallbackcmd  #名字唯一即可
                fallbackUri: forward:/defaultfallback  #在本gateway中产生的异常或超时将调用本gateway中的control层中的defaultfallback  
</span></code></pre> 
<p>上面的逻辑是，获取路径值，如果存在gateway字符串，则返回false。</p> 
<p>gateway给我们提供了很多内置的Predicate，如断言时间的 AfterRoutePredicateFactory、BeforeRoutePredicateFactory…，断言cookie的CookieRoutePredicateFactory，断言请求头的HeaderRoutePredicateFactory，一般见其名知其意，<strong>且yml中配置时只需要写前缀即可</strong>，且一般有两个参数，第一个值一般都是<strong>Java的正则表达式</strong>。例如</p> 
<pre><code class="prism language-java">	spring<span class="token operator">:</span>
  cloud<span class="token operator">:</span>
    gateway<span class="token operator">:</span>
      routes<span class="token operator">:</span>
      <span class="token operator">-</span> id<span class="token operator">:</span> cookie_route
        uri<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>org
        predicates<span class="token operator">:</span>
        <span class="token operator">-</span> <span class="token class-name">Cookie</span><span class="token operator">=</span>chocolate<span class="token punctuation">,</span> ch<span class="token punctuation">.</span>p    #<span class="token class-name">Cookie</span>就是前缀名
</code></pre> 
<h4><a id="gatewayfilter_102"></a>七、gateway的filter</h4> 
<p>gateway的filter有三种：<strong>全局Filter、默认Filter和自定义Filter</strong>。<br> 全局Filter一般是我们定义，全局的filter一般要实现<strong>GlobalFilter 和Orderd</strong>，我们可以设置getOrder()方法来设置当前Filter的执行权重。<strong>order值越小，请求服务前的优先级越高，服务返回后执行的优先级越低</strong>。</p> 
<p>如下</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">GlobalFilter</span> <span class="token function">customGlobalFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> chain<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> exchange<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Principal</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">defaultIfEmpty</span><span class="token punctuation">(</span><span class="token string">"Default User"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>userName <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//adds header to proxied request</span>
                    exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"CUSTOM-REQUEST-HEADER"</span><span class="token punctuation">,</span> userName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> exchange<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>chain<span class="token operator">::</span><span class="token function">filter</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">GlobalFilter</span> <span class="token function">customGlobalPostFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> chain<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>serverWebExchange <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//adds header to response</span>
                    serverWebExchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"CUSTOM-RESPONSE-HEADER"</span><span class="token punctuation">,</span>
                            <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>serverWebExchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"It worked"</span><span class="token operator">:</span> <span class="token string">"It did not work"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> serverWebExchange<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>gateway也为我们提供了很多的内置Filter，即默认的Filter，像AddRequestHeaderGatewayFilter，AddRequestParameterGatewayFilter等等。在yml中配置也只需要写前缀即可，如下</p> 
<pre><code class="prism language-java">spring<span class="token operator">:</span>
  cloud<span class="token operator">:</span>
    gateway<span class="token operator">:</span>
      routes<span class="token operator">:</span>
      <span class="token operator">-</span> id<span class="token operator">:</span> add_request_parameter_route
        uri<span class="token operator">:</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>org
        filters<span class="token operator">:</span>
        <span class="token operator">-</span> <span class="token class-name">AddRequestParameter</span><span class="token operator">=</span>red<span class="token punctuation">,</span> blue
</code></pre> 
<p>下面讲几个常用的gateway内置的Filter：ForwardRoutingFilter和ReactiveLoadBalancerClientFilter</p> 
<p>ForwardRoutingFilter：这个过滤器将URI视为是可改变的属性。当URL有forward修饰时，例如：forward://localendpoint，它会使用spring的DispatcherHandle来处理请求，换句话说，就是用DispatcherHandle来处理forward请求转发。<br> ReactiveLoadBalancerClientFilter：就是用来负载均衡的。当URL有lb时，例如：lb://myservice，它使用springCloud的ReactLoadBalancer去解析服务名为myservice的微服务（将这个myservice解析为实际的主机和端口，并替换当前的URI），找到这个微服务的集群，并负载均衡到某一台，执行服务。</p> 
<pre><code class="prism language-java">spring<span class="token operator">:</span>
  cloud<span class="token operator">:</span>
    gateway<span class="token operator">:</span>
      routes<span class="token operator">:</span>
      <span class="token operator">-</span> id<span class="token operator">:</span> myRoute
        uri<span class="token operator">:</span> lb<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>service
        predicates<span class="token operator">:</span>
        <span class="token operator">-</span> <span class="token class-name">Path</span><span class="token operator">=</span><span class="token operator">/</span>service<span class="token comment">/**
</span></code></pre> 
<p>注意：<strong>gateway支持所有的loadbalancer特性</strong>。</p> 
<h4><a id="gateway_167"></a>八、gateway的降级熔断</h4> 
<p>先看看官网的例子，如下</p> 
<pre><code class="prism language-java">spring<span class="token operator">:</span>
  cloud<span class="token operator">:</span>
    gateway<span class="token operator">:</span>
      routes<span class="token operator">:</span>
      <span class="token operator">-</span> id<span class="token operator">:</span> circuitbreaker_route
        uri<span class="token operator">:</span> lb<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>backing<span class="token operator">-</span>service<span class="token operator">:</span><span class="token number">8088</span>
        predicates<span class="token operator">:</span>
        <span class="token operator">-</span> <span class="token class-name">Path</span><span class="token operator">=</span><span class="token operator">/</span>consumingServiceEndpoint
        filters<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token class-name">CircuitBreaker</span>
          args<span class="token operator">:</span>
            name<span class="token operator">:</span> myCircuitBreaker
            fallbackUri<span class="token operator">:</span> forward<span class="token operator">:</span><span class="token operator">/</span>inCaseOfFailureUseThis
        <span class="token operator">-</span> <span class="token class-name">RewritePath</span><span class="token operator">=</span><span class="token operator">/</span>consumingServiceEndpoint<span class="token punctuation">,</span> <span class="token operator">/</span>backingServiceEndpoint
</code></pre> 
<p>表示如果发生了fallback，则重定向到fallbackUri地址中的controller。正常的话，是到uri中的controller</p> 
<p>当然，你也可以使用配置的方式，如下</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">routes</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">"circuitbreaker_route"</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">"/consumingServiceEndpoint"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">circuitBreaker</span><span class="token punctuation">(</span>c <span class="token operator">-&gt;</span> c<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"myCircuitBreaker"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fallbackUri</span><span class="token punctuation">(</span><span class="token string">"forward:/inCaseOfFailureUseThis"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">rewritePath</span><span class="token punctuation">(</span><span class="token string">"/consumingServiceEndpoint"</span><span class="token punctuation">,</span> <span class="token string">"/backingServiceEndpoint"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"lb://backing-service:8088"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>熔断器也可以这样写，没有fallback或处理在gateway应用中，而是有一个注册在主机9994端口下的应用，这个应用可以处理fallback。</p> 
<pre><code class="prism language-java">spring<span class="token operator">:</span>
  cloud<span class="token operator">:</span>
    gateway<span class="token operator">:</span>
      routes<span class="token operator">:</span>
      <span class="token operator">-</span> id<span class="token operator">:</span> ingredients
        uri<span class="token operator">:</span> lb<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>ingredients
        predicates<span class="token operator">:</span>
        <span class="token operator">-</span> <span class="token class-name">Path</span><span class="token operator">=</span><span class="token comment">//ingredients/**</span>
        filters<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token class-name">CircuitBreaker</span>
          args<span class="token operator">:</span>
            name<span class="token operator">:</span> fetchIngredients
            fallbackUri<span class="token operator">:</span> forward<span class="token operator">:</span><span class="token operator">/</span>fallback
      <span class="token operator">-</span> id<span class="token operator">:</span> ingredients<span class="token operator">-</span>fallback
        uri<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">9994</span>
        predicates<span class="token operator">:</span>
        <span class="token operator">-</span> <span class="token class-name">Path</span><span class="token operator">=</span><span class="token operator">/</span>fallback
</code></pre> 
<p>下面看看我们自己设置的熔断降级，如下</p> 
<pre><code class="prism language-java"><span class="token comment">//在当前gateway中的controller，如果Yml中没有配置其他主机的fallback方法，如果配置了，则该方法配置在另外的主机上。</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CircuitConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>commandKey <span class="token operator">=</span> <span class="token string">"gatewayCommand"</span><span class="token punctuation">,</span>fallbackMethod <span class="token operator">=</span> <span class="token string">"gatewayFallback"</span><span class="token punctuation">,</span>commandProperties <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">HystrixPropertiesManager</span><span class="token punctuation">.</span>CIRCUIT_BREAKER_ENABLED<span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span><span class="token class-name">HystrixPropertiesManager</span><span class="token punctuation">.</span>CIRCUIT_BREAKER_SLEEP_WINDOW_IN_MILLISECONDS<span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">"10000"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span><span class="token class-name">HystrixPropertiesManager</span><span class="token punctuation">.</span>CIRCUIT_BREAKER_ERROR_THRESHOLD_PERCENTAGE<span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">"40"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span><span class="token class-name">HystrixPropertiesManager</span><span class="token punctuation">.</span>CIRCUIT_BREAKER_REQUEST_VOLUME_THRESHOLD<span class="token punctuation">,</span>value <span class="token operator">=</span> <span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">gatewayCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"gatewayCommand method.."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">gatewayFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"gatewayFallback method.."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
gateway的yml
      routes<span class="token operator">:</span>
        <span class="token operator">-</span> id<span class="token operator">:</span> path_route
          uri<span class="token operator">:</span> lb<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>PROVIDER  # lb的意思是负载均衡
          predicates<span class="token operator">:</span>
            <span class="token operator">-</span> <span class="token class-name">Custome</span><span class="token operator">=</span><span class="token operator">/</span>gateway<span class="token comment">/**
          filters:
            - name: Hystrix
              args:
                name: fallbackcmd
                fallbackUri: forward:/defaultfallback
</span></code></pre> 
<p>注意，当前fallbackuri只能使用forward！如果没配置其他的处理fallback的主机，则重定向到当前网关主机的controller路径。</p> 
<h4><a id="gatewayactuator_257"></a>九、gateway整合actuator</h4> 
<p>需要actuator的依赖。<br> 一般gateway的路由信息是配置注册中心，我们可以使用原始的手工方式刷新路由缓存。使用post请求/actuator/gateway/refresh 即可。当然这需要导入spring的actuator依赖<br> 你也可以检索gateway中所有的路由信息，以手工方式。使用get请求/actuator/gateway/routes<br> 你也可以检索某一个路由信息，使用get请求/actuator/gateway/routes/{id}<br> 总之，可以使用actuator来CRUD路由。</p> 
<h4><a id="_264"></a>十、总结</h4> 
<p>1、gateway网关作为整个项目的最上层，其实就是对请求的处理，细化说有：请求路由转发，限流，熔断降级和负载均衡等。但是在项目中一般使用的请求转发和负载均衡。<br> 2、gateway中限流使用的是令牌桶算法。<br> 3、gateway的熔断降级只能在本网关内出现的异常和超时，如果正常请求到别的微服务，而在别的微服务中出现的超时和异常，配置在gateway网关中的熔断降级不起效。<br> 4、gateway使用的异步非阻塞的模型，底层使用的Netty框架，可和springwebFlux、springMvc结合使用。<br> 5、gateway中的Fileter可以理解为是spring中的Aop机制中的环绕通知。有前置和后置，针对请求服务前后而言。Filter的order值越小，执行前置的优先级越大，执行后置的优先级越小。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a8581bbd0f56a5887f1614c8d9f6c998/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python3 查找替换文件中的一行</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e450a734f2eea933701dcd01ed4f0886/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Windows中jps命令无法查看java进程问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>