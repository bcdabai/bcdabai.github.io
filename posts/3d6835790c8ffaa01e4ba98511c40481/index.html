<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mask-rcnn训练自己的数据集 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mask-rcnn训练自己的数据集" />
<meta property="og:description" content="import os import sys import random import math import re import time import numpy as np import cv2 import matplotlib import matplotlib.pyplot as plt import yaml from config import Config import utils import model as modellib import visualize from model import log from PIL import Image #%matplotlib inline # Root directory of the project ROOT_DIR = os.getcwd() # Directory to save logs and trained model MODEL_DIR = os.path.join(ROOT_DIR, &#34;logs&#34;) # Local path to trained weights file COCO_MODEL_PATH = os." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/3d6835790c8ffaa01e4ba98511c40481/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-04-11T21:17:51+08:00" />
<meta property="article:modified_time" content="2018-04-11T21:17:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mask-rcnn训练自己的数据集</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <pre class="prettyprint"><code class=" hljs python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> math
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> cv2
<span class="hljs-keyword">import</span> matplotlib
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> yaml
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> Config
<span class="hljs-keyword">import</span> utils
<span class="hljs-keyword">import</span> model <span class="hljs-keyword">as</span> modellib
<span class="hljs-keyword">import</span> visualize
<span class="hljs-keyword">from</span> model <span class="hljs-keyword">import</span> log

<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image

<span class="hljs-comment">#%matplotlib inline </span>

<span class="hljs-comment"># Root directory of the project</span>
ROOT_DIR = os.getcwd()

<span class="hljs-comment"># Directory to save logs and trained model</span>
MODEL_DIR = os.path.join(ROOT_DIR, <span class="hljs-string">"logs"</span>)

<span class="hljs-comment"># Local path to trained weights file</span>
COCO_MODEL_PATH = os.path.join(ROOT_DIR, <span class="hljs-string">"mask_rcnn_coco.h5"</span>)
<span class="hljs-comment"># Download COCO trained weights from Releases if needed</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(COCO_MODEL_PATH):
    utils.download_trained_weights(COCO_MODEL_PATH)


<span class="hljs-comment">################################################       Configurations        ###############################################    </span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShapesConfig</span><span class="hljs-params">(Config)</span>:</span>
    <span class="hljs-string">"""Configuration for training on the toy shapes dataset.
    Derives from the base Config class and overrides values specific
    to the toy shapes dataset.
    """</span>
    <span class="hljs-comment"># Give the configuration a recognizable name</span>
    NAME = <span class="hljs-string">"shapes"</span>

    <span class="hljs-comment"># Train on 1 GPU and 8 images per GPU. We can put multiple images on each</span>
    <span class="hljs-comment"># GPU because the images are small. Batch size is 8 (GPUs * images/GPU).</span>
    GPU_COUNT = <span class="hljs-number">1</span>
    IMAGES_PER_GPU = <span class="hljs-number">1</span>

    <span class="hljs-comment"># Number of classes (including background)</span>
    NUM_CLASSES = <span class="hljs-number">1</span> + <span class="hljs-number">3</span>  <span class="hljs-comment"># background + 3 class</span>

    <span class="hljs-comment"># Use small images for faster training. Set the limits of the small side</span>
    <span class="hljs-comment"># the large side, and that determines the image shape.</span>
    IMAGE_MIN_DIM = <span class="hljs-number">1024</span>
    IMAGE_MAX_DIM = <span class="hljs-number">1024</span>

    <span class="hljs-comment"># Use smaller anchors because our image and objects are small</span>
    RPN_ANCHOR_SCALES = (<span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">64</span>, <span class="hljs-number">128</span>)  <span class="hljs-comment"># anchor side in pixels</span>

    <span class="hljs-comment"># Reduce training ROIs per image because the images are small and have</span>
    <span class="hljs-comment"># few objects. Aim to allow ROI sampling to pick 33% positive ROIs.</span>
    TRAIN_ROIS_PER_IMAGE = <span class="hljs-number">32</span>

    <span class="hljs-comment"># Use a small epoch since the data is simple</span>
    STEPS_PER_EPOCH = <span class="hljs-number">2000</span>

    <span class="hljs-comment"># use small validation steps since the epoch is small</span>
    VALIDATION_STEPS = <span class="hljs-number">5</span>

config = ShapesConfig()
config.display()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_ax</span><span class="hljs-params">(rows=<span class="hljs-number">1</span>, cols=<span class="hljs-number">1</span>, size=<span class="hljs-number">8</span>)</span>:</span>
    <span class="hljs-string">"""Return a Matplotlib Axes array to be used in
    all visualizations in the notebook. Provide a
    central point to control graph sizes.

    Change the default size attribute to control the size
    of rendered images
    """</span>
    _, ax = plt.subplots(rows, cols, figsize=(size*cols, size*rows))
    <span class="hljs-keyword">return</span> ax

<span class="hljs-comment">#############################################       Dataset Made By Self         #############################################</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DrugDataset</span><span class="hljs-params">(utils.Dataset)</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_obj_index</span><span class="hljs-params">(self, image)</span>:</span>
        n =np.max(image)
        <span class="hljs-keyword">return</span> n

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">from_yaml_get_class</span><span class="hljs-params">(self,image_id)</span>:</span>
        info=self.image_info[image_id]
        <span class="hljs-keyword">with</span> open(info[<span class="hljs-string">'yaml_path'</span>]) <span class="hljs-keyword">as</span> f:
            temp=yaml.load(f.read())
            labels=temp[<span class="hljs-string">'label_names'</span>]
            <span class="hljs-keyword">del</span> labels[<span class="hljs-number">0</span>]
        <span class="hljs-keyword">return</span> labels

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">draw_mask</span><span class="hljs-params">(self, num_obj, mask, image)</span>:</span>
        info = self.image_info[image_id]
        <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> range(num_obj):
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(info[<span class="hljs-string">'width'</span>]):
                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(info[<span class="hljs-string">'height'</span>]):
                    at_pixel = image.getpixel((i, j))
                    <span class="hljs-keyword">if</span> at_pixel == index + <span class="hljs-number">1</span>:
                        mask[j, i, index] = <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> mask

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_shapes</span><span class="hljs-params">(self, count, height, width, img_floder, mask_floder, imglist,dataset_root_path)</span>:</span>
        <span class="hljs-string">"""Generate the requested number of images.
        count: number of images to generate.
        height, width: the size of the generated images.
        """</span>
        <span class="hljs-comment"># Add classes</span>
        self.add_class(<span class="hljs-string">"shapes"</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"intersection_three"</span>)
        self.add_class(<span class="hljs-string">"shapes"</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"intersection_four"</span>)
        self.add_class(<span class="hljs-string">"shapes"</span>, <span class="hljs-number">3</span>, <span class="hljs-string">"roundabout"</span>)
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(count):
            filestr = imglist[i].split(<span class="hljs-string">"."</span>)[<span class="hljs-number">0</span>]
            <span class="hljs-comment">#filestr = filestr.split("_")[1]</span>
            mask_path = mask_floder + <span class="hljs-string">"/"</span> + filestr + <span class="hljs-string">".png"</span>
            yaml_path = dataset_root_path + <span class="hljs-string">"json/"</span> + filestr + <span class="hljs-string">"_json/info.yaml"</span>
            self.add_image(<span class="hljs-string">"shapes"</span>, image_id=i, path=img_floder + <span class="hljs-string">"/"</span> + imglist[i],
                           width=width, height=height, mask_path=mask_path,yaml_path=yaml_path)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_mask</span><span class="hljs-params">(self, image_id)</span>:</span>
        <span class="hljs-string">"""Generate instance masks for shapes of the given image ID.
        """</span>
        info = self.image_info[image_id]
        count = <span class="hljs-number">1</span>  <span class="hljs-comment"># number of object</span>
        img = Image.open(info[<span class="hljs-string">'mask_path'</span>])
        num_obj = self.get_obj_index(img)
        mask = np.zeros([info[<span class="hljs-string">'height'</span>], info[<span class="hljs-string">'width'</span>], num_obj], dtype=np.uint8)

        mask = self.draw_mask(num_obj, mask, img)

        occlusion = np.logical_not(mask[:, :, -<span class="hljs-number">1</span>]).astype(np.uint8)
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(count - <span class="hljs-number">2</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):
            mask[:, :, i] = mask[:, :, i] * occlusion
            occlusion = np.logical_and(occlusion, np.logical_not(mask[:, :, i]))

        labels = []
        labels = self.from_yaml_get_class(image_id)
        labels_form = []
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(labels)):
            <span class="hljs-keyword">if</span> labels[i].find(<span class="hljs-string">"intersection_three"</span>) != -<span class="hljs-number">1</span>:
                labels_form.append(<span class="hljs-string">"intersection_three"</span>)
            <span class="hljs-keyword">elif</span> labels[i].find(<span class="hljs-string">"intersection_four"</span>) != -<span class="hljs-number">1</span>:
                labels_form.append(<span class="hljs-string">"intersection_four"</span>)
            <span class="hljs-keyword">elif</span> labels[i].find(<span class="hljs-string">"roundabout"</span>) != -<span class="hljs-number">1</span>:
                labels_form.append(<span class="hljs-string">"roundabout"</span>)
        class_ids = np.array([self.class_names.index(s) <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> labels_form])

        <span class="hljs-keyword">return</span> mask, class_ids.astype(np.int32)

<span class="hljs-comment">#基础设置</span>
dataset_root_path = <span class="hljs-string">"E:/Road Testdata/coco/"</span>
img_floder = dataset_root_path + <span class="hljs-string">"JPGImages"</span>
mask_floder = dataset_root_path + <span class="hljs-string">"mask"</span>
imglist = os.listdir(img_floder)
count = len(imglist)
width = <span class="hljs-number">1024</span>
height = <span class="hljs-number">1024</span>

<span class="hljs-comment"># Training dataset</span>
dataset_train = DrugDataset()
dataset_train.load_shapes(count, <span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>, img_floder, mask_floder, imglist,dataset_root_path)
dataset_train.prepare()

<span class="hljs-comment"># Validation dataset</span>
dataset_val = DrugDataset()
dataset_val.load_shapes(count, <span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>, img_floder, mask_floder, imglist,dataset_root_path)
dataset_val.prepare()

<span class="hljs-comment"># Load and display random samples</span>

image_ids = np.random.choice(dataset_train.image_ids, <span class="hljs-number">4</span>)

<span class="hljs-keyword">for</span> image_id <span class="hljs-keyword">in</span> image_ids:
    image = dataset_train.load_image(image_id)
    mask, class_ids = dataset_train.load_mask(image_id)
    <span class="hljs-comment">#visualize.display_top_masks(image, mask, class_ids, dataset_train.class_names)</span>

<span class="hljs-comment">##################################################       Ceate Model     ##################################################</span>
<span class="hljs-comment"># Create model in training mode</span>
model = modellib.MaskRCNN(mode=<span class="hljs-string">"training"</span>, config=config, model_dir=MODEL_DIR)

<span class="hljs-comment"># Which weights to start with?</span>
init_with = <span class="hljs-string">"coco"</span>  <span class="hljs-comment"># imagenet, coco, or last</span>

<span class="hljs-keyword">if</span> init_with == <span class="hljs-string">"imagenet"</span>:
    model.load_weights(model.get_imagenet_weights(), by_name=<span class="hljs-keyword">True</span>)
<span class="hljs-keyword">elif</span> init_with == <span class="hljs-string">"coco"</span>:
    <span class="hljs-comment"># Load weights trained on MS COCO, but skip layers that</span>
    <span class="hljs-comment"># are different due to the different number of classes</span>
    <span class="hljs-comment"># See README for instructions to download the COCO weights</span>
    model.load_weights(COCO_MODEL_PATH, by_name=<span class="hljs-keyword">True</span>,
                       exclude=[<span class="hljs-string">"mrcnn_class_logits"</span>, <span class="hljs-string">"mrcnn_bbox_fc"</span>, 
                                <span class="hljs-string">"mrcnn_bbox"</span>, <span class="hljs-string">"mrcnn_mask"</span>])
<span class="hljs-keyword">elif</span> init_with == <span class="hljs-string">"last"</span>:
    <span class="hljs-comment"># Load the last model you trained and continue training</span>
    model.load_weights(model.find_last()[<span class="hljs-number">1</span>], by_name=<span class="hljs-keyword">True</span>)


<span class="hljs-comment">##################################################       Training        ##################################################</span>
<span class="hljs-comment"># Train the head branches</span>
<span class="hljs-comment"># Passing layers="heads" freezes all layers except the head</span>
<span class="hljs-comment"># layers. You can also pass a regular expression to select</span>
<span class="hljs-comment"># which layers to train by name pattern.</span>
model.train(dataset_train, dataset_val, 
            learning_rate=config.LEARNING_RATE, 
            epochs=<span class="hljs-number">1</span>, 
            layers=<span class="hljs-string">'heads'</span>)

<span class="hljs-comment"># Fine tune all layers</span>
<span class="hljs-comment"># Passing layers="all" trains all layers. You can also </span>
<span class="hljs-comment"># pass a regular expression to select which layers to</span>
<span class="hljs-comment"># train by name pattern.</span>
model.train(dataset_train, dataset_val, 
            learning_rate=config.LEARNING_RATE / <span class="hljs-number">10</span>,
            epochs=<span class="hljs-number">2</span>, 
            layers=<span class="hljs-string">"all"</span>)

<span class="hljs-comment"># Save weights,Typically not needed because callbacks save after every epoch,Uncomment to save manually</span>
<span class="hljs-comment"># model_path = os.path.join(MODEL_DIR, "mask_rcnn_shapes.h5")</span>
<span class="hljs-comment"># model.keras_model.save_weights(model_path)</span>

<span class="hljs-comment">##################################################       Detection       ##################################################</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InferenceConfig</span><span class="hljs-params">(ShapesConfig)</span>:</span>
    GPU_COUNT = <span class="hljs-number">1</span>
    IMAGES_PER_GPU = <span class="hljs-number">1</span>

inference_config = InferenceConfig()

<span class="hljs-comment"># Recreate the model in inference mode</span>
model = modellib.MaskRCNN(mode=<span class="hljs-string">"inference"</span>, config=inference_config,model_dir=MODEL_DIR)

<span class="hljs-comment"># Get path to saved weights</span>
<span class="hljs-comment"># Either set a specific path or find last trained weights</span>
<span class="hljs-comment"># model_path = os.path.join(ROOT_DIR, ".h5 file name here")</span>
model_path = model.find_last()[<span class="hljs-number">1</span>]

<span class="hljs-comment"># Load trained weights (fill in path to trained weights here)</span>
<span class="hljs-keyword">assert</span> model_path != <span class="hljs-string">""</span>, <span class="hljs-string">"Provide path to trained weights"</span>
print(<span class="hljs-string">"Loading weights from "</span>, model_path)
model.load_weights(model_path, by_name=<span class="hljs-keyword">True</span>)

<span class="hljs-comment"># Test on a random image</span>
image_id = random.choice(dataset_val.image_ids)
original_image, image_meta, gt_class_id, gt_bbox, gt_mask =\
    modellib.load_image_gt(dataset_val, inference_config, image_id, use_mini_mask=<span class="hljs-keyword">False</span>)

log(<span class="hljs-string">"original_image"</span>, original_image)
log(<span class="hljs-string">"image_meta"</span>, image_meta)
log(<span class="hljs-string">"gt_class_id"</span>, gt_class_id)
log(<span class="hljs-string">"gt_bbox"</span>, gt_bbox)
log(<span class="hljs-string">"gt_mask"</span>, gt_mask)

visualize.display_instances( original_image, gt_bbox, gt_mask, gt_class_id, dataset_train.class_names, figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">8</span>) )

results = model.detect([original_image], verbose=<span class="hljs-number">1</span>)

r = results[<span class="hljs-number">0</span>]
visualize.display_instances(original_image, r[<span class="hljs-string">'rois'</span>], r[<span class="hljs-string">'masks'</span>], r[<span class="hljs-string">'class_ids'</span>], 
                            dataset_val.class_names, r[<span class="hljs-string">'scores'</span>], ax=get_ax())


<span class="hljs-comment">##################################################       Evaluation      ##################################################                 </span>
<span class="hljs-comment"># Compute VOC-Style mAP @ IoU=0.5</span>
<span class="hljs-comment"># Running on 10 images. Increase for better accuracy.</span>
image_ids = np.random.choice(dataset_val.image_ids, <span class="hljs-number">50</span>)
APs = []
<span class="hljs-keyword">for</span> image_id <span class="hljs-keyword">in</span> image_ids:
    <span class="hljs-comment"># Load image and ground truth data</span>
    image, image_meta, gt_class_id, gt_bbox, gt_mask =\
        modellib.load_image_gt(dataset_val, inference_config,image_id, use_mini_mask=<span class="hljs-keyword">False</span>)
    molded_images = np.expand_dims(modellib.mold_image(image, inference_config), <span class="hljs-number">0</span>)
    <span class="hljs-comment"># Run object detection</span>
    results = model.detect([image], verbose=<span class="hljs-number">0</span>)
    r = results[<span class="hljs-number">0</span>]
    <span class="hljs-comment"># Compute AP</span>
    AP, precisions, recalls, overlaps =\
        utils.compute_ap(gt_bbox, gt_class_id, gt_mask,r[<span class="hljs-string">"rois"</span>], r[<span class="hljs-string">"class_ids"</span>], r[<span class="hljs-string">"scores"</span>], r[<span class="hljs-string">'masks'</span>])
    APs.append(AP)

print(<span class="hljs-string">"mAP: "</span>, np.mean(APs))
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/24af008ab854f7f85296baf5231b8c16/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java项目练习3_类和对象</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0e0bb3be1074a0f3d09639ce5dfd922d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mask-rcnn训练完自己的数据集之后的测试demo</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>