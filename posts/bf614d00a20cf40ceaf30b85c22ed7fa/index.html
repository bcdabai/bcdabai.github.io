<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ubuntu&#43;Docker双容器docker-compose部署Django&#43;Vue项目(2-Django) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ubuntu&#43;Docker双容器docker-compose部署Django&#43;Vue项目(2-Django)" />
<meta property="og:description" content="文章目录 部署Django后端接口下载Python环境及一些尝试pip包管理运行项目容器报错1(查询容器IP解决)报错2(pvsite_uwsgi.ini文件配置socket还是http)报错3(用http先)用python manage.py runserver运行项目先报错4(下载cryptography库) 回到用uwsgi&#43;django运行成功先在uwsgi&#43;django中加入nginx配置 最终使用docker-compose双容器配置项目目录树docker-compose.yml配置最终Django文件配置requirements.txt文件配置pvsite_uwsgi.ini文件配置Django下的Dockerfile文件配置 最终Vue文件配置Vue下的Dockerfile文件配置Vue下的nginx.conf文件配置 其他笔记写在最后 部署Django后端接口 下载Python环境及一些尝试 由于项目用到是3.8.8版本，避免之后出现问题。就不下最新的了
docker pull python:3.8.8 以python镜像启动一个容器，参数以命令模式进入该容器：
docker run -it python /bin/bash /bin/bash进入容器中的命令行，暂时我理解为进入之后用法和ubuntu中的终端一样。(毕竟一个容器相当于一个虚拟机[滑稽])
但是上面的命令的命令会默认运行最新的python版本，本地的旧版本都不行
运行指定版本镜像
docker run -it python:3.8.8 /bin/bash 后台运行
在大部分的场景下，我们希望 docker 的服务是在后台运行的，我们可以过 -d 指定容器的运行模式，--name给容器起名
docker run -itd --name pythonTest python:3.8.8 /bin/bash 进入容器
exec 命令适用于进入后台运行的容器
docker exec -it 容器ID /bin/bash 可以直接进入容器中下载Django，执行如下命令，第一次不行，第二次就好了
pip install django pip包管理 在本地下载pip管理工具(可以下载其他工具试试,这里用pipreqs)
pip install pipreqs 下载完执行命令
pipreqs --encoding=utf8 ./ 导出文件到当前路径，后续可继续添加所需要的库
运行项目容器 先跑出项目容器
docker run -it -d --name Djangotest -p 9001:9001 -v /home/andy/Web/Django:/home/andy/Web/Django python:3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/bf614d00a20cf40ceaf30b85c22ed7fa/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-06T14:44:22+08:00" />
<meta property="article:modified_time" content="2022-12-06T14:44:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ubuntu&#43;Docker双容器docker-compose部署Django&#43;Vue项目(2-Django)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#Django_1" rel="nofollow">部署Django后端接口</a></li><li><ul><li><a href="#Python_2" rel="nofollow">下载Python环境及一些尝试</a></li><li><a href="#pip_35" rel="nofollow">pip包管理</a></li><li><a href="#_48" rel="nofollow">运行项目容器</a></li><li><ul><li><a href="#1IP_72" rel="nofollow">报错1(查询容器IP解决)</a></li><li><a href="#2pvsite_uwsgiinisockethttp_105" rel="nofollow">报错2(pvsite_uwsgi.ini文件配置socket还是http)</a></li><li><a href="#3http_116" rel="nofollow">报错3(用http先)</a></li><li><a href="#python_managepy_runserver_124" rel="nofollow">用python manage.py runserver运行项目先</a></li><li><ul><li><a href="#4cryptography_129" rel="nofollow">报错4(下载cryptography库)</a></li></ul> 
     </li><li><a href="#uwsgidjango_138" rel="nofollow">回到用uwsgi+django运行成功先</a></li><li><a href="#uwsgidjangonginx_152" rel="nofollow">在uwsgi+django中加入nginx配置</a></li></ul> 
   </li></ul> 
   </li><li><a href="#dockercompose_167" rel="nofollow">最终使用docker-compose双容器配置</a></li><li><ul><li><a href="#_169" rel="nofollow">项目目录树</a></li><li><a href="#dockercomposeyml_235" rel="nofollow">docker-compose.yml配置</a></li><li><a href="#Django_282" rel="nofollow">最终Django文件配置</a></li><li><ul><li><a href="#requirementstxt_284" rel="nofollow">requirements.txt文件配置</a></li><li><a href="#pvsite_uwsgiini_293" rel="nofollow">pvsite_uwsgi.ini文件配置</a></li><li><a href="#DjangoDockerfile_319" rel="nofollow">Django下的Dockerfile文件配置</a></li></ul> 
    </li><li><a href="#Vue_332" rel="nofollow">最终Vue文件配置</a></li><li><ul><li><a href="#VueDockerfile_335" rel="nofollow">Vue下的Dockerfile文件配置</a></li><li><a href="#Vuenginxconf_348" rel="nofollow">Vue下的nginx.conf文件配置</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_438" rel="nofollow">其他笔记</a></li><li><a href="#_449" rel="nofollow">写在最后</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="Django_1"></a>部署Django后端接口</h3> 
<h4><a id="Python_2"></a>下载Python环境及一些尝试</h4> 
<p>由于项目用到是3.8.8版本，避免之后出现问题。就不下最新的了</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> pull python:3.8.8
</code></pre> 
<p><img src="https://images2.imgbox.com/28/4f/zeEgzuNy_o.png" alt="请添加图片描述"><br> 以python镜像启动一个容器，参数以命令模式进入该容器：</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-it</span> python /bin/bash
</code></pre> 
<p><code>/bin/bash</code>进入容器中的命令行，暂时我理解为进入之后用法和ubuntu中的终端一样。(毕竟一个容器相当于一个虚拟机[滑稽])<br> <strong>但是上面的命令的命令会默认运行最新的python版本，本地的旧版本都不行</strong><br> 运行指定版本镜像</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-it</span> python:3.8.8 /bin/bash
</code></pre> 
<p><img src="https://images2.imgbox.com/5b/aa/gjEQxVlB_o.png" alt="请添加图片描述"><br> <strong>后台运行</strong><br> 在大部分的场景下，我们希望 docker 的服务是在后台运行的，我们可以过 <code>-d</code> 指定容器的运行模式，<code>--name</code>给容器起名</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-itd</span>  <span class="token parameter variable">--name</span> pythonTest python:3.8.8 /bin/bash  
</code></pre> 
<p><img src="https://images2.imgbox.com/cb/47/YDlcv2tl_o.png" alt="在这里插入图片描述"><br> <strong>进入容器</strong><br> <code>exec</code> <strong>命令适用于进入后台运行的容器</strong></p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> 容器ID /bin/bash
</code></pre> 
<p>可以直接进入容器中下载Django，执行如下命令，第一次不行，第二次就好了</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> django
</code></pre> 
<h4><a id="pip_35"></a>pip包管理</h4> 
<p>在本地下载pip管理工具(可以下载其他工具试试,这里用<strong>pipreqs</strong>)</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> pipreqs
</code></pre> 
<p>下载完执行命令</p> 
<pre><code class="prism language-bash">pipreqs  <span class="token parameter variable">--encoding</span><span class="token operator">=</span>utf8  ./
</code></pre> 
<p>导出文件到当前路径，后续可继续添加所需要的库<br> <img src="https://images2.imgbox.com/3c/ba/UnSq8zib_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/ed/c5/VAjm3QR6_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_48"></a>运行项目容器</h4> 
<p>先跑出项目容器</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> Djangotest <span class="token parameter variable">-p</span> <span class="token number">9001</span>:9001 <span class="token parameter variable">-v</span> /home/andy/Web/Django:/home/andy/Web/Django python:3.8.8
<span class="token comment">#-v /home/test:/home/test是将/home/test是将主机上的该目录挂载到容器内的home目录下（当然也可以使用docker cp命令）</span>
</code></pre> 
<p>其他解释见第一节</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">-v</span>         用于挂载容器目录路径，内外共享目录，用法：-v 宿主机路径:容器路径
</code></pre> 
<p>进入容器</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> Djangotest <span class="token function">bash</span>
</code></pre> 
<p>然后安装<strong>requirements.txt</strong>中的库，执行完再安装<strong>uwsgi</strong>。</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> <span class="token parameter variable">-r</span> /home/andy/Web/Django/requirements.txt
pip <span class="token function">install</span> uwsgi
</code></pre> 
<p><strong>uwsgi运行项目</strong></p> 
<pre><code class="prism language-bash">uwsgi  <span class="token parameter variable">--ini</span>  /home/andy/Web/Django/pvsite_uwsgi.ini 
</code></pre> 
<h5><a id="1IP_72"></a>报错1(查询容器IP解决)</h5> 
<p><img src="https://images2.imgbox.com/e4/f7/08M2DXXS_o.png" alt="在这里插入图片描述"><br> 应该<strong>pvsite_uwsgi.ini</strong>中的IP配置有问题<br> <strong>查看docker容器的IP</strong></p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> inspect 99ef4b98f188<span class="token punctuation">(</span>该容器ID<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/fc/a2/owmwbXNX_o.jpg" alt="请添加图片描述"><br> 容器IP就是<code>172.17.0.5</code><br> 修改<strong>pvsite_uwsgi.ini</strong>配置如下</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>uwsgi<span class="token punctuation">]</span>

<span class="token comment">#chdir=/home/andy/Documents/photovoltaic/photovoltaicsite   # 指定运行目录:项目根目录的绝对路径</span>

<span class="token comment"># 指定sock的文件路径,可以用端口或sock文件（Nginx监听的端口）</span>
socket <span class="token operator">=</span> <span class="token number">172.17</span>.0.5:9001
<span class="token comment"># stats子系统允许您将uWSGI的内部统计数据导出为JSON, 在指定的地址上，开启状态服务</span>
<span class="token comment">#stats = 127.0.0.1:9999</span>
<span class="token comment">#载入wsgi-file</span>
wsgi-file <span class="token operator">=</span> photovoltaicsite/wsgi.py

<span class="token comment">#允许主进程存在（enable master process）</span>
<span class="token assign-left variable">master</span><span class="token operator">=</span>true
<span class="token comment">#设置最大工作进程数:将会生成4个进程, 每个进程有2个线程</span>
<span class="token assign-left variable">processes</span><span class="token operator">=</span><span class="token number">4</span>
threads <span class="token operator">=</span> <span class="token number">2</span>
<span class="token comment">#某个权限</span>
chmod-socket <span class="token operator">=</span> <span class="token number">666</span>  
<span class="token comment">#退出时清除环境  </span>
<span class="token assign-left variable">vacuum</span><span class="token operator">=</span>true  
</code></pre> 
<p>再次运行</p> 
<h5><a id="2pvsite_uwsgiinisockethttp_105"></a>报错2(pvsite_uwsgi.ini文件配置socket还是http)</h5> 
<blockquote> 
 <p>invalid request block size:21573 (max 4896) …skip</p> 
</blockquote> 
<p>看样子能访问，但是uwsgi内部解析的数据包只能最大4k。<br> 看样子给<strong>pvsite_uwsgi.ini</strong>文件增加一条这个就行。(后续结合nginx应该不会出现这种问题)</p> 
<pre><code class="prism language-bash"><span class="token comment">#设置用于uwsgi包解析的内部缓存区大小到64k。默认是4k。</span>
buffer-size <span class="token operator">=</span> <span class="token number">65536</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b8/81/5Q5h531r_o.png" alt="在这里插入图片描述"><br> 加完之后继续运行</p> 
<h5><a id="3http_116"></a>报错3(用http先)</h5> 
<pre><code class="prism language-bash">uwsgi_proto_uwsgi_parser<span class="token punctuation">(</span><span class="token punctuation">)</span>: Resource temporarily unavailable <span class="token punctuation">[</span>proto/uwsgi.c line <span class="token number">40</span><span class="token punctuation">]</span>
</code></pre> 
<blockquote> 
 <p><font color="red">这个报错目前不清楚是为什么，在docker中测试了很久。我是按照这个地址<code>192.168.80.128:9001</code>去访问的。而这个地址和端口是Django+uwsgi容器运行直接映射的端口。<br> 知道为什么了，人都傻了。自己在<strong>pvsite_uwsgi.ini</strong>配置的<code>socket = 172.17.0.5:9001。</code>我部署的是<code>socket</code>不是<code>http</code>怎么能用浏览器去访问到了。要在nginx中去监听这个socket才能访问啊。socket改成http就可以了。</font></p> 
</blockquote> 
<h5><a id="python_managepy_runserver_124"></a>用python manage.py runserver运行项目先</h5> 
<p>运行到现在其实还没配置好数据库(直觉告诉我先<strong>python manage.py runserver</strong>运行成功，这些问题迎刃而解),先用<strong>python manage.py runserver</strong>启动项目。配置好数据库吧。</p> 
<p><strong>Django项目在settings.py中先改成连接另外一个ubuntu里的mysql试试</strong><br> <img src="https://images2.imgbox.com/ba/d3/cPFMjeLb_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="4cryptography_129"></a>报错4(下载cryptography库)</h6> 
<p>出现了之前一样的问题。确实个package。</p> 
<blockquote> 
 <p><code>bash RuntimeError: 'cryptography' package is required for sha256_password or caching_sha2_password auth methods </code></p> 
</blockquote> 
<p>按照下面下载之后就可以运行成功了。</p> 
<pre><code class="prism language-bash"> pip <span class="token function">install</span> cryptography
</code></pre> 
<h5><a id="uwsgidjango_138"></a>回到用uwsgi+django运行成功先</h5> 
<p><strong>先收集Django后台的资源，运行如下命令，在当前路径下会生成static文件夹保存网页需要的静态资源。</strong></p> 
<pre><code class="prism language-bash">python manage.py collectstatic
</code></pre> 
<p><strong>由于之前在Django中的settings配置过资源路径只需要pvsite_uwsgi.ini文件新增如下：</strong></p> 
<pre><code class="prism language-bash"><span class="token comment">#加上读取静态资源路径(Django后台的css文件等,不然没样式)</span>
static-map <span class="token operator">=</span>/static<span class="token operator">=</span>/home/andy/Web/Django/photovoltaicsite/static
</code></pre> 
<p>访问Django后台成功了<br> <img src="https://images2.imgbox.com/70/09/Jd5kF3tB_o.png" alt="请添加图片描述"></p> 
<h5><a id="uwsgidjangonginx_152"></a>在uwsgi+django中加入nginx配置</h5> 
<p>先将<strong>pvsite_uwsgi.ini</strong>配置的<code>http= 172.17.0.5:9001。</code>改成<code>socket=容器IP:端口</code><br> 加上-d后台运行<code>uwsgi -d --ini /home/andy/Web/Django/pvsite_uwsgi.ini </code></p> 
<p><strong>然后运行nginx容器</strong><br> 这里我用的是<code>-v</code>挂载宿主机的目录和文件，所以有点长。(后面完善直接打包镜像用更好的方法) 。别忘了最后的nginx镜像</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> Vuetest <span class="token parameter variable">-p</span> <span class="token number">8080</span>:8080 <span class="token parameter variable">-v</span> /home/andy/Web/Vue/dist/:/usr/share/nginx/html/ <span class="token parameter variable">-v</span> /home/andy/Web/Vue/nginx.conf:/etc/nginx/nginx.conf  nginx
</code></pre> 
<p>文件目录挂载</p> 
<pre><code class="prism language-bash"><span class="token comment">#-v /home/andy/Web/Vue/dist/:/usr/share/nginx/html/</span>
<span class="token comment">#-v /home/andy/Web/Vue/nginx.conf:/etc/nginx/nginx.conf</span>
</code></pre> 
<p><strong>这里已经要开启另外的nginx容器了。双容器运行的话要进行通信(像两个独立的虚拟机)。下面用到docker-compose</strong></p> 
<h3><a id="dockercompose_167"></a>最终使用docker-compose双容器配置</h3> 
<h4><a id="_169"></a>项目目录树</h4> 
<p><code>/home/andy/web</code>目录下的大致目录结构</p> 
<pre><code class="prism language-bash">Web:.
│  docker-compose.yml
├─Django
│  │  Dockerfile
│  │  uwsgi_params 
│  └─photovoltaicsite
│      │  manage.py
│      │  pvsite_uwsgi.ini
│      │  requirements.txt
│      ├─photovoltaiccalculation
│      │  │  admin.py
│      │  │  api.py
│      │  │  api_url.py
│      │  │  apps.py
│      │  │  models.py
│      │  │  modelToJson.py
│      │  │  tests.py
│      │  │  views.py
│      │  │  __init__.py
│      │  ├─migrations
│      │          
│      ├─photovoltaicsite
│      │  │  asgi.py
│      │  │  settings.py
│      │  │  urls.py
│      │  │  wsgi.py
│      │  │  __init__.py
│      │  └─__pycache__         
│      ├─static
│      │  ├─admin
│      │  │  ├─css            
│      │  │  ├─fonts    
│      │  │  ├─img          
│      │  │  └─js                 
│      │  └─rest_framework
│      │      ├─css      
│      │      ├─docs
│      │      │  ├─css    
│      │      │  ├─img  
│      │      │  └─js        
│      │      ├─fonts     
│      │      ├─img     
│      │      └─js
│      │              
│      └─upload
│          └─headImg
│                  <span class="token number">20221027135148</span>-4.png
│                  <span class="token number">20221206021825</span>-1.png
│                  
├─Mysql<span class="token punctuation">(</span>这个项目我直接连接了另外一台虚拟机上的mysql<span class="token punctuation">)</span>
└─Vue
    │  Dockerfile
    │  nginx.conf
    └─dist
        │  favicon.ico
        │  index.html  
        ├─css     
        ├─fonts     
        ├─img      
        └─js            
</code></pre> 
<p>在windows下可以终端下用<code>tree /f &gt;tree.md</code>生成目录树</p> 
<h4><a id="dockercomposeyml_235"></a>docker-compose.yml配置</h4> 
<pre><code class="prism language-typescript">version<span class="token operator">:</span> <span class="token string">"3"</span>

networks<span class="token operator">:</span> # <span class="token function">自定义网络</span><span class="token punctuation">(</span>默认桥接<span class="token punctuation">)</span><span class="token punctuation">,</span> 不使用links通信 
  #proxy<span class="token operator">:</span>
    #ipam<span class="token operator">:</span>
      #config<span class="token operator">:</span>
      #<span class="token operator">-</span> subnet<span class="token operator">:</span> <span class="token number">172.16</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> #由于默认bridge桥接网络，重启容器后ip地址会改变<span class="token punctuation">.</span>固定<span class="token constant">IP</span>
  django_network<span class="token operator">:</span>
    driver<span class="token operator">:</span> bridge
  vue_nginx_network<span class="token operator">:</span>
    driver<span class="token operator">:</span> bridge

services<span class="token operator">:</span>
  django<span class="token operator">:</span>
    build<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>andy<span class="token operator">/</span>Web<span class="token operator">/</span>Django # <span class="token string">'.'</span>代表当前目录
    #command<span class="token operator">:</span> uwsgi  <span class="token operator">--</span>ini  <span class="token operator">/</span>home<span class="token operator">/</span>andy<span class="token operator">/</span>Web<span class="token operator">/</span>Django<span class="token operator">/</span>photovoltaicsite<span class="token operator">/</span>pvsite_uwsgi<span class="token punctuation">.</span>ini   # 容器启动后启动web服务器<span class="token punctuation">,</span>执行多条指令用下面的
    command<span class="token operator">:</span> bash <span class="token operator">-</span>c <span class="token string">'python manage.py makemigrations&amp;&amp;python manage.py migrate&amp;&amp;uwsgi  --ini  /home/andy/Web/Django/photovoltaicsite/pvsite_uwsgi.ini'</span>
    networks<span class="token operator">:</span>
     <span class="token operator">-</span> django_network
     #proxy<span class="token operator">:</span>
      #ipv4_address<span class="token operator">:</span> <span class="token number">172.17</span><span class="token number">.0</span><span class="token number">.5</span> #固定<span class="token constant">IP</span>
    ports<span class="token operator">:</span>       #暴露容器端口，与<span class="token operator">-</span>p相同，但是端口不能低于<span class="token number">60</span>
      <span class="token operator">-</span> <span class="token string">"9090:9090"</span>
    volumes<span class="token operator">:</span>      #虚拟机挂载文件和目录到容器
      <span class="token operator">-</span> <span class="token operator">/</span>home<span class="token operator">/</span>andy<span class="token operator">/</span>Web<span class="token operator">/</span>Django<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>andy<span class="token operator">/</span>Web<span class="token operator">/</span>Django
    restart<span class="token operator">:</span> always # always表容器运行发生错误时一直重启

  vue_nginx<span class="token operator">:</span>
    build<span class="token operator">:</span> <span class="token operator">/</span>home<span class="token operator">/</span>andy<span class="token operator">/</span>Web<span class="token operator">/</span>Vue
    ports<span class="token operator">:</span>
      <span class="token operator">-</span> <span class="token string">"8080:8080"</span>
      <span class="token operator">-</span> <span class="token string">"9001:9001"</span>
    restart<span class="token operator">:</span> always # always表容器运行发生错误时一直重启
    volumes<span class="token operator">:</span>     #虚拟机挂载文件和目录到容器
      <span class="token operator">-</span> <span class="token operator">/</span>home<span class="token operator">/</span>andy<span class="token operator">/</span>Web<span class="token operator">/</span>Vue<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf
      <span class="token operator">-</span> <span class="token operator">/</span>home<span class="token operator">/</span>andy<span class="token operator">/</span>Web<span class="token operator">/</span>Vue<span class="token operator">/</span>dist<span class="token operator">/</span><span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token operator">/</span>
      <span class="token operator">-</span> <span class="token operator">/</span>home<span class="token operator">/</span>andy<span class="token operator">/</span>Web<span class="token operator">/</span>Django<span class="token operator">:</span><span class="token operator">/</span>home<span class="token operator">/</span>andy<span class="token operator">/</span>Web<span class="token operator">/</span>Django
    networks<span class="token operator">:</span>
      <span class="token operator">-</span> vue_nginx_network
      <span class="token operator">-</span> django_network #将vue_nginx_network加入到django的网络中
    depends_on<span class="token operator">:</span> #此标签用于解决容器的依赖，启动先后问题。如启动应用容器，需要先启动数据库容器php<span class="token operator">:</span>depends_on<span class="token operator">:</span><span class="token operator">-</span> apache<span class="token operator">-</span> mysql
      <span class="token operator">-</span> django
</code></pre> 
<h4><a id="Django_282"></a>最终Django文件配置</h4> 
<p>Django下的setttings.py配置就不展示了。网上其他教程容易搜到</p> 
<h5><a id="requirementstxt_284"></a>requirements.txt文件配置</h5> 
<pre><code class="prism language-bash"><span class="token assign-left variable">Django</span><span class="token operator">==</span><span class="token number">4.1</span>
<span class="token assign-left variable">djangorestframework</span><span class="token operator">==</span><span class="token number">3.14</span>.0
<span class="token assign-left variable">PyMySQL</span><span class="token operator">==</span><span class="token number">1.0</span>.2
django-cors-headers<span class="token operator">==</span><span class="token number">3.13</span>.0
<span class="token assign-left variable">uwsgi</span><span class="token operator">==</span><span class="token number">2.0</span>.21
<span class="token assign-left variable">cryptography</span><span class="token operator">==</span><span class="token number">38.0</span>.4
</code></pre> 
<h5><a id="pvsite_uwsgiini_293"></a>pvsite_uwsgi.ini文件配置</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>uwsgi<span class="token punctuation">]</span>

<span class="token comment">#chdir=/home/andy/Documents/photovoltaic/photovoltaicsite   # 指定运行目录:项目根目录的绝对路径</span>

<span class="token comment"># 指定sock的文件路径,可以用端口或sock文件（Nginx监听的端口）</span>
socket <span class="token operator">=</span> <span class="token number">0.0</span>.0.0:9090

<span class="token comment"># stats子系统允许您将uWSGI的内部统计数据导出为JSON, 在指定的地址上，开启状态服务</span>
<span class="token comment">#stats = 127.0.0.1:9999</span>
<span class="token comment">#载入wsgi-file</span>
wsgi-file <span class="token operator">=</span> photovoltaicsite/wsgi.py

<span class="token comment">#允许主进程存在（enable master process）</span>
<span class="token assign-left variable">master</span><span class="token operator">=</span>true
<span class="token comment">#设置最大工作进程数:将会生成4个进程, 每个进程有2个线程</span>
<span class="token assign-left variable">processes</span><span class="token operator">=</span><span class="token number">4</span>
threads <span class="token operator">=</span> <span class="token number">2</span>
<span class="token comment">#某个权限</span>
chmod-socket <span class="token operator">=</span> <span class="token number">666</span>  
<span class="token comment">#退出时清除环境  </span>
<span class="token assign-left variable">vacuum</span><span class="token operator">=</span>true  
<span class="token comment">#设置用于uwsgi包解析的内部缓存区大小到64k。默认是4k。</span>
buffer-size <span class="token operator">=</span> <span class="token number">65536</span>
</code></pre> 
<h5><a id="DjangoDockerfile_319"></a>Django下的Dockerfile文件配置</h5> 
<pre><code class="prism language-bash"><span class="token comment"># 建立  python:3.8.8 环境</span>
FROM python:3.8.8
<span class="token comment"># 镜像作者andy</span>
MAINTAINER andy
<span class="token comment"># 将项目文件拷贝到工作目录下（拷贝的主机内容，最好是相对路径）</span>
COPY Django/ /home/andy/Web/Django
<span class="token comment"># 设置容器内工作目录</span>
WORKDIR /home/andy/Web/Django/photovoltaicsite
<span class="token comment"># 在容器内安装django项目需要的库</span>
RUN pip <span class="token function">install</span> <span class="token parameter variable">-r</span> /home/andy/Web/Django/photovoltaicsite/requirements.txt
</code></pre> 
<h4><a id="Vue_332"></a>最终Vue文件配置</h4> 
<p>dist文件是vue-cli中build项目得到的</p> 
<h5><a id="VueDockerfile_335"></a>Vue下的Dockerfile文件配置</h5> 
<pre><code class="prism language-bash"><span class="token comment"># 设置基础镜像</span>
FROM nginx
<span class="token comment"># 定义作者</span>
MAINTAINER andy
<span class="token comment"># 将dist文件中的内容复制到 /usr/share/nginx/html/ 这个目录下面</span>
COPY dist/  /usr/share/nginx/html/
COPY nginx.conf /etc/nginx/nginx.conf
<span class="token comment">#-v dist/  /usr/share/nginx/html/</span>
<span class="token comment">#-v /home/andy/Web/Vue/nginx.conf:/etc/nginx/nginx.conf</span>
</code></pre> 
<h5><a id="Vuenginxconf_348"></a>Vue下的nginx.conf文件配置</h5> 
<pre><code class="prism language-bash">user www-data<span class="token punctuation">;</span>
worker_processes auto<span class="token punctuation">;</span>
pid /run/nginx.pid<span class="token punctuation">;</span>
include /etc/nginx/modules-enabled/*.conf<span class="token punctuation">;</span>

events <span class="token punctuation">{<!-- --></span>
	worker_connections <span class="token number">768</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{<!-- --></span>
	sendfile on<span class="token punctuation">;</span>
	tcp_nopush on<span class="token punctuation">;</span>
	tcp_nodelay on<span class="token punctuation">;</span>
	keepalive_timeout <span class="token number">65</span><span class="token punctuation">;</span>
	types_hash_max_size <span class="token number">2048</span><span class="token punctuation">;</span>
	include /etc/nginx/mime.types<span class="token punctuation">;</span>
	default_type application/octet-stream<span class="token punctuation">;</span>

	<span class="token comment">##</span>
	<span class="token comment"># SSL Settings</span>
	<span class="token comment">##</span>

	ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3<span class="token punctuation">;</span> <span class="token comment"># Dropping SSLv3, ref: POODLE</span>
	ssl_prefer_server_ciphers on<span class="token punctuation">;</span>

	<span class="token comment">##</span>
	<span class="token comment"># Logging Settings</span>
	<span class="token comment">##</span>

	access_log /var/log/nginx/access.log<span class="token punctuation">;</span>
	error_log /var/log/nginx/error.log<span class="token punctuation">;</span>

	<span class="token comment">##</span>
	<span class="token comment"># Gzip Settings</span>
	<span class="token comment">##</span>

	<span class="token function">gzip</span> on<span class="token punctuation">;</span>
	<span class="token comment">#	Vue configuration</span>
	server <span class="token punctuation">{<!-- --></span>
	listen   <span class="token number">8080</span><span class="token punctuation">;</span>     <span class="token comment">#配置访问时的端口号</span>
	server_name  <span class="token number">192.168</span>.80.129<span class="token punctuation">;</span>
	charset     utf-8<span class="token punctuation">;</span>
	client_max_body_size  75M<span class="token punctuation">;</span>  <span class="token comment">#影响post文件的最大大小</span>

	location / <span class="token punctuation">{<!-- --></span>          <span class="token comment">#配置web静态资源</span>
		root /usr/share/nginx/html/<span class="token punctuation">;</span>
		index index.html<span class="token punctuation">;</span>
		add_header <span class="token string">'Access-Control-Allow-Origin'</span> <span class="token string">'*'</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token comment">#	uWSGi configuration</span>
	upstream django <span class="token punctuation">{<!-- --></span>
	    server <span class="token number">192.168</span>.80.129:9090<span class="token punctuation">;</span> <span class="token comment"># for a web port socket (we'll use this first)</span>
	<span class="token punctuation">}</span>
	server <span class="token punctuation">{<!-- --></span>
	listen   <span class="token number">9001</span><span class="token punctuation">;</span>     <span class="token comment">#配置访问时的端口号</span>
	server_name  <span class="token number">192.168</span>.80.129<span class="token punctuation">;</span>
	charset     utf-8<span class="token punctuation">;</span>
	client_max_body_size  75M<span class="token punctuation">;</span>  <span class="token comment">#影响post文件的最大大小</span>
	
	location /upload <span class="token punctuation">{<!-- --></span>        <span class="token comment">#配置媒体资源文件</span>
		expires 30d<span class="token punctuation">;</span>
		autoindex  on<span class="token punctuation">;</span>
		add_header Cache-Control private<span class="token punctuation">;</span>
		<span class="token builtin class-name">alias</span> /home/andy/Web/Django/photovoltaicsite/upload<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	location /static <span class="token punctuation">{<!-- --></span>      <span class="token comment">#配置静态资源文件</span>
		expires 30d<span class="token punctuation">;</span>
		autoindex on<span class="token punctuation">;</span>
		add_header Cache-Control private<span class="token punctuation">;</span>
		<span class="token comment">#alias /home/andy/Documents/photovoltaic/photovoltaiccalculation;</span>
		<span class="token builtin class-name">alias</span> /home/andy/Web/Django/photovoltaicsite/static<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	location / <span class="token punctuation">{<!-- --></span>          <span class="token comment">#配置uWSGI服务器</span>
		include /etc/nginx/uwsgi_params<span class="token punctuation">;</span>
		uwsgi_pass django<span class="token punctuation">;</span>
		uwsgi_read_timeout <span class="token number">2</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	include /etc/nginx/conf.d/*.conf<span class="token punctuation">;</span>
	include /etc/nginx/sites-enabled/*<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ee/74/CffrU31M_o.png" alt="请添加图片描述"><br> 最后能成功运行。</p> 
<h3><a id="_438"></a>其他笔记</h3> 
<p>Linux中<code>echo</code>命令的功能是写内容到标准输出。</p> 
<pre><code class="prism language-bash"><span class="token comment">#echo hello world</span>
hello world
</code></pre> 
<p>给static文件夹及其子文件和子目录的所有权限(读写)给所有用户：(当前路径有static文件夹)</p> 
<pre><code class="prism language-bash"><span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">777</span> static
</code></pre> 
<h3><a id="_449"></a>写在最后</h3> 
<p>由于初次使用Docker。这篇博客更像是个人的一个笔记(边做边记)，可能写的不是很清晰。但是对ubuntu+Docker环境的部署还是会有一些参考价值。</p> 
<p>在部署完后之后。对个人也有一些开发上的思考。比如在访问前端项目时，如果出现一些网络错误或是莫名其妙的短暂性的跨域(Django中已经设置过cors解决跨域了，不知道为什么会间歇性出现这个报错。但却不影响功能)导致访问不到资源，此时网站应该给出一个响应，类似返回一个自定义404页面或是500页面。</p> 
<p><a href="https://blog.csdn.net/weixin_43810267/article/details/119883350">主要参考链接1</a><br> <a href="https://blog.csdn.net/qq_44976531/article/details/127615409">主要参考链接2</a><br> <a href="https://mp.weixin.qq.com/s?__biz=MjM5OTMyODA4Nw==&amp;mid=2247486903&amp;idx=1&amp;sn=5d2172f66c0357ffaefac7c783c80867&amp;chksm=a73c6d8f904be4999d7844a7f70f9d3aa8cc460cd18089f13924711a3261cd4c69d1c7b6933e&amp;scene=178&amp;cur_album_id=1343884685092503554#rd" rel="nofollow">做完发现的一个比较完善的部署教程</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/384c81401e765be11d69b10241fdcbeb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">拯救强迫症：Win11去除桌面快捷方式小箭头</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1e4a586291fbb0747acc7d1f6816fdca/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Redis 性能问题&amp;优化方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>