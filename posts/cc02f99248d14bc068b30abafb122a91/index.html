<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>iOS 中block的循环引用问题 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="iOS 中block的循环引用问题" />
<meta property="og:description" content="开发中经常使用weakSelf和strongSelf来解决block的循环引用问题，但是是不是所有的block都会导致循环引用呢？显然不是的，那么怎么判断调用一个带有block方法时是否会造成循环引用呢，我们来分析一下。
首先我们来写一个含有block的类，并调用自己，然后在外部实现这个block，来测试什么情况会出现循环引用。
@interface ALDTestBlockModel () @property (nonatomic, copy) dispatch_block_t testBlock; @property (nonatomic, copy) NSString * testString; @end @implementation ALDTestBlockModel - (void)initWithBlock1:(dispatch_block_t)block{ //对象不持有该block if (block) { block(); } } - (void)initWithBlock2:(dispatch_block_t)block{ //对象持有该block self.testBlock = block; if (self.testBlock) { self.testBlock(); } } @end 外部测试代码：
@interface ALDTestBlockController () @property (nonatomic, strong) ALDTestBlockModel *model; @end @implementation ALDTestBlockController - (void)viewDidLoad { [super viewDidLoad]; self.model = [ALDTestBlockModel new]; [self noSelfTest]; //[self haveSelfTest]; } - (void)noSelfTest{ [self." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/cc02f99248d14bc068b30abafb122a91/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-12-20T15:30:26+08:00" />
<meta property="article:modified_time" content="2018-12-20T15:30:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">iOS 中block的循环引用问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>开发中经常使用weakSelf和strongSelf来解决block的循环引用问题，但是是不是所有的block都会导致循环引用呢？显然不是的，那么怎么判断调用一个带有block方法时是否会造成循环引用呢，我们来分析一下。<br> 首先我们来写一个含有block的类，并调用自己，然后在外部实现这个block，来测试什么情况会出现循环引用。</p> 
<pre><code>@interface ALDTestBlockModel ()

@property (nonatomic, copy) dispatch_block_t testBlock;
@property (nonatomic, copy) NSString * testString;

@end

@implementation ALDTestBlockModel
- (void)initWithBlock1:(dispatch_block_t)block{
    //对象不持有该block
    if (block) {
        block();
    }
}

- (void)initWithBlock2:(dispatch_block_t)block{
    //对象持有该block
    self.testBlock = block;
    if (self.testBlock) {
        self.testBlock();
    }
}
@end
</code></pre> 
<p>外部测试代码：</p> 
<pre><code>@interface ALDTestBlockController ()

@property (nonatomic, strong) ALDTestBlockModel *model;

@end

@implementation ALDTestBlockController

- (void)viewDidLoad {
    [super viewDidLoad];
    self.model = [ALDTestBlockModel new];
    [self noSelfTest];
    //[self haveSelfTest];
}

- (void)noSelfTest{
    [self.model initWithBlock1:^{
        NSLog(@"1111self=[]");
    }];
    [self.model initWithBlock2:^{
        NSLog(@"2222self=[]");
    }];
}

- (void)haveSelfTest{
    [self.model initWithBlock1:^{
        NSLog(@"1111self====== %@",self.testString);
    }];
    [self.model initWithBlock2:^{
        NSLog(@"2222self====== %@",self.testString);
    }];
}

- (void)dealloc{
    NSLog(@"");
}

@end
</code></pre> 
<p>我们首先来测试在实现block中没有出现self及成员变量之类的，我们断点在block类中，可以看一下block和testBlock的isa，我们会发现block和testBlock的isa都是一个NSGlobalBlock类型，然后在controller点击返回，断点在dealloc，会发现会走断点。</p> 
<p>然后来测一下block中出现self或者成员变量时，先测</p> 
<pre><code>[self.model initWithBlock1:^{
        NSLog(@"1111self====== %@",self.testString);
    }];
</code></pre> 
<p>这个方法里面，未持有block，点击返回，dealloc的断点依然会走。<br> 再来测一下</p> 
<pre><code>[self.model initWithBlock2:^{
        NSLog(@"2222self====== %@",self.testString);
    }];
</code></pre> 
<p>这个方法里面，model持有了block，点击返回不会走dealloc，说明出现了循环引用。这个时候就可以用weakSelf和strongSelf来解决循环引用的问题了。<br> 总结一下，当调用带有block的方法时，如果该方法内部没有持有该block，那么这个方法在被调用时，就不需要考虑循环引用的问题。如果该方法内部持有了该block，那么这个方法在被调用时，一定要注意block实现时是否会用到self或者self相关的，如果要用到，就需要用weakSelf和strongSelf来避免循环引用。<br> 最后补充一点，block的isa有三种：</p> 
<ul><li>NSGlobalBlock：存储在程序的数据区域，在 block 内部没有引用任何外部变量。</li><li>NSStackBlock：存储在栈上，在 block 内部引用外部变量。在 MRC 下，栈块在当函数退出的时候，该空间会被回收，因此如果再调用该 block 会导致 crash，通过拷贝该栈块，可以解决该问题。在 ARC 模式下，生成的 block 也是 栈块，只是当赋值给 strong 对象时，系统会主动对其进行 copy。</li><li>NSMallocBlock：存储在堆上的 block。<br> 我们都知道栈区的内存是系统自动管理的，所以出现NSStackBlock时我们可以不用考虑内存问题，但是出现NSMallocBlock时一定要注意了，很容易出现内存泄漏。</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/38bc91bd7255713f58401ee91184c2e2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Oracle之ORA-01940：无法删除当前已连接用户的解决方案</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/571f1b692a91da645194a2886834f503/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Oracle之CMD导入DMP文件报错提示“IMP-00003: 遇到 ORACLE 错误 1917”</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>