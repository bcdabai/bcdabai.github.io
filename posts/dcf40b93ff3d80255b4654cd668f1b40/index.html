<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>hadoop 三次排序 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="hadoop 三次排序" />
<meta property="og:description" content="数据
10.0.0.1,192.168.0.1,1000010.0.0.1,192.168.0.1,1000110.0.0.1,192.168.0.1,1000210.0.0.1,192.168.0.2,1000010.0.0.1,192.168.0.2,1000110.0.0.1,192.168.0.3,0999910.0.0.1,192.168.0.3,1000010.0.0.2,192.168.0.1,1000110.0.0.2,192.168.0.1,1000210.0.0.2,192.168.0.2,1000010.0.0.2,192.168.0.2,1000310.0.0.3,192.168.0.1,1000010.0.0.3,192.168.0.1,1000110.0.0.3,192.168.0.1,1000110.0.0.3,192.168.0.1,1000210.0.0.3,192.168.0.1,1000410.0.0.3,192.168.0.3,1000510.0.0.3,192.168.0.3,1000610.0.0.3,192.168.0.3,1000710.0.0.3,192.168.0.3,10008 打乱顺序
10.0.0.3,192.168.0.3,1000510.0.0.1,192.168.0.1,1000010.0.0.3,192.168.0.1,1000110.0.0.2,192.168.0.2,1000010.0.0.3,192.168.0.1,1000410.0.0.3,192.168.0.1,1000210.0.0.2,192.168.0.1,1000110.0.0.1,192.168.0.1,1000210.0.0.3,192.168.0.1,1000010.0.0.3,192.168.0.3,1000610.0.0.1,192.168.0.3,0999910.0.0.3,192.168.0.3,1000810.0.0.1,192.168.0.3,1000010.0.0.1,192.168.0.1,1000110.0.0.3,192.168.0.3,1000710.0.0.1,192.168.0.2,1000010.0.0.2,192.168.0.1,1000210.0.0.1,192.168.0.2,1000110.0.0.3,192.168.0.1,1000110.0.0.2,192.168.0.2,10003 自定义结构
import java.io.DataInput;import java.io.DataOutput;import java.io.IOException;import org.apache.hadoop.io.Text;import org.apache.hadoop.io.WritableComparable;import org.apache.hadoop.io.WritableComparator;public class TriTuple implements WritableComparable&lt;TriTuple&gt;{private Text serverIP;private Text clientIP;private Text time;public TriTuple(){serverIP = new Text();clientIP = new Text();time = new Text();}public Text getServerIP(){return serverIP;}public void setServerIP(Text serverIP){this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/dcf40b93ff3d80255b4654cd668f1b40/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-09-25T16:27:47+08:00" />
<meta property="article:modified_time" content="2013-09-25T16:27:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">hadoop 三次排序</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>数据</p> 
<pre><code class="language-html">10.0.0.1,192.168.0.1,10000
10.0.0.1,192.168.0.1,10001
10.0.0.1,192.168.0.1,10002
10.0.0.1,192.168.0.2,10000
10.0.0.1,192.168.0.2,10001
10.0.0.1,192.168.0.3,09999
10.0.0.1,192.168.0.3,10000
10.0.0.2,192.168.0.1,10001
10.0.0.2,192.168.0.1,10002
10.0.0.2,192.168.0.2,10000
10.0.0.2,192.168.0.2,10003
10.0.0.3,192.168.0.1,10000
10.0.0.3,192.168.0.1,10001
10.0.0.3,192.168.0.1,10001
10.0.0.3,192.168.0.1,10002
10.0.0.3,192.168.0.1,10004
10.0.0.3,192.168.0.3,10005
10.0.0.3,192.168.0.3,10006
10.0.0.3,192.168.0.3,10007
10.0.0.3,192.168.0.3,10008</code></pre> 
<p><br> 打乱顺序</p> 
<pre><code class="language-html">10.0.0.3,192.168.0.3,10005
10.0.0.1,192.168.0.1,10000
10.0.0.3,192.168.0.1,10001
10.0.0.2,192.168.0.2,10000
10.0.0.3,192.168.0.1,10004
10.0.0.3,192.168.0.1,10002
10.0.0.2,192.168.0.1,10001
10.0.0.1,192.168.0.1,10002
10.0.0.3,192.168.0.1,10000
10.0.0.3,192.168.0.3,10006
10.0.0.1,192.168.0.3,09999
10.0.0.3,192.168.0.3,10008
10.0.0.1,192.168.0.3,10000
10.0.0.1,192.168.0.1,10001
10.0.0.3,192.168.0.3,10007
10.0.0.1,192.168.0.2,10000
10.0.0.2,192.168.0.1,10002
10.0.0.1,192.168.0.2,10001
10.0.0.3,192.168.0.1,10001
10.0.0.2,192.168.0.2,10003</code></pre> 
<p><br> 自定义结构</p> 
<pre><code class="language-java">import java.io.DataInput;
import java.io.DataOutput;
import java.io.IOException;

import org.apache.hadoop.io.Text;
import org.apache.hadoop.io.WritableComparable;
import org.apache.hadoop.io.WritableComparator;

public class TriTuple implements WritableComparable&lt;TriTuple&gt;
{
	private Text serverIP;
	private Text clientIP;
	private Text time;

	public TriTuple()
	{
		serverIP = new Text();
		clientIP = new Text();
		time = new Text();
	}

	public Text getServerIP()
	{
		return serverIP;
	}

	public void setServerIP(Text serverIP)
	{
		this.serverIP = serverIP;
	}

	public Text getClientIP()
	{
		return clientIP;
	}

	public void setClientIP(Text clientIP)
	{
		this.clientIP = clientIP;
	}

	public Text getTime()
	{
		return time;
	}

	public void setTime(Text time)
	{
		this.time = time;
	}

	public void readFields(DataInput in) throws IOException
	{
		serverIP.readFields(in);
		clientIP.readFields(in);
		time.readFields(in);
	}

	public void write(DataOutput out) throws IOException
	{
		serverIP.write(out);
		clientIP.write(out);
		time.write(out);
	}

	public int compareTo(TriTuple tt)
	{
		int cmp;
		if(0 != (cmp = serverIP.compareTo(tt.serverIP)))
		{
			return cmp;
		}
		else
		{
			if(0 != (cmp = clientIP.compareTo(tt.clientIP)))
			{
				return cmp;
			}
			else
			{
				return time.compareTo(tt.time);
			}
		}
	}

	public int hashCode()
	{
		return serverIP.hashCode() * 31;
	}

	public boolean equals(Object o)
	{
		if(o instanceof TriTuple)
		{
			TriTuple tt = (TriTuple) o;
			return serverIP.equals(tt.serverIP) &amp;&amp; clientIP.equals(tt.clientIP)
					&amp;&amp; time.equals(tt.time);
		}
		return false;
	}

	public String toString()
	{
		return serverIP + "," + clientIP + "," + time;
	}

	public static class FirstComparator extends WritableComparator
	{
		protected FirstComparator()
		{
			super(TriTuple.class, true);
		}

		public int compare(WritableComparable w1, WritableComparable w2)
		{
			int cmp1 = ((TriTuple) w1).getServerIP().compareTo(((TriTuple) w2).getServerIP());
			int cmp2 = ((TriTuple) w1).getClientIP().compareTo(((TriTuple) w2).getClientIP());
			if(0 == cmp1 &amp;&amp; 0 == cmp2)
			{
				return 0;
			}
			else
			{
				if(0 != cmp1)
				{
					return cmp1;
				}
				else
				{
					return cmp2;
				}
			}
		}
	}
}
</code></pre> 
<p><br> mapreduce + driver</p> 
<pre><code class="language-java">import java.io.IOException;

import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.Path;
import org.apache.hadoop.io.LongWritable;
import org.apache.hadoop.io.NullWritable;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Job;
import org.apache.hadoop.mapreduce.Mapper;
import org.apache.hadoop.mapreduce.Reducer;
import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;
import org.apache.hadoop.mapreduce.lib.input.TextInputFormat;
import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;
import org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;

public class MyJob
{
	public static class MapClass extends Mapper&lt;LongWritable, Text, TriTuple, NullWritable&gt;
	{
		TriTuple outKey = new TriTuple();
		
		public void map(LongWritable key, Text value, Context context) throws IOException, InterruptedException
		{
			String inValue = value.toString();
			String[] field = inValue.split(",");
			if(3 == field.length)
			{
				outKey.setClientIP(new Text(field[0]));
				outKey.setServerIP(new Text(field[1]));
				outKey.setTime(new Text(field[2]));
				
				context.write(outKey, NullWritable.get());
			}
		}
	}

	public static class Reduce extends Reducer&lt;TriTuple, NullWritable, Text, NullWritable&gt;
	{
		Text outKey = new Text();
		int counter = 0;
		public void reduce(TriTuple key, Iterable&lt;NullWritable&gt; values,	Context context) throws IOException, InterruptedException
		{
			counter = 0;
			for(NullWritable value : values)
			{
				++counter;
				outKey.set(key.toString() + ", " + counter);
				context.write(outKey, NullWritable.get());
			}
		}
	}

	public static void main(String[] args) throws Exception
	{
		Configuration conf = new Configuration();
		Job job = new Job(conf, "MyJob");

		job.setNumReduceTasks(10);
		job.setJarByClass(MyJob.class);
		
		job.setMapperClass(MapClass.class);
		job.setReducerClass(Reduce.class);	
		job.setGroupingComparatorClass(TriTuple.FirstComparator.class);
		//job.setPartitionerClass(PhNumPartitioner.class);
		
		job.setMapOutputKeyClass(TriTuple.class);
		job.setMapOutputValueClass(NullWritable.class);
		job.setOutputKeyClass(Text.class);
		job.setOutputValueClass(NullWritable.class);
		
		job.setInputFormatClass(TextInputFormat.class);
		job.setOutputFormatClass(TextOutputFormat.class);
		
		FileInputFormat.addInputPath(job, new Path(args[0]));
		FileOutputFormat.setOutputPath(job, new Path(args[1]));
		
		System.exit(job.waitForCompletion(true) ? 0 : 1);
	}
}
</code></pre> 
<p><br> 结果</p> 
<pre><code class="language-html">192.168.0.1,10.0.0.1,10000, 1
192.168.0.1,10.0.0.1,10001, 2
192.168.0.1,10.0.0.1,10002, 3
192.168.0.1,10.0.0.2,10001, 1
192.168.0.1,10.0.0.2,10002, 2
192.168.0.1,10.0.0.3,10000, 1
192.168.0.1,10.0.0.3,10001, 2
192.168.0.1,10.0.0.3,10001, 3
192.168.0.1,10.0.0.3,10002, 4
192.168.0.1,10.0.0.3,10004, 5
192.168.0.2,10.0.0.1,10000, 1
192.168.0.2,10.0.0.1,10001, 2
192.168.0.2,10.0.0.2,10000, 1
192.168.0.2,10.0.0.2,10003, 2
192.168.0.3,10.0.0.1,09999, 1
192.168.0.3,10.0.0.1,10000, 2
192.168.0.3,10.0.0.3,10005, 1
192.168.0.3,10.0.0.3,10006, 2
192.168.0.3,10.0.0.3,10007, 3
192.168.0.3,10.0.0.3,10008, 4</code></pre> 
<p><br>  </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/98f4ae98f99b144f840c06b39c2682fe/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">java的MD5加密</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3da41aeba46bfb8b67f225c1e25b0c9e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在VS C&#43;&#43;中调试DLL工程的方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>