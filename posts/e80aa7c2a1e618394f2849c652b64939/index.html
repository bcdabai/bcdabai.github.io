<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>php wordpress漏洞,wordpress会有漏洞吗 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="php wordpress漏洞,wordpress会有漏洞吗" />
<meta property="og:description" content="根据CVE官方漏洞通报得知wordpress新出一个组合式rce漏洞，漏洞编号分别为CVE-2019-8943和CVE-2019-8942，下载漏洞版本源码，分析漏洞触发过程，注：漏洞复现时一定要断网搭建，wordpress在联网状态时会自动更新代码包。找到漏洞发生文件post.php，wordpress有多个post.php文件，这里简要说明一下各自的作用，wp-includes/post.php为post的源文件，wp-admin/includes/post.php为有后台权限的post接口，wp-admin/post.php为后台post的请求处理，具体调用代码如下：wp-admin/post.php：require_once( dirname( __FILE__ ) . &#39;/admin.php&#39; );
wp-admin/admin.php：require_once(ABSPATH . &#39;wp-admin/includes/admin.php&#39;);
wp-admin/includes/admin.php：require_once(ABSPATH . &#39;wp-admin/includes/post.php&#39;);
wp-admin/admin.php:：require_once(dirname(dirname(__FILE__)) . &#39;/wp-load.php&#39;);
wp-load.php：require_once( dirname( ABSPATH ) . &#39;/wp-config.php&#39; );
wp-config.php：require_once(ABSPATH . &#39;wp-settings.php&#39;);
wp-settings.php：require( ABSPATH . WPINC . &#39;/post.php&#39; );
define( &#39;WPINC&#39;, &#39;wp-includes&#39; );
根据以上调用流程，漏洞利用流程为上传一个图片到媒体库，然后进行更新操作，调用wp-admin/post.php函数，并根据switch到case:editpost，如下图所示：
其中edit_post为漏洞函数，进入函数声明，如下图所示：
$post_data为post数组，并未作任何过滤防护，对此产生了之后的漏洞，对比修复后的代码，如下图所示：
在此我多说两句，因一开始并未发现wordpress在联网时会进行自动更新，所以，我定位了另一个类似漏洞点，如下图所示：
以上代码会根据传入的meta数组进行update_meta，根据代码中的$key(数据库中的meta_id)，$value[‘key’](数据库中的meta_key),$value[‘value’](数据库中的meta_value)，构造meta[1][key]=_wp_attached_file&amp;meta[1][value]=123，最终执行类似以下数据库语句UPDATE `wp_postmeta` SET `meta_key` = &#39;_wp_attached_file&#39;, `meta_value` = &#39;123&#39; WHERE `meta_id` = 2，实现过程，如下图所示：
根据meta_id更新wp_postmeta表中内容，最终执行do_action函数，如下图所示 ：
但是由于第三个和第四个if的限制，导致无法执行成功，这也算是一个漏洞复现上的一个有趣的点吧，继续跟踪，如下图所示：
找到可利用的点，并根据代码所示，进入wp_updae_post函数，如下图所示：
此函数会经过一些获取参数的操作，将数组中的变量提取出来并进行赋值，跟踪到漏洞发生点，如下图所示：
发现返回wp_insert_attachment函数，跟踪此函数，如下图所示：
返回wp_insert_post函数，跟踪此函数，在此函数中定位到漏洞发生点，如下图所示：
所以根据以上漏洞点，可传入meta_input[_wp_attached_file] =../evil.jpg?shell.php，执行SQL语句为UPDATE `wp_postmeta` SET `meta_value` = &#39;../evil.jpg?shell.php &#39; WHERE `post_id` = 8 AND `meta_key` = &#39;_wp_attached_file&#39;，测试条件为前提必须知道post_id，不过正常情况下更新图片时会自带此参数，如果是测试的话，可以观察数据库填写相关内容。具体SQL语句嵌套执行方法，如下图所示：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/e80aa7c2a1e618394f2849c652b64939/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-25T21:40:05+08:00" />
<meta property="article:modified_time" content="2021-03-25T21:40:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">php wordpress漏洞,wordpress会有漏洞吗</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p align="center"><img src="https://images2.imgbox.com/9c/b2/kO9FKBKx_o.png" alt="c09183412c8f63086eb7860b5af1cdff.png"></p> 
 <p>根据CVE官方漏洞通报得知wordpress新出一个组合式rce漏洞，漏洞编号分别为CVE-2019-8943和CVE-2019-8942，下载漏洞版本源码，分析漏洞触发过程，注：漏洞复现时一定要断网搭建，wordpress在联网状态时会自动更新代码包。找到漏洞发生文件post.php，wordpress有多个post.php文件，这里简要说明一下各自的作用，wp-includes/post.php为post的源文件，wp-admin/includes/post.php为有后台权限的post接口，wp-admin/post.php为后台post的请求处理，具体调用代码如下：wp-admin/post.php：require_once( dirname( __FILE__ ) . '/admin.php' );</p> 
 <p>wp-admin/admin.php：require_once(ABSPATH . 'wp-admin/includes/admin.php');</p> 
 <p>wp-admin/includes/admin.php：require_once(ABSPATH . 'wp-admin/includes/post.php');</p> 
 <p>wp-admin/admin.php:：require_once(dirname(dirname(__FILE__)) . '/wp-load.php');</p> 
 <p>wp-load.php：require_once( dirname( ABSPATH ) . '/wp-config.php' );</p> 
 <p>wp-config.php：require_once(ABSPATH . 'wp-settings.php');</p> 
 <p>wp-settings.php：require( ABSPATH . WPINC . '/post.php' );</p> 
 <p>define( 'WPINC', 'wp-includes' );</p> 
 <p>根据以上调用流程，漏洞利用流程为上传一个图片到媒体库，然后进行更新操作，调用wp-admin/post.php函数，并根据switch到case:editpost，如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/78/d8/GrDExNOK_o.png" alt="f4f47fab6669bd6b5555f3b0034357ab.png"></p> 
 <p>其中edit_post为漏洞函数，进入函数声明，如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/e7/71/LYlD46MP_o.png" alt="49127ca244a35ecb2d9b10f0f2f5449c.png"></p> 
 <p>$post_data为post数组，并未作任何过滤防护，对此产生了之后的漏洞，对比修复后的代码，如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/44/86/Rx1OhmPe_o.png" alt="efee4223e39ff92161647e21bcfa8adf.png"></p> 
 <p>在此我多说两句，因一开始并未发现wordpress在联网时会进行自动更新，所以，我定位了另一个类似漏洞点，如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/d5/82/v6u0ja0e_o.png" alt="9a11b01022523c8501b351f3c257d67e.png"></p> 
 <p>以上代码会根据传入的meta数组进行update_meta，根据代码中的$key(数据库中的meta_id)，$value[‘key’](数据库中的meta_key),$value[‘value’](数据库中的meta_value)，构造meta[1][key]=_wp_attached_file&amp;meta[1][value]=123，最终执行类似以下数据库语句UPDATE `wp_postmeta` SET `meta_key` = '_wp_attached_file', `meta_value` = '123' WHERE `meta_id` = 2，实现过程，如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/87/66/4n7M69q7_o.png" alt="a38becff88a8c6a67ea060d0606a54c8.png"></p> 
 <p>根据meta_id更新wp_postmeta表中内容，最终执行do_action函数，如下图所示 ：</p> 
 <p align="center"><img src="https://images2.imgbox.com/f7/e7/gBusYYpb_o.png" alt="44de274754f77d3c5681fb6cdd5a07d5.png"></p> 
 <p>但是由于第三个和第四个if的限制，导致无法执行成功，这也算是一个漏洞复现上的一个有趣的点吧，继续跟踪，如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/e2/06/R7RM1qsn_o.png" alt="d108df33cc568bbfe255a7c71d3c8edd.png"></p> 
 <p>找到可利用的点，并根据代码所示，进入wp_updae_post函数，如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/f0/66/3dTgIaSV_o.png" alt="8b2c8413196124ff141fb2ae1c4cb11d.png"></p> 
 <p>此函数会经过一些获取参数的操作，将数组中的变量提取出来并进行赋值，跟踪到漏洞发生点，如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/11/21/eGDnoASx_o.png" alt="a46429dc7ca8fce54e28af498d537df3.png"></p> 
 <p>发现返回wp_insert_attachment函数，跟踪此函数，如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/8f/91/N0jcChXO_o.png" alt="dee00de9b8577839095f4cd2f446d57f.png"></p> 
 <p>返回wp_insert_post函数，跟踪此函数，在此函数中定位到漏洞发生点，如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/e8/98/zcfULagA_o.png" alt="55fbd14240ce4f1cec5605e6599514f6.png"></p> 
 <p>所以根据以上漏洞点，可传入meta_input[_wp_attached_file] =../evil.jpg?shell.php，执行SQL语句为UPDATE `wp_postmeta` SET `meta_value` = '../evil.jpg?shell.php ' WHERE `post_id` = 8 AND `meta_key` = '_wp_attached_file'，测试条件为前提必须知道post_id，不过正常情况下更新图片时会自带此参数，如果是测试的话，可以观察数据库填写相关内容。具体SQL语句嵌套执行方法，如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/7f/9a/jsgqikML_o.png" alt="f785f2b1c30a90952e230fe626c3e56e.png"></p> 
 <p>通过传入参数，赋值到相对应的表名和列名，最终执行do_action函数，如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/27/8a/z9tX0mDd_o.png" alt="05da4d9c5b9d62c8a188225a37aa140b.png"></p> 
 <p>在此完成wordpress目录遍历漏洞，并在之后利用本地文件包含漏洞执行rce，wordpress官方使用图像库为GD和Imagick，如下图所示：</p> 
 <p align="center"><img src="https://images2.imgbox.com/84/90/z1UePN9i_o.png" alt="83fc248e5bea1f341924a7875fda6b01.png"></p> 
 <p>其中Imagick并不是wordpress自带，需要下载插件，所以默认可以使用绕过GD库的方法执行任意代码。</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2ad1f48a4da47d748703c25ada17a9c6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue 导航守卫 判断用户是否登录</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3e96b08b44e4e84304859c0144a224f1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">matlab绘制子图怎么,MATLAB画图之多子图画法（subplot和自己确定大小位置两种方法）...</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>