<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Android Framework系列】第2章 Binder机制大全 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Android Framework系列】第2章 Binder机制大全" />
<meta property="og:description" content="1 Binder简介 1.1 什么是Binder Binder是Android中主要的跨进程通信方式。Android系统中，每个应用程序是由Android的Activity，Service，BroadCast，ContentProvider这四剑客中一个或多个组合而成，这四剑客所涉及的多进程间的通信底层都是依赖于BinderIPC机制。例如当进程A中的Activity要向进程B中的Service通信，这便需要依赖于BinderIPC。不仅于此，整个Android系统架构中，大量采用了Binder机制作为IPC（进程间通信）方案，当然也存在部分其他的IPC方式，比如Zygote通信便是采用socket。
Binder驱动和ServiceManager分别相当于网络协议中的路由器和DNS，并基于mmap实现了IPC传输数据时只需一次拷贝。Binder包括BinderProxy、BpBinder、BBinder等各种Binder实体，以及对Binder驱动操作的ProcessState、IPCThreadState封装，再加上Binder驱动内部的结构体、命令处理，整体贯穿Java、Native层，涉及用户态、内核态，往上可以说到Service、AIDL等，往下可以说到mmap、Binder驱动设备，是相当庞大、繁琐的一个机制。
1.2 为什么要使用Binder 为什么要用Binder？？？这个问题问得好。我们知道Binder是一种Android独有的跨进程通讯方式，而Android系统底层是Linux，所以Linux的跨进程通讯方式在Android里也是可以使用的。那还有其他方式可以实现Linux的跨进程通讯吗？
传统Linux进程间通信方式：管道、信号量、socket、共享内存，而Binder是android系统独有的通讯方式。
Binder：只需要拷贝一次，基于C/S架构，易用性高，系统为每个APP分配UID同时支持实名和匿名更安全共享内存：无需拷贝，控制复杂，易用性差，依赖上层协议，访问接入点是开放的不安全Socket：需要拷贝两次，基于C/S架构，作为一款通用接口，其传输效率低，开销大，以来上层协议，访问接入点是开放的，不安全管道：需要拷贝两次，非C/S架构，是一对一的通讯模型，把一个程序的输出直接链接另一个程序的输入。Linux下的管道主要分两种：无名管道(pipe)和有名管道(fifo)。无名管道只能用于具有亲缘关系的进程之间的通信(也就是父子进程或兄弟进程之间)，是以半双工的一个通信方式，速度较慢，容量有限；有名管道是对无名管道的一种改进，可以让两个互补相干的进程之间进行通信。并且该管道在文件系统中可见，不过大小一直为0。信号量：与其他的进程间通信方式不太相同，它主要提供对进程间共享资源的访问机制，进程会根据它判定是否能够访问某些共享资源，同时进程也可以修改该标志。除了用于访问控制外，还可以用于进程同步，主要是用来解决进程线程之间同步与互斥问题的一种通信机制。 Android系统需要一种高效率、安全性高的方式，因此Binder最合适不过。Binder只需要拷贝一次，效率仅次于共享内存，而且采用传统的C/S结构
2 Binder 实现机制 2.1 内存概念 首先需要明确Linux系统关于内存的几个概念：虚拟内存，用户空间，内核空间、MMap
2.1.1 虚拟内存 虚拟内存简单来说，是一种内存管理技术，是虚拟的、逻辑上存在的存储空间；将物理上（不连续的物理）的内存（碎片）形成一个逻辑上连续完整的地址空间。虚拟内存初始化的过程，就叫做内存映射。我们的用户程序操作的内存实际上都是通过虚拟内存操作真正的物理内存。
简单理解：虚拟地址指向虚拟内存，虚拟内存指向对应的物理内存，物理内存会根据程序局部性原则，加载磁盘中的活跃程序到物理内存中。MMU将物理内存的地址转换为虚拟地址提供给外部（CPU）使用。虚拟内存与物理内存的映射以页为单位，常见的页大小为4KB
虚拟内存中有效位和磁盘地址可组成三种状态：
未分配（有效位0，磁盘地址null），磁盘上还不存在未缓存（有效位0，磁盘地址有值），磁盘上存在，但内存中不存在已缓存（有效位1，磁盘地址有值），磁盘、内存都存在 2.1.1.1 MMU MMU是Memory Management Unit的缩写，中文名是内存管理单元，有时称作分页内存管理单元（英语：paged memory management unit，缩写为PMMU）。它是一种负责处理中央处理器（CPU）的内存访问请求的计算机硬件。它的功能包括虚拟地址到物理地址的转换（即虚拟内存管理）、内存保护、中央处理器高速缓存的控制，在较为简单的计算机体系结构中，负责总线的仲裁以及存储体切换（bank switching，尤其是在8位的系统上）。
如上图所示，MMU实际上是CPU和物理内存/磁盘之间的桥梁，主要职责是将物理地址转换为虚拟地址提供给CPU使用。物理内存和磁盘之间存在频繁的读写操作，因为根据程序局部性原则
2.1.2 用户空间、内核空间 虚拟内存被操作系统划分成两块：用户空间和内核空间，用户空间是用户程序代码运行的地方，内核空间是内核代码运行的地方。为了安全，他们是隔离的，即使用户的程序崩溃了，内核也不受影响。
32位系统，即2^32，即总共可以访问地址为4G，内核空间为1G，用户空间为3G；
64位操作系统，低位2-47位是有效的可变地址，高位48-63位全补0对应用户空间，全补1是内核空间
2.1.3 MMap（Memory Mapping）内存映射 Linux通过将虚拟内存区域与磁盘上的空间关联起来，以初始化这个虚拟内存区域的内容，这个过程成为内存映射。具体一点来说，把一个文件或者其他对象映射到进程的地址空间，实现文件磁盘地址和进程虚拟地址空间的映射关系。实现这种映射关系之后，进程就可以采用指针的方式读写操作这一段内存，而系统会自动回写到对应的磁盘文件。
用户空间（虚拟内存）和磁盘文件（物理内存）存在映射关系，这样在虚拟内存中操作文件，就会自动回写到磁盘文件中。
2.2 Binder原理 Binder通信采用C/S架构，从组件视角来说，包含Client、Server、ServiceManager以及Binder驱动，其中ServiceManager用于管理系统中的各种服务。架构图如下所示：
可以看出无论是注册服务和获取服务的过程都需要ServiceManager，需要注意的是此处的ServiceManager是指Native层的ServiceManager(C&#43;&#43;)，并非指framework层的ServiceManager(Java)。ServiceManager是整个Binder通信机制的大管家，是Android进程间通信机制Binder的守护进程，要掌握Binder机制，首先需要了解系统是如何首次启动ServiceManager。当ServiceManager启动之后，Client端和Server端通信时都需要先获取ServiceManager接口，才能开始通信服务。
图中Client/Server/ServiceManage之间的相互通信都是基于Binder机制。既然基于Binder机制通信，那么同样也是C/S架构，则图中的3大步骤都有相应的Client端与Server端。
注册服务(addService)：Server进程要先注册Service到ServiceManager。该过程：Server是客户端，ServiceManager是服务端。获取服务(getService)：Client进程使用某个Service前，须先向ServiceManager中获取相应的Service。该过程：Client是客户端，ServiceManager是服务端。使用服务：Client根据得到的Service信息建立与Service所在的Server进程通信的通路，然后就可以直接与Service交互。该过程：client是客户端，server是服务端。 图中的Client,Server,ServiceManager之间交互都是虚线表示，是由于它们彼此之间不是直接交互的，而是都通过与Binder驱动进行交互，从而实现IPC通信方式。其中Binder驱动位于内核空间，Client,Server,ServiceManager位于用户空间。Binder驱动和ServiceManager可以看做是Android平台的基础架构，而Client和Server是Android的应用层，开发人员只需自定义实现Client、Server端，借助Android的基本平台架构便可以直接进行IPC通信。
3 Binder整体架构 Client：调用端（客户端）进程Server：被调用端（服务端）进程​BpBinder和BinderProxy：远程Binder实体，只不过一个Native层、一个Java层，BpBinder内部持有了一个Binder句柄值handle。BBinder：Server端接收来自Client端通过IPCThreadState传递过来的信息，然后回调onTransact实现方法。ProcessState：进程单例，负责打开Binder驱动设备及mmap；IPCThreadState：线程单例，负责与Binder驱动进行具体的命令通信。
​ 通讯流程：
由Proxy发起transact()调用，会将数据打包到Parcel中，层层向下调用到BpBinder，在BpBinder中调用IPCThreadState的transact()方法并传入handle句柄值，IPCThreadState再去执行具体的Binder命令。由Binder驱动到Server的大概流程就是：Server通过IPCThreadState接收到Client的请求后，层层向上，最后回调到Stub的onTransact()方法。 Client通过ServiceManager或AMS获取到的远程Binder实体，一般会用Proxy做一层封装，比如ServiceManagerProxy、AIDL生成的Proxy类。而被封装的远程Binder实体是一个BinderProxy。
​当然这不代表所有的IPC流程，比如ServiceManager作为一个Server时，便没有上层的封装，也没有借助IPCThreadState，而是初始化后通过binder_loop()方法直接与Binder驱动通信的。
4 Binder四层结构 Binder在整个Android系统中有这举足轻重的地位，在Native层有一套完整的binder通信的C/S架构图中红色代表整个framework层binder架构相关组件，Binder类代表Server端，BinderProxy类代码Client端；图中的蓝色代表Native层，BpBinder作为客户端，BBinder作为服务端。基于naive层的Binder框架，Java也有一套镜像功能的binder C/S架构，通过JNI技术与native层的binder对应，Java层的binder功能最终都是交给native的binder来完成。从kernel到native，jni，framework层的架构所涉及的所有有关类和方法见Binder类图。
上图为整个 Binder 从 kernel 至，native，JNI，Framework 层所涉及的全部类" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4525912753728030c6f04b206753b073/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-27T14:14:56+08:00" />
<meta property="article:modified_time" content="2023-06-27T14:14:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Android Framework系列】第2章 Binder机制大全</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_Binder_0"></a>1 Binder简介</h2> 
<h3><a id="11_Binder_1"></a>1.1 什么是Binder</h3> 
<p>  <strong><code>Binder是Android中主要的跨进程通信方式</code></strong>。Android系统中，每个应用程序是由Android的Activity，Service，BroadCast，ContentProvider这四剑客中一个或多个组合而成，这四剑客所涉及的多进程间的通信底层都是依赖于BinderIPC机制。例如当进程A中的Activity要向进程B中的Service通信，这便需要依赖于BinderIPC。不仅于此，<strong>整个Android系统架构中，大量采用了Binder机制作为IPC（进程间通信）方案</strong>，当然也存在部分其他的IPC方式，比如Zygote通信便是采用socket。<br>   Binder驱动和ServiceManager分别相当于网络协议中的路由器和DNS，并基于<code>mmap</code>实现了IPC传输数据时只需一次拷贝。<strong>Binder包括<code>BinderProxy</code>、<code>BpBinder</code>、<code>BBinder</code>等各种Binder实体，以及对Binder驱动操作的<code>ProcessState</code>、<code>IPCThreadState</code>封装，再加上Binder驱动内部的结构体、命令处理，整体贯穿Java、Native层，涉及用户态、内核态，往上可以说到Service、AIDL等，往下可以说到mmap、Binder驱动设备，是相当庞大、繁琐的一个机制。</strong></p> 
<h3><a id="12_Binder_4"></a>1.2 为什么要使用Binder</h3> 
<p>  为什么要用Binder？？？这个问题问得好。我们知道Binder是一种Android独有的跨进程通讯方式，而Android系统底层是Linux，所以Linux的跨进程通讯方式在Android里也是可以使用的。那还有其他方式可以实现Linux的跨进程通讯吗？<br>   传统<strong>Linux进程间通信</strong>方式：<strong>管道、信号量、socket、共享内存</strong>，而<code>Binder是android系统独有的通讯方式</code>。</p> 
<blockquote> 
 <ol><li><strong>Binder</strong>：只需要<strong>拷贝一次</strong>，基于<strong>C/S架构</strong>，易用性高，系统为每个APP分配UID同时支持实名和匿名更<strong>安全</strong></li><li><strong>共享内存</strong>：<strong>无需拷贝</strong>，控制复杂，易用性差，依赖上层协议，访问接入点是开放的<strong>不安全</strong></li><li><strong>Socket</strong>：需要<strong>拷贝两次</strong>，基于<strong>C/S架构</strong>，作为一款通用接口，其<strong>传输效率低</strong>，开销大，以来上层协议，访问接入点是开放的，<strong>不安全</strong></li><li><strong>管道</strong>：需要<strong>拷贝两次</strong>，<strong>非C/S架构</strong>，是一对一的通讯模型，把一个程序的输出直接链接另一个程序的输入。Linux下的管道主要分两种：无名管道(pipe)和有名管道(fifo)。无名管道只能用于具有亲缘关系的进程之间的通信(也就是父子进程或兄弟进程之间)，是以半双工的一个通信方式，速度较慢，容量有限；有名管道是对无名管道的一种改进，可以让两个互补相干的进程之间进行通信。并且该管道在文件系统中可见，不过大小一直为0。</li><li><strong>信号量</strong>：与其他的进程间通信方式不太相同，它主要<strong>提供对进程间共享资源的访问机制</strong>，进程会根据它判定是否能够访问某些共享资源，同时进程也可以修改该标志。除了用于访问控制外，还可以用于进程同步，主要是用来解决进程线程之间同步与互斥问题的一种通信机制。</li></ol> 
</blockquote> 
<p>Android系统需要一种<strong>高效率、安全性高</strong>的方式，因此Binder最合适不过。<strong>Binder只需要拷贝一次，效率仅次于共享内存，而且采用传统的C/S结构</strong><br> <img src="https://images2.imgbox.com/4c/2f/1GwxqcGk_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2_Binder__15"></a>2 Binder 实现机制</h2> 
<h3><a id="21__16"></a>2.1 内存概念</h3> 
<p>首先需要明确Linux系统关于内存的几个概念：<code>虚拟内存</code>，<code>用户空间</code>，<code>内核空间</code>、<code>MMap</code></p> 
<h4><a id="211__18"></a>2.1.1 虚拟内存</h4> 
<p>虚拟内存简单来说，是一种内存管理技术，是虚拟的、逻辑上存在的存储空间；将物理上（不连续的物理）的内存（碎片）形成一个逻辑上连续完整的地址空间。<strong>虚拟内存初始化的过程，就叫做内存映射</strong>。我们的用户程序操作的内存实际上都是通过虚拟内存操作真正的物理内存。<br> <img src="https://images2.imgbox.com/99/c3/6Uq4Q7Dr_o.png" alt="在这里插入图片描述">简单理解：虚拟地址指向虚拟内存，虚拟内存指向对应的物理内存，物理内存会根据<strong>程序局部性原则</strong>，加载磁盘中的活跃程序到物理内存中。MMU将物理内存的地址转换为虚拟地址提供给外部（CPU）使用。虚拟内存与物理内存的映射以页为单位，常见的<strong>页大小为4KB</strong><br> 虚拟内存中有效位和磁盘地址可组成三种状态：</p> 
<blockquote> 
 <ol><li>未分配（有效位0，磁盘地址null），磁盘上还不存在</li><li>未缓存（有效位0，磁盘地址有值），磁盘上存在，但内存中不存在</li><li>已缓存（有效位1，磁盘地址有值），磁盘、内存都存在</li></ol> 
</blockquote> 
<h5><a id="2111_MMU_26"></a>2.1.1.1 MMU</h5> 
<p><strong><code>MMU是Memory Management Unit</code><strong>的缩写，中文名是</strong>内存管理单元</strong>，有时称作分页内存管理单元（英语：paged memory management unit，缩写为PMMU）。它是一种<strong>负责处理中央处理器（CPU）的内存访问请求的计算机硬件</strong>。它的功能包括虚拟地址到物理地址的转换（即虚拟内存管理）、内存保护、中央处理器高速缓存的控制，在较为简单的计算机体系结构中，负责总线的仲裁以及存储体切换（bank switching，尤其是在8位的系统上）。<br> <img src="https://images2.imgbox.com/cb/65/q3Gx0Ie3_o.png" alt="在这里插入图片描述"><br> 如上图所示，MMU实际上是<strong>CPU</strong>和<strong>物理内存/磁盘</strong>之间的桥梁，主要职责是将物理地址转换为虚拟地址提供给CPU使用。物理内存和磁盘之间存在频繁的读写操作，因为根据程序局部性原则</p> 
<h4><a id="212__30"></a>2.1.2 用户空间、内核空间</h4> 
<p>虚拟内存被操作系统划分成两块：<strong>用户空间和内核空间，用户空间是用户程序代码运行的地方，内核空间是内核代码运行的地方。为了安全，他们是隔离的，即使用户的程序崩溃了，内核也不受影响。</strong><br> 32位系统，即2^32，即总共可以访问地址为4G，内核空间为1G，用户空间为3G；<br> 64位操作系统，低位2-47位是有效的可变地址，高位48-63位全补0对应用户空间，全补1是内核空间</p> 
<h4><a id="213_MMapMemory_Mapping_34"></a>2.1.3 MMap（Memory Mapping）内存映射</h4> 
<p><strong>Linux通过将虚拟内存区域与磁盘上的空间关联起来，以初始化这个虚拟内存区域的内容，这个过程成为内存映射</strong>。具体一点来说，把一个文件或者其他对象映射到进程的地址空间，实现文件磁盘地址和进程虚拟地址空间的映射关系。实现这种映射关系之后，进程就可以采用指针的方式读写操作这一段内存，而系统会自动回写到对应的磁盘文件。</p> 
<p><strong>用户空间（虚拟内存）和磁盘文件（物理内存）存在映射关系，这样在虚拟内存中操作文件，就会自动回写到磁盘文件中。</strong></p> 
<h3><a id="22_Binder_39"></a>2.2 Binder原理</h3> 
<p><code>Binder通信采用C/S架构</code>，从组件视角来说，包含<code>Client</code>、<code>Server</code>、<code>ServiceManager</code>以及<code>Binder驱动</code>，其中ServiceManager用于管理系统中的各种服务。架构图如下所示：<br> <img src="https://images2.imgbox.com/14/13/FLYdnoM4_o.png" alt="在这里插入图片描述"><br> 可以看出无论是<strong>注册服务</strong>和<strong>获取服务</strong>的过程都需要<code>ServiceManager</code>，需要注意的是此处的ServiceManager是指Native层的<code>ServiceManager(C++)</code>，并非指framework层的<code>ServiceManager(Java)</code>。ServiceManager是整个Binder通信机制的大管家，是Android进程间通信机制Binder的守护进程，要掌握Binder机制，首先需要了解系统是如何首次启动ServiceManager。<strong>当ServiceManager启动之后，<code>Client端</code>和<code>Server端</code>通信时都需要先获取<code>ServiceManager接口</code>，才能开始通信服务。</strong><br> 图中<code>Client/Server/ServiceManage</code>之间的相互通信都是基于Binder机制。既然基于Binder机制通信，那么同样也是<strong>C/S架构</strong>，则图中的3大步骤都有相应的Client端与Server端。</p> 
<ol><li><code>注册服务(addService)</code>：Server进程要先注册Service到ServiceManager。该过程：Server是客户端，ServiceManager是服务端。</li><li><code>获取服务(getService)</code>：Client进程使用某个Service前，须先向ServiceManager中获取相应的Service。该过程：Client是客户端，ServiceManager是服务端。</li><li><code>使用服务</code>：Client根据得到的Service信息建立与Service所在的Server进程通信的通路，然后就可以直接与Service交互。该过程：client是客户端，server是服务端。</li></ol> 
<p>图中的Client,Server,ServiceManager之间交互都是虚线表示，是由于它们彼此之间不是直接交互的，而是都<strong>通过与Binder驱动进行交互，从而实现IPC通信方式</strong>。其中Binder驱动位于内核空间，Client,Server,ServiceManager位于用户空间。<strong><code>Binder驱动和ServiceManager可以看做是Android平台的基础架构</code>，而<code>Client和Server是Android的应用层</code>，开发人员只需自定义实现Client、Server端，借助Android的基本平台架构便可以直接进行IPC通信。</strong></p> 
<h2><a id="3_Binder_50"></a>3 Binder整体架构</h2> 
<p><img src="https://images2.imgbox.com/a3/0a/G2ru1pgK_o.png" alt="在这里插入图片描述"></p> 
<ol><li><code>Client</code>：调用端（客户端）进程</li><li><code>Server</code>：被调用端（服务端）进程​</li><li><code>BpBinder和BinderProxy</code>：远程Binder实体，只不过一个Native层、一个Java层，BpBinder内部持有了一个Binder句柄值handle。</li><li><code>BBinder</code>：Server端接收来自Client端通过IPCThreadState传递过来的信息，然后回调onTransact实现方法。</li><li><code>ProcessState</code>：进程单例，负责打开Binder驱动设备及mmap；</li><li><code>IPCThreadState</code>：线程单例，负责与Binder驱动进行具体的命令通信。<br> ​</li></ol> 
<blockquote> 
 <p><strong>通讯流程</strong>：</p> 
 <ol><li>由<code>Proxy</code>发起<code>transact()</code>调用，会将数据打包到Parcel中，层层向下调用到<code>BpBinder</code>，在<code>BpBinder</code>中调用<code>IPCThreadState的transact()方法</code>并传入<code>handle</code>句柄值，<code>IPCThreadState</code>再去执行具体的<code>Binder</code>命令。</li><li>由<code>Binder驱动</code>到<code>Server</code>的大概流程就是：<code>Server</code>通过<code>IPCThreadState</code>接收到<code>Client</code>的请求后，层层向上，最后回调到<code>Stub的onTransact()方法</code>。</li></ol> 
</blockquote> 
<p><code>Client</code>通过<code>ServiceManager</code>或<code>AMS</code>获取到的远程<code>Binder</code>实体，一般会用<code>Proxy</code>做一层封装，比如<code>ServiceManagerProxy</code>、<code>AIDL</code>生成的<code>Proxy</code>类。而被封装的远程<code>Binder</code>实体是一个<code>BinderProxy</code>。<br> ​当然这不代表所有的IPC流程，比如ServiceManager作为一个Server时，便没有上层的封装，也没有借助IPCThreadState，而是初始化后通过<code>binder_loop()方法</code>直接与<code>Binder驱动</code>通信的。</p> 
<h2><a id="4_Binder_65"></a>4 Binder四层结构</h2> 
<p><img src="https://images2.imgbox.com/eb/da/ZPFXrmBo_o.png" alt="在这里插入图片描述"><br> Binder在整个Android系统中有这举足轻重的地位，在Native层有一套完整的binder通信的C/S架构图中红色代表整个framework层binder架构相关组件，<code>Binder类代表Server端，BinderProxy类代码Client端</code>；图中的蓝色代表Native层，<code>BpBinder作为客户端，BBinder作为服务端。</code>基于naive层的Binder框架，Java也有一套镜像功能的binder C/S架构，通过JNI技术与native层的binder对应，Java层的binder功能最终都是交给native的binder来完成。从<code>kernel</code>到<code>native</code>，<code>jni</code>，<code>framework</code>层的架构所涉及的所有有关类和方法见Binder类图。<br> <img src="https://images2.imgbox.com/d5/9b/IWlpRFKz_o.png" alt="在这里插入图片描述"><br> 上图为整个 Binder 从 kernel 至，native，JNI，Framework 层所涉及的全部类<br> <img src="https://images2.imgbox.com/ce/20/msRCfAxV_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="41_Binder_Framework_71"></a>4.1 Binder Framework层</h3> 
<p>binder在framework层，采用JNI技术来调用native(C/C++)层的binder架构，从而为上层应用程序提供服务。我们知道native层中，binder是C/S架构，分为<code>Bn端(Server)</code>和<code>Bp端(Client)</code>。对于java层在命名与架构上非常相近，同样实现了一套IPC通信架构。</p> 
<h4><a id="411_StubProxy_73"></a>4.1.1 Stub与Proxy机制</h4> 
<p>Stub为服务端，接收数据。<br> Proxy为客户端，发送数据。</p> 
<h4><a id="412_ServiceManager_Java_76"></a>4.1.2 ServiceManager Java对象如何管理服务</h4> 
<p><strong>ServiceManager是Binder机制的大管家</strong>，管理着android系统的各种Service。Service向ServiceManager注册，当Client需要调用Service时，先通过ServiceManager查询到该Service，Client接着再与Service通信。这些Service有java层也有native层的。native层通过BpServiceManager/BnServiceManager实现的Service与ServiceManager的交互。</p> 
<h4><a id="413_ClientService_78"></a>4.1.3 Client端和Service端沟通机制</h4> 
<p>同native层类似，java层，aidl脚本依据IServiceManager.aidl生成IServiceManager接口类，包含子类<code>IServiceManager.Stub</code>和<code>IServiceManager.Stub.Proxy</code>，两者都实现了IServiceManager接口，前者代表<code>server端</code>，后者代表<code>client端</code>。</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IServiceManager</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IInterface</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Stub</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>Binder</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IServiceManager</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IServiceManager</span> <span class="token function">asInterface</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IBinder</span> obj<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span>IInterface</span> iin <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">queryLocalInterface</span><span class="token punctuation">(</span>DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>iin <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> iin <span class="token keyword">instanceof</span> <span class="token class-name">IServiceManager</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">IServiceManager</span><span class="token punctuation">)</span>iin<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IServiceManager<span class="token punctuation">.</span>Stub<span class="token punctuation">.</span>Proxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">Parcel</span> data<span class="token punctuation">,</span> <span class="token class-name">Parcel</span> reply<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">String</span> descriptor <span class="token operator">=</span> DESCRIPTOR<span class="token punctuation">;</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">case</span> <span class="token class-name">TRANSACTION_getService</span><span class="token operator">:</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">String</span> _arg0<span class="token punctuation">;</span>
                        _arg0 <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        data<span class="token punctuation">.</span><span class="token function">enforceNoDataAvail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">IBinder</span> _result <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>_agr0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        reply<span class="token punctuation">.</span><span class="token function">writeNoException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        reply<span class="token punctuation">.</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token keyword">implements</span> <span class="token class-name">IServiceManager</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">private</span> <span class="token class-name">IBinder</span> mRemote<span class="token punctuation">;</span>
            <span class="token class-name">Proxy</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> remote<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                mRemote <span class="token operator">=</span> remote<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">IBinder</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Parcel</span> _data <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Parcel</span> _reply <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">IBinder</span> _result<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    _data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span>DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> _status <span class="token operator">=</span> mRemote<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span><span class="token class-name">Stub<span class="token punctuation">.</span>TRANSACTION_getService</span><span class="token punctuation">,</span> _data<span class="token punctuation">,</span> _reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _reply<span class="token punctuation">.</span><span class="token function">readException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _result <span class="token operator">=</span> _reply<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{<!-- --></span>
                    _reply<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _data<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> _result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">IBinder</span> <span class="token function">checkService</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Parcel</span> _data <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Parcel</span> _reply <span class="token operator">=</span> <span class="token class-name">Parcel</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">IBinder</span> _result<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    _data<span class="token punctuation">.</span><span class="token function">writeInterfaceToken</span><span class="token punctuation">(</span>DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _data<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> _status <span class="token operator">=</span> mRemote<span class="token punctuation">.</span><span class="token function">transact</span><span class="token punctuation">(</span><span class="token class-name">Stub<span class="token punctuation">.</span>TRANSACTION_checkService</span><span class="token punctuation">,</span> _data<span class="token punctuation">,</span> _reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _reply<span class="token punctuation">.</span><span class="token function">readException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _result <span class="token operator">=</span> _reply<span class="token punctuation">.</span><span class="token function">readStrongBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{<!-- --></span>
                    _reply<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _data<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> _result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>java层使用ServiceManager类实现servicemanager的client端，通过getIServiceManager()获取servicemanager的代理类，其中<code>BinderInternal.getContextObject()</code>通过jni创建一个BinderProxy对象。<br> 这里BinderProxy本来就是java类，为什么要通过jni创建呢？目的是创建BinderPrxoy对象的同时，也创建一个BpBinder对象，BinderProxy和BpBinder是一一对应的关系；同理，创建java层Binder对象时，也会通过jni创建一个BBinder对象。我们可以理解为<code>BinderProxy/Binder</code>封装了<code>BpBinder/BBinder</code>，实际工作的是后者。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ServiceManager</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">IServiceManager</span> sServiceManager<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">IServiceManager</span> <span class="token function">getIServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sServiceManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> sServiceManager<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sServiceManager <span class="token operator">=</span> <span class="token class-name">ServiceManagerNative</span>
                <span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span><span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">allowBlocing</span><span class="token punctuation">(</span><span class="token class-name">BinderInternal</span><span class="token punctuation">.</span><span class="token function">getContextObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sServiceManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IBinder</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">IBinder</span> service <span class="token operator">=</span> sCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> service<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">allowBlocking</span><span class="token punctuation">(</span><span class="token function">rawGetServices</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">IBinder</span> <span class="token function">rawGetService</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span>  <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">IBinder</span> binder <span class="token operator">=</span> <span class="token function">getIServiceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> binder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此时，获取到的servicemanager的代理类<code>IServiceManagerProxy(BinderProxy)</code>。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ServiceManagerNative</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">ServiceManagerNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IServiceManager</span> <span class="token function">asInterface</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> obj<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServiceManagerProxy</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">class</span> <span class="token class-name">ServiceManagerProxy</span> <span class="token keyword">implements</span> <span class="token class-name">IServiceManager</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token class-name">ServiceManagerProxy</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> remote<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            mRemote <span class="token operator">=</span> remote<span class="token punctuation">;</span>
            <span class="token comment">//servicemanager实际的代理类</span>
            mServiceManager <span class="token operator">=</span> <span class="token class-name">IServiceManager<span class="token punctuation">.</span>Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>remote<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">public</span> <span class="token class-name">IBinder</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> mServiceManager<span class="token punctuation">.</span><span class="token function">checkService</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">private</span> <span class="token class-name">IBinder</span> mRemote<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">IServiceManager</span> mServiceManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这样，我们使用<code>ServiceManager.addService()/getService()</code>等等方法时，会走到<code>BinderProxy</code>的<code>transact()-&gt;transactNative()</code></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">transact</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">Parcel</span> data<span class="token punctuation">,</span> <span class="token class-name">Parcel</span> reply<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">transactNative</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">boolean</span> <span class="token function">transactNative</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">Parcel</span> data<span class="token punctuation">,</span> <span class="token class-name">Parecl</span> reply<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
</code></pre> 
<p>最终通过jni进入native层，通过<code>BpBinder.transact()-&gt;IPCThreadState.transact()-&gt;writeTransactionData()-&gt;waitForResponse()</code>进入binder驱动层，与servicemanager进程通信，等待返回结果。</p> 
<p>注意，这里的servicemanager的服务端，使用的是native层的<code>BnServiceManager</code>，并没有使用到java层的IServiceManager.Stub</p> 
<p>servicemanager接收到请求后，执行相应的操作<code>IPCThreadState::executeCommand()-&gt;BBinder::transact()-&gt;BnServiceManager::onTransact()</code>, 具体的实现方法在ServiceManager.cpp中，这里不详细开展了。</p> 
<pre><code class="prism language-c"><span class="token operator">::</span>android<span class="token operator">::</span><span class="token class-name">status_t</span> BnServiceManager<span class="token operator">::</span><span class="token function">onTransact</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> _aidl_code<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token operator">::</span>android<span class="token operator">::</span>Parcel<span class="token operator">&amp;</span> _aidl_data<span class="token punctuation">,</span> <span class="token operator">::</span>android<span class="token operator">::</span>Parcel<span class="token operator">*</span> _aidl_reply<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> _aidl_flags<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token operator">::</span>android<span class="token operator">::</span><span class="token class-name">status_t</span> _aidl_ret_status <span class="token operator">=</span> <span class="token operator">::</span>android<span class="token operator">::</span>OK<span class="token punctuation">;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>_aidl_code<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> BnServiceManager<span class="token operator">::</span>TRANSACTION_getService<span class="token operator">:</span>
        <span class="token operator">::</span>std<span class="token operator">::</span>string in_name<span class="token punctuation">;</span>
        <span class="token operator">::</span>android<span class="token operator">::</span>sp<span class="token operator">&lt;</span><span class="token operator">::</span>android<span class="token operator">::</span>IBinder<span class="token operator">&gt;</span> _aidl_return<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        _aidl_ret_status <span class="token operator">=</span> _aidl_data<span class="token punctuation">.</span><span class="token function">readUtf8FromUtf16</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>in_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token operator">::</span>android<span class="token operator">::</span>binder<span class="token operator">::</span>Status <span class="token function">_aidl_status</span><span class="token punctuation">(</span><span class="token function">getService</span><span class="token punctuation">(</span>in_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        _aidl_ret_status <span class="token operator">=</span> _aidl_reply<span class="token operator">-&gt;</span><span class="token function">writeStrongBinder</span><span class="token punctuation">(</span>_aidl_return<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token keyword">case</span> BnServiceManager<span class="token operator">::</span>TRANSACTION_checkService<span class="token operator">:</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>数据组装完毕后，回到<code>IPCThreadState::executeCommand()</code>，执行<code>sendReply()</code></p> 
<pre><code class="prism language-c"><span class="token class-name">status_t</span> IPCThreadState<span class="token operator">::</span><span class="token function">sendReply</span><span class="token punctuation">(</span><span class="token keyword">const</span> Parcel<span class="token operator">&amp;</span> reply<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> flags<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">status_t</span> err<span class="token punctuation">;</span>
    <span class="token class-name">status_t</span> statusBuffer<span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">writeTransactionData</span><span class="token punctuation">(</span>BC_REPLY<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> reply<span class="token punctuation">,</span> <span class="token operator">&amp;</span>statusBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> NO_ERROR<span class="token punctuation">)</span> <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token function">waitForResponse</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过binder驱动，将请求的结果返回给client端，如下所示，返回的结果写入了Parcel中。</p> 
<pre><code class="prism language-c"><span class="token class-name">status_t</span> IPCThreadState<span class="token operator">::</span><span class="token function">waitForResponse</span><span class="token punctuation">(</span>Parcel <span class="token operator">*</span>reply<span class="token punctuation">,</span> <span class="token class-name">status_t</span> <span class="token operator">*</span>acquireResult<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token operator">=</span><span class="token function">talkWithDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> NO_ERROR<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        cmd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>mIn<span class="token punctuation">.</span><span class="token function">readInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> BR_REPLY<span class="token operator">:</span>
            binder_transaction_data tr<span class="token punctuation">;</span>
            err <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> TF_STATUS_CODE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    reply<span class="token operator">-&gt;</span><span class="token function">ipcSetDataReference</span><span class="token punctuation">(</span>reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> tr<span class="token punctuation">.</span>data_size<span class="token punctuation">,</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token class-name">binder_size_t</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">)</span><span class="token punctuation">,</span> tr<span class="token punctuation">.</span>offsets_size<span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">binder_size_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span> freeBuffer<span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">goto</span> finish<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  finish<span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接着进入<code>IServiceManager.Stub.Proxy</code>类的方法中，通过<code>Parcel.readStrongBinder()</code>获取到与servicemanager通信的结果。</p> 
<p><strong>总结</strong>：<strong>servicemanager在管理java层service时，目前只使用了<code>IServiceManager.Stub.Proxy</code>作为代理类，并没有使用<code>IServiceManager.Stub</code>作为服务类，服务类使用的依然是native层<code>BnServiceManager</code></strong>。</p> 
<h3><a id="42_Binder_jni_322"></a>4.2 Binder jni层</h3> 
<h4><a id="421_android_util_binder_jni__native__323"></a>4.2.1 android_util_binder jni 接口如何实现 native 方法</h4> 
<p>服务注册</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">register_android_os_Binder</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">int_register_android_os_Binder</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">int_register_android_os_BinderInternal</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">int_register_android_os_BinderProxy</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    jclass clazz <span class="token operator">=</span> <span class="token function">FindClassOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"android/util/Log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gLogOffsets<span class="token punctuation">.</span>mClass <span class="token operator">=</span> <span class="token function">MakeGlobalRefOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gLogOffsets<span class="token punctuation">.</span>mLogE <span class="token operator">=</span> <span class="token function">GetStaticMethodIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"e"</span><span class="token punctuation">,</span>
            <span class="token string">"(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    clazz <span class="token operator">=</span> <span class="token function">FindClassOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"android/os/ParcelFileDescriptor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gParcelFileDescriptorOffsets<span class="token punctuation">.</span>mClass <span class="token operator">=</span> <span class="token function">MakeGlobalRefOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gParcelFileDescriptorOffsets<span class="token punctuation">.</span>mConstructor <span class="token operator">=</span> <span class="token function">GetMethodIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"&lt;init&gt;"</span><span class="token punctuation">,</span>
                                                                 <span class="token string">"(Ljava/io/FileDescriptor;)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    clazz <span class="token operator">=</span> <span class="token function">FindClassOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"android/os/StrictMode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gStrictModeCallbackOffsets<span class="token punctuation">.</span>mClass <span class="token operator">=</span> <span class="token function">MakeGlobalRefOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gStrictModeCallbackOffsets<span class="token punctuation">.</span>mCallback <span class="token operator">=</span> <span class="token function">GetStaticMethodIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span>
            <span class="token string">"onBinderStrictModePolicyChange"</span><span class="token punctuation">,</span> <span class="token string">"(I)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">int_register_android_os_Binder</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    jclass clazz <span class="token operator">=</span> <span class="token function">FindClassOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> kBinderPathName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    gBinderOffsets<span class="token punctuation">.</span>mClass <span class="token operator">=</span> <span class="token function">MakeGlobalRefOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gBinderOffsets<span class="token punctuation">.</span>mExecTransact <span class="token operator">=</span> <span class="token function">GetMethodIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"execTransact"</span><span class="token punctuation">,</span> <span class="token string">"(IJJI)Z"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gBinderOffsets<span class="token punctuation">.</span>mObject <span class="token operator">=</span> <span class="token function">GetFieldIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"mObject"</span><span class="token punctuation">,</span> <span class="token string">"J"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">RegisterMethodsOrDie</span><span class="token punctuation">(</span>
        env<span class="token punctuation">,</span> kBinderPathName<span class="token punctuation">,</span>
        gBinderMethods<span class="token punctuation">,</span> <span class="token function">NELEM</span><span class="token punctuation">(</span>gBinderMethods<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">int_register_android_os_BinderInternal</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    jclass clazz <span class="token operator">=</span> <span class="token function">FindClassOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> kBinderInternalPathName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    gBinderInternalOffsets<span class="token punctuation">.</span>mClass <span class="token operator">=</span> <span class="token function">MakeGlobalRefOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gBinderInternalOffsets<span class="token punctuation">.</span>mForceGc <span class="token operator">=</span> <span class="token function">GetStaticMethodIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"forceBinderGc"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">RegisterMethodsOrDie</span><span class="token punctuation">(</span>
        env<span class="token punctuation">,</span> kBinderInternalPathName<span class="token punctuation">,</span>
        gBinderInternalMethods<span class="token punctuation">,</span> <span class="token function">NELEM</span><span class="token punctuation">(</span>gBinderInternalMethods<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">int_register_android_os_BinderProxy</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    jclass clazz <span class="token operator">=</span> <span class="token function">FindClassOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"java/lang/Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gErrorOffsets<span class="token punctuation">.</span>mClass <span class="token operator">=</span> <span class="token function">MakeGlobalRefOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>

    clazz <span class="token operator">=</span> <span class="token function">FindClassOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> kBinderProxyPathName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gBinderProxyOffsets<span class="token punctuation">.</span>mClass <span class="token operator">=</span> <span class="token function">MakeGlobalRefOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gBinderProxyOffsets<span class="token punctuation">.</span>mConstructor <span class="token operator">=</span> <span class="token function">GetMethodIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"&lt;init&gt;"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gBinderProxyOffsets<span class="token punctuation">.</span>mSendDeathNotice <span class="token operator">=</span> <span class="token function">GetStaticMethodIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"sendDeathNotice"</span><span class="token punctuation">,</span>
            <span class="token string">"(Landroid/os/IBinder$DeathRecipient;)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gBinderProxyOffsets<span class="token punctuation">.</span>mObject <span class="token operator">=</span> <span class="token function">GetFieldIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"mObject"</span><span class="token punctuation">,</span> <span class="token string">"J"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gBinderProxyOffsets<span class="token punctuation">.</span>mSelf <span class="token operator">=</span> <span class="token function">GetFieldIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"mSelf"</span><span class="token punctuation">,</span>
                                                <span class="token string">"Ljava/lang/ref/WeakReference;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gBinderProxyOffsets<span class="token punctuation">.</span>mOrgue <span class="token operator">=</span> <span class="token function">GetFieldIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"mOrgue"</span><span class="token punctuation">,</span> <span class="token string">"J"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    clazz <span class="token operator">=</span> <span class="token function">FindClassOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"java/lang/Class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gClassOffsets<span class="token punctuation">.</span>mGetName <span class="token operator">=</span> <span class="token function">GetMethodIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"getName"</span><span class="token punctuation">,</span> <span class="token string">"()Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">RegisterMethodsOrDie</span><span class="token punctuation">(</span>
        env<span class="token punctuation">,</span> kBinderProxyPathName<span class="token punctuation">,</span>
        gBinderProxyMethods<span class="token punctuation">,</span> <span class="token function">NELEM</span><span class="token punctuation">(</span>gBinderProxyMethods<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong><code>int_register_android_os_Binder</code>方法的主要功能</strong>：<br> 通过<code>gBinderOffsets</code>，保存Java层Binder类的信息，为JNI层访问Java层提供通道；<br> 通过<code>RegisterMethodsOrDie</code>，将<code>gBinderMethods数组</code>完成映射关系，为Java层访问JNI层提供通道。<br> <strong>也就是说该过程建立了Binder类在Native层与framework层之间的相互调用的<br> 桥梁。</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> jobject <span class="token function">android_os_BinderInternal_getContextObject</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span> b <span class="token operator">=</span> ProcessState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getContextObject</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">javaObjectForIBinder</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>BinderInternal.java中有一个native方法<code>getContextObject()</code>，JNI调用执行上述方法。<code>ProcessState::self()-&gt;getContextObject()</code>等价于<code>newBpBinder(0)</code>。在ProcessState的Self中，会调用自身的构造函数，在构造函数中，会做几件事情：</p> 
<blockquote> 
 <ol><li>打开binder设备，设置服务的<code>最大线程数目为15个</code></li><li>用mmap做内存映射（大小为<code>1M-8K</code>）</li></ol> 
</blockquote> 
<pre><code class="prism language-c">jobject <span class="token function">javaObjectForIBinder</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span><span class="token operator">&amp;</span> val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>val<span class="token operator">-&gt;</span><span class="token function">checkSubclass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gBinderOffsets<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// One of our own!</span>
        jobject object <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span>JavaBBinder<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOGDEATH</span><span class="token punctuation">(</span><span class="token string">"objectForBinder %p: it's our own %p!\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> object<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// For the rest of the function we will hold this lock, to serialize</span>
    <span class="token comment">// looking/creation/destruction of Java proxies for native Binder proxies.</span>
    AutoMutex <span class="token function">_l</span><span class="token punctuation">(</span>mProxyLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Someone else's...  do we know about it?</span>
    jobject object <span class="token operator">=</span> <span class="token punctuation">(</span>jobject<span class="token punctuation">)</span>val<span class="token operator">-&gt;</span><span class="token function">findObject</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gBinderProxyOffsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        jobject res <span class="token operator">=</span> <span class="token function">jniGetReferent</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"objectForBinder %p: found existing %p!\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LOGDEATH</span><span class="token punctuation">(</span><span class="token string">"Proxy object %p of IBinder %p no longer in working set!!!"</span><span class="token punctuation">,</span> object<span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">android_atomic_dec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gNumProxyRefs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        val<span class="token operator">-&gt;</span><span class="token function">detachObject</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gBinderProxyOffsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token operator">-&gt;</span><span class="token function">DeleteGlobalRef</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    object <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">NewObject</span><span class="token punctuation">(</span>gBinderProxyOffsets<span class="token punctuation">.</span>mClass<span class="token punctuation">,</span> gBinderProxyOffsets<span class="token punctuation">.</span>mConstructor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOGDEATH</span><span class="token punctuation">(</span><span class="token string">"objectForBinder %p: created new proxy %p !\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// The proxy holds a reference to the native object.</span>
        env<span class="token operator">-&gt;</span><span class="token function">SetLongField</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> gBinderProxyOffsets<span class="token punctuation">.</span>mObject<span class="token punctuation">,</span> <span class="token punctuation">(</span>jlong<span class="token punctuation">)</span>val<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        val<span class="token operator">-&gt;</span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>javaObjectForIBinder<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// The native object needs to hold a weak reference back to the</span>
        <span class="token comment">// proxy, so we can retrieve the same proxy if it is still active.</span>
        jobject refObject <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">NewGlobalRef</span><span class="token punctuation">(</span>
                env<span class="token operator">-&gt;</span><span class="token function">GetObjectField</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> gBinderProxyOffsets<span class="token punctuation">.</span>mSelf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        val<span class="token operator">-&gt;</span><span class="token function">attachObject</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gBinderProxyOffsets<span class="token punctuation">,</span> refObject<span class="token punctuation">,</span>
                <span class="token function">jnienv_to_javavm</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> proxy_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Also remember the death recipients registered on this proxy</span>
        sp<span class="token operator">&lt;</span>DeathRecipientList<span class="token operator">&gt;</span> drl <span class="token operator">=</span> new DeathRecipientList<span class="token punctuation">;</span>
        drl<span class="token operator">-&gt;</span><span class="token function">incStrong</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>javaObjectForIBinder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token operator">-&gt;</span><span class="token function">SetLongField</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> gBinderProxyOffsets<span class="token punctuation">.</span>mOrgue<span class="token punctuation">,</span> reinterpret_cast<span class="token operator">&lt;</span>jlong<span class="token operator">&gt;</span><span class="token punctuation">(</span>drl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Note that a new object reference has been created.</span>
        <span class="token function">android_atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gNumProxyRefs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">incRefsCreated</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> object<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>根据BpBinder(C++)生成BinderProxy(Java)对象.主要工作是创建BinderProxy对象,并把BpBinder对象地址保存到BinderProxy.mObject成员变量。到此可以知ServiceManagerNative.asInterface(BinderInternal.getContextObject())等价于ServiceManagerNative.asInterface(newBinderProxy())</p> 
<pre><code class="prism language-c">sp<span class="token operator">&lt;</span>IBinder<span class="token operator">&gt;</span> <span class="token function">ibinderForJavaObject</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token operator">-&gt;</span><span class="token function">IsInstanceOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> gBinderOffsets<span class="token punctuation">.</span>mClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        JavaBBinderHolder<span class="token operator">*</span> jbh <span class="token operator">=</span> <span class="token punctuation">(</span>JavaBBinderHolder<span class="token operator">*</span><span class="token punctuation">)</span>
            env<span class="token operator">-&gt;</span><span class="token function">GetLongField</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> gBinderOffsets<span class="token punctuation">.</span>mObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> jbh <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">?</span> jbh<span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token operator">-&gt;</span><span class="token function">IsInstanceOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> gBinderProxyOffsets<span class="token punctuation">.</span>mClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>IBinder<span class="token operator">*</span><span class="token punctuation">)</span>
            env<span class="token operator">-&gt;</span><span class="token function">GetLongField</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> gBinderProxyOffsets<span class="token punctuation">.</span>mObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"ibinderForJavaObject: %p is not a Binder object"</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>根据Binde(Java)生成JavaBBinderHolder(C++)对象.主要工作是创建JavaBBinderHolder对象,并把JavaBBinderHolder对象地址保存到Binder.mObject成员变量</p> 
<pre><code class="prism language-c">class JavaBBinderHolder <span class="token operator">:</span> public RefBase
<span class="token punctuation">{<!-- --></span>
public<span class="token operator">:</span>
    sp<span class="token operator">&lt;</span>JavaBBinder<span class="token operator">&gt;</span> <span class="token function">get</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        AutoMutex <span class="token function">_l</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sp<span class="token operator">&lt;</span>JavaBBinder<span class="token operator">&gt;</span> b <span class="token operator">=</span> mBinder<span class="token punctuation">.</span><span class="token function">promote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            b <span class="token operator">=</span> new <span class="token function">JavaBBinder</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mBinder <span class="token operator">=</span> b<span class="token punctuation">;</span>
            <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"Creating JavaBinder %p (refs %p) for Object %p, weakCount=%"</span> PRId32 <span class="token string">"\n"</span><span class="token punctuation">,</span>
                 b<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token operator">-&gt;</span><span class="token function">getWeakRefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">,</span> b<span class="token operator">-&gt;</span><span class="token function">getWeakRefs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getWeakCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sp<span class="token operator">&lt;</span>JavaBBinder<span class="token operator">&gt;</span> <span class="token function">getExisting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        AutoMutex <span class="token function">_l</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> mBinder<span class="token punctuation">.</span><span class="token function">promote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

private<span class="token operator">:</span>
    Mutex           mLock<span class="token punctuation">;</span>
    wp<span class="token operator">&lt;</span>JavaBBinder<span class="token operator">&gt;</span> mBinder<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>JavaBBinderHolder有一个成员变量mBinder，保存当前创建的JavaBBinder对象，这是一个wp类型的，可能会被垃圾回收器给回收，所以每次使用前，都需要先判断是否存在。</p> 
<pre><code class="prism language-c">    <span class="token function">JavaBBinder</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject object<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">mVM</span><span class="token punctuation">(</span><span class="token function">jnienv_to_javavm</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mObject</span><span class="token punctuation">(</span>env<span class="token operator">-&gt;</span><span class="token function">NewGlobalRef</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"Creating JavaBBinder %p\n"</span><span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">android_atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gNumLocalRefs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">incRefsCreated</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>创建<code>JavaBBinder</code>，该对象继承于<code>BBinder</code>对象。<code>data.writeStrongBinder(service)</code>最终等价于<code>parcel-&gt;writeStrongBinder(newJavaBBinder(env,obj));</code></p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> jboolean <span class="token function">android_os_BinderProxy_transact</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">,</span>
        jint code<span class="token punctuation">,</span> jobject dataObj<span class="token punctuation">,</span> jobject replyObj<span class="token punctuation">,</span> jint flags<span class="token punctuation">)</span> <span class="token comment">// throws RemoteException</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataObj <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">jniThrowNullPointerException</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> JNI_FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Parcel<span class="token operator">*</span> data <span class="token operator">=</span> <span class="token function">parcelForJavaObject</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> dataObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> JNI_FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Parcel<span class="token operator">*</span> reply <span class="token operator">=</span> <span class="token function">parcelForJavaObject</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> replyObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reply <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> replyObj <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> JNI_FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    IBinder<span class="token operator">*</span> target <span class="token operator">=</span> <span class="token punctuation">(</span>IBinder<span class="token operator">*</span><span class="token punctuation">)</span>
        env<span class="token operator">-&gt;</span><span class="token function">GetLongField</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> gBinderProxyOffsets<span class="token punctuation">.</span>mObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">jniThrowException</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"java/lang/IllegalStateException"</span><span class="token punctuation">,</span> <span class="token string">"Binder has been finalized!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> JNI_FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"Java code calling transact on %p in Java object %p with code %"</span> PRId32 <span class="token string">"\n"</span><span class="token punctuation">,</span>
            target<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>


    bool time_binder_calls<span class="token punctuation">;</span>
    <span class="token class-name">int64_t</span> start_millis<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kEnableBinderSample<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Only log the binder call duration for things on the Java-level main thread.</span>
        <span class="token comment">// But if we don't</span>
        time_binder_calls <span class="token operator">=</span> <span class="token function">should_time_binder_calls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>time_binder_calls<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            start_millis <span class="token operator">=</span> <span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//printf("Transact from Java code to %p sending: ", target); data-&gt;print();</span>
    <span class="token class-name">status_t</span> err <span class="token operator">=</span> target<span class="token operator">-&gt;</span><span class="token function">transact</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//if (reply) printf("Transact from Java code to %p received: ", target); reply-&gt;print();</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>kEnableBinderSample<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>time_binder_calls<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">conditionally_log_binder_call</span><span class="token punctuation">(</span>start_millis<span class="token punctuation">,</span> target<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> JNI_TRUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> UNKNOWN_TRANSACTION<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> JNI_FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">signalExceptionForError</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> err<span class="token punctuation">,</span> true <span class="token comment">/*canThrowRemoteException*/</span><span class="token punctuation">,</span> data<span class="token operator">-&gt;</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> JNI_FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Java层的<code>BinderProxy.transact()</code>最终交由Native层的<code>BpBinder::transact()</code>完成。NativeBinder的注册服务(addService)中有详细说明BpBinder执行过程。另外，该方法可抛出RemoteException。</p> 
<h4><a id="422_AndroidRuntime_jni__605"></a>4.2.2 AndroidRuntime jni 调度机制</h4> 
<h3><a id="43_Binder_native_607"></a>4.3 Binder native层</h3> 
<h4><a id="431_IPCRPC_608"></a>4.3.1 IPC与RPC</h4> 
<p>  <strong>IPC （Inter-Process Communication）即进程间通信</strong>，是指进程间数据交互的过程。Android底层是基于Linux，而Linux基于安全考虑，是不允许两个进程间直接操作对方的数据，这就是进程隔离。</p> 
<p>  <strong>RPC（Remote Procedure Call）即远程过程调用</strong>，它是一种通过网络从远程计算机程序上请求服务，在不需要了解底层网络技术的协议下，即可获取计算机进程中的数据。RPC使得开发包括网络分布式多程序在内的应用程序更加容易。简而言之：客户端能向服务端发送若干个进程请求，服务端根据发送的进程参数依次返回对应的计算结果。RPC可以说客户端调用服务端的接口的过程，是面向接口的编程。</p> 
<p>  Android 利用远程过程调用 (RPC) 提供了一种进程间通信 (IPC) 机制，通过这种机制，由 Activity 或其他应用组件调用的方法将（在其他进程中）远程执行，而所有结果将返回给调用方。 这就要求把方法调用及其数据分解至操作系统可以识别的程度，并将其从本地进程和地址空间传输至远程进程和地址空间，然后在远程进程中重新组装并执行该调用。 然后，返回值将沿相反方向传输回来。 Android 提供了执行这些 IPC 事务所需的全部代码，因此您只需集中精力定义和实现 RPC 编程接口即可。要执行 IPC，必须使用 bindService() 将应用绑定到服务上。也就是说，<strong>RPC在的Android具体体现，是依赖 <code>bindService()</code>的方式，在<code>onBind</code>方法将服务端的计算结果返回给客户端（Activity等组件）的过程。</strong></p> 
<h4><a id="432_service_manager_614"></a>4.3.2 service_manager服务如何随系统启动而启动</h4> 
<p><img src="https://images2.imgbox.com/c8/2b/Mgn5u9Eh_o.png" alt="在这里插入图片描述"><br> ServiceManager进程是在init进程创建的，所以我们从init进程的main(）开始分析：</p> 
<pre><code class="prism language-c"><span class="token comment">// 文件路径： system/core/init/main.cpp</span>
 
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"second_stage"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//TODO  根据条件会走到这个分支</span>
            <span class="token keyword">return</span> <span class="token function">SecondStageMain</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>
 
 
<span class="token keyword">int</span> <span class="token function">SecondStageMain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token comment">//用来存放解析出的内容</span>
   ActionManager<span class="token operator">&amp;</span> am <span class="token operator">=</span> ActionManager<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   ServiceList<span class="token operator">&amp;</span> sm <span class="token operator">=</span> ServiceList<span class="token operator">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//在这个方法中会对 /system/core/rootdir/init.rc 脚本文件文件进行解析</span>
   <span class="token function">LoadBootScripts</span><span class="token punctuation">(</span>am<span class="token punctuation">,</span> sm<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
   <span class="token comment">//循环处理init.rc脚本中的command命令，处理完就进入等待</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>prop_waiter_state<span class="token punctuation">.</span><span class="token function">MightBeWaiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> Service<span class="token operator">::</span><span class="token function">is_exec_service_running</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
         <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//内部遍历执行每个action中携带的command对应的执行函数</span>
			am<span class="token punctuation">.</span><span class="token function">ExecuteOneCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
 
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">LoadBootScripts</span><span class="token punctuation">(</span>ActionManager<span class="token operator">&amp;</span> action_manager<span class="token punctuation">,</span> ServiceList<span class="token operator">&amp;</span> service_list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//创建解析器</span>
	Parser parser <span class="token operator">=</span> <span class="token function">CreateParser</span><span class="token punctuation">(</span>action_manager<span class="token punctuation">,</span> service_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    std<span class="token operator">::</span>string bootscript <span class="token operator">=</span> <span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token string">"ro.boot.init_rc"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bootscript<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//解析init.rc ,这个是手机设备上的路径，和源码中system/core/init/init.rc是一个文件</span>
        parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/system/etc/init/hw/init.rc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/system/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            late_import_paths<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"/system/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// late_import is available only in Q and earlier release. As we don't</span>
        <span class="token comment">// have system_ext in those versions, skip late_import for system_ext.</span>
        parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/system_ext/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/product/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            late_import_paths<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"/product/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/odm/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            late_import_paths<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"/odm/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/vendor/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            late_import_paths<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"/vendor/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span>bootscript<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下面是init.rc中启动servicemanager进程相关的部分：</p> 
<pre><code class="prism language-c">on init
    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">Start essential services<span class="token punctuation">.</span></span></span>
    start servicemanager  #启动servicemanager进程
    start hwservicemanager
    start vndservicemanager
</code></pre> 
<p>有关servicemanager进程启动的细节配置被放在了frameworks\native\cmds\servicemanager\servicemanager.rc</p> 
<pre><code class="prism language-c">#此脚本文件描述了启动servicemanager进程时的一些细节
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">service</span><span class="token expression">用于通知init进程创建名为servicemanager的进程，这个进程执行程序的路径是<span class="token operator">/</span>system<span class="token operator">/</span>bin<span class="token operator">/</span>servicemanager</span></span>
#在手机系统中是能找到这个文件的
service servicemanager <span class="token operator">/</span>system<span class="token operator">/</span>bin<span class="token operator">/</span>servicemanager
    class core animation
    #表明此进程是以system身份运行的
    user system
    group system readproc
    #说明servicemanager是系统中的关键服务，关键服务是不会退出的，若退出系统则会重启，系统重启则会重启
    #以下onrestart修饰的进程，也可以说明这些进程是依赖于servicemanager进程的
    critical
    onrestart restart healthd
    onrestart restart zygote
    onrestart restart audioserver
    onrestart restart media
    onrestart restart surfaceflinger
    onrestart restart inputflinger
    onrestart restart drm
    onrestart restart cameraserver
    onrestart restart keystore
    onrestart restart gatekeeperd
    onrestart restart thermalservice
    writepid <span class="token operator">/</span>dev<span class="token operator">/</span>cpuset<span class="token operator">/</span>system<span class="token operator">-</span>background<span class="token operator">/</span>tasks
    shutdown critical
</code></pre> 
<p>总结：ServiceManager是一个独立的进程，<code>由init进程创建</code>，且在创建<code>zygote进程之前被创建</code>。</p> 
<h4><a id="433_loopServiceManagermain_717"></a>4.3.3 loop循环（ServiceManager的main方法）</h4> 
<p>ServiceManager的main方法：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">;</span>
    <span class="token keyword">union</span> selinux_callback cb<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>driver<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        driver <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        driver <span class="token operator">=</span> <span class="token string">"/dev/binder"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 打开 /dev/binder 初始化系统 其内部通过 mmap() 函数创建一块内存空间 </span>
    <span class="token comment">// 参数 mapsize = 128*1024 就是空间的大小 128k</span>
    bs <span class="token operator">=</span> <span class="token function">binder_open</span><span class="token punctuation">(</span>driver<span class="token punctuation">,</span> <span class="token number">128</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 调用了 binder.c 中的 binder_become_context_manager(bs) 函数</span>
    <span class="token comment">// 作用：把本进程设置为 Binder 框架的管理进程 </span>
    <span class="token comment">// 其内部非常简单 就是通过 ioctl 将 BINDER_SET_CONTEXT_MGR 发送到了驱动</span>
    <span class="token comment">// 调用了 binder_become_context_manager 后就代表我已经准备就绪了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">binder_become_context_manager</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cb<span class="token punctuation">.</span>func_audit <span class="token operator">=</span> audit_callback<span class="token punctuation">;</span>
    <span class="token function">selinux_set_callback</span><span class="token punctuation">(</span>SELINUX_CB_AUDIT<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cb<span class="token punctuation">.</span>func_log <span class="token operator">=</span> selinux_log_callback<span class="token punctuation">;</span>
    <span class="token function">selinux_set_callback</span><span class="token punctuation">(</span>SELINUX_CB_LOG<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">VENDORSERVICEMANAGER</span></span>
    sehandle <span class="token operator">=</span> <span class="token function">selinufx_android_vendor_service_context_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    sehandle <span class="token operator">=</span> <span class="token function">selinux_android_service_context_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token function">selinux_status_open</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sehandle <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"SELinux: Failed to acquire sehandle. Aborting.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getcon</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>service_manager_context<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"SELinux: Failed to acquire service_manager context. Aborting.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 最后调用 binder_loop 开启消息循环。将 svcmgr_handler 函数指针传入。</span>
    <span class="token comment">// binder_loop() 函数的主要作用就是从驱动读取命令解析后再 用svcmgr_handler 处理</span>
    <span class="token function">binder_loop</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> svcmgr_handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>SeviceManager进程启动过程中，主要做了以下四件事：</p> 
<blockquote> 
 <p>1）初始化binder驱动，并完成映射<br> 2）将自身以“manager” 添加到servicemanager中的map集合中<br> 3）binder_become_context_manager，注册成为为binder驱动的上下文管理者<br> 4）<strong>binder_loop，循环等待客户端的请求</strong>，（给Looper设置callback，进入无限循环，处理client端发来的请求）</p> 
</blockquote> 
<h4><a id="434__779"></a>4.3.4 内核空间与用户空间原理</h4> 
<p>在Linux中，<strong><code>操作系统和驱动程序运行在Kernel space（内核空间），应用程序运行在User space（用户空间）</code></strong>。两者不能简单的使用指针传递数据，因为Linux使用的虚拟内核机制，当内核空间使用用户空间指针时，对应的数据可能不在内存中（数据已被换出）。用户空间的内存采用段页式，内核空间也有自己的规则。<br> 简单说，Kernel space 是 Linux 内核的运行空间，User space 是用户程序的运行空间。<strong>为了安全，它们是隔离的，即使用户的程序崩溃了，内核也不受影响</strong>。Kernel space 可以执行任意命令，调用系统的一切资源；User space 只能执行简单的运算，不能直接调用系统资源，必须通过系统接口（又称 system call），才能向内核发出指令。</p> 
<h4><a id="435_misc_register_782"></a>4.3.5 misc_register</h4> 
<p><code>misc_register函数</code>使用来<code>注册</code>对外提供操作的函数<br> 驱动文件是一种特殊的文件，例如open 一个文件，只是打开而已。 在Linux机制中，如果操作一个驱动文件，会调用驱动对应的方法。 <code>open ( ' / dev / binder " ）</code>文件，会执行驱动源码的 <code>binder_open</code> 方法</p> 
<h3><a id="44_Binder_785"></a>4.4 Binder驱动层</h3> 
<h4><a id="441__786"></a>4.4.1 基础</h4> 
<p>handle 回调函数详解<br> 数据结构：binder_node、binder_ref、binder_proc、binder_thread</p> 
<h4><a id="442__789"></a>4.4.2 数据交互</h4> 
<p>在BinderIPC通信过程中，进程间通信都要先通过向Binder驱动发送BC_XXX命令，然后Binder 驱动稍做处理后通过对应的BR_XXX将命令转给给目标进程。<br> 如果有返回值，进程也是先将返回结果以BC_REPLY的形式先发给Binder驱动，然后通过驱动以BR_REPLY命令转发。<br> <img src="https://images2.imgbox.com/61/ae/VzPuU9IV_o.png" alt="在这里插入图片描述"><br> <strong><code>PS:从Driver发出的命令以BR开始，而发往Driver的命令以BC开头</code></strong></p> 
<h4><a id="443__795"></a>4.4.3 三大逻辑流程</h4> 
<p>服务注册、服务发现、服务调用，下面我们来看看Binder在c层的三大逻辑：</p> 
<p><strong>服务注册检测及服务发现</strong><br> service_manager.c</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">svcmgr_handler</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span>txn<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span>
                   <span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">svcinfo</span> <span class="token operator">*</span>si<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> <span class="token operator">*</span>s<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> len<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> handle<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> strict_policy<span class="token punctuation">;</span>
    <span class="token keyword">int</span> allow_isolated<span class="token punctuation">;</span>

    <span class="token comment">//ALOGI("target=%p code=%d pid=%d uid=%d\n",</span>
    <span class="token comment">//      (void*) txn-&gt;target.ptr, txn-&gt;code, txn-&gt;sender_pid, txn-&gt;sender_euid);</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span>target<span class="token punctuation">.</span>ptr <span class="token operator">!=</span> BINDER_SERVICE_MANAGER<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span>code <span class="token operator">==</span> PING_TRANSACTION<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// Equivalent to Parcel::enforceInterface(), reading the RPC</span>
    <span class="token comment">// header with the strict mode policy mask and the interface name.</span>
    <span class="token comment">// Note that we ignore the strict_policy and don't propagate it</span>
    <span class="token comment">// further (since we do no outbound RPCs anyway).</span>
    strict_policy <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>svcmgr_id<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">memcmp</span><span class="token punctuation">(</span>svcmgr_id<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>svcmgr_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"invalid id %s\n"</span><span class="token punctuation">,</span> <span class="token function">str8</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sehandle <span class="token operator">&amp;&amp;</span> <span class="token function">selinux_status_updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> <span class="token class-name">selabel_handle</span> <span class="token operator">*</span>tmp_sehandle <span class="token operator">=</span> <span class="token function">selinux_android_service_context_handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp_sehandle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">selabel_close</span><span class="token punctuation">(</span>sehandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sehandle <span class="token operator">=</span> tmp_sehandle<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span><span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span>code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> SVC_MGR_GET_SERVICE<span class="token operator">:</span>
    <span class="token keyword">case</span> SVC_MGR_CHECK_SERVICE<span class="token operator">:</span>
    	<span class="token comment">//服务名</span>
        s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//根据名称查找相应服务</span>
        handle <span class="token operator">=</span> <span class="token function">do_find_service</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>sender_euid<span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>sender_pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handle<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token function">bio_put_ref</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> SVC_MGR_ADD_SERVICE<span class="token operator">:</span>
    	<span class="token comment">//服务名</span>
        s <span class="token operator">=</span> <span class="token function">bio_get_string16</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        handle <span class="token operator">=</span> <span class="token function">bio_get_ref</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        allow_isolated <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//注册指定服务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">do_add_service</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> s<span class="token punctuation">,</span> len<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>sender_euid<span class="token punctuation">,</span>
            allow_isolated<span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>sender_pid<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> SVC_MGR_LIST_SERVICES<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">uint32_t</span> n <span class="token operator">=</span> <span class="token function">bio_get_uint32</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">svc_can_list</span><span class="token punctuation">(</span>txn<span class="token operator">-&gt;</span>sender_pid<span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>sender_euid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"list_service() uid=%d - PERMISSION DENIED\n"</span><span class="token punctuation">,</span>
                    txn<span class="token operator">-&gt;</span>sender_euid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        si <span class="token operator">=</span> svclist<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> si<span class="token punctuation">)</span>
            si <span class="token operator">=</span> si<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">bio_put_string16</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> si<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"unknown code %d\n"</span><span class="token punctuation">,</span> txn<span class="token operator">-&gt;</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">bio_put_uint32</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">svcinfo</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">svcinfo</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token comment">//服务的 handle 值</span>
    <span class="token class-name">uint32_t</span> handle<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">binder_death</span> death<span class="token punctuation">;</span>
    <span class="token keyword">int</span> allow_isolated<span class="token punctuation">;</span>
    <span class="token comment">//名字长度</span>
    <span class="token class-name">size_t</span> len<span class="token punctuation">;</span>
    <span class="token comment">//服务名</span>
    <span class="token class-name">uint16_t</span> name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>该方法的功能：注册服务、查询服务，以及列举所有服务。<br> 每一个服务用 svcinfo 结构体来表示，该 handle 值是在注册服务的过程中，由<br> 服务所在进程那一端所确定的。</p> 
<p><strong>注册服务</strong><br> service_manager.c</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">do_add_service</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span>
                   <span class="token keyword">const</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span>
                   <span class="token class-name">uint32_t</span> handle<span class="token punctuation">,</span> <span class="token class-name">uid_t</span> uid<span class="token punctuation">,</span> <span class="token keyword">int</span> allow_isolated<span class="token punctuation">,</span>
                   <span class="token class-name">pid_t</span> spid<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">svcinfo</span> <span class="token operator">*</span>si<span class="token punctuation">;</span>

    <span class="token comment">//ALOGI("add_service('%s',%x,%s) uid=%d\n", str8(s, len), handle,</span>
    <span class="token comment">//        allow_isolated ? "allow_isolated" : "!allow_isolated", uid);</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handle <span class="token operator">||</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token comment">//权限检查</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">svc_can_register</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">,</span> spid<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"add_service('%s',%x) uid=%d - PERMISSION DENIED\n"</span><span class="token punctuation">,</span>
             <span class="token function">str8</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//服务检索</span>
    si <span class="token operator">=</span> <span class="token function">find_svc</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"add_service('%s',%x) uid=%d - ALREADY REGISTERED, OVERRIDE\n"</span><span class="token punctuation">,</span>
                 <span class="token function">str8</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//服务已注册时，释放相应的服务</span>
            <span class="token function">svcinfo_death</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> si<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        si<span class="token operator">-&gt;</span>handle <span class="token operator">=</span> handle<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        si <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>si<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//内存不足，无法分配足够内存</span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"add_service('%s',%x) uid=%d - OUT OF MEMORY\n"</span><span class="token punctuation">,</span>
                 <span class="token function">str8</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">,</span> handle<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        si<span class="token operator">-&gt;</span>handle <span class="token operator">=</span> handle<span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>
        <span class="token comment">//内存拷贝服务信息</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>name<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>death<span class="token punctuation">.</span>func <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> svcinfo_death<span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>death<span class="token punctuation">.</span>ptr <span class="token operator">=</span> si<span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>allow_isolated <span class="token operator">=</span> allow_isolated<span class="token punctuation">;</span>
        <span class="token comment">// svclist 保存所有已注册的服务</span>
        si<span class="token operator">-&gt;</span>next <span class="token operator">=</span> svclist<span class="token punctuation">;</span>
        svclist <span class="token operator">=</span> si<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//以 BC_ACQUIRE 命令，handle 为目标的信息，通过 ioctl 发送给 binder 驱动</span>
    <span class="token function">binder_acquire</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//以 BC_REQUEST_DEATH_NOTIFICATION 命令的信息，通过 ioctl 发送给 binder 驱动，</span>
    <span class="token comment">//主要用于清理内存等收尾工作。</span>
    <span class="token function">binder_link_to_death</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>si<span class="token operator">-&gt;</span>death<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">svc_can_register</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token class-name">size_t</span> name_len<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> spid<span class="token punctuation">,</span> <span class="token class-name">uid_t</span> uid<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>perm <span class="token operator">=</span> <span class="token string">"add"</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">multiuser_get_app_id</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> AID_APP<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* Don't allow apps to register services */</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//检查 selinux 权限是否满足</span>
    <span class="token keyword">return</span> <span class="token function">check_mac_perms_from_lookup</span><span class="token punctuation">(</span>spid<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> perm<span class="token punctuation">,</span> <span class="token function">str8</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> name_len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">svcinfo_death</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">svcinfo</span> <span class="token operator">*</span>si <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">svcinfo</span><span class="token operator">*</span> <span class="token punctuation">)</span> ptr<span class="token punctuation">;</span>

    <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"service '%s' died\n"</span><span class="token punctuation">,</span> <span class="token function">str8</span><span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> si<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>si<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">binder_release</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> si<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        si<span class="token operator">-&gt;</span>handle <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>binder.c</p> 
<pre><code class="prism language-c"><span class="token class-name">uint32_t</span> <span class="token function">bio_get_ref</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span>obj<span class="token punctuation">;</span>

    obj <span class="token operator">=</span> <span class="token function">_bio_get_obj</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>type <span class="token operator">==</span> BINDER_TYPE_HANDLE<span class="token punctuation">)</span>
        <span class="token keyword">return</span> obj<span class="token operator">-&gt;</span>handle<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">binder_link_to_death</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_state</span> <span class="token operator">*</span>bs<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> target<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">binder_death</span> <span class="token operator">*</span>death<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">uint32_t</span> cmd<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_handle_cookie</span> payload<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> data<span class="token punctuation">;</span>

    data<span class="token punctuation">.</span>cmd <span class="token operator">=</span> BC_REQUEST_DEATH_NOTIFICATION<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>handle <span class="token operator">=</span> target<span class="token punctuation">;</span>
    data<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> death<span class="token punctuation">;</span>
    <span class="token function">binder_write</span><span class="token punctuation">(</span>bs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>服务注册:<br> 注册服务的分以下 3 部分工作：<br> svc_can_register：检查权限，检查 selinux 权限是否满足；<br> find_svc：服务检索，根据服务名来查询匹配的服务；<br> svcinfo_death：释放服务，当查询到已存在同名的服务，则先清理该服<br> 务信息，再将当前的服务加入到服务列表 svclist；</p> 
<p>binder_write 进入 Binder driver 后，直接调用后进入 binder_thread_write, 处理 BC_REQUEST_DEATH_NOTIFICATION 命令</p> 
<p><strong>服务发现</strong><br> service_manager.c</p> 
<pre><code class="prism language-c"><span class="token class-name">uint32_t</span> <span class="token function">do_find_service</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">,</span> <span class="token class-name">uid_t</span> uid<span class="token punctuation">,</span> <span class="token class-name">pid_t</span> spid<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">svcinfo</span> <span class="token operator">*</span>si <span class="token operator">=</span> <span class="token function">find_svc</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si <span class="token operator">||</span> <span class="token operator">!</span>si<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>si<span class="token operator">-&gt;</span>allow_isolated<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// If this service doesn't allow access from isolated processes,</span>
        <span class="token comment">// then check the uid to see if it is isolated.</span>
        <span class="token class-name">uid_t</span> appid <span class="token operator">=</span> uid <span class="token operator">%</span> AID_USER<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>appid <span class="token operator">&gt;=</span> AID_ISOLATED_START <span class="token operator">&amp;&amp;</span> appid <span class="token operator">&lt;=</span> AID_ISOLATED_END<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">svc_can_find</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> len<span class="token punctuation">,</span> spid<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> si<span class="token operator">-&gt;</span>handle<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">svcinfo</span> <span class="token operator">*</span><span class="token function">find_svc</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint16_t</span> <span class="token operator">*</span>s16<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">svcinfo</span> <span class="token operator">*</span>si<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>si <span class="token operator">=</span> svclist<span class="token punctuation">;</span> si<span class="token punctuation">;</span> si <span class="token operator">=</span> si<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">==</span> si<span class="token operator">-&gt;</span>len<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token function">memcmp</span><span class="token punctuation">(</span>s16<span class="token punctuation">,</span> si<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> len <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> si<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>服务发现：查询到目标服务，并返回该服务所对应的 handle<br> 从 svclist 服务列表中，根据服务名遍历查找是否已经注册。当服务已存在<br> svclist，则返回相应的服务名，否则返回 NULL。<br> 当找到服务的 handle, 则调用 bio_put_ref(reply, handle)，将 handle 封装到<br> reply.</p> 
<p>binder.c</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">bio_put_ref</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> handle<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span>obj<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token punctuation">)</span>
        obj <span class="token operator">=</span> <span class="token function">bio_alloc_obj</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        obj <span class="token operator">=</span> <span class="token function">bio_alloc</span><span class="token punctuation">(</span>bio<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    obj<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0x7f</span> <span class="token operator">|</span> FLAT_BINDER_FLAG_ACCEPTS_FDS<span class="token punctuation">;</span>
    obj<span class="token operator">-&gt;</span>type <span class="token operator">=</span> BINDER_TYPE_HANDLE<span class="token punctuation">;</span>
    obj<span class="token operator">-&gt;</span>handle <span class="token operator">=</span> handle<span class="token punctuation">;</span>
    obj<span class="token operator">-&gt;</span>cookie <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">bio_put_obj</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span>obj<span class="token punctuation">;</span>

    obj <span class="token operator">=</span> <span class="token function">bio_alloc_obj</span><span class="token punctuation">(</span>bio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    obj<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0x7f</span> <span class="token operator">|</span> FLAT_BINDER_FLAG_ACCEPTS_FDS<span class="token punctuation">;</span>
    obj<span class="token operator">-&gt;</span>type <span class="token operator">=</span> BINDER_TYPE_BINDER<span class="token punctuation">;</span>
    obj<span class="token operator">-&gt;</span>binder <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>ptr<span class="token punctuation">;</span>
    obj<span class="token operator">-&gt;</span>cookie <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">bio_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_io</span> <span class="token operator">*</span>bio<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    size <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> bio<span class="token operator">-&gt;</span>data_avail<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        bio<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> BIO_F_OVERFLOW<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">void</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> bio<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
        bio<span class="token operator">-&gt;</span>data <span class="token operator">+=</span> size<span class="token punctuation">;</span>
        bio<span class="token operator">-&gt;</span>data_avail <span class="token operator">-=</span> size<span class="token punctuation">;</span>
        <span class="token keyword">return</span> ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>服务调用</strong><br> 上层通过checkService()，getService(）获取到服务，实际上是调用底层的transact()方法，对其方法进行调用。</p> 
<p>BpBinder.cpp</p> 
<pre><code class="prism language-c"><span class="token class-name">status_t</span> BpBinder<span class="token operator">::</span><span class="token function">transact</span><span class="token punctuation">(</span>
    <span class="token class-name">uint32_t</span> code<span class="token punctuation">,</span> <span class="token keyword">const</span> Parcel<span class="token operator">&amp;</span> data<span class="token punctuation">,</span> Parcel<span class="token operator">*</span> reply<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Once a binder has died, it will never come back to life.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mAlive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">status_t</span> status <span class="token operator">=</span> IPCThreadState<span class="token operator">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">transact</span><span class="token punctuation">(</span>
            mHandle<span class="token punctuation">,</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> DEAD_OBJECT<span class="token punctuation">)</span> mAlive <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> DEAD_OBJECT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Binder 代理类调用 transact()方法，真正工作还是交给 IPCThreadState 来进行<br> transact 工作，</p> 
<p>IPCThreadState.cpp</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> pthread_mutex_t gTLSMutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">bool</span> gHaveTLS <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> pthread_key_t gTLS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">bool</span> gShutdown <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">bool</span> gDisableBackgroundScheduling <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

IPCThreadState<span class="token operator">*</span> <span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>gHaveTLS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
restart<span class="token operator">:</span>
        <span class="token keyword">const</span> pthread_key_t k <span class="token operator">=</span> gTLS<span class="token punctuation">;</span>
        IPCThreadState<span class="token operator">*</span> st <span class="token operator">=</span> <span class="token punctuation">(</span>IPCThreadState<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">pthread_getspecific</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">)</span> <span class="token keyword">return</span> st<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> IPCThreadState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>gShutdown<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gTLSMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gHaveTLS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_key_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gTLS<span class="token punctuation">,</span> threadDestructor<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gTLSMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        gHaveTLS <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gTLSMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> restart<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">IPCThreadState</span><span class="token double-colon punctuation">::</span><span class="token function">IPCThreadState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">mProcess</span><span class="token punctuation">(</span><span class="token class-name">ProcessState</span><span class="token double-colon punctuation">::</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mMyThreadId</span><span class="token punctuation">(</span><span class="token function">androidGetTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mStrictModePolicy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mLastTransactionBinderFlags</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">pthread_setspecific</span><span class="token punctuation">(</span>gTLS<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearCaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mIn<span class="token punctuation">.</span><span class="token function">setDataCapacity</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mOut<span class="token punctuation">.</span><span class="token function">setDataCapacity</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>TLS 是指 Thread local storage(线程本地储存空间)，每个线程都拥有自己的TLS，并且是私有空间，线程之间不会共享。通过pthread_getspecific/pthread_setspecific 函数可以获取/设置这些空间中的内容。从线程本地存储空间中获得保存在其中的 IPCThreadState 对象。</p> 
<p>每个线程都有一个 IPCThreadState，每个 IPCThreadState 中都有一个 mIn、一个mOut。成员变量 mProcess 保存了 ProcessState 变量(每个进程只有一个)。<br> mIn 用来接收来自 Binder 设备的数据，默认大小为 256 字节；<br> mOut 用来存储发往 Binder 设备的数据，默认大小为 256 字节</p> 
<pre><code class="prism language-c"><span class="token class-name">status_t</span> IPCThreadState<span class="token operator">::</span><span class="token function">transact</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span> handle<span class="token punctuation">,</span>
                                  <span class="token class-name">uint32_t</span> code<span class="token punctuation">,</span> <span class="token keyword">const</span> Parcel<span class="token operator">&amp;</span> data<span class="token punctuation">,</span>
                                  Parcel<span class="token operator">*</span> reply<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//数据错误检查</span>
    <span class="token class-name">status_t</span> err <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">errorCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    flags <span class="token operator">|=</span> TF_ACCEPT_FDS<span class="token punctuation">;</span>

    <span class="token function">IF_LOG_TRANSACTIONS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        TextOutput<span class="token operator">::</span>Bundle <span class="token function">_b</span><span class="token punctuation">(</span>alog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        alog <span class="token operator">&lt;&lt;</span> <span class="token string">"BC_TRANSACTION thr "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" / hand "</span>
            <span class="token operator">&lt;&lt;</span> handle <span class="token operator">&lt;&lt;</span> <span class="token string">" / code "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">TypeCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span>
            <span class="token operator">&lt;&lt;</span> indent <span class="token operator">&lt;&lt;</span> data <span class="token operator">&lt;&lt;</span> dedent <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_ONEWAY</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt; SEND from pid %d uid %d %s"</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">"READ REPLY"</span> <span class="token operator">:</span> <span class="token string">"ONE WAY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 传输数据</span>
        err <span class="token operator">=</span> <span class="token function">writeTransactionData</span><span class="token punctuation">(</span>BC_TRANSACTION<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> code<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> reply<span class="token operator">-&gt;</span><span class="token function">setError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>mLastError <span class="token operator">=</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// relayout</span>
            <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt; CALLING transaction 4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt; CALLING transaction %d"</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//等待响应</span>
            err <span class="token operator">=</span> <span class="token function">waitForResponse</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            Parcel fakeReply<span class="token punctuation">;</span>
            err <span class="token operator">=</span> <span class="token function">waitForResponse</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fakeReply<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// relayout</span>
            <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"&lt;&lt;&lt;&lt;&lt;&lt; RETURNING transaction 4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"&lt;&lt;&lt;&lt;&lt;&lt; RETURNING transaction %d"</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        
        <span class="token function">IF_LOG_TRANSACTIONS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            TextOutput<span class="token operator">::</span>Bundle <span class="token function">_b</span><span class="token punctuation">(</span>alog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            alog <span class="token operator">&lt;&lt;</span> <span class="token string">"BR_REPLY thr "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" / hand "</span>
                <span class="token operator">&lt;&lt;</span> handle <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> alog <span class="token operator">&lt;&lt;</span> indent <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>reply <span class="token operator">&lt;&lt;</span> dedent <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token keyword">else</span> alog <span class="token operator">&lt;&lt;</span> <span class="token string">"(none requested)"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//不需要响应消息的 binder 则进入该分支</span>
        err <span class="token operator">=</span> <span class="token function">waitForResponse</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">status_t</span> IPCThreadState<span class="token operator">::</span><span class="token function">writeTransactionData</span><span class="token punctuation">(</span><span class="token class-name">int32_t</span> cmd<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> binderFlags<span class="token punctuation">,</span>
    <span class="token class-name">int32_t</span> handle<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> code<span class="token punctuation">,</span> <span class="token keyword">const</span> Parcel<span class="token operator">&amp;</span> data<span class="token punctuation">,</span> <span class="token class-name">status_t</span><span class="token operator">*</span> statusBuffer<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    binder_transaction_data tr<span class="token punctuation">;</span>

    tr<span class="token punctuation">.</span>target<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* Don't pass uninitialized stack data to a remote process */</span>
    tr<span class="token punctuation">.</span>target<span class="token punctuation">.</span>handle <span class="token operator">=</span> handle<span class="token punctuation">;</span>
    tr<span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
    tr<span class="token punctuation">.</span>flags <span class="token operator">=</span> binderFlags<span class="token punctuation">;</span>
    tr<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tr<span class="token punctuation">.</span>sender_pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    tr<span class="token punctuation">.</span>sender_euid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// data 为记录 Media 服务信息的 Parcel 对象</span>
    <span class="token keyword">const</span> <span class="token class-name">status_t</span> err <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">errorCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        tr<span class="token punctuation">.</span>data_size <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">ipcDataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">ipcData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>offsets_size <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">ipcObjectsCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">binder_size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">ipcObjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>statusBuffer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        tr<span class="token punctuation">.</span>flags <span class="token operator">|=</span> TF_STATUS_CODE<span class="token punctuation">;</span>
        <span class="token operator">*</span>statusBuffer <span class="token operator">=</span> err<span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>data_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">status_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer <span class="token operator">=</span> reinterpret_cast<span class="token operator">&lt;</span><span class="token class-name">uintptr_t</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>statusBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>offsets_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>mLastError <span class="token operator">=</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//cmd = BC_TRANSACTION</span>
    mOut<span class="token punctuation">.</span><span class="token function">writeInt32</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//写入 binder_transaction_data 数据</span>
    mOut<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">status_t</span> IPCThreadState<span class="token operator">::</span><span class="token function">waitForResponse</span><span class="token punctuation">(</span>Parcel <span class="token operator">*</span>reply<span class="token punctuation">,</span> <span class="token class-name">status_t</span> <span class="token operator">*</span>acquireResult<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">int32_t</span> cmd<span class="token punctuation">;</span>
    <span class="token class-name">int32_t</span> err<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token operator">=</span><span class="token function">talkWithDriver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> NO_ERROR<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        err <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">errorCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> NO_ERROR<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mIn<span class="token punctuation">.</span><span class="token function">dataAvail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        
        cmd <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">readInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">IF_LOG_COMMANDS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            alog <span class="token operator">&lt;&lt;</span> <span class="token string">"Processing waitForResponse Command: "</span>
                <span class="token operator">&lt;&lt;</span> <span class="token function">getReturnString</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> BR_TRANSACTION_COMPLETE<span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reply <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>acquireResult<span class="token punctuation">)</span> <span class="token keyword">goto</span> finish<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        
        <span class="token keyword">case</span> BR_DEAD_REPLY<span class="token operator">:</span>
            err <span class="token operator">=</span> DEAD_OBJECT<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> finish<span class="token punctuation">;</span>

        <span class="token keyword">case</span> BR_FAILED_REPLY<span class="token operator">:</span>
            err <span class="token operator">=</span> FAILED_TRANSACTION<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> finish<span class="token punctuation">;</span>
        
        <span class="token keyword">case</span> BR_ACQUIRE_RESULT<span class="token operator">:</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">ALOG_ASSERT</span><span class="token punctuation">(</span>acquireResult <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"Unexpected brACQUIRE_RESULT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> <span class="token class-name">int32_t</span> result <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">readInt32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>acquireResult<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token operator">*</span>acquireResult <span class="token operator">=</span> result <span class="token operator">?</span> NO_ERROR <span class="token operator">:</span> INVALID_OPERATION<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">goto</span> finish<span class="token punctuation">;</span>
        
        <span class="token keyword">case</span> BR_REPLY<span class="token operator">:</span>
            <span class="token punctuation">{<!-- --></span>
                binder_transaction_data tr<span class="token punctuation">;</span>
                err <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">ALOG_ASSERT</span><span class="token punctuation">(</span>err <span class="token operator">==</span> NO_ERROR<span class="token punctuation">,</span> <span class="token string">"Not enough command data for brREPLY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token keyword">goto</span> finish<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> TF_STATUS_CODE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        reply<span class="token operator">-&gt;</span><span class="token function">ipcSetDataReference</span><span class="token punctuation">(</span>
                            reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            tr<span class="token punctuation">.</span>data_size<span class="token punctuation">,</span>
                            reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token class-name">binder_size_t</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            tr<span class="token punctuation">.</span>offsets_size<span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">binder_size_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            freeBuffer<span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        err <span class="token operator">=</span> <span class="token operator">*</span>reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token class-name">status_t</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">freeBuffer</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>
                            reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            tr<span class="token punctuation">.</span>data_size<span class="token punctuation">,</span>
                            reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token class-name">binder_size_t</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            tr<span class="token punctuation">.</span>offsets_size<span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">binder_size_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">freeBuffer</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>
                        reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        tr<span class="token punctuation">.</span>data_size<span class="token punctuation">,</span>
                        reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token class-name">binder_size_t</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>tr<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        tr<span class="token punctuation">.</span>offsets_size<span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">binder_size_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">goto</span> finish<span class="token punctuation">;</span>

        <span class="token keyword">default</span><span class="token operator">:</span>
            err <span class="token operator">=</span> <span class="token function">executeCommand</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token keyword">goto</span> finish<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

finish<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>acquireResult<span class="token punctuation">)</span> <span class="token operator">*</span>acquireResult <span class="token operator">=</span> err<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> reply<span class="token operator">-&gt;</span><span class="token function">setError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mLastError <span class="token operator">=</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">status_t</span> IPCThreadState<span class="token operator">::</span><span class="token function">talkWithDriver</span><span class="token punctuation">(</span>bool doReceive<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mProcess<span class="token operator">-&gt;</span>mDriverFD <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EBADF<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    binder_write_read bwr<span class="token punctuation">;</span>
    
    <span class="token comment">// Is the read buffer empty?</span>
    <span class="token keyword">const</span> bool needRead <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">dataPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> mIn<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// We don't want to write anything if we are still reading</span>
    <span class="token comment">// from data left in the input buffer and the caller</span>
    <span class="token comment">// has requested to read the next data.</span>
    <span class="token keyword">const</span> <span class="token class-name">size_t</span> outAvail <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">!</span>doReceive <span class="token operator">||</span> needRead<span class="token punctuation">)</span> <span class="token operator">?</span> mOut<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    bwr<span class="token punctuation">.</span>write_size <span class="token operator">=</span> outAvail<span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>write_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>mOut<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// This is what we'll read.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>doReceive <span class="token operator">&amp;&amp;</span> needRead<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//接收数据缓冲区信息的填充。如果以后收到数据，就直接填在 mIn 中了。</span>
        bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">dataCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>mIn<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        bwr<span class="token punctuation">.</span>read_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bwr<span class="token punctuation">.</span>read_buffer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">IF_LOG_COMMANDS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        TextOutput<span class="token operator">::</span>Bundle <span class="token function">_b</span><span class="token punctuation">(</span>alog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outAvail <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            alog <span class="token operator">&lt;&lt;</span> <span class="token string">"Sending commands to driver: "</span> <span class="token operator">&lt;&lt;</span> indent<span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> cmds <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>bwr<span class="token punctuation">.</span>write_buffer<span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>cmds<span class="token punctuation">)</span><span class="token operator">+</span>bwr<span class="token punctuation">.</span>write_size<span class="token punctuation">;</span>
            alog <span class="token operator">&lt;&lt;</span> <span class="token function">HexDump</span><span class="token punctuation">(</span>cmds<span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>write_size<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>cmds <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> cmds <span class="token operator">=</span> <span class="token function">printCommand</span><span class="token punctuation">(</span>alog<span class="token punctuation">,</span> cmds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            alog <span class="token operator">&lt;&lt;</span> dedent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        alog <span class="token operator">&lt;&lt;</span> <span class="token string">"Size of receive buffer: "</span> <span class="token operator">&lt;&lt;</span> bwr<span class="token punctuation">.</span>read_size
            <span class="token operator">&lt;&lt;</span> <span class="token string">", needRead: "</span> <span class="token operator">&lt;&lt;</span> needRead <span class="token operator">&lt;&lt;</span> <span class="token string">", doReceive: "</span> <span class="token operator">&lt;&lt;</span> doReceive <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// Return immediately if there is nothing to do.</span>
    <span class="token comment">//当读缓冲和写缓冲都为空，则直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>write_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>read_size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>

    bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">status_t</span> err<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">IF_LOG_COMMANDS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            alog <span class="token operator">&lt;&lt;</span> <span class="token string">"About to read/write, write size = "</span> <span class="token operator">&lt;&lt;</span> mOut<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>HAVE_ANDROID_OS<span class="token punctuation">)</span></span></span>
		<span class="token comment">//通过 ioctl 不停的读写操作，跟 Binder Driver 进行通信</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>mProcess<span class="token operator">-&gt;</span>mDriverFD<span class="token punctuation">,</span> BINDER_WRITE_READ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bwr<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            err <span class="token operator">=</span> NO_ERROR<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            err <span class="token operator">=</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        err <span class="token operator">=</span> INVALID_OPERATION<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mProcess<span class="token operator">-&gt;</span>mDriverFD <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            err <span class="token operator">=</span> <span class="token operator">-</span>EBADF<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">IF_LOG_COMMANDS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            alog <span class="token operator">&lt;&lt;</span> <span class="token string">"Finished read/write, write size = "</span> <span class="token operator">&lt;&lt;</span> mOut<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token comment">//当被中断，则继续执行</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span>EINTR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">IF_LOG_COMMANDS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        alog <span class="token operator">&lt;&lt;</span> <span class="token string">"Our err: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">)</span>err <span class="token operator">&lt;&lt;</span> <span class="token string">", write consumed: "</span>
            <span class="token operator">&lt;&lt;</span> bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">&lt;&lt;</span> <span class="token string">" (of "</span> <span class="token operator">&lt;&lt;</span> mOut<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">&lt;&lt;</span> <span class="token string">"), read consumed: "</span> <span class="token operator">&lt;&lt;</span> bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&gt;=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>write_consumed <span class="token operator">&lt;</span> mOut<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                mOut<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bwr<span class="token punctuation">.</span>write_consumed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                mOut<span class="token punctuation">.</span><span class="token function">setDataSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>read_consumed <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mIn<span class="token punctuation">.</span><span class="token function">setDataSize</span><span class="token punctuation">(</span>bwr<span class="token punctuation">.</span>read_consumed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mIn<span class="token punctuation">.</span><span class="token function">setDataPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">IF_LOG_COMMANDS</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            TextOutput<span class="token operator">::</span>Bundle <span class="token function">_b</span><span class="token punctuation">(</span>alog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            alog <span class="token operator">&lt;&lt;</span> <span class="token string">"Remaining data size: "</span> <span class="token operator">&lt;&lt;</span> mOut<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            alog <span class="token operator">&lt;&lt;</span> <span class="token string">"Received commands from driver: "</span> <span class="token operator">&lt;&lt;</span> indent<span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> cmds <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> end <span class="token operator">=</span> mIn<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> mIn<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            alog <span class="token operator">&lt;&lt;</span> <span class="token function">HexDump</span><span class="token punctuation">(</span>cmds<span class="token punctuation">,</span> mIn<span class="token punctuation">.</span><span class="token function">dataSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>cmds <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> cmds <span class="token operator">=</span> <span class="token function">printReturnCommand</span><span class="token punctuation">(</span>alog<span class="token punctuation">,</span> cmds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            alog <span class="token operator">&lt;&lt;</span> dedent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中 handle 的值用来标识目的端，注册服务过程的目的端为 service manager，此处 handle=0 所对应的是 binder_context_mgr_node 对象，正是 servicemanager 所对应的 binder 实体对象。binder_transaction_data 结构体是 binder驱动通信的数据结构，该过程最终是把 Binder 请求码 BC_TRANSACTION 和binder_transaction_data 结构体写入到 mOut。</p> 
<p>binder_write_read 结构体用来与 Binder 设备交换数据的结构, 通过 ioctl 与mDriverFD 通信，是真正与 Binder 驱动进行数据读写交互的过程。先向 servicemanager 进程发送查询服务的请求(BR_TRANSACTION)。<br> 当 service manager 进程收到该命令后，会执行do_find_service() 查询服务所对应的 handle，然后再 binder_send_reply()应答发起者，发送 BC_REPLY 协议，然后调用 binder_transaction()，再向服务请求者的 Todo 队列 插入事务。<br> 接下来，再看看 binder_transaction 过程。</p> 
<p>binder.c</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">binder_transaction</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
				   <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span>
				   <span class="token keyword">struct</span> <span class="token class-name">binder_transaction_data</span> <span class="token operator">*</span>tr<span class="token punctuation">,</span> <span class="token keyword">int</span> reply<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//根据各种判定，获取以下信息：</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>t<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_work</span> <span class="token operator">*</span>tcomplete<span class="token punctuation">;</span>
	<span class="token class-name">binder_size_t</span> <span class="token operator">*</span>offp<span class="token punctuation">,</span> <span class="token operator">*</span>off_end<span class="token punctuation">;</span>
	<span class="token comment">//目标进程</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>target_proc<span class="token punctuation">;</span>
	<span class="token comment">//目标线程</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>target_thread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token comment">//目标binder节点</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_node</span> <span class="token operator">*</span>target_node <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token comment">//目标TODO队列</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>target_list<span class="token punctuation">;</span>
	<span class="token comment">//目标等待队列</span>
	<span class="token class-name">wait_queue_head_t</span> <span class="token operator">*</span>target_wait<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>in_reply_to <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">binder_transaction_log_entry</span> <span class="token operator">*</span>e<span class="token punctuation">;</span>
	<span class="token class-name">uint32_t</span> return_error<span class="token punctuation">;</span>

	e <span class="token operator">=</span> <span class="token function">binder_transaction_log_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_transaction_log<span class="token punctuation">)</span><span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>call_type <span class="token operator">=</span> reply <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>from_proc <span class="token operator">=</span> proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>from_thread <span class="token operator">=</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>target_handle <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>target<span class="token punctuation">.</span>handle<span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>data_size <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>offsets_size <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		in_reply_to <span class="token operator">=</span> thread<span class="token operator">-&gt;</span>transaction_stack<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>in_reply_to <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got reply transaction with no transaction stack\n"</span><span class="token punctuation">,</span>
					  proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
			return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_empty_call_stack<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">binder_set_nice</span><span class="token punctuation">(</span>in_reply_to<span class="token operator">-&gt;</span>saved_priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>in_reply_to<span class="token operator">-&gt;</span>to_thread <span class="token operator">!=</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got reply transaction with bad transaction stack, transaction %d has target %d:%d\n"</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> in_reply_to<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span>
				in_reply_to<span class="token operator">-&gt;</span>to_proc <span class="token operator">?</span>
				in_reply_to<span class="token operator">-&gt;</span>to_proc<span class="token operator">-&gt;</span>pid <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
				in_reply_to<span class="token operator">-&gt;</span>to_thread <span class="token operator">?</span>
				in_reply_to<span class="token operator">-&gt;</span>to_thread<span class="token operator">-&gt;</span>pid <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
			in_reply_to <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_bad_call_stack<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		thread<span class="token operator">-&gt;</span>transaction_stack <span class="token operator">=</span> in_reply_to<span class="token operator">-&gt;</span>to_parent<span class="token punctuation">;</span>
		target_thread <span class="token operator">=</span> in_reply_to<span class="token operator">-&gt;</span>from<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>target_thread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			return_error <span class="token operator">=</span> BR_DEAD_REPLY<span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_dead_binder<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>target_thread<span class="token operator">-&gt;</span>transaction_stack <span class="token operator">!=</span> in_reply_to<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got reply transaction with bad target transaction stack %d, expected %d\n"</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span>
				target_thread<span class="token operator">-&gt;</span>transaction_stack <span class="token operator">?</span>
				target_thread<span class="token operator">-&gt;</span>transaction_stack<span class="token operator">-&gt;</span>debug_id <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
				in_reply_to<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
			return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
			in_reply_to <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			target_thread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_dead_binder<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		target_proc <span class="token operator">=</span> target_thread<span class="token operator">-&gt;</span>proc<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>target<span class="token punctuation">.</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_ref</span> <span class="token operator">*</span>ref<span class="token punctuation">;</span>

			ref <span class="token operator">=</span> <span class="token function">binder_get_ref</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> tr<span class="token operator">-&gt;</span>target<span class="token punctuation">.</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got transaction to invalid handle\n"</span><span class="token punctuation">,</span>
					proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
				return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
				<span class="token keyword">goto</span> err_invalid_target_handle<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			target_node <span class="token operator">=</span> ref<span class="token operator">-&gt;</span>node<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			target_node <span class="token operator">=</span> binder_context_mgr_node<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>target_node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				return_error <span class="token operator">=</span> BR_DEAD_REPLY<span class="token punctuation">;</span>
				<span class="token keyword">goto</span> err_no_context_mgr_node<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		e<span class="token operator">-&gt;</span>to_node <span class="token operator">=</span> target_node<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">;</span>
		target_proc <span class="token operator">=</span> target_node<span class="token operator">-&gt;</span>proc<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>target_proc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			return_error <span class="token operator">=</span> BR_DEAD_REPLY<span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_dead_binder<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> thread<span class="token operator">-&gt;</span>transaction_stack<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>

			tmp <span class="token operator">=</span> thread<span class="token operator">-&gt;</span>transaction_stack<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-&gt;</span>to_thread <span class="token operator">!=</span> thread<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got new transaction with bad transaction stack, transaction %d has target %d:%d\n"</span><span class="token punctuation">,</span>
					proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> tmp<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span>
					tmp<span class="token operator">-&gt;</span>to_proc <span class="token operator">?</span> tmp<span class="token operator">-&gt;</span>to_proc<span class="token operator">-&gt;</span>pid <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
					tmp<span class="token operator">-&gt;</span>to_thread <span class="token operator">?</span>
					tmp<span class="token operator">-&gt;</span>to_thread<span class="token operator">-&gt;</span>pid <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
				<span class="token keyword">goto</span> err_bad_call_stack<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-&gt;</span>from <span class="token operator">&amp;&amp;</span> tmp<span class="token operator">-&gt;</span>from<span class="token operator">-&gt;</span>proc <span class="token operator">==</span> target_proc<span class="token punctuation">)</span>
					target_thread <span class="token operator">=</span> tmp<span class="token operator">-&gt;</span>from<span class="token punctuation">;</span>
				tmp <span class="token operator">=</span> tmp<span class="token operator">-&gt;</span>from_parent<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>target_thread<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e<span class="token operator">-&gt;</span>to_thread <span class="token operator">=</span> target_thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span>
		target_list <span class="token operator">=</span> <span class="token operator">&amp;</span>target_thread<span class="token operator">-&gt;</span>todo<span class="token punctuation">;</span>
		target_wait <span class="token operator">=</span> <span class="token operator">&amp;</span>target_thread<span class="token operator">-&gt;</span>wait<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		target_list <span class="token operator">=</span> <span class="token operator">&amp;</span>target_proc<span class="token operator">-&gt;</span>todo<span class="token punctuation">;</span>
		target_wait <span class="token operator">=</span> <span class="token operator">&amp;</span>target_proc<span class="token operator">-&gt;</span>wait<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	e<span class="token operator">-&gt;</span>to_proc <span class="token operator">=</span> target_proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span>

	<span class="token comment">/* TODO: reuse incoming transaction for reply */</span>
	<span class="token comment">//分配两个结构体内存</span>
	t <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_alloc_t_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">binder_stats_created</span><span class="token punctuation">(</span>BINDER_STAT_TRANSACTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//分配两个结构体内存</span>
	tcomplete <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>tcomplete<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>tcomplete <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_alloc_tcomplete_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">binder_stats_created</span><span class="token punctuation">(</span>BINDER_STAT_TRANSACTION_COMPLETE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	t<span class="token operator">-&gt;</span>debug_id <span class="token operator">=</span> <span class="token operator">++</span>binder_last_id<span class="token punctuation">;</span>
	e<span class="token operator">-&gt;</span>debug_id <span class="token operator">=</span> t<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span>
		<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_TRANSACTION<span class="token punctuation">,</span>
				 <span class="token string">"%d:%d BC_REPLY %d -&gt; %d:%d, data %016llx-%016llx size %lld-%lld\n"</span><span class="token punctuation">,</span>
				 proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span>
				 target_proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> target_thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span>
				 <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span>
				 <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">,</span>
				 <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_TRANSACTION<span class="token punctuation">,</span>
				 <span class="token string">"%d:%d BC_TRANSACTION %d -&gt; %d - node %d, data %016llx-%016llx size %lld-%lld\n"</span><span class="token punctuation">,</span>
				 proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span>
				 target_proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> target_node<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span>
				 <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span>
				 <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">,</span>
				 <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reply <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span>
		t<span class="token operator">-&gt;</span>from <span class="token operator">=</span> thread<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		t<span class="token operator">-&gt;</span>from <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>sender_euid <span class="token operator">=</span> <span class="token function">task_euid</span><span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>tsk<span class="token punctuation">)</span><span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>to_proc <span class="token operator">=</span> target_proc<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>to_thread <span class="token operator">=</span> target_thread<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>code <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>code<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> tr<span class="token operator">-&gt;</span>flags<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>priority <span class="token operator">=</span> <span class="token function">task_nice</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">trace_binder_transaction</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> t<span class="token punctuation">,</span> target_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//从target_proc分配一块buffer</span>
	t<span class="token operator">-&gt;</span>buffer <span class="token operator">=</span> <span class="token function">binder_alloc_buf</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span>
		tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">,</span> <span class="token operator">!</span>reply <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_binder_alloc_buf_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>allow_user_free <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>debug_id <span class="token operator">=</span> t<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>transaction <span class="token operator">=</span> t<span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>target_node <span class="token operator">=</span> target_node<span class="token punctuation">;</span>
	<span class="token function">trace_binder_transaction_alloc_buf</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>target_node<span class="token punctuation">)</span>
		<span class="token function">binder_inc_node</span><span class="token punctuation">(</span>target_node<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	offp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">binder_size_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>data <span class="token operator">+</span>
				 <span class="token function">ALIGN</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>
			   tr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got transaction with invalid data ptr\n"</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_copy_data_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>offp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>
			   tr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">,</span> tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got transaction with invalid offsets ptr\n"</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_copy_data_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IS_ALIGNED</span><span class="token punctuation">(</span>tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">binder_size_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got transaction with invalid offsets size, %lld\n"</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_bad_offset<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	off_end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>offp <span class="token operator">+</span> tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> offp <span class="token operator">&lt;</span> off_end<span class="token punctuation">;</span> offp<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span>fp<span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>offp <span class="token operator">&gt;</span> t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>data_size <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>fp<span class="token punctuation">)</span> <span class="token operator">||</span>
			t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>data_size <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>fp<span class="token punctuation">)</span> <span class="token operator">||</span>
			<span class="token operator">!</span><span class="token function">IS_ALIGNED</span><span class="token punctuation">(</span><span class="token operator">*</span>offp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got transaction with invalid offset, %lld\n"</span><span class="token punctuation">,</span>
					  proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span><span class="token operator">*</span>offp<span class="token punctuation">)</span><span class="token punctuation">;</span>
			return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_bad_offset<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		fp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">flat_binder_object</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>data <span class="token operator">+</span> <span class="token operator">*</span>offp<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> BINDER_TYPE_BINDER<span class="token operator">:</span>
		<span class="token keyword">case</span> BINDER_TYPE_WEAK_BINDER<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_ref</span> <span class="token operator">*</span>ref<span class="token punctuation">;</span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_node</span> <span class="token operator">*</span>node <span class="token operator">=</span> <span class="token function">binder_get_node</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>binder<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				node <span class="token operator">=</span> <span class="token function">binder_new_node</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>binder<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
					<span class="token keyword">goto</span> err_binder_new_node_failed<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				node<span class="token operator">-&gt;</span>min_priority <span class="token operator">=</span> fp<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> FLAT_BINDER_FLAG_PRIORITY_MASK<span class="token punctuation">;</span>
				node<span class="token operator">-&gt;</span>accept_fds <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> FLAT_BINDER_FLAG_ACCEPTS_FDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>cookie <span class="token operator">!=</span> node<span class="token operator">-&gt;</span>cookie<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d sending u%016llx node %d, cookie mismatch %016llx != %016llx\n"</span><span class="token punctuation">,</span>
					proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span>
					<span class="token punctuation">(</span>u64<span class="token punctuation">)</span>fp<span class="token operator">-&gt;</span>binder<span class="token punctuation">,</span> node<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span>
					<span class="token punctuation">(</span>u64<span class="token punctuation">)</span>fp<span class="token operator">-&gt;</span>cookie<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>node<span class="token operator">-&gt;</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
				return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
				<span class="token keyword">goto</span> err_binder_get_ref_for_node_failed<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			ref <span class="token operator">=</span> <span class="token function">binder_get_ref_for_node</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
				<span class="token keyword">goto</span> err_binder_get_ref_for_node_failed<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>type <span class="token operator">==</span> BINDER_TYPE_BINDER<span class="token punctuation">)</span>
				fp<span class="token operator">-&gt;</span>type <span class="token operator">=</span> BINDER_TYPE_HANDLE<span class="token punctuation">;</span>
			<span class="token keyword">else</span>
				fp<span class="token operator">-&gt;</span>type <span class="token operator">=</span> BINDER_TYPE_WEAK_HANDLE<span class="token punctuation">;</span>
			fp<span class="token operator">-&gt;</span>handle <span class="token operator">=</span> ref<span class="token operator">-&gt;</span>desc<span class="token punctuation">;</span>
			<span class="token function">binder_inc_ref</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>type <span class="token operator">==</span> BINDER_TYPE_HANDLE<span class="token punctuation">,</span>
					   <span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token function">trace_binder_transaction_node_to_ref</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> node<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_TRANSACTION<span class="token punctuation">,</span>
					 <span class="token string">"        node %d u%016llx -&gt; ref %d desc %d\n"</span><span class="token punctuation">,</span>
					 node<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>node<span class="token operator">-&gt;</span>ptr<span class="token punctuation">,</span>
					 ref<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span> ref<span class="token operator">-&gt;</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> BINDER_TYPE_HANDLE<span class="token operator">:</span>
		<span class="token keyword">case</span> BINDER_TYPE_WEAK_HANDLE<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">struct</span> <span class="token class-name">binder_ref</span> <span class="token operator">*</span>ref <span class="token operator">=</span> <span class="token function">binder_get_ref</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got transaction with invalid handle, %d\n"</span><span class="token punctuation">,</span>
						proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span>
						thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
				return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
				<span class="token keyword">goto</span> err_binder_get_ref_failed<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>proc <span class="token operator">==</span> target_proc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>type <span class="token operator">==</span> BINDER_TYPE_HANDLE<span class="token punctuation">)</span>
					fp<span class="token operator">-&gt;</span>type <span class="token operator">=</span> BINDER_TYPE_BINDER<span class="token punctuation">;</span>
				<span class="token keyword">else</span>
					fp<span class="token operator">-&gt;</span>type <span class="token operator">=</span> BINDER_TYPE_WEAK_BINDER<span class="token punctuation">;</span>
				fp<span class="token operator">-&gt;</span>binder <span class="token operator">=</span> ref<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>ptr<span class="token punctuation">;</span>
				fp<span class="token operator">-&gt;</span>cookie <span class="token operator">=</span> ref<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>cookie<span class="token punctuation">;</span>
				<span class="token function">binder_inc_node</span><span class="token punctuation">(</span>ref<span class="token operator">-&gt;</span>node<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>type <span class="token operator">==</span> BINDER_TYPE_BINDER<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">trace_binder_transaction_ref_to_node</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_TRANSACTION<span class="token punctuation">,</span>
						 <span class="token string">"        ref %d desc %d -&gt; node %d u%016llx\n"</span><span class="token punctuation">,</span>
						 ref<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span> ref<span class="token operator">-&gt;</span>desc<span class="token punctuation">,</span> ref<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span>
						 <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>ref<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">struct</span> <span class="token class-name">binder_ref</span> <span class="token operator">*</span>new_ref<span class="token punctuation">;</span>

				new_ref <span class="token operator">=</span> <span class="token function">binder_get_ref_for_node</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> ref<span class="token operator">-&gt;</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>new_ref <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
					<span class="token keyword">goto</span> err_binder_get_ref_for_node_failed<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				fp<span class="token operator">-&gt;</span>handle <span class="token operator">=</span> new_ref<span class="token operator">-&gt;</span>desc<span class="token punctuation">;</span>
				<span class="token function">binder_inc_ref</span><span class="token punctuation">(</span>new_ref<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>type <span class="token operator">==</span> BINDER_TYPE_HANDLE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">trace_binder_transaction_ref_to_ref</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> ref<span class="token punctuation">,</span>
									new_ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_TRANSACTION<span class="token punctuation">,</span>
						 <span class="token string">"        ref %d desc %d -&gt; ref %d desc %d (node %d)\n"</span><span class="token punctuation">,</span>
						 ref<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span> ref<span class="token operator">-&gt;</span>desc<span class="token punctuation">,</span> new_ref<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">,</span>
						 new_ref<span class="token operator">-&gt;</span>desc<span class="token punctuation">,</span> ref<span class="token operator">-&gt;</span>node<span class="token operator">-&gt;</span>debug_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

		<span class="token keyword">case</span> BINDER_TYPE_FD<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span> target_fd<span class="token punctuation">;</span>
			<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>in_reply_to<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ACCEPT_FDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got reply with fd, %d, but target does not allow fds\n"</span><span class="token punctuation">,</span>
						proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
					return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
					<span class="token keyword">goto</span> err_fd_not_allowed<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>target_node<span class="token operator">-&gt;</span>accept_fds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got transaction with fd, %d, but target does not allow fds\n"</span><span class="token punctuation">,</span>
					proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
				return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
				<span class="token keyword">goto</span> err_fd_not_allowed<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			file <span class="token operator">=</span> <span class="token function">fget</span><span class="token punctuation">(</span>fp<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got transaction with invalid fd, %d\n"</span><span class="token punctuation">,</span>
					proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
				return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
				<span class="token keyword">goto</span> err_fget_failed<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			target_fd <span class="token operator">=</span> <span class="token function">task_get_unused_fd_flags</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>target_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">fput</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
				return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
				<span class="token keyword">goto</span> err_get_unused_fd_failed<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">task_fd_install</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> target_fd<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">trace_binder_transaction_fd</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>handle<span class="token punctuation">,</span> target_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_TRANSACTION<span class="token punctuation">,</span>
					 <span class="token string">"        fd %d -&gt; %d\n"</span><span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>handle<span class="token punctuation">,</span> target_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">/* TODO: fput? */</span>
			fp<span class="token operator">-&gt;</span>handle <span class="token operator">=</span> target_fd<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

		<span class="token keyword">default</span><span class="token operator">:</span>
			<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got transaction with invalid object type, %x\n"</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> fp<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
			return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
			<span class="token keyword">goto</span> err_bad_object_type<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">BUG_ON</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>async_transaction <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">binder_pop_transaction</span><span class="token punctuation">(</span>target_thread<span class="token punctuation">,</span> in_reply_to<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> TF_ONE_WAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">BUG_ON</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>async_transaction <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		t<span class="token operator">-&gt;</span>need_reply <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		t<span class="token operator">-&gt;</span>from_parent <span class="token operator">=</span> thread<span class="token operator">-&gt;</span>transaction_stack<span class="token punctuation">;</span>
		thread<span class="token operator">-&gt;</span>transaction_stack <span class="token operator">=</span> t<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">BUG_ON</span><span class="token punctuation">(</span>target_node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">BUG_ON</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>async_transaction <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>target_node<span class="token operator">-&gt;</span>has_async_transaction<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			target_list <span class="token operator">=</span> <span class="token operator">&amp;</span>target_node<span class="token operator">-&gt;</span>async_todo<span class="token punctuation">;</span>
			target_wait <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span>
			target_node<span class="token operator">-&gt;</span>has_async_transaction <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	t<span class="token operator">-&gt;</span>work<span class="token punctuation">.</span>type <span class="token operator">=</span> BINDER_WORK_TRANSACTION<span class="token punctuation">;</span>
	<span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token operator">-&gt;</span>work<span class="token punctuation">.</span>entry<span class="token punctuation">,</span> target_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
	tcomplete<span class="token operator">-&gt;</span>type <span class="token operator">=</span> BINDER_WORK_TRANSACTION_COMPLETE<span class="token punctuation">;</span>
	<span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tcomplete<span class="token operator">-&gt;</span>entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>target_wait<span class="token punctuation">)</span>
		<span class="token function">wake_up_interruptible</span><span class="token punctuation">(</span>target_wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>

err_get_unused_fd_failed<span class="token operator">:</span>
err_fget_failed<span class="token operator">:</span>
err_fd_not_allowed<span class="token operator">:</span>
err_binder_get_ref_for_node_failed<span class="token operator">:</span>
err_binder_get_ref_failed<span class="token operator">:</span>
err_binder_new_node_failed<span class="token operator">:</span>
err_bad_object_type<span class="token operator">:</span>
err_bad_offset<span class="token operator">:</span>
err_copy_data_failed<span class="token operator">:</span>
	<span class="token function">trace_binder_transaction_failed_buffer_release</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">binder_transaction_buffer_release</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">,</span> offp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>transaction <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token function">binder_free_buf</span><span class="token punctuation">(</span>target_proc<span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
err_binder_alloc_buf_failed<span class="token operator">:</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span>tcomplete<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">binder_stats_deleted</span><span class="token punctuation">(</span>BINDER_STAT_TRANSACTION_COMPLETE<span class="token punctuation">)</span><span class="token punctuation">;</span>
err_alloc_tcomplete_failed<span class="token operator">:</span>
	<span class="token function">kfree</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">binder_stats_deleted</span><span class="token punctuation">(</span>BINDER_STAT_TRANSACTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
err_alloc_t_failed<span class="token operator">:</span>
err_bad_call_stack<span class="token operator">:</span>
err_empty_call_stack<span class="token operator">:</span>
err_dead_binder<span class="token operator">:</span>
err_invalid_target_handle<span class="token operator">:</span>
err_no_context_mgr_node<span class="token operator">:</span>
	<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_FAILED_TRANSACTION<span class="token punctuation">,</span>
			 <span class="token string">"%d:%d transaction failed %d, size %lld-%lld\n"</span><span class="token punctuation">,</span>
			 proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> return_error<span class="token punctuation">,</span>
			 <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">,</span> <span class="token punctuation">(</span>u64<span class="token punctuation">)</span>tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">struct</span> <span class="token class-name">binder_transaction_log_entry</span> <span class="token operator">*</span>fe<span class="token punctuation">;</span>

		fe <span class="token operator">=</span> <span class="token function">binder_transaction_log_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binder_transaction_log_failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span>fe <span class="token operator">=</span> <span class="token operator">*</span>e<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">BUG_ON</span><span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span>return_error <span class="token operator">!=</span> BR_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>in_reply_to<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		thread<span class="token operator">-&gt;</span>return_error <span class="token operator">=</span> BR_TRANSACTION_COMPLETE<span class="token punctuation">;</span>
		<span class="token function">binder_send_failed_reply</span><span class="token punctuation">(</span>in_reply_to<span class="token punctuation">,</span> return_error<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span>
		thread<span class="token operator">-&gt;</span>return_error <span class="token operator">=</span> return_error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个过程非常重要，分两种情况来说：</p> 
<ol><li>当请求服务的进程与服务属于不同进程，则为请求服务所在进程创建binder_ref 对象，指向服务进程中的 binder_node;</li><li>当请求服务的进程与服务属于同一进程，则不再创建新对象，只是引用计数 加 1 ， 并 且 修 改 type 为 BINDER_TYPE_BINDER 或BINDER_TYPE_WEAK_BINDER。</li></ol> 
<h4><a id="444__1948"></a>4.4.4 数据拷贝</h4> 
<p>一次数据拷贝，发生在Client端:copy_from_user<br> binder.c</p> 
<pre><code class="prism language-c">	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>buffer<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>
			   tr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> tr<span class="token operator">-&gt;</span>data_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got transaction with invalid data ptr\n"</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_copy_data_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>offp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span>
			   tr<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">.</span>offsets<span class="token punctuation">,</span> tr<span class="token operator">-&gt;</span>offsets_size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">binder_user_error</span><span class="token punctuation">(</span><span class="token string">"%d:%d got transaction with invalid offsets ptr\n"</span><span class="token punctuation">,</span>
				proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		return_error <span class="token operator">=</span> BR_FAILED_REPLY<span class="token punctuation">;</span>
		<span class="token keyword">goto</span> err_copy_data_failed<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>准确来说是一次拷贝分开两次操作，<code>一次信息的拷贝（就像请求头部），第二次数据的拷贝</code></p> 
<h4><a id="445_transction_task_1968"></a>4.4.5 transction_task</h4> 
<p>发送端与接收端<br> 传输流程<br> 服务使用</p> 
<h4><a id="446_server_1972"></a>4.4.6 server线程</h4> 
<p>有多个<code>client</code>发送请求时<code>server</code>会忙不过来，导致创建多个线程。<code>client请求</code>时会将数据放至<code>todo链表</code>，并且会<code>唤醒等待wait队列的线程</code>，如果有线程在wait队列中等待表示server忙得过来，如果没有表示忙不过来。此时驱动会向应用程序反馈，你应该多创建一些线程来处理。</p> 
<p>驱动向APP发出“创建新线程请求”的条件</p> 
<blockquote> 
 <p>proc-&gt;requested_threads=0， 未处理的新线程请求。<br> proc-&gt;ready_threads为0，空闲的线程数<br> proc-&gt;requested_threads_started &lt; proc-&gt;max_threads。 已启动的线程数&lt;max_threads</p> 
</blockquote> 
<pre><code class="prism language-c">	<span class="token operator">*</span>consumed <span class="token operator">=</span> ptr <span class="token operator">-</span> buffer<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>proc<span class="token operator">-&gt;</span>requested_threads <span class="token operator">+</span> proc<span class="token operator">-&gt;</span>ready_threads <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
	    proc<span class="token operator">-&gt;</span>requested_threads_started <span class="token operator">&lt;</span> proc<span class="token operator">-&gt;</span>max_threads <span class="token operator">&amp;&amp;</span>
	    <span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span>looper <span class="token operator">&amp;</span> <span class="token punctuation">(</span>BINDER_LOOPER_STATE_REGISTERED <span class="token operator">|</span>
	     BINDER_LOOPER_STATE_ENTERED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">/* the user-space code fails to */</span>
	     <span class="token comment">/*spawn a new thread if we leave this out */</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		proc<span class="token operator">-&gt;</span>requested_threads<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">binder_debug</span><span class="token punctuation">(</span>BINDER_DEBUG_THREADS<span class="token punctuation">,</span>
			     <span class="token string">"binder: %d:%d BR_SPAWN_LOOPER\n"</span><span class="token punctuation">,</span>
			     proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token function">SAMPLE_INFO</span><span class="token punctuation">(</span><span class="token string">"%s (%d, %d) [%s]"</span><span class="token punctuation">,</span> proc<span class="token operator">-&gt;</span>tsk<span class="token operator">-&gt;</span>comm<span class="token punctuation">,</span> proc<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> thread<span class="token operator">-&gt;</span>pid<span class="token punctuation">,</span> <span class="token function">binder_cmd_name</span><span class="token punctuation">(</span>BR_SPAWN_LOOPER<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">put_user</span><span class="token punctuation">(</span>BR_SPAWN_LOOPER<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<p>当创建好新线程后，新线程会执行ioctl表明已经进入了loop<br> binder_thread_write<br> case BC_REGISTER_LOOPER:<br> proc-&gt;requested_threads_started++;在此设置了thread_started增加线程的数量</p> 
<p>如何创建新线程</p> 
<ol><li>设置max_threads<br> proc-&gt;max_threads = 0。<br> binder_ioctl<br> case BINDER_SET_MAX_THREADS<br> copy_from_user(&amp;proc-&gt;max_threads, ubuf, sizeof(proc-&gt;max_threads)</li><li>收到BR_SPAWN_LOOPER。<br> 创建线程时为什么使用pthread_create()而不使用fork。因为fork会复制mmap的地址，mmap地址设置为不可复制</li><li>再ioctl BC_REGISTER_LOOPER表示已经正常运行了。<br> 在驱动中会更新如下两个变量。<br> switch BC_REGISTER_LOOPER<br> proc-&gt;requested_threads–;<br> proc-&gt;requested_threads_started++;</li><li>向主线一进进入循环体，读驱动、处理。</li></ol> 
<h2><a id="5__2018"></a>5 面试题</h2> 
<h3><a id="1Binder__2019"></a>1.Binder 的优缺点</h3> 
<p><strong>优点：</strong></p> 
<blockquote> 
 <ol><li>性能方面<br> 共享内存 0 次数据拷贝<br> Binder 1 次数据拷贝<br> Socket/管道/消息队列 2 次数据拷贝</li></ol> 
</blockquote> 
<blockquote> 
 <ol start="2"><li>稳定性方面<br> Binder：基于 C/S 架构，客户端（Client）有什么需求就丢给服务端（Server）去完成，<br> 架构清晰、职责明确又相互独立，自然稳定性更好<br> 共享内存：虽然无需拷贝，但是控制复杂，难以使用<br> 从稳定性的角度讲，Binder 机制是优于内存共享的。</li></ol> 
</blockquote> 
<blockquote> 
 <ol start="3"><li>安全性方面<br> 传统的 IPC 没有任何安全措施，安全依赖上层协议来确保。<br> 传统的 IPC 方法无法获得对方可靠的进程用户 ID/进程 UI（UID/PID），从而无法鉴<br> 别对方身份。<br> 传统的 IPC 只能由用户在数据包中填入 UID/PID，容易被恶意程序利用。<br> 传统的 IPC 访问接入点是开放的，无法阻止恶意程序通过猜测接收方地址获得连接。<br> Binder 既支持实名 Binder，又支持匿名 Binder，安全性高。</li></ol> 
</blockquote> 
<blockquote> 
 <ol start="4"><li>从语言层面的角度<br> 大家多知道Linux是基于C语言(面向过程的语言)，而Android是基于Java语言(面向对象的语句)，而对于Binder恰恰也符合面向对象的思想，将进程间通信转化为通过对某个Binder对象的引用调用该对象的方法，而其独特之处在于Binder对象是一个可以跨进程引用的对象，它的实体位于一个进程中，而它的引用却遍布于系统的各个进程之中。可以从一个进程传给其它进程，让大家都能访问同一Server，就像将一个对象或引用赋值给另一个引用一样。Binder模糊了进程边界，淡化了进程间通信过程，整个系统仿佛运行于同一个面向对象的程序之中。从语言层面，Binder更适合基于面向对象语言的Android系统，对于Linux系统可能会有点“水土不服”。</li></ol> 
</blockquote> 
<blockquote> 
 <ol start="5"><li>从公司战略的角度<br> 众所周知，Linux内核是开源的系统，所开放源代码许可协议GPL保护，该协议具有“病毒式感染”的能力，怎么理解这句话呢？受GPL保护的Linux Kernel是运行在内核空间，对于上层的任何类库、服务、应用等运行在用户空间，一旦进行SysCall（系统调用），调用到底层Kernel，那么也必须遵循GPL协议。<br> 而Android 之父 Andy Rubin对于GPL显然是不能接受的，为此，Google巧妙地将GPL协议控制在内核空间，将用户空间的协议采用Apache-2.0协议（允许基于Android的开发商不向社区反馈源码），同时在GPL协议与Apache-2.0之间的Lib库中采用BSD证授权方法，有效隔断了GPL的传染性，仍有较大争议，但至少目前缓解Android，让GPL止步于内核空间，这是Google在GPL Linux下 开源与商业化共存的一个成功典范。</li></ol> 
</blockquote> 
<p><strong>缺点：</strong></p> 
<blockquote> 
 <ol><li>Binder共享内存耗尽<br> Binder的性能（减少一次copy_to_user）和安全是最大优势，但由于Binder在内核和用户态都对传输的数据量有限制，因此要避免通过Binder传输大量数据。一个进程用于接收Binder数据的共享内存为1M-8K，对于oneway要减半。同时，Binder driver也有4M上限的限制，当多个线程共用这块共享内存时，一旦driver发现数据接收方共享内存不够，就会返回错误。<br> Binder共享内存耗尽的影响：<br> Binder调用耗时长，甚至失败；<br> 若是用户操作的关键流程，则会导致卡顿发生。<br> 优化建议：<br> 及时释放data(Server端)或reply(Client端)，建议用AIDL框架；<br> Binder接口设计时避免大数据的参数传递，若有需要可用Ashmem传递；<br> 避免短时间内大量线程同时并行调用某Server，若有需要，需做削峰处理。</li></ol> 
</blockquote> 
<blockquote> 
 <ol start="2"><li>Binder线程池耗尽<br> Server端有一定数量的Binder线程池来响应Client的调用，一个进程的Binder线程数默认最大是16（1个主线程和15个非主线程），超过的请求会被阻塞等待空闲的Binder线程，即Binder线程池耗尽会导致后面的调用被阻塞。<br> Binder线程池耗尽的影响：<br> 同步调用的Client端被阻塞，若是用户操作的关键流程中，则发生卡顿现象；<br> system_server等系统关键服务进程的Binder线程池耗尽，则造成整机卡顿。<br> 优化建议：<br> 避免短时间内大量线程同时并行调用某Server，若有需要则需做削峰处理；<br> 提升Binder接口实现的执行效率。</li></ol> 
</blockquote> 
<blockquote> 
 <ol start="3"><li>创建大量BpBinder或Binder对象<br> BpBinder是客户端中的Binder引用，保存着目标服务的handle信息，即服务端的Binder实体的引用信息，用于查询内核中的Binder节点，并同Binder实体通信。<br> 系统并未限制Server端的Binder对象创建，理论来说可以大量创建，但一个Service应该仅创建一个Binder对象，BpBinder对象有上限6000/2500个，多了会被杀掉，因此建议同一个Service的BpBinder实现进程内共用。<br> 创建大量BpBinder或Binder对象的影响：<br> 内存占用，频繁GC，甚至因OOM而闪退；<br> 整机卡顿。<br> 优化建议：<br> 一个Service仅一个Binder对象实例，按使用场景和生命周期合并Service；<br> 及时释放不再使用的BpBinder。</li></ol> 
</blockquote> 
<blockquote> 
 <ol start="4"><li>使用多个ServiceConnection对象Bind同一个Service<br> ServiceConnection其实也是一个Service，提供给AMS维护，用于管理目标Service的回调。同一个ServiceConnection对象可以管理多个Service，Client端已做到对不同Service的复用，AMS仅维护一个IServiceConnection；但不同ServiceConnection对象没有做到复用，即使是同一个Service。<br> 使用多个ServiceConnection对象Bind同一个Service的影响：<br> 增加AMS的维护负担，Service的启动/退出都会持有AMS锁后遍历SC；<br> 长时间持有AMS锁，导致整机卡顿。<br> 优化建议：<br> 复用同一个ServiceConnection对象，特别是同一个Service；<br> 监听Service的死亡回调，若有需要可立即重新Bind；<br> 及时unbind不再使用的Service。</li></ol> 
</blockquote> 
<blockquote> 
 <ol start="5"><li>随用随获取系统服务<br> 系统服务由ServiceManager维护，获取系统服务IBinder的过程也是一次跨进程Binder调用。应用常用的系统服务在应用进程启动时就已由ATMS带过去了，而其他系统服务系统对普通应用使用hiden接口来限制。当出现频繁调checkService接口的，主要是系统服务或系统应用。<br> 随用随获取系统服务影响：<br> 不必要的跨进程同步调用耗时1ms左右，有些甚至达到s级（logcat -b events -s service_manager_slow）；<br> 增加系统负荷。<br> 优化建议：<br> 一次获取成功后本地缓存；<br> 通过IBinder的linkToDeath机制感知到服务的退出，服务退出后清除本地IBinder缓存，下次需要时再次向Servicemanager获取。</li></ol> 
</blockquote> 
<h3><a id="2Binder_mmap_2097"></a>2.Binder 是如何做到一次拷贝的(mmap如何实现一次拷贝)</h3> 
<p>主要是因为 Linux 是使用的虚拟内存寻址方式，它有如下特性：</p> 
<ol><li>用户空间的虚拟内存地址是映射到物理内存中的</li><li>对虚拟内存的读写实际上是对物理内存的读写，这个过程就是内存映射</li><li>这个内存映射过程是通过系统调用 mmap()来实现。<br> Binder 借助了内存映射的方法，在内核空间和接收方用户空间的数据缓存区之间做了一层内存映射，就相当于直接拷贝到了接收方用户空间的数据缓存区，从而减少了一次数据拷贝</li></ol> 
<p>Client与Server处于不同进程有着不同的虚拟地址规则，所以无法直接通信。<br> 而一个页框可以映射给多个页，那么就可以将一块物理内存分别与Client和Server的虚拟内存块进行映射。<br> 如图，Client就只需copy_from_user进行一次数据拷贝，Server进程就能读取到数据了。<br> 另外映射的虚拟内存块大小将近**<code>1M(1M-8K)</code>**，所以IPC通信传输的数据量也被限制为此值。<br> <strong>(注：实际上是一次拷贝分开两次操作，分别为头部信息拷贝和数据拷贝)</strong><br> <img src="https://images2.imgbox.com/9a/5f/86EYJvrv_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="3MMAP__2111"></a>3.MMAP 的内存映射原理了解吗</h3> 
<p>MMAP 内存映射的实现过程，总的来说可以分为三个阶段：<br> （一）进程启动映射过程，并在虚拟地址空间中为映射创建虚拟映射区域</p> 
<ol><li>进程在用户空间调用库函数 mmap，原型：void *mmap(void *start, size_t length, int<br> prot, int flags, int fd, off_t offset);</li><li>在当前进程的虚拟地址空间中，寻找一段空闲的满足要求的连续的虚拟地址</li><li>为此虚拟区分配一个 vm_area_struct 结构，接着对这个结构的各个域进行了初始化</li><li>将新建的虚拟区结构（vm_area_struct）插入进程的虚拟地址区域链表或树中</li></ol> 
<p>（二）调用内核空间的系统调用函数 mmap（不同于用户空间函数），实现文件<br> 物理地址和进程虚拟地址的一一映射关系</p> 
<ol><li>为映射分配了新的虚拟地址区域后，通过待映射的文件指针，在文件描述符表中找<br> 到对应的文件描述符，通过文件描述符，链接到内核“已打开文件集”中该文件的文<br> 件结构体（struct file），每个文件结构体维护着和这个已打开文件相关各项信息。</li><li>通过该文件的文件结构体，链接到 file_operations 模块，调用内核函数 mmap，其原<br> 型为：int mmap(struct file *filp, struct vm_area_struct *vma)，不同于用户空间库函数。</li><li>内核 mmap 函数通过虚拟文件系统 inode 模块定位到文件磁盘物理地址。</li><li>通过 remap_pfn_range 函数建立页表，即实现了文件地址和虚拟地址区域的映射关<br> 系。此时，这片虚拟地址并没有任何数据关联到主存中。</li></ol> 
<p>（三）进程发起对这片映射空间的访问，引发缺页异常，实现文件内容到物理<br> 内存（主存）的拷贝<br> 注：前两个阶段仅在于创建虚拟区间并完成地址映射，但是并没有将任何文件数<br> 据的拷贝至主存。真正的文件读取是当进程发起读或写操作时。<br> 进程的读或写操作访问虚拟地址空间这一段映射地址，通过查询页表，发现这一<br> 段地址并不在物理页面上。因为目前只建立了地址映射，真正的硬盘数据还没有<br> 拷贝到内存中，因此引发缺页异常。</p> 
<ol><li>缺页异常进行一系列判断，确定无非法操作后，内核发起请求调页过程。</li><li>调页过程先在交换缓存空间（swap cache）中寻找需要访问的内存页，如果没有则<br> 调用 nopage 函数把所缺的页从磁盘装入到主存中。</li><li>之后进程即可对这片主存进行读或者写的操作，如果写操作改变了其内容，一定时<br> 间后系统会自动回写脏页面到对应磁盘地址，也即完成了写入到文件的过程。</li></ol> 
<p>注：修改过的脏页面并不会立即更新回文件中，而是有一段时间的延迟，可以调<br> 用 msync()来强制同步, 这样所写的内容就能立即保存到文件里了。</p> 
<h3><a id="4Binder__2147"></a>4.Binder 机制是如何跨进程的</h3> 
<p>1.Binder 驱动<br> 在内核空间创建一块接收缓存区，<br> 实现地址映射：将内核缓存区、接收进程用户空间映射到同一接收缓存区<br> 2.发送进程通过系统调用（copy_from_user）将数据发送到内核缓存区。由于内<br> 核缓存区和接收进程用户空间存在映射关系，故相当于也发送了接收进程的用户<br> 空间，实现了跨进程通信。</p> 
<h3><a id="5_2154"></a>5.说说四大组件的通信机制</h3> 
<ol><li>activity<br> （1）一个 Activity 通常就是一个单独的屏幕（窗口）。<br> （2）Activity 之间通过 Intent 进行通信。<br> （3）android 应用中每一个 Activity 都必须要在 AndroidManifest.xml 配置文件中<br> 声明，否则系统将不识别也不执行该 Activity。</li><li>service<br> （1）service 用于在后台完成用户指定的操作。service 分为两种：<br> started（启动）：当应用程序组件（如 activity）调用 startService()方法启动服务时，<br> 服务处于 started 状态。<br> bound（绑定）：当应用程序组件调用 bindService()方法绑定到服务时，服务处于 bound<br> 状态。<br> (2)startService()与 bindService()区别：<br> started service（启动服务）是由其他组件调用 startService()方法启动的，这导致服务<br> 的 onStartCommand()方法被调用。当服务是 started 状态时，其生命周期与启动它的<br> 组件无关，并且可以在后台无限期运行，即使启动服务的组件已经被销毁。因此，<br> 服务需要在完成任务后调用 stopSelf()方法停止，或者由其他组件调用 stopService()<br> 方法停止。<br> 使用 bindService()方法启用服务，调用者与服务绑定在了一起，调用者一旦退出，服<br> 务也就终止，大有“不求同时生，必须同时死”的特点。<br> (3)开发人员需要在应用程序配置文件中声明全部的 service，使用<br> 标签。<br> (4)Service 通常位于后台运行，它一般不需要与用户交互，因此 Service 组件没有<br> 图形用户界面。Service 组件需要继承 Service 基类。Service 组件通常用于为其他<br> 组件提供后台服务或监控其他组件的运行状态。</li><li>content provider<br> （1）android 平台提供了 Content Provider 使一个应用程序的指定数据集提供给<br> 其他应用程序。其他应用可以通过 ContentResolver 类从该内容提供者中获取或<br> 存入数据。<br> （2）只有需要在多个应用程序间共享数据是才需要内容提供者。例如，通讯录<br> 数据被多个应用程序使用，且必须存储在一个内容提供者中。它的好处是统一数<br> 据访问方式。<br> （3）ContentProvider 实现数据共享。ContentProvider 用于保存和获取数据，并<br> 使其对所有应用程序可见。这是不同应用程序间共享数据的唯一方式，因为<br> android 没有提供所有应用共同访问的公共存储区。<br> （4）开发人员不会直接使用 ContentProvider 类的对象，大多数是通过<br> ContentResolver 对象实现对 ContentProvider 的操作。<br> （5）ContentProvider 使用 URI 来唯一标识其数据集，这里的 URI 以 content://<br> 作为前缀，表示该数据由 ContentProvider 来管理。</li><li>broadcast receiver<br> （1）你的应用可以使用它对外部事件进行过滤，只对感兴趣的外部事件(如当电<br> 话呼入时，或者数据网络可用时)进行接收并做出响应。广播接收器没有用户界<br> 面。然而，它们可以启动一个 activity 或 serice 来响应它们收到的信息，或者用<br> NotificationManager 来通知用户。通知可以用很多种方式来吸引用户的注意力，<br> 例如闪动背灯、震动、播放声音等。一般来说是在状态栏上放一个持久的图标，<br> 用户可以打开它并获取消息。<br> （2）广播接收者的注册有两种方法，分别是程序动态注册和 AndroidManifest 文<br> 件中进行静态注册。<br> （3）动态注册广播接收器特点是当用来注册的 Activity 关掉后，广播也就失效了。<br> 静态注册无需担忧广播接收器是否被关闭，只要设备是开启状态，广播接收器也<br> 是打开着的。也就是说哪怕 app 本身未启动，该 app 订阅的广播在触发时也会对<br> 它起作用。</li></ol> 
<h3><a id="6_Intent__2206"></a>6.为什么 Intent 不能传递大数据</h3> 
<p>Intent 携带信息的大小其实是受 Binder 限制。数据以 Parcel 对象的形式存放在<br> Binder 传递缓存中。如果数据或返回值比传递 buffer 大，则此次传递调用失败并<br> 抛出 TransactionTooLargeException 异常。<br> Binder 传递缓存有一个限定大小，通常是 1Mb。但同一个进程中所有的传输共享<br> 缓存空间。多个地方在进行传输时，即时它们各自传输的数据不超出大小限制，<br> TransactionTooLargeException 异常也可能会被抛出。在使用 Intent 传递数据时，<br> 1Mb 并不是安全上限。因为 Binder 中可能正在处理其它的传输工作。不同的机<br> 型和系统版本，这个上限值也可能会不同。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/823362637ee39e45d392f344950e97d9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Go项目配置管理神器之viper使用详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3d9c67d2608e2aa3fab5dd962a06b8a0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Sql Server：创建用户并指定该用户只能看指定的视图，除此之外的都不让查看</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>