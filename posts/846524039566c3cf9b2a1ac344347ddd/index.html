<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【mongo事务】使用docker-compose启动mongo,‘单副本模式‘实现支持事务。 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【mongo事务】使用docker-compose启动mongo,‘单副本模式‘实现支持事务。" />
<meta property="og:description" content="想要mongo支持事务的首要条件是mongo版本4.x 以上，且为复制集模式。由于很多时候使用mongo都不需要部署多副本，但是想支持事务，所以可以使用‘单副本模式’，既能保证mongo实例只有一个，又是复制集模式。
本文使用mongo5.0.8作为样例。
本文只是日常遇到问题的小记，如有错误，欢迎指出。
首先给出docker-compose.yml version: &#39;3.0&#39; services: mongo: image: mongo:5.0.8 restart: unless-stopped container_name: mongodb command: --replSet rs0 --bind_ip_all --keyFile /data/mongodb/keyFile environment: TZ: &#39;Asia/Shanghai&#39; #用户名密码 MONGO_INITDB_ROOT_USERNAME: &#39;admin&#39; MONGO_INITDB_ROOT_PASSWORD: &#39;password&#39; ports: - 27017:27017 volumes: - ./mongodb/data:/data/db - ./mongodb/keyFile:/data/mongodb/keyFile 准备keyFile 本人粗略测试在4.x版本不需要使用keyFile,但是在5.x版本是必须要KeyFile的，不然会报 “BadValue: security.keyFile is required when authorization is enabled with replica sets”
生成keyFile openssl rand -base64 128 &gt; ./mongodb/keyFile 其中 ./keyFile 是指定生成文件的名字以及在哪一个文件夹下
设置权限以及所属用户 keyFile文件的权限必须为600,如果权限太大，启动时会报“error opening file: /data/mongodb/keyFile: bad file”
当权限改为600以后还需要把keyFile文件的所属用户和用户组改为mongodb不然在启动时会报&#34;permissions on /data/mongodb/keyFile are too open&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/846524039566c3cf9b2a1ac344347ddd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-03T14:32:56+08:00" />
<meta property="article:modified_time" content="2023-11-03T14:32:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【mongo事务】使用docker-compose启动mongo,‘单副本模式‘实现支持事务。</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>想要mongo支持事务的首要条件是mongo版本4.x 以上，且为复制集模式。由于很多时候使用mongo都不需要部署多副本，但是想支持事务，所以可以使用‘单副本模式’，既能保证mongo实例只有一个，又是复制集模式。<br> 本文使用mongo5.0.8作为样例。</strong></p> 
<p>本文只是日常遇到问题的小记，如有错误，欢迎指出。</p> 
<h5><a id="dockercomposeyml_5"></a>首先给出docker-compose.yml</h5> 
<pre><code class="prism language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.0'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">mongo</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo<span class="token punctuation">:</span>5.0.8
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> mongodb
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>replSet rs0 <span class="token punctuation">-</span><span class="token punctuation">-</span>bind_ip_all <span class="token punctuation">-</span><span class="token punctuation">-</span>keyFile /data/mongodb/keyFile
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">TZ</span><span class="token punctuation">:</span> <span class="token string">'Asia/Shanghai'</span>
      <span class="token comment">#用户名密码</span>
      <span class="token key atrule">MONGO_INITDB_ROOT_USERNAME</span><span class="token punctuation">:</span> <span class="token string">'admin'</span>
      <span class="token key atrule">MONGO_INITDB_ROOT_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">'password'</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 27017<span class="token punctuation">:</span><span class="token number">27017</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./mongodb/data<span class="token punctuation">:</span>/data/db
      <span class="token punctuation">-</span> ./mongodb/keyFile<span class="token punctuation">:</span>/data/mongodb/keyFile
</code></pre> 
<h5><a id="keyFile_28"></a>准备keyFile</h5> 
<p>本人粗略测试在4.x版本不需要使用keyFile,但是在5.x版本是必须要KeyFile的，不然会报 “BadValue: security.keyFile is required when authorization is enabled with replica sets”<br> <img src="https://images2.imgbox.com/80/63/IyW85cPv_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="keyFile_32"></a>生成keyFile</h6> 
<pre><code class="prism language-powershell">openssl rand <span class="token operator">-</span>base64 128 &gt; <span class="token punctuation">.</span><span class="token operator">/</span>mongodb/keyFile
</code></pre> 
<p>其中 ./keyFile 是指定生成文件的名字以及在哪一个文件夹下</p> 
<h6><a id="_39"></a>设置权限以及所属用户</h6> 
<p>keyFile文件的权限必须为600,如果权限太大，启动时会报“error opening file: /data/mongodb/keyFile: bad file”<br> <img src="https://images2.imgbox.com/91/3c/5eTioYI9_o.png" alt="在这里插入图片描述"><br> 当权限改为600以后还需要把keyFile文件的所属用户和用户组改为mongodb不然在启动时会报"permissions on /data/mongodb/keyFile are too open"<br> <img src="https://images2.imgbox.com/e8/50/VocjVPcQ_o.png" alt="在这里插入图片描述"><br> 由于使用容器启动所以需要把keyFile文件的所属用户和用户组 改为999，这样容器会自动把keyFile文件的所属用户和用户组改为mongodb。</p> 
<pre><code class="prism language-powershell">sudo chmod 600 keyFile
sudo chown 999:999 keyFile
</code></pre> 
<p>容器外<br> <img src="https://images2.imgbox.com/47/c4/pqT1kuO8_o.png" alt="在这里插入图片描述"><br> 容器里</p> 
<p><img src="https://images2.imgbox.com/cd/f9/LjzL25Z4_o.png" alt="在这里插入图片描述"><br> 当keyFile文件准备好以后，就可以根据上面的docker-compose.yml启动容器。</p> 
<h5><a id="_57"></a>初始化</h5> 
<p>容器启动后这时mongo还不能使用，还需要进入容器内初始化复制集。<br> 进入容器</p> 
<pre><code class="prism language-powershell">docker exec <span class="token operator">-</span>it mongodb <span class="token operator">/</span>bin/bash
</code></pre> 
<p>用刚刚设置的用户名密码进入mongo</p> 
<pre><code class="prism language-powershell">mongo <span class="token operator">-</span>u admin <span class="token operator">--</span>authenticationDatabase admin
</code></pre> 
<p><img src="https://images2.imgbox.com/50/87/td3mfQtk_o.png" alt="在这里插入图片描述"></p> 
<p>执行初始化</p> 
<pre><code class="prism language-powershell">rs<span class="token punctuation">.</span>initiate<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>显示一下就说明成功了<br> <img src="https://images2.imgbox.com/d7/c2/klYY8GGJ_o.png" alt="在这里插入图片描述"><br> 到这mongo就算是启动完成了。</p> 
<h5><a id="spring_boot_79"></a>spring boot项目配置</h5> 
<p>要想实现事务还需要在项目中进行配置</p> 
<p>spring boot 版本： 2.1.6.RELEASE</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MongoTransactionConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">MongoTransactionManager</span> <span class="token function">transactionManager</span><span class="token punctuation">(</span><span class="token class-name">MongoDbFactory</span> factory<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"开启mongo事务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MongoTransactionManager</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在spring boot高版本中MongoDbFactory被弃用需要换成MongoDatabaseFactory</p> 
<p>spring boot 版本：2.6.1</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MongoTransactionConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">MongoTransactionManager</span> <span class="token function">transactionManager</span><span class="token punctuation">(</span><span class="token class-name">MongoDatabaseFactory</span> factory<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"开启mongo事务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MongoTransactionManager</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>添加配置类以后只需要在方法上加入@Transactional注解就可以实现mongo事务了。</p> 
<hr> 
<p><strong>！！！新增！！！</strong><br> 很多时候我们会保留挂载出来的数据，重新构建容器，由于docker在每次构建新容器时都会为容器随机分配一个hostname。但因为我们还是使用上一个容器挂载出来的数据，这就导致mongo副本集配置的hostname还是上一个容器，这就导致新启动的mongo不能用。因此我们只需要改变mongo副本集配置的hostname，就能解决这个问题</p> 
<p>当我们启动mongo后直接连接会报这个错。<br> <img src="https://images2.imgbox.com/ca/ca/VTuwkGLj_o.png" alt="在这里插入图片描述"></p> 
<p>我们首先进入容器，查看当前容器的hostname<br> <img src="https://images2.imgbox.com/a0/4a/ilL9RPLX_o.png" alt="在这里插入图片描述"><br> 使用上面提到的方式，使用admin账号登陆mongo，查看config</p> 
<pre><code class="prism language-powershell">rs<span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e1/4d/TXEwlEEf_o.png" alt="在这里插入图片描述"><br> 正如上述所说config里的hostname与当前容器的不一样</p> 
<h5><a id="1hostname_131"></a>方法1：更改hostname</h5> 
<p>1.获取副本集配置</p> 
<pre><code class="prism language-powershell">config=rs<span class="token punctuation">.</span>conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>2.可以根据上面配置json的格式可以知道hostname的位置，从而对他进行重新赋值（将host改为当前容器的host）</p> 
<pre><code class="prism language-powershell">config<span class="token punctuation">.</span>members<span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">.</span>host=<span class="token string">"c3e9261f8a04:27017"</span>
</code></pre> 
<p>3.最后更新config</p> 
<pre><code class="prism language-powershell">rs<span class="token punctuation">.</span>reconfig<span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>force : true<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1e/f1/gWfL3uCd_o.png" alt="在这里插入图片描述"><br> 改完以后mongo就能正常启动了</p> 
<h5><a id="2yamlhostname_148"></a>方法2：在yaml中指定hostname</h5> 
<pre><code class="prism language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.0'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">mongo</span><span class="token punctuation">:</span>
  	<span class="token key atrule">hostname</span><span class="token punctuation">:</span> mongo501
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo<span class="token punctuation">:</span>5.0.8
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> mongodb
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>replSet rs0 <span class="token punctuation">-</span><span class="token punctuation">-</span>bind_ip_all <span class="token punctuation">-</span><span class="token punctuation">-</span>keyFile /data/mongodb/keyFile
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">TZ</span><span class="token punctuation">:</span> <span class="token string">'Asia/Shanghai'</span>
      <span class="token comment">#用户名密码</span>
      <span class="token key atrule">MONGO_INITDB_ROOT_USERNAME</span><span class="token punctuation">:</span> <span class="token string">'admin'</span>
      <span class="token key atrule">MONGO_INITDB_ROOT_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">'password'</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 27017<span class="token punctuation">:</span><span class="token number">27017</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./mongodb/data<span class="token punctuation">:</span>/data/db
      <span class="token punctuation">-</span> ./mongodb/keyFile<span class="token punctuation">:</span>/data/mongodb/keyFile
</code></pre> 
<p>这样的话每次新建的容器的hostname都是同一个了。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/059adf334e87fa95ce1c801e32f1eebd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue报错：may use special comments to disable some warnings. Use // eslint-disable-next-line to ignore</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9e4fd6a8c9a424b7176b09ae8567aa77/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">前端如何配置hosts</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>