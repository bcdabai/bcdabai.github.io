<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mongoæ—¶é—´æˆ³è½¬æ—¥æœŸä»¥åŠæ—¥æœŸåˆ†ç»„ - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Mongoæ—¶é—´æˆ³è½¬æ—¥æœŸä»¥åŠæ—¥æœŸåˆ†ç»„" />
<meta property="og:description" content="æœ€è¿‘é‡åˆ°çš„ä¸€ä¸ªæ•°æ®ç»Ÿè®¡æŠ˜çº¿å›¾çš„æ€§èƒ½ä¼˜åŒ–ç‚¹ï¼Œå¯ä»¥è¯´æ˜¯ä¸€å®šæ€ç»´ä¸Šçš„è½¬å˜ï¼Œå°±è®°å½•ä¸‹å’¯
èƒŒæ™¯ï¼šcronå®šæ—¶ä»»åŠ¡è¯»å–å½“å‰ç»Ÿè®¡æ•°æ®çš„å¼‚å¸¸å€¼ï¼Œé¢‘ç‡ä¸ºæ¯äº”åˆ†é’Ÿè®°å½•ä¸€æ¬¡ï¼ŒæŠ˜çº¿å›¾è¦æ±‚è·å–æ¯æ—¥çš„å¼‚å¸¸é¡¹å³°å€¼
æœ€ä¸€å¼€å§‹çš„æƒ³æ³•ï¼šå°†æ•°æ®è¯»å–åˆ°å†…å­˜ä¸­è¿›è¡Œæ¡ä»¶è¿‡æ»¤ã€è®¡ç®—
é¦–å…ˆæ ¹æ®æ—¶é—´æˆ³å°†æ•°æ®ä»¥æ—¥æœŸä½œä¸ºåˆ†ç»„ï¼Œå…¶æ¬¡åœ¨æ¯ä¸ªåˆ†ç»„ä¸­è·å–å¼‚å¸¸é¡¹çš„å³°å€¼æ•°æ®ï¼Œæ—¶é—´å¤æ‚åº¦O(n*n)ï¼Œæœ€å¥½ä»¥æ—¥æœŸåˆ†ç»„åˆ—è¡¨&#43;å³°å€¼æ•°æ®åˆ—è¡¨ä½œä¸ºå¯¹è±¡è¿”å›ç»“æœ
é‡åˆ°æ€§èƒ½é—®é¢˜ï¼šä¸€å¤©çš„æ•°æ®é‡ä¸º(60/5)*24=288ï¼Œé»˜è®¤æ—¥æœŸä¸º15å¤©ï¼Œåˆ™ç»Ÿè®¡çš„æ•°æ®é‡ä¸º4230ï¼Œæ¥å£è¿”å›ç”šè‡³éœ€è¦8ã€9ç§’çš„æ—¶é—´ï¼Œä½œä¸ºä¸€ä¸ªé¡¹ç›®çš„é—¨é¢æŠ˜çº¿å›¾ï¼Œè¿™ç§æƒ…å†µ è¾¾å’©ï¼
ä¼˜åŒ–çš„å¿µå¤´ï¼šæˆ‘è¦æ‹¿æ¯å¤©çš„å³°å€¼æ•°æ®ï¼Œæ€ä¹ˆæ‰èƒ½ç›´æ¥å–åˆ°æ¯å¤©çš„å³°å€¼å‘¢ï¼Œmongoçš„èšåˆæ˜¯ä¸æ˜¯å¯ä»¥åšåˆ°å•Šï¼Ÿ $groupå¯ä»¥æŒ‰æ—¥æœŸåšåˆ†ç»„ï¼Œ $maxå¯ä»¥æ‹¿åˆ°æœ€å¤§å€¼ï¼Œæ¥ä¸‹æ¥ä¸€ä¸ª $sortå¥½åƒæ˜¯å°±æˆäº†å§ï¼ è¯´å¹²å°±å¹²ï¼ï¼
æ¥ä¸‹æ¥çš„èšåˆè¯­å¥å‡ä¸ºmongo pipelineï¼Œæœ€åé™„ä¸Šgolangçš„bsonæ¡ä»¶å“ˆ
// ResultCountModel _ type ResultCountModel struct { CommonBase `json:&#34;,inline&#34; yaml:&#34;,inline&#34; bson:&#34;,inline&#34;` ErrorCount int `json:&#34;error_count&#34; bson:&#34;error_count&#34;` Timestamp int64 `json:&#34;timestamp&#34; bson:&#34;timestamp&#34;` MaxTime int64 `json:&#34;max_time&#34; bson:&#34;max_time&#34;` } æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸Šï¼Œè¿™é‡Œä½¿ç”¨CommonBaseï¼Œæ˜¯å› ä¸ºåœ¨$groupèšåˆåä¼šå¾—åˆ°_idå”¯ä¸€æ ‡è¯†å­—æ®µï¼Œå› æ­¤ä¾¿äºè·å–æœ€åçš„èšåˆç»“æœï¼Œåœ¨å®šä¹‰ç»“æ„ä½“æ—¶å°†å…¶åŠ ä¸Šï¼›timestampå•ä½ä¸ºæ¯«ç§’
1ã€æ—¥æœŸç­›é€‰ ç¬¬ä¸€æ­¥ï¼Œæ¯«æ— ç–‘é—®ï¼Œå¯¹æ—¶é—´æˆ³timestampè¿›è¡Œæ—¥æœŸçš„è¿‡æ»¤
{ $match: { timestamp: { $gte: 1671897600000, // min_timestamp $lt: 1673280000000 // max_timestamp } } } $gte å¤§äºç­‰äº
$lt å°äº
2ã€æ—¥æœŸè½¬æ¢ ç¬¬äºŒæ­¥ï¼Œæ ¹æ®æ—¶é—´æˆ³å¤§å°è¿›è¡Œæ—¥æœŸçš„è½¬æ¢ï¼Œè¿™é‡Œæ˜¯ç”¨çš„æ˜¯$projectï¼Œ å°†å…·æœ‰è¯·æ±‚å­—æ®µçš„æ–‡æ¡£ä¼ é€’åˆ°ç®¡é“ä¸­çš„ä¸‹ä¸€é˜¶æ®µã€‚æŒ‡å®šçš„å­—æ®µå¯ä»¥æ˜¯è¾“å…¥æ–‡æ¡£ä¸­çš„ç°æœ‰å­—æ®µæˆ–æ˜¯æ–°è®¡ç®—çš„å­—æ®µ
ä½¿ç”¨$projectä¸»è¦æ€è·¯æ˜¯ï¼Œå°†timestampæ—¶é—´æˆ³è½¬æ¢ä¸ºæ ‡å‡†æ—¥æœŸï¼Œä¹‹åè¾“å‡ºä¸ºæƒ³è¦çš„formatå½¢å¼ï¼›åŒæ—¶ä½¿ç”¨ $projectä¿ç•™éœ€è¦çš„å­—æ®µ
æ—¶é—´æˆ³è½¬æ¢æ—¥æœŸ æ ¸å¿ƒæ–¹æ³•ï¼š$dateToString
{ $dateToString: { date: &lt;dateExpression&gt;, format: &lt;formatString&gt;, timezone: &lt;tzExpression&gt;, onNull: &lt;expression&gt; } } date ï¼šè¦è½¬æ¢çš„å­—ç¬¦ä¸²æ—¥æœŸï¼Œå¿…é¡»æ˜¯è§£æä¸ºDateã€Timestampã€ObjectID çš„æœ‰æ•ˆè¡¨è¾¾å¼formatï¼š æ—¥æœŸæ ¼å¼è§„èŒƒtimezoneï¼šè¿ç®—ç»“æœçš„æ—¶åŒºï¼Œå¸¸ç”¨UTCåç§»é‡onNullï¼š dateä¸ºnullæˆ–ç¼ºå¤±æ—¶è¦è¿”å›çš„å€¼ æ—¥æœŸæ ¼å¼æƒ³è¦â€œæœˆä»½-æ—¥æœŸâ€ï¼Œé‚£format: â€œ%m-%dâ€" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4bb8a3fefb6f8660640b5285dbe8f5ff/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-09T16:56:26+08:00" />
<meta property="article:modified_time" content="2023-01-09T16:56:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Mongoæ—¶é—´æˆ³è½¬æ—¥æœŸä»¥åŠæ—¥æœŸåˆ†ç»„</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>æœ€è¿‘é‡åˆ°çš„ä¸€ä¸ªæ•°æ®ç»Ÿè®¡æŠ˜çº¿å›¾çš„æ€§èƒ½ä¼˜åŒ–ç‚¹ï¼Œå¯ä»¥è¯´æ˜¯ä¸€å®šæ€ç»´ä¸Šçš„è½¬å˜ï¼Œå°±è®°å½•ä¸‹å’¯<br> èƒŒæ™¯ï¼šcronå®šæ—¶ä»»åŠ¡è¯»å–å½“å‰ç»Ÿè®¡æ•°æ®çš„å¼‚å¸¸å€¼ï¼Œé¢‘ç‡ä¸ºæ¯äº”åˆ†é’Ÿè®°å½•ä¸€æ¬¡ï¼ŒæŠ˜çº¿å›¾è¦æ±‚è·å–æ¯æ—¥çš„å¼‚å¸¸é¡¹å³°å€¼</p> 
<p>æœ€ä¸€å¼€å§‹çš„æƒ³æ³•ï¼šå°†æ•°æ®è¯»å–åˆ°å†…å­˜ä¸­è¿›è¡Œæ¡ä»¶è¿‡æ»¤ã€è®¡ç®—<br> é¦–å…ˆæ ¹æ®æ—¶é—´æˆ³å°†æ•°æ®ä»¥æ—¥æœŸä½œä¸ºåˆ†ç»„ï¼Œå…¶æ¬¡åœ¨æ¯ä¸ªåˆ†ç»„ä¸­è·å–å¼‚å¸¸é¡¹çš„å³°å€¼æ•°æ®ï¼Œæ—¶é—´å¤æ‚åº¦O(n*n)ï¼Œæœ€å¥½ä»¥æ—¥æœŸåˆ†ç»„åˆ—è¡¨+å³°å€¼æ•°æ®åˆ—è¡¨ä½œä¸ºå¯¹è±¡è¿”å›ç»“æœ<br> é‡åˆ°æ€§èƒ½é—®é¢˜ï¼šä¸€å¤©çš„æ•°æ®é‡ä¸º<code>(60/5)*24</code>=288ï¼Œé»˜è®¤æ—¥æœŸä¸º15å¤©ï¼Œåˆ™ç»Ÿè®¡çš„æ•°æ®é‡ä¸º4230ï¼Œæ¥å£è¿”å›ç”šè‡³éœ€è¦8ã€9ç§’çš„æ—¶é—´ï¼Œä½œä¸ºä¸€ä¸ªé¡¹ç›®çš„é—¨é¢æŠ˜çº¿å›¾ï¼Œè¿™ç§æƒ…å†µ è¾¾å’©ï¼</p> 
<p>ä¼˜åŒ–çš„å¿µå¤´ï¼šæˆ‘è¦æ‹¿æ¯å¤©çš„å³°å€¼æ•°æ®ï¼Œæ€ä¹ˆæ‰èƒ½ç›´æ¥å–åˆ°æ¯å¤©çš„å³°å€¼å‘¢ï¼Œmongoçš„èšåˆæ˜¯ä¸æ˜¯å¯ä»¥åšåˆ°å•Šï¼Ÿ $groupå¯ä»¥æŒ‰æ—¥æœŸåšåˆ†ç»„ï¼Œ $maxå¯ä»¥æ‹¿åˆ°æœ€å¤§å€¼ï¼Œæ¥ä¸‹æ¥ä¸€ä¸ª $sortå¥½åƒæ˜¯å°±æˆäº†å§ï¼ è¯´å¹²å°±å¹²ï¼ï¼</p> 
<p><mark>æ¥ä¸‹æ¥çš„èšåˆè¯­å¥å‡ä¸ºmongo pipelineï¼Œæœ€åé™„ä¸Šgolangçš„bsonæ¡ä»¶å“ˆ</mark></p> 
<pre><code class="prism language-go"><span class="token comment">// ResultCountModel _</span>
<span class="token keyword">type</span> ResultCountModel <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	CommonBase <span class="token string">`json:",inline" yaml:",inline" bson:",inline"`</span>
	ErrorCount <span class="token builtin">int</span>   <span class="token string">`json:"error_count" bson:"error_count"`</span>
	Timestamp  <span class="token builtin">int64</span> <span class="token string">`json:"timestamp" bson:"timestamp"`</span>
	MaxTime    <span class="token builtin">int64</span> <span class="token string">`json:"max_time" bson:"max_time"`</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸Šï¼Œè¿™é‡Œä½¿ç”¨<code>CommonBase</code>ï¼Œæ˜¯å› ä¸ºåœ¨$groupèšåˆåä¼šå¾—åˆ°<code>_id</code>å”¯ä¸€æ ‡è¯†å­—æ®µï¼Œå› æ­¤ä¾¿äºè·å–æœ€åçš„èšåˆç»“æœï¼Œåœ¨å®šä¹‰ç»“æ„ä½“æ—¶å°†å…¶åŠ ä¸Šï¼›<code>timestamp</code>å•ä½ä¸ºæ¯«ç§’</p> 
<h4><a id="1_24"></a>1ã€æ—¥æœŸç­›é€‰</h4> 
<p>ç¬¬ä¸€æ­¥ï¼Œæ¯«æ— ç–‘é—®ï¼Œå¯¹æ—¶é—´æˆ³<code>timestamp</code>è¿›è¡Œæ—¥æœŸçš„è¿‡æ»¤</p> 
<pre><code class="prism language-shell">  <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$match</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        timestamp: <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$gte</span><span class="token builtin class-name">:</span> <span class="token number">1671897600000</span>, // min_timestamp
            <span class="token variable">$lt</span><span class="token builtin class-name">:</span> <span class="token number">1673280000000</span>   // max_timestamp
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><code>$gte</code> å¤§äºç­‰äº<br> <code>$lt</code> å°äº</p> 
<h4><a id="2_42"></a>2ã€æ—¥æœŸè½¬æ¢</h4> 
<p>ç¬¬äºŒæ­¥ï¼Œæ ¹æ®æ—¶é—´æˆ³å¤§å°è¿›è¡Œæ—¥æœŸçš„è½¬æ¢ï¼Œè¿™é‡Œæ˜¯ç”¨çš„æ˜¯$projectï¼Œ å°†å…·æœ‰è¯·æ±‚å­—æ®µçš„æ–‡æ¡£ä¼ é€’åˆ°ç®¡é“ä¸­çš„ä¸‹ä¸€é˜¶æ®µã€‚æŒ‡å®šçš„å­—æ®µå¯ä»¥æ˜¯<u>è¾“å…¥æ–‡æ¡£ä¸­çš„ç°æœ‰å­—æ®µ</u>æˆ–æ˜¯<u>æ–°è®¡ç®—çš„å­—æ®µ</u></p> 
<p>ä½¿ç”¨$projectä¸»è¦æ€è·¯æ˜¯ï¼Œå°†<code>timestamp</code>æ—¶é—´æˆ³è½¬æ¢ä¸ºæ ‡å‡†æ—¥æœŸï¼Œä¹‹åè¾“å‡ºä¸ºæƒ³è¦çš„formatå½¢å¼ï¼›åŒæ—¶ä½¿ç”¨ $projectä¿ç•™éœ€è¦çš„å­—æ®µ</p> 
<h5><a id="_48"></a>æ—¶é—´æˆ³è½¬æ¢æ—¥æœŸ</h5> 
<p>æ ¸å¿ƒæ–¹æ³•ï¼š<strong>$dateToString</strong></p> 
<pre><code class="prism language-shell">
<span class="token punctuation">{<!-- --></span> 
  <span class="token variable">$dateToString</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    date: <span class="token operator">&lt;</span>dateExpression<span class="token operator">&gt;</span>,
    format: <span class="token operator">&lt;</span>formatString<span class="token operator">&gt;</span>,
    timezone: <span class="token operator">&lt;</span>tzExpression<span class="token operator">&gt;</span>,
    onNull: <span class="token operator">&lt;</span>expression<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<ul><li><code>date</code> ï¼šè¦è½¬æ¢çš„å­—ç¬¦ä¸²æ—¥æœŸï¼Œå¿…é¡»æ˜¯è§£æä¸º<u><em>Dateã€Timestampã€ObjectID</em> </u>çš„æœ‰æ•ˆè¡¨è¾¾å¼</li><li><code>format</code>ï¼š æ—¥æœŸæ ¼å¼è§„èŒƒ</li><li><code>timezone</code>ï¼šè¿ç®—ç»“æœçš„æ—¶åŒºï¼Œå¸¸ç”¨UTCåç§»é‡</li><li><code>onNull</code>ï¼š dateä¸ºnullæˆ–ç¼ºå¤±æ—¶è¦è¿”å›çš„å€¼</li></ul> 
<p>æ—¥æœŸæ ¼å¼æƒ³è¦â€œæœˆä»½-æ—¥æœŸâ€ï¼Œé‚£format: â€œ%m-%dâ€</p> 
<p>æ—¥æœŸæ•°æ®è¿™é‡Œï¼Œå¦‚æœç›´æ¥ä½¿ç”¨è¾“å…¥æ–‡æ¡£ä¸­çš„ç°æœ‰å­—æ®µçš„è¯ date: â€œ$timestampâ€ï¼Œåˆ™ä¼šæŠ¥é”™ï¼š<s>PlanExecutor error during aggregation :: caused by :: canâ€™t convert from BSON type long to Date</s><br> å› æ­¤æˆ‘ä»¬éœ€è¦å°†æ—¶é—´æˆ³è½¬æ¢ä¸ºæ—¥æœŸï¼š å³æ ¼æ—å¨æ²»å¼€å§‹æ—¶é—´(1970-01-01 00ï¼š00ï¼š00)+æ—¶é—´æˆ³+æ—¶å·®</p> 
<pre><code class="prism language-shell">  date:<span class="token punctuation">{<!-- --></span>
    <span class="token variable">$add</span>:<span class="token punctuation">[</span>
      new Date<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,
      <span class="token string">"<span class="token variable">$timestamp</span>"</span>,
      <span class="token number">28800000</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
</code></pre> 
<p>æ³¨æ„âš ï¸ï¼š</p> 
<ul><li>MongoDBæ—¶é—´çš„åŸºæœ¬å•ä½ä¸ºæ¯«ç§’ï¼Œæ‰€ä»¥æœ¬æ–‡ç›´æ¥ä½¿ç”¨â€$timestampâ€å³å¯ï¼›è‹¥æ—¶é—´å•ä½ä¸ºç§’çº§æ—¶ï¼Œåˆ™éœ€è¦ä½¿ç”¨ $multiplyè¿›è¡Œä¹˜æ³•è¿ç®—ï¼š<em>{ $multiply:[" $timestampâ€,1000]}</em></li><li>MongoDBæ˜¯UTCæ—¶åŒºï¼Œå³ä¸­æ—¶åŒº(0åº¦ç»çº¿)ï¼Œ ä¸­å›½ä¸ºä¸œå…«åŒºï¼Œå› æ­¤éœ€è¦ä½¿ç”¨timezoneæ·»åŠ 8å°æ—¶(å³28800000æ¯«ç§’)</li></ul> 
<p>pipelineå¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-shell">  day:<span class="token punctuation">{<!-- --></span>
    <span class="token variable">$dateToString</span>:<span class="token punctuation">{<!-- --></span>
      format:<span class="token string">"%m-%d"</span>,
      date:<span class="token punctuation">{<!-- --></span>
        <span class="token variable">$add</span>:<span class="token punctuation">[</span>
          new Date<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,
          <span class="token string">"<span class="token variable">$timestamp</span>"</span>,
          <span class="token number">28800000</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>,
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
</code></pre> 
<h5><a id="_106"></a>ä¿ç•™éœ€è¦å­—æ®µ</h5> 
<pre><code class="prism language-shell">
/**
 * specifications: The fields to
 *   include or exclude.
 */
<span class="token punctuation">{<!-- --></span>
  timestamp:1,
  error_count:1,
<span class="token punctuation">}</span>

</code></pre> 
<p>$projectå°†ä¿ç•™å­—æ®µç½®ä¸º1å³å¯è¿›è¡Œæ•°æ®ä¿ç•™æ“ä½œ</p> 
<p>ç¬¬äºŒæ­¥å®Œæ•´pipelineå¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-shell">
<span class="token punctuation">{<!-- --></span>
    <span class="token variable">$project</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        day: <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$dateToString</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                format: <span class="token string">'%m-%d'</span>,
                date: <span class="token punctuation">{<!-- --></span>
                    <span class="token variable">$add</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                        ISODate<span class="token punctuation">(</span><span class="token string">'1970-01-01T00:00:00.000Z'</span><span class="token punctuation">)</span>,
                        <span class="token string">'$timestamp'</span>,
                        <span class="token number">28800000</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        timestamp: <span class="token number">1</span>,
        error_count: <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>,

</code></pre> 
<h4><a id="3_150"></a>3ã€æ—¥æœŸåˆ†ç»„</h4> 
<p>ç¬¬ä¸‰æ­¥ï¼Œä½¿ç”¨$groupè¿›è¡Œæ—¥æœŸåˆ†ç»„</p> 
<pre><code class="prism language-shell"><span class="token punctuation">{<!-- --></span>
  <span class="token variable">$group</span><span class="token builtin class-name">:</span>
    <span class="token punctuation">{<!-- --></span>
      _id: <span class="token operator">&lt;</span>expression<span class="token operator">&gt;</span>, // Group key
      <span class="token operator">&lt;</span>field<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>: <span class="token punctuation">{<!-- --></span> <span class="token operator">&lt;</span>accumulator<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token builtin class-name">:</span> <span class="token operator">&lt;</span>expression<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token punctuation">}</span>,
      <span class="token punctuation">..</span>.
    <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> 
<ul><li><code>_id</code>ï¼š è¡¨è¾¾å¼æŒ‡å®šç»„å¯†é’¥</li><li><code>field</code>ï¼š è®¡ç®—ä½¿ç”¨çš„<em>ç´¯åŠ å™¨è¿ç®—ç¬¦</em></li></ul> 
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦å°†ç¬¬äºŒæ­¥è·å¾—çš„æ—¥æœŸè½¬æ¢è¿›è¡Œåˆ†ç»„èšåˆï¼ŒåŒæ—¶è·å–æ¯ä¸ªåˆ†ç»„çš„å¼‚å¸¸é¡¹æœ€å¤§å€¼å³å³°å€¼æ•°æ®</p> 
<pre><code class="prism language-shell">
<span class="token punctuation">{<!-- --></span>
    <span class="token variable">$group</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        _id: <span class="token string">'$day'</span>,
        error_count: <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$max</span><span class="token builtin class-name">:</span> <span class="token string">'$error_count'</span>
        <span class="token punctuation">}</span>,
        max_time: <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$max</span><span class="token builtin class-name">:</span> <span class="token string">'$timestamp'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>, 

</code></pre> 
<p>è¿™é‡Œé¢å¤–è·å–äº†<code>max_time</code>å­—æ®µï¼Œä¸»è¦ç”¨äºåœ¨è®¡ç®—ç»Ÿè®¡æ•°æ®æ—¶çš„æ’åºï¼Œåœ¨æœ€åæ’åºéƒ¨åˆ†ä¼šä½¿ç”¨åˆ°</p> 
<h4><a id="4_188"></a>4ã€æ—¥æœŸæ’åº</h4> 
<p>è¿™é‡Œåšä¸€ä¸ªå‡è®¾ï¼Œå¦‚æœä¸ä½¿ç”¨<code>max_time</code>çš„è¯ï¼Œå¦‚ä½•å°†æ•°æ®è¿›è¡ŒæŒ‰æ—¥æœŸçš„æ’åºå‘¢ï¼Ÿ å¦‚æœæ ¹æ®<code>_id</code>è¿›è¡Œæ’åºï¼Œåˆ™ä¼šå‡ºç°â€œä¸Šå¹´æœ«â€æ’åºåœ¨â€œä¸‹å¹´åˆâ€çš„æƒ…å†µï¼ˆæ„Ÿè°¢ç°åœ¨çš„ğŸ“…ï¼Œä¸ç„¶ä¼šå¿˜è®°è¿™ä¸ªé—®é¢˜ï¼‰<br> æ‰€ä»¥å°†æ¯ä¸ªåˆ†ç»„çš„æœ€å¤§æ—¶é—´æˆ³ä¿ç•™ä¸‹æ¥æ—¶å¾ˆæœ‰å¿…è¦çš„ï¼<br> è¿™é‡Œå–$max $minéƒ½æ˜¯å¯ä»¥çš„å“ˆ</p> 
<pre><code class="prism language-shell"><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$sort</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
        max_time: <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>æœ€ç»ˆå®Œæ•´pipelineï¼š</strong></p> 
<pre><code class="prism language-shell">
<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
 <span class="token variable">$match</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
  timestamp: <span class="token punctuation">{<!-- --></span>
   <span class="token variable">$gte</span><span class="token builtin class-name">:</span> <span class="token number">1671897600000</span>,
   <span class="token variable">$lt</span><span class="token builtin class-name">:</span> <span class="token number">1673280000000</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>, <span class="token punctuation">{<!-- --></span>
 <span class="token variable">$project</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
  day: <span class="token punctuation">{<!-- --></span>
   <span class="token variable">$dateToString</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    format: <span class="token string">'%m-%d'</span>,
    date: <span class="token punctuation">{<!-- --></span>
     <span class="token variable">$add</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      ISODate<span class="token punctuation">(</span><span class="token string">'1970-01-01T00:00:00.000Z'</span><span class="token punctuation">)</span>,
      <span class="token string">'$timestamp'</span>,
      <span class="token number">28800000</span>
     <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  timestamp: <span class="token number">1</span>,
  error_count: <span class="token number">1</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>, <span class="token punctuation">{<!-- --></span>
 <span class="token variable">$group</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
  _id: <span class="token string">'$day'</span>,
  error_count: <span class="token punctuation">{<!-- --></span>
   <span class="token variable">$max</span><span class="token builtin class-name">:</span> <span class="token string">'$error_count'</span>
  <span class="token punctuation">}</span>,
  max_time: <span class="token punctuation">{<!-- --></span>
   <span class="token variable">$max</span><span class="token builtin class-name">:</span> <span class="token string">'$timestamp'</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>, <span class="token punctuation">{<!-- --></span>
 <span class="token variable">$sort</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
  max_time: <span class="token number">1</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
 <span class="token variable">$match</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
  timestamp: <span class="token punctuation">{<!-- --></span>
   <span class="token variable">$gte</span><span class="token builtin class-name">:</span> <span class="token number">1671897600000</span>,
   <span class="token variable">$lt</span><span class="token builtin class-name">:</span> <span class="token number">1673280000000</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>, <span class="token punctuation">{<!-- --></span>
 <span class="token variable">$project</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
  day: <span class="token punctuation">{<!-- --></span>
   <span class="token variable">$dateToString</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    format: <span class="token string">'%m-%d'</span>,
    date: <span class="token punctuation">{<!-- --></span>
     <span class="token variable">$add</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      ISODate<span class="token punctuation">(</span><span class="token string">'1970-01-01T00:00:00.000Z'</span><span class="token punctuation">)</span>,
      <span class="token string">'$timestamp'</span>,
      <span class="token number">28800000</span>
     <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  timestamp: <span class="token number">1</span>,
  error_count: <span class="token number">1</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>, <span class="token punctuation">{<!-- --></span>
 <span class="token variable">$group</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
  _id: <span class="token string">'$day'</span>,
  error_count: <span class="token punctuation">{<!-- --></span>
   <span class="token variable">$max</span><span class="token builtin class-name">:</span> <span class="token string">'$error_count'</span>
  <span class="token punctuation">}</span>,
  max_time: <span class="token punctuation">{<!-- --></span>
   <span class="token variable">$max</span><span class="token builtin class-name">:</span> <span class="token string">'$timestamp'</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>, <span class="token punctuation">{<!-- --></span>
 <span class="token variable">$sort</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
  max_time: <span class="token number">1</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

</code></pre> 
<p>åœ¨golangé‡Œé¢ï¼ŒAggregateåˆ™ç›´æ¥ä½¿ç”¨pipelineå³å¯ï¼Œäº¦å¯è½¬æ¢ä¸ºfilterä½¿ç”¨<br> filterä»£ç ï¼š</p> 
<pre><code class="prism language-go">filter <span class="token operator">:=</span> bson<span class="token punctuation">.</span>A<span class="token punctuation">{<!-- --></span>
		bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token string">"$match"</span><span class="token punctuation">,</span> bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">{<!-- --></span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">{<!-- --></span><span class="token string">"$gte"</span><span class="token punctuation">,</span> param<span class="token punctuation">.</span>MinTimestamp<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token punctuation">{<!-- --></span><span class="token string">"$lt"</span><span class="token punctuation">,</span> param<span class="token punctuation">.</span>MaxTimestamp<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token string">"$project"</span><span class="token punctuation">,</span> bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">{<!-- --></span><span class="token string">"day"</span><span class="token punctuation">,</span> bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">{<!-- --></span><span class="token string">"$dateToString"</span><span class="token punctuation">,</span> bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span>
					<span class="token punctuation">{<!-- --></span><span class="token string">"format"</span><span class="token punctuation">,</span> <span class="token string">"%m-%d"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
					<span class="token punctuation">{<!-- --></span><span class="token string">"date"</span><span class="token punctuation">,</span> bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span>
						<span class="token punctuation">{<!-- --></span><span class="token string">"$add"</span><span class="token punctuation">,</span> bson<span class="token punctuation">.</span>A<span class="token punctuation">{<!-- --></span>
							time<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token number">1970</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>UTC<span class="token punctuation">)</span><span class="token punctuation">,</span>
							<span class="token string">"$timestamp"</span><span class="token punctuation">,</span>
							<span class="token number">28800000</span><span class="token punctuation">,</span>
						<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
					<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">{<!-- --></span><span class="token string">"error_count"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">{<!-- --></span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token string">"$group"</span><span class="token punctuation">,</span> bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">{<!-- --></span><span class="token string">"_id"</span><span class="token punctuation">,</span> <span class="token string">"$day"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">{<!-- --></span><span class="token string">"max_time"</span><span class="token punctuation">,</span> bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token string">"$max"</span><span class="token punctuation">,</span> <span class="token string">"$timestamp"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">{<!-- --></span><span class="token string">"error_count"</span><span class="token punctuation">,</span> bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token string">"$max"</span><span class="token punctuation">,</span> <span class="token string">"$error_count"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token string">"$sort"</span><span class="token punctuation">,</span> bson<span class="token punctuation">.</span>D<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token string">"max_time"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>å®Œç»“æ’’èŠ±ğŸ‰</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/41e69a792a3335f883da7c95bc704cde/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">SQLè·å–æŸ¥è¯¢ç»“æœçš„æ€»æ¡æ•°ï¼Œè®°å½•ä»¥åç”¨åˆ°çš„SQLå‡½æ•°</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e4b18c429dfa181218ed27fafc8684bf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">æ­å»ºPyQtç¯å¢ƒï¼ˆPyCharmï¼‰</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>