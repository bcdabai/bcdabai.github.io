<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>前端 Gitlab 自动部署 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="前端 Gitlab 自动部署" />
<meta property="og:description" content="前端 Gitlab 自动部署 根据自己的系统，下载对应二进制安装文件 # Linux x86-64 sudo curl -L --output /usr/local/bin/gitlab-runner &#34;https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64&#34; # Linux x86 sudo curl -L --output /usr/local/bin/gitlab-runner &#34;https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-386&#34; # Linux arm sudo curl -L --output /usr/local/bin/gitlab-runner &#34;https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-arm&#34; # Linux arm64 sudo curl -L --output /usr/local/bin/gitlab-runner &#34;https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-arm64&#34; # Linux s390x sudo curl -L --output /usr/local/bin/gitlab-runner &#34;https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-s390x&#34; 授予执行权限 sudo chmod &#43;x /usr/local/bin/gitlab-runner 创建一个 Gitlab CI 账户 sudo useradd --comment &#39;GitLab Runner&#39; --create-home gitlab-runner --shell /bin/bash 安装、运行 # 安装 sudo gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner # 启动 sudo gitlab-runner start 此时, gitlab-runner 已经安装完毕了。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2d3b1407d7c3b8c365d125655abe16cb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-23T20:44:52+08:00" />
<meta property="article:modified_time" content="2021-04-23T20:44:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">前端 Gitlab 自动部署</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_Gitlab__0"></a>前端 Gitlab 自动部署</h2> 
<h3><a id="_1"></a>根据自己的系统，下载对应二进制安装文件</h3> 
<pre><code class="prism language-shell"><span class="token comment"># Linux x86-64</span>
<span class="token function">sudo</span> <span class="token function">curl</span> -L --output /usr/local/bin/gitlab-runner <span class="token string">"https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64"</span>

<span class="token comment"># Linux x86</span>
<span class="token function">sudo</span> <span class="token function">curl</span> -L --output /usr/local/bin/gitlab-runner <span class="token string">"https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-386"</span>

<span class="token comment"># Linux arm</span>
<span class="token function">sudo</span> <span class="token function">curl</span> -L --output /usr/local/bin/gitlab-runner <span class="token string">"https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-arm"</span>

<span class="token comment"># Linux arm64</span>
<span class="token function">sudo</span> <span class="token function">curl</span> -L --output /usr/local/bin/gitlab-runner <span class="token string">"https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-arm64"</span>

<span class="token comment"># Linux s390x</span>
<span class="token function">sudo</span> <span class="token function">curl</span> -L --output /usr/local/bin/gitlab-runner <span class="token string">"https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-s390x"</span>
</code></pre> 
<h3><a id="_19"></a>授予执行权限</h3> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/gitlab-runner
</code></pre> 
<h3><a id="_Gitlab_CI__23"></a>创建一个 Gitlab CI 账户</h3> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">useradd</span> --comment <span class="token string">'GitLab Runner'</span> --create-home gitlab-runner --shell /bin/bash
</code></pre> 
<h3><a id="_27"></a>安装、运行</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 安装</span>
<span class="token function">sudo</span> gitlab-runner <span class="token function">install</span> --user<span class="token operator">=</span>gitlab-runner --working-directory<span class="token operator">=</span>/home/gitlab-runner
<span class="token comment"># 启动</span>
<span class="token function">sudo</span> gitlab-runner start
</code></pre> 
<p>此时, gitlab-runner 已经安装完毕了。</p> 
<p>然后注册一个 runner:</p> 
<pre><code class="prism language-shell">gitlab-runner register
</code></pre> 
<p>输入上述命令后，会出现以下内容</p> 
<pre><code class="prism language-shell"><span class="token comment"># 要输入你的 git 地址</span>
Enter the GitLab instance URL <span class="token punctuation">(</span>for example, https://gitlab.com/<span class="token punctuation">)</span>:
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment"># 输入你项目的 token, 这个 token 在项目的 settings -&gt; CI/CD -&gt; Runner 中可以找到</span>
Enter the registration token:
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment"># 输入你 runner 的简介，主要用于多个 runner 的区分，可不填</span>
Enter a description <span class="token keyword">for</span> the runner:
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment"># 输入你用于部署的 tags</span>
Enter tags <span class="token keyword">for</span> the runner <span class="token punctuation">(</span>comma-separated<span class="token punctuation">)</span>:
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment"># 根据你的环境和部署方式自行选择，我这里使用的是 shell</span>
Enter the executor: parallels, shell, ssh, virtualbox, docker+machine, docker, docker-ssh, docker-ssh+machine, kubernetes:
</code></pre> 
<p>到此，会出现 <code>Runner registered successfully</code> 说明你已经成功注册一个 runner。<br> 进入项目中找到 Runner <code>settings -&gt; CI/CD -&gt; Runner</code> 你就会看到一个已经整装待发的 runner 了。</p> 
<h3><a id="_68"></a>项目部署</h3> 
<p>到项目的个目录创建一个名为 <code>.gitlab-ci.yml</code> 的 jobs 文件，文件内的内容大概如下</p> 
<pre><code class="prism language-yml"><span class="token key atrule">image</span><span class="token punctuation">:</span> node  <span class="token comment"># 选用docker镜像</span>

<span class="token key atrule">stages</span><span class="token punctuation">:</span> <span class="token comment"># Stages 表示构建阶段，这里有两个阶段 install, deploy</span>
  <span class="token punctuation">-</span> install
  <span class="token punctuation">-</span> deploy

<span class="token key atrule">cache</span><span class="token punctuation">:</span>
  <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"$CI_COMMIT_REF_SLUG"</span>
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> node_modules

<span class="token comment"># 开发环境</span>
<span class="token key atrule">install-staging</span><span class="token punctuation">:</span> 
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> install
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> primary
  <span class="token key atrule">only</span><span class="token punctuation">:</span> <span class="token comment"># 定义了只有在被merge到了如下分支上 才会执行部署脚本。</span>
    <span class="token punctuation">-</span> dev
    <span class="token punctuation">-</span> release
    <span class="token punctuation">-</span> master
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> echo "===== start install ======"
    <span class="token punctuation">-</span> npm config set sass_binary_site https<span class="token punctuation">:</span>//npm.taobao.org/mirrors/node<span class="token punctuation">-</span>sass/
    <span class="token punctuation">-</span> npm install <span class="token punctuation">-</span><span class="token punctuation">-</span>registry=https<span class="token punctuation">:</span>//registry.npm.taobao.org  <span class="token comment">#安装依赖</span>
    <span class="token punctuation">-</span> echo "===== end install ======"


<span class="token key atrule">deploy-staging</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> primary
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> dev
    <span class="token punctuation">-</span> release
    <span class="token punctuation">-</span> master
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> echo "===== start build ======"
    <span class="token punctuation">-</span> npm run build<span class="token punctuation">:</span>beta <span class="token comment"># 项目打包</span>
    <span class="token punctuation">-</span> echo "===== end build ======"
    <span class="token punctuation">-</span> echo "===== start deploy ======"
    <span class="token punctuation">-</span> npm run deploy <span class="token comment"># 上传至部署服务器</span>
    <span class="token punctuation">-</span> echo "===== end deploy ======"
</code></pre> 
<p>当我们编辑好文件后，<code>push</code> 我们的文件至 <code>dev、release、master</code> 的时候，就会进行自动部署了</p> 
<h3><a id="_117"></a>遇到的问题</h3> 
<ol><li><code>git fetch-pack: expected shallow list</code></li></ol> 
<pre><code class="prism language-shell"><span class="token comment"># 这是因为服务器版本过低的原因，通过升级 `git` 版本来解决</span>
yum <span class="token function">install</span> -y http://opensource.wandisco.com/centos/7/git/x86_64/wandisco-git-release-7-2.noarch.rpm
<span class="token comment"># 然后</span>
yum update <span class="token function">git</span>
</code></pre> 
<ol start="2"><li><code>npm command not found</code></li></ol> 
<pre><code class="prism language-shell"><span class="token comment"># 虽然我们已经安装了 node，但是当前用户的目录下找不到</span>
n<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">which</span> node<span class="token variable">)</span></span><span class="token punctuation">;</span>n<span class="token operator">=</span><span class="token variable">${n%/bin/node}</span><span class="token punctuation">;</span> <span class="token function">chmod</span> -R 755 <span class="token variable">$n</span>/bin/*<span class="token punctuation">;</span> <span class="token function">sudo</span> <span class="token function">cp</span> -r <span class="token variable">$n</span>/<span class="token punctuation">{<!-- --></span>bin,lib,share<span class="token punctuation">}</span> /usr/local
</code></pre> 
<ol start="3"><li><code>gitlab-runner: command not found</code><br> 当我使用<code>sudo gitlab-runner install</code> 时, 反馈我的是, <code>gitlab-runner: command not found</code>找了很久的文档没有解决方案, 后来我是进到 <code>gitlab-runner</code> 安装目录直接使用 <code>./gitlab-runner install 上面的安装命令</code> 来进行安装的。</li></ol> 
<h3><a id="_134"></a>其他</h3> 
<p>如果你的服务器还没有安装 <code>git 和 node</code> 可参考如下文章进行安装</p> 
<h4><a id="_git_137"></a>安装 git</h4> 
<pre><code class="prism language-shell">yum <span class="token function">install</span> -y <span class="token function">git</span>
</code></pre> 
<p>安装完成之后, 使用 <code>git --version</code> 查看是否已成功安装。</p> 
<h4><a id="_nvmnode_143"></a>安装 nvm、node</h4> 
<p>至于为什么不直接安装 node，因为我这里对版本有需求，如果没有需求的，可自行百度直接安装即可。</p> 
<p>两种安装办法：<br> <strong>1.curl</strong></p> 
<pre><code class="prism language-shell"><span class="token function">curl</span> -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh <span class="token operator">|</span> <span class="token function">bash</span>
</code></pre> 
<p>不过这个方法，可能会出现 443连接拒绝。可先通过<a href="https://www.ipaddress.com/" rel="nofollow">https://www.ipaddress.com/</a><br> 查询一下 raw.githubusercontent.com 对应的IP 地址，然后在 <code>/etc/hosts</code> 中添加对应的解析即可</p> 
<p><strong>2.git</strong></p> 
<pre><code class="prism language-shell"><span class="token comment"># 下载 nvm</span>
<span class="token function">git</span> clone git://github.com/creationix/nvm.git ~/nvm
<span class="token comment"># 然后进入到相应目录，执行 install.sh 进行安装 nvm</span>
<span class="token function">cd</span> ~/nvm
./install.sh
</code></pre> 
<p>等待安装结束后， 加入系统环境</p> 
<pre><code class="prism language-shell"><span class="token function">source</span>   ~/.bashrc
</code></pre> 
<p>查看所有的 node 版本</p> 
<pre><code class="prism language-shell">nvm list-remote
</code></pre> 
<p>安装需要的版本</p> 
<pre><code class="prism language-shell">nvm <span class="token function">install</span> v10.24.0
</code></pre> 
<p>查看所有已安装的版本</p> 
<pre><code class="prism language-shell">nvm list
</code></pre> 
<p>查看 node npm 版本</p> 
<pre><code class="prism language-shell">node -v
<span class="token function">npm</span> -v
</code></pre> 
<p>至此， 已经全部安装完成</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c0af9d03b346f7f53808762941ac793d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">D. Cut(质因子分解，倍增)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d9c7de719ec5cf6a4971b99742c79b76/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">各种排序算法的整合</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>