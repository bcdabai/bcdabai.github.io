<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Dubbo消费端java.lang.NoClassDefFoundError错误的排查 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Dubbo消费端java.lang.NoClassDefFoundError错误的排查" />
<meta property="og:description" content="当时在代码中调用Dubbo服务时产生这个异常。
javax.servlet.ServletException: org.glassfish.jersey.server. ContainerException: java.lang.NoClassDefFoundError: Could not initialize class com.xxxx.report.api. ReportApiProvider$ReportApiProviderHolder dubbo消费端代码结构如下：
public abstract class AbstractApiProvider { //省略 ... protected ResourceBundle dubboConsumer = ResourceBundle.getBundle(&#34;consumer/dubbo-consumer&#34;); // 省略 ... } public class ReportApiProvider extends AbstractApiProvider { private ReportApiProvider() { } private static class ReportApiProviderHolder { private static final ReportApiProvider singleton = new ReportApiProvider(); } static ReportApiProvider getInstance() { return ReportApiProviderHolder.singleton; } public static ReportService getReportService(){ return getInstance().getBean(ReportService.class); } } 调用getInstance()报错，但tomcat中却没有有效的日志，只有NoClassDefFoundError及调用栈信息。看到错误首先检查内部类相关的class是否成功编译，一切正常。
随后在排查过程中并未仔细检查父类AbstractApiProvider对资源的加载，导致排查多花了些时间。因为在父类中还完成了很多初始化工作，而且需要依赖很多其它的包。于是排查哪个包出现问题，通过每次替换一半的正常的依赖包并启动程序观察结果，于是很快定位到一个依赖包，替换了这个包后异常除。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/cdde7a898b4e209cfbf23d3a092cbb54/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-10-31T19:18:14+08:00" />
<meta property="article:modified_time" content="2016-10-31T19:18:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Dubbo消费端java.lang.NoClassDefFoundError错误的排查</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>当时在代码中调用Dubbo服务时产生这个异常。</p> 
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-label">javax.servlet.ServletException:</span> org<span class="hljs-preprocessor">.glassfish</span><span class="hljs-preprocessor">.jersey</span><span class="hljs-preprocessor">.server</span>.
<span class="hljs-label">ContainerException:</span> java<span class="hljs-preprocessor">.lang</span><span class="hljs-preprocessor">.NoClassDefFoundError</span>: 
Could not initialize class <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.xxxx</span><span class="hljs-preprocessor">.report</span><span class="hljs-preprocessor">.api</span>.
ReportApiProvider$ReportApiProviderHolder</code></pre> 
<p>dubbo消费端代码结构如下：</p> 
<pre class="prettyprint"><code class=" hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractApiProvider</span> {<!-- --></span>
    <span class="hljs-comment">//省略</span>
    ... 
    <span class="hljs-keyword">protected</span> ResourceBundle dubboConsumer = ResourceBundle.getBundle(<span class="hljs-string">"consumer/dubbo-consumer"</span>);
    <span class="hljs-comment">// 省略</span>
    ...
}

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReportApiProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractApiProvider</span> {<!-- --></span>

    <span class="hljs-keyword">private</span> <span class="hljs-title">ReportApiProvider</span>() {
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReportApiProviderHolder</span> {<!-- --></span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ReportApiProvider singleton = <span class="hljs-keyword">new</span> ReportApiProvider();
    }

    <span class="hljs-keyword">static</span> ReportApiProvider getInstance() {
        <span class="hljs-keyword">return</span> ReportApiProviderHolder.singleton;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ReportService <span class="hljs-title">getReportService</span>(){
        <span class="hljs-keyword">return</span> getInstance().getBean(ReportService.class);
    }
}</code></pre> 
<p>调用getInstance()报错，但tomcat中却没有有效的日志，只有NoClassDefFoundError及调用栈信息。看到错误首先检查内部类相关的class是否成功编译，一切正常。</p> 
<p>随后在排查过程中并未仔细检查父类AbstractApiProvider对资源的加载，导致排查多花了些时间。因为在父类中还完成了很多初始化工作，而且需要依赖很多其它的包。于是排查哪个包出现问题，通过每次替换一半的正常的依赖包并启动程序观察结果，于是很快定位到一个依赖包，替换了这个包后异常除。</p> 
<p>随后再次分析ReportApiProvider的AbstractApiProvider，发现父类会获取属性文件中的属性， <br> ResourceBundle.getBundle(“consumer/dubbo-consumer”)最后去查找发现该方法尝试通过key去找value，这个(key,value)对并未配置在文件中，导致产生错误。</p> 
<p>最后产生错误的完整路径是如下。 <br> 1. getInstance() <br> 2. ReportApiProviderHolder.singleton <br> 3. new ReportApiProvider() <br> 4. 在基类中完成相关对象创建及资源加载 <br> protected ResourceBundle dubboConsumer = ResourceBundle.getBundle(“consumer/dubbo-consumer”)最终失败，导致ReportApiProvider对象创建失败。</p> 
<p>因此通过getInstance()获取实例时产生了 <br> java.lang.NoClassDefFoundError: <br> Could not initialize class com.fengdai.report.api.ReportApiProvider$ReportApiProviderHolder异常。</p> 
<p>随后又在stackoverflow上看了看相关问题。</p> 
<blockquote> 
 <p><a href="http://stackoverflow.com/questions/34413/why-am-i-getting-a-noclassdeffounderror-in-java" rel="nofollow">http://stackoverflow.com/questions/34413/why-am-i-getting-a-noclassdeffounderror-in-java</a></p> 
</blockquote> 
<p>最高票回答可以看出，在尝试加载类时因某些原来导致失败，进而产生了NoClassDefFoundError异常，而这个异常不仅仅是当.class不存在时候导致。</p> 
<p>最后简化一下问题。下面的代码通过IODH单利模式获取对象实例，但由于基类基类加载时出错导致失败，导致ClassDefNotFoundError异常的产生。涉及的知识点 <br> 类加载机制参考深入《理解Java虚拟机 JVM高级特性与最佳实践》第7章即可。</p> 
<pre class="prettyprint"><code class=" hljs axapta"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractLayer</span>{<!-- --></span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> a = <span class="hljs-number">1</span>/<span class="hljs-number">0</span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConcretLayer</span> <span class="hljs-inheritance"><span class="hljs-keyword">extends</span></span> <span class="hljs-title">AbstractLayer</span>{<!-- --></span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConcretLayerHolder</span>{<!-- --></span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ConcretLayer singleton = <span class="hljs-keyword">new</span> ConcretLayer();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>  ConcretLayer getInstance(){
        <span class="hljs-keyword">return</span> ConcretLayerHolder.singleton;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassDefNotFoundError</span> {<!-- --></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> main(String[] args) {
        ConcretLayer.getInstance();
    }
}</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/771b548235ee0a748df1a982d54a9c39/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">iOS   给测试人员测试手机APP的四种方法：真机运行（略），打ipa包，（testFlighe）邮件,蒲公英（一）打ipa包</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5765f442ffa473d51a3d45e2057a1064/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">设置Excel工作簿达到使用天数后自动删除文件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>