<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux 系统下 docker 搭建和使用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux 系统下 docker 搭建和使用" />
<meta property="og:description" content="文章目录 1 docker 搭建2 docker 使用2.1 查看 docker 镜像2.2 给镜像重名2.3 docker 常用命令2.4 docker启动常用命令2.5 容器操作2.6 保存容器为新的镜像2.7 文件传输2.8 挂载2.9 docker 服务的启动和关闭2.10 docker 镜像保存与导入2.11 docker 使用的主要命令 3 docker 存储目录的更改方法一：软链接（建议使用）方法二：直接更改目录方法 4 docker 使用小 tips，方便你我他的小设置4.1 用户权限问题，添加新用户后挂载目录无法读取。4.2 通过ssh 连接容器 5 docker 服务器搭建容器整体流程梳理docker 挂载docker container 的脚本文件在 notion 6 Docker 问答录7 搭建 wiki8 搭建 xwiki 1 docker 搭建 docker 官方文档地址： https://docs.docker.com/engine/reference/commandline/docker/
安装方法官方文档：https://docs.docker.com/engine/install/ubuntu/#prerequisites
单用户授权： https://docs.docker.com/engine/install/linux-postinstall/
# 卸载之前的docker sudo apt-get remove docker docker-engine docker.io containerd runc # 安装docker 需要的包 sudo apt-get update sudo apt-get install \ ca-certificates \ curl \ gnupg \ lsb-release # docker 添加证书 curl -fsSL https://download." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/86085332565960c27233bc8b8a61eb71/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-01T17:02:38+08:00" />
<meta property="article:modified_time" content="2023-03-01T17:02:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux 系统下 docker 搭建和使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><a href="#1_docker__2" rel="nofollow">1 docker 搭建</a></li><li><a href="#2_docker__64" rel="nofollow">2 docker 使用</a></li><li><ul><li><a href="#21__docker__66" rel="nofollow">2.1 查看 docker 镜像</a></li><li><a href="#22__80" rel="nofollow">2.2 给镜像重名</a></li><li><a href="#23_docker__92" rel="nofollow">2.3 docker 常用命令</a></li><li><a href="#24_docker_101" rel="nofollow">2.4 docker启动常用命令</a></li><li><a href="#25___137" rel="nofollow">2.5 容器操作</a></li><li><a href="#26__182" rel="nofollow">2.6 保存容器为新的镜像</a></li><li><a href="#27__196" rel="nofollow">2.7 文件传输</a></li><li><a href="#28__213" rel="nofollow">2.8 挂载</a></li><li><a href="#29_docker__223" rel="nofollow">2.9 docker 服务的启动和关闭</a></li><li><a href="#210_docker__230" rel="nofollow">2.10 docker 镜像保存与导入</a></li><li><a href="#211_docker__240" rel="nofollow">2.11 docker 使用的主要命令</a></li></ul> 
    </li><li><a href="#3_docker__298" rel="nofollow">3 docker 存储目录的更改</a></li><li><ul><li><ul><li><a href="#_300" rel="nofollow">方法一：软链接（建议使用）</a></li><li><a href="#_326" rel="nofollow">方法二：直接更改目录方法</a></li></ul> 
    </li></ul> 
    </li><li><a href="#4_docker__tips_349" rel="nofollow">4 docker 使用小 tips，方便你我他的小设置</a></li><li><ul><li><a href="#41__351" rel="nofollow">4.1 用户权限问题，添加新用户后挂载目录无法读取。</a></li><li><a href="#42_ssh__360" rel="nofollow">4.2 通过ssh 连接容器</a></li></ul> 
    </li><li><a href="#5_docker__368" rel="nofollow">5 docker 服务器搭建容器整体流程梳理</a></li><li><ul><li><a href="#docker__414" rel="nofollow">docker 挂载</a></li><li><a href="#docker_container__notion_479" rel="nofollow">docker container 的脚本文件在 notion</a></li></ul> 
    </li><li><a href="#6___Docker__482" rel="nofollow">6 Docker 问答录</a></li><li><a href="#7__wiki_486" rel="nofollow">7 搭建 wiki</a></li><li><a href="#8__xwiki_511" rel="nofollow">8 搭建 xwiki</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h4><a id="1_docker__2"></a>1 docker 搭建</h4> 
<p>docker 官方文档地址： https://docs.docker.com/engine/reference/commandline/docker/</p> 
<p>安装方法官方文档：https://docs.docker.com/engine/install/ubuntu/#prerequisites</p> 
<p>单用户授权： https://docs.docker.com/engine/install/linux-postinstall/</p> 
<pre><code class="prism language-shell"><span class="token comment"># 卸载之前的docker</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> remove <span class="token function">docker</span> docker-engine docker.io containerd runc
<span class="token comment"># 安装docker 需要的包</span>
 <span class="token function">sudo</span> <span class="token function">apt-get</span> update
 <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token punctuation">\</span>
    ca-certificates <span class="token punctuation">\</span>
    <span class="token function">curl</span> <span class="token punctuation">\</span>
    gnupg <span class="token punctuation">\</span>
    lsb-release
    
<span class="token comment"># docker 添加证书</span>
<span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class="token operator">|</span> <span class="token function">sudo</span> gpg <span class="token parameter variable">--dearmor</span> <span class="token parameter variable">-o</span> /usr/share/keyrings/docker-archive-keyring.gpg
    
<span class="token comment"># 本地的稳定安装</span>
<span class="token builtin class-name">echo</span> <span class="token punctuation">\</span>
  <span class="token string">"deb [arch=<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture<span class="token variable">)</span></span> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
  <span class="token variable"><span class="token variable">$(</span>lsb_release <span class="token parameter variable">-cs</span><span class="token variable">)</span></span> stable"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">&gt;</span> /dev/null
   
<span class="token comment"># docker 安装</span>
 <span class="token function">sudo</span> <span class="token function">apt-get</span> update
 <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> docker-ce docker-ce-cli containerd.io
 
<span class="token comment"># 用户加入docker 组别</span>
<span class="token comment"># sudo groupadd docker  # 默认是有的</span>
<span class="token function">sudo</span> <span class="token function">usermod</span> <span class="token parameter variable">-aG</span> <span class="token function">docker</span> <span class="token environment constant">$USER</span>

</code></pre> 
<p>出现下列信息说明安装成功。</p> 
<pre><code class="prism language-shell">Hello from Docker<span class="token operator">!</span>
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 <span class="token number">1</span>. The Docker client contacted the Docker daemon.
 <span class="token number">2</span>. The Docker daemon pulled the <span class="token string">"hello-world"</span> image from the Docker Hub.
    <span class="token punctuation">(</span>amd64<span class="token punctuation">)</span>
 <span class="token number">3</span>. The Docker daemon created a new container from that image <span class="token function">which</span> runs the
    executable that produces the output you are currently reading.
 <span class="token number">4</span>. The Docker daemon streamed that output to the Docker client, <span class="token function">which</span> sent it
    to your terminal.

To try something <span class="token function">more</span> ambitious, you can run an Ubuntu container with:
 $ <span class="token function">docker</span> run <span class="token parameter variable">-it</span> ubuntu <span class="token function">bash</span>

Share images, automate workflows, and <span class="token function">more</span> with a <span class="token function">free</span> Docker ID:
 https://hub.docker.com/

For <span class="token function">more</span> examples and ideas, visit:
 https://docs.docker.com/get-started/
</code></pre> 
<h4><a id="2_docker__64"></a>2 docker 使用</h4> 
<h5><a id="21__docker__66"></a>2.1 查看 docker 镜像</h5> 
<pre><code class="prism language-shell"><span class="token function">docker</span> image <span class="token function">ls</span>
</code></pre> 
<p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-8CziOVTe-1642650775496)(D:\Program_Files\Typora\Picutre\Docker\001.png)]</p> 
<ul><li><strong>REPOSITORY</strong>: 来自于哪个仓库；</li><li><strong>TAG</strong>: 镜像的标签信息，比如 5.7、latest 表示不同的版本信息；</li><li><strong>IMAGE ID</strong>: 镜像的 ID, 如果您看到两个 ID 完全相同，那么实际上，它们指向的是同一个镜像，只是标签名称不同罢了；</li><li><strong>CREATED</strong>: 镜像最后的更新时间；</li><li><strong>SIZE</strong>: 镜像的大小，优秀的镜像一般体积都比较小，这也是我更倾向于使用轻量级的 alpine 版本的原因；</li></ul> 
<h5><a id="22__80"></a>2.2 给镜像重名</h5> 
<pre><code class="prism language-shell"><span class="token function">docker</span> tag ubuntu:15.10 ubuntu15.10
<span class="token function">docker</span> image <span class="token function">ls</span>
<span class="token comment">#### 显示信息</span>
REPOSITORY    TAG       IMAGE ID       CREATED        SIZE
hello-world   latest    feb5d9fea6a5   <span class="token number">3</span> months ago   <span class="token number">13</span>.3kB
ubuntu15.10   latest    9b9cb95443b5   <span class="token number">5</span> years ago    137MB
ubuntu        <span class="token number">15.10</span>     9b9cb95443b5   <span class="token number">5</span> years ago    137MB
</code></pre> 
<h5><a id="23_docker__92"></a>2.3 docker 常用命令</h5> 
<pre><code class="prism language-shell"><span class="token comment">#### 查看镜像的详细信息</span>
<span class="token function">docker</span> inspect ubuntu15.10
<span class="token comment">#### 查看镜像历史信息</span>
<span class="token function">docker</span> <span class="token function">history</span> ubuntu15.10
</code></pre> 
<h5><a id="24_docker_101"></a>2.4 docker启动常用命令</h5> 
<p>所需要的命令主要为 <code>docker run</code></p> 
<p>当利用 docker run 来创建容器时，Docker 在后台运行的标准操作包括：</p> 
<ul><li>检查本地是否存在指定的镜像，不存在就从 registry 下载</li><li>利用镜像创建并启动一个容器</li><li>分配一个文件系统，并在只读的镜像层外面挂载一层可读写层</li><li>从宿主主机配置的网桥接口中桥接一个虚拟接口到容器中去</li><li>从地址池配置一个 ip 地址给容器</li><li>执行用户指定的应用程序</li><li>执行完毕后容器被终止</li></ul> 
<pre><code class="prism language-shell"><span class="token comment"># 查看docker中已下载的镜像</span>
<span class="token function">docker</span> images
<span class="token comment"># 通过 docker中的一个镜像生成并进入容器</span>
<span class="token function">docker</span> run ubuntu:18.04 /bin/echo <span class="token string">'Hello world'</span>
<span class="token comment"># -t 选项让Docker分配一个伪终端（pseudo-tty）并绑定到容器的标准输入上， -i 则让容器的标准输入保持打开</span>
<span class="token function">docker</span> run <span class="token parameter variable">-t</span> <span class="token parameter variable">-i</span> ubuntu:18.04 /bin/bash
<span class="token comment"># 分配终端，挂载本地文件启动，同时给容器命名，（ 进入容器时既可以指定容器名，也可以指定容器ID ）</span>
<span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--name</span><span class="token operator">=</span><span class="token string">"userTest001"</span> <span class="token parameter variable">-v</span>  /opt/work/opt_user/:/home/mntdata  ubuntu_env_true:latest /bin/bash
<span class="token comment"># 修改容器名</span>
<span class="token function">docker</span> <span class="token function">rename</span> userTest001 user_test

<span class="token comment"># 启动已终止容器</span>
<span class="token function">docker</span> container start
<span class="token comment"># 查看终止状态的容器</span>
<span class="token function">docker</span> container <span class="token function">ls</span> <span class="token parameter variable">-a</span>
<span class="token comment"># 查看运行状态的容器</span>
<span class="token function">docker</span> container <span class="token function">ls</span> 
</code></pre> 
<h5><a id="25___137"></a>2.5 容器操作</h5> 
<pre><code class="prism language-shell"><span class="token comment"># 查看 docker 中所有的容器</span>
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span>             <span class="token comment"># （-aq 只有容器id , -a 有状态显示 ）</span>
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-aq</span>
<span class="token function">docker</span> container <span class="token function">ls</span> <span class="token parameter variable">-a</span>   <span class="token comment"># （有状态显示）</span>

<span class="token comment"># 进入 containerID 为 83806d576f69 的容器（ exec 以互不打扰的方式重开一个命令行）</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> f59522c03264 /bin/bash
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token parameter variable">-u</span> root f59522c03264 /bin/bash

<span class="token comment"># 启动、停止某个容器</span>
<span class="token function">docker</span> start 83806d576f69
<span class="token function">docker</span> stop 83806d576f69
<span class="token function">docker</span> container stop <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-aq</span><span class="token variable">)</span></span>

<span class="token comment"># 删除容器(83806d576f69 为容器的 containerID ，上面的命令可查看)，前提是！！！容器已停止运行</span>
<span class="token function">docker</span> stop 83806d576f69
<span class="token function">docker</span> <span class="token function">rm</span> 83806d576f69

<span class="token comment">## 输出镜像的 id 全称</span>
<span class="token function">docker</span> image inspect <span class="token parameter variable">--format</span><span class="token operator">=</span><span class="token string">'{<!-- -->{.RepoTags}} {<!-- -->{.Id}} {<!-- -->{.Parent}}'</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> image <span class="token function">ls</span> <span class="token parameter variable">-q</span> <span class="token parameter variable">--filter</span> <span class="token assign-left variable">since</span><span class="token operator">=</span>9b9cb95443b5<span class="token variable">)</span></span>
<span class="token comment">#### 删除 镜像</span>
<span class="token function">docker</span> rmi e508bd6d6


<span class="token comment"># 复制文件</span>
<span class="token function">docker</span> <span class="token function">cp</span> mycontainer:/opt/file.txt /opt/local/
<span class="token function">docker</span> <span class="token function">cp</span> /opt/local/file.txt mycontainer:/opt/


<span class="token comment">#### ！！！！！！ 不要轻易使用</span>
<span class="token comment"># 删除所有不使用的镜像</span>
<span class="token function">docker</span> image prune <span class="token parameter variable">--force</span> <span class="token parameter variable">--all</span> 或者 <span class="token function">docker</span> image prune  <span class="token parameter variable">-a</span>  <span class="token punctuation">(</span>谨慎添加  <span class="token parameter variable">-f</span> <span class="token punctuation">)</span>
<span class="token comment"># 删除所有停止的容器</span>
<span class="token function">docker</span> container prune  <span class="token punctuation">(</span>谨慎添加  <span class="token parameter variable">-f</span> <span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment"># 进入容器（两个终端输入命令不同时出现）</span>
<span class="token function">docker</span> container start  98f
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> 98f /bin/bash
</code></pre> 
<h5><a id="26__182"></a>2.6 保存容器为新的镜像</h5> 
<pre><code class="prism language-shell"><span class="token comment"># 基于已有的docker容器，做一新的dokcer image. </span>
<span class="token comment"># 前提是：先停止容器 ！！！！！！！！！</span>
<span class="token function">docker</span> stop <span class="token operator">&lt;</span>old_container_id<span class="token operator">&gt;</span>
<span class="token function">docker</span> commit <span class="token operator">&lt;</span>old_container_id<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>new_image_name<span class="token operator">&gt;</span>

<span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-l</span>
<span class="token function">docker</span> stop 6d83def2eb81
<span class="token function">docker</span> commit 6d83def2eb81 ubuntu15.10.new
<span class="token function">docker</span> images
</code></pre> 
<h5><a id="27__196"></a>2.7 文件传输</h5> 
<pre><code class="prism language-shell"><span class="token comment"># 主机和容器互相传输命令</span>
<span class="token function">docker</span> <span class="token function">cp</span> 98f3b5ce5:/home/root_98f3b5ce5d14  /home/xxx/ 

<span class="token function">docker</span> <span class="token function">cp</span>  root_host_dir/  98f3b5ce5:/home/

<span class="token function">docker</span> <span class="token function">cp</span> 容器id:容器内路径 主机目的路径
<span class="token function">docker</span> <span class="token function">cp</span> 主机目的路径 容器id:容器内路径
</code></pre> 
<pre><code class="prism language-shell"><span class="token comment"># 查看docker中已下载的镜像</span>
<span class="token function">docker</span> images
</code></pre> 
<h5><a id="28__213"></a>2.8 挂载</h5> 
<pre><code class="prism language-shell"><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">-v</span> 主机目录:容器内目录 <span class="token parameter variable">-p</span> 主机端口:容器内端口
<span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">-v</span> /home/ceshi:/home centos /bin/bash

<span class="token function">docker</span> run  <span class="token parameter variable">-it</span> <span class="token parameter variable">-v</span> /opt/work/dockerdata:/home/data  ubuntu_env_true /bin/bash
<span class="token comment">#通过 docker inspect 容器id 查看</span>
</code></pre> 
<h5><a id="29_docker__223"></a>2.9 docker 服务的启动和关闭</h5> 
<pre><code class="prism language-shell">systemctl stop <span class="token function">docker</span>
systemctl restart <span class="token function">docker</span>
</code></pre> 
<h5><a id="210_docker__230"></a>2.10 docker 镜像保存与导入</h5> 
<pre><code class="prism language-shell"><span class="token function">docker</span> save imageID <span class="token operator">&gt;</span> filename
<span class="token comment"># 或者 用 REPOSITORY</span>
<span class="token function">docker</span> save ubuntu_user:latest <span class="token operator">&gt;</span> ubuntu_user.tar

<span class="token function">docker</span> load <span class="token operator">&lt;</span> filename
</code></pre> 
<h5><a id="211_docker__240"></a>2.11 docker 使用的主要命令</h5> 
<pre><code class="prism language-shell"> <span class="token comment"># 查看docker中已下载的镜像</span>
 <span class="token function">docker</span> images
 <span class="token comment"># 查看docker中已安装的容器</span>
 <span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span>

 <span class="token comment"># 通过镜像生成并启动一个容器</span>
 <span class="token function">docker</span> run <span class="token parameter variable">-it</span> ubuntu_env_true:latest /bin/bash
 <span class="token builtin class-name">exit</span>
 <span class="token comment"># 以挂载的方式生成并启动一个容器</span>
 <span class="token function">docker</span> run  <span class="token parameter variable">-it</span> <span class="token parameter variable">-v</span> /host_filename:/home/data  ubuntu_env_true /bin/bash
 <span class="token comment"># 以挂载的方式生成并启动一个容器，同时给容器的名称命名为 userTest001</span>
 <span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--name</span><span class="token operator">=</span><span class="token string">"userTest001"</span> <span class="token parameter variable">-v</span>  /opt/work/opt_ldf/:/home/mntdata  ubuntu_env_true:latest /bin/bash 
 <span class="token comment"># 修改容器名</span>
 <span class="token function">docker</span> <span class="token function">rename</span> userTest001 user_test

 <span class="token comment"># 启动容器、停止容器、停止所用容器</span>
 <span class="token function">docker</span> container start  b7fd710a3fbc<span class="token punctuation">(</span>containerID/Name<span class="token punctuation">)</span>
 <span class="token function">docker</span> container stop  b7fd710a3fbc
 <span class="token function">docker</span> container stop <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-aq</span><span class="token variable">)</span></span>
 
 
 <span class="token comment"># 进入容器，以互不打扰命令行的方式进入容器。</span>
 <span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> 98f<span class="token punctuation">(</span>containerID/Name<span class="token punctuation">)</span> /bin/bash 
 
 <span class="token comment"># 主机和容器互相传输命令</span>
 <span class="token function">docker</span> <span class="token function">cp</span> 容器id:容器内路径 主机目的路径
 <span class="token function">docker</span> <span class="token function">cp</span> 主机目的路径 容器id:容器内路径 
 <span class="token function">docker</span> <span class="token function">cp</span>  98f3b5ce5:/home/file  /home/xxx/ 
 <span class="token function">docker</span> <span class="token function">cp</span>  host_root_host_dir/  98f3b5ce5:/home/file
  
 <span class="token comment"># 保存容器</span>
 <span class="token comment"># 查看当前容器状态，停止所有容器，查看容器状态，需保存的容器状态为停止，保存容器为新的镜像。</span>
 <span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span>
 <span class="token function">docker</span> container stop <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-aq</span><span class="token variable">)</span></span>
 <span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span>
 <span class="token function">docker</span> commit  b6e38a990eb6 ubuntu_env_true
 <span class="token function">docker</span> images 
  
 <span class="token comment"># 删除容器(83806d576f69 为容器的id，上面的命令可查看)，先停止容器！！！</span>
 <span class="token comment"># 删除的前提是容器已停止运行！！！！！</span>
 <span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span>
 <span class="token function">docker</span> container stop 83806d576f69
 <span class="token function">docker</span> <span class="token function">rm</span> 83806d576f69 
 <span class="token comment"># 删除镜像</span>
 <span class="token function">docker</span> rmi e508bd6d6<span class="token punctuation">(</span>imageID<span class="token punctuation">)</span> 
 
 <span class="token comment">#### ！！！！！！ 不要轻易使用</span>
 <span class="token comment"># 删除所有不使用的镜像</span>
 <span class="token function">docker</span> image prune <span class="token parameter variable">--force</span> --all或者docker image prune  <span class="token parameter variable">-a</span>  <span class="token punctuation">(</span>谨慎添加  <span class="token parameter variable">-f</span> <span class="token punctuation">)</span>
 <span class="token comment"># 删除所有停止的容器</span>
 <span class="token function">docker</span> container prune  <span class="token punctuation">(</span>谨慎添加  <span class="token parameter variable">-f</span> <span class="token punctuation">)</span>
</code></pre> 
<h4><a id="3_docker__298"></a>3 docker 存储目录的更改</h4> 
<h6><a id="_300"></a>方法一：软链接（建议使用）</h6> 
<pre><code class="prism language-shell"><span class="token comment"># 查找 docker 的存储目录</span>
<span class="token function">sudo</span> <span class="token function">docker</span> info <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Docker Root Dir"</span>

<span class="token comment"># 关掉 docker 服务</span>
systemctl stop <span class="token function">docker</span>

<span class="token comment"># 移动目录到想要存储的目录</span>
<span class="token function">mv</span> /var/lib/docker  /home/work/docker_root

<span class="token comment"># 软链接，在需要存储的目录下创建一个软链接，链接到 docker 的默认目录。</span>
<span class="token function">ln</span> <span class="token parameter variable">-s</span> src_Dir dst_Dir
<span class="token function">ln</span> <span class="token parameter variable">-s</span> /home/work/docker_root  /var/lib/docker

<span class="token comment"># 重启 docker 服务</span>
systemctl restart <span class="token function">docker</span>

<span class="token comment"># 查看，并运行一个做测试</span>
<span class="token function">docker</span> images
<span class="token function">docker</span> run <span class="token parameter variable">-it</span> ubuntu_env_true:latest /bin/bash


</code></pre> 
<h6><a id="_326"></a>方法二：直接更改目录方法</h6> 
<pre><code class="prism language-shell"><span class="token comment">### 官方文档的修改办法是编辑 /etc/docker/daemon.json 文件,</span>
<span class="token comment">### 默认情况下这个配置文件是没有的，我们需要新建一个</span>
<span class="token function">touch</span>  daemon.json 
<span class="token comment">### 写入下列内容</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"data-root"</span><span class="token builtin class-name">:</span> <span class="token string">"/www/docker"</span>
<span class="token punctuation">}</span>
<span class="token comment">### 此文件还涉及默认源的设定，如果设定了国内源，那么实际就是在源地址下方加一行，写成：</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token string">"http://hub-mirror.c.163.com"</span><span class="token punctuation">]</span>,
  <span class="token string">"data-root"</span><span class="token builtin class-name">:</span> <span class="token string">"/www/docker"</span>
<span class="token punctuation">}</span>
<span class="token comment">### 保存退出，然后重启 docker 服务：</span>
systemctl restart <span class="token function">docker</span>
<span class="token comment">### 查找 docker 的存储目录，验证修改</span>
<span class="token function">sudo</span> <span class="token function">docker</span> info <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Docker Root Dir"</span>
</code></pre> 
<h4><a id="4_docker__tips_349"></a>4 docker 使用小 tips，方便你我他的小设置</h4> 
<h5><a id="41__351"></a>4.1 用户权限问题，添加新用户后挂载目录无法读取。</h5> 
<p>容器内修改 /etc/passwd 文件的用户 id ，让他和挂载目录的id 一样</p> 
<pre><code class="prism language-shell"><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s/<span class="token variable">${username}</span>:x:1000:1000/<span class="token variable">${username}</span>:x:<span class="token variable">${uid}</span>:<span class="token variable">${gid}</span>/"</span> /etc/passwd
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s/<span class="token variable">${username}</span>:x:1000/<span class="token variable">${username}</span>:x:<span class="token variable">${gid}</span>/"</span> /etc/group
</code></pre> 
<h5><a id="42_ssh__360"></a>4.2 通过ssh 连接容器</h5> 
<p>通过 ssh 连接容器可实现 权限控制问题，只能读取某个特定的权限</p> 
<pre><code class="prism language-shell"><span class="token function">ssh</span> username@xx.xx.xx.xx <span class="token parameter variable">-p</span> xxxx
</code></pre> 
<h4><a id="5_docker__368"></a>5 docker 服务器搭建容器整体流程梳理</h4> 
<p>为用户新建容器，并挂载，并开放端口号让用户连接，同时修改用户uid 让其不受访问限制。</p> 
<pre><code class="prism language-shell"><span class="token comment"># 新建容器供用户使用的完整流程。</span>
<span class="token comment"># ----------------------------------------------------------------------------------------------</span>
<span class="token comment"># 查看当前 端口是否被占用</span>
<span class="token function">netstat</span> <span class="token parameter variable">-ntulp</span> <span class="token operator">|</span><span class="token function">grep</span> <span class="token number">10000</span>
<span class="token function">netstat</span> <span class="token parameter variable">-ntulp</span> <span class="token operator">|</span><span class="token function">grep</span> <span class="token number">22</span>
<span class="token function">netstat</span> -anp<span class="token operator">|</span><span class="token function">grep</span> <span class="token number">22</span>

<span class="token comment"># 挂载、命名、生成容器</span>
<span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">-p</span> <span class="token number">10000</span>:22 userTestssh /bin/bash
<span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--name</span><span class="token operator">=</span><span class="token string">"user"</span> <span class="token parameter variable">-p</span> <span class="token number">10000</span>:22   ubuntu_git_ssh /bin/bash
<span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--name</span><span class="token operator">=</span><span class="token string">"user"</span> <span class="token parameter variable">-p</span> <span class="token number">10000</span>:22 <span class="token parameter variable">-v</span> /home/user:/home/user <span class="token parameter variable">-v</span> /home/down/:/home/down/ ubuntu_init_ssh /bin/bash
<span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--name</span><span class="token operator">=</span><span class="token string">"user"</span> <span class="token parameter variable">--device</span> /dev/net/tun:/dev/net/tun <span class="token parameter variable">-p</span> <span class="token number">10000</span>:22 <span class="token parameter variable">-v</span> /home/user:/home/user  ubuntu_yocto_clean:latest /bin/bash
<span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--name</span><span class="token operator">=</span><span class="token string">"user"</span> <span class="token parameter variable">--privileged</span>  <span class="token parameter variable">-p</span> <span class="token number">10000</span>:22  <span class="token parameter variable">-v</span> /home/user:/home/user  ubuntu_yocto_clean:latest /bin/bash
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token parameter variable">-p</span> <span class="token number">10000</span>:22 userTestssh /bin/bash

<span class="token comment"># 容器挨个新建用户，挨个赋权限测试</span>
<span class="token comment"># sudo adduser user</span>
addgroup SoftSec1 --force-badname
<span class="token function">useradd</span> <span class="token parameter variable">-m</span> user
<span class="token function">usermod</span> <span class="token parameter variable">-g</span> SoftSec1 user
<span class="token function">usermod</span> <span class="token parameter variable">-s</span> /bin/bash  user
<span class="token function">passwd</span> user

<span class="token comment"># 修改用户id , 组id</span>
<span class="token function">vi</span> /etc/passwd   <span class="token comment"># user id</span>
<span class="token function">vi</span> /etc/group    <span class="token comment"># SoftSec1 id</span>

<span class="token comment"># Ubuntu添加用户并赋sudo权限</span>
<span class="token function">usermod</span> <span class="token parameter variable">-aG</span> <span class="token function">sudo</span> user
<span class="token function">id</span> user

<span class="token comment"># ssh 连接测试</span>
<span class="token comment"># 容器</span>
<span class="token function">docker</span> container start user
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> user /bin/bash /etc/init.d/ssh start
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span>
<span class="token function">ssh</span> user@xxxxxxxx <span class="token parameter variable">-p</span> <span class="token number">10000</span>
</code></pre> 
<h5><a id="docker__414"></a>docker 挂载</h5> 
<p>docker 挂载文件系统，如果docker 有挂载权限 mount /dev/sdd /opt</p> 
<pre><code class="prism language-shell"><span class="token comment"># --privileged=true 允许挂载的危险操作 ！！！！ 谨慎使用！</span>
<span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--name</span><span class="token operator">=</span><span class="token string">"test_mount"</span> <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true <span class="token parameter variable">-p</span> <span class="token number">10000</span>:22 ubuntu_ssh:latest /bin/bash

<span class="token comment"># mount 挂载</span>
<span class="token builtin class-name">cd</span> <span class="token builtin class-name">.</span>   <span class="token comment"># 刷新当前目录，mount 挂载后要先刷新当前目录，才能体现出挂载的文件</span>
<span class="token function">ls</span> <span class="token parameter variable">-l</span>  <span class="token comment"># 刷新后查看，已有文件。</span>
 <span class="token function">mount</span> /dev/sdb /opt/
 <span class="token function">ls</span>
 <span class="token function">df</span> <span class="token parameter variable">-h</span>
 <span class="token builtin class-name">cd</span> <span class="token builtin class-name">.</span>
 ll
 <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>./test.ext4 <span class="token assign-left variable">bs</span><span class="token operator">=</span>1M <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">10</span>   <span class="token comment"># 制作文件系统</span>
 <span class="token function">sync</span>
 <span class="token function">sudo</span> mkfs.ext4 test.ext4 <span class="token parameter variable">-F</span>
 mkfs.ext4 test.ext4 <span class="token parameter variable">-F</span>
 <span class="token function">mkdir</span> test_mntdir
 <span class="token function">mount</span> test.ext4 test_mntdir/
 <span class="token builtin class-name">cd</span> <span class="token builtin class-name">test</span>
 <span class="token builtin class-name">cd</span> test_mntdir/
 <span class="token function">ls</span>
 <span class="token function">history</span>
 
<span class="token comment">#### output:</span>
<span class="token comment"># -----------------------------------------------------------------------------------</span>
root@eb12da5ce152:/opt<span class="token comment"># dd if=/dev/zero of=./test.ext4 bs=1M count=10</span>
<span class="token number">10</span>+0 records <span class="token keyword">in</span>
<span class="token number">10</span>+0 records out
<span class="token number">10485760</span> bytes <span class="token punctuation">(</span><span class="token number">10</span> MB, <span class="token number">10</span> MiB<span class="token punctuation">)</span> copied, <span class="token number">0.0056286</span> s, <span class="token number">1.9</span> GB/s
root@eb12da5ce152:/opt<span class="token comment"># sync</span>
root@eb12da5ce152:/opt<span class="token comment"># mk^C</span>
root@eb12da5ce152:/opt<span class="token comment"># ^C</span>
root@eb12da5ce152:/opt<span class="token comment"># ^C</span>
root@eb12da5ce152:/opt<span class="token comment"># sudo mkfs.ext4 test.ext4 -F</span>
bash: sudo: <span class="token builtin class-name">command</span> not found
root@eb12da5ce152:/opt<span class="token comment"># mkfs.ext4 test.ext4 -F</span>
<span class="token function">mke2fs</span> <span class="token number">1.44</span>.1 <span class="token punctuation">(</span><span class="token number">24</span>-Mar-2018<span class="token punctuation">)</span>
Discarding device blocks: <span class="token keyword">done</span>
Creating filesystem with <span class="token number">10240</span> 1k blocks and <span class="token number">2560</span> inodes
Filesystem UUID: cca0f45a-03b2-455f-8456-09f803c5dc71
Superblock backups stored on blocks:
        <span class="token number">8193</span>

Allocating group tables: <span class="token keyword">done</span>
Writing inode tables: <span class="token keyword">done</span>
Creating journal <span class="token punctuation">(</span><span class="token number">1024</span> blocks<span class="token punctuation">)</span>: <span class="token keyword">done</span>
Writing superblocks and filesystem accounting information: <span class="token keyword">done</span>

root@eb12da5ce152:/opt<span class="token comment"># mkdir test_mntdir</span>
root@eb12da5ce152:/opt<span class="token comment"># mount test.ext4 test_mntdir/</span>
root@eb12da5ce152:/opt<span class="token comment"># cd test</span>
bash: cd: test: No such <span class="token function">file</span> or directory
root@eb12da5ce152:/opt<span class="token comment"># ls^C</span>
root@eb12da5ce152:/opt<span class="token comment"># cd test_mntdir/</span>
root@eb12da5ce152:/opt/test_mntdir<span class="token comment"># ls</span>
lost+found
<span class="token comment"># -----------------------------------------------------------------------------------</span>
</code></pre> 
<h5><a id="docker_container__notion_479"></a>docker container 的脚本文件在 notion</h5> 
<p>qweqw</p> 
<h4><a id="6___Docker__482"></a>6 Docker 问答录</h4> 
<p>Docker 问答录： https://blog.lab99.org/post/docker-2016-07-14-faq.html</p> 
<h4><a id="7__wiki_486"></a>7 搭建 wiki</h4> 
<pre><code class="prism language-bash"><span class="token function">docker</span> pull mysql

<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-v</span> /data/mysql/data:/var/lib/mysql <span class="token parameter variable">-v</span> /data/mysql/conf:/etc/mysql/conf.d <span class="token parameter variable">--name</span> mysql <span class="token parameter variable">-e</span> <span class="token assign-left variable">TZ</span><span class="token operator">=</span>Asia/Shanghai  <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">1234</span> <span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 mysql:latest
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mysql <span class="token function">bash</span>
mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span>

use mysql<span class="token punctuation">;</span>

create user <span class="token string">'wiki'</span>@<span class="token string">'localhost'</span> identified by <span class="token string">'1234'</span><span class="token punctuation">;</span>
create user <span class="token string">'wiki'</span>@<span class="token string">'%'</span> identified by <span class="token string">'1234'</span><span class="token punctuation">;</span>
create database <span class="token variable"><span class="token variable">`</span>wiki<span class="token variable">`</span></span><span class="token punctuation">;</span>

grant all privileges on wiki.* to <span class="token string">'wiki'</span>@<span class="token string">'localhost'</span><span class="token punctuation">;</span>
grant all privileges on wiki.* to <span class="token string">'wiki'</span>@<span class="token string">'%'</span><span class="token punctuation">;</span>
flush privileges<span class="token punctuation">;</span><span class="token keyword">select</span> host,user,authentication_string,plugin from user<span class="token punctuation">;</span>
alter user <span class="token string">'wiki'</span>@<span class="token string">'%'</span> identified with mysql_native_password by <span class="token string">'1234'</span><span class="token punctuation">;</span>

<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">82</span>:3000 <span class="token parameter variable">--name</span> wiki <span class="token parameter variable">--restart</span> unless-stopped <span class="token parameter variable">-e</span> <span class="token string">"DB_TYPE=mysql"</span> <span class="token parameter variable">-e</span> <span class="token string">"DB_HOST=192.168.1.198"</span> <span class="token parameter variable">-e</span> <span class="token string">"DB_PORT=3306"</span> <span class="token parameter variable">-e</span> <span class="token string">"DB_USER=wiki"</span> <span class="token parameter variable">-e</span> <span class="token string">"DB_PASS=1234"</span> <span class="token parameter variable">-e</span> <span class="token string">"DB_NAME=wiki"</span> requarks/wiki:latest 

http://172.17.0.3:3000
</code></pre> 
<h4><a id="8__xwiki_511"></a>8 搭建 xwiki</h4> 
<pre><code class="prism language-bash"><span class="token comment"># 使用docker搭建xwiki</span>

<span class="token comment"># 部署xwiki</span>
<span class="token comment"># 使用docker现成的xwiki模板来部署</span>

<span class="token comment"># 查看端口号</span>
<span class="token function">netstat</span> <span class="token parameter variable">-tln</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">10000</span>

<span class="token comment"># 创建网络</span>
<span class="token function">docker</span> network create <span class="token parameter variable">-d</span> bridge xwiki-nw

<span class="token comment"># 创建mysql</span>
<span class="token function">docker</span> run <span class="token parameter variable">--net</span><span class="token operator">=</span>xwiki-nw <span class="token parameter variable">--name</span> mysql-xwiki <span class="token parameter variable">-v</span> /home/project/mysql:/var/lib/mysql <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span>xwiki <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_USER</span><span class="token operator">=</span>xwiki <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_PASSWORD</span><span class="token operator">=</span>xwiki <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_DATABASE</span><span class="token operator">=</span>xwiki <span class="token parameter variable">-d</span> mysql:5.7 --character-set-server<span class="token operator">=</span>utf8 --collation-server<span class="token operator">=</span>utf8_bin --explicit-defaults-for-timestamp<span class="token operator">=</span><span class="token number">1</span>

<span class="token comment"># 创建xwiki</span>
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--net</span><span class="token operator">=</span>xwiki-nw <span class="token parameter variable">--name</span> xwiki <span class="token parameter variable">-p</span> <span class="token number">10000</span>:8080 <span class="token parameter variable">-v</span> /home/project/xwiki:/usr/local/xwiki <span class="token parameter variable">-e</span> <span class="token assign-left variable">DB_USER</span><span class="token operator">=</span>xwiki <span class="token parameter variable">-e</span> <span class="token assign-left variable">DB_PASSWORD</span><span class="token operator">=</span>xwiki <span class="token parameter variable">-e</span> <span class="token assign-left variable">DB_DATABASE</span><span class="token operator">=</span>xwiki <span class="token parameter variable">-e</span> <span class="token assign-left variable">DB_HOST</span><span class="token operator">=</span>mysql-xwiki xwiki:mysql-tomcat
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e1996f8e46d4250acbb87ef1d67045bb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">jetpack compose系列（入门基础案例讲解）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e7841ca8cdec4165fdc1881bfb3995b8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python3安装及pip3 报ERROR: No matching distribution found for</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>