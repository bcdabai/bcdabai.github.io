<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用kettle批量同步表 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用kettle批量同步表" />
<meta property="og:description" content="一、需求
使用kettle将源库多张表批量同步到目标库。
二、设计
整体设计流程如下：
1、在数据开始同步前，在目标库中的日志表记录数据同步开始时间；
2、将所有需要同步的表名放在目标库的一张表中，在kettle中读取这些表名；
3、循环读取每一个表名，进行表数据同步；
4、所有表同步完成后，更新日志表的结束时间。
整个job如下：
下面再详细看看job里的每个组件：
1、trans_begin
组件：General-&gt;Transformation
功能：更新日志表里数据同步开始时间。
配置如下：
2、trans_youxin_tablename
组件：General-&gt;Transformation
功能：读取所有要同步的表名。
2.1 Table input
组件：Input-&gt;Table input
功能：目标库有一张表存放所有要同步的表名，读取这张表记录。（表里面有两个字段：序列号SEQ_NO、表名TABLE_NAME，序列号从1开始递增）
2.2 Select values
组件：Transform-&gt;Select values
功能：获取所有表名。
2.3 Copy rows to result
组件：Utility-&gt;Clone row
功能：将表名放到结果集。
3、variable_set
组件：Scripting-&gt;JavaScript
功能：设置变量。
内容如下：
var prevRow=previous_result.getRows(); if (prevRow == null &amp;&amp;(prevRow.size()=0)) { false; }else{ parent_job.setVariable(&#34;tables&#34;, prevRow); parent_job.setVariable(&#34;size&#34;, prevRow.size()); parent_job.setVariable(&#34;i&#34;, 0); parent_job.setVariable(&#34;tablename&#34;, prevRow.get(0).getString(&#34;TABLE_NAME&#34;,&#34;&#34;)); true; } 4、 variable_loop
组件：Conditions-&gt;simple evaluation
功能：循环读取每个表名。
5、trans_youxin_data
组件：General-&gt;Transformation
功能：将源表同步到目标表。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/cad9f170421fc4127316d1df1c32cddb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-05-08T15:46:48+08:00" />
<meta property="article:modified_time" content="2019-05-08T15:46:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用kettle批量同步表</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>一、需求</strong></p> 
<p>使用kettle将源库多张表批量同步到目标库。</p> 
<p><strong>二、设计</strong></p> 
<p>整体设计流程如下：</p> 
<p>1、在数据开始同步前，在目标库中的日志表记录数据同步开始时间；<br> 2、将所有需要同步的表名放在目标库的一张表中，在kettle中读取这些表名；<br> 3、循环读取每一个表名，进行表数据同步；<br> 4、所有表同步完成后，更新日志表的结束时间。</p> 
<p>整个job如下：<br> <img src="https://images2.imgbox.com/2b/1f/mZ4wiP87_o.png" alt="在这里插入图片描述"><br> 下面再详细看看job里的每个组件：</p> 
<p><strong>1、trans_begin</strong></p> 
<p>组件：General-&gt;Transformation<br> 功能：更新日志表里数据同步开始时间。<br> <img src="https://images2.imgbox.com/86/dd/df2TwPDd_o.png" alt="在这里插入图片描述"><br> 配置如下：<br> <img src="https://images2.imgbox.com/94/88/0Pyf091t_o.png" alt="在这里插入图片描述"><br> <strong>2、trans_youxin_tablename</strong></p> 
<p>组件：General-&gt;Transformation<br> 功能：读取所有要同步的表名。<br> <img src="https://images2.imgbox.com/a4/b7/lgKCEqiy_o.png" alt="在这里插入图片描述"><br> <strong>2.1 Table input</strong></p> 
<p>组件：Input-&gt;Table input<br> 功能：目标库有一张表存放所有要同步的表名，读取这张表记录。（表里面有两个字段：序列号SEQ_NO、表名TABLE_NAME，序列号从1开始递增）<br> <img src="https://images2.imgbox.com/8a/3c/S9t7KpIL_o.png" alt="在这里插入图片描述"><br> <strong>2.2 Select values</strong></p> 
<p>组件：Transform-&gt;Select values<br> 功能：获取所有表名。<br> <img src="https://images2.imgbox.com/27/0a/JkSBt8gn_o.png" alt="在这里插入图片描述"><br> <strong>2.3 Copy rows to result</strong></p> 
<p>组件：Utility-&gt;Clone row<br> 功能：将表名放到结果集。<br> <img src="https://images2.imgbox.com/19/d6/2qg6apL5_o.png" alt="在这里插入图片描述"><br> <strong>3、variable_set</strong></p> 
<p>组件：Scripting-&gt;JavaScript<br> 功能：设置变量。</p> 
<p>内容如下：</p> 
<pre><code>var prevRow=previous_result.getRows();
if (prevRow == null &amp;&amp;(prevRow.size()=0))
{
	false;
  
}else{
    parent_job.setVariable("tables", prevRow);
	parent_job.setVariable("size", prevRow.size());
	parent_job.setVariable("i", 0);
	parent_job.setVariable("tablename", prevRow.get(0).getString("TABLE_NAME",""));
	true;
}
</code></pre> 
<p><strong>4、 variable_loop</strong></p> 
<p>组件：Conditions-&gt;simple evaluation<br> 功能：循环读取每个表名。<br> <img src="https://images2.imgbox.com/f2/9a/10m4GzfJ_o.png" alt="在这里插入图片描述"><br> <strong>5、trans_youxin_data</strong></p> 
<p>组件：General-&gt;Transformation<br> 功能：将源表同步到目标表。<br> <img src="https://images2.imgbox.com/2f/0c/MP5dBSBq_o.png" alt="在这里插入图片描述"><br> <strong>5.1 Table input</strong></p> 
<p>组件：Input-&gt;Table input<br> 功能：读取源表数据。<br> <img src="https://images2.imgbox.com/57/51/GY24604h_o.png" alt="在这里插入图片描述"><br> <strong>5.2 Table output</strong></p> 
<p>组件：Output-&gt;Table output<br> 功能：将数据写入目标表。<br> <img src="https://images2.imgbox.com/00/6f/wReqWMNk_o.png" alt="在这里插入图片描述"><br> <strong>5.3 Blocking Step</strong></p> 
<p>组件：Flow-&gt;Blocking Step<br> 功能：在前面的Table input和Table output执行完成之后，才执行后面的update log。<br> <img src="https://images2.imgbox.com/de/7d/IIJSLQbc_o.png" alt="在这里插入图片描述"><br> <strong>5.4 update log</strong></p> 
<p>组件：Scripting-&gt;Execute SQL Script<br> 功能：在步骤2.1可以看到，读取表名是按照SEQ_NO倒序，最后读的是SEQ_NO=1的表名。因为是循环处理每个表的同步，如果发现已经处理到了SEQ_NO=1的表，说明全部表同步完成，这时就可以更新日志表的结束时间。<br> <img src="https://images2.imgbox.com/42/b9/L4OiQ5s0_o.png" alt="在这里插入图片描述"></p> 
<p><strong>6、variable_judge</strong></p> 
<p>组件：Scripting-&gt;JavaScript<br> 功能：获取当前处理的表名。</p> 
<p>内容如下：</p> 
<pre><code>var list_Tables =parent_job.getVariable("tables").replace(" ","").replace("[","").replace("]","").split(",");
var size = new Number(parent_job.getVariable("size"));
var i = new Number(parent_job.getVariable("i"))+1;
if(i&lt;size){
    parent_job.setVariable("tablename", list_Tables[i].trim());
}
parent_job.setVariable("i",i);
true;
</code></pre> 
<p>完毕。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bc6e99f0325842d636c5f27e67862106/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python画对数与半对数坐标</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fab9764559ce6dec1c8d2ea785d2c85a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python爬虫滑块验证</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>