<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>å­çº¿ç¨‹ä¹Ÿèƒ½æ›´æ–°UIï¼Ÿ - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="å­çº¿ç¨‹ä¹Ÿèƒ½æ›´æ–°UIï¼Ÿ" />
<meta property="og:description" content="åœ¨å†™ä¸€ä¸ªå°é¡¹ç›®çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ï¼Œåœ¨å­çº¿ç¨‹é‡Œé¢æœ‰ä¸¤ä¸ªæ›´æ–°UIæ“ä½œï¼Œä½†æ˜¯å‰é¢ä¸€ä¸ªä¸æŠ¥é”™ï¼Œåé¢ä¸€ä¸ªæŠ¥é”™äº†ã€‚
æˆ‘ç¡®å®æ²¡æœ‰ä¹±è¯´ï¼Œä»£ç (å®Œæ•´ä»£ç ,åé¢logå¯¹åº”è¡Œæ•°éƒ½æ˜¯å‡†çš„)å¦‚ä¸‹ï¼š
package com.demo.text_demo; import androidx.appcompat.app.AppCompatActivity; import android.os.Bundle; import android.util.Log; import android.view.View; import android.widget.TextView; import com.demo.R; import java.io.PrintWriter; import java.io.StringWriter; public class TextDemoActivity extends AppCompatActivity implements View.OnClickListener { private TextView tv_refresh_text; private TextView tv_refresh_text_too; @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_text_demo); tv_refresh_text = findViewById(R.id.tv_refresh_text); tv_refresh_text_too= findViewById(R.id.tv_refresh_text_too); tv_refresh_text.setOnClickListener(this); } @Override public void onClick(View v) { logUtils(&#34;onClick: &#34; &#43; Thread.currentThread().getName()); Thread newThread = new Thread(new Runnable() { @Override public void run() { logUtils(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/159978185fa0df443c13ec4a1ddec6c0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-04T03:55:39+08:00" />
<meta property="article:modified_time" content="2022-10-04T03:55:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">å­çº¿ç¨‹ä¹Ÿèƒ½æ›´æ–°UIï¼Ÿ</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>åœ¨å†™ä¸€ä¸ªå°é¡¹ç›®çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ï¼Œåœ¨å­çº¿ç¨‹é‡Œé¢æœ‰ä¸¤ä¸ªæ›´æ–°UIæ“ä½œï¼Œä½†æ˜¯å‰é¢ä¸€ä¸ªä¸æŠ¥é”™ï¼Œåé¢ä¸€ä¸ªæŠ¥é”™äº†ã€‚</p> 
<p><img alt="" height="126" src="https://images2.imgbox.com/62/79/OUk8i3LS_o.jpg" width="126"></p> 
<p>æˆ‘ç¡®å®æ²¡æœ‰ä¹±è¯´ï¼Œä»£ç (å®Œæ•´ä»£ç ,åé¢logå¯¹åº”è¡Œæ•°éƒ½æ˜¯å‡†çš„)å¦‚ä¸‹ï¼š</p> 
<pre><code class="language-java">package com.demo.text_demo;

import androidx.appcompat.app.AppCompatActivity;

import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.TextView;

import com.demo.R;


import java.io.PrintWriter;
import java.io.StringWriter;

public class TextDemoActivity extends AppCompatActivity implements View.OnClickListener {

    private TextView tv_refresh_text;
    private TextView tv_refresh_text_too;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_text_demo);

        tv_refresh_text = findViewById(R.id.tv_refresh_text);
        tv_refresh_text_too= findViewById(R.id.tv_refresh_text_too);
        tv_refresh_text.setOnClickListener(this);

    }


    @Override
    public void onClick(View v) {
        logUtils("onClick: " + Thread.currentThread().getName());
        Thread newThread = new Thread(new Runnable() {
            @Override
            public void run() {
                logUtils("newThread: " + Thread.currentThread().getName());
                try {
                    tv_refresh_text.setText("æˆ‘æ›´æ–°äº†è‡ªå·±");
                     tv_refresh_text_too.setText("æˆ‘ä¹Ÿè¦æ›´æ–°è‡ªå·±123456789123456789æˆ‘ä¹Ÿè¦æ›´æ–°è‡ªå·±123456789123456789");
               
                } catch (Exception e) {
                    logException(e);
                }
            }
        });
        newThread.start();
    }


    private void logUtils(String msg) {

        Log.e("textDemo", msg);

    }

    private void logException(Exception e) {
        StringWriter sw = new StringWriter();
        e.printStackTrace(new PrintWriter(sw));
        logUtils(sw.toString());
    }
}</code></pre> 
<p>å¸ƒå±€æ–‡ä»¶ï¼š</p> 
<pre><code class="language-html">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:gravity="center"
    android:orientation="vertical"
    tools:context=".text_demo.TextDemoActivity"&gt;

    &lt;TextView
        android:id="@+id/tv_refresh_text"
        android:layout_width="match_parent"
        android:layout_height="@dimen/dp_30"
        android:text="æ–‡æœ¬1"
        android:gravity="center"
        android:textColor="@color/black"
        android:textSize="@dimen/sp_16" /&gt;

    &lt;TextView
        android:id="@+id/tv_refresh_text_too"
        android:layout_width="match_parent"
        android:layout_marginTop="10dp"
        android:layout_height="wrap_content"
        android:text="æ–‡æœ¬2"
        android:textColor="@color/black"
        android:textSize="@dimen/sp_16" /&gt;
&lt;/LinearLayout&gt;</code></pre> 
<p>é¡µé¢å¾ˆç®€å•ï¼Œä¸¤è¡Œæ–‡æœ¬ï¼Œç‚¹å‡»ä¸Šé¢çš„TextView ä¼šåœ¨ä¸€ä¸ªå­çº¿ç¨‹ä¸­å¯¹ä¸¤ä¸ªTextViewè¿›è¡ŒsetText()æ“ä½œã€‚</p> 
<p></p> 
<p>ç‚¹å‡»ä»¥åæŠ¥é”™å¦‚ä¸‹</p> 
<p><span style="color:#f33b45;">2021-01-25 15:20:26.024 E/textDemo: onClick: main<br> 2021-01-25 15:20:26.025 E/textDemo: newThread: Thread-3<br> 2021-01-25 15:20:26.028 E/textDemo: android.view.ViewRootImpl$CalledFromWrongThreadException: Only the original thread that created a view hierarchy can touch its views.<br> Â  Â  Â  Â  at android.view.ViewRootImpl.checkThread(ViewRootImpl.java:8913)<br> Â  Â  Â  Â  at android.view.ViewRootImpl.requestLayout(ViewRootImpl.java:1557)<br> Â  Â  Â  Â  at android.view.View.requestLayout(</span>View.java:24694<span style="color:#f33b45;">)<br> Â  Â  Â  Â  at android.view.View.requestLayout(</span>View.java:24694<span style="color:#f33b45;">)<br> Â  Â  Â  Â  at android.view.View.requestLayout(</span>View.java:24694<span style="color:#f33b45;">)<br> Â  Â  Â  Â  at android.view.View.requestLayout(</span>View.java:24694<span style="color:#f33b45;">)<br> Â  Â  Â  Â  at android.view.View.requestLayout(</span>View.java:24694<span style="color:#f33b45;">)<br> Â  Â  Â  Â  at android.view.View.requestLayout(</span>View.java:24694<span style="color:#f33b45;">)<br> Â  Â  Â  Â  at android.view.View.requestLayout(</span>View.java:24694<span style="color:#f33b45;">)<br> Â  Â  Â  Â  at android.widget.TextView.checkForRelayout(</span>TextView.java:9750<span style="color:#f33b45;">)<br> Â  Â  Â  Â  at android.widget.TextView.setText(</span>TextView.java:6314<span style="color:#f33b45;">)<br> Â  Â  Â  Â  at android.widget.TextView.setText(</span>TextView.java:6142<span style="color:#f33b45;">)<br> Â  Â  Â  Â  at android.widget.TextView.setText(</span>TextView.java:6094<span style="color:#f33b45;">)<br> Â  Â  Â  Â  at com.sz.edit_sn.text_demo.TextDemoActivity$1.run(</span><span style="color:#3399ea;">TextDemoActivity.java:42</span><span style="color:#f33b45;">)<br> Â  Â  Â  Â  at java.lang.Thread.run(</span>Thread.java:929<span style="color:#f33b45;">)</span></p> 
<p>æŠ¥é”™çš„æ˜¯åé¢çš„ tv_refresh_text_too.setText("æˆ‘ä¹Ÿè¦æ›´æ–°è‡ªå·±123456789123456789æˆ‘ä¹Ÿè¦æ›´æ–°è‡ªå·±123456789123456789"); å‰é¢çš„ tv_refresh_text.setText("æˆ‘æ›´æ–°äº†è‡ªå·±")æ²¡æœ‰æŠ¥é”™ï¼Œæ‰‹æœºç•Œé¢ä¸­UIéƒ½æ›´æ–°æˆåŠŸäº†ã€‚</p> 
<pre><code class="language-java"> @Override
    public void onClick(View v) {
        logUtils("onClick: " + Thread.currentThread().getName());
        Thread newThread = new Thread(new Runnable() {
            @Override
            public void run() {
                logUtils("newThread: " + Thread.currentThread().getName());
                try {
                    tv_refresh_text.setText("æˆ‘æ›´æ–°äº†è‡ªå·±");     â† è¿™ä¸€è¡Œæ²¡æŠ¥é”™å¹¶æ›´æ–°UIæˆåŠŸ
                    tv_refresh_text_too.setText("æˆ‘ä¹Ÿè¦æ›´æ–°è‡ªå·±123456789123456789æˆ‘ä¹Ÿè¦æ›´æ–°è‡ªå·±123456789123456789");  â† è¿™ä¸€è¡ŒæŠ¥é”™
                } catch (Exception e) {
                    logException(e);
                }
            }
        });
        newThread.start();
    }</code></pre> 
<p>ç¡®å®æ˜¯å­çº¿ç¨‹ä¸¤ä¸ªæ›´æ–°UIæ“ä½œï¼Œå‰ä¸€ä¸ªæ²¡æŠ¥é”™ï¼Œåä¸€ä¸ªæŠ¥é”™äº†ã€‚ã€‚ã€‚</p> 
<p>ä»æ—¥å¿—æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºæ›´æ–°TextViewæ“ä½œæ˜¯åœ¨<span style="color:#f33b45;">newThread: Thread-3</span>ä¸­è¿›è¡Œçš„</p> 
<p>å­çº¿ç¨‹ä¸æ˜¯ä¸èƒ½è¿›è¡ŒUIæ›´æ–°æ“ä½œä¹ˆï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</p> 
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ tv_refresh_text.setText() ä¸ºå•¥æ²¡æœ‰æŠ¥é”™</p> 
<p><em>Read</em>Â <em>the</em>Â <em>fucking</em>Â source code ! (PS: å¯ä»¥ç›´æ¥è·³åˆ°æœ€åçœ‹æ€»ç»“)</p> 
<pre><code class="language-java">tv_refresh_text.setText("æˆ‘æ›´æ–°äº†è‡ªå·±");
                ğŸ‘‡
                ğŸ‘‡ è°ƒç”¨
                ğŸ‘‡
public class TextView extends View implements ViewTreeObserver.OnPreDrawListener {


    
    public final void setText(CharSequence text) {
        setText(text, mBufferType);  
      }
                   ğŸ‘‡
    public void setText(CharSequence text, BufferType type) {
          setText(text, type, true, 0);

         
      }
                    ğŸ‘‡ âœæœ€ç»ˆè°ƒç”¨è¿™ä¸ªæ–¹æ³•
    private void setText(CharSequence text, BufferType type,
                                             boolean notifyBefore, int oldlen) {
        mTextSetFromXmlOrResourceId = false;
        if (text == null) {
            text = "";
        }

       
        âš ï¸ Spanned æˆ‘ä»¬æ²¡æœ‰è®¾ç½®ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹SpannableString
        if (text instanceof Spanned &amp;&amp; ... ) {
                ...
                ...   

            âš ï¸ å¦‚æœæ‚¨æˆ‘ä»¬è®¾ç½®äº†Spannerè¿™é‡Œä¼šæ”¹å˜ mEllipsize çš„å€¼
               ä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰ã€‚
              â— æ³¨æ„ mEllipsize è¿™ä¸ªå˜é‡åé¢ä¼šç”¨åˆ°å¾ˆé‡è¦ â—
            setEllipsize(TextUtils.TruncateAt.MARQUEE);

        }

        ...çœç•¥ä»£ç ...

        if (mLayout != null) {
            checkForRelayout();âœ æˆ‘ä»¬æ¥ç€å»çœ‹checkForRelayout()
        }

        sendOnTextChanged(text, 0, oldlen, textLength);
        onTextChanged(text, 0, oldlen, textLength);

        ...... 
    }
                      ğŸ‘‡
    private void checkForRelayout() {
        // If we have a fixed width, we can just swap in a new text layout
        // if the text height stays the same or if the view height is fixed.
        
        if ((mLayoutParams.width != LayoutParams.WRAP_CONTENT
                || (mMaxWidthMode == mMinWidthMode &amp;&amp; mMaxWidth == mMinWidth))
                &amp;&amp; (mHint == null || mHintLayout != null)
                &amp;&amp; (mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight() &gt; 0)) {
            // Static width, so try making a new text layout.

            int oldht = mLayout.getHeight();
            int want = mLayout.getWidth();
            int hintWant = mHintLayout == null ? 0 : mHintLayout.getWidth();

            /*
             * No need to bring the text into view, since the size is not
             * changing (unless we do the requestLayout(), in which case it
             * will happen at measure).
             */
        makeNewLayout(want, hintWant, UNKNOWN_BORING, UNKNOWN_BORING,
           mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight(),           
                                                                            false);
            âœè¿˜è®°å¾—ä¸Šé¢çš„ mEllipsize ä¹ˆï¼Œæˆ‘ä»¬æ²¡æœ‰è®¾ç½®
               æ‰€ä»¥mEllipsize != TextUtils.TruncateAt.MARQUEEä¸ºtrue
            if (mEllipsize != TextUtils.TruncateAt.MARQUEE) {
                // In a fixed-height view, so use our new text layout.
                âœè¿™é‡Œçš„è¯´é«˜åº¦ä¸æ˜¯WRAP_CONTENTä¹Ÿä¸æ˜¯MATCH_PARENT
                   å°±æ˜¯ä¸€ä¸ªå†™æ­»çš„å›ºå®šé«˜åº¦æ¯”å¦‚å†™æ­»60dp
                   tv_refresh_text.setText()å°±æ˜¯è¿›å…¥è¿™ä¸ªåˆ¤æ–­æ¡ä»¶ã€‚
                if (mLayoutParams.height != LayoutParams.WRAP_CONTENT
                        &amp;&amp; mLayoutParams.height != LayoutParams.MATCH_PARENT) {
                    autoSizeText();âœ autoSizeTextType Android8.0æ–°ç‰¹æ€§
                    invalidate();
                    return;
                }

                // Dynamic height, but height has stayed the same,
                // so use our new text layout.
                âœä¸æ»¡è¶³ä¸Šä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œä½†æ˜¯æ–°çš„TextViewçš„é«˜åº¦å’ŒåŸæ¥çš„é«˜åº¦æ²¡æœ‰æ”¹å˜
                   å°±èµ°è¿™ä¸ªåˆ¤æ–­æ¡ä»¶  
                if (mLayout.getHeight() == oldht
                        &amp;&amp; (mHintLayout == null || mHintLayout.getHeight() == oldht)) {
                    autoSizeText();âœ autoSizeTextType Android8.0æ–°ç‰¹æ€§
                    invalidate();
                    return;
                }
                
               âœ ä¸Šé¢ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶éƒ½ä¼šè°ƒç”¨ invalidate();                 

            }

            // We lose: the height has changed and we have a dynamic height.
            // Request a new view layout using our new text layout.
            requestLayout();âœæ­£å¸¸åˆ·æ–°UIå°±èµ°è¿™é‡Œçš„æµç¨‹ï¼Œtv_refresh_text_too å°±æ˜¯èµ°è¿™é‡Œï¼Œ                
                               å…ˆä¸çœ‹ï¼Œåé¢å†åˆ†æ
            invalidate();
        } else {
            // Dynamic width, so we have no choice but to request a new
            // view layout with a new text layout.
            nullLayouts();
            requestLayout();âœ å®½åº¦åŠ¨æ€å˜åŒ–ï¼Œåˆ«æ— é€‰æ‹©åªèƒ½é‡æ–°å¸ƒå±€
            invalidate();
        }
    }
}</code></pre> 
<p>View # invalidate() æ–¹æ³•Â :</p> 
<pre><code class="language-java">public class View implements ... { 
    public void invalidate() {
            invalidate(true);
    }             ğŸ‘‡
                  ğŸ‘‡
    public void invalidate(boolean invalidateCache) {
        invalidateInternal(0, 0, mRight - mLeft, mBottom - mTop, invalidateCache, true);
    }             ğŸ‘‡
                  ğŸ‘‡
    void invalidateInternal(int l, int t, int r, int b, boolean invalidateCache,
            boolean fullInvalidate) {
        if (mGhostView != null) {
            âœè’™å±‚å¸ƒå±€ï¼Œæˆ‘ä»¬æ²¡æœ‰ï¼Œä¸ç”¨ç®¡
            mGhostView.invalidate(true);
            return;
        }

        if (skipInvalidate()) {
            âœä¸å¯è§æˆ–è€…é€æ˜ç›´æ¥è¿”å›
            return;
        }

        if ((mPrivateFlags &amp; (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)) == (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)
                || (invalidateCache &amp;&amp; (mPrivateFlags &amp; PFLAG_DRAWING_CACHE_VALID) == PFLAG_DRAWING_CACHE_VALID)
                || (mPrivateFlags &amp; PFLAG_INVALIDATED) != PFLAG_INVALIDATED
                || (fullInvalidate &amp;&amp; isOpaque() != mLastIsOpaque)) {
            if (fullInvalidate) {
                mLastIsOpaque = isOpaque();
                mPrivateFlags &amp;= ~PFLAG_DRAWN;
            }

            mPrivateFlags |= PFLAG_DIRTY;

            if (invalidateCache) {
                mPrivateFlags |= PFLAG_INVALIDATED;
                mPrivateFlags &amp;= ~PFLAG_DRAWING_CACHE_VALID;
            }

            // Propagate the damage rectangle to the parent view.
            final AttachInfo ai = mAttachInfo;
            final ViewParent p = mParent;âœ p = mParent
            if (p != null &amp;&amp; ai != null &amp;&amp; l &lt; r &amp;&amp; t &lt; b) {
                final Rect damage = ai.mTmpInvalRect;
                damage.set(l, t, r, b);
           âœå³mParent.invalidateChildï¼Œè¿™é‡ŒTextViewçš„çˆ¶å¸ƒå±€ä¸ºLinearlayoutï¼Œ
              Linearlayoutç»§æ‰¿äºViewGroup,æ‰€ä»¥æˆ‘ä»¬åˆ°ViewGroupé‡Œå»çœ‹invalidateChildæ–¹æ³•
                p.invalidateChild(this, damage);
            }

            // Damage the entire projection receiver, if necessary.
            if (mBackground != null &amp;&amp; mBackground.isProjected()) {
                final View receiver = getProjectionReceiver();
                if (receiver != null) {
                    receiver.damageInParent();
                }
            }
        }
    }


}</code></pre> 
<p>ViewGroup # invalidateChildï¼š</p> 
<pre><code class="language-java">@UiThread
public abstract class ViewGroup extends View implements ViewParent, ViewManager {

    @Deprecated
    @Override
    public final void invalidateChild(View child, final Rect dirty) {
        final AttachInfo attachInfo = mAttachInfo;
        âœæ˜¯å¦å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ
        if (attachInfo != null &amp;&amp; attachInfo.mHardwareAccelerated) {
            // HW accelerated fast path
            onDescendantInvalidated(child, child);
            return;
        }
        âœç°åœ¨è¿™ä¸ªthisæ˜¯LinearLayoutç»§æ‰¿äºViewGroup
        ViewParent parent = this;

        if (attachInfo != null) {
               
                ...çœç•¥ä»£ç ...

         
             do {
                View view = null;
                if (parent instanceof View) {âœ parentè‚¯å®šå±äºView
                    view = (View) parent;
                }

                ......
                âœ parent = thiså³è°ƒç”¨ä¸‹é¢çš„invalidateChildInParent
                parent = parent.invalidateChildInParent(location, dirty);
                
                if (view != null) { 
                    // Account for transform on current parent
                    Matrix m = view.getMatrix();
                    if (!m.isIdentity()) {
                        RectF boundingRect = attachInfo.mTmpTransformRect;
                        boundingRect.set(dirty);
                        m.mapRect(boundingRect);
                        dirty.set((int) Math.floor(boundingRect.left),
                                (int) Math.floor(boundingRect.top),
                                (int) Math.ceil(boundingRect.right),
                                (int) Math.ceil(boundingRect.bottom));
                    }
                }
            } while (parent != null);
        }
    }

    @Deprecated
    @Override
    public ViewParent invalidateChildInParent(final int[] location, final Rect dirty) {
        if ((mPrivateFlags &amp; (PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID)) != 0) {
            // either DRAWN, or DRAWING_CACHE_VALID
            if ((mGroupFlags &amp; (FLAG_OPTIMIZE_INVALIDATE | FLAG_ANIMATION_DONE))
                    != FLAG_OPTIMIZE_INVALIDATE) {
                dirty.offset(location[CHILD_LEFT_INDEX] - mScrollX,
                        location[CHILD_TOP_INDEX] - mScrollY);
                if ((mGroupFlags &amp; FLAG_CLIP_CHILDREN) == 0) {
                    dirty.union(0, 0, mRight - mLeft, mBottom - mTop);
                }

                final int left = mLeft;
                final int top = mTop;

                if ((mGroupFlags &amp; FLAG_CLIP_CHILDREN) == FLAG_CLIP_CHILDREN) {
                    if (!dirty.intersect(0, 0, mRight - left, mBottom - top)) {
                        dirty.setEmpty();
                    }
                }

                location[CHILD_LEFT_INDEX] = left;
                location[CHILD_TOP_INDEX] = top;
            } else {

                if ((mGroupFlags &amp; FLAG_CLIP_CHILDREN) == FLAG_CLIP_CHILDREN) {
                    dirty.set(0, 0, mRight - mLeft, mBottom - mTop);
                } else {
                    // in case the dirty rect extends outside the bounds of this container
                    dirty.union(0, 0, mRight - mLeft, mBottom - mTop);
                }
                location[CHILD_LEFT_INDEX] = mLeft;
                location[CHILD_TOP_INDEX] = mTop;

                mPrivateFlags &amp;= ~PFLAG_DRAWN;
            }
            mPrivateFlags &amp;= ~PFLAG_DRAWING_CACHE_VALID;
            if (mLayerType != LAYER_TYPE_NONE) {
                mPrivateFlags |= PFLAG_INVALIDATED;
            }
         âœæ³¨æ„è¿™é‡Œè¿”å›çš„æ˜¯ mParent ï¼Œè¿™ä¸ªæ˜¯åœ¨Viewä¸­çš„å˜é‡ï¼Œè¿™æ ·parent = mParent
            å°±èµ°åˆ°äº†å†ä¸Šä¸€å±‚ï¼Œæœ€ç»ˆä¼šè°ƒç”¨parent = ViewRootImpl
            return mParent;
        }

        return null;
    }
}</code></pre> 
<p>æœ€ç»ˆè°ƒç”¨ ViewRootImpl çš„Â  invalidateChildInParent(Â  , )Â Â æ–¹æ³•</p> 
<pre><code class="language-java">public final class ViewRootImpl implements ViewParent,...{ 
    @Override
    public ViewParent invalidateChildInParent(int[] location, Rect dirty) {
        checkThread(); âœ"æ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºä¸»çº¿ç¨‹"
        if (DEBUG_DRAW) Log.v(mTag, "Invalidate child: " + dirty);

        if (dirty == null) {
            invalidate();
            return null;
        } else if (dirty.isEmpty() &amp;&amp; !mIsAnimating) {
            return null;
        }

        if (mCurScrollY != 0 || mTranslator != null) {
            mTempRect.set(dirty);
            dirty = mTempRect;
            if (mCurScrollY != 0) {
                dirty.offset(0, -mCurScrollY);
            }
            if (mTranslator != null) {
                mTranslator.translateRectInAppWindowToScreen(dirty);
            }
            if (mAttachInfo.mScalingRequired) {
                dirty.inset(-1, -1);
            }
        }

        invalidateRectOnScreen(dirty);

        return null;
    }

   void checkThread() {
    âœ"Only the original thread that created a view hierarchy can touch its views."
        "ä¸€ä¸ªç†Ÿæ‚‰çš„å¼‚å¸¸é”™è¯¯"
    if (mThread != Thread.currentThread()) {
      throw new CalledFromWrongThreadException(
        "Only the original thread that created a view hierarchy can touch its views.");
        }
    }


}</code></pre> 
<p></p> 
<p><img alt="" height="152" src="https://images2.imgbox.com/16/67/W1TpkzD5_o.png" width="152"></p> 
<p>è¿™ä¸æ˜¯è¦æ£€æŸ¥æ˜¯å¦ä¸»çº¿ç¨‹ä¼šæŠ¥é”™çš„ä¹ˆï¼Ÿï¼ï¼ï¼</p> 
<p>æˆ‘ä»¬å›åˆ° ViewGroup#invalidateChild æ–¹æ³•</p> 
<pre><code class="language-java">@UiThread
public abstract class ViewGroup extends View implements ViewParent, ViewManager {

    @Deprecated
    @Override
    public final void invalidateChild(View child, final Rect dirty) {
        final AttachInfo attachInfo = mAttachInfo;
        âœæ˜¯å¦å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ
        if (attachInfo != null &amp;&amp; attachInfo.mHardwareAccelerated) {
            // HW accelerated fast path
            onDescendantInvalidated(child, child);
            return;
        }
        
        .....åé¢ä»£ç çœç•¥.....
    }

    
}</code></pre> 
<p>æ˜¯çš„èµ°äº†ç¡¬ä»¶åŠ é€Ÿï¼Œå°±returnäº†ï¼Œä¸èµ°åé¢äº†ã€‚</p> 
<p>æ¥ç€çœ‹ ViewGroup#onDescendantInvalidated</p> 
<pre><code class="language-java"> @Override
    @CallSuper
    public void onDescendantInvalidated(@NonNull View child, @NonNull View target) {
        /*
         * HW-only, Rect-ignoring damage codepath
         *
         * We don't deal with rectangles here, since RenderThread native code computes damage for
         * everything drawn by HWUI (and SW layer / drawing cache doesn't keep track of damage area)
         */
         .....çœç•¥ä»£ç ......

        if (mParent != null) {
            âœè°ƒç”¨çˆ¶å¸ƒå±€çš„onDescendantInvalidatedï¼Œå°±æ˜¯è¿™ä¸ªæ–¹æ³•æœ¬èº«ï¼Œç›´åˆ°ViewRootImpl
            mParent.onDescendantInvalidated(this, target);
        }
    }</code></pre> 
<p>æ¥ç€çœ‹ ViewRootImpl#onDescendantInvalidated æ–¹æ³•</p> 
<pre><code class="language-java">public final class ViewRootImpl implements ViewParent,
        View.AttachInfo.Callbacks, ThreadedRenderer.DrawCallbacks {    

    @Override
    public void onDescendantInvalidated(@NonNull View child, @NonNull View descendant) {
        if ((descendant.mPrivateFlags &amp; PFLAG_DRAW_ANIMATION) != 0) {
            mIsAnimating = true;
        }
        invalidate();
    }

    void invalidate() {
        mDirty.set(0, 0, mWidth, mHeight);
        if (!mWillDrawSoon) {
            scheduleTraversals();
        }
    }


    final class TraversalRunnable implements Runnable {
        @Override
        public void run() {
            doTraversal();
        }
    }
    final TraversalRunnable mTraversalRunnable = new TraversalRunnable();
    void scheduleTraversals() {
        if (!mTraversalScheduled) {
            mTraversalScheduled = true;
            mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();
            âœå°±æ˜¯æ‰§è¡Œ mTraversalRunnableï¼Œå³doTraversal()æ–¹æ³•,åé¢å°±æ˜¯ç†Ÿæ‚‰çš„ç»˜åˆ¶åŠ è½½UIäº†
            mChoreographer.postCallback(
                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);
            if (!mUnbufferedInputDispatch) {
                scheduleConsumeBatchedInput();
            }
            notifyRendererOfFramePending();
            pokeDrawLockIfNeeded();
        }
    }

   


}</code></pre> 
<p>åˆ°è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°æ²¡æœ‰checkThread()ï¼Œæ‰€ä»¥å°±ä¸ä¼šæŠ¥éä¸»çº¿ç¨‹æ›´æ–°UIé”™è¯¯ï¼Œè€Œæ˜¯ç›´æ¥æ›´æ–°UIäº†ï¼Œæ‰€ä»¥tv_refresh_text.setText("æˆ‘æ›´æ–°äº†è‡ªå·±"); è¿™ä¸ªæ›´æ–°æ“ä½œå°±æ²¡æœ‰æŠ¥é”™ã€‚</p> 
<p>æ„Ÿè§‰æ€ä¹ˆæœ‰ç‚¹ä¸å¯¹åŠ²å‘¢ï¼Œå¼€äº†ç¡¬ä»¶åŠ é€Ÿï¼Œå°±ä¸æ£€æŸ¥çº¿ç¨‹ï¼Œå°±ä¸ä¼šæŠ¥é”™ï¼Œé‚£æˆ‘åªè¦å¼€å¯äº†ç¡¬ä»¶åŠ é€Ÿï¼Œæ‰€æœ‰UIéƒ½å¯ä»¥åœ¨å­çº¿ç¨‹ä¸­æ›´æ–°äº†ï¼Ÿ</p> 
<p>ä¸æ˜¯è¿™æ ·çš„ï¼ŒåŒæ ·çš„æƒ…å†µä¸‹tv_refresh_result.setText("æˆ‘ä¹Ÿæ›´æ–°äº†è‡ªå·±") ä¸å°±æŠ¥é”™äº†ä¹ˆã€‚</p> 
<p>å†å›åˆ°å‰é¢çš„</p> 
<pre><code class="language-java">tv_refresh_text.setText("æˆ‘æ›´æ–°äº†è‡ªå·±");
                ğŸ‘‡
                ğŸ‘‡ è°ƒç”¨
                ğŸ‘‡
public class TextView extends View implements ViewTreeObserver.OnPreDrawListener {


    
    public final void setText(CharSequence text) {
        setText(text, mBufferType);  
      }
                   ğŸ‘‡
    public void setText(CharSequence text, BufferType type) {
          setText(text, type, true, 0);

         
      }
                    ğŸ‘‡ âœæœ€ç»ˆè°ƒç”¨è¿™ä¸ªæ–¹æ³•
    private void setText(CharSequence text, BufferType type,
                                             boolean notifyBefore, int oldlen) {
        m 

        ...çœç•¥ä»£ç ...

        if (mLayout != null) {
            checkForRelayout();âœ æˆ‘ä»¬æ¥ç€å»çœ‹checkForRelayout()
        }

        
        ...... 
    }
                      ğŸ‘‡
    private void checkForRelayout() {
        // If we have a fixed width, we can just swap in a new text layout
        // if the text height stays the same or if the view height is fixed.

        if ((mLayoutParams.width != LayoutParams.WRAP_CONTENT
                || (mMaxWidthMode == mMinWidthMode &amp;&amp; mMaxWidth == mMinWidth))
                &amp;&amp; (mHint == null || mHintLayout != null)
                &amp;&amp; (mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight() &gt; 0)) {
           
            
            if (mEllipsize != TextUtils.TruncateAt.MARQUEE) {
                // In a fixed-height view, so use our new text layout.
                
                âœæ¡ä»¶1 heightä¸ä¸ºWRAP_CONTENTä¹Ÿä¸ä¸ºMATCH_PARENT
                if (mLayoutParams.height != LayoutParams.WRAP_CONTENT
                        &amp;&amp; mLayoutParams.height != LayoutParams.MATCH_PARENT) {
                    ...
                    invalidate();
                    return;
                }

              
                 âœæ¡ä»¶2  heightæ²¡æœ‰å‘ç”Ÿæ”¹å˜å’Œä¹‹å‰ç›¸åŒï¼Œ
                if (mLayout.getHeight() == oldht
                        &amp;&amp; (mHintLayout == null || mHintLayout.getHeight() == oldht)) {
                    ...
                    invalidate();
                    return;
                }
                
                
            }

            
            requestLayout();âœv_refresh_text_too å°±æ˜¯èµ°è¿™é‡Œ               
                               
            invalidate();
        } else {
            // Dynamic width, so we have no choice but to request a new
            // view layout with a new text layout.
            nullLayouts();
            requestLayout();
            invalidate();
        }
    }
}</code></pre> 
<p>åªæœ‰æ»¡è¶³æ¡ä»¶1æˆ–è€…æ¡ä»¶2çš„æƒ…å†µä¸‹ï¼Œå­çº¿ç¨‹æ›´æ–°UIä¸ä¼šæŠ¥é”™ã€‚</p> 
<p>å¦åˆ™å°±åƒÂ tv_refresh_text_too.setText()å°±ä¼šè°ƒç”¨å…¶çˆ¶ç±»Viewçš„Â requestLayout()</p> 
<pre><code class="language-java">View:

    @CallSuper
    public void requestLayout() {
        
        ......

        if (mParent != null &amp;&amp; !mParent.isLayoutRequested()) {
            âœViewGroupæ²¡æœ‰é‡è½½è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥è¿˜æ˜¯Viewè‡ªå·±çš„è¿™ä¸ªæ–¹æ³•
               ç›´åˆ°æœ€ç»ˆè°ƒç”¨ViewRootImpçš„requestLayout()æ–¹æ³•
            mParent.requestLayout();
        }
       
        ......
    }</code></pre> 
<pre><code class="language-java"> ViewRootImp:  
    @Override
    public void requestLayout() {
        if (!mHandlingLayoutInLayoutRequest) {
            checkThread();âœå…ˆæ£€æŸ¥çº¿ç¨‹
            mLayoutRequested = true;
            scheduleTraversals();âœ è¿™ä¸ªç†Ÿæ‚‰çš„æ–¹æ³•
        }
    }</code></pre> 
<p>æ‰€ä»¥åŒæ ·çš„ç¡¬ä»¶åŠ é€Ÿ,tv_refresh_text_too.setText()å°±æŠ¥é”™äº†ã€‚</p> 
<p>å¦å¤–1ï¸âƒ£ï¼šä¸Šé¢æ¡ä»¶1æ¯”è¾ƒå¥½ç†è§£ï¼Œæ¡ä»¶2åˆ°åº•æ˜¯å•¥æ„æ€å‘¢ï¼Ÿ</p> 
<p>å°±æ¯”å¦‚Â  Â  tv_refresh_text_too.setText("æˆ‘ä¹Ÿè¦æ›´æ–°è‡ªå·±123456789123456789æˆ‘ä¹Ÿè¦æ›´æ–°è‡ªå·±123456789123456789"); å¦‚æœæ”¹æˆtv_refresh_text_too.setText("123");</p> 
<p>ä½ ä¼šå‘ç°åœ¨è¿è¡Œdemo ä»–å°±ä¸ä¼šæŠ¥é”™ï¼Œå› ä¸ºå®ƒsetText("123")ä¸ä¼šæ”¹å˜å®ƒä¹‹å‰çš„é«˜åº¦ã€‚</p> 
<p>è€Œ tv_refresh_text_too.setText("æˆ‘ä¹Ÿè¦æ›´æ–°è‡ªå·±123456789123456789æˆ‘ä¹Ÿè¦æ›´æ–°è‡ªå·±123456789123456789");ä¸€è¡Œæ”¾ä¸ä¸‹äº†ä¼šå˜æˆä¸¤è¡Œå±•ç¤ºï¼Œè¿™æ—¶å€™å°±ä¸æ»¡è¶³æ¡ä»¶2é«˜åº¦ä¸å˜çš„é™åˆ¶ï¼Œæ‰€ä»¥ä¼šæŠ¥é”™ï¼</p> 
<p>å¦å¤–2ï¸âƒ£ï¼šå¦‚æœä½ å…³é—­äº†ç¡¬ä»¶åŠ é€Ÿï¼Œåœ¨Mainfestæ–‡ä»¶Activityçš„å£°æ˜ä¸­åŠ ä¸Š android:hardwareAccelerated="false"ï¼Œä½ å†è¿è¡Œå°±ä¼šå‘ç°tv_refresh_text.setText("æˆ‘æ›´æ–°äº†è‡ªå·±");ä¹Ÿä¼šæŠ¥é”™ã€‚</p> 
<p></p> 
<p><span style="color:#f33b45;"><strong>æ€»ç»“ï¼š</strong></span></p> 
<p><span style="color:#f33b45;"><strong>å†™äº†ä¸€å¤§ç¯‡çš„åºŸè¯å…¶å®å°±æ˜¯</strong></span></p> 
<p><span style="color:#f33b45;"><strong>1 å¼€å¯äº†ç¡¬ä»¶åŠ é€Ÿ</strong></span></p> 
<p><span style="color:#f33b45;"><strong>2 åœ¨å®½åº¦å›ºå®šï¼Œé«˜åº¦å†™æ­»å¤šå°‘dp(æ¡ä»¶1) æˆ–è€… æ–°çš„UIå†…å®¹ä¸ä¼šæ”¹å˜ä¹‹å‰UIçš„é«˜åº¦(æ¡ä»¶2)</strong></span></p> 
<p><span style="color:#f33b45;"><strong>è¿™ç§æƒ…å†µä¸‹ï¼Œå­çº¿ç¨‹æ›´æ–°UIä¸ä¼šæŠ¥é”™ï¼</strong></span></p> 
<p></p> 
<p>================================================================</p> 
<p>å­çº¿ç¨‹å¯ä»¥æ›´æ–°UIçš„å…¶å®ƒéªšæ“ä½œï¼</p> 
<pre><code class="language-Kotlin">æ“ä½œ1ï¼šå…ˆrequestLayout å†åœ¨å­çº¿ç¨‹è®¾ç½®UIå°±ä¸ä¼šèµ°checkThread        
        val textView = findViewById&lt;TextView&gt;(R.id.tv_update)

        textView.requestLayout()

        thread {
            textView.text = "haha"
        }</code></pre> 
<pre><code class="language-Kotlin">SurfaceView ä¹Ÿå¯ä»¥å­çº¿ç¨‹æ›´æ–°UI</code></pre> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b54f7d7aab1fd5d45e602257a6bc04d3/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">ã€SSHã€‘SSH å…å¯†ç ç™»å½•é…ç½®|Secure Shell å…å¯†è®¤è¯ç™»å½•|linux ç”Ÿæˆå¯†é’¥</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1a9d8d7219d255abf1607e0d6e9ed625/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">VMware16å®‰è£…windows server 2022æŠ¥è“å±å’ŒNo Mediaé”™è¯¯è§£å†³åŠæ³•ï¼Œå›¾ç‰‡å¦‚ä¸‹ï¼š</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>