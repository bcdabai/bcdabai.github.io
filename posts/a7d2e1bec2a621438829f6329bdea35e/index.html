<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>wireguard windows\linux版本client\server的配置 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="wireguard windows\linux版本client\server的配置" />
<meta property="og:description" content="本文实现三台机器的互联，一台server端，二台客户端，系统均为win,server win10, client 一台win7,一台win10,开源地址：可以下载windows ,mac ,linux ,android各种版本
WireGuard · GitHub
我们下使用的是wireguard-windows版本
windows版本这个既可以当服务端，也可以当客户端来用。首先我们配置一下服务端
配置如下：
服务段配置如下：
[Interface] PrivateKey = gKyDkJ17/xrc/8X7RQDiJpnVMQoCMGkXGbvonLntxXg= ListenPort = 55555 Address = 10.254.0.1/24 [Peer] PublicKey = &#43;iYeKrWo54FskCVmix1rLOXWfnnO4FPnS0J2SNZcWkU= AllowedIPs = 10.254.0.2/32 [Peer] PublicKey = osB5o/qRjglwcnmCCHEAPk23G23l/XAWJoRCnjfnDAI= AllowedIPs = 10.254.0.3/32 Client2端如下
[Interface] PrivateKey = 4Gp4c&#43;SNuZ2HAfD2qQ4JxyTF&#43;OhW&#43;WqE0A/mKLUZa3Y= Address = 10.254.0.2/32 DNS = 114.114.114.114 [Peer] PublicKey = wpCeLCeoTsV9Q3VG7vJnklNxf3qAt53S0vyMPSVaGwA= AllowedIPs = 0.0.0.0/0 Endpoint = 10.10.10.11:55555 PersistentKeepalive = 25 Client3端如下
[Interface] PrivateKey = qANM2T7N/675&#43;zFyRucuOGBtRIegLoTJphdXoKiJAXo= Address = 10." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a7d2e1bec2a621438829f6329bdea35e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-07T19:49:23+08:00" />
<meta property="article:modified_time" content="2023-04-07T19:49:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">wireguard windows\linux版本client\server的配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>本文实现三台机器的互联，一台server端，二台客户端，系统均为win,server win10, client 一台win7,一台win10,开源地址：可以下载windows ,mac ,linux ,android各种版本</p> 
<p><a href="https://github.com/WireGuard" title="WireGuard · GitHub">WireGuard · GitHub</a></p> 
<p><img alt="" height="497" src="https://images2.imgbox.com/0a/ab/LfecQJL0_o.png" width="962"></p> 
<p> 我们下使用的是wireguard-windows版本</p> 
<p><img alt="" height="525" src="https://images2.imgbox.com/9a/84/w9l1ogne_o.png" width="675"></p> 
<p>windows版本这个既可以当服务端，也可以当客户端来用。首先我们配置一下服务端</p> 
<p>配置如下：</p> 
<p><img alt="" height="810" src="https://images2.imgbox.com/40/a8/0Rc1UXJO_o.png" width="1067"></p> 
<p> 服务段配置如下：</p> 
<pre><code>[Interface]
PrivateKey = gKyDkJ17/xrc/8X7RQDiJpnVMQoCMGkXGbvonLntxXg=
ListenPort = 55555
Address = 10.254.0.1/24
[Peer]
PublicKey = +iYeKrWo54FskCVmix1rLOXWfnnO4FPnS0J2SNZcWkU=
AllowedIPs = 10.254.0.2/32

[Peer]
PublicKey = osB5o/qRjglwcnmCCHEAPk23G23l/XAWJoRCnjfnDAI=
AllowedIPs = 10.254.0.3/32
</code></pre> 
<p> Client2端如下</p> 
<pre><code>[Interface]
PrivateKey = 4Gp4c+SNuZ2HAfD2qQ4JxyTF+OhW+WqE0A/mKLUZa3Y=
Address = 10.254.0.2/32
DNS = 114.114.114.114
[Peer]
PublicKey = wpCeLCeoTsV9Q3VG7vJnklNxf3qAt53S0vyMPSVaGwA=
AllowedIPs = 0.0.0.0/0
Endpoint = 10.10.10.11:55555
PersistentKeepalive = 25
</code></pre> 
<p>Client3端如下</p> 
<pre><code>[Interface]
PrivateKey = qANM2T7N/675+zFyRucuOGBtRIegLoTJphdXoKiJAXo=
Address = 10.254.0.3/32
DNS = 114.114.114.114
[Peer]
PublicKey = wpCeLCeoTsV9Q3VG7vJnklNxf3qAt53S0vyMPSVaGwA=
AllowedIPs = 0.0.0.0/0
Endpoint = 10.10.10.11:55555
PersistentKeepalive = 25
</code></pre> 
<p>这样当client2,3连通时，他们所有的IP就都走server了。但是发现打开baidu.com打不开，还要在server上面设定一下</p> 
<p>1， <strong>管理员</strong> 身份打开<code>PowerShell（一定是powershell哦）</code></p> 
<p></p> 
<p>2，查找刚创建的虚拟交换机的接口索引。</p> 
<p>可以通过运行 <code>Get-NetAdapter</code> 来查找接口索引</p> 
<p>你的输出应类似下面的形式：<img alt="" height="203" src="https://images2.imgbox.com/05/46/ZZSzqm4X_o.png" width="844"></p> 
<p>3，使用 <a href="https://learn.microsoft.com/zh-cn/powershell/module/nettcpip/New-NetIPAddress" rel="nofollow" title="New-NetIPAddress">New-NetIPAddress</a> 配置 NAT 网关。 </p> 
<p>New-NetIPAddress -IPAddress &lt;NAT Gateway IP&gt; -PrefixLength &lt;NAT Subnet Prefix Length&gt; -InterfaceIndex &lt;ifIndex&gt;</p> 
<p>若要配置网关，你将需要一些有关你的网络的信息：</p> 
<ul><li> <p><strong>IPAddress</strong> - NAT 网关 IP 指定要用作 NAT 网关 IP 的 IPv4 或 IPv6 地址。<br> 常规形式将为 a.b.c.1（例如 172.16.0.1）。 尽管最后一个位置不一定必须是.1，但通常是（基于前缀长度）</p> <p>通用网关 IP 为 192.168.0.1</p> </li><li> <p><strong>PrefixLength</strong> -- NAT 子网前缀长度定义的 NAT 本地子网大小（子网掩码）。 子网前缀长度将介于 0 到 32 之间的一个整数值。</p> <p>0 将映射整个 Internet，32 则只允许一个映射的 IP。 常用值范围从 24 到 12，具体要取决于多少 IP 需要附加到 NAT。</p> <p>常用 PrefixLength 为 24 -- 这是子网掩码 255.255.255.0</p> </li><li> <p><strong>InterfaceIndex</strong> -- ifIndex 是你在上一步中确定的虚拟交换机的接口索引。</p> </li></ul> 
<p>运行以下内容来创建 NAT 网关：</p> 
<pre><code>New-NetIPAddress -IPAddress 10.254.0.2 -PrefixLength 24 -InterfaceIndex 79</code></pre> 
<p><img alt="" height="425" src="https://images2.imgbox.com/7d/02/cgmXPbn1_o.png" width="758"></p> 
<p></p> 
<p>这时查看server配置ipv4时 就会有了ip地址</p> 
<p><img alt="" height="767" src="https://images2.imgbox.com/93/40/GUNhpbK1_o.png" width="1200"></p> 
<p></p> 
<p>使用 <a href="https://learn.microsoft.com/zh-cn/powershell/module/netnat/New-NetNat" rel="nofollow" title="New-NetNat">New-NetNat</a> 配置 NAT 网络。</p> 
<p>下面是常规命令：</p> 
<p>PowerShell复制</p> 
<pre><code>New-NetNat -Name &lt;NATOutsideName&gt; -InternalIPInterfaceAddressPrefix &lt;NAT subnet prefix&gt;
</code></pre> 
<p>若要配置网关，你将需要提供一些有关网络和 NAT 网关的信息：</p> 
<ul><li> <p><strong>Name</strong> - NATOutsideName 描述 NAT 网络的名称。 将使用此参数删除 NAT 网络。</p> </li><li> <p><strong>InternalIPInterfaceAddressPrefix</strong> - NAT 子网前缀同时描述上述 NAT 网关 IP 前缀和上述 NAT 子网前缀长度。</p> </li></ul> 
<p>常规形式将为 a.b.c.0/NAT 子网前缀长度</p> 
<p>综上所述，对于本示例，我们将使用 192.168.0.0/24</p> 
<p>对于我们的示例，运行以下命令以设置 NAT 网络</p> 
<pre><code>New-NetNat  -Name MyNATnetwork -InternalIPInterfaceAddressPrefix 10.254.0.0/24
</code></pre> 
<p> <img alt="" height="214" src="https://images2.imgbox.com/2b/21/wo3UL4js_o.png" width="811"></p> 
<p> 当再次执行下面命令时</p> 
<pre><code>New-NetNat  -Name MyNATnetwork -InternalIPInterfaceAddressPrefix 10.254.0.0/24
</code></pre> 
<p>会报错，因为已经生成了</p> 
<p><img alt="" height="120" src="https://images2.imgbox.com/8c/a1/yHZL3nqw_o.png" width="831"></p> 
<p> 使用NetNat可以查看已经建立好的 NAT 网络</p> 
<p><img alt="" height="240" src="https://images2.imgbox.com/2a/45/kZnJR9t4_o.png" width="532"></p> 
<p>使用Remove-NetNat可以清空Nat网络</p> 
<p> <img alt="" height="148" src="https://images2.imgbox.com/69/68/oeSA0LqK_o.png" width="683"></p> 
<p></p> 
<p></p> 
<p> 这样，客户端所有上网的访问都是经过了10.10.10.11来上网了。</p> 
<p>如果有些网站不想经过10.10.10.11来使用可以改进</p> 
<p>[Interface]<br> PrivateKey = 4Gp4c+SNuZ2HAfD2qQ4JxyTF+OhW+WqE0A/mKLUZa3Y=<br> Address = 10.254.0.2/32</p> 
<p>[Peer]<br> PublicKey = wpCeLCeoTsV9Q3VG7vJnklNxf3qAt53S0vyMPSVaGwA=<br><span style="color:#fe2c24;">AllowedIPs = 0.0.0.0/0</span><br> Endpoint = 10.10.10.11:55555<br> PersistentKeepalive = 25<br>  </p> 
<p>注意替换PublicKey为计算机A的公钥，Endpoint为计算机A的IP地址，PersistentKeepalive为保持连接的时间，单位为秒。</p> 
<p>AllowedIPs设置为0.0.0.0/0的含义为路由此计算机的所有流量至私有网络。</p> 
<p>PersistentKeepalive该参数可不设置，但设置了该参数，则客户端会在每次连接后发送心跳包，保持连接。</p> 
<p></p> 
<p></p> 
<p>LINUX 版本</p> 
<p>服务端：</p> 
<ol><li><code>apt update</code></li><li><code>apt install wireguard</code></li><li><code>apt install resolvconf</code></li><li>验证是否安装成功: <pre><code>modprobe wireguard &amp;&amp; lsmod | grep wireguard
</code></pre> <p></p> </li><li><code>cd /etc/wireguard/</code></li><li>生成服务端和客户端的公钥私钥 <pre><code># 服务端私钥
wg genkey &gt; server_privatekey
# 服务端公钥
wg pubkey &lt; server_privatekey &gt; server_publickey
# 其他客户端私钥
wg genkey &gt; client_privatekey
wg pubkey &lt; client_privatekey &gt; client_publickey
ls -l</code></pre> <p>spublickey 是服务端的公钥 sprivatekey是服务端的私钥, cpublickey 是客户端的公钥 cprivatekey是客户端的私钥</p> </li><li>打开防火墙转发功能</li></ol> 
<pre><code>echo 1 &gt; /proc/sys/net/ipv4/ip_forward
echo "net.ipv4.ip_forward = 1" &gt;&gt; /etc/sysctl.conf
sysctl -p
</code></pre> 
<p>        8.生成服务端配置文件</p> 
<pre><code>echo "[Interface]
PrivateKey = $(cat server_privatekey)
Address = 10.254.0.1/24 
#如果你的服务器主网卡名称不是 eth0 ，那么请修改下面防火墙规则中最后的 eth0 为你的主网卡名称,可用ens33或者用ip a 命令进行查看
PostUp   = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
#端口号55555是随意的，但是要在防火墙上打开
ListenPort = 55555
DNS = 114.114.114.114
MTU = 1420
#[Peer] 代表客户端配置，每增加一段 [Peer] 就是增加一个客户端账号
[Peer]
PublicKey = $(cat client_publickey)
AllowedIPs = 10.254.0.2/32"|sed '/^#/d;/^\s*$/d' &gt; wg0.conf
</code></pre> 
<p> <img alt="" height="663" src="https://images2.imgbox.com/9a/e7/9NAicFCi_o.png" width="905"></p> 
<p> 由于我的linux服务器没有eth0,相关的设定要改为如下</p> 
<pre><code>echo "[Interface]
PrivateKey = $(cat server_privatekey)
Address = 10.254.0.1/24 
#如果你的服务器主网卡名称不是 eth0 ，那么请修改下面防火墙规则中最后的 eth0 为你的主网卡名称,可用ens33或者用ip a 命令进行查看
PostUp   = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o enp4s0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o enp4s0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
#端口号55555是随意的，但是要在防火墙上打开
ListenPort = 55555
DNS = 114.114.114.114
MTU = 1420
#[Peer] 代表客户端配置，每增加一段 [Peer] 就是增加一个客户端账号
[Peer]
PublicKey = $(cat client_publickey)
AllowedIPs = 10.254.0.2/32"|sed '/^#/d;/^\s*$/d' &gt; wg0.conf</code></pre> 
<p> 9，生成客户端配置文件</p> 
<pre><code>echo "[Interface]
PrivateKey = $(cat client_privatekey)
Address = 10.254.0.2/24
DNS = 114.114.114.114
MTU = 1420
[Peer]
PublicKey = $(cat server_publickey)
# 服务器地址和端口，下面的 10.10.10.136 记得更换为你的服务器公网IP，端口请填写服务端配置时的监听端口
Endpoint = 10.10.10.136:55555
AllowedIPs = 0.0.0.0/0, ::0/0
PersistentKeepalive = 25"|sed '/^#/d;/^\s*$/d' &gt; client.conf
</code></pre> 
<p></p> 
<p>10,启动Wireguard</p> 
<pre><code>wg-quick up wg0
</code></pre> 
<p>11,停止Wireguard </p> 
<pre><code>wg-quick down wg0
</code></pre> 
<p> 12,查看Wireguard状态</p> 
<pre><code>wg
</code></pre> 
<p> 13,<code>如果是云服务器，安全规则记得增加对应端口55555</code></p> 
<p></p> 
<p>14,配置多用户</p> 
<p>#重新生成一对客户端密匙<br> #cprivatekey1 为客户端私匙，cpublickey1 为客户端公匙</p> 
<pre><code>wg genkey | tee client_privatekey1 | wg pubkey &gt; client_publickey1</code></pre> 
<pre><code>wg genkey | tee client_privatekey2 | wg pubkey &gt; client_publickey2</code></pre> 
<p>#服务器上执行添加客户端配置代码(新增一个 [peer])：<br> #$(cat cpublickey1) 这个是客户端公匙，10.254.0.3/32 这个是客户端内网IP地址，按序递增最后一位(.3)，不要重复</p> 
<p></p> 
<pre><code>wg set wg0 peer $(cat client_publickey) allowed-ips 10.254.0.2/32
wg-quick save wg0</code></pre> 
<pre><code>wg set wg0 peer $(cat client_publickey1) allowed-ips 10.254.0.3/32
wg-quick save wg0</code></pre> 
<pre><code>wg set wg0 peer $(cat client_publickey2) allowed-ips 10.254.0.4/32
wg-quick save wg0</code></pre> 
<p> 查看设定的结果 </p> 
<pre><code>wg showconf wg0</code></pre> 
<p> <img alt="" height="200" src="https://images2.imgbox.com/95/db/BWmasWzw_o.png" width="618"></p> 
<p></p> 
<p></p> 
<p>#生成客户端配置文件1</p> 
<pre><code>echo "[Interface]
PrivateKey = $(cat client_privatekey1)
Address = 10.254.0.3/24
DNS = 114.114.114.114
MTU = 1420
[Peer]
PublicKey = $(cat server_publickey)
# 服务器地址和端口，下面的 10.10.10.136 记得更换为你的服务器公网IP，端口请填写服务端配置时的监听端口
Endpoint = 10.10.10.136:55555
AllowedIPs = 0.0.0.0/0, ::0/0
PersistentKeepalive = 25"|sed '/^#/d;/^\s*$/d' &gt; client1.conf
</code></pre> 
<pre><code>echo "[Interface]
PrivateKey = $(cat client_privatekey2)
Address = 10.254.0.4/24
DNS = 114.114.114.114
MTU = 1420
[Peer]
PublicKey = $(cat server_publickey)
# 服务器地址和端口，下面的 10.10.10.136 记得更换为你的服务器公网IP，端口请填写服务端配置时的监听端口
Endpoint = 10.10.10.136:55555
AllowedIPs = 0.0.0.0/0, ::0/0
PersistentKeepalive = 25"|sed '/^#/d;/^\s*$/d' &gt; client2.conf</code></pre> 
<p>将client.conf进行二维码发布,linux下</p> 
<pre><code class="hljs">apt install qrencode

cat client.conf |qrencode -t UTF8
</code></pre> 
<p>用手机版本的wireguard直接扫码就可以加入了 </p> 
<p><img alt="" height="1098" src="https://images2.imgbox.com/bf/a2/nCIVb2f1_o.png" width="1108"> </p> 
<p> </p> 
<p>AllowedIPs地址后边加个0.0.0.0/0 /8(16,24,32)是什么意思?</p> 
<p>是掩码的位数   <br>     A类IP地址的默认子网掩码为255.0.0.0（由于255相当于二进制的8位1，所以也缩写成“/8”，表示网络号占了8位）;<br>     B类的为255.255.0.0（/16）;<br>     C类的为255.255.255.0(/24)<br>     /30就是255.255.255.252<br>     /32就是255.255.255.255</p> 
<p>0.0.0.0/0就是全部流量都转发</p> 
<p> 查看</p> 
<p>配置后需要重启服务</p> 
<pre><code>wg-quick down wg0
wg-quick up wg0</code></pre> 
<p><br> 设置开机启动</p> 
<pre><code>systemctl enable wg-quick@wg0</code></pre> 
<p><br> 取消开机启动</p> 
<pre><code>systemctl disable wg-quick@wg0</code></pre> 
<p>另外如果ubuntu想当客户端配置如下 </p> 
<pre><code>[Interface]
PrivateKey = yP8FOt6/nnnNALkDoGPJK8IUP0rOK2PVzHankNb6H1Q=
Address = 10.254.0.4/24
DNS = 114.114.114.114
MTU = 1420

[Peer]
PublicKey = NJDZsvc7wCnXNpZ+3ofzMK1S7UPfPXId/OJauKCzbnk=
AllowedIPs = 0.0.0.0/0, ::/0
Endpoint = 10.10.10.136:55555
PersistentKeepalive = 25
</code></pre> 
<p> 当运行上面的配置时，ubuntu里的firefox就会走10.10.10.136的流量，但是wget,curl,nc等还是走的内本地Ip.这时增加主机路由表。</p> 
<p>运行route </p> 
<p><img alt="" height="130" src="https://images2.imgbox.com/19/f4/CIEL6Ail_o.png" width="704"></p> 
<p> 发现10.10.10.0直接就到了ens33了，这里就要改动一下</p> 
<p> #删除一条路由　删除的时候不用写网关</p> 
<pre><code>route del -net 10.10.10.0 -netmask 255.255.255.0</code></pre> 
<p> 运行 ip a,获取 ens33 </p> 
<p>Wireguard Client添加主机路由表(10.10.10.136根据你的实际公网来添加）</p> 
<pre><code>route add 10.10.10.136 dev ens33</code></pre> 
<p>这时查看路由表如下  </p> 
<p><img alt="" height="127" src="https://images2.imgbox.com/bd/2c/4g2yGmKM_o.png" width="805"><br> 通过下面的策略来控制对应的地址是走哪个网</p> 
<pre><code>route add 10.10.10.136 dev ens33
route add 10.10.10.123 dev wg0</code></pre> 
<p><br> linux配置wirguard原文链接：https://blog.csdn.net/weixin_43805459/article/details/120163031</p> 
<p></p> 
<p>另外在腾讯云上使用上面的方法配制时有问题，因为腾讯云的服务器上的eth0对应的IP没有对应真实IP存在问题</p> 
<p><img alt="" height="434" src="https://images2.imgbox.com/03/14/KWhYs2P2_o.png" width="982"></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/249e7bf09871d0ef97a9eb70665e5f07/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">xpath选择器应用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bc68dd1241f44dc7d96ae4cd2bdc88b8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">百度搜索优质视频基础质量要求说明</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>