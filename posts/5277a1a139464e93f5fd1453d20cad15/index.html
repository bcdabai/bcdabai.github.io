<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【BUG】golang gorm导入数据库报错 “unexpected type clause.Expr“ - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【BUG】golang gorm导入数据库报错 “unexpected type clause.Expr“" />
<meta property="og:description" content="帮同事排查一个gorm导入数据报错的问题
事发现场 ck sql
CREATE TABLE ods_api.t_sms_jg_msg_callback_dis ( `app_key` String DEFAULT &#39;&#39; COMMENT &#39;应用标识&#39;, `callback_type` Int32 DEFAULT 0 COMMENT &#39;0送达，1回执&#39;, `channel` Int32 DEFAULT 0 COMMENT &#39;uid下发的渠道&#39;, `model` String DEFAULT &#39;&#39; COMMENT &#39;设备机型&#39;, `jgid` String DEFAULT &#39;&#39; COMMENT &#39;极光返回的msgid&#39;, `notification_state` Int8 DEFAULT 0 COMMENT &#39;接收通知时通知开关是否打开&#39;, `params` String DEFAULT &#39;&#39; COMMENT &#39;用户在push API推送请求的时候在payload的callback里自行指定的参数&#39;, `platform` String DEFAULT &#39;&#39; COMMENT &#39;推送平台&#39;, `registration_id` String DEFAULT &#39;&#39; COMMENT &#39;设备唯一标识&#39;, `alias` String DEFAULT &#39;&#39; COMMENT &#39;设备registration_id对应的别名&#39;, `send_time` String DEFAULT &#39;&#39; COMMENT &#39;通知的送达时间/ 用户点击通知的时间&#39;, `created_at` DateTime DEFAULT now() ) ENGINE = ReplacingMergeTree(created_at) PARTITION BY toDate(created_at) ORDER BY (callback_type, jgid, registration_id, send_time) SETTINGS index_granularity = 8192 COMMENT &#39;极光push点击/送达回执记录表,中台notify服务用&#39; go 数据表" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5277a1a139464e93f5fd1453d20cad15/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-29T23:32:29+08:00" />
<meta property="article:modified_time" content="2024-01-29T23:32:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【BUG】golang gorm导入数据库报错 “unexpected type clause.Expr“</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>帮同事排查一个gorm导入数据报错的问题</p> 
<h3><a id="_2"></a>事发现场</h3> 
<p>ck sql</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> ods_api<span class="token punctuation">.</span>t_sms_jg_msg_callback_dis
<span class="token punctuation">(</span>
    <span class="token punctuation">`</span>app_key<span class="token punctuation">`</span> String <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'应用标识'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>callback_type<span class="token punctuation">`</span> Int32 <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'0送达，1回执'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>channel<span class="token punctuation">`</span> Int32 <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'uid下发的渠道'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>model<span class="token punctuation">`</span> String <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'设备机型'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>jgid<span class="token punctuation">`</span> String <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'极光返回的msgid'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>notification_state<span class="token punctuation">`</span> Int8 <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'接收通知时通知开关是否打开'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>params<span class="token punctuation">`</span> String <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户在push API推送请求的时候在payload的callback里自行指定的参数'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>platform<span class="token punctuation">`</span> String <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'推送平台'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>registration_id<span class="token punctuation">`</span> String <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'设备唯一标识'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>alias<span class="token punctuation">`</span> String <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'设备registration_id对应的别名'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>send_time<span class="token punctuation">`</span> String <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'通知的送达时间/ 用户点击通知的时间'</span><span class="token punctuation">,</span>
    <span class="token punctuation">`</span>created_at<span class="token punctuation">`</span> <span class="token keyword">DateTime</span> <span class="token keyword">DEFAULT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> ReplacingMergeTree<span class="token punctuation">(</span>created_at<span class="token punctuation">)</span>
<span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> toDate<span class="token punctuation">(</span>created_at<span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>callback_type<span class="token punctuation">,</span> jgid<span class="token punctuation">,</span> registration_id<span class="token punctuation">,</span> send_time<span class="token punctuation">)</span>
SETTINGS index_granularity <span class="token operator">=</span> <span class="token number">8192</span>
<span class="token keyword">COMMENT</span> <span class="token string">'极光push点击/送达回执记录表,中台notify服务用'</span>
</code></pre> 
<p>go 数据表</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> TSmsJgMsgCallback <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	AppKey            <span class="token builtin">string</span>    <span class="token string">`gorm:"column:app_key;default:;comment:'应用标识'" json:"appkey"`</span>
	CallbackType      <span class="token builtin">int32</span>     <span class="token string">`gorm:"column:callback_type;default:0;comment:'0送达，1回执'" json:"callback_type"`</span>
	Channel           <span class="token builtin">int32</span>     <span class="token string">`gorm:"column:channel;default:0;comment:'uid下发的渠道'" json:"channel"`</span>
	Model             <span class="token builtin">string</span>    <span class="token string">`gorm:"column:model;default:;comment:'设备机型'" json:"model"`</span>
	Jgid              <span class="token builtin">string</span>    <span class="token string">`gorm:"column:jgid;default:;comment:'极光返回的msgid'" json:"msgid"`</span>
	NotificationState <span class="token builtin">int8</span>      <span class="token string">`gorm:"column:notification_state;default:0;comment:'接收通知时通知开关是否打开'" json:"notification_state"`</span>
	Params            <span class="token builtin">string</span>    <span class="token string">`gorm:"column:params;default:;comment:'用户在push API推送请求的时候在payload的callback里自行指定的参数'" json:"params"`</span>
	Platform          <span class="token builtin">string</span>    <span class="token string">`gorm:"column:platform;default:;comment:'推送平台'" json:"platform"`</span>
	RegistrationId    <span class="token builtin">string</span>    <span class="token string">`gorm:"column:registration_id;default:;comment:'设备唯一标识'" json:"registration_id"`</span>
	Alias             <span class="token builtin">string</span>    <span class="token string">`gorm:"column:alias;default:;comment:'设备registration_id对应的别名'" json:"alias"`</span>
	SendTime          <span class="token builtin">string</span>    <span class="token string">`gorm:"column:send_time;default:;comment:'通知的送达时间/ 用户点击通知的时间'" json:"send_time"`</span>
	CreatedAt         time<span class="token punctuation">.</span>Time <span class="token string">`gorm:"column:created_at"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>TSmsJgMsgCallback<span class="token punctuation">)</span> <span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token string">"t_sms_jg_msg_callback_dis"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>导入数据报错代码</strong></p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">insertCk</span><span class="token punctuation">(</span>callbackList <span class="token punctuation">[</span><span class="token punctuation">]</span>ck<span class="token punctuation">.</span>TSmsJgMsgCallback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>callbackList<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	err <span class="token operator">:=</span> clickhouse<span class="token punctuation">.</span><span class="token function">GetPushCk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Table</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ck<span class="token punctuation">.</span>TSmsJgMsgCallback<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">TableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>callbackList<span class="token punctuation">)</span><span class="token punctuation">.</span>Error
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"callbackClick insertCk err"</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token string">"callbackList"</span><span class="token punctuation">,</span> callbackList<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

</code></pre> 
<p>日志打印：</p> 
<pre><code> INSERT INTO `t_sms_jg_msg_callback` (`callback_type`,`channel`,`notification_state`,`alias`,`send_time`,`app_key`,`model`,`jgid`,`params`,`platform`,`registration_id`) VALUES (1,1,1,'alias1','1510109259','b2d7e0fbaa7f4d7e9c2b3bc0','model1','123','{"key1":"value1","key2":"value2"}','android','1a0018970a4b4b4b4b4b4b4b4b4b4b4b')
 callbackClick ck insert err     {"error": "alias (String): unexpected type clause.Expr"

</code></pre> 
<h3><a id="_76"></a>问题分析</h3> 
<p>从sql日志和手动执行，并无问题，只能找gorm clihouse源码debug分析为什么报类型不一致</p> 
<p><img src="https://images2.imgbox.com/98/f6/4DeRxEgJ_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到，变量里jgid字段类型不为string,而是为DEFAULT?<br> 变量类型为[]interface{} ?<br> <img src="https://images2.imgbox.com/2e/c3/RbKwRU2h_o.png" alt="在这里插入图片描述"></p> 
<p>再看gorm的定义<br> gorm语法写错了<br> <img src="https://images2.imgbox.com/b7/0a/R34qZbx3_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_91"></a>总结</h3> 
<p>通过SQL自动生成自动代码model时，尽量用公司内部的组件或者可靠的三方工具，自己写非常容易出错</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/59e268b59af6e90be4260bc28e3f5ddb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">AJAX进阶（重点）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/50d4deae561b7834e37ca218c4531c59/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">WPOpenSocial实现WordPress的QQ登录</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>