<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Go-Benchmark入门-进阶篇（下） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Go-Benchmark入门-进阶篇（下）" />
<meta property="og:description" content="接上文：Go-Benchmark入门-基础篇（上）
引言 本篇是进阶篇，围绕最佳实践，介绍项目中可能会用得上的一些技巧和科普更多的 benchmark 知识，也是对本人半个多月实践的一次总结和备忘。
go版本：
go1.19.4 darwin/arm64 最佳实践 提升准确度：-benchtime 默认情况下，benchmark只运行1秒钟，不过我们可以通过如下2个命令控制运行时长和测试轮次，以提高准确度：
-benchtime t Run enough iterations of each benchmark to take t, specified as a time.Duration (for example, -benchtime 1h30s). The default is 1 second (1s). The special syntax Nx means to run the benchmark N times (for example, -benchtime 100x). -count n Run each test, benchmark, and fuzz seed n times (default 1). If -cpu is set, run n times for each GOMAXPROCS value." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/fc9948135621addeaee8af56a9c85a06/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-16T13:29:15+08:00" />
<meta property="article:modified_time" content="2023-05-16T13:29:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Go-Benchmark入门-进阶篇（下）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>接上文：<a href="https://blog.csdn.net/xmcy001122/article/details/130703327">Go-Benchmark入门-基础篇（上）</a></p> 
<h3><a id="_2"></a>引言</h3> 
<p>本篇是进阶篇，围绕最佳实践，介绍项目中可能会用得上的一些技巧和科普更多的 benchmark 知识，也是对本人半个多月实践的一次总结和备忘。</p> 
<p>go版本：</p> 
<pre><code class="prism language-bash">go1.19.4 darwin/arm64
</code></pre> 
<h3><a id="_9"></a>最佳实践</h3> 
<h4><a id="benchtime_10"></a>提升准确度：-benchtime</h4> 
<p>默认情况下，benchmark只运行1秒钟，不过我们可以通过如下2个命令控制运行时长和测试轮次，以提高准确度：</p> 
<pre><code class="prism language-bash">-benchtime t
    Run enough iterations of each benchmark to take t, specified
    as a time.Duration <span class="token punctuation">(</span>for example, -benchtime 1h30s<span class="token punctuation">)</span>.
    The default is <span class="token number">1</span> second <span class="token punctuation">(</span>1s<span class="token punctuation">)</span>.
    The special syntax Nx means to run the benchmark N <span class="token builtin class-name">times</span>
    <span class="token punctuation">(</span>for example, -benchtime 100x<span class="token punctuation">)</span>.

-count n
    Run each test, benchmark, and fuzz seed n <span class="token builtin class-name">times</span> <span class="token punctuation">(</span>default <span class="token number">1</span><span class="token punctuation">)</span>.
    If -cpu is set, run n <span class="token builtin class-name">times</span> <span class="token keyword">for</span> each GOMAXPROCS value.
    Examples are always run once. -count does not apply to
    fuzz tests matched by -fuzz.
</code></pre> 
<p>根据 <a href="https://pkg.go.dev/cmd/go#hdr-Testing_flags" rel="nofollow">官方文档</a> ，我们看到 <code>-benchtime</code> 是 <a href="https://pkg.go.dev/time#Duration" rel="nofollow">time.Duration</a> 格式，小时分可以缩写为“h”、”m”、”s”单个字母，以下代表运行测试1小时10分10秒：</p> 
<pre><code class="prism language-bash">$ go <span class="token builtin class-name">test</span> -bench<span class="token operator">=</span><span class="token string">"BenchmarkFibV2$"</span> -benchtime<span class="token operator">=</span>1h10m10s
</code></pre> 
<p>另外，如果以x结尾，可以精确控制测试运行N次：</p> 
<pre><code class="prism language-bash">$ go <span class="token builtin class-name">test</span> -bench<span class="token operator">=</span><span class="token string">"BenchmarkFibV2$"</span> -benchtime<span class="token operator">=</span>10x

goos: darwin
goarch: arm64
pkg: goexample/13_benchmark
BenchmarkFibV2-10             <span class="token number">10</span>               <span class="token number">116.6</span> ns/op
PASS
ok      goexample/13_benchmark  <span class="token number">0</span>.414s
</code></pre> 
<p>搭配 <code>-count</code>命令，我们可以精确控制测试运行多少时间（或多少次），以及运行几轮测试：</p> 
<pre><code class="prism language-bash">$ go <span class="token builtin class-name">test</span> -run<span class="token operator">=</span>none -bench<span class="token operator">=</span><span class="token string">"BenchmarkFibV2$"</span> -benchtime<span class="token operator">=</span>2s -count<span class="token operator">=</span><span class="token number">3</span>
goos: darwin
goarch: arm64
pkg: goexample/13_benchmark
BenchmarkFibV2-10       <span class="token number">238259484</span>                <span class="token number">9.972</span> ns/op
BenchmarkFibV2-10       <span class="token number">240662946</span>                <span class="token number">9.968</span> ns/op
BenchmarkFibV2-10       <span class="token number">240829356</span>                <span class="token number">9.969</span> ns/op
PASS
ok      goexample/13_benchmark  <span class="token number">10</span>.420s
</code></pre> 
<p>如上，我们每次测试运行2秒钟，总共运行了3次，我们看到平均每次耗时在 9.9 ns 左右，通过 <code>-benchtime</code> 和 <code>-count</code> 这2个命令，我们可以提升测试的准确定，避免性能毛刺或抖动。</p> 
<h4><a id="benchmem_58"></a>内存分配情况：-benchmem</h4> 
<p>我们可以使用 <code>-benchmem</code> 来观察代码的内存分配情况：</p> 
<pre><code class="prism language-bash">goos: darwin
goarch: arm64
pkg: server/msg-dispatcher/internal/dao
BenchmarkPushGroup_Create-10     <span class="token number">855</span>    <span class="token number">1270851</span> ns/op    <span class="token number">6138</span> B/op    <span class="token number">142</span> allocs/op
PASS
ok      server/msg-dispatcher/internal/dao      <span class="token number">1</span>.563s
</code></pre> 
<ul><li><code>142 allocs/op</code>：表示每次函数操作会涉及 <code>142</code> 次内存分配，因为这里使用的 <code>ent</code> orm框架，这个数字看起来也不算夸张。</li><li><code>6138 B/op</code>：表示1次函数调用会分配 6138 Bytes内存。</li></ul> 
<p>我们还可以结合 <code>-memprofile</code> 命令导出性能文件，然后使用 pprof 工具来进行精确分析内存分配和占用情况。</p> 
<ol><li>生成 pprof 文件（文件名和后缀无要求）</li></ol> 
<pre><code class="prism language-bash">$ go <span class="token builtin class-name">test</span> -run<span class="token operator">=</span>none -bench<span class="token operator">=</span><span class="token string">"BenchmarkPushGroup_Create$"</span> -benchmem -memprofile<span class="token operator">=</span><span class="token string">"out.profile"</span>
</code></pre> 
<ol start="2"><li>使用 go tool 中的pprof工具加载，并输出 top 10的内存占用情况（更多功能输入help查看）：</li></ol> 
<pre><code class="prism language-bash"><span class="token punctuation">(</span>pprof<span class="token punctuation">)</span> <span class="token function">top</span> <span class="token number">10</span>
Showing nodes accounting <span class="token keyword">for</span> <span class="token number">9227</span>.88kB, <span class="token number">58.09</span>% of <span class="token number">15884</span>.30kB total
Showing <span class="token function">top</span> <span class="token number">10</span> nodes out of <span class="token number">126</span>
      flat  flat%   sum%        cum   cum%
<span class="token number">3075</span>.38kB <span class="token number">19.36</span>% <span class="token number">19.36</span>%  <span class="token number">3075</span>.38kB <span class="token number">19.36</span>%  runtime.allocm
<span class="token number">1024</span>.08kB  <span class="token number">6.45</span>% <span class="token number">25.81</span>%  <span class="token number">1024</span>.08kB  <span class="token number">6.45</span>%  server/msg-dispatcher/internal/dao/ent.<span class="token punctuation">(</span>*BizPushGroupCreate<span class="token punctuation">)</span>.createSpec
<span class="token number">1024</span>.08kB  <span class="token number">6.45</span>% <span class="token number">32.26</span>%  <span class="token number">1536</span>.17kB  <span class="token number">9.67</span>%  github.com/go-sql-driver/mysql.<span class="token punctuation">(</span>*mysqlStmt<span class="token punctuation">)</span>.query
<span class="token number">1024</span>.04kB  <span class="token number">6.45</span>% <span class="token number">38.70</span>%  <span class="token number">1024</span>.04kB  <span class="token number">6.45</span>%  server/msg-dispatcher/internal/dao/ent.<span class="token punctuation">(</span>*BizPushGroupQuery<span class="token punctuation">)</span>.querySpec
  <span class="token number">516</span>.64kB  <span class="token number">3.25</span>% <span class="token number">41.95</span>%   <span class="token number">516</span>.64kB  <span class="token number">3.25</span>%  google.golang.org/protobuf/reflect/protoregistry.<span class="token punctuation">(</span>*Types<span class="token punctuation">)</span>.register
     514kB  <span class="token number">3.24</span>% <span class="token number">45.19</span>%      514kB  <span class="token number">3.24</span>%  bufio.NewReaderSize
  <span class="token number">513</span>.31kB  <span class="token number">3.23</span>% <span class="token number">48.42</span>%   <span class="token number">513</span>.31kB  <span class="token number">3.23</span>%  regexp.onePassCopy
  <span class="token number">512</span>.17kB  <span class="token number">3.22</span>% <span class="token number">51.65</span>%   <span class="token number">512</span>.17kB  <span class="token number">3.22</span>%  entgo.io/ent/dialect/sql.Select
  <span class="token number">512</span>.09kB  <span class="token number">3.22</span>% <span class="token number">54.87</span>%   <span class="token number">512</span>.09kB  <span class="token number">3.22</span>%  github.com/go-sql-driver/mysql.<span class="token punctuation">(</span>*mysqlConn<span class="token punctuation">)</span>.readColumns
  <span class="token number">512</span>.09kB  <span class="token number">3.22</span>% <span class="token number">58.09</span>%   <span class="token number">512</span>.09kB  <span class="token number">3.22</span>%  google.golang.org/protobuf/types/descriptorpb.init
</code></pre> 
<ol start="3"><li>可以通过 <code>png</code> 导出成图片：</li></ol> 
<pre><code class="prism language-bash"><span class="token punctuation">(</span>pprof<span class="token punctuation">)</span> png
Generating report <span class="token keyword">in</span> profile001.png
</code></pre> 
<p>看下图最左侧 pushGroup.Create的树形图，分配情况一目了然：<br> <img src="https://images2.imgbox.com/70/ce/zXQtSyDf_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_103"></a>测试不同的输入（时间复杂度）</h4> 
<p>以 <a href="https://leetcode.cn/problems/fibonacci-number/" rel="nofollow">斐波拉契数列</a> 为例，当我们需要评估算法是O(1)、O(N)、O(n^2）还是其他时间复杂度时，如果看代码不好判断（比如递归版本的解法）：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">Fib</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> n <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> n
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token function">Fib</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">Fib</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这种情况下，我们可以通过测试不同输入的函数耗时，然后放到折线图中判断。在下面的代码中，我们通过b.Run运行子测试的功能，一次性测试计算第10、30和40位的斐波拉契数列：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">BenchmarkFib_Table</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">var</span> table <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{<!-- --></span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">}</span>
   <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
      num <span class="token operator">:=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      name <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s_%d"</span><span class="token punctuation">,</span> <span class="token string">"BenchmarkFib"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span>
      b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token function">benchFib</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> num<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">benchFib</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">,</span> num <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">Fib</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">goos: darwin
goarch: arm64
pkg: goexample/13_benchmark
BenchmarkFib_Table/BenchmarkFib_10-10            <span class="token number">4750002</span>               <span class="token number">250.3</span> ns/op
BenchmarkFib_Table/BenchmarkFib_30-10                <span class="token number">314</span>           <span class="token number">3787747</span> ns/op
BenchmarkFib_Table/BenchmarkFib_40-10                  <span class="token number">3</span>         <span class="token number">467186889</span> ns/op
PASS
ok      goexample/13_benchmark  <span class="token number">6</span>.110s
</code></pre> 
<p>转换成折线图（1-30）：<br> <img src="https://images2.imgbox.com/a1/c1/XHEP9Scm_o.png" alt="在这里插入图片描述"><br> 我们可以直观看到这个线的走势，从20左右开始，折线就急剧爬升。到了30后面，几乎就是90度的走向了，所以从这根线的走势可以看出，递归版本的 <code>斐波拉契</code> 解法的时间复杂度，肯定不是 O(n)，至少是 O(n^2) 级别，关于该递归解法的时间复杂度分析可以参考这篇文章：递归求Fibonacci数列的时间复杂度到底是多少?</p> 
<h4><a id="_150"></a>跳过单元测试</h4> 
<p>如果你省略 <code>-run</code> 指令，其实也会运行 <code>同一个package</code> 下的所有单测：</p> 
<pre><code class="prism language-bash">$ go <span class="token builtin class-name">test</span> -bench<span class="token operator">=</span><span class="token string">"BenchmarkFib_40$"</span>
goos: darwin
goarch: arm64
pkg: goexample/13_benchmark
BenchmarkFib_40-10             <span class="token number">3</span>         <span class="token number">469632750</span> ns/op
PASS
ok      goexample/13_benchmark  <span class="token number">3</span>.235s
</code></pre> 
<p>从上面的输出看不出啥，那是因为你的单测全部 PAAS，不相信的话，我们可以加个 <code>-v</code> 把执行的单测详情输出看看：</p> 
<pre><code class="prism language-bash">$ go <span class="token builtin class-name">test</span> -bench<span class="token operator">=</span><span class="token string">"BenchmarkFib_40$"</span> -v
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFib
--- PASS: TestFib <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestFibIterator
--- PASS: TestFibIterator <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
goos: darwin
goarch: arm64
pkg: goexample/13_benchmark
BenchmarkFib_40
BenchmarkFib_40-10             <span class="token number">3</span>         <span class="token number">468810389</span> ns/op
PASS
ok      goexample/13_benchmark  <span class="token number">2</span>.999s
</code></pre> 
<p>所以，如果我们需要显示跳过单测，一定别忘记给 <code>-run</code> 指令指定<code>一个不匹配任何单测的正则</code>，即可跳过单测，只运行 benchmark测试。</p> 
<pre><code class="prism language-bash">$ go <span class="token builtin class-name">test</span> -run<span class="token operator">=</span><span class="token string">"none"</span> -bench<span class="token operator">=</span><span class="token string">"BenchmarkFib"</span>
</code></pre> 
<h4><a id="benchmark_183"></a>对比benchmark结果</h4> 
<p><code>golang.org/x/perf</code> 中提供了一组工具，可以对 benchmark 结果进行分析，其中一个很有用的工具就是 <code>benchstat</code>，可以对2次benchmark结果进行A/B比较，让我们以 <code>斐波拉契数列</code> 为例来演示一下。</p> 
<ol><li>准备 benchmark 测试代码</li></ol> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">BenchmarkFib_Table</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   nums <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{<!-- --></span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">}</span>
   <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
      num <span class="token operator">:=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      name <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span>
      b<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">Fib</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>              <span class="token comment">// (1)</span>
            <span class="token comment">// FibIterator(num)   // (2)</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>执行 <code>递归算法版本</code> 的测试并保存文件</li></ol> 
<pre><code class="prism language-bash">$ go <span class="token builtin class-name">test</span> -bench<span class="token operator">=</span><span class="token string">"BenchmarkFib$"</span> -run<span class="token operator">=</span>none -count <span class="token number">2</span> <span class="token operator">|</span> <span class="token function">tee</span> old.txt
* <span class="token variable"><span class="token variable">`</span>-count<span class="token variable">`</span></span>：会执行2遍测试
* <span class="token variable"><span class="token variable">`</span><span class="token function">tee</span><span class="token variable">`</span></span>：会把测试结果保存成文件，同时把结果输出到控制台。
</code></pre> 
<ol start="3"><li>执行 <code>迭代版本解法</code> 的测试并保存文件</li></ol> 
<pre><code class="prism language-bash"><span class="token comment"># 注释（1）位置的代码，取消（2）位置代码的注释然后运行</span>
$ go <span class="token builtin class-name">test</span> -bench<span class="token operator">=</span><span class="token string">"BenchmarkFib$"</span> -run<span class="token operator">=</span>none -count <span class="token number">2</span> <span class="token operator">|</span> <span class="token function">tee</span> new.txt
</code></pre> 
<ol start="4"><li>安装 <code>benchstat</code> 工具</li></ol> 
<pre><code class="prism language-ba">$ go install golang.org/x/perf/cmd/benchstat@latest
</code></pre> 
<ol start="5"><li>对比结果</li></ol> 
<pre><code class="prism language-bash">$ benchstat old.txt new.txt
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">goos: darwin
goarch: arm64
pkg: goexample/13_benchmark
                │      old.txt       │                new.txt                │
                │       sec/op       │    sec/op     vs base                 │
Fib_Table/10-10       <span class="token number">238</span>.550n ± ∞ ¹   <span class="token number">3</span>.743n ± ∞ ¹        ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.333</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> ²
Fib_Table/20-10     <span class="token number">29431</span>.000n ± ∞ ¹   <span class="token number">6</span>.889n ± ∞ ¹        ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.333</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> ²
Fib_Table/30-10   <span class="token number">3637274</span>.000n ± ∞ ¹   <span class="token number">9</span>.976n ± ∞ ¹        ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.333</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> ²
geomean                 <span class="token number">29.45</span>µ         <span class="token number">6</span>.360n        -99.98%
* <span class="token variable"><span class="token variable">`</span>sec/op<span class="token variable">`</span></span>：代表每次运行的平均耗时
* <span class="token variable"><span class="token variable">`</span>geomean<span class="token variable">`</span></span>：递归版本平均耗时 <span class="token variable"><span class="token variable">`</span><span class="token number">30.84</span> us<span class="token variable">`</span></span>，迭代版本解法平均 <span class="token variable"><span class="token variable">`</span><span class="token number">6.6</span> ns<span class="token variable">`</span></span>，性能提升了 <span class="token variable"><span class="token variable">`</span><span class="token number">99.98</span>%<span class="token variable">`</span></span>。
</code></pre> 
<p>更多关于 <code>bench stat</code>工具可以参考：<a href="https://pkg.go.dev/golang.org/x/perf/cmd/benchstat" rel="nofollow">官方文档</a></p> 
<h4><a id="pprof_239"></a>结合pprof进行函数耗时分析</h4> 
<p>通过指定 <code>-cpuprofile</code> 可以输出cpu信息到文件中，然后就可以使用pprof来进行更深入的分析了。</p> 
<p>举一个实际案例，假设要分析某个函数的耗时：</p> 
<pre><code class="prism language-bash">$ go <span class="token builtin class-name">test</span> -run<span class="token operator">=</span><span class="token string">"none"</span> -bench<span class="token operator">=</span><span class="token string">"BenchmarkPushDevice_BindOrUpdate"</span> -cpuprofile<span class="token operator">=</span>out.cpu
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-bash">goos: darwin
goarch: arm64
pkg: internal/biz
BenchmarkPushDevice_BindOrUpdate-10           <span class="token number">18</span>          <span class="token number">66413139</span> ns/op
PASS
ok      internal/biz      <span class="token number">3</span>.678s
</code></pre> 
<p>我们发现这个 <code>BindOrUpdate</code> 1秒执行了18次，平均66ms执行一次。</p> 
<p>这个性能比预期低，让我们使用 go tool中的 <code>pprof</code> 工具，调查一下到底是哪里比较耗时（微服务中一般使用trace分析函数耗时）。</p> 
<p>使用 <code>pprof</code> 加载文件：</p> 
<pre><code class="prism language-bash">$ go tool pprof out.cpu

Type: cpu
Time: Feb <span class="token number">16</span>, <span class="token number">2023</span> at <span class="token number">4</span>:47pm <span class="token punctuation">(</span>CST<span class="token punctuation">)</span>
Duration: <span class="token number">2</span>.86s, Total samples <span class="token operator">=</span> 120ms <span class="token punctuation">(</span> <span class="token number">4.19</span>%<span class="token punctuation">)</span>
Entering interactive mode <span class="token punctuation">(</span>type <span class="token string">"help"</span> <span class="token keyword">for</span> commands, <span class="token string">"o"</span> <span class="token keyword">for</span> options<span class="token punctuation">)</span>
<span class="token punctuation">(</span>pprof<span class="token punctuation">)</span>
</code></pre> 
<p>输入 top：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">(</span>pprof<span class="token punctuation">)</span> <span class="token function">top</span>

Showing nodes accounting <span class="token keyword">for</span> 120ms, <span class="token number">100</span>% of 120ms total
Showing <span class="token function">top</span> <span class="token number">10</span> nodes out of <span class="token number">112</span>
      flat  flat%   sum%        cum   cum%
      40ms <span class="token number">33.33</span>% <span class="token number">33.33</span>%       40ms <span class="token number">33.33</span>%  syscall.syscall
      20ms <span class="token number">16.67</span>% <span class="token number">50.00</span>%       20ms <span class="token number">16.67</span>%  runtime.kevent
      20ms <span class="token number">16.67</span>% <span class="token number">66.67</span>%       20ms <span class="token number">16.67</span>%  runtime.pthread_cond_signal
      10ms  <span class="token number">8.33</span>% <span class="token number">75.00</span>%       10ms  <span class="token number">8.33</span>%  internal/dao/ent.newBizPushUserDeviceMutation
      10ms  <span class="token number">8.33</span>% <span class="token number">83.33</span>%       10ms  <span class="token number">8.33</span>%  runtime.<span class="token punctuation">(</span>*limiterEvent<span class="token punctuation">)</span>.stop
      10ms  <span class="token number">8.33</span>% <span class="token number">91.67</span>%       10ms  <span class="token number">8.33</span>%  runtime.<span class="token punctuation">(</span>*spanSet<span class="token punctuation">)</span>.push
      10ms  <span class="token number">8.33</span>%   <span class="token number">100</span>%       10ms  <span class="token number">8.33</span>%  runtime.step
         <span class="token number">0</span>     <span class="token number">0</span>%   <span class="token number">100</span>%       20ms <span class="token number">16.67</span>%  bufio.<span class="token punctuation">(</span>*Reader<span class="token punctuation">)</span>.ReadSlice
         <span class="token number">0</span>     <span class="token number">0</span>%   <span class="token number">100</span>%       20ms <span class="token number">16.67</span>%  bufio.<span class="token punctuation">(</span>*Reader<span class="token punctuation">)</span>.fill
         <span class="token number">0</span>     <span class="token number">0</span>%   <span class="token number">100</span>%       10ms  <span class="token number">8.33</span>%  context.WithDeadline
<span class="token punctuation">(</span>pprof<span class="token punctuation">)</span>
</code></pre> 
<p>好像看不出啥，我们可以继续使用 list newBizPushUserDeviceMutation 挨个查看详情，考虑到篇幅这里就不再过多介绍了。</p> 
<p>输入 png 导出（help查看更多pprof命令）：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">(</span>pprof<span class="token punctuation">)</span> png
Generating report <span class="token keyword">in</span> profile001.png
</code></pre> 
<p>打开 png，我们看到下面3个红框的位置，分辨有3个操作每个耗时10ms（mysql操作），他们是顺序执行，所以会占用30ms，总计40ms耗时左右，1秒钟也就执行25次，和压测结果接近，至此，我们结合pprof找到了函数耗时的点，可以做针对性的性能优化了，是不是很方便？<br> <img src="https://images2.imgbox.com/7f/e9/qYslWpeq_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="ResetTimer__StartTimer__StopTimer_302"></a>ResetTimer &amp; StartTimer &amp; StopTimer</h4> 
<p>我们可以通过 <code>ResetTimer</code> 忽略初始化需要的时间，通过 <code>StartTimer</code> 和 <code>StopTimer</code> 忽略某一段代码的耗时，如下是一个示例：</p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">BenchmarkNewPushDevice</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   entClient <span class="token operator">:=</span> <span class="token function">newEntClient</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
   redisClient <span class="token operator">:=</span> unittest<span class="token punctuation">.</span><span class="token function">NewRedis</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
   member <span class="token operator">:=</span> <span class="token function">NewPushGroupMemberDao</span><span class="token punctuation">(</span>entClient<span class="token punctuation">,</span> redisClient<span class="token punctuation">)</span>
   group <span class="token operator">:=</span> <span class="token function">NewPushGroupDao</span><span class="token punctuation">(</span>entClient<span class="token punctuation">,</span> redisClient<span class="token punctuation">,</span> member<span class="token punctuation">)</span>

   <span class="token comment">// 忽略 redis,mysql 等初始化占用的时间</span>
   b<span class="token punctuation">.</span><span class="token function">ResetTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

   b<span class="token punctuation">.</span><span class="token function">SetParallelism</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
   b<span class="token punctuation">.</span><span class="token function">RunParallel</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>pb <span class="token operator">*</span>testing<span class="token punctuation">.</span>PB<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> pb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token comment">// 忽略这段代码的耗时</span>
         b<span class="token punctuation">.</span><span class="token function">StopTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token boolean">_</span> <span class="token operator">=</span> group<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">100000</span><span class="token punctuation">)</span>
         b<span class="token punctuation">.</span><span class="token function">StartTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

         err <span class="token operator">:=</span> member<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>总结<br> 本文罗列了实战中可能会用到的各种小技巧，包括：</p> 
<ul><li><code>提升准确度</code>：-benchtime 和 -count 的使用</li><li><code>内存分配情况</code>：-benchmem 和 -memprofile 的使用</li><li><code>测试不同的输入</code>：b.Run运行子测试，验证时间复杂度</li><li><code>跳过单元测试</code>：可以通过 -run 指定一个不匹配任何单测的正则来跳过</li><li><code>对比benchmark结果</code>：使用 bench stat 工具，对比2次测试结果</li><li><code>结合pprof进行函数耗时分析</code>：-cpuprofile 指令的使用，并演示如何结合pprofile工具进行可视化分析。</li><li><code>ResetTimer &amp; StartTimer &amp; StopTimer 的使用</code></li></ul> 
<h3><a id="_339"></a>附录</h3> 
<p>benchmark常用命令如下（完整命令）：</p> 
<pre><code class="prism language-bash">-cpu <span class="token number">1,2</span>,4
    Specify a list of GOMAXPROCS values <span class="token keyword">for</span> <span class="token function">which</span> the tests, benchmarks or
    fuzz tests should be executed. The default is the current value
    of GOMAXPROCS. -cpu does not apply to fuzz tests matched by -fuzz.

-benchtime t
    Run enough iterations of each benchmark to take t, specified
    as a time.Duration <span class="token punctuation">(</span>for example, -benchtime 1h30s<span class="token punctuation">)</span>.
    The default is <span class="token number">1</span> second <span class="token punctuation">(</span>1s<span class="token punctuation">)</span>.
    The special syntax Nx means to run the benchmark N <span class="token builtin class-name">times</span>
    <span class="token punctuation">(</span>for example, -benchtime 100x<span class="token punctuation">)</span>.

-benchmem
    Print memory allocation statistics <span class="token keyword">for</span> benchmarks.

-count n
    Run each test, benchmark, and fuzz seed n <span class="token builtin class-name">times</span> <span class="token punctuation">(</span>default <span class="token number">1</span><span class="token punctuation">)</span>.
    If -cpu is set, run n <span class="token builtin class-name">times</span> <span class="token keyword">for</span> each GOMAXPROCS value.
    Examples are always run once. -count does not apply to
    fuzz tests matched by -fuzz.

-cpuprofile cpu.out
    Write a CPU profile to the specified <span class="token function">file</span> before exiting.
    Writes <span class="token builtin class-name">test</span> binary as -c would.

-memprofile mem.out
    Write an allocation profile to the <span class="token function">file</span> after all tests have passed.
    Writes <span class="token builtin class-name">test</span> binary as -c would.
</code></pre> 
<h3><a id="_371"></a>关于作者</h3> 
<p>作者简介：一线Gopher，公众号《Go和分布式IM》运营者，开源项目： <a href="https://github.com/xmcy0011/CoffeeChat">CoffeeChat</a> 、<a href="https://github.com/xmcy0011/interview-golang">interview-golang</a> 发起人 &amp; 核心开发者，终身程序员。</p> 
<hr> 
<p>参考：</p> 
<ul><li><a href="https://geektutu.com/post/hpg-benchmark.html#%E9%99%84-%E6%8E%A8%E8%8D%90%E4%B8%8E%E5%8F%82%E8%80%83" rel="nofollow">benchmark 基准测试</a></li><li><a href="https://pkg.go.dev/time#Duration" rel="nofollow">https://pkg.go.dev/time#Duration</a></li><li><a href="https://blog.logrocket.com/benchmarking-golang-improve-function-performance/" rel="nofollow">Benchmarking in Golang: Improving function performance</a></li><li><a href="https://pkg.go.dev/golang.org/x/perf/cmd/benchstat" rel="nofollow">benchstat</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/589929bffc733fcec4c30de61227d214/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">头歌平台python数据分析——（7）数据聚合</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7f2f938672b7c32ce43fd32669caf8e6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">git命令 拉/推项目（精简）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>