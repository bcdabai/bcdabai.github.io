<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Redis实战—黑马点评（二）缓存篇 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Redis实战—黑马点评（二）缓存篇" />
<meta property="og:description" content="Redis实战—黑马点评（二）缓存篇 目录 Redis实战—黑马点评（二）缓存篇1. 什么是缓存1.1 缓存的作用和成本 2. 添加 Redis 缓存3. 缓存更新策略3.1 三种更新策略3.1.1 主动更新策略 4. 缓存穿透4.1 常见两种解决办法4.1.1 缓存空值4.1.2 布隆过滤器 4.2 小结 5. 缓存雪崩6. 缓存击穿6.1 常见解决方案两种6.1.1 互斥锁6.1.2 逻辑过期6.1.3 方案对比 6.2 小收获 7. 缓存工具类封装7.1 代码实现问题：刚才的代码中，锁的key不应该在代码中指定，而是作为参数传入。 7.2 小收获7.2.1 时间处理7.2.2 泛型使用7.2.3 Function对象 1. 什么是缓存 缓存即为数据交换的缓冲区，是数据临时存储的地方，读写性能高。
1.1 缓存的作用和成本 简单的说，用缓存好处多，可以提升程序性能，缺点就是麻烦。
2. 添加 Redis 缓存 不用缓存的话，我们的程序获取数据是从数据库：
用了缓存之后，减少了数据库的压力：
原本需要从数据库中查的数据现在只需要去缓存中查了（第一次除外）。
案例：添加商户缓存
具体代码就不写了，这个流程还存在缓存穿透的问题，后续会说明。
这里收获了一个小编码技巧，在软件工程中有“单一出口原则”的说法，在方法中就只有一个return，但有时候用多个return会大幅简洁代码，省掉大量的else。
3. 缓存更新策略 数据存到缓存后，会有一个数据一致性的人问题：
假如数据库更新了，用户还是从缓存查数据，那么查到的就是缓存中的旧数据了。
所以需要有一种更行缓存的机制。
3.1 三种更新策略 内存淘汰
Redis自带的机制，当内存不足时自动淘汰部分数据。下次查询时更新缓存。
超时剔除
给数据添加TTL值，到期自动删除。下次查询时更新。
主动更新
主动编写逻辑，在数据改变时，更行缓存。
3.1.1 主动更新策略 第一种就是主动编码，在数据库更新时更新缓存（编码多，麻烦）。
第二种就是将缓存和数据库整合为一个服务，由该服务来保证一致性（编码少，缺点就是这个服务质量不好保证，不好维护）。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/79538144e42ea0986fdf719e4fd74ebc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-16T10:00:30+08:00" />
<meta property="article:modified_time" content="2023-02-16T10:00:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Redis实战—黑马点评（二）缓存篇</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Redis_0"></a>Redis实战—黑马点评（二）缓存篇</h2> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#Redis_0" rel="nofollow">Redis实战—黑马点评（二）缓存篇</a></li><li><ul><li><a href="#1__7" rel="nofollow">1. 什么是缓存</a></li><li><ul><li><a href="#11__14" rel="nofollow">1.1 缓存的作用和成本</a></li></ul> 
   </li><li><a href="#2__Redis__21" rel="nofollow">2. 添加 Redis 缓存</a></li><li><a href="#3__46" rel="nofollow">3. 缓存更新策略</a></li><li><ul><li><a href="#31__54" rel="nofollow">3.1 三种更新策略</a></li><li><ul><li><a href="#311__71" rel="nofollow">3.1.1 主动更新策略</a></li></ul> 
   </li></ul> 
   </li><li><a href="#4__123" rel="nofollow">4. 缓存穿透</a></li><li><ul><li><a href="#41__127" rel="nofollow">4.1 常见两种解决办法</a></li><li><ul><li><a href="#411__136" rel="nofollow">4.1.1 缓存空值</a></li><li><a href="#412__149" rel="nofollow">4.1.2 布隆过滤器</a></li></ul> 
    </li><li><a href="#42__168" rel="nofollow">4.2 小结</a></li></ul> 
   </li><li><a href="#5__175" rel="nofollow">5. 缓存雪崩</a></li><li><a href="#6__199" rel="nofollow">6. 缓存击穿</a></li><li><ul><li><a href="#61__208" rel="nofollow">6.1 常见解决方案两种</a></li><li><ul><li><a href="#611__213" rel="nofollow">6.1.1 互斥锁</a></li><li><a href="#612__220" rel="nofollow">6.1.2 逻辑过期</a></li><li><a href="#613__227" rel="nofollow">6.1.3 方案对比</a></li></ul> 
    </li><li><a href="#62__236" rel="nofollow">6.2 小收获</a></li></ul> 
   </li><li><a href="#7__269" rel="nofollow">7. 缓存工具类封装</a></li><li><ul><li><a href="#71__271" rel="nofollow">7.1 代码实现</a></li><li><ul><li><a href="#key_394" rel="nofollow">问题：刚才的代码中，锁的key不应该在代码中指定，而是作为参数传入。</a></li></ul> 
    </li><li><a href="#72__398" rel="nofollow">7.2 小收获</a></li><li><ul><li><a href="#721__402" rel="nofollow">7.2.1 时间处理</a></li><li><a href="#722__445" rel="nofollow">7.2.2 泛型使用</a></li><li><a href="#723_Function_563" rel="nofollow">7.2.3 Function对象</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p><img src="https://images2.imgbox.com/4c/7c/RMt8cvI8_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="1__7"></a>1. 什么是缓存</h3> 
<p>缓存即为数据交换的缓冲区，是数据临时存储的地方，<strong>读写性能高</strong>。</p> 
<p><img src="https://images2.imgbox.com/8e/fd/x1zcGGXn_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="11__14"></a>1.1 缓存的作用和成本</h4> 
<p><img src="https://images2.imgbox.com/62/27/km53Xe6R_o.jpg" alt="在这里插入图片描述"></p> 
<p>简单的说，用缓存好处多，可以提升程序性能，缺点就是麻烦。</p> 
<h3><a id="2__Redis__21"></a>2. 添加 Redis 缓存</h3> 
<p>不用缓存的话，我们的程序获取数据是从数据库：</p> 
<p><img src="https://images2.imgbox.com/5a/73/7IvAOQ15_o.jpg" alt="在这里插入图片描述"></p> 
<p>用了缓存之后，减少了数据库的压力：</p> 
<p><img src="https://images2.imgbox.com/74/7f/KVzCE7nh_o.jpg" alt="在这里插入图片描述"></p> 
<p>原本需要从数据库中查的数据现在只需要去缓存中查了（第一次除外）。</p> 
<p>案例：添加商户缓存</p> 
<p><img src="https://images2.imgbox.com/e0/7b/pIHscP6y_o.jpg" alt="在这里插入图片描述"></p> 
<p>具体代码就不写了，这个流程还存在缓存穿透的问题，后续会说明。</p> 
<p>这里收获了一个小编码技巧，在软件工程中有“单一出口原则”的说法，在方法中就只有一个return，但有时候用多个return会大幅简洁代码，省掉大量的else。</p> 
<h3><a id="3__46"></a>3. 缓存更新策略</h3> 
<p>数据存到缓存后，会有一个数据一致性的人问题：</p> 
<p>假如数据库更新了，用户还是从缓存查数据，那么查到的就是缓存中的旧数据了。</p> 
<p>所以需要有一种更行缓存的机制。</p> 
<h4><a id="31__54"></a>3.1 三种更新策略</h4> 
<ol><li> <p>内存淘汰</p> <p>Redis自带的机制，当内存不足时自动淘汰部分数据。下次查询时更新缓存。</p> </li><li> <p>超时剔除</p> <p>给数据添加TTL值，到期自动删除。下次查询时更新。</p> </li><li> <p>主动更新</p> <p>主动编写逻辑，在数据改变时，更行缓存。</p> </li></ol> 
<p><img src="https://images2.imgbox.com/3c/f6/Ic6PyVeD_o.jpg" alt="在这里插入图片描述"></p> 
<h5><a id="311__71"></a>3.1.1 主动更新策略</h5> 
<p><img src="https://images2.imgbox.com/66/72/pIm3nL2H_o.jpg" alt="在这里插入图片描述"></p> 
<p>第一种就是主动编码，在数据库更新时更新缓存（编码多，麻烦）。</p> 
<p>第二种就是将缓存和数据库整合为一个服务，由该服务来保证一致性（编码少，缺点就是这个服务质量不好保证，不好维护）。</p> 
<p>第三种就是只操作缓存，由其他服务来将缓存同步到数据库，保证最终一致性。（完全不用关心数据库，但是当缓存没有同步时宕机了，数据将不会同步到数据库）。</p> 
<p>第一二种都是强一致性，第三种是保证最终一致性。</p> 
<p>方案一强一致且可控，用的较多。</p> 
<p>在开始编码前，还有三个问题需要考虑：</p> 
<ol><li> <p>更新数据库时，缓存是更新还是删除？</p> <p>更新：每次更新数据库都更新缓存</p> <p>删除：更新时删除缓存，查询时更新缓存</p> <p>一般是选择删除的方案，因为不是每次更新都要查询的，不查询，也就省去了添加缓存的步骤，避免浪费内存，性能。</p> </li><li> <p>如何保证同时成功或失败？</p> <p>单体系统：将缓存和数据库操作放在同一个事务中。</p> <p>分布式系统：利用TCC等分布式事务方案。</p> </li><li> <p>先操作缓存还是数据库？</p> <p>本质上是线程安全问题</p> <p>看两个例子，初始状态数据库，缓存都为10</p> <p><img src="https://images2.imgbox.com/7d/9d/VOxmd8n8_o.jpg" alt="在这里插入图片描述"></p> <p>先删除缓存，在数据库更新这个耗时操作完成之前，其他线程将未更新前的数据更新到缓存，然后原来的线程再更新数据库，造成数据的不一致。</p> <p>例2：<img src="https://images2.imgbox.com/03/26/Rp0BNuFQ_o.jpg" alt="在这里插入图片描述"></p> <p>假设缓存在线程一查询时恰好失效（或没有该缓存），将会查询数据库，此时数据库是老数据，在将该老数据写入缓存时，线程二进行数据库更新和缓存删除操作，最后线程一写入老数据，造成数据不一致。</p> <p>**例二这种情况发生概率很小，因为写缓存的操作是微秒级的，短时间内不太可能完成数据库更新和缓存删除的操作。例一的情况发生的概率还是比较大的。**所以一般先操作数据库再删缓存并且给数据加上一个TTL过期时间，最大限度保证线程安全。</p> </li></ol> 
<p><img src="https://images2.imgbox.com/67/6d/9ODZmidc_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="4__123"></a>4. 缓存穿透</h3> 
<p>缓存穿透是指，客户端的请求数据在数据库和缓存都不存在，但是这些请求永远会打向数据库，给数据库造成压力。</p> 
<h4><a id="41__127"></a>4.1 常见两种解决办法</h4> 
<p><img src="https://images2.imgbox.com/50/9b/KLsMdTNd_o.jpg" alt="在这里插入图片描述"></p> 
<h5><a id="411__136"></a>4.1.1 缓存空值</h5> 
<p>即使数据库不存在，我们也在redis中缓存一个空。</p> 
<p>优点：简单，易维护。</p> 
<p>缺点：</p> 
<ul><li>额外的内存消耗（可加一个TTL缓解）</li><li>可能造成短期的数据不一致（当缓存空值时，该数据正好被插入数据库，客户端请求缓存获得空）</li></ul> 
<h5><a id="412__149"></a>4.1.2 布隆过滤器</h5> 
<p>用算法实现的记录所请求的数据是否存在的过滤器。底层像是BitMap。当数据库中不存在该数据时，会拒绝请求，存在时才放行。</p> 
<p>存在误判可能，有可能出现数据不存在布隆过滤器却认为存在的情况，但是布隆过滤器若是认为数据不存在，那就一定不存在。</p> 
<p>优点就是不占用额外内存，缺点就是实现复杂，存在误判可能。</p> 
<p><strong>使用方案一，简单高效</strong></p> 
<p>所以商户缓存的流程将被优化为：</p> 
<p><img src="https://images2.imgbox.com/24/01/yIMcT64R_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="42__168"></a>4.2 小结</h4> 
<p><img src="https://images2.imgbox.com/74/9a/Psc8hJkT_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5__175"></a>5. 缓存雪崩</h3> 
<p>缓存雪崩是指，在同一时间大量的key同时失效或redis服务宕机，导致大量请求到达数据库，给数据库造成过大压力。</p> 
<p>解决方案比较常见的有：</p> 
<ol><li> <p>给不同的key的TTL添加随机值</p> <p>不在同一时间过期，添加几分钟随机值（根据业务）。</p> </li><li> <p>Redis集群，提高可用性</p> <p>避免redis服务全部挂掉。</p> </li><li> <p>缓存业务降级限流策略</p> <p>亡羊补牢，数据库再崩了就是更大的损失。</p> </li><li> <p>添加多级缓存</p> <p>浏览器缓存，nginx缓存等，即使redis崩了，还有其他缓存可查。</p> </li></ol> 
<h3><a id="6__199"></a>6. 缓存击穿</h3> 
<p>也被称为热点key问题，即 一个<strong>被高并发访问</strong>并且<strong>缓存重建业务复杂</strong>的key突然失效，大量请求给数据库带来巨大压力。</p> 
<p><img src="https://images2.imgbox.com/a6/87/FbQyAmim_o.jpg" alt="在这里插入图片描述"></p> 
<p>在缓存重建期间大量请求到达数据库。</p> 
<h4><a id="61__208"></a>6.1 常见解决方案两种</h4> 
<p><img src="https://images2.imgbox.com/fd/75/IbBfM7iH_o.jpg" alt="在这里插入图片描述"></p> 
<h5><a id="611__213"></a>6.1.1 互斥锁</h5> 
<p>当缓存重建业务开始时，其他线程等待并重试，保证没有多余的请求到达数据库。该互斥锁的简单时间可以用setnx命令来实现。（在后续秒杀篇中会实现该分布式锁）</p> 
<p><img src="https://images2.imgbox.com/a0/5b/tgyVvgLY_o.jpg" alt="在这里插入图片描述"></p> 
<h5><a id="612__220"></a>6.1.2 逻辑过期</h5> 
<p>用一个字段来保存过期时间，查询该缓存时判断缓存是否过期，如果过期则返回旧数据，并让另一个线程异步地重建缓存，重建缓存时需要加锁，其他线程来获取锁失败时，返回旧数据。</p> 
<p><img src="https://images2.imgbox.com/2f/e1/k4w1aeUl_o.jpg" alt="在这里插入图片描述"></p> 
<h5><a id="613__227"></a>6.1.3 方案对比</h5> 
<p><img src="https://images2.imgbox.com/dc/d1/Hq72cJlT_o.jpg" alt="在这里插入图片描述"></p> 
<p>方案一牺牲性能保证一致性，方案二则反之，根据业务需求选择。</p> 
<h4><a id="62__236"></a>6.2 小收获</h4> 
<p>若使用方案二，需要添加一个字段，如何添加呢？</p> 
<p>在数据库添加是最笨的方式并且不合理。</p> 
<p>在往常，我会新建一个DTO，然后添加该字段，使用该DTO对象进行数据传输。</p> 
<p>在该课程中，我学会了如下方案：</p> 
<ol><li> <p>使用MP的注解</p> <p><img src="https://images2.imgbox.com/07/ed/WSH0JjCV_o.jpg" alt="在这里插入图片描述"></p> <p>但是这样就破坏了该对象的结构</p> </li><li> <p>创建一个新的类继承该类，然后添加新字段。（DTO）</p> </li><li> <p>创建一个新类，添加该字段，让原类继承该类。（和一一样，破坏了对象的结构）</p> </li><li> <p>创建一个新类，使用泛型，该类包含新的字段和一个泛型对象。（优雅）</p> <pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> expireTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<h3><a id="7__269"></a>7. 缓存工具类封装</h3> 
<h4><a id="71__271"></a>7.1 代码实现</h4> 
<p><img src="https://images2.imgbox.com/90/e2/A6svJEaw_o.jpg" alt="在这里插入图片描述"></p> 
<p>简单说就是：1、3配合解决缓存穿透，2、4配合解决缓存击穿，四个方法，两个设置两个读取。</p> 
<p>方法一：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">R</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>方法二：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">setWithExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">R</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">RedisData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 写入redis</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>方法三：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> ID<span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">queryWithPassThrough</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Type</span> type<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ignoreError<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> dbFallback<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">R</span> r<span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> keyPrefix <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token comment">// 1. 从redis查询商铺缓存</span>
    <span class="token class-name">String</span> json <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 判断是否存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 3.1 存在</span>
        r <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> type<span class="token punctuation">,</span> ignoreError<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.2 不存在</span>
    <span class="token comment">// 判断是否是空值(防止缓存穿透)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>json <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 从数据库查询</span>
    r <span class="token operator">=</span> dbFallback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 不存在 返回错误 将空值写入redis</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token constant">CACHE_NULL_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 存在 写入redis</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> r<span class="token punctuation">,</span> time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>方法四：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> ID<span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">queryWithLogicalExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Type</span> type<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ignoreError<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> dbFallback<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">R</span> r<span class="token punctuation">;</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> keyPrefix <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token comment">// 1. 从redis查询商铺缓存</span>
    <span class="token class-name">String</span> json <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 判断是否命中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 3.1 未命中</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.2 命中</span>
    <span class="token class-name">RedisData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisData</span><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ignoreError<span class="token punctuation">)</span><span class="token punctuation">;</span>
    r <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span>redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 4. 判断是否过期</span>
        <span class="token comment">// 4.1 未过期 返回</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4.2 过期</span>
    <span class="token comment">// 5. 缓存重建</span>
    <span class="token comment">// 5.1 获取互斥锁</span>
    <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token constant">LOCK_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 5.2 成功 开启另一线程重建</span>
        <span class="token constant">CACHE_REBUILD_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 查数据库</span>
                <span class="token class-name">R</span> newR <span class="token operator">=</span> dbFallback<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 更新缓存</span>
                <span class="token function">setWithExpire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> newR<span class="token punctuation">,</span> time<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 模拟业务延时</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">unLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 5.3 失败</span>
    <span class="token comment">// 无论是否成功都返回旧数据</span>
    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>锁的简单实现</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   	<span class="token comment">// 当flag为null时，若直接返回将会拆箱失败，报错，所以使用hutool的BooleanUtil工具保证拆箱成功（不用也可以，用Boolean.TRUE.equals方法）</span>
    <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="key_394"></a>问题：刚才的代码中，锁的key不应该在代码中指定，而是作为参数传入。</h5> 
<h4><a id="72__398"></a>7.2 小收获</h4> 
<p>收获到了很多编码小技巧：</p> 
<h5><a id="721__402"></a>7.2.1 时间处理</h5> 
<ol><li> <p>判断某个值是否过期</p> <pre><code class="prism language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span>redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre> <p>可以用LocalDateTime的isBefore和isAfter方法</p> </li><li> <p>续期</p> <p>使用LocalDateTime实例中的plusxxx方法，例如：</p> <pre><code class="prism language-java"><span class="token class-name">LocalDateTime</span> time <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <p>即可在当前时间的基础上添加2000秒得到一个新时间</p> </li><li> <p>单位转换</p> <p>刚刚续期的代码中plusSeconds，不一定每次都是Seconds，很不方便，那如何同一代码呢？</p> <p>使用TimeUtil中的方法：</p> <pre><code class="prism language-java"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 60</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">toMinutes</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
</code></pre> <p>所以续期的代码可以统一为：</p> <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWithExpire</span><span class="token punctuation">(</span><span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<h5><a id="722__445"></a>7.2.2 泛型使用</h5> 
<p>泛型类：</p> 
<pre><code class="prism language-java"><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">IData</span> <span class="token punctuation">{<!-- --></span> 
	<span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>泛型方法：</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token class-name">R</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 定义泛型后，一般会在参数列表中接受泛型来指定泛型类型。</span>
<span class="token punctuation">}</span> 
</code></pre> 
<p>泛型的JSON转换：</p> 
<p>将JSON字符串转换为含有自定义泛型的对象。</p> 
<p>假设有如下类：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">class</span> <span class="token class-name">IData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>一般情况下，因为有类型擦除，我们不会直接.class，我们都是使用TypeRefrence的方式：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
* 用哪种json解析工具用法都差不多 都是传type、class这些
*/</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">json2Obj3</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">R</span> data <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testParse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建json字符串</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> iData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>iData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 解析</span>
    <span class="token class-name">IData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token function">json2Obj3</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IData</span><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 能输出name才算成功</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>若是传class，那么就指定泛型的class对象：</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">IData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">json2Obj2</span><span class="token punctuation">(</span><span class="token class-name">String</span> json<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">IData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IData</span><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这个时候就需要转换两次了 因为在该方法中R就是R类型而不是User类型</span>
    data<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建json字符串</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> iData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>iData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 解析</span>
    <span class="token class-name">IData</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token function">json2Obj2</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 能输出name才算成功</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>类型探究：</p> 
<pre><code class="prism language-java"><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">testType</span><span class="token punctuation">(</span><span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> type1<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>type1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>type2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testType1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">testType</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>输出：</p> 
<p><img src="https://images2.imgbox.com/eb/a8/kARFi09D_o.png" alt="在这里插入图片描述"></p> 
<p>JSON转换小结：在泛型方法内，R就是R对象，不是其他的什么对象，只有将具体的类型传进来才能解析。</p> 
<h5><a id="723_Function_563"></a>7.2.3 Function对象</h5> 
<p>Java8的新特性，可以像js一样丝滑：</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">testFunc</span><span class="token punctuation">(</span><span class="token class-name">String</span> param<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> function<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> function<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"result: "</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testFunc1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">testFunc</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> s <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"in func: "</span> <span class="token operator">+</span> s <span class="token operator">+</span> <span class="token string">" world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s <span class="token operator">+</span> <span class="token string">" result"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>黑马点评中，Redis工具类的封装，当方法中需要查询数据库，但是各个业务的查询逻辑可能不同，于是就在参数列表中加上了Function对象用于传入该逻辑。当然也可以不用Function，直接接受结果，这个结果在方法之外获得。</p> 
<p>Function还有很多用法：</p> 
<p>function源码</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">R</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> before<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>before<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">V</span> v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">apply</span><span class="token punctuation">(</span>before<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">andThen</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> after<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>after<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> after<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token function">apply</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> t <span class="token operator">-&gt;</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>andThen，compose返回值都是Function，可以链式编程，自由组合各种函数。</p> 
<p>ion源码</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">R</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">V</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> before<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>before<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">V</span> v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">apply</span><span class="token punctuation">(</span>before<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">default</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">andThen</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">R</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> after<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>after<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span> t<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> after<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token function">apply</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> t <span class="token operator">-&gt;</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>andThen，compose返回值都是Function，可以链式编程，自由组合各种函数。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/50d8af54c42de86a907c5656e0345914/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">linux网络之怪现象一--接网线启动网络不通，不接网线启动再插线网络通</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/39a41d269b7a1dbb70fff9019c93f8cc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">R语言实现常用的5种分析方法（主成分&#43;因子&#43;多维标度&#43;判别&#43;聚类</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>