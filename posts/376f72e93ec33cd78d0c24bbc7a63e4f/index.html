<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 按键事件分发流程 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 按键事件分发流程" />
<meta property="og:description" content="版本：Android11
前言： 最近TV开发中遇到这么一个需求，添加一键进入谷歌浏览器，并进入指定的网址中。最开始在PhoneWindowManager中进行添加，但是添加完成后发现存在问题。每次进入浏览器都会打开一个浏览器窗口，按下次数多了会变得异常卡顿，后续将按键响应的流程放在PhoneFallbackEventHandler中进行处理之后便能解决这个问题，觉得较为奇怪，便准备查看一遍按键事件的分发流程，以理清整个的逻辑。
按键处理流程： 首先从PhoneWindowManager开始，按键从遥控器按下之后，经过一系列底层向上的传递工作之后，会来到PhoneWindowManager的interceptKeyBeforeDispatching方法和interceptKeyBeforeQueueing方法，在这里可以对按键进行初步处理，例如音量键，Home键，都是在这里处理。代码较长，这里就不贴了，大家可以自行去查看源码。在PhoneWindowManager中如果没有处理按键事件，那么按键会传入到ViewRootImpl。
frameworks\base\services\core\java\com\android\server\policy\PhoneWindowManager.java 在ViewRootImpl有三个内部类用于处理按键事件，分别是:
ViewPreImeInputStage，EarlyPostImeInputStage，ViewPostImeInputStage
这三个内部类的区别是ViewPreImeInputStage会在界面有输入法，且事件尚未发送给输入法的时候调用，EarlyPostImeInputStage会在发送给输入法之后调用，而ViewPostImeInputStage则是发送给View处理，我们的需求中没有出现输入法的地方，所以我们直接来看ViewPostImeInputStage类：
frameworks\base\core\java\android\view\ViewRootImpl.java /** * Delivers post-ime input events to the view hierarchy. */ final class ViewPostImeInputStage extends InputStage { public ViewPostImeInputStage(InputStage next) { super(next); } @Override protected int onProcess(QueuedInputEvent q) { if (q.mEvent instanceof KeyEvent) { return processKeyEvent(q); } else { final int source = q.mEvent.getSource(); if ((source &amp; InputDevice.SOURCE_CLASS_POINTER) != 0) { return processPointerEvent(q); } else if ((source &amp; InputDevice.SOURCE_CLASS_TRACKBALL) !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/376f72e93ec33cd78d0c24bbc7a63e4f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-30T13:34:45+08:00" />
<meta property="article:modified_time" content="2022-03-30T13:34:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 按键事件分发流程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>版本：Android11</p> 
<h3><a id="_1"></a>前言：</h3> 
<p>最近TV开发中遇到这么一个需求，添加一键进入谷歌浏览器，并进入指定的网址中。最开始在PhoneWindowManager中进行添加，但是添加完成后发现存在问题。每次进入浏览器都会打开一个浏览器窗口，按下次数多了会变得异常卡顿，后续将按键响应的流程放在PhoneFallbackEventHandler中进行处理之后便能解决这个问题，觉得较为奇怪，便准备查看一遍按键事件的分发流程，以理清整个的逻辑。</p> 
<h3><a id="_4"></a>按键处理流程：</h3> 
<p>首先从PhoneWindowManager开始，按键从遥控器按下之后，经过一系列底层向上的传递工作之后，会来到PhoneWindowManager的interceptKeyBeforeDispatching方法和interceptKeyBeforeQueueing方法，在这里可以对按键进行初步处理，例如音量键，Home键，都是在这里处理。代码较长，这里就不贴了，大家可以自行去查看源码。在PhoneWindowManager中如果没有处理按键事件，那么按键会传入到ViewRootImpl。</p> 
<pre><code class="prism language-bash">frameworks<span class="token punctuation">\</span>base<span class="token punctuation">\</span>services<span class="token punctuation">\</span>core<span class="token punctuation">\</span>java<span class="token punctuation">\</span>com<span class="token punctuation">\</span>android<span class="token punctuation">\</span>server<span class="token punctuation">\</span>policy<span class="token punctuation">\</span>PhoneWindowManager.java
</code></pre> 
<p>在ViewRootImpl有三个内部类用于处理按键事件，分别是:<br> ViewPreImeInputStage，EarlyPostImeInputStage，ViewPostImeInputStage<br> 这三个内部类的区别是ViewPreImeInputStage会在界面有输入法，且事件尚未发送给输入法的时候调用，EarlyPostImeInputStage会在发送给输入法之后调用，而ViewPostImeInputStage则是发送给View处理，我们的需求中没有出现输入法的地方，所以我们直接来看ViewPostImeInputStage类：</p> 
<pre><code class="prism language-bash">frameworks<span class="token punctuation">\</span>base<span class="token punctuation">\</span>core<span class="token punctuation">\</span>java<span class="token punctuation">\</span>android<span class="token punctuation">\</span>view<span class="token punctuation">\</span>ViewRootImpl.java
</code></pre> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * Delivers post-ime input events to the view hierarchy.
     */</span>
    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ViewPostImeInputStage</span> <span class="token keyword">extends</span> <span class="token class-name">InputStage</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token class-name">ViewPostImeInputStage</span><span class="token punctuation">(</span><span class="token class-name">InputStage</span> next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">onProcess</span><span class="token punctuation">(</span><span class="token class-name">QueuedInputEvent</span> q<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span>mEvent <span class="token keyword">instanceof</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">processKeyEvent</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> source <span class="token operator">=</span> q<span class="token punctuation">.</span>mEvent<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>source <span class="token operator">&amp;</span> <span class="token class-name">InputDevice</span><span class="token punctuation">.</span>SOURCE_CLASS_POINTER<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token function">processPointerEvent</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>source <span class="token operator">&amp;</span> <span class="token class-name">InputDevice</span><span class="token punctuation">.</span>SOURCE_CLASS_TRACKBALL<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token function">processTrackballEvent</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token function">processGenericMotionEvent</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>在事件发下来后首先会调用onProcess方法，在这个方法中判断event属于KeyEvent之后就会调用processKeyEvent方法，我们继续看processKeyEvent方法：</p> 
<pre><code class="prism language-java">        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">processKeyEvent</span><span class="token punctuation">(</span><span class="token class-name">QueuedInputEvent</span> q<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">KeyEvent</span> event <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">KeyEvent</span><span class="token punctuation">)</span>q<span class="token punctuation">.</span>mEvent<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mUnhandledKeyManager<span class="token punctuation">.</span><span class="token function">preViewDispatch</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> FINISH_HANDLED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Deliver the key to the view hierarchy.</span>
            <span class="token comment">//这里会将按键事件传递给mView的dispatchKeyEvent方法</span>
            <span class="token comment">//这个mView便是我们Activity的最顶层布局DecorView对象</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mView<span class="token punctuation">.</span><span class="token function">dispatchKeyEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> FINISH_HANDLED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldDropInputEvent</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> FINISH_NOT_HANDLED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// This dispatch is for windows that don't have a Window.Callback. Otherwise,</span>
            <span class="token comment">// the Window.Callback usually will have already called this (see</span>
            <span class="token comment">// DecorView.superDispatchKeyEvent) leaving this call a no-op.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mUnhandledKeyManager<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>mView<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> FINISH_HANDLED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">int</span> groupNavigationDirection <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token comment">//此处会判断一下方向键以及TAB键，进行方向和焦点的处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span>ACTION_DOWN
                    <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span><span class="token function">getKeyCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span>KEYCODE_TAB<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeyEvent</span><span class="token punctuation">.</span><span class="token function">metaStateHasModifiers</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getMetaState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span>META_META_ON<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    groupNavigationDirection <span class="token operator">=</span> <span class="token class-name">View</span><span class="token punctuation">.</span>FOCUS_FORWARD<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeyEvent</span><span class="token punctuation">.</span><span class="token function">metaStateHasModifiers</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getMetaState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span>META_META_ON <span class="token operator">|</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span>META_SHIFT_ON<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    groupNavigationDirection <span class="token operator">=</span> <span class="token class-name">View</span><span class="token punctuation">.</span>FOCUS_BACKWARD<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// If a modifier is held, try to interpret the key as a shortcut.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span>ACTION_DOWN
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">KeyEvent</span><span class="token punctuation">.</span><span class="token function">metaStateHasNoModifiers</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getMetaState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span><span class="token function">getRepeatCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">KeyEvent</span><span class="token punctuation">.</span><span class="token function">isModifierKey</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getKeyCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> groupNavigationDirection <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mView<span class="token punctuation">.</span><span class="token function">dispatchKeyShortcutEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> FINISH_HANDLED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldDropInputEvent</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> FINISH_NOT_HANDLED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Apply the fallback event policy.</span>
            <span class="token comment">// 这里便是我们添加按键处理的地方</span>
            <span class="token comment">//可以看到这里是在mView没有处理消耗按键之后才能接收到事件</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mFallbackEventHandler<span class="token punctuation">.</span><span class="token function">dispatchKeyEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> FINISH_HANDLED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldDropInputEvent</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> FINISH_NOT_HANDLED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Handle automatic focus changes.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span>ACTION_DOWN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>groupNavigationDirection <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">performKeyboardGroupNavigation</span><span class="token punctuation">(</span>groupNavigationDirection<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> FINISH_HANDLED<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">performFocusNavigation</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> FINISH_HANDLED<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> FORWARD<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>从上面这段代码我们可以看出，按键消息会先发送给Activity所在的DecorView对象，如果DecorView没有对按键进行处理，才会继续下发到PhoneFallbackEventHandler对象。而我们第一次按下按键时由于在Launcher界面，DecorView没有处理此按键事件，便将按键事件分发到PhoneFallbackEventHandler中，而我们在PhoneFallbackEventHandler中onKeyUp方法才能正确获取到消息并进行处理。而当进入了对应网页之后，大部分按键都在mView.dispatchKeyEvent中被拦截了，我们继续查看DecorView的dispatchKeyEvent方法。</p> 
<pre><code class="prism language-bash">frameworks<span class="token punctuation">\</span>base<span class="token punctuation">\</span>core<span class="token punctuation">\</span>java<span class="token punctuation">\</span>com<span class="token punctuation">\</span>android<span class="token punctuation">\</span>internal<span class="token punctuation">\</span>policy<span class="token punctuation">\</span>DecorView.java
</code></pre> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dispatchKeyEvent</span><span class="token punctuation">(</span><span class="token class-name">KeyEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> keyCode <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getKeyCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> action <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isDown <span class="token operator">=</span> action <span class="token operator">==</span> <span class="token class-name">KeyEvent</span><span class="token punctuation">.</span>ACTION_DOWN<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isDown <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getRepeatCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// First handle chording of panel key: if a panel key is held</span>
            <span class="token comment">// but not released, try to execute a shortcut in it.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mWindow<span class="token punctuation">.</span>mPanelChordingKey <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mWindow<span class="token punctuation">.</span>mPanelChordingKey <span class="token operator">!=</span> keyCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">boolean</span> handled <span class="token operator">=</span> <span class="token function">dispatchKeyShortcutEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>handled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// If a panel is open, perform a shortcut on it without the</span>
            <span class="token comment">// chorded panel key</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mWindow<span class="token punctuation">.</span>mPreparedPanel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mWindow<span class="token punctuation">.</span>mPreparedPanel<span class="token punctuation">.</span>isOpen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mWindow<span class="token punctuation">.</span><span class="token function">performPanelShortcut</span><span class="token punctuation">(</span>mWindow<span class="token punctuation">.</span>mPreparedPanel<span class="token punctuation">,</span> keyCode<span class="token punctuation">,</span> event<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//这里进行判断，当window未销毁，并且Callback存在,并且是应用程序时</span>
		<span class="token comment">//就会发送到PhoneWindow.Callback 的dispatchKeyEvent方法，否则就发往父类</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mWindow<span class="token punctuation">.</span><span class="token function">isDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">Window<span class="token punctuation">.</span>Callback</span> cb <span class="token operator">=</span> mWindow<span class="token punctuation">.</span><span class="token function">getCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> handled <span class="token operator">=</span> cb <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mFeatureId <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> cb<span class="token punctuation">.</span><span class="token function">dispatchKeyEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
                    <span class="token operator">:</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">dispatchKeyEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>handled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> isDown <span class="token operator">?</span> mWindow<span class="token punctuation">.</span><span class="token function">onKeyDown</span><span class="token punctuation">(</span>mFeatureId<span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getKeyCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span>
                <span class="token operator">:</span> mWindow<span class="token punctuation">.</span><span class="token function">onKeyUp</span><span class="token punctuation">(</span>mFeatureId<span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getKeyCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>从这里可以看到当window未销毁时，就会去获取Callback对象，而这个callback对象实际上就是我们应用的Activity，因为Activity是实现了Callback接口的，通过打印也可以能看到在此处调用完之后就是调用的Activity的dispatchKeyEvent方法，大家可以自行实验。<br> 而mFeatureId变量表示小于零表示为应用程序。</p> 
<h3><a id="_173"></a>结论</h3> 
<p>经过这一步骤后，按键便传递到了Activity中，而谷歌浏览器中做了什么处理我们看不到代码，只能根据打印猜测一番。在进入了指定页面之后输入的一些按键都会在mView.dispatchKeyEvent中被拦截，只有Back键，Menu键等特殊按键有响应，应当是此页面直接拦截了按键事件，所以进入页面之后在ViewRootImpl中只会走到mView.dispatchKeyEvent便return，我们加在PhoneFallbackEventHandler的处理便不会再执行，以此达到我们的目的。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4ad2dfe1315b22212178edbc3ea55bde/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ssd性能测试</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/05d9c13302e6c4d088880f1bb19cfe83/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">防火墙：firewall-cmd命令</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>