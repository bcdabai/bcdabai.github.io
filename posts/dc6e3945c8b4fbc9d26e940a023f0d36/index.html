<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Swin Transformer实战图像分类(Windows下，无需用到Conda，亲测有效) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Swin Transformer实战图像分类(Windows下，无需用到Conda，亲测有效)" />
<meta property="og:description" content="目录
前言
一、从官网拿到源码，然后配置自己缺少的环境。
针对可能遇到的错误：
二、数据集获取与处理
2.1 数据集下载
2.2 数据集处理
三、下载预训练权重
四、修改部分参数配置
4.1 修改config.py
4.2 修改build.py
4.3 修改units.py
4.4 修改main.py
4.5 修改其他的地方
4.6 将最后结果以折线图的形式呈现出来
五、其他可修改的地方
六、运行代码
前言 关于Swin Transformer的讲解和实战，实际上网络上已经有很多了。不过有一些代码跑起来可能有一些问题（有一些确实有点问题，或者没头没尾的）。
最初的时候，我通过一些调研，参照网上的一些教程，跑的时候也遇到了一些问题，但是最后确实是成功了。下面我就详细地来讲述应该怎么做。
关于Swin Transformer的基础知识就不再赘述了。相信想到用Swin Transformer来实战的同学肯定已经多多少少对其有一定了解了。
在此，我说一下我的实战的思路：
从官网拿到代码，然后改改，换成自己的数据集，加载它的预训练权重，然后让代码跑起来。
如果你的coding能力确实比较强，那么你完全可以从官网上找到部分Swin Transformer的Model部分核心代码，然后数据处理部分、跑模型的部分都自己来写，这样做也完全OK。但是对能力要求较高，并且对模型的理解要求也比较高。比如，参考某B站Up主的视频，它的代码就是这样子的（在别人的文章里应该都能看的到，我就不重复了）。
而我们在这里就介绍傻瓜式的操作。
我的环境：
Win 10Python 3.8Pytorch/torchvision 1.13.1&#43;cu116NVIDIA GeForce RTX 3060（CUDA 11.7.102）Pycharm Community； OK，开始。
一、从官网拿到源码，然后配置自己缺少的环境。 论文: https://arxiv.org/abs/2103.14030
代码: https://github.com/microsoft/Swin-Transformer
注意下，这里的fused window process、还有apex等不安装也是可以跑通的。它们的安装不影响代码的运行。如果你最后对性能有很高的要求，那你再去下载，我们这里主要是学习，然后让它先跑起来。
你要最起码确保在data文件夹下、models文件夹下和最外层的所有py文件都没有依赖报错（就是导入包的报错）
就是如上图那些的一些包，你给它都下载好不报错就行了。或者你新搞个虚拟环境，然后重新装一下就行，怎么搞虚拟环境可以参考这篇文章【正在更新中...】。
针对可能遇到的错误： 注意，这个错误只是可能遇到，不是一定会遇到。它和你下载的Pytorch的版本有关系。并且你的分类数如果大于5，应该是不会报错的。
那我们需要做什么呢？就是你可能需要改一下你的accuracy函数。
说一下这个函数的入口在哪找，因为这个函数并不是Swin-transformer的函数，它是Pytorch内置的文件函数，所以它原本是只读的（只是有写保护，并非不可更改）。那么我们从哪里找呢？
找到main.py-&gt;函数validate，有一行
acc1, acc5 = accuracy(output, target, topk=(1, 5)) 鼠标点击accuracy函数，然后按ctrl B就可以了(转到定义)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/dc6e3945c8b4fbc9d26e940a023f0d36/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-03T21:47:02+08:00" />
<meta property="article:modified_time" content="2023-12-03T21:47:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Swin Transformer实战图像分类(Windows下，无需用到Conda，亲测有效)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E5%89%8D%E8%A8%80-toc" style="margin-left:0px;"><a href="#%E5%89%8D%E8%A8%80" rel="nofollow">前言</a></p> 
<p id="%E4%B8%80%E3%80%81%E4%BB%8E%E5%AE%98%E7%BD%91%E6%8B%BF%E5%88%B0%E6%BA%90%E7%A0%81%EF%BC%8C%E7%84%B6%E5%90%8E%E9%85%8D%E7%BD%AE%E8%87%AA%E5%B7%B1%E7%BC%BA%E5%B0%91%E7%9A%84%E7%8E%AF%E5%A2%83%E3%80%82-toc" style="margin-left:0px;"><a href="#%E4%B8%80%E3%80%81%E4%BB%8E%E5%AE%98%E7%BD%91%E6%8B%BF%E5%88%B0%E6%BA%90%E7%A0%81%EF%BC%8C%E7%84%B6%E5%90%8E%E9%85%8D%E7%BD%AE%E8%87%AA%E5%B7%B1%E7%BC%BA%E5%B0%91%E7%9A%84%E7%8E%AF%E5%A2%83%E3%80%82" rel="nofollow">一、从官网拿到源码，然后配置自己缺少的环境。</a></p> 
<p id="%E9%92%88%E5%AF%B9%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E9%94%99%E8%AF%AF%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E9%92%88%E5%AF%B9%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E9%94%99%E8%AF%AF%EF%BC%9A" rel="nofollow">针对可能遇到的错误：</a></p> 
<p id="%E4%BA%8C%E3%80%81%E6%95%B0%E6%8D%AE%E9%9B%86%E8%8E%B7%E5%8F%96%E4%B8%8E%E5%A4%84%E7%90%86-toc" style="margin-left:0px;"><a href="#%E4%BA%8C%E3%80%81%E6%95%B0%E6%8D%AE%E9%9B%86%E8%8E%B7%E5%8F%96%E4%B8%8E%E5%A4%84%E7%90%86" rel="nofollow">二、数据集获取与处理</a></p> 
<p id="2.1%20%E6%95%B0%E6%8D%AE%E9%9B%86%E4%B8%8B%E8%BD%BD-toc" style="margin-left:40px;"><a href="#2.1%20%E6%95%B0%E6%8D%AE%E9%9B%86%E4%B8%8B%E8%BD%BD" rel="nofollow">2.1 数据集下载</a></p> 
<p id="2.2%20%E6%95%B0%E6%8D%AE%E9%9B%86%E5%A4%84%E7%90%86-toc" style="margin-left:40px;"><a href="#2.2%20%E6%95%B0%E6%8D%AE%E9%9B%86%E5%A4%84%E7%90%86" rel="nofollow">2.2 数据集处理</a></p> 
<p id="%E4%B8%89%E3%80%81%E4%B8%8B%E8%BD%BD%E9%A2%84%E8%AE%AD%E7%BB%83%E6%9D%83%E9%87%8D-toc" style="margin-left:0px;"><a href="#%E4%B8%89%E3%80%81%E4%B8%8B%E8%BD%BD%E9%A2%84%E8%AE%AD%E7%BB%83%E6%9D%83%E9%87%8D" rel="nofollow">三、下载预训练权重</a></p> 
<p id="%E5%9B%9B%E3%80%81%E4%BF%AE%E6%94%B9%E9%83%A8%E5%88%86%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE-toc" style="margin-left:0px;"><a href="#%E5%9B%9B%E3%80%81%E4%BF%AE%E6%94%B9%E9%83%A8%E5%88%86%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE" rel="nofollow">四、修改部分参数配置</a></p> 
<p id="4.1%20%E4%BF%AE%E6%94%B9config.py-toc" style="margin-left:40px;"><a href="#4.1%20%E4%BF%AE%E6%94%B9config.py" rel="nofollow">4.1 修改config.py</a></p> 
<p id="4.2%20%E4%BF%AE%E6%94%B9build.py-toc" style="margin-left:40px;"><a href="#4.2%20%E4%BF%AE%E6%94%B9build.py" rel="nofollow">4.2 修改build.py</a></p> 
<p id="4.3%20%E4%BF%AE%E6%94%B9units.py-toc" style="margin-left:40px;"><a href="#4.3%20%E4%BF%AE%E6%94%B9units.py" rel="nofollow">4.3 修改units.py</a></p> 
<p id="4.4%20%E4%BF%AE%E6%94%B9main.py-toc" style="margin-left:40px;"><a href="#4.4%20%E4%BF%AE%E6%94%B9main.py" rel="nofollow">4.4 修改main.py</a></p> 
<p id="4.5%20%E4%BF%AE%E6%94%B9%E5%85%B6%E4%BB%96%E7%9A%84%E5%9C%B0%E6%96%B9-toc" style="margin-left:40px;"><a href="#4.5%20%E4%BF%AE%E6%94%B9%E5%85%B6%E4%BB%96%E7%9A%84%E5%9C%B0%E6%96%B9" rel="nofollow">4.5 修改其他的地方</a></p> 
<p id="4.6%20%E5%B0%86%E6%9C%80%E5%90%8E%E7%BB%93%E6%9E%9C%E4%BB%A5%E6%8A%98%E7%BA%BF%E5%9B%BE%E7%9A%84%E5%BD%A2%E5%BC%8F%E5%91%88%E7%8E%B0%E5%87%BA%E6%9D%A5-toc" style="margin-left:40px;"><a href="#4.6%20%E5%B0%86%E6%9C%80%E5%90%8E%E7%BB%93%E6%9E%9C%E4%BB%A5%E6%8A%98%E7%BA%BF%E5%9B%BE%E7%9A%84%E5%BD%A2%E5%BC%8F%E5%91%88%E7%8E%B0%E5%87%BA%E6%9D%A5" rel="nofollow">4.6 将最后结果以折线图的形式呈现出来</a></p> 
<p id="%E4%BA%94%E3%80%81%E5%85%B6%E4%BB%96%E5%8F%AF%E4%BF%AE%E6%94%B9%E7%9A%84%E5%9C%B0%E6%96%B9-toc" style="margin-left:0px;"><a href="#%E4%BA%94%E3%80%81%E5%85%B6%E4%BB%96%E5%8F%AF%E4%BF%AE%E6%94%B9%E7%9A%84%E5%9C%B0%E6%96%B9" rel="nofollow">五、其他可修改的地方</a></p> 
<p id="%E5%85%AD%E3%80%81%E8%BF%90%E8%A1%8C%E4%BB%A3%E7%A0%81-toc" style="margin-left:0px;"><a href="#%E5%85%AD%E3%80%81%E8%BF%90%E8%A1%8C%E4%BB%A3%E7%A0%81" rel="nofollow">六、运行代码</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="%E5%89%8D%E8%A8%80">前言</h2> 
<p>关于Swin Transformer的讲解和实战，实际上网络上已经有很多了。<strong>不过有一些代码跑起来可能有一些问题（有一些确实有点问题，或者没头没尾的）。</strong></p> 
<p>最初的时候，我通过一些调研，参照网上的一些教程，跑的时候也遇到了一些问题，但是最后确实是成功了。下面我就详细地来讲述应该怎么做。</p> 
<p>关于Swin Transformer的基础知识就不再赘述了。相信想到用Swin Transformer来实战的同学肯定已经多多少少对其有一定了解了。</p> 
<p><strong>在此，我说一下我的实战的思路：</strong></p> 
<p><strong>从官网拿到代码，然后改改，换成自己的数据集，加载它的预训练权重，然后让代码跑起来。</strong></p> 
<p>如果你的coding能力确实比较强，那么你完全可以从官网上找到部分Swin Transformer的Model部分核心代码，然后数据处理部分、跑模型的部分都自己来写，这样做也完全OK。但是对能力要求较高，并且对模型的理解要求也比较高。比如，参考某B站Up主的视频，它的代码就是这样子的（在别人的文章里应该都能看的到，我就不重复了）。</p> 
<p>而我们在这里就介绍傻瓜式的操作。</p> 
<p>我的环境：</p> 
<blockquote> 
 <ul><li>Win 10</li><li>Python 3.8</li><li>Pytorch/torchvision 1.13.1+cu116</li><li>NVIDIA GeForce RTX 3060（CUDA 11.7.102）</li><li>Pycharm Community；</li></ul> 
</blockquote> 
<p>OK，开始。</p> 
<p></p> 
<h2 id="%E4%B8%80%E3%80%81%E4%BB%8E%E5%AE%98%E7%BD%91%E6%8B%BF%E5%88%B0%E6%BA%90%E7%A0%81%EF%BC%8C%E7%84%B6%E5%90%8E%E9%85%8D%E7%BD%AE%E8%87%AA%E5%B7%B1%E7%BC%BA%E5%B0%91%E7%9A%84%E7%8E%AF%E5%A2%83%E3%80%82">一、从官网拿到源码，然后配置自己缺少的环境。</h2> 
<p>论文: https://arxiv.org/abs/2103.14030</p> 
<p>代码: https://github.com/microsoft/Swin-Transformer</p> 
<p>注意下，<strong>这里的fused window process、还有apex等不安装也是可以跑通的。</strong>它们的安装不影响代码的运行。如果你最后对性能有很高的要求，那你再去下载，我们这里主要是学习，然后让它先跑起来。</p> 
<p><span style="color:#fe2c24;"><strong>你要最起码确保在data文件夹下、models文件夹下和最外层的所有py文件都没有依赖报错（就是导入包的报错）</strong></span></p> 
<p class="img-center"><img alt="" height="538" src="https://images2.imgbox.com/5e/30/VtRQ2cLj_o.png" width="310"></p> 
<p>就是如上图那些的一些包，你给它都下载好不报错就行了。或者你新搞个虚拟环境，然后重新装一下就行，怎么搞虚拟环境可以参考这篇文章【正在更新中...】。</p> 
<h4 id="%E9%92%88%E5%AF%B9%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E9%94%99%E8%AF%AF%EF%BC%9A">针对可能遇到的错误：</h4> 
<p><strong>注意，这个错误只是可能遇到，不是一定会遇到。它和你下载的Pytorch的版本有关系。并且你的分类数如果大于5，应该是不会报错的。</strong></p> 
<p><span style="color:#fe2c24;"><strong>那我们需要做什么呢？就是你可能需要改一下你的accuracy函数。</strong></span></p> 
<p><strong>说一下这个函数的入口在哪找，因为这个函数并不是Swin-transformer的函数，它是Pytorch内置的文件函数，所以它原本是只读的（只是有写保护，并非不可更改）。那么我们从哪里找呢？</strong></p> 
<p><span style="color:#fe2c24;"><strong>找到main.py-&gt;函数validate，有一行</strong></span></p> 
<pre><code>acc1, acc5 = accuracy(output, target, topk=(1, 5))</code></pre> 
<p><img alt="" height="918" src="https://images2.imgbox.com/ce/be/VjUFyNGO_o.png" width="1044"></p> 
<p><span style="color:#fe2c24;"><strong>鼠标点击accuracy函数，然后按ctrl B就可以了(转到定义)</strong></span></p> 
<p>然后在metrics.py(这是个只读文件)里的这个函数accuracy，它应该是这个样子的（如下图）：</p> 
<p><img alt="" height="295" src="https://images2.imgbox.com/42/f8/qJLFQwVI_o.png" width="1191"></p> 
<p>但有些小伙伴该函数的第一行是这个样子的：</p> 
<pre><code>maxk = max(topk)</code></pre> 
<p>然后就导致如果你训练过程中，如果分类数比较少（比如二分类），那它就会报类似于“索引k超出范围”这样的错误。你把它这一行给改成上面截图的那个样子就行：</p> 
<pre><code>maxk = min(max(topk), output.size()[1])  //应该是这个样子的，否则二分类会报错</code></pre> 
<p><strong>OK了家人们，现在我们环境配置就这样说完了。拿到项目和配置环境相信都是最基本的，没有什么好说的了哈。</strong></p> 
<p></p> 
<h2 id="%E4%BA%8C%E3%80%81%E6%95%B0%E6%8D%AE%E9%9B%86%E8%8E%B7%E5%8F%96%E4%B8%8E%E5%A4%84%E7%90%86"><strong>二、数据集获取与处理</strong></h2> 
<p><strong>注意，我们是要用预训练权重去跑我们自己是数据集，所以不要傻乎乎的去下载ImgNet 1K，更不要傻乎乎地去下载ImgNet 22K哈哈哈，这些都是官方在一开始训练swin transformer的时候所用到的数据集，如果我们用预训练权重来去训练自己的训练集的话，是不需要下载这些东西的了。</strong></p> 
<p><strong>我们这里，就以猫狗数据集为例来为大家说下数据集怎么整。</strong></p> 
<p>我们就以Kaggle猫狗大战数据集为例。</p> 
<h3 id="2.1%20%E6%95%B0%E6%8D%AE%E9%9B%86%E4%B8%8B%E8%BD%BD">2.1 数据集下载</h3> 
<p>传送门：<a href="https://www.kaggle.com/c/dogs-vs-cats-redux-kernels-edition/data" rel="nofollow" title="Dogs vs. Cats Redux: Kernels Edition | Kaggle​​​​​​">Dogs vs. Cats Redux: Kernels Edition | Kaggle​​​​​​</a></p> 
<p>具体怎么下载，可以参考这篇文章：【正在更新中】</p> 
<p>或者也可以用百度网盘分享的链接下载：【正在更新中】</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/01/88/ns1ydMgr_o.png" width="1200"></p> 
<p>简单来说，就是你需要先登录，同意它比赛的Rules，然后点击那个Download就可以下载了。数据集不是很大，所以直接从浏览器上下载感觉问题也不大。</p> 
<h3 id="2.2%20%E6%95%B0%E6%8D%AE%E9%9B%86%E5%A4%84%E7%90%86">2.2 数据集处理</h3> 
<p>OK，那么数据集下载完毕之后，我们要对数据集进行处理分类。</p> 
<p>那个csv表格没有用的，它是给你提交的样例。我们需要拿的是test数据集合train数据集，解压缩。</p> 
<p>我们的目标，就是把它整成这样的形式：</p> 
<p><img alt="" height="318" src="https://images2.imgbox.com/fd/3b/Ta6RDUAL_o.png" width="1012"></p> 
<p style="text-align:center;">图①</p> 
<p>简单来说，也就是<strong>把下载拿到的训练集分成训练集(train)和验证集(val)，然后猫的目录下都存猫，狗的目录下都存狗。</strong></p> 
<p>怎么整呢？我的做法是，首先新建一个文件夹，命名为dataset，然后把从网上下载的train和test的压缩包都解压到该目录下。再新建一个main.py文件用于执行划分训练集和验证集的代码。那么，解压后的文件结构就是：</p> 
<pre><code class="language-python"> |——dataset
      |——test
          |—— 0.png
          |—— 1.png
          |—— 2.png
          |——  ...
      |——train
          |——cat //这个是自己提前建好的空目录
          |——dog //这个也是提前建好的空目录
          |——cat.1.png
          |——cat.2.png
          |——cat.3.png
          |——...
          |——dog.1.png
          |——dog.2.png
          |——dog.3.png
          |——...
      |——val
          |——cat //这个是自己提前建好的空目录
          |——dog //这个也是提前建好的空目录
      |——main.py</code></pre> 
<p>然后在main.py中执行以下代码：</p> 
<pre><code class="language-python">import os
import shutil
dir_train = '.\\train'
dir_val = '.\\val'
for file in os.listdir(dir_train):
    if file.startswith('cat') and file.endswith(".jpg"):
        num = int(file.split('.')[1])
        if num &lt;= 9999:
            shutil.move(os.path.join(dir_train, file), os.path.join(dir_train, 'cat', file))
        else:
            shutil.move(os.path.join(dir_train, file), os.path.join(dir_val, 'cat', file))
    elif file.startswith('dog') and file.endswith(".jpg"):
        num = int(file.split('.')[1])
        if num &lt;= 9999:
            shutil.move(os.path.join(dir_train, file), os.path.join(dir_train, 'dog', file))
        else:
            shutil.move(os.path.join(dir_train, file), os.path.join(dir_val, 'dog', file))</code></pre> 
<p>解释下这个代码是做什么的。<strong>这个代码就是把train目录文件下的编号是0-9999的猫和狗作为训练集(就是放到train目录下)，然后把10000-12500的猫和狗放到val文件下。</strong>这样，我们在训练集，就总共有20000张图片，然后我们放了5000张图片留作验证使用。（当然你要是觉得这个比例不够好，可以自己再去调，该上面的两个9999就可以）</p> 
<p>运行这段代码后，得到的文件夹结构就是像图①所示的那样了。</p> 
<h2 id="%E4%B8%89%E3%80%81%E4%B8%8B%E8%BD%BD%E9%A2%84%E8%AE%AD%E7%BB%83%E6%9D%83%E9%87%8D">三、下载预训练权重</h2> 
<p>接下来，下载预训练配置权重。</p> 
<p>从modelhub.md文件中，下载预训练权重。下载哪个都行，<strong>当然了，有些模型需要配置额外的环境。</strong></p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/72/95/Vzi34UuY_o.png" width="1200"></p> 
<p>我们这里就以最简单的Swin-T为例，我们下载的也是Image 1K的model的预训练权重。那么，下载下来的预训练权重的名称就是<strong>swin_tiny_patch4_window7_224.pth</strong>。</p> 
<p>OK，不管哪个，下载下来，然后放到swin-Transformer的根路径中，就像这样：</p> 
<p><img alt="" height="1118" src="https://images2.imgbox.com/8c/cf/VGwvrCNh_o.png" width="1200"></p> 
<h2 id="%E5%9B%9B%E3%80%81%E4%BF%AE%E6%94%B9%E9%83%A8%E5%88%86%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE">四、修改部分参数配置</h2> 
<p>由于我们是Windows操作系统，并且按照我们上面数据集来看，我们是二分类，所以我们需要修改一些参数配置。</p> 
<h3 id="4.1%20%E4%BF%AE%E6%94%B9config.py">4.1 修改config.py</h3> 
<pre><code class="language-python">_C.DATA.DATA_PATH = 'dataset'
# Dataset name
_C.DATA.DATASET = 'imagenet'
# Model name
_C.MODEL.NAME = 'swin_tiny_patch4_window7_224'
# Checkpoint to resume, could be overwritten by command line argument
_C.MODEL.RESUME ='swin_tiny_patch4_window7_224.pth'
# Number of classes, overwritten in data preparation
_C.MODEL.NUM_CLASSES = 2
</code></pre> 
<p>上面这些参数是必然要改的。相信大家也能看懂这些参数是什么意思哈。</p> 
<p>稍微解释下这个 （了解下即可）</p> 
<pre><code>_C.DATA.DATASET = 'imagenet' </code></pre> 
<p>这个的意思，我的理解就是采用什么数据集来去训练的，它有俩选择，要么是“imagenet”，要么是"imagenet22K"，对应下面build.py的截图中的if和elsif。</p> 
<h3 id="4.2%20%E4%BF%AE%E6%94%B9build.py">4.2 修改build.py</h3> 
<p>build.py文件在data文件夹里。</p> 
<p><img alt="" height="468" src="https://images2.imgbox.com/74/fc/4bOObeao_o.png" width="773"></p> 
<p>修改这个地方：</p> 
<p><img alt="" height="850" src="https://images2.imgbox.com/bb/4f/iSWgP5ae_o.png" width="1200"></p> 
<p>把原来的1000改成上图所示，或者直接改成2都行。</p> 
<h3 id="4.3%20%E4%BF%AE%E6%94%B9units.py">4.3 修改units.py</h3> 
<p>因为我们的预训练权重中最后是对1000类别进行分类的，而我们是二分类，所以我们需要在load_checkpoint这个函数中，把输出头的类别数给修改了。具体如下：</p> 
<p><img alt="" height="528" src="https://images2.imgbox.com/96/87/Y5UQYkCB_o.png" width="1200"></p> 
<p>在上图的位置添加以下代码：</p> 
<pre><code class="language-python">    if checkpoint['model']['head.weight'].shape[0] == 1000:
        checkpoint['model']['head.weight'] = torch.nn.Parameter(
            torch.nn.init.xavier_uniform_(torch.empty(config.MODEL.NUM_CLASSES, 768))
        )
        checkpoint['model']['head.bias'] = torch.nn.Parameter(torch.randn(config.MODEL.NUM_CLASSES))</code></pre> 
<h3 id="4.4%20%E4%BF%AE%E6%94%B9main.py">4.4 修改main.py</h3> 
<p><img alt="" height="599" src="https://images2.imgbox.com/c1/26/24m2G2Ph_o.png" width="1200"></p> 
<p>将init_process_group函数修改如下：</p> 
<pre><code class="language-python">torch.distributed.init_process_group(backend='gloo', init_method='env://', world_size=1, rank=0)</code></pre> 
<p>想要在windows环境下跑通代码，那么前面的backend得换成“gloo”。然后后面的init_method我的用'env://'是可以跑通的，有的小伙伴可能跑不通，我看网上也有用‘file://tmp/somefile’的（对我来说行不通），大家如果最终是因为这行代码而导致代码跑不起来，可以专门去网上看看解决方案。反正上述代码我的是跑起来了。</p> 
<h3 id="4.5%20%E4%BF%AE%E6%94%B9%E5%85%B6%E4%BB%96%E7%9A%84%E5%9C%B0%E6%96%B9">4.5 修改其他的地方</h3> 
<p>还有些其他奇奇怪怪的情况，在这里就不一一列举，上网一查都可以查到。比如</p> 
<pre><code class="language-python">from torch._six import inf</code></pre> 
<p>已经不再用，而是直接从torch里导入，即</p> 
<pre><code class="language-python">from torch import inf</code></pre> 
<p>即可。</p> 
<p>但是这些问题不是每个人都会遇到，就比如我自己配置的时候并没有遇到这些问题，我给别人配置的时候就遇到了这些问题。大家自己如果遇到了再去查就行。</p> 
<h3 id="4.6%20%E5%B0%86%E6%9C%80%E5%90%8E%E7%BB%93%E6%9E%9C%E4%BB%A5%E6%8A%98%E7%BA%BF%E5%9B%BE%E7%9A%84%E5%BD%A2%E5%BC%8F%E5%91%88%E7%8E%B0%E5%87%BA%E6%9D%A5" style="background-color:transparent;">4.6 将最后结果以折线图的形式呈现出来</h3> 
<p>先说一下我们最后画出来的图是什么样子的。就是横坐标是迭代次数，纵坐标左边是每次Train的avg_loss(平均的loss)大小，右边是Test时每次的avg_acc@1（平均准确率）。</p> 
<p>修改五个地方。</p> 
<p>在util.py文件中修改一处：</p> 
<p><img alt="" height="652" src="https://images2.imgbox.com/d6/a8/gS1IfwBb_o.png" width="1014"></p> 
<p>也就是添加以下代码，就是新添加一个函数。</p> 
<pre><code class="language-python">from matplotlib import pyplot as plt


def plot_curve(x, y1, y2, label1, label2):
    # 创建折线图
    fig, ax1 = plt.subplots()

    # 绘制第一条折线（范围在[0,1]）
    ax1.plot(x, y1, 'b-', label=label1)
    ax1.set_xlabel('train_epoch')
    ax1.set_ylabel(label1, color='b')
    ax1.set_ylim([0, 8])
    ax2 = ax1.twinx()
    ax2.set_ylabel(label2, color='r')
    ax2.set_ylim([0, 100])
    y2 = y2[1:101]
    ax2.plot(x, y2, 'r-', label=label2)
    lines1, labels1 = ax1.get_legend_handles_labels()
    lines2, labels2 = ax2.get_legend_handles_labels()
    lines = lines1 + lines2
    labels = labels1 + labels2
    ax1.legend(lines, labels)
    plt.show()</code></pre> 
<p>然后在main.py中修改四处：</p> 
<p><strong>第一处：</strong></p> 
<p><img alt="" height="556" src="https://images2.imgbox.com/3b/3c/MfUCw6Hg_o.png" width="1200"></p> 
<p>可以在一开始的地方加上两个list用于存储每个epoch的avg_loss和avg_acc@1.</p> 
<p><strong>第二处：</strong></p> 
<p>在<strong>train_one_epoch</strong>函数的最后增加一行：</p> 
<p><img alt="" height="658" src="https://images2.imgbox.com/e5/ab/aKupgbhV_o.png" width="1200"></p> 
<pre><code class="language-python">list_train_loss.append(loss_meter.avg)</code></pre> 
<p>就是说每次训练完都把avg_loss存储进去。</p> 
<p><strong>第三处：</strong></p> 
<p>同理，在<strong>validate</strong>函数中也添加一行代码：</p> 
<p><img alt="" height="559" src="https://images2.imgbox.com/26/2d/qKnW1hA6_o.png" width="1146"></p> 
<pre><code class="language-python">list_val_acc.append(acc1_meter.avg)</code></pre> 
<p>作用和上面同理。</p> 
<p><strong>第四处：</strong></p> 
<p>在main函数的最后，加上这两行：</p> 
<p><img alt="" height="817" src="https://images2.imgbox.com/05/c5/T3cVWznP_o.png" width="1200"></p> 
<pre><code class="language-python">    num_x = range(config.TRAIN.START_EPOCH, config.TRAIN.EPOCHS)
    plot_curve(num_x, list_train_loss, list_val_acc, "train_loss", "val_acc@1")</code></pre> 
<p>它的作用是最后显示出图示来。</p> 
<p>但需要注意下哈，我在这里画出来的图，默认只能够画出来你从断点开始到最后结束的那一段。就是你checkpoint之前的是画不出来的，所以尽量一次性训练完就好。</p> 
<h2 id="%E4%BA%94%E3%80%81%E5%85%B6%E4%BB%96%E5%8F%AF%E4%BF%AE%E6%94%B9%E7%9A%84%E5%9C%B0%E6%96%B9">五、其他可修改的地方</h2> 
<p>再说说其他可以修改的地方：</p> 
<p>如果你觉得它打印的频次太多了，你可以修改参数：</p> 
<pre><code class="language-python"># Frequency to logging info
_C.PRINT_FREQ = 10</code></pre> 
<p>同样如果你觉得你训练次数过多或者过少，你可以修改参数：</p> 
<pre><code class="language-python">_C.TRAIN.EPOCHS = 100</code></pre> 
<p>如果你不想把你自身训练的每一轮模型都保存，你可以修改参数：</p> 
<pre><code class="language-python"># Frequency to save checkpoint
_C.SAVE_FREQ = 1</code></pre> 
<p>为什么修改这些参数大家可以从源码中去找哈。</p> 
<h2 id="%E5%85%AD%E3%80%81%E8%BF%90%E8%A1%8C%E4%BB%A3%E7%A0%81">六、运行代码</h2> 
<p>差不多都搞完了，我们将我们的代码跑起来：</p> 
<p>如果不想用命令行，可以点击右上角的编辑配置：</p> 
<p><img alt="" height="450" src="https://images2.imgbox.com/3a/60/eVoqrHZk_o.png" width="781"></p> 
<p>然后在参数这一栏：</p> 
<p><img alt="" height="1031" src="https://images2.imgbox.com/c2/7f/Z2QPZTFu_o.png" width="1200"></p> 
<p>添加以下参数：</p> 
<pre><code class="language-python">--cfg configs/swin/swin_tiny_patch4_window7_224.yaml  --local_rank 0  --batch-size=64 --data-path=data/dataset</code></pre> 
<p>解释下什么意思。</p> 
<blockquote> 
 <ul><li>--cfg是参数配置文件，它在configs文件夹里，你添加的这个配置的文件名需要和你的预训练权重的名字是一样的。</li><li>--local_rank设置成0就行。</li><li>--data-path后面需要添加你数据文件的路径。我就把它放到了data/dataset文件下。</li><li>--batch-size看你GPU有多大了，如果不大，可以设置成16，如果比较大，也可以设置成64、128等。</li></ul> 
</blockquote> 
<p>然后就，跑起来了。</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/39/9c/vyzRBkkm_o.png" width="1200"></p> 
<p>好啦，如果有什么问题，欢迎留言。同时，如果觉得我写的文章对你有帮助，那就点个收藏，或者赞和关注吧，我将会持续带来优质的分享。</p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/92dca3726b81cc9d59b7f7dd127e0661/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL索引优化实战二</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8d3ef03b81b1b7730d60f7ffcd7394e6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue中下载不同文件的几种方式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>