<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>一个由二级索引引发的P1惨案 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="一个由二级索引引发的P1惨案" />
<meta property="og:description" content="文章目录 前言一、业务背景二、故障出现三、故障定位&amp;&amp;止血四、事后复盘删除二级索引的动机二级索引的设计 五、故障总结开发侧：DBA侧：阿里云： 结语 前言 前不久在实习的时候搞了个P1故障，导致服务不可用将近一小时，最后排查复盘发现竟然只是一个二级索引！
一、业务背景 5000w&#43;数据，1024分表
中午12点准时推单，一般推单会持续15min-30min，该业务为核心业务，一旦受阻影响面很大。
二、故障出现 业务侧反馈中午推单卡住，一单未推（该业务为关键业务，很紧急，影响面大）。
上阿里云日志看到
Error updating database. Cause: com.mysql.cj.jdbc.exceptions.MySQLTransactionRollbackException: [15b848918060c000-2][10.0.62.142:3306][booking_center]ERR-CODE: [TDDL-4614][ERR_EXECUTE_ON_MYSQL] Error occurs when execute on GROUP &#39;BOOKING_CENTER_1617764186004XHSA_PURM_0001&#39; ATOM &#39;rm-bp17rbdzegw1600mp_booking_center_nmqq_0001&#39;: Lock wait timeout exceeded; try restarting transaction 报警出现大量锁等待超时。
同时钉钉群里有大量长事务告警。
三、故障定位&amp;&amp;止血 12:19 初步定位
看到报警内容，可以定位到是数据库长事务导致新的语句无法执行。此时确定是数据库的问题，开始联系dba解决。
由于是饭点，其他开发和dba都去吃午饭了，都匆匆赶回公司。
12:38 dba到场
看到故障的第一反应是kill掉所有的长事务，但是尝试kill发现并不能成功kill。
回顾最近的修改，只有昨天五点左右删除了相关表的一个二级索引。我们推测和这个有关，所以建议执行增加二级索引的DDL操作。
12:43 执行后发现该索引一直在pending，没有执行，猜测是长事务霸占了行锁。开始联系阿里云技术人员支持。
此时所有update都被阻塞。
我们找到了产生长事务的sql
&lt;!-- 经过脱敏的代码 --&gt; &lt;update id=&#34;***&#34;&gt; &lt;foreach collection=&#34;***&#34; item=&#34;i&#34; open=&#34;&#34; close=&#34;&#34; index=&#34;index&#34; separator=&#34;;&#34;&gt; update bh_order_line &lt;set&gt; &lt;if test=&#34;i.a!=null&#34;&gt; a=#{i.a}, &lt;/if&gt; &lt;if test=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/1cb5e2f77865d2965569fd1f00f2b74a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-25T09:15:36+08:00" />
<meta property="article:modified_time" content="2023-02-25T09:15:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">一个由二级索引引发的P1惨案</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#_3" rel="nofollow">一、业务背景</a></li><li><a href="#_9" rel="nofollow">二、故障出现</a></li><li><a href="#_27" rel="nofollow">三、故障定位&amp;&amp;止血</a></li><li><a href="#_98" rel="nofollow">四、事后复盘</a></li><li><ul><li><a href="#_99" rel="nofollow">删除二级索引的动机</a></li><li><a href="#_102" rel="nofollow">二级索引的设计</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_122" rel="nofollow">五、故障总结</a></li><li><ul><li><ul><li><a href="#_124" rel="nofollow">开发侧：</a></li><li><a href="#DBA_138" rel="nofollow">DBA侧：</a></li><li><a href="#_144" rel="nofollow">阿里云：</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_152" rel="nofollow">结语</a></li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>前言</h3> 
<p>前不久在实习的时候搞了个P1故障，导致服务不可用将近一小时，最后排查复盘发现竟然只是一个二级索引！</p> 
<h3><a id="_3"></a>一、业务背景</h3> 
<p>5000w+数据，1024分表</p> 
<p>中午12点准时推单，一般推单会持续15min-30min，该业务为核心业务，一旦受阻影响面很大。</p> 
<h3><a id="_9"></a>二、故障出现</h3> 
<p>业务侧反馈中午推单卡住，一单未推（该业务为关键业务，很紧急，影响面大）。</p> 
<p>上阿里云日志看到</p> 
<pre><code class="prism language-sql"> Error updating <span class="token keyword">database</span><span class="token punctuation">.</span> 
 Cause: com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>MySQLTransactionRollbackException: <span class="token punctuation">[</span><span class="token number">15</span>b848918060c000<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10.0</span><span class="token number">.62</span><span class="token number">.142</span>:<span class="token number">3306</span><span class="token punctuation">]</span><span class="token punctuation">[</span>booking_center<span class="token punctuation">]</span>ERR<span class="token operator">-</span>CODE: <span class="token punctuation">[</span>TDDL<span class="token operator">-</span><span class="token number">4614</span><span class="token punctuation">]</span><span class="token punctuation">[</span>ERR_EXECUTE_ON_MYSQL<span class="token punctuation">]</span> 
 Error occurs <span class="token keyword">when</span> <span class="token keyword">execute</span> <span class="token keyword">on</span> <span class="token keyword">GROUP</span> <span class="token string">'BOOKING_CENTER_1617764186004XHSA_PURM_0001'</span> ATOM <span class="token string">'rm-bp17rbdzegw1600mp_booking_center_nmqq_0001'</span>: <span class="token keyword">Lock</span> wait timeout exceeded<span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span>
</code></pre> 
<p>报警出现<strong>大量锁等待超时</strong>。</p> 
<p>同时钉钉群里有<strong>大量长事务告警</strong>。</p> 
<h3><a id="_27"></a>三、故障定位&amp;&amp;止血</h3> 
<p>12:19 初步定位</p> 
<p>看到报警内容，可以定位到是数据库长事务导致新的语句无法执行。此时确定是数据库的问题，开始联系dba解决。</p> 
<p>由于是饭点，其他开发和dba都去吃午饭了，都匆匆赶回公司。</p> 
<p>12:38 dba到场</p> 
<p>看到故障的第一反应是kill掉所有的长事务，但是尝试kill发现并不能成功kill。</p> 
<p>回顾最近的修改，只有昨天五点左右删除了相关表的一个二级索引。我们推测和这个有关，所以建议执行增加二级索引的DDL操作。</p> 
<p>12:43 执行后发现该索引一直在pending，没有执行，猜测是长事务霸占了行锁。开始联系阿里云技术人员支持。</p> 
<p>此时所有update都被阻塞。</p> 
<p>我们找到了产生长事务的sql</p> 
<pre><code class="prism language-sql"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token comment">-- 经过脱敏的代码 --&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">update</span> id<span class="token operator">=</span><span class="token string">"***"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>foreach collection<span class="token operator">=</span><span class="token string">"***"</span> item<span class="token operator">=</span><span class="token string">"i"</span> <span class="token keyword">open</span><span class="token operator">=</span><span class="token string">""</span> <span class="token keyword">close</span><span class="token operator">=</span><span class="token string">""</span> <span class="token keyword">index</span><span class="token operator">=</span><span class="token string">"index"</span> separator<span class="token operator">=</span><span class="token string">";"</span><span class="token operator">&gt;</span>
            <span class="token keyword">update</span> bh_order_line
            <span class="token operator">&lt;</span><span class="token keyword">set</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">"i.a!=null"</span><span class="token operator">&gt;</span>
                    a<span class="token operator">=</span><span class="token comment">#{i.a},</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">"i.b!=null"</span><span class="token operator">&gt;</span>
                    b<span class="token operator">=</span><span class="token comment">#{i.replaceProductInfo,typeHandler=...},</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">"i.c!=null"</span><span class="token operator">&gt;</span>
                    c<span class="token operator">=</span><span class="token comment">#{i.c}</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">set</span><span class="token operator">&gt;</span>
            <span class="token keyword">where</span> id <span class="token operator">=</span><span class="token comment">#{i.id}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>foreach<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">update</span><span class="token operator">&gt;</span>
</code></pre> 
<p>这时开始分析，意识到该sql用了id进行定位，而分区键是order_id。在没有二级索引的情况下，每一条update都会下发请求到所有分表，而该事务有多个update（几十个），从而导致长事务的发生，而之前推单为了快速完成，所以这个量是非常大的，进而导致拖垮整个库。</p> 
<p>这时基本确认是二级索引删了的缘故。</p> 
<p>此时也考虑了其他方案，比如改代码，增加查询条件，从而命中分区键，但发现代码没有做防腐层，改起来很难，复杂度高，在没有测试的情况下容易出大问题，于是否定了这个方案。</p> 
<p>12:50 阿里云技术人员定位并给出了kill语句尝试kill，执行没效果。</p> 
<p>在kill不掉长事务的情况下，打算重启，但阿里云并没有针对单个私有rds重启的按钮，只能重启整个drds。而该drds上涉及很多其他的业务，影响面太大了。</p> 
<hr> 
<p>考虑到该故障极大可能短时间内无法有效恢复，开始考虑人工止损，由于查询导出走的是订单中心（ES），所以导出功能正常，此时由文员人工导出并审单分配。</p> 
<hr> 
<p>13:00 阿里云技术人员决定重启cn节点，此时评估影响，阿里云技术人员说明可能会出现闪断，大约 3min 左右。</p> 
<p>考虑到重启是为了停止所有长事务，让增加索引的操作顺利执行，而此时服务还在源源不断发送update产生新的长事务。所以此时需要先关闭服务。</p> 
<p>13:04 等待业务方完成导出后关闭（因为需要人工推单来兜底止损）</p> 
<p>13:31 停掉我们的服务，重启drds</p> 
<p>增加二级索引的DDL操作开始执行，发现进展缓慢，预计要1-2小时。</p> 
<p>13:58 我们觉得实在太慢了，询问有没有加速的方法，阿里云技术人员提供了新的方法，并由他们来操作，发现速度快了很多。（改了参数）</p> 
<p>14:24 二级索引添加成功，重启我们自己的服务，服务恢复正常</p> 
<h3><a id="_98"></a>四、事后复盘</h3> 
<h4><a id="_99"></a>删除二级索引的动机</h4> 
<p>当初删除二级索引是为了避免触发阿里云一个已知的bug</p> 
<h4><a id="_102"></a>二级索引的设计</h4> 
<p>原先二级索引的设计确实是有问题的</p> 
<p><img src="https://images2.imgbox.com/30/23/naF3hRcJ_o.png" alt=""></p> 
<p>这也是为什么当时阿里云技术人员都认为该索引是无用的。</p> 
<p>如果要选择gsi二级索引去优化 用id查询无法命中分区键的问题，那么正确的建立gsi语句应该是</p> 
<pre><code class="prism language-sql"><span class="token keyword">GLOBAL</span> <span class="token keyword">INDEX</span> <span class="token identifier"><span class="token punctuation">`</span>idx_gsi_id<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> COVERING <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> DBPARTITION <span class="token keyword">BY</span> <span class="token keyword">HASH</span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
</code></pre> 
<p>至于为什么原先那个二级索引能起到部分作用，原因在于，虽然之前的二级索引也是全表扫描，但是扫描的表不同，它扫描的是索引表，索引表只有8个，而对于主库的表有1024个，扫描索引表花费的时间更少，即使还要回表，但此次回表并不需要去下发请求到每个主表当中。</p> 
<p>不过根本原因还是评估不到位，并没有考虑到二级索引删除可能带来的影响。</p> 
<h2><a id="_122"></a>五、故障总结</h2> 
<h4><a id="_124"></a>开发侧：</h4> 
<p><strong>1.历史背景设计不合理性与阿里云版本的bug导致</strong></p> 
<p><strong>因 bh_order_line 表中</strong>GSI索引 都需要根据 查询字段id -&gt;与order_Id 做一层映射关系,不然无法找到order_Id 对应的分库,</p> 
<p>就会全局查询,出现<strong>异常告警或长事务慢SQL</strong>,如果<strong>GSI</strong>索引有映射关系,但是所有查询都要查询二级索引表然后回主表查询,会出现之前告警出现的异常</p> 
<p><strong>合理设计</strong></p> 
<p><strong>GSI索引 建id-&gt;与表中热点key建立(除去order_Id)这个字段,代码SQL查询时候带上分库主键order_Id进行查询</strong></p> 
<p><strong>2.代码层是否健壮（能否做到熔断,降级,快速修改代码进行止血等能力）</strong></p> 
<h4><a id="DBA_138"></a>DBA侧：</h4> 
<p>1.线上删索引操作应该落实工单审批流程。</p> 
<p>2.drds1.0库，增加应对突发的数据库请求流量、资源消耗过高的语句，进行限流熔断的机制；</p> 
<h4><a id="_144"></a>阿里云：</h4> 
<p>1.线上当前版本bug触发业务偶发报错，同时gsi索引存在回表也会触发bug；</p> 
<p>2.线上当前版本bug，导致kill 'all’操作不起作用，升级版本后才能解决；</p> 
<p>3.ddl加了限速，导致ddl操作十分漫长，影响恢复进度；</p> 
<h2><a id="_152"></a>结语</h2> 
<p>作为实习生第一次搞出这么大的故障，还是蛮惭愧的，而原因竟然只是因为一个二级索引！<br> 还好有DBA、Leader和mentor的支援，不然就我一个肯定GG。<br> 第一次经历故障的止血和恢复，说实话学到了很多很多，在复盘阶段，也学了很多sql优化的相关知识，团队也开始着手处理之前一直出现的慢SQL问题。<br> 多亏了Leader和mentor，不然没有线上处理故障经验的我直接GG。<br> 这次故障也为我敲响警钟，对待问题需要小心再小心，尤其是线上问题，<strong>对待线上，要有敬畏之心！</strong><br> 同时自身也要去<strong>深入学习自己使用到技术和工具</strong>，只有掌握底层原理，才能在做技术方案时更加全面的考虑到各种情况的可能。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6539d884f6d8bd5dc1b875d17f63dc30/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">excel核对技巧：这么多数据对比的方法应该够用了</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a376a18b17320f7b949055aad957cee7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C语言 格式化占位符的语法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>