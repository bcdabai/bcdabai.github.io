<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32之音乐播放器 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32之音乐播放器" />
<meta property="og:description" content="STM32之音乐播放器 1.硬件平台 CPU：STM32F103ZE 屏幕：3.5寸TFTLCD屏 音频解码器： VS1053 SD卡、外扩Sram 2.示例效果 3.软件设计 VS1053b 是单片 Ogg Vorbis/MP3/AAC/WMA/MIDI 音频解码器，及 IMA ADPCM 编码器和用户加载的 OggVorbis 编码器。
支持： MP3/WMA/OGG/WAV/FLAC/MIDI/AAC 等音频格式的解码，并支持： OGG/WAV 音频格式的录音，支持高低音调节设置， 功能十分强大。
它包含了一个高性能、有专利的低功耗 DSP 处理器内核VS_DSP4、工作数据存储器、供用户应用程序和任何固化解码器一起运行的 16 KiB 指令 RAM 及 0.5KiB 多的数据 RAM、串行的控制和输入数据接口、最多 8 个可用的通用 I/O 引脚、一个 UART、并有一个优质的可变采样率立体声 ADC（“咪”、“线路”、“线路&#43;咪”或“线路*2”） 和立体声 DAC、和跟随的一个耳机功放及一个公共电压缓冲器。
3.1 硬件接口 引脚GPIO说明VS_MISOPA6主机输入VS_MOSIPA7主机输出VS_SCKPA5时钟VS_XCSPF7命令片选(低电平有效)VS_XDCSPF6数据片选（低电平有效）VS_DREQPC13数据请求线（高电平表示可以接收数据）VS_RSTPE6复位脚(低电平复位) 3.2 VS1053驱动 /**************硬件接口***************** **VS_MISO -- PA6 主机输入 **VS_MOSI -- PA7 主机输出 **VS_SCK -- PA5 时钟 **VS_XCS -- PF7 命令片选(低电平有效) **VS_XDCS -- PF6 数据片选（低电平有效） **VS_DREQ -- PC13 数据请求线（高电平表示可以接收数据） **VS_RST -- PE6 复位脚(低电平复位) ** *****************************************/ void VS1053_Init(void) { /*1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c1a141a43b41d1dd8a615f5aaca74a4b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-12T20:46:00+08:00" />
<meta property="article:modified_time" content="2022-04-12T20:46:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32之音乐播放器</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="STM32_0"></a>STM32之音乐播放器</h2> 
<h3><a id="1_1"></a>1.硬件平台</h3> 
<blockquote> 
 <ul><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled> <strong>CPU：</strong><font color="#ff0000" size="4">STM32F103ZE</font></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled> <strong>屏幕：</strong><font color="#ff0000" size="4">3.5寸TFTLCD屏</font></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled> <strong>音频解码器：</strong> <font color="#ff0000" size="4">VS1053</font></li><li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled> <strong><font size="4">SD卡、外扩Sram</font></strong></li></ul> 
</blockquote> 
<h3><a id="2_7"></a>2.示例效果</h3> 
<p><img src="https://images2.imgbox.com/0d/d4/Up5Vmm3V_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/82/1c/50wVgolb_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_11"></a>3.软件设计</h3> 
<blockquote> 
 <p>  VS1053b 是单片 Ogg Vorbis/MP3/AAC/WMA/MIDI 音频解码器，及 IMA ADPCM 编码器和用户加载的 OggVorbis 编码器。<br>   支持： MP3/WMA/OGG/WAV/FLAC/MIDI/AAC 等音频格式的解码，并支持： OGG/WAV 音频格式的录音，支持高低音调节设置， 功能十分强大。<br>   它包含了一个高性能、有专利的低功耗 DSP 处理器内核VS_DSP4、工作数据存储器、供用户应用程序和任何固化解码器一起运行的 16 KiB 指令 RAM 及 0.5KiB 多的数据 RAM、串行的控制和输入数据接口、最多 8 个可用的通用 I/O 引脚、一个 UART、并有一个优质的可变采样率立体声 ADC（“咪”、“线路”、“线路+咪”或“线路*2”） 和立体声 DAC、和跟随的一个耳机功放及一个公共电压缓冲器。</p> 
</blockquote> 
<h4><a id="31__16"></a>3.1 硬件接口</h4> 
<p><img src="https://images2.imgbox.com/83/db/Udyb7iMD_o.png" alt="在这里插入图片描述"></p> 
<table><thead><tr><th>引脚</th><th>GPIO</th><th>说明</th></tr></thead><tbody><tr><td>VS_MISO</td><td>PA6</td><td>主机输入</td></tr><tr><td>VS_MOSI</td><td>PA7</td><td>主机输出</td></tr><tr><td>VS_SCK</td><td>PA5</td><td>时钟</td></tr><tr><td>VS_XCS</td><td>PF7</td><td>命令片选(低电平有效)</td></tr><tr><td>VS_XDCS</td><td>PF6</td><td>数据片选（低电平有效）</td></tr><tr><td>VS_DREQ</td><td>PC13</td><td>数据请求线（高电平表示可以接收数据）</td></tr><tr><td>VS_RST</td><td>PE6</td><td>复位脚(低电平复位)</td></tr></tbody></table> 
<h4><a id="32_VS1053_27"></a>3.2 VS1053驱动</h4> 
<pre><code class="prism language-c"><span class="token comment">/**************硬件接口*****************
**VS_MISO -- PA6 主机输入
**VS_MOSI -- PA7 主机输出
**VS_SCK  -- PA5 时钟
**VS_XCS  -- PF7 命令片选(低电平有效)
**VS_XDCS -- PF6 数据片选（低电平有效）
**VS_DREQ -- PC13 数据请求线（高电平表示可以接收数据）
**VS_RST  -- PE6 复位脚(低电平复位)
**
*****************************************/</span>

<span class="token keyword">void</span> <span class="token function">VS1053_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/*1. 开时钟*/</span>
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//PA</span>
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">//PC</span>
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span><span class="token comment">//PE</span>
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">;</span><span class="token comment">//PF</span>
	GPIOA<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;=</span><span class="token number">0x000FFFFF</span><span class="token punctuation">;</span>
	GPIOA<span class="token operator">-&gt;</span>CRL<span class="token operator">|=</span><span class="token number">0x38300000</span><span class="token punctuation">;</span>
	
	GPIOF<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;=</span><span class="token number">0x00FFFFFF</span><span class="token punctuation">;</span>
	GPIOF<span class="token operator">-&gt;</span>CRL<span class="token operator">|=</span><span class="token number">0x33000000</span><span class="token punctuation">;</span>
	
	GPIOC<span class="token operator">-&gt;</span>CRH<span class="token operator">&amp;=</span><span class="token number">0xFF0FFFFF</span><span class="token punctuation">;</span>
	GPIOC<span class="token operator">-&gt;</span>CRH<span class="token operator">|=</span><span class="token number">0x00800000</span><span class="token punctuation">;</span>
	
	GPIOE<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;=</span><span class="token number">0xF0FFFFFF</span><span class="token punctuation">;</span>
	GPIOE<span class="token operator">-&gt;</span>CRL<span class="token operator">|=</span><span class="token number">0x03000000</span><span class="token punctuation">;</span>
	VS_XCS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	VS_XDCS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">VS1053_RST</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">VS1053_SetVoice</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*2.配置时钟寄存器*/</span>
	<span class="token function">VS1053_WriteRegDat</span><span class="token punctuation">(</span>VS1053_CLOCKF<span class="token punctuation">,</span><span class="token number">0x9800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*SPI收发一个字节*/</span>
u8 <span class="token function">VS1053_SPI_ReadWriteData</span><span class="token punctuation">(</span>u8 data_tx<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 data_rx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		VS_SCK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>data_tx<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span>VS_MOSI<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> VS_MOSI<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		VS_SCK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		data_tx<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
		
		data_rx<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>VS_MISO<span class="token punctuation">)</span>data_rx<span class="token operator">|=</span><span class="token number">0x01</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> data_rx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/********************往寄存器中写入数据******************
**
**形参：u8 addr --地址
**			u16 data  -- 写入的数据
**********************************************************/</span>
<span class="token keyword">void</span> <span class="token function">VS1053_WriteRegDat</span><span class="token punctuation">(</span>u8 addr<span class="token punctuation">,</span>u16 data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>VS_DREQ<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token comment">//等待数据线空闲</span>
	VS_XDCS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//数据片选拉高</span>
	VS_XCS<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//命令片选拉低</span>
	<span class="token function">VS1053_SPI_ReadWriteData</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写指令</span>
	<span class="token function">VS1053_SPI_ReadWriteData</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//寄存器地址</span>
	<span class="token function">VS1053_SPI_ReadWriteData</span><span class="token punctuation">(</span>data<span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">VS1053_SPI_ReadWriteData</span><span class="token punctuation">(</span>data<span class="token operator">&gt;&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写入数据</span>
	VS_XCS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*******************从寄存器中读取数据*******************/</span>
u16 <span class="token function">VS1053_ReadRegDat</span><span class="token punctuation">(</span>u8 addr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u16 data<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>VS_DREQ<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token comment">//等待数据线空闲</span>
	VS_XDCS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//数据片选拉高</span>
	VS_XCS<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//命令片选拉低</span>
	<span class="token function">VS1053_SPI_ReadWriteData</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读指令</span>
	<span class="token function">VS1053_SPI_ReadWriteData</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//寄存器地址</span>
	data<span class="token operator">=</span><span class="token function">VS1053_SPI_ReadWriteData</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>
	data<span class="token operator">|=</span><span class="token function">VS1053_SPI_ReadWriteData</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	VS_XCS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/****************音量调节*****************
**
**形参：u8 vol_l -- 左声道 0~254
**      u8 vol_r -- 右声道 0~254
**每个增量表示0.5db的衰减，值越大，音量越小
**注意：如果设置 VOL 的值为 0xFFFF，将使芯片进入掉电模式。
**右声道是高 8 位 左声道是低 8 位
*******************************************/</span>
<span class="token keyword">void</span> <span class="token function">VS1053_SetVoice</span><span class="token punctuation">(</span>u8 vol_l<span class="token punctuation">,</span>u8 vol_r<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u16 temp<span class="token operator">=</span>vol_r<span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token operator">|</span>vol_l<span class="token punctuation">;</span>
	<span class="token function">VS1053_WriteRegDat</span><span class="token punctuation">(</span>VS1053_VOL<span class="token punctuation">,</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/***************VS1053硬件复位**************/</span>
<span class="token keyword">void</span> <span class="token function">VS1053_RST</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//硬件复位</span>
	VS_RST<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">Delay_Ms</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	VS_XDCS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//取消数据传输</span>
	VS_XCS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//取消命令传输</span>
	VS_RST<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//完成复位</span>
	<span class="token comment">//软件复位</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>VS_DREQ<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token comment">//等待数据线空闲</span>
	<span class="token function">VS1053_WriteRegDat</span><span class="token punctuation">(</span>VS1053_MODE<span class="token punctuation">,</span><span class="token number">0x0804</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置为新模式,进行软件复位</span>
	<span class="token function">Delay_Ms</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token keyword">while</span><span class="token punctuation">(</span>VS_DREQ<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token comment">//等待数据线空闲,复位完成</span>
<span class="token punctuation">}</span>
<span class="token comment">/****获取解码时间******/</span>
u16 <span class="token function">VS1053_Get_Time</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u16 time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	time<span class="token operator">=</span><span class="token function">VS1053_ReadRegDat</span><span class="token punctuation">(</span>VS1053_DECODE_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> time<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/****清除解码时间******/</span>
<span class="token keyword">void</span> <span class="token function">VS1053_Clear_Time</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">VS1053_WriteRegDat</span><span class="token punctuation">(</span>VS1053_DECODE_TIME<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="33__154"></a>3.3 播放音乐，歌词同步，音乐切换</h4> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> music_lrc<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//存放从文件中读取出来的歌词</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> music_lrc_str<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//存放筛选过后的歌词</span>
<span class="token keyword">static</span> u16 music_time<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//保存每句歌词时间</span>
u8 buff_music<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">/**************播放音乐****************************/</span>
u8 <span class="token function">VS1053_PlayOneMusic</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>music_file<span class="token punctuation">,</span>u8 display_lrc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u16 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>time1<span class="token punctuation">,</span>time2<span class="token punctuation">;</span>
	u32 k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u16 y<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">;</span>
   u8 vol_l<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>vol_r<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">;</span>
	FIL fp<span class="token punctuation">;</span>
	FRESULT res<span class="token punctuation">;</span>
	UINT br<span class="token punctuation">;</span>
	u8 key<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	res<span class="token operator">=</span><span class="token function">f_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token punctuation">,</span>music_file<span class="token punctuation">,</span>FA_READ<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//只读</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">!=</span>FR_OK<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//printf("%s文件打开失败err:%d\r\n",music_file,res);</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
   <span class="token comment">//printf("VS1053复位成功\r\n");</span>
	<span class="token function">LCD_ShowStr2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>music_file<span class="token punctuation">,</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//显示歌名</span>
   <span class="token function">LCD_Refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新显示</span>
	<span class="token function">VS1053_Clear_Time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清除解码时间</span>
   	<span class="token comment">/*3.设置音量*/</span>
	<span class="token function">VS1053_SetVoice</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">f_eof</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//判断是否到文件尾</span>
	<span class="token punctuation">{<!-- --></span>
		key<span class="token operator">=</span><span class="token function">Key_Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//切换下一首</span>
		<span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment">//声音加</span>
      <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>vol_l<span class="token operator">&lt;</span><span class="token number">250</span><span class="token punctuation">)</span>
         <span class="token punctuation">{<!-- --></span>
            vol_l<span class="token operator">+=</span><span class="token number">50</span><span class="token punctuation">;</span>
            vol_r<span class="token operator">+=</span><span class="token number">50</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token function">VS1053_SetVoice</span><span class="token punctuation">(</span>vol_l<span class="token punctuation">,</span>vol_r<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">//声音减</span>
      <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>vol_l<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
         <span class="token punctuation">{<!-- --></span>
            vol_l<span class="token operator">-=</span><span class="token number">50</span><span class="token punctuation">;</span>
            vol_r<span class="token operator">-=</span><span class="token number">50</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token function">VS1053_SetVoice</span><span class="token punctuation">(</span>vol_l<span class="token punctuation">,</span>vol_r<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">f_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token punctuation">,</span>buff_music<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buff_music<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>br<span class="token punctuation">)</span><span class="token operator">!=</span>FR_OK<span class="token punctuation">)</span><span class="token comment">//读取音频数据</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//printf("读取文件失败");</span>
			<span class="token function">f_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
<span class="token comment">//		printf("读取数据成功\r\n");</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>br<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">while</span><span class="token punctuation">(</span>VS_DREQ<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token comment">//等待数据线空闲</span>
			VS_XDCS<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//片选拉低，开始发送音乐数据</span>
			<span class="token function">VS1053_SPI_ReadWriteData</span><span class="token punctuation">(</span>buff_music<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			VS_XDCS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		time1<span class="token operator">=</span><span class="token function">VS1053_Get_Time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取解码时间</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>time1<span class="token operator">!=</span>time2<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			time2<span class="token operator">=</span>time1<span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>display_lrc<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//是否显示歌词</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>time2<span class="token operator">&gt;=</span>music_time<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">//通过时间判断显示对应歌词</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>y<span class="token operator">&gt;=</span><span class="token punctuation">(</span>LCD_HIGHT<span class="token operator">-</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//换页显示歌词</span>
					<span class="token punctuation">{<!-- --></span>
						y<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">;</span>
						<span class="token function">LCD_ReflashBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//重画背景					</span>
						<span class="token function">LCD_ShowStr2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>music_file<span class="token punctuation">,</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//显示歌名</span>
					<span class="token punctuation">}</span>
               <span class="token function">LCD_ShowStr2</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>music_lrc_str<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span>WHITE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//显示当前行</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">&gt;=</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> y<span class="token operator">&gt;=</span><span class="token number">48</span><span class="token punctuation">)</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token function">LCD_ShowStr2</span><span class="token punctuation">(</span>y<span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>music_lrc_str<span class="token punctuation">[</span>k<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将上一行清为底色</span>
					<span class="token punctuation">}</span>
               <span class="token function">LCD_Refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新显示</span>
               y<span class="token operator">+=</span><span class="token number">16</span><span class="token punctuation">;</span>
               k<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>	
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="34__251"></a>3.4 歌词解析</h4> 
<pre><code class="prism language-c"><span class="token comment">/********************歌词解析******************/</span>
u8 <span class="token function">Vs1053_GetLrc_Music</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>musiclrc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	FIL fil<span class="token punctuation">;</span>
	FRESULT res<span class="token punctuation">;</span>
	UINT br<span class="token punctuation">;</span>
	FILINFO fno<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	u32 time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//记录每句歌词的播放起始时间</span>
	<span class="token comment">/*1.打开文件*/</span>
	res<span class="token operator">=</span><span class="token function">f_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fil<span class="token punctuation">,</span>musiclrc<span class="token punctuation">,</span>FA_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">!=</span>FR_OK<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s文件打开失败\r\n"</span><span class="token punctuation">,</span>musiclrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>music_lrc<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>music_lrc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>music_lrc_str<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>music_lrc_str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*2.读取歌词*/</span>
	res<span class="token operator">=</span><span class="token function">f_stat</span> <span class="token punctuation">(</span>musiclrc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fno<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取文件状态</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">!=</span>FR_OK<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"文件状态获取失败\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//printf("size=%d\r\n",fno.fsize);	</span>
	res<span class="token operator">=</span><span class="token function">f_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fil<span class="token punctuation">,</span>music_lrc<span class="token punctuation">,</span>fno<span class="token punctuation">.</span>fsize<span class="token punctuation">,</span><span class="token operator">&amp;</span>br<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取歌词</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">!=</span>FR_OK <span class="token operator">||</span> br<span class="token operator">!=</span>fno<span class="token punctuation">.</span>fsize<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"读取文件失败\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	
	<span class="token comment">/*歌词解析*/</span>
	j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	p<span class="token operator">=</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>music_lrc<span class="token punctuation">,</span><span class="token string">"[0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//找到歌词的起始位置</span>
	p<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token char">'\0'</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		buff<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		j<span class="token operator">++</span><span class="token punctuation">;</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">']'</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//[00:00.65]李荣浩 - 年少有为</span>
			time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>buff<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">&gt;=</span><span class="token number">7</span><span class="token punctuation">)</span>time<span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//最后两位时间大于5，总秒数+1</span>
			time<span class="token operator">+=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token char">'0'</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token operator">+</span><span class="token punctuation">(</span>buff<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">+</span><span class="token punctuation">(</span>buff<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token char">'0'</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token operator">+</span><span class="token punctuation">(</span>buff<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//歌词起始秒数</span>
			j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			music_time<span class="token punctuation">[</span>cnt<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>time<span class="token punctuation">;</span>
<span class="token comment">//			printf("time:%d\r\n",music_time[cnt]);</span>
			<span class="token comment">/*获取歌词*/</span>
			i<span class="token operator">++</span><span class="token punctuation">;</span>
         <span class="token comment">//[00:00.65]李荣浩 - 年少有为</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token char">'['</span><span class="token punctuation">)</span><span class="token comment">//保存一句歌词</span>
			<span class="token punctuation">{<!-- --></span>	
				music_lrc_str<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>p<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">'\0'</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
         music_lrc_str<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token char">'\0'</span><span class="token punctuation">;</span><span class="token comment">//保存一行歌词</span>
			i<span class="token operator">++</span><span class="token punctuation">;</span>
         k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
         count<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//记录第几行</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>music_lrc<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>music_lrc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   k<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">25</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
      <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>music_lrc<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>music_lrc_str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">LCD_ShowStr2</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span>music_lrc<span class="token punctuation">,</span>GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//显示一屏幕歌词</span>
      k<span class="token operator">+=</span><span class="token number">16</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token function">LCD_Refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新显示</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="35__332"></a>3.5 读取音乐文件，查找歌词，播放音乐</h4> 
<pre><code class="prism language-c"><span class="token comment">/***********音乐播放***************/</span>
u8 <span class="token function">Vs1053_play_Music</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>music_file<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 stat<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	DIR dp<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
	FILINFO fno<span class="token punctuation">;</span>
	FRESULT res<span class="token punctuation">;</span>
	<span class="token keyword">char</span> buff1<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> buff2<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	res<span class="token operator">=</span><span class="token function">f_opendir</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dp<span class="token punctuation">,</span>music_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">!=</span>FR_OK<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"目录打开失败err:%d\r\n"</span><span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"目录打卡成功\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		res<span class="token operator">=</span><span class="token function">f_readdir</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dp<span class="token punctuation">,</span><span class="token operator">&amp;</span>fno<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token operator">!=</span>FR_OK <span class="token operator">||</span> fno<span class="token punctuation">.</span>fname<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
<span class="token comment">//		printf("%s\r\n",fno.fname);</span>
		p<span class="token operator">=</span><span class="token function">strstr</span><span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fname<span class="token punctuation">,</span><span class="token string">".mp3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//查找文件中的音频文件</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token comment">//G.E.M. 邓紫棋 - 我的秘密</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				buff1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>fno<span class="token punctuation">.</span>fname<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fname<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fname<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">'m'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>  <span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fname<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">'p'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>  <span class="token punctuation">(</span>fno<span class="token punctuation">.</span>fname<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">'3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>
				i<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			buff1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token char">'\0'</span><span class="token punctuation">;</span>
			<span class="token comment">//显示歌名</span>
			<span class="token function">LCD_ReflashBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//重画背景</span>
         <span class="token function">LCD_Refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新显示</span>
			<span class="token comment">//printf("歌名:%s\r\n",buff1);</span>
			<span class="token function">snprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buff2<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buff2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"%s/%s.lrc"</span><span class="token punctuation">,</span>music_file<span class="token punctuation">,</span>buff1<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//printf("buff2:%s\r\n",buff2);</span>
			stat<span class="token operator">=</span><span class="token function">Vs1053_GetLrc_Music</span><span class="token punctuation">(</span>buff2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//歌词解析</span>
			<span class="token comment">//if(stat==0)printf("获取歌词成功\r\n");</span>
			<span class="token function">snprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buff2<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buff2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"%s/%s.mp3"</span><span class="token punctuation">,</span>music_file<span class="token punctuation">,</span>buff1<span class="token punctuation">)</span><span class="token punctuation">;</span>
			stat<span class="token operator">=</span><span class="token function">VS1053_PlayOneMusic</span><span class="token punctuation">(</span>buff2<span class="token punctuation">,</span><span class="token operator">!</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//播放音乐</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>stat<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"音乐播放完成\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"stat=%d\r\n"</span><span class="token punctuation">,</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">f_closedir</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="36_LCDSD_398"></a>3.6 主函数：LCD初始化、SD卡挂载</h4> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   FRESULT ret<span class="token punctuation">;</span>
   FATFS fs<span class="token punctuation">;</span>
	<span class="token function">Beep_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Led_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Key_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Usartx_Init</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span><span class="token number">115200</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">TIMx_Init</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">W25Q64_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//W25Q64初始化</span>
	<span class="token function">IIC_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//IIC初始化</span>
	<span class="token function">NT35310_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//LCD初始化</span>
	<span class="token function">SRAM_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AA<span class="token operator">:</span>
   <span class="token comment">/*挂载磁盘*/</span>
   ret<span class="token operator">=</span><span class="token function">f_mount</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fs<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span>FR_OK<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"磁盘挂载成功\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> 
   <span class="token punctuation">{<!-- --></span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"请检查SD卡是否插入!!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">Delay_Ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> AA<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token function">VS1053_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">Vs1053_play_Music</span><span class="token punctuation">(</span><span class="token string">"0:/music"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="4_433"></a>4.工程示例</h3> 
<p>工程示例：https://download.csdn.net/download/weixin_44453694/85117817</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/93099274a217d787d1c3e1f6ba4020dc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android判断当前网络能否上网</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4c8d6dad6794c01f8b030afbab90e90d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【文献阅读笔记】之基于注意力机制的深度学习路面裂缝检测</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>