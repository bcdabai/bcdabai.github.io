<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql集群搭建_MySQL Shell 副本集 和 MGR 快速搭建 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql集群搭建_MySQL Shell 副本集 和 MGR 快速搭建" />
<meta property="og:description" content="原文链接：MySQL Shell 副本集 和 MGR 快速搭建 本文为原创文章，如有转载请标明出处。
简介 MySQL Shell是MySQL Server的高级客户端和代码编辑器。除了和mysql命令行客户端程序一样，使用常规的SQL功能外，MySQL Shell还提供了JavaScript和Python的脚本功能，并包含多个API，其中的AdminAPI用于操作InnoDB Cluster。
安装部署 下载：https://dev.mysql.com/downloads/shell/
安装
#tar -zxvf mysql-shell-8.0.20-linux-glibc2.12-x86-64bit.tar.gz -C /opt/idc/mysql-shell8.0.20 ####配置 #vi /etc/profilt export PATH=/opt/idc/mysql-shell8.0.20/bin:$PATH #Source /etc/profile 说明：https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-connections.html
备注：是不是很简单，但需要注意每个mysql版本都有对应shell版本。建议对应版本使用。shell 是跟着mysql版本进行维护的。
ReplicaSet：只能搭建主从架构 通过shell脚本 搭建主从
创建集群
[root@ens8 idc]# mysqlsh MySQL Shell 8.0.20 Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved. Oracle is a registered trademark of Oracle Corporation and/or its affiliates. Other names may be trademarks of their respective owners." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/151cf6261deec6fff846a49aa90b9d31/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-21T16:24:46+08:00" />
<meta property="article:modified_time" content="2020-11-21T16:24:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql集群搭建_MySQL Shell 副本集 和 MGR 快速搭建</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div> 
 <p>原文链接：MySQL Shell 副本集 和 MGR 快速搭建 </p> 
 <p>本文为原创文章，如有转载请标明出处。</p> 
 <h3><b>简介</b></h3> 
 <p><br>MySQL Shell是MySQL Server的高级客户端和代码编辑器。除了和mysql命令行客户端程序一样，使用常规的SQL功能外，MySQL Shell还提供了JavaScript和Python的脚本功能，并包含多个API，其中的AdminAPI用于操作InnoDB Cluster。</p> 
 <p></p> 
 <div style="text-align:center;"> 
  <img src="https://images2.imgbox.com/72/7f/Wp81D515_o.png" alt="ac5f4c004d11f01b8084cec84e3c4c1f.png"> 
 </div> 
 <h3>安装部署</h3> 
 <p>下载：https://dev.mysql.com/downloads/shell/</p> 
 <p>安装</p> 
 <div class="has"> 
  <pre><code>#tar -zxvf mysql-shell-8.0.20-linux-glibc2.12-x86-64bit.tar.gz -C /opt/idc/mysql-shell8.0.20

####配置
#vi /etc/profilt
export PATH=/opt/idc/mysql-shell8.0.20/bin:$PATH
#Source /etc/profile</code></pre> 
 </div> 
 <p>说明：https://dev.mysql.com/doc/mysql-shell/8.0/en/mysql-shell-connections.html</p> 
 <p>备注：是不是很简单，但需要注意每个mysql版本都有对应shell版本。建议对应版本使用。shell 是跟着mysql版本进行维护的。</p> 
 <blockquote>
   ReplicaSet：只能搭建主从架构 
 </blockquote> 
 <p>通过shell脚本 搭建主从<br>创建集群</p> 
 <div class="has"> 
  <pre><code>[root@ens8 idc]# mysqlsh
MySQL Shell 8.0.20

Copyright (c) 2016, 2020, Oracle and/or its affiliates. All rights reserved.
Oracle is a registered trademark of Oracle Corporation and/or its affiliates.
Other names may be trademarks of their respective owners.

Type 'help' or '?' for help; 'quit' to exit.
 MySQL  JS &gt; connect root@192.168.244.129:3380

 MySQL  192.168.244.129:3380 ssl  JS &gt; var rs = dba.createReplicaSet("dbexample")</code></pre> 
 </div> 
 <p></p> 
 <div style="text-align:center;"> 
  <img src="https://images2.imgbox.com/c5/80/QFtpHHJk_o.png" alt="2243d3fb676f75a652c35136ee582b93.png"> 
 </div> 
 <p>查看集群状态：</p> 
 <div class="has"> 
  <pre><code>MySQL  192.168.244.129:3380 ssl  JS &gt; rs.status()</code></pre> 
 </div> 
 <p></p> 
 <div style="text-align:center;"> 
  <img src="https://images2.imgbox.com/d3/bd/kAZBE5vU_o.png" alt="f388998a834227b6b0b210057b6b84ef.png"> 
 </div> 
 <p>添加集群节点：</p> 
 <div class="has"> 
  <pre><code>MySQL  192.168.244.129:3380 ssl  JS &gt; rs.addInstance('root@192.168.244.129:3381')</code></pre> 
 </div> 
 <p></p> 
 <div style="text-align:center;"> 
  <img src="https://images2.imgbox.com/d4/ad/hpamRvy6_o.png" alt="81765d46155f781bf2907fa8714018f1.png"> 
 </div> 
 <p><br>查看集群状态：</p> 
 <div class="has"> 
  <pre><code>MySQL  192.168.244.129:3380 ssl  JS &gt; rs.status()</code></pre> 
 </div> 
 <p></p> 
 <div style="text-align:center;"> 
  <img src="https://images2.imgbox.com/e6/13/0tke2lWP_o.png" alt="6219df9a337629b61700db34806a7068.png"> 
 </div> 
 <p>登录数据库，查看主从状态：</p> 
 <p></p> 
 <div style="text-align:center;"> 
  <img src="https://images2.imgbox.com/e8/bd/jvZzfQGp_o.png" alt="ba4dff7e1821df636d425b04565f6294.png"> 
 </div> 
 <p>其他命令：</p> 
 <div class="has"> 
  <pre><code>rs = dba.createReplicaSet('testadopt', {'adoptFromAR':1}) #现有副本集接管

rs.addInstance(“root@192.168.244.129:3381”)  #添加节点 

rs.disconnect() #断开replicaset对象使用的所有内部会话。

rs.forcePrimaryInstance(instance, options) #不可用主服务器的副本集中执行故障转移

rs.getName() #获取集群名字

rs.help([member]) #帮助信息

rs.listRouters([options]) ##mysql router配置信息

rs.rejoinInstance(instance[, options]) #重新加入副本

rs.removeInstance(instance[, options]) #删除节点

rs.removeRouterMetadata(routerDef) #删除router 信息

rs.setPrimaryInstance(instance, options) #指定主节点

rs.setupAdminAccount(user, options) #创建集群管理账号

rs.setupRouterAccount(user, options) #指定router 访问账号

rs.status([options]) #查看副本集状态

#optins 部分 可以通过 help ReplicaSet.removeInstance 查看</code></pre> 
 </div> 
 <p>备注：<br>1）现没有双主配置，并行复制，多源复制相关的参数支持，可以算不完善<br>2）删除添加节点</p> 
 <p></p> 
 <div style="text-align:center;"> 
  <img src="https://images2.imgbox.com/93/6e/wysSUeP6_o.png" alt="21a1aa2dadad170646fab8931c5d390e.png"> 
 </div> 
 <p><br>3）没有副本集摧毁的命令<br>如果要删除集群需要先通过removeInstance删除第二节点,再通过stop slave 以及reset slave all,并删除mysql_innodb_cluster_metadata数据库实现<br>4）通过，一下命令可以查看帮助文档<br>? ReplicaSet<br>官场参考：https://dev.mysql.com/doc/refman/8.0/en/mysql-innodb-replicasets.html</p> 
 <p>*总结下来，不完善，还需继续努力。</p> 
 <h3>MGR新集群搭建：</h3> 
 <p>创建新MGR</p> 
 <div class="has"> 
  <pre><code>[root@ss30 mysqlrouter]# mysqlsh
 MySQL  JS &gt; dba.checkInstanceConfiguration('root@192.168.244.129:3380')
The instance 'ens8:3380' is valid to be used in an InnoDB cluster.

{
    "status": "ok"
}</code></pre> 
 </div> 
 <p>对集群中的每个服务器实例重复此过程：</p> 
 <div class="has"> 
  <pre><code>MySQL  JS &gt;dba.checkInstanceConfiguration('root@192.168.244.129:3381')
 MySQL  JS &gt;dba.checkInstanceConfiguration('root@192.168.244.129:3382')</code></pre> 
 </div> 
 <p>执行dba.configureInstance()后再次检查实例配置的输出如下：</p> 
 <div class="has"> 
  <pre><code>MySQL  JS &gt;dba.configureInstance('root@192.168.244.129:3380')
 MySQL  JS &gt;dba.configureInstance('root@192.168.244.129:3381')
 MySQL  JS &gt;dba.configureInstance('root@192.168.244.129:3382')</code></pre> 
 </div> 
 <p>创建MGR集群：</p> 
 <div class="has"> 
  <pre><code>##链接主节点
 MySQL  JS &gt;connect root@192.168.244.129:3380

##创建集群
 MySQL  192.168.244.129:3380 ssl  JS  &gt; dba.createCluster('mgrCluster')
 MySQL  192.168.244.129:3380 ssl  JS &gt; var cluster = dba.getCluster()

 ##添加节点
 MySQL  192.168.244.129:3380 ssl  JS &gt; cluster.addInstance('root@192.168.244.129:3381')
 MySQL  192.168.244.129:3380 ssl  JS &gt; cluster.addInstance('root@192.168.244.129:3382')
 
  ##查看集群状态
 MySQL  192.168.244.129:3380 ssl  JS &gt; cluster.status()
 
 ##解散InnoDB Cluster
 MySQL  192.168.244.129:3380 ssl  JS &gt; cluster.dissolve()
 
 ##配置新主选举权重
 MySQL  192.168.244.129:3380 ssl  JS &gt;  var mycluster = dba.getCluster()
 MySQL  192.168.244.129:3380 ssl  JS &gt; mycluster.addInstance('root@192.168.244.129:3381', {memberWeight:25})
 MySQL  192.168.244.129:3380 ssl  JS &gt; mycluster.addInstance('root@192.168.244.129:3382', {memberWeight:50})

##指定一个新的主节点
 MySQL  192.168.244.129:3380 ssl  JS &gt; cluster.setPrimaryInstance('192.168.244.129:3381')

##Cluster.switchToMultiPrimaryMode()切换到多主模式：
 MySQL  192.168.244.129:3380 ssl  JS &gt; cluster.switchToMultiPrimaryMode()


 ##Cluster.switchToSinglePrimaryMode()切换到单主模式
 MySQL  192.168.244.129:3380 ssl  JS &gt; cluster.switchToSinglePrimaryMode('172.16.1.125:3306')</code></pre> 
 </div> 
 <blockquote>
   MGR集群接管： 
  <br>如果在已经配置好的组复制上创建InnoDB Cluster，并且希望使用它来创建集群，可将adoptFromGR选项传递给dba.createCluster()函数。创建的InnoDB Cluster会匹配复制组是以单主数据库还是多主数据库运行。 要采用现有的组复制组，使用MySQL Shell连接到组成员。 
 </blockquote> 
 <div class="has"> 
  <pre><code>[root@ss30 mysqlrouter]# mysqlsh --uri root@192.168.244.129:3380
  MySQL  192.168.244.129:3380 ssl  JS &gt; var cluster = dba.createCluster('testCluster', {adoptFromGR: true});
A new InnoDB cluster will be created based on the existing replication group on instance '192.168.244.129:3380'.

Creating InnoDB cluster 'testCluster' on 'ens8:3380'...

Adding Seed Instance...
Adding Instance 'ens8:3380'...
Adding Instance 'ens8:3381'...
Adding Instance 'ens8:3382'...
Resetting distributed recovery credentials across the cluster...
Cluster successfully created based on existing replication group.

MySQL  192.168.244.129:3380 ssl  JS &gt; cluster.status();
{
    "clusterName": "testCluster", 
    "defaultReplicaSet": {
        "name": "default", 
        "primary": "ens8:3380", 
        "ssl": "DISABLED", 
        "status": "OK", 
        "statusText": "Cluster is ONLINE and can tolerate up to ONE failure.", 
        "topology": {
            "ens8:3380": {
                "address": "ens8:3380", 
                "mode": "R/W", 
                "readReplicas": {}, 
                "replicationLag": null, 
                "role": "HA", 
                "status": "ONLINE", 
                "version": "8.0.19"
            }, 
            "ens8:3381": {
                "address": "ens8:3381", 
                "mode": "R/O", 
                "readReplicas": {}, 
                "replicationLag": null, 
                "role": "HA", 
                "status": "ONLINE", 
                "version": "8.0.19"
            }, 
            "ens8:3382": {
                "address": "ens8:3382", 
                "mode": "R/O", 
                "readReplicas": {}, 
                "replicationLag": null, 
                "role": "HA", 
                "status": "ONLINE", 
                "version": "8.0.19"
            }
        }, 
        "topologyMode": "Single-Primary"
    }, 
    "groupInformationSourceMember": "ens8:3380"
}</code></pre> 
 </div> 
 <h3>其他命令</h3> 
 <div class="has"> 
  <pre><code>##检查节点配置实例，用于加入cluster之前
dba.checkInstanceConfiguration("root@hostname:3306")

##重启
dba.rebootClusterFromCompleteOutage('mycluster');

##删除schema 
dba.dropMetadataSchema();   

##获取当前集群           
var cluster = dba.getCluster('mycluster')    

##检查cluster里节点状态 
cluster.checkInstanceState("root@hostname:3306") 

##重新加入节点，我本地测试的时候发现rejoin一直无效，每次是delete后
cluster.rejoinInstance("root@hostname:3306")

##删除集群
addcluster.dissolve({force：true})  

##增加节点     
cluster.addInstance("root@hostname:3306")   

##删除节点
cluster.removeInstance("root@hostname:3306") 

##强制删除节点
cluster.removeInstance('root@host:3306',{force:true})    

##解散集群
cluster.dissolve({force:true})     

###集群描述
cluster.describe()</code></pre> 
 </div> 
 <p>如何重置Innodb cluster集群环境:</p> 
 <div class="has"> 
  <pre><code>##主节点：登录mysql-shell清空集群
mysql-js&gt;dba.dropMetadataSchema();   
 
mysql&gt; stop group_replication;
##清空日志，确保和从库的表没有冲突
mysql&gt; reset master;               
mysql&gt; reset slave;
  
##其他节点(主要清理和主库的主从信息， 确保主库和从库的表没有冲突)
mysql&gt; stop group_replication;
mysql&gt; reset master;
mysql&gt; reset slave</code></pre> 
 </div> 
 <p>如何将Multi-Primary改为Single-Primary</p> 
 <div class="has"> 
  <pre><code>## a) 解散原来的集群：
mysql-js&gt; cluster.dissolve({force: true})

## b) 每台主机MySQL修改如下配置：
mysql&gt; set global group_replication_enforce_update_everywhere_checks=OFF;
mysql&gt; set global group_replication_single_primary_mode=ON;

## c) 重新创建集群：
mysql-js&gt; var cluster = dba.createCluster('mysqlCluster');
mysql-js&gt; cluster.addInstance('chianyu@svr2:3306');
mysql-js&gt; cluster.addInstance('chianyu@svr3:3306');</code></pre> 
 </div> 
 <h3>状态属性</h3> 
 <ul><li>节点状态</li></ul> 
 <ol><li>ONLINE - 节点状态正常。</li><li>OFFLINE - 实例在运行，但没有加入任何Cluster。</li><li>RECOVERING - 实例已加入Cluster，正在同步数据。</li><li>ERROR - 同步数据发生异常。</li><li>UNREACHABLE - 与其他节点通讯中断，可能是网络问题，可能是节点crash。</li><li>MISSING 节点已加入集群，但未启动group replication</li></ol> 
 <ul><li>集群状态</li></ul> 
 <ol><li>OK – 所有节点处于online状态，有冗余节点。</li><li>OK_PARTIAL – 有节点不可用，但仍有冗余节点。</li><li>OK_NO_TOLERANCE – 有足够的online节点，但没有冗余，例如：两个节点的Cluster，其中一个挂了，集群就不可用了。</li><li>NO_QUORUM – 有节点处于online状态，但达不到法定节点数，此状态下Cluster无法写入，只能读取。</li><li>UNKNOWN – 不是online或recovering状态，尝试连接其他实例查看状态。</li><li>UNAVAILABLE – 组内节点全是offline状态，但实例在运行，可能实例刚重启还没加入Cluster。</li></ol> 
 <h3>总结</h3> 
 <p><br>整体搭建还是很快速，方便的。但还需要进行很多优化部分。<br>MGR算成熟，但还可以继续优化，<br>副本集还存在很多问题，不建议生产使用。</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/df621bc8e4df84da6d8a84304d3db3a8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">r语言 rgl 强制过程中_R语言正则表达式：提取括号中的内容</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6e31f71ecd565b76d173f301c31ab768/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">有没有办法找回testflight之前测试的软件_苹果testflight使用技巧，你需要知道这些、、...</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>