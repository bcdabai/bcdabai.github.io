<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>LVSDR模式&#43;keepalived - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="LVSDR模式&#43;keepalived" />
<meta property="og:description" content="目录 一.Keepalived简介二.Keepalvied的工作原理三.vrrp相关1.术语2.技术 四.搭建设想五.构建过程1.主机配置基本配置网卡配置（直接编写keepalived.conf,可以不要设置虚拟网卡）ipvsamd 策略keepalived策略 2.备份LVS服务器配置网卡配置（直接编写keepalived.conf，可跳过此步骤）ipvsadm配置和keepalived策略 3.真实主机配置4.客户机测试DOWN 掉主LVS的keepalived 六.优化功能1.日志功能2.单播多播地址2.1修改多播2.2单播设定 3.通知脚本 一.Keepalived简介 Keepalived是Linux下一个轻量级别的高可用解决方案。高可用(High Avalilability,HA)，其实两种不同的含义：广义来讲，是指整个系统的高可用行，狭义的来讲就是之主机的冗余和接管，
它与HeartBeat RoseHA 实现相同类似的功能，都可以实现服务或者网络的高可用，但是又有差别，HeartBeat是一个专业的、功能完善的高可用软件，它提供了HA 软件所需的基本功能，比如：心跳检测、资源接管，检测集群中的服务，在集群节点转移共享IP地址的所有者等等。HeartBeat功能强大，但是部署和使用相对比较麻烦，
与HeartBeat相比，Keepalived主要是通过虚拟路由冗余来实现高可用功能，虽然它没有HeartBeat功能强大，但是Keepalived部署和使用非常的简单，所有配置只需要一个配置文件即可以完成。
二.Keepalvied的工作原理 Keepalived起初是为LVS设计的，专门用来监控集群系统中各个服务节点的状态，它根据TCP/IP参考模型的第三、第四层、第五层交换机制检测每个服务节点的状态，如果某个服务器节点出现异常，或者工作出现故障，Keepalived将检测到，并将出现的故障的服务器节点从集群系统中剔除，这些工作全部是自动完成的，不需要人工干涉，需要人工完成的只是修复出现故障的服务节点
Keepalived作为一个高性能集群软件，它还能实现对集群中服务器运行状态的监控以及故障隔离，下面我们介绍一下Keepalived对服务器运行状态和故障隔离的工作原理。
Keepalived工作在TCP/IP 参考模型的 三层、四层、五层，也就是分别为：网络层，
传输层和应用层，根据TCP、IP参数模型隔层所能实现的功能，Keepalived运行机制如下：
在网络层：我们知道运行这4个重要的协议，互联网络IP协议，互联网络可控制报文协议ICMP、地址转换协议ARP、反向地址转换协议RARP，在网络层Keepalived在网络层采用最常见的工作方式是通过ICMP协议向服务器集群中的每一个节点发送一个ICMP数据包(有点类似与Ping的功能)，如果某个节点没有返回响应数据包，那么认为该节点发生了故障，Keepalived将报告这个节点失效，并从服务器集群中剔除故障节点。
在传输层：提供了两个主要的协议：传输控制协议TCP和用户数据协议UDP，传输控制协议TCP可以提供可靠的数据输出服务、IP地址和端口，代表TCP的一个连接端，要获得TCP服务，需要在发送机的一个端口和接收机的一个端口上建立连接，而Keepalived在传输层里利用了TCP协议的端口连接和扫描技术来判断集群节点的端口是否正常，比如对于常见的WEB服务器80端口。或者SSH服务22端口，Keepalived一旦在传输层探测到这些端口号没有数据响应和数据返回，就认为这些端口发生异常，然后强制将这些端口所对应的节点从服务器集群中剔除掉。
在应用层：可以运行FTP，TELNET，SMTP，DNS等各种不同类型的高层协议，Keepalived的运行方式也更加全面化和复杂化，用户可以通过自定义Keepalived工作方式，例如：可以通过编写程序或者脚本来运行Keepalived，而Keepalived将根据用户的设定参数检测各种程序或者服务是否允许正常，如果Keepalived的检测结果和用户设定的不一致时，Keepalived将把对应的服务器从服务器集群中剔除
功能：
基于vrrp协议完成地址流动为vip地址所在的节点生成ipvs规则(在配置文件中预先定义)为ipvs集群的各RS做健康状态检测基于脚本调用接口完成脚本中定义的功能，进而影响集群事务，以此支持nginx、haproxy等服务 三.vrrp相关 1.术语 虚拟路由器：Virtual Router 虚拟路由器标识：VRID(0-255) 物理路由器： master ：主设备 backup ：备用设备 priority：优先级 VIP：Virtual IP VMAC：Virutal MAC (00-00-5e-00-01-VRID) GraciousARP 2.技术 通告：心跳，优先级等；周期性
工作方式：抢占式，非抢占式，延迟抢占模式
实际工作中，非抢占式，
安全认证：
无认证简单字符认证：预共享密钥MD5 工作模式：
主/备：单虚拟路径器主/主：主/备（虚拟路由器1），备/主（虚拟路由器2） 四.搭建设想 就是建立两台LVS，保证网络畅通，即使一台损坏，老化，备用服务器可以立马顶上
机器IP地址主LVS负载调度器192.168.133.50备LVS负载调度器192.168.133.100RS服务器1192.168.133.75RS服务器2192.168.133.99客户端IP地址自定义 五.构建过程 所有主机都必须关闭防火墙
[root@host ~]# systemctl stop firewalld [root@host ~]# setenforce 0 1.主机配置 基本配置 [root@host ~]# vi /etc/sysctl." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/7571c3190c12ca02a3c77380af473eae/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-19T11:46:35+08:00" />
<meta property="article:modified_time" content="2021-11-19T11:46:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">LVSDR模式&#43;keepalived</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#Keepalived_1" rel="nofollow">一.Keepalived简介</a></li><li><a href="#Keepalvied_7" rel="nofollow">二.Keepalvied的工作原理</a></li><li><a href="#vrrp_27" rel="nofollow">三.vrrp相关</a></li><li><ul><li><a href="#1_28" rel="nofollow">1.术语</a></li><li><a href="#2_40" rel="nofollow">2.技术</a></li></ul> 
  </li><li><a href="#_54" rel="nofollow">四.搭建设想</a></li><li><a href="#_64" rel="nofollow">五.构建过程</a></li><li><ul><li><a href="#1_70" rel="nofollow">1.主机配置</a></li><li><ul><li><a href="#_71" rel="nofollow">基本配置</a></li><li><a href="#keepalivedconf_86" rel="nofollow">网卡配置（直接编写keepalived.conf,可以不要设置虚拟网卡）</a></li><li><a href="#ipvsamd__102" rel="nofollow">ipvsamd 策略</a></li><li><a href="#keepalived_126" rel="nofollow">keepalived策略</a></li></ul> 
   </li><li><a href="#2LVS_149" rel="nofollow">2.备份LVS服务器配置</a></li><li><ul><li><a href="#keepalivedconf_150" rel="nofollow">网卡配置（直接编写keepalived.conf，可跳过此步骤）</a></li><li><a href="#ipvsadmkeepalived_168" rel="nofollow">ipvsadm配置和keepalived策略</a></li></ul> 
   </li><li><a href="#3_195" rel="nofollow">3.真实主机配置</a></li><li><a href="#4_239" rel="nofollow">4.客户机测试</a></li><li><ul><li><a href="#DOWN_LVSkeepalived_247" rel="nofollow">DOWN 掉主LVS的keepalived</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_328" rel="nofollow">六.优化功能</a></li><li><ul><li><a href="#1_329" rel="nofollow">1.日志功能</a></li><li><a href="#2_376" rel="nofollow">2.单播多播地址</a></li><li><ul><li><a href="#21_377" rel="nofollow">2.1修改多播</a></li><li><a href="#22_402" rel="nofollow">2.2单播设定</a></li></ul> 
   </li><li><a href="#3_418" rel="nofollow">3.通知脚本</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Keepalived_1"></a>一.Keepalived简介</h2> 
<p>Keepalived是Linux下一个轻量级别的高可用解决方案。高可用(High Avalilability,HA)，其实两种不同的含义：广义来讲，是指整个系统的高可用行，狭义的来讲就是之主机的冗余和接管，</p> 
<p>它与HeartBeat RoseHA 实现相同类似的功能，都可以实现服务或者网络的高可用，但是又有差别，HeartBeat是一个专业的、功能完善的高可用软件，它提供了HA 软件所需的基本功能，比如：心跳检测、资源接管，检测集群中的服务，在集群节点转移共享IP地址的所有者等等。HeartBeat功能强大，但是部署和使用相对比较麻烦，</p> 
<p>与HeartBeat相比，Keepalived主要是通过虚拟路由冗余来实现高可用功能，虽然它没有HeartBeat功能强大，但是Keepalived部署和使用非常的简单，所有配置只需要一个配置文件即可以完成。</p> 
<h2><a id="Keepalvied_7"></a>二.Keepalvied的工作原理</h2> 
<p>Keepalived起初是为LVS设计的，专门用来监控集群系统中各个服务节点的状态，它根据TCP/IP参考模型的第三、第四层、第五层交换机制检测每个服务节点的状态，如果某个服务器节点出现异常，或者工作出现故障，Keepalived将检测到，并将出现的故障的服务器节点从集群系统中剔除，这些工作全部是自动完成的，不需要人工干涉，需要人工完成的只是修复出现故障的服务节点<br> Keepalived作为一个高性能集群软件，它还能实现对集群中服务器运行状态的监控以及故障隔离，下面我们介绍一下Keepalived对服务器运行状态和故障隔离的工作原理。</p> 
<p>Keepalived工作在TCP/IP 参考模型的 三层、四层、五层，也就是分别为：网络层，</p> 
<p>传输层和应用层，根据TCP、IP参数模型隔层所能实现的功能，Keepalived运行机制如下：</p> 
<p>在网络层：我们知道运行这4个重要的协议，互联网络IP协议，互联网络可控制报文协议ICMP、地址转换协议ARP、反向地址转换协议RARP，在网络层Keepalived在网络层采用最常见的工作方式是通过ICMP协议向服务器集群中的每一个节点发送一个ICMP数据包(有点类似与Ping的功能)，如果某个节点没有返回响应数据包，那么认为该节点发生了故障，Keepalived将报告这个节点失效，并从服务器集群中剔除故障节点。</p> 
<p>在传输层：提供了两个主要的协议：传输控制协议TCP和用户数据协议UDP，传输控制协议TCP可以提供可靠的数据输出服务、IP地址和端口，代表TCP的一个连接端，要获得TCP服务，需要在发送机的一个端口和接收机的一个端口上建立连接，而Keepalived在传输层里利用了TCP协议的端口连接和扫描技术来判断集群节点的端口是否正常，比如对于常见的WEB服务器80端口。或者SSH服务22端口，Keepalived一旦在传输层探测到这些端口号没有数据响应和数据返回，就认为这些端口发生异常，然后强制将这些端口所对应的节点从服务器集群中剔除掉。</p> 
<p>在应用层：可以运行FTP，TELNET，SMTP，DNS等各种不同类型的高层协议，Keepalived的运行方式也更加全面化和复杂化，用户可以通过自定义Keepalived工作方式，例如：可以通过编写程序或者脚本来运行Keepalived，而Keepalived将根据用户的设定参数检测各种程序或者服务是否允许正常，如果Keepalived的检测结果和用户设定的不一致时，Keepalived将把对应的服务器从服务器集群中剔除</p> 
<p>功能：</p> 
<ul><li>基于vrrp协议完成地址流动</li><li>为vip地址所在的节点生成ipvs规则(在配置文件中预先定义)</li><li>为ipvs集群的各RS做健康状态检测</li><li>基于脚本调用接口完成脚本中定义的功能，进而影响集群事务，以此支持nginx、haproxy等服务</li></ul> 
<h2><a id="vrrp_27"></a>三.vrrp相关</h2> 
<h3><a id="1_28"></a>1.术语</h3> 
<pre><code>虚拟路由器：Virtual Router 
    虚拟路由器标识：VRID(0-255)
    物理路由器：
        master  ：主设备
        backup  ：备用设备
        priority：优先级
    VIP：Virtual IP 
    VMAC：Virutal MAC (00-00-5e-00-01-VRID)
    GraciousARP
</code></pre> 
<h3><a id="2_40"></a>2.技术</h3> 
<p>通告：心跳，优先级等；周期性<br> 工作方式：抢占式，非抢占式，延迟抢占模式<br> 实际工作中，非抢占式，<br> 安全认证：</p> 
<ul><li>无认证</li><li>简单字符认证：预共享密钥</li><li>MD5</li></ul> 
<p>工作模式：</p> 
<ul><li>主/备：单虚拟路径器</li><li>主/主：主/备（虚拟路由器1），备/主（虚拟路由器2）</li></ul> 
<h2><a id="_54"></a>四.搭建设想</h2> 
<p><img src="https://images2.imgbox.com/63/f8/0u9bvCws_o.png" alt="在这里插入图片描述"><br> 就是建立两台LVS，保证网络畅通，即使一台损坏，老化，备用服务器可以立马顶上</p> 
<table><thead><tr><th>机器</th><th>IP地址</th></tr></thead><tbody><tr><td>主LVS负载调度器</td><td>192.168.133.50</td></tr><tr><td>备LVS负载调度器</td><td>192.168.133.100</td></tr><tr><td>RS服务器1</td><td>192.168.133.75</td></tr><tr><td>RS服务器2</td><td>192.168.133.99</td></tr><tr><td>客户端</td><td>IP地址自定义</td></tr></tbody></table> 
<h2><a id="_64"></a>五.构建过程</h2> 
<p>所有主机都必须关闭防火墙</p> 
<pre><code>[root@host ~]# systemctl stop firewalld
[root@host ~]# setenforce 0
</code></pre> 
<h3><a id="1_70"></a>1.主机配置</h3> 
<h4><a id="_71"></a>基本配置</h4> 
<pre><code>[root@host ~]# vi /etc/sysctl.conf
</code></pre> 
<p>在末尾编写如下代码<br> <img src="https://images2.imgbox.com/f0/a7/0UsfFZCa_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host ~]# sysctl -p
net.ipv4.ip_forward = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.ens33.send_redirects = 0
</code></pre> 
<h4><a id="keepalivedconf_86"></a>网卡配置（直接编写keepalived.conf,可以不要设置虚拟网卡）</h4> 
<pre><code>[root@host ~]# cd /etc/sysconfig/network-scripts/                                           进入网卡编辑
[root@host network-scripts]# cp ifcfg-ens33 ifcfg-ens33:0                            复制文件到虚拟网卡
[root@host network-scripts]# vim ifcfg-ens33:0

</code></pre> 
<p><img src="https://images2.imgbox.com/ca/a1/zlUM16fG_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host network-scripts]# systemctl restart network
[root@host network-scripts]# ifconfig

</code></pre> 
<p><img src="https://images2.imgbox.com/e1/25/Coob59bf_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="ipvsamd__102"></a>ipvsamd 策略</h4> 
<pre><code>[root@host ~]# yum install -y ipvsadm* 
[root@host ~]# modprobe ip_vs
[root@host ~]# cat /proc/net/ip_vs
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn
[root@host ~]# ipvsadm-save &gt;/etc/sysconfig/ipvsadm
[root@host ~]# systemctl start ipvsadm
[root@host ~]# ipvsadm -C                                                                         直接编写keepalived.conf以下可不用设定，因为会自动开启
[root@host ~]# ipvsadm -A -t 192.168.133.200:80 -s rr
[root@host ~]# ipvsadm -a -t 192.168.133.200:80 -r 192.168.133.99:80 -g
[root@host ~]# ipvsadm -a -t 192.168.133.200:80 -r 192.168.133.75:80 -g
[root@host ~]# ipvsadm
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  host:http rr
  -&gt; 192.168.133.75:http          Route   1      0          0         
  -&gt; 192.168.133.99:http          Route   1      0          0         
[root@host ~]# ipvsadm -ln
</code></pre> 
<p><img src="https://images2.imgbox.com/18/04/GvKdh2Sh_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="keepalived_126"></a>keepalived策略</h4> 
<pre><code>[root@host ~]# yum install -y keepalived 
[root@host ~]# cd /etc/keepalived/
[root@host keepalived]# ls
keepalived.conf
[root@host keepalived]# cp keepalived.conf keepalived.conf.bak
[root@host keepalived]# ls
keepalived.conf  keepalived.conf.bak
[root@host keepalived]# vim keepalived.conf

</code></pre> 
<p><img src="https://images2.imgbox.com/a1/4e/r9AdY1im_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/13/59/NoPxqWJF_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/08/5c/oMd2A75K_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dd/f5/jByV5lRs_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host keepalived]# systemctl enable keepalived
Created symlink from /etc/systemd/system/multi-user.target.wants/keepalived.service to /usr/lib/systemd/system/keepalived.service.
</code></pre> 
<h3><a id="2LVS_149"></a>2.备份LVS服务器配置</h3> 
<h4><a id="keepalivedconf_150"></a>网卡配置（直接编写keepalived.conf，可跳过此步骤）</h4> 
<pre><code>[root@back ~]# systemctl restart network                                网卡配置差不多，但重启网不能用这条命令
[root@back ~]#ifup ens33:0                                            得用这条命令 但会报错，因为两个服务器的vip一样
ERROR     : [/etc/sysconfig/network-scripts/ifup-eth] Error, some other host (00:0C:29:D1:E8:8B) already uses address 192.168.133.200.
</code></pre> 
<p>解决办法找到以下内容注释掉<br> <img src="https://images2.imgbox.com/57/9e/qNCEcnnD_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/1c/35/XmulO6Pt_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@back ~]# ifup ens33:0                        这时再用这条命令启动网卡
</code></pre> 
<p>第二种方法<br> 主LVS上用ifup ens33:0 启动<br> 备用LVS上用systemctl restart network启动，不需要修改文件即可</p> 
<h4><a id="ipvsadmkeepalived_168"></a>ipvsadm配置和keepalived策略</h4> 
<p>装好ipvsadm并设置同主机设置相同<br> 安装keepalived后，将主机文件发往备份机</p> 
<pre><code>[root@host ~]# scp /etc/keepalived/keepalived.conf root@192.168.133.100:/etc/keepalived/
The authenticity of host '192.168.133.100 (192.168.133.100)' can't be established.
ECDSA key fingerprint is SHA256:eBYF1NpUpJHEFPq/PtM1L7nhNgFIIqXoIU3xGy8umVU.
ECDSA key fingerprint is MD5:b1:fa:bd:29:6c:f5:9e:aa:84:f0:6b:b2:7e:ef:3c:df.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.133.100' (ECDSA) to the list of known hosts.
root@192.168.133.100's password: 
keepalived.conf                                                                                              100% 1177     2.8MB/s   00:00  
</code></pre> 
<pre><code>[root@back ~]# vim /etc/keepalived/keepalived.conf 
</code></pre> 
<p>只要更改三处<br> <img src="https://images2.imgbox.com/48/e9/QoQ6hZBL_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@back ~]# systemctl enable keepalived
Created symlink from /etc/systemd/system/multi-user.target.wants/keepalived.service to /usr/lib/systemd/system/keepalived.service.
[root@back ~]# systemctl start keepalived

</code></pre> 
<h3><a id="3_195"></a>3.真实主机配置</h3> 
<p>基本差不多</p> 
<pre><code>[root@rs1 ~]# yum install -y httpd 
[root@rs1 ~]# systemctl start httpd
</code></pre> 
<pre><code>[root@rs1 ~]# echo "THIS IS  server ONE1" &gt; /var/www/html/index.html                     RS1网页
[root@rs1 ~]# cat /var/www/html/index.html
THIS IS  server ONE1

[root@rs2 ~]# echo "THIS IS  TWO2 WELCOME" &gt; /var/www/html/index.html            RS2网页
[root@rs2 ~]# cat /var/www/html/index.html     
THIS IS  TWO2 WELCOME
[root@rs2 ~]#  vi /etc/sysctl.conf

</code></pre> 
<p><img src="https://images2.imgbox.com/00/eb/Wg18YuOq_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@rs1 ~]# sysctl -p
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.all.arp_announce = 2
net.ipv4.conf.default.arp_ignore = 1
net.ipv4.conf.default.arp_announce = 2
net.ipv4.conf.lo.arp_ignore = 1
net.ipv4.conf.lo.arp_announce = 2
</code></pre> 
<pre><code>[root@rs1 ~]# cd /etc/sysconfig/network-scripts/
[root@rs1 network-scripts]# cp ifcfg-lo ifcfg-lo:0
[root@rs1 network-scripts]# vim ifcfg-lo:0
</code></pre> 
<p><img src="https://images2.imgbox.com/74/96/qMNfJOtd_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@rs1 network-scripts]# systemctl restart network
[root@rs2 network-scripts]# route add -host 192.168.133.200 dev lo:0

</code></pre> 
<h3><a id="4_239"></a>4.客户机测试</h3> 
<p>客户机访问vip"192.168.133.200"<br> <img src="https://images2.imgbox.com/b0/8e/qq9cecYV_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/db/13/eXnBODB9_o.png" alt="在这里插入图片描述"><br> 主LVS看结果<br> <img src="https://images2.imgbox.com/42/34/oXhZP4IZ_o.png" alt="在这里插入图片描述"><br> 备份LVS看结果<br> <img src="https://images2.imgbox.com/70/ba/ZRBppLp7_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="DOWN_LVSkeepalived_247"></a>DOWN 掉主LVS的keepalived</h4> 
<pre><code>[root@host ~]# systemctl stop keepalived

</code></pre> 
<p>客户机登录正常<br> <img src="https://images2.imgbox.com/3d/5a/AUL9kE65_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ed/3e/ujxz10hI_o.png" alt="在这里插入图片描述"><br> 在备份LVS上查看登录情况<br> <img src="https://images2.imgbox.com/b6/68/Sin1aPH0_o.png" alt="在这里插入图片描述"><br> 主备实验<br> 工作方式：抢占式，非抢占式，延迟抢占模式<br> 默认方式就是抢占式<br> 在真实主机上输入命令</p> 
<pre><code>[root@rs1 ~]# tcpdump -i ens33 -nn host 224.0.0.18                            默认组播是224.0.0.18
</code></pre> 
<p>可以看到都是从master上传过来的报文<br> <img src="https://images2.imgbox.com/ca/ed/RGHGl3Qy_o.png" alt="在这里插入图片描述"><br> 我们停止主机上的keepalived服务</p> 
<pre><code>[root@host network-scripts]# systemctl stop keepalived.service
</code></pre> 
<p>备用服务器就里面顶了上来<br> <img src="https://images2.imgbox.com/ea/6f/5QrB05h5_o.png" alt="在这里插入图片描述"><br> 这时我们再启动主机的keepalived服务</p> 
<pre><code>[root@host network-scripts]# systemctl restart keepalived.service
</code></pre> 
<p>主服务器立马抢占了服务，<br> <img src="https://images2.imgbox.com/64/53/6fA9Ozme_o.png" alt="在这里插入图片描述"><br> 因为实际工作中会产生掉包现象，所以不提倡用这种模式</p> 
<p>非抢占式<br> 在真实主机上输入命令</p> 
<pre><code>[root@rs1 ~]# tcpdump -i ens33 -nn host 224.0.0.18                            默认组播是224.0.0.18
</code></pre> 
<p>目前上来的还是主机地址<br> <img src="https://images2.imgbox.com/1a/fa/3cJhJp9s_o.png" alt="在这里插入图片描述"><br> 主备服务器上的设置</p> 
<pre><code>[root@host keepalived]# vim keepalived.conf
</code></pre> 
<p><img src="https://images2.imgbox.com/b8/95/O2s1ubXI_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/5c/9e/M2YGWyCT_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host keepalived]# systemctl restart keepalived.service
[root@host keepalived]# systemctl stop keepalived.service
[root@host keepalived]# systemctl start keepalived.service
</code></pre> 
<p>这里仍然是备份服务器在工作，<br> <img src="https://images2.imgbox.com/0d/4c/mKt6nqzw_o.png" alt="在这里插入图片描述"><br> 然后我们去停掉备份服务器的keepalived的服务</p> 
<pre><code>[root@BACK ~]# systemctl stop keepalived.service 
</code></pre> 
<p>这时就发现原来的主服务器就开始重新工作了<br> <img src="https://images2.imgbox.com/45/7d/gDDp4DuZ_o.png" alt="在这里插入图片描述"><br> 延迟抢占模式<br> 可以设定多少时间后开始抢占服务</p> 
<pre><code>[root@host keepalived]# vim keepalived.conf
</code></pre> 
<p><img src="https://images2.imgbox.com/dd/9e/MmFSxWtl_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host keepalived]# systemctl start keepalived.service
[root@host keepalived]# systemctl stop keepalived.service
[root@host keepalived]# systemctl start keepalived.service
</code></pre> 
<p>可以看到在执行完命令后20秒主服务器抢占了备用服务器<br> <img src="https://images2.imgbox.com/d2/56/NXTighAp_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_328"></a>六.优化功能</h2> 
<h3><a id="1_329"></a>1.日志功能</h3> 
<p>日志都在/var/log/message里</p> 
<pre><code>[root@host keepalived]# vim /var/log/messages
</code></pre> 
<p>可以看到日志很多，很不好找<br> <img src="https://images2.imgbox.com/fe/5f/tJTYEjwn_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host keepalived]# keepalived --help                               查看keepalived的帮助文件
</code></pre> 
<p>-D -S 都是日志文件有关，<br> <img src="https://images2.imgbox.com/27/f3/CcjKHfpj_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host keepalived]# ps aux |grep keep
</code></pre> 
<p>看进程末位是有默认 -D的<br> <img src="https://images2.imgbox.com/96/92/oKuHFWuB_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host keepalived]# vim /lib/systemd/system/keepalived.service
</code></pre> 
<p><img src="https://images2.imgbox.com/4f/11/MNqcsP3y_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host ~]# vim /etc/sysconfig/keepalived
</code></pre> 
<p><img src="https://images2.imgbox.com/66/b3/em5INrmq_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host ~]# vim /etc/rsyslog.conf 
</code></pre> 
<p><img src="https://images2.imgbox.com/17/e7/fY9sgP8R_o.png" alt="在这里插入图片描述"><br> 这里增加这一行<br> <img src="https://images2.imgbox.com/76/eb/U0rYJMIT_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host ~]# systemctl restart keepalived.service rsyslog.service                                     重启服务，但会报错
Warning: keepalived.service changed on disk. Run 'systemctl daemon-reload' to reload units.
[root@host ~]# systemctl daemon-reload                                                                            应该先复位再重启
[root@host ~]# systemctl restart keepalived.service rsyslog.service
[root@host ~]# cat /var/log/keepalive.log 
</code></pre> 
<p>可以看到keepalive的日志都集中在了一个文件夹里<br> <img src="https://images2.imgbox.com/01/1c/Lw6Uvx0c_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_376"></a>2.单播多播地址</h3> 
<h4><a id="21_377"></a>2.1修改多播</h4> 
<p>主备服务器都要改</p> 
<pre><code>[root@host ~]# vim /etc/keepalived/keepalived.conf
</code></pre> 
<p>在全局末尾增加单播地址<br> <img src="https://images2.imgbox.com/b6/e9/GRMLkjLz_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host ~]# systemctl restart keepalived.service                                                  重启主机服务
</code></pre> 
<p>可以看到单播设置成功<br> <img src="https://images2.imgbox.com/88/03/0j3XBWCe_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host ~]# systemctl stop keepalived.service                        停止主机服务
</code></pre> 
<p><img src="https://images2.imgbox.com/8b/5d/vEdTp9ZN_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host ~]# systemctl restart keepalived.service                                            重启主机服务后，20秒后主机抢占服务
</code></pre> 
<p><img src="https://images2.imgbox.com/39/8d/Dj9FEbLv_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="22_402"></a>2.2单播设定</h4> 
<p>主从服务器都得设定增加，注意源地址和目标地址</p> 
<pre><code>[root@host ~]# vim /etc/keepalived/keepalived.conf
</code></pre> 
<p><img src="https://images2.imgbox.com/d1/73/mfeoWXUm_o.png" alt="在这里插入图片描述"><br> 这是备用服务器上的设置<br> <img src="https://images2.imgbox.com/ec/a8/05Tb35uC_o.png" alt="在这里插入图片描述"><br> 重启服务后就可以在真实服务器上体现出来了</p> 
<pre><code>[root@rs1 ~]# tcpdump -i ens33 -nn host 192.168.133.50
</code></pre> 
<p><img src="https://images2.imgbox.com/5b/69/2DbZ3v4F_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_418"></a>3.通知脚本</h3> 
<pre><code>[root@localhost opt]#vim /etc/mail.rc
</code></pre> 
<p>在底部增加以下命令<br> <img src="https://images2.imgbox.com/d8/d9/XwT6Kj6z_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host ~]# cd /opt
[root@host opt]# rz -E
rz waiting to receive.
[root@host opt]# ls
keepalive.sh  rh
[root@host opt]# chmod +x keepalive.sh 
[root@host opt]# vim /etc/keepalived/keepalived.conf
</code></pre> 
<p><img src="https://images2.imgbox.com/7a/a1/gc90bVNX_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@host opt]# systemctl daemon-reload 
[root@host opt]# systemctl restart keepalived.service 
[root@host opt]# scp /opt/keepalive.sh root@192.168.133.99:/opt
root@192.168.133.99's password: 
keepalive.sh                                                                                                 100%  414   461.0KB/s   00:00  
</code></pre> 
<p>查看邮箱即可看到提醒<br> <img src="https://images2.imgbox.com/a8/d1/5MU2ab2E_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7d04ffe2a862c8ae86a4bcd767369e7d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">进制定义</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b892aa9612c9013ca46f5c6df905515b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">《X86汇编语言：从实模式到保护模式》读取磁盘</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>