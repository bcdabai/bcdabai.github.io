<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>小程序mqtt实现聊天功能 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="小程序mqtt实现聊天功能" />
<meta property="og:description" content="mqtt是什么？ MQTT是一个轻量级传输协议，它被设计用于轻量级的发布/订阅式消息传输，MQTT协议针对低带宽网络，低计算能力的设备，做了特殊的优化。是一种简单、稳定、开放、轻量级易于实现的消息协议，在物联网的应用下的信息采集，工业控制，智能家居等方面具有广泛的适用性。
谁发布，谁订阅？ MQTT服务器类似一个公告栏，里面张贴了各种广告。 张三跑过来说，凡是涉及足球的（/public/TEST/Soccer）的都发给自己（订阅） 第二天，李四过来贴广告了，主题是（/public/TEST/Soccer），发布的内容是“30号有比赛” 此时，公告栏会自动发短信给张三，发送的信息为 “30号有比赛” 张三：APP端； 李四：设备端； 公告栏：云端的MQTT服务器 mqtt优点？ 1、MQTT更加简单: MQTT是一种消息队列协议，使用发布/订阅消息模式，提供一对多的消息发布，解除应用程序耦合，相对于其他协议，开发更简单；
2、MQTT网络更加稳定 工作在TCP/IP协议上；由TCP/IP协议提供稳定的网络连接；
3、轻量级 小型传输，开销很小（固定长度的头部是 2 字节），协议交换最小化，以降低网络流量；适合低带宽，数据量较小的应用；
MQTT和Websocket的区别是什么？ MQTT是为了物联网场景设计的基于TCP的Pub/Sub协议，有许多为物联网优化的特性，比如适应不同网络的QoS、层级主题、遗言等等。
WebSocket是为了HTML5应用方便与服务器双向通讯而设计的协议，HTTP握手然后转TCP协议，用于取代之前的Server Push、Comet、长轮询等老旧实现。两者之所有有交集，是因为一个应用场景：如何通过HTML5应用来作为MQTT的客户端，以便接受设备消息或者向设备发送信息，那么MQTT over WebSocket自然成了最合理的途径了。
如何适用mqtt去实现聊天功能？ 首先我们从前端布局样式开始 为了时时滚动到最新消息我们使用 scroll-view 标签包裹 使用它的scroll-into-view属性我们绑定一个自定义id
如图：
我们在创建的元素上绑定一个 id属性，scroll-view 即可自动滚动到其对应位置。
以上就是几种不同消息类型的展示，我们先不考虑类型的样式，我们先来实现聊天左右分布的布局
推荐大家使用 flex 布局去实现
左侧医生：display: flex;justify-content: flex-start; (默认属性) 右侧患者：display: flex;justify-content: flex-end;（尾部对齐）
样式方面主要也就是这两个属性，其他消息类型的，也是在这基础上做修改即可。
2.连接 mqtt
首先我们要引入依赖
var Paho = require(&#39;./utils/paho-mqtt-wx.js&#39;)
var Paho = require(&#39;./utils/paho-mqtt-wx.js&#39;) /** * 连接 mqtt */ connectMqtt() { // let t = &#39;异常断线&#39;; var t = {} t." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/b47820ecf77a82bbdaf47511716e6085/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-20T09:53:19+08:00" />
<meta property="article:modified_time" content="2023-06-20T09:53:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">小程序mqtt实现聊天功能</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5><a id="mqtt_0"></a>mqtt是什么？</h5> 
<blockquote> 
 <p><code>MQTT是一个轻量级传输协议</code>，它被设计用于轻量级的<code>发布/订阅式消息传输</code>，MQTT协议针对低带宽网络，低计算能力的设备，做了特殊的优化。是一种简单、稳定、开放、轻量级易于实现的消息协议，在<code>物联网</code>的应用下的<code>信息采集</code>，<code>工业控制</code>，<code>智能家居</code>等方面具有广泛的适用性。</p> 
</blockquote> 
<h5><a id="_4"></a>谁<code>发布</code>，谁<code>订阅</code>？</h5> 
<pre><code>MQTT服务器类似一个公告栏，里面张贴了各种广告。

张三跑过来说，凡是涉及足球的（/public/TEST/Soccer）的都发给自己（订阅）

第二天，李四过来贴广告了，主题是（/public/TEST/Soccer），发布的内容是“30号有比赛”

此时，公告栏会自动发短信给张三，发送的信息为 “30号有比赛”

张三：APP端；

李四：设备端；

公告栏：云端的MQTT服务器

</code></pre> 
<p><img src="https://images2.imgbox.com/63/67/hpS1euW3_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="mqtt_24"></a>mqtt优点？</h5> 
<h6><a id="1MQTT_26"></a>1、MQTT更加简单:</h6> 
<blockquote> 
 <p>MQTT是一种消息队列协议，使用发布/订阅消息模式，提供一对多的消息发布，解除应用程序耦合，相对于其他协议，开发更简单；</p> 
</blockquote> 
<h6><a id="2MQTT_29"></a>2、MQTT网络更加稳定</h6> 
<blockquote> 
 <p>工作在TCP/IP协议上；由TCP/IP协议提供稳定的网络连接；</p> 
</blockquote> 
<h6><a id="3_32"></a>3、轻量级</h6> 
<blockquote> 
 <p>小型传输，开销很小（固定长度的头部是 2 字节），协议交换最小化，以降低网络流量；适合低带宽，数据量较小的应用；</p> 
</blockquote> 
<h5><a id="MQTTWebsocket_37"></a>MQTT和Websocket的区别是什么？</h5> 
<ul><li> <p><code>MQTT</code>是为了物联网场景设计的基于TCP的Pub/Sub协议，有许多为<code>物联网</code>优化的特性，比如适应不同网络的QoS、层级主题、遗言等等。</p> </li><li> <p><code>WebSocket</code>是为了<code>HTML5</code>应用方便与服务器双向通讯而设计的协议，HTTP握手然后转TCP协议，用于取代之前的Server Push、Comet、<code>长轮询</code>等老旧实现。两者之所有有交集，是因为一个应用场景：<code>如何通过HTML5应用来作为MQTT的客户端，以便接受设备消息或者向设备发送信息，那么MQTT over WebSocket自然成了最合理的途径了。</code></p> </li></ul> 
<h5><a id="mqtt_43"></a>如何适用mqtt去实现聊天功能？</h5> 
<blockquote> 
 <ol><li>首先我们从前端布局样式开始</li></ol> 
</blockquote> 
<div> 
 <img src="https://images2.imgbox.com/3f/a8/nIaSPg2r_o.jpg" width="49%"> 
</div> 
<blockquote> 
 <p>为了时时滚动到最新消息我们使用 scroll-view 标签包裹 使用它的<code>scroll-into-view</code>属性我们绑定一个自定义id</p> 
</blockquote> 
<p>如图：</p> 
<p><img src="https://images2.imgbox.com/63/fa/p1HAPt1L_o.jpg" alt="在这里插入图片描述"></p> 
<p>我们在创建的元素上绑定一个 <code>id</code>属性，<code>scroll-view </code>即可自动滚动到其对应位置。</p> 
<p><img src="https://images2.imgbox.com/eb/1f/wxG1i5Tk_o.jpg" alt="在这里插入图片描述"></p> 
<p>以上就是几种不同消息类型的展示，我们先不考虑类型的样式，我们先来实现聊天左右分布的布局</p> 
<blockquote> 
 <p>推荐大家使用 <code>flex</code> 布局去实现</p> 
</blockquote> 
<p>左侧医生：<code>display: flex;justify-content: flex-start;</code> (默认属性) <br></p> 
<p>右侧患者：<code>display: flex;justify-content: flex-end;</code>（尾部对齐）<br></p> 
<p>样式方面主要也就是这两个属性，其他消息类型的，也是在这基础上做修改即可。</p> 
<blockquote> 
 <p>2.连接 mqtt</p> 
</blockquote> 
<p>首先我们要引入依赖</p> 
<p><code>var Paho = require('./utils/paho-mqtt-wx.js')</code></p> 
<pre><code class="prism language-javascript"><span class="token keyword">var</span> Paho <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/paho-mqtt-wx.js'</span><span class="token punctuation">)</span>


<span class="token comment">/**
	* 连接 mqtt
	*/</span>
<span class="token function">connectMqtt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// let t = '异常断线';</span>
	<span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	t<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>connectParams<span class="token punctuation">.</span>msgTopicName
	t<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">0</span>
	t<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token number">3</span>
	<span class="token comment">// console.log(t, 98)</span>
	<span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Paho<span class="token punctuation">.</span>Message</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>connectOptions <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	<span class="token comment">//连接mqtt用户名</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>connectOptions<span class="token punctuation">.</span>userName <span class="token operator">=</span> api<span class="token punctuation">.</span>mqttuser 
	<span class="token comment">//连接mqtt密码</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>connectOptions<span class="token punctuation">.</span>password <span class="token operator">=</span> api<span class="token punctuation">.</span>mqttpass 
	<span class="token comment">//遗嘱消息 当客户端断开连接时，发送给相关的订阅者的遗嘱消息</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>connectOptions<span class="token punctuation">.</span>willMessage <span class="token operator">=</span> message 
	<span class="token comment">//心跳保持时间 是一种用于MQTT 的 长连接机制。</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>connectOptions<span class="token punctuation">.</span>keepAliveInterval <span class="token operator">=</span> <span class="token number">10</span> 
	<span class="token comment">//断开连接时是否要清除session</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>connectOptions<span class="token punctuation">.</span>cleanSession <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>connectParams<span class="token punctuation">.</span>cleanSession
	<span class="token comment">//设置如果连接丢失，客户端是否自动尝试重新连接到服务器</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>connectOptions<span class="token punctuation">.</span>reconnect <span class="token operator">=</span> <span class="token boolean">false</span> 
	 <span class="token comment">//连接成功回调</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>connectOptions<span class="token punctuation">.</span>onSuccess <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onConnect 
	<span class="token comment">//连接失败回调</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>connectOptions<span class="token punctuation">.</span>onFailure <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>failConnect 

	<span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Paho<span class="token punctuation">.</span>Client</span><span class="token punctuation">(</span><span class="token string">'wss://'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>connectParams<span class="token punctuation">.</span>dnHost <span class="token operator">+</span> <span class="token string">'/mqtt'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>connectParams<span class="token punctuation">.</span>clientId<span class="token punctuation">)</span>
  <span class="token comment">//当客户端失去连接时调用</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span>onConnectionLost <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onConnectionLost 
	<span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span>onMessageArrived <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onMessageArrived
	 <span class="token comment">//与服务器建立连接</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>connectOptions<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">onConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'连接成功 - onSuccess'</span><span class="token punctuation">)</span>
	<span class="token comment">//订阅</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>connectParams<span class="token punctuation">.</span>msgTopicName<span class="token punctuation">)</span> <span class="token comment">//订阅</span>
	<span class="token comment">// var t = '上线';</span>
	<span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	t<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>connectParams<span class="token punctuation">.</span>msgTopicName
	t<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">0</span>
	t<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Paho<span class="token punctuation">.</span>Message</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
	message<span class="token punctuation">.</span>destinationName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>connectParams<span class="token punctuation">.</span>statusTopicName 
	<span class="token comment">//发送上线消息</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">failConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 从新连接</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'连接失败 - onFailure'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">onMessageArrived</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mqtt消息到达 - onMessageArrived:'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">onConnectionLost</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 从新连接</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mqtt失去连接 - responseObject:'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>以上我们完成mqtt连接操作，以及一些事件监听。</p> 
<h5><a id="_152"></a>发送消息以及聊天记录缓存处理？</h5> 
<p><img src="https://images2.imgbox.com/71/a6/e1r7iYZV_o.jpg" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>到这里就已经是聊天功能的核心了</p> 
</blockquote> 
<blockquote> 
 <p>首先是消息分组，消息按发送时间段去缓存分组，实现起来的思路大概就是，当我们<code>发送</code>或者<code>收到</code>消息的时候<br> 我们只需要拿当前你要发送或者你接受的消息发送时间（endTime）去与我们本地缓存记录的最新一条消息去做对比</p> 
</blockquote> 
<pre><code class="prism language-javascript">
<span class="token comment">//举个栗子</span>
<span class="token comment">//最新消息的发送时间</span>
<span class="token keyword">let</span> newEndtime <span class="token operator">=</span> <span class="token number">1624418176356</span><span class="token punctuation">,</span>

<span class="token comment">//本地缓存最新消息发送时间</span>
oldEndtime <span class="token operator">=</span> <span class="token number">1624418212889</span> 

<span class="token comment">//120000（毫秒）2分钟</span>

newEndtime <span class="token operator">-</span> oldEndtime <span class="token operator">&lt;=</span> <span class="token number">120000</span> <span class="token operator">?</span>  创建新分组 ： 当前分组添加消息

</code></pre> 
<blockquote> 
 <p>时间分组的实现思路就是这样，我们只需要根据消息发送时间去计算，判断是不是两分钟内的消息，如果是我们直接在当前消息分组（<code>messageArr[messageArr.length-1].messages.Push</code>）一条新消息，如果大于两分钟了，我们就直接从新创建一个分组，也就是<code>messageArr.Push</code>,Push过在把最新消息更新到本地历史消息即可。</p> 
</blockquote> 
<h5><a id="_179"></a>历史消息上拉加载？</h5> 
<blockquote> 
 <p><code>本地存储</code>数据与<code>服务端数据混合加载</code>，因小程序本地存储限制我们前端只存100条聊天数据，本地的数据加载完以后，在上拉我们就要调用分页去获取历史消息了，</p> 
</blockquote> 
<p><strong>注意了：历史消息的分页，会有一个分页参数就是我们messageArr消息记录最后一条消息的endTime（发送时间），然后把服务端返回历史消息合并到我们messageArr里，消息加载总体就这些逻辑，</strong></p> 
<blockquote> 
 <p><strong>以上步骤我们就可以实现一个基本的聊天功能了 思路大体就是这样 有疑问的同学可以私信我</strong></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/28/e9/eBGuFtMd_o.jpg" alt="在这里插入图片描述"></p> 
<div align="center"> 
 <b>喜欢下方小程序的私信送源码</b> 
</div> 
<div align="center"> 
 <img src="https://images2.imgbox.com/c1/a0/VGImVIG2_o.jpg" width="300"> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/744963a52269f1466659136a1d5c4586/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">华为HCIA进阶笔记：PPPoE原理与配置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ea83ce965ed6116c9fd60e085d22be70/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vue服务端渲染SSR</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>