<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Vue 源码之Vue 响应式原理【完整版】 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Vue 源码之Vue 响应式原理【完整版】" />
<meta property="og:description" content="写在前面 由于昨天写的文章 Vue 源码之Vue视图更新原理【一】与今天的内容代码有些相关联，所以开头先进行简单的回顾阐述，也方便对内容进行完整的阅读。
Vue 视图更新原理 Vue 的视图更新原理主要涉及的是响应式相关API Object.defineProperty 的使用，它的作用是为对象的某个属性对外提供 get、set 方法，从而实现外部对该属性的读和写操作时能够被内部监听，实现后续的同步视图更新功能
一、实现响应式的核心API：Object.defineProperty Object.defineProperty的用法介绍：MDN-Object.defineProperty，下面是模拟 Vue data 值的更新对API接口进行初步了解
// 模拟 Vue 中的 data const data = {} // 对外不可见的内部变量 let _myName = &#39;Yimwu&#39; // 响应式监听 data 中的 name Object.defineProperty(data, &#34;name&#34;, { // 使用 data.name 时 get 方法被调用，返回内部存储变量值 get: () =&gt; { console.log(&#39;get&#39;) return _myName }, // 使用 data.name = xxx 修改变量时，set 方法被调用，设置内部存储变量值 set: (newVal) =&gt; { console.log(&#39;set&#39;) _myName = newVal } }) console." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/82342eb353d384e0582b185bc31b96e3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-28T08:33:26+08:00" />
<meta property="article:modified_time" content="2022-03-28T08:33:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Vue 源码之Vue 响应式原理【完整版】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>写在前面</h2> 
<p>由于昨天写的文章 <a href="https://blog.csdn.net/weixin_42524603/article/details/123766521?spm=1001.2014.3001.5501">Vue 源码之Vue视图更新原理【一】</a>与今天的内容代码有些相关联，所以开头先进行简单的回顾阐述，也方便对内容进行完整的阅读。</p> 
<h2><a id="Vue__2"></a>Vue 视图更新原理</h2> 
<p><strong>Vue 的视图更新原理</strong>主要涉及的是响应式相关API <strong>Object.defineProperty</strong> 的使用，它的作用是为对象的某个属性对外提供 <strong>get、set</strong> 方法，从而实现<strong>外部对该属性的读和写操作时能够被内部监听</strong>，实现后续的同步视图更新功能</p> 
<h3><a id="APIObjectdefineProperty_4"></a>一、实现响应式的核心API：Object.defineProperty</h3> 
<p>Object.defineProperty的用法介绍：<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" rel="nofollow">MDN-Object.defineProperty</a>，下面是模拟 Vue data 值的更新对API接口进行初步了解</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 模拟 Vue 中的 data</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token comment">// 对外不可见的内部变量</span>
<span class="token keyword">let</span> _myName <span class="token operator">=</span> <span class="token string">'Yimwu'</span>
<span class="token comment">// 响应式监听 data 中的 name</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 使用 data.name 时 get 方法被调用，返回内部存储变量值</span>
    <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> _myName
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 使用 data.name = xxx 修改变量时，set 方法被调用，设置内部存储变量值</span>
    <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">)</span>
      _myName <span class="token operator">=</span> newVal
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// 输出 Yimwu  get</span>
data<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Mr.Wu'</span> <span class="token comment">// 输出 set (监听成功)</span>
</code></pre> 
<h3><a id="_27"></a>二、视图更新初步实现</h3> 
<h4><a id="1updateView_28"></a>1、updateView</h4> 
<p>为了方便 <strong>模拟视图更新</strong>，这里创建了一个函数 <strong>updateView</strong> ，当数据更新时，调用 updateView ，模拟进行了视图更新（在 <strong>Vue 中表现为</strong> template 模板中引用了该变量值的 <strong>DOM 元素的变化</strong>）</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 验证更新是否触发</span>
<span class="token keyword">function</span> <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'视图更新'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2defineReactive_36"></a>2、defineReactive</h4> 
<p>创建函数 defineReactive ，对 API Object.defineProperty 进行封装，接受三个参数，监听的目标对象、属性名，以及属性值，<strong>一个target(对象)通过调用 defineReactive 就能够实现对 key（对应属性名）进行监听</strong>，类比到 Vue 中:</p> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>            <span class="token comment">// data ---&gt; target</span>
        name<span class="token punctuation">:</span> <span class="token string">'yimwu'</span>  <span class="token comment">// name ---&gt; key</span>
    <span class="token punctuation">}</span>                  <span class="token comment">// 'yimwu'---&gt; value</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> 
<p>具体实现如下：</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 重新定义属性，监听起来</span>
<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">// value 一直在闭包中，此处设置完成后，下次get能够获取最新设置的值</span>
      <span class="token comment">// 这里有个小优化，若相同则不触发更新</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>newVal <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        value <span class="token operator">=</span> newVal
        <span class="token comment">// 触发更新</span>
        <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3observe_67"></a>3、observe</h4> 
<p>observe 主要是用于对对象中的每个属性进行 defineReactive 监听</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 监听对象属性</span>
<span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> target <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 不是数组或对象不适合监听</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// 将对象的属性用 defineProperty 重新定义</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="4_82"></a>4、完整代码以及测试例子</h4> 
<pre><code class="prism language-javascript"><span class="token comment">// 验证更新是否触发</span>
<span class="token keyword">function</span> <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'视图更新'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 重新定义属性，监听起来</span>
<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">// value 一直在闭包中，此处设置完成后，下次get能够获取最新设置的值</span>
      <span class="token comment">// 这里有个小优化，若相同则不触发更新</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>newVal <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        value <span class="token operator">=</span> newVal
        <span class="token comment">// 触发更新</span>
        <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听对象属性</span>
<span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> target <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 不是数组或对象不适合监听</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// 将对象的属性用 defineProperty 重新定义</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 准备数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  name<span class="token punctuation">:</span> <span class="token string">'Yimwu'</span><span class="token punctuation">,</span>
  id<span class="token punctuation">:</span> <span class="token number">001</span><span class="token punctuation">,</span>
  information<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    tel<span class="token punctuation">:</span> <span class="token string">'135xxxxx354'</span><span class="token punctuation">,</span>
    email<span class="token punctuation">:</span> <span class="token string">'15xxxxx@xx.com'</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听数据</span>
<span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token comment">// 测试</span>
data<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'YI'</span> <span class="token comment">// (监听成功)输出 --&gt; 数据更新</span>
data<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> num<span class="token punctuation">:</span> <span class="token number">21</span> <span class="token punctuation">}</span>  <span class="token punctuation">(</span>监听成功<span class="token punctuation">)</span>输出 <span class="token operator">--</span><span class="token operator">&gt;</span> 数据更新
data<span class="token punctuation">.</span>information<span class="token punctuation">.</span>tel <span class="token operator">=</span> <span class="token string">'13456xxx234'</span> <span class="token comment">// (监听失败)</span>
data<span class="token punctuation">.</span>age<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">110</span> <span class="token comment">// (监听失败)</span>
</code></pre> 
<h4><a id="5_137"></a>5、视图更新优化（实现对象深度监听）</h4> 
<p>从上面测试的例子可以看出，对于<code>data.information.tel</code>这种<strong>嵌套的对象</strong>，初版的 defineReactive 是<strong>无法进行监听</strong>的，解决的方法也很简单，<strong>对对象的所有属性进行监听函数的递归调用</strong>，即<strong>在执行 Object.defineProperty 前先进行递归调用 observe</strong>，如果该属性为<strong>对象</strong>，则 observe 会<strong>递归调用<br> defineReactive</strong>，不是则observe 直接返回，继续执行 Object.defineProperty，完整代码及测试例子如下：</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 重新定义属性，监听起来</span>
<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 再次用value嵌套调用 observe 深，若为对象，则进行进一步监听，若非value非对象则直接返回</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">// value 一直在闭包中，此处设置完成后，下次get能够获取最新设置的值</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>newVal <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        value <span class="token operator">=</span> newVal
        <span class="token comment">// 触发更新</span>
        <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 测试数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  name<span class="token punctuation">:</span> <span class="token string">'Yimwu'</span><span class="token punctuation">,</span>
  id<span class="token punctuation">:</span> <span class="token number">001</span><span class="token punctuation">,</span>
  information<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    tel<span class="token punctuation">:</span> <span class="token string">'135xxxxx354'</span><span class="token punctuation">,</span>
    email<span class="token punctuation">:</span> <span class="token string">'15xxxxx@xx.com'</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听数据</span>
<span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token comment">// 测试</span>
data<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'YI'</span> <span class="token comment">// (监听成功)输出 --&gt; 数据更新</span>
data<span class="token punctuation">.</span>information<span class="token punctuation">.</span>tel <span class="token operator">=</span> <span class="token string">'00000000000'</span> <span class="token punctuation">(</span>监听成功<span class="token punctuation">)</span>输出 <span class="token operator">--</span><span class="token operator">&gt;</span> 数据更新
</code></pre> 
<h4><a id="6_Vueset_176"></a>6、如何理解 Vue.set</h4> 
<p>在使用 Vue 的过程中，我们或许都有过这样子的经历，在 data 中定义了一个对象，然后在程序执行过程中给他动态添加了属性，然后对当我们<strong>对该新增属性进行值更新时并没有触发视图更新</strong>，作为Vue初学者时，将 data 响应式当成黑盒对待，就很难理解它为啥不更新，而今天拨开原理后，这里就很容易理解了</p> 
<pre><code class="prism language-javascript">data<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> num<span class="token punctuation">:</span> <span class="token number">010</span> <span class="token punctuation">}</span> <span class="token comment">// (监听成功)输出 --&gt; 数据更新</span>
data<span class="token punctuation">.</span>id<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">110</span> <span class="token comment">// (监听失败)</span>
</code></pre> 
<p>如上图所示，当<strong>给 id 赋值</strong>为一个对象时，<strong>触发了 id 的数据更新</strong>，而当<strong>对 id.num 进行赋值</strong>时，<strong>未触发数据更新</strong>，根据 <strong>步骤5</strong> 的代码可以看出，这其实是因为执行 set 的时候没有对设置的 value 进行处理，导致了 num 属性没有被设置监听。在这里的实例中，解决办法就比较简单粗暴了，只需要直接在 set 里将 set 接受的 value 放到 observe 函数里执行，就能够对 value 进行监听了，下面是最终的<strong>defineReactive</strong>函数代码以及测试例子：</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 重新定义属性，监听起来</span>
<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 再次用value嵌套调用 observe 深，若为对象，则进行进一步监听，若非value非对象则直接返回</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 对于新增加的值进行深度监听，如 data.id = { num: 101 }, 新增加的 num 也将能够被监听到</span>
      <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
      <span class="token comment">// value 一直在闭包中，此处设置完成后，下次get能够获取最新设置的值</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>newVal <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        value <span class="token operator">=</span> newVal
        <span class="token comment">// 触发更新</span>
        <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  name<span class="token punctuation">:</span> <span class="token string">'Yimwu'</span><span class="token punctuation">,</span>
  id<span class="token punctuation">:</span> <span class="token number">001</span><span class="token punctuation">,</span>
  information<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    tel<span class="token punctuation">:</span> <span class="token string">'135xxxxx354'</span><span class="token punctuation">,</span>
    email<span class="token punctuation">:</span> <span class="token string">'15xxxxx@xx.com'</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听数据</span>
<span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token comment">// 测试</span>
data<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> num<span class="token punctuation">:</span> <span class="token number">010</span> <span class="token punctuation">}</span> <span class="token comment">// (监听成功)输出 --&gt; 数据更新</span>
data<span class="token punctuation">.</span>id<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">110</span> <span class="token comment">// (监听成功)输出 --&gt; 数据更新</span>
</code></pre> 
<h3><a id="_222"></a>三、视图更新优化———实现数组监听</h3> 
<p>在上一节【初步实现】中，已经实现了对对象的所有属性、嵌套属性进行监听，但是，如果 <strong>某个属性是一个数组</strong> 呢，对数组进行 push、pop 等操作，会触发更新吗？很显然是不会的，因为 <strong>Object.defineProperty</strong> 并不具备监听数组内部变化的能力，那么我们该如何解决呢————重写数组原型上的方法。</p> 
<h4><a id="1_224"></a>1、定义监听数组的原型</h4> 
<p>我们都知道，在 JS 中，任何对象都有原型，而我们的目的是通过重写数组原型上方法（push、pop等）实现监听，而作为库或是框架，我们都不应该去改变全局原型上的任何原生方法或者属性，污染全局环境，所以，这里分3步：</p> 
<blockquote> 
 <p>第一步：创建一个对象，将数组的原型赋值给该对象<br> <code>const oldArrayProperty = Array.prototype</code><br> 第二步：创建新对象，原型指向该对象<br> <code>const arrProperty = Object.create(oldArrayProperty)</code><br> 第三步：重写该对象上的方法<br> <code>arrProperty.push = function(){} ...</code><br> <code>arrProperty.pop = function(){} ...</code></p> 
</blockquote> 
<pre><code class="prism language-javascript"><span class="token comment">// 重新定义数组原型，加入触发更新的机制</span>
<span class="token keyword">const</span> oldArrayProperty <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype
<span class="token comment">// 创建新对象，原型指向oldArrayProperty</span>
<span class="token keyword">const</span> arrProperty <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>oldArrayProperty<span class="token punctuation">)</span>
<span class="token comment">// 重写原型上的方法（可以所有都重写，这里只进行少量举例）</span>
<span class="token comment">// arrProperty.push = function(){} </span>
<span class="token comment">// arrProperty.pop = function(){}</span>
<span class="token comment">// 优化写法</span>
<span class="token keyword">const</span> methods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'push'</span><span class="token punctuation">,</span><span class="token string">'pop'</span><span class="token punctuation">,</span><span class="token string">'shift'</span><span class="token punctuation">,</span><span class="token string">'unshift'</span><span class="token punctuation">,</span><span class="token string">'splice'</span><span class="token punctuation">]</span>
methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>method <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  arrProperty<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">updateView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    Array<span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">...</span>arguments<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="2_250"></a>2、将需要监听的数组的原型指向自定义的特殊原型</h4> 
<p>对原来的 observe 进行修改，加入数组判断，如果是数组则修改该数组的原型，至此，数组监听完成，下面是 observe 修改后代码以及测试例子</p> 
<pre><code class="prism language-javascript"><span class="token comment">// 监听对象属性</span>
<span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> target <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 不是数组或对象</span>
    <span class="token keyword">return</span> target
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果是数组则修改该数组的原型</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    target<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> arrProperty
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 重新定义属性</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 测试数据</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  myCars<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'Bugatti'</span><span class="token punctuation">,</span><span class="token string">'Koenigsegg'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听数据</span>
<span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token comment">// 测试</span>
data<span class="token punctuation">.</span>myCars<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'AE86'</span><span class="token punctuation">)</span> <span class="token comment">// (监听成功)输出 --&gt; 数据更新</span>
</code></pre> 
<h3><a id="_281"></a>四、性能分析</h3> 
<p>为了实现对象的每个嵌套 <strong>属性监听</strong> 的 <strong>全覆盖</strong> ，需要对对象的属性进行 <strong>深度遍历，递归到底</strong>，所以对于性能的损耗是非常大的，特别是在初始化阶段，如果有大量的层级非常高的对象进行响应式监听的绑定，会 <strong>极大耗费</strong> 初始化时的 <strong>性能</strong>，导致拖慢 <strong>First Paint Time</strong></p> 
<h2><a id="_283"></a>总结</h2> 
<p>当使用 Vue 一段时间后，或者说已经能够<strong>熟练使用 Vue</strong> 的时候，我们就需要开始进一步挖掘 Vue 的高级用法、原理等，从根本上学习、了解 Vue 的 <strong>底层原理</strong>，通过了解 Vue 的相关 <strong>设计原理</strong> 后，能够使得我们在平时开发的过程中，突破 <strong>用得爽</strong> 这一层次，来到 <strong>用得好、用得巧</strong> 这样一种更加高级的层次，<strong>从底层原理的角度出发，将是性能优化以及架构设计的最好突破口！</strong></p> 
<h2><a id="_285"></a>写在最后</h2> 
<p>博主接下来将持续更新好文，欢迎关注博主哟！！<br> 如果文章对您有帮助麻烦亲<strong>点赞、收藏 + 关注</strong>和博主一起成长哟！！❤❤❤</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3e7d885b69022fc09a9083a7aaa6e8b2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">spring、springboot集成 log4j日志、log4j2日志以及slf4j</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/24038509841f38d8294d71b248cd2b9a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【linux kernel】一文总结initramfs的使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>