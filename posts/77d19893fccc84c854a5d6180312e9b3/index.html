<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Spring Boot】错误处理及流程解析 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Spring Boot】错误处理及流程解析" />
<meta property="og:description" content="一、错误处理 默认情况下，Spring Boot提供/error处理所有错误的映射
对于机器客户端（例如PostMan），它将生成JSON响应，其中包含错误，HTTP状态和异常消息的详细信息（如果设置了拦截器，需要在请求头中塞入Cookie相关参数）
对于浏览器客户端，响应一个“ whitelabel”错误视图，以HTML格式呈现相同的数据
另外，templates下面error文件夹中的4xx，5xx页面会被自动解析
二、底层相关组件 那么Spring Boot是怎么实现上述的错误页相关功能的呢？
我们又要来找一下相关源码进行分析了
首先我们先了解一个概念：@Bean配置的类的默认id是方法的名称，但是我们可以通过value或者name给这个bean取别名，两者不可同时使用
我们进入ErrorMvcAutoConfiguration，看这个类名应该是和错误处理的自动配置有关，我们看下这个类做了什么
向容器中注册类型为DefaultErrorAttributes，id为errorAttributes的bean（管理错误信息，如果要自定义错误页面打印的字段，就自定义它），这个类实现了ErrorAttributes, HandlerExceptionResolver（异常处理解析器接口）, Ordered三个接口 @Bean @ConditionalOnMissingBean( value = {ErrorAttributes.class}, search = SearchStrategy.CURRENT ) public DefaultErrorAttributes errorAttributes() { return new DefaultErrorAttributes(); } 点进去后发现，这个类是和我们响应页面中的message、error等字段有关
向容器中注册一个id为basicErrorController的控制器bean（管理错误相应逻辑，不想返回json或者错误视图，就自定义它） @Bean @ConditionalOnMissingBean( value = {ErrorController.class}, search = SearchStrategy.CURRENT ) public BasicErrorController basicErrorController(ErrorAttributes errorAttributes, ObjectProvider&lt;ErrorViewResolver&gt; errorViewResolvers) { return new BasicErrorController(errorAttributes, this.serverProperties.getError(), (List)errorViewResolvers.orderedStream().collect(Collectors.toList())); } 这个控制器就和前面我们返回json或者错误视图有关
声明类型为DefaultErrorViewResolver，id为conventionErrorViewResolver的bean（管理错误视图跳转路径，如果要改变跳转路径，就自定义它） @Configuration( proxyBeanMethods = false ) @EnableConfigurationProperties({WebProperties.class, WebMvcProperties.class}) static class DefaultErrorViewResolverConfiguration { private final ApplicationContext applicationContext; private final Resources resources; DefaultErrorViewResolverConfiguration(ApplicationContext applicationContext, WebProperties webProperties) { this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/77d19893fccc84c854a5d6180312e9b3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-18T22:55:45+08:00" />
<meta property="article:modified_time" content="2022-09-18T22:55:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Spring Boot】错误处理及流程解析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_0"></a>一、错误处理</h4> 
<p>默认情况下，Spring Boot提供/error处理所有错误的映射</p> 
<p>对于机器客户端（例如PostMan），它将生成JSON响应，其中包含错误，HTTP状态和异常消息的详细信息（如果设置了拦截器，需要在请求头中塞入Cookie相关参数）<br> <img src="https://images2.imgbox.com/ae/f5/AYzai99d_o.png" alt="在这里插入图片描述"></p> 
<p>对于浏览器客户端，响应一个“ whitelabel”错误视图，以HTML格式呈现相同的数据<br> <img src="https://images2.imgbox.com/15/04/TmmGY9eB_o.png" alt="在这里插入图片描述"></p> 
<p>另外，templates下面error文件夹中的4xx，5xx页面会被自动解析</p> 
<h4><a id="_11"></a>二、底层相关组件</h4> 
<p>那么Spring Boot是怎么实现上述的错误页相关功能的呢？<br> 我们又要来找一下相关源码进行分析了</p> 
<p>首先我们先了解一个概念：@Bean配置的类的默认id是方法的名称，但是我们可以通过value或者name给这个bean取别名，两者不可同时使用</p> 
<p>我们进入<code>ErrorMvcAutoConfiguration</code>，看这个类名应该是和错误处理的自动配置有关，我们看下这个类做了什么</p> 
<ul><li>向容器中注册类型为<code>DefaultErrorAttributes</code>，id为<code>errorAttributes</code>的bean（管理错误信息，如果要自定义错误页面打印的字段，就自定义它），这个类实现了ErrorAttributes, HandlerExceptionResolver（异常处理解析器接口）, Ordered三个接口</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token class-name">ErrorAttributes</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    search <span class="token operator">=</span> <span class="token class-name">SearchStrategy</span><span class="token punctuation">.</span>CURRENT
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">DefaultErrorAttributes</span> <span class="token function">errorAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultErrorAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>点进去后发现，这个类是和我们响应页面中的message、error等字段有关<br> <img src="https://images2.imgbox.com/59/00/KgB2CenR_o.png" alt="在这里插入图片描述"></p> 
<ul><li>向容器中注册一个id为<code>basicErrorController</code>的控制器bean（管理错误相应逻辑，不想返回json或者错误视图，就自定义它）</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token class-name">ErrorController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    search <span class="token operator">=</span> <span class="token class-name">SearchStrategy</span><span class="token punctuation">.</span>CURRENT
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">BasicErrorController</span> <span class="token function">basicErrorController</span><span class="token punctuation">(</span><span class="token class-name">ErrorAttributes</span> errorAttributes<span class="token punctuation">,</span> <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ErrorViewResolver</span><span class="token punctuation">&gt;</span></span> errorViewResolvers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BasicErrorController</span><span class="token punctuation">(</span>errorAttributes<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverProperties<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">)</span>errorViewResolvers<span class="token punctuation">.</span><span class="token function">orderedStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个控制器就和前面我们返回json或者错误视图有关<br> <img src="https://images2.imgbox.com/6c/ac/aoBkrEyh_o.png" alt="在这里插入图片描述"></p> 
<ul><li>声明类型为<code>DefaultErrorViewResolver</code>，id为<code>conventionErrorViewResolver</code>的bean（管理错误视图跳转路径，如果要改变跳转路径，就自定义它）</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>
   proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">WebProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">WebMvcProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DefaultErrorViewResolverConfiguration</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Resources</span> resources<span class="token punctuation">;</span>

   <span class="token class-name">DefaultErrorViewResolverConfiguration</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">,</span> <span class="token class-name">WebProperties</span> webProperties<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext <span class="token operator">=</span> applicationContext<span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>resources <span class="token operator">=</span> webProperties<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Bean</span>
   <span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">DispatcherServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">ErrorViewResolver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token class-name">DefaultErrorViewResolver</span> <span class="token function">conventionErrorViewResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultErrorViewResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个类中，解释了为什么前面会根据不同的状态码转向不同的错误页<br> <img src="https://images2.imgbox.com/8b/4a/iM6oQPXV_o.png" alt="在这里插入图片描述"></p> 
<ul><li>声明一个静态内部类<code>WhitelabelErrorViewConfiguration</code>，它与错误视图配置相关，这个类中声明了一个id为error的视图对象提供给<code>basicErrorController</code>中使用，还定义了视图解析器<code>BeanNameViewResolver </code>，它会根据返回的视图名作为组件的id去容器中找View对象</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>
   proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>
   prefix <span class="token operator">=</span> <span class="token string">"server.error.whitelabel"</span><span class="token punctuation">,</span>
   name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"enabled"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
   matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token class-name">ErrorMvcAutoConfiguration<span class="token punctuation">.</span>ErrorTemplateMissingCondition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WhitelabelErrorViewConfiguration</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ErrorMvcAutoConfiguration<span class="token punctuation">.</span>StaticView</span> defaultErrorView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorMvcAutoConfiguration<span class="token punctuation">.</span>StaticView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">protected</span> <span class="token class-name">WhitelabelErrorViewConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>
       name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">}</span>
   <span class="token punctuation">)</span>
   <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>
       name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">}</span>
   <span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token class-name">View</span> <span class="token function">defaultErrorView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultErrorView<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token annotation punctuation">@Bean</span>
   <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
   <span class="token keyword">public</span> <span class="token class-name">BeanNameViewResolver</span> <span class="token function">beanNameViewResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token class-name">BeanNameViewResolver</span> resolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanNameViewResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       resolver<span class="token punctuation">.</span><span class="token function">setOrder</span><span class="token punctuation">(</span><span class="token number">2147483637</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> resolver<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>另外还声明了一个静态内部类StaticView，这里面涉及错误视图的渲染等相关操作</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">StaticView</span> <span class="token keyword">implements</span> <span class="token class-name">View</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MediaType</span> TEXT_HTML_UTF8<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token class-name">StaticView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> model<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isCommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
           logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
           response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span>TEXT_HTML_UTF8<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">StringBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">Object</span> timestamp <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">Object</span> message <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">Object</span> trace <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"trace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h4><a id="_135"></a>三、异常处理流程</h4> 
<p>为了了解Spring Boot的异常处理流程，我们写一个demo进行debug</p> 
<p>首先写一个会发生算术运算异常的接口<code>/test_error</code></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 测试报错信息
 * @return 跳转错误页面
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/test_error"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后放置一个错误页面5xx.html于templates下的error文件夹中</p> 
<pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.thymeleaf.org<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0, maximum-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>author<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ThemeBucket<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>shortcut icon<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>image/png<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>500 Page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>css/style.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>css/style-responsive.css<span class="token punctuation">"</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries --&gt;</span>
  <span class="token comment">&lt;!--[if lt IE 9]&gt;
  &lt;script src="js/html5shiv.js"&gt;&lt;/script&gt;
  &lt;script src="js/respond.min.js"&gt;&lt;/script&gt;
  &lt;![endif]--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>error-page<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>container <span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>error-wrapper text-center<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>images/500-error.png<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>OOOPS!!!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${message}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Something went wrong.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>nrml-txt<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${trace}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Why not try refreshing you page? Or you can <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>contact our support<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> if the problem persists.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>back-btn<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index.html<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${status}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span> Back To Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- Placed js at the end of the document so the pages load faster --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>js/jquery-1.10.2.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>js/jquery-migrate-1.2.1.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>js/bootstrap.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>js/modernizr.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--common scripts for all pages--&gt;</span>
<span class="token comment">&lt;!--&lt;script src="js/scripts.js"&gt;&lt;/script&gt;--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>然后我们开启debug模式，发送请求</p> 
<p>首先，我们的断点还是来到<code>DispatcherServlet</code>类下的<code>doDispatch()</code>方法<br> 经过<code>mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</code>调用目标方法之后，他会返回相关错误信息，并将其塞入dispatchException这个对象</p> 
<p>然后调用<code>this.processDispatchResult(processedRequest, response, mappedHandler, mv, (Exception)dispatchException);</code>处理调度结果<br> <img src="https://images2.imgbox.com/05/ba/GMB5efvT_o.png" alt="在这里插入图片描述"></p> 
<p>然后他会在<code>processDispatchResult()</code>中经过判断是否存在异常，异常不为空，调用<code>processHandlerException()</code>方法，这里它会遍历系统中所有的异常处理解析器，哪个解析器返回结果不为null，就结束循环</p> 
<p>在调用<code>DefaultErrorAttributes</code>时，它会将错误中的信息放入request请求域中（我们后面模板引擎页面解析会用到）</p> 
<p>遍历完所有解析器，我们发现他们都不能返回一个不为空的<code>ModelAndView</code>对象，于是它会继续抛出异常<br> <img src="https://images2.imgbox.com/44/81/sccdKjtt_o.png" alt="在这里插入图片描述"></p> 
<p>当系统发现没有任何人能处理这个异常时，底层就会发送 /error 请求，它就会被我们上面介绍的<code>BasicErrorController</code>下的<code>errorHtml()</code>方法处理<br> <img src="https://images2.imgbox.com/0c/ae/ygvf6M15_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/55/a3/TWkSQ5RS_o.png" alt="在这里插入图片描述"></p> 
<p>这个方法会通过<code>ModelAndView modelAndView = this.resolveErrorView(request, response, status, model);</code>去遍历系统中所有的错误视图解析器，如果调用解析器的<code>resolveErrorView()</code>方法返回结果不为空就结束循环<br> <img src="https://images2.imgbox.com/f8/73/eE1XMUrK_o.png" alt="在这里插入图片描述"><br> 系统中只默认注册了一个错误视图解析器，也就是我们上面介绍的<code>DefaultErrorViewResolver</code>，跟随debug断点我们得知，这个解析器会把<code>error+响应状态码</code>作为错误页的地址，最终返回给我们的视图地址为<code>error/5xx.html</code><br> <img src="https://images2.imgbox.com/5b/30/TA7GPd55_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_223"></a>四、定制错误处理逻辑</h4> 
<h5><a id="1_224"></a>1、自定义错误页面</h5> 
<p>error下的4xx.html和5xx.html，根据我们上面了解的<code>DefaultErrorViewResolver</code>类可以，它的<code>resolveErrorView()</code>方法在进行错误页解析时，如果有精确的错误状态码页面就匹配精确，没有就找 4xx.html，如果都没有就转到系统默认的错误页</p> 
<h5><a id="2_227"></a>2、使用注解或者默认的异常处理</h5> 
<ul><li>@ControllerAdvice+@ExceptionHandler处理全局异常，我们结合一个demo来了解一下用法<br> 首先我们创建一个类用来处理全局异常</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>decade<span class="token punctuation">.</span>exception</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ControllerAdvice</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ExceptionHandler</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@ControllerAdvice</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyExceptionHandler</span> <span class="token punctuation">{<!-- --></span>

   <span class="token comment">// 指定该方法处理某些指定异常，@ExceptionHandler的value可以是数组，这里我们指定该方法处理数学运算异常和空指针异常</span>
   <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token class-name">ArithmeticException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handleArithmeticException</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"异常信息为：{}"</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// 打印完错误信息后，返回登录页</span>
       <span class="token keyword">return</span> <span class="token string">"login"</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们还是使用上面的会发生算术运算异常的接口<code>/test_error</code>进行测试<br> 请求接口后发现，页面跳转到登录页了<br> <img src="https://images2.imgbox.com/ab/0e/ONDZEwW1_o.png" alt="在这里插入图片描述"><br> 为什么没有再走到5xx.html呢？<br> 因为@ControllerAdvice+@ExceptionHandler的底层是<code>ExceptionHandlerExceptionResolver</code>来处理的</p> 
<p>这样在进入<code>DispatcherServlet</code>类下的<code>processHandlerException()</code>方法时，就会调用<code>ExceptionHandlerExceptionResolver</code>这个异常处理解析器，从而跳转到我们自己创建的异常处理类进行异常处理，然后返回不为null的ModelAndView对象给它，终止遍历，不会再发送<code>/error</code>请求</p> 
<ul><li>@ResponseStatus+自定义异常<br> 首先我们自定义一个异常类</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>decade<span class="token punctuation">.</span>exception</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ResponseStatus</span><span class="token punctuation">;</span>

<span class="token comment">// code对应错误码，reason对应message</span>
<span class="token annotation punctuation">@ResponseStatus</span><span class="token punctuation">(</span>code <span class="token operator">=</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>METHOD_NOT_ALLOWED<span class="token punctuation">,</span> reason <span class="token operator">=</span> <span class="token string">"自定义异常"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token punctuation">{<!-- --></span>

   <span class="token keyword">public</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后写一个接口去抛出自定义异常</p> 
<pre><code class="prism language-java"><span class="token comment">/**
* 测试报错信息
* @return 跳转错误页面
*/</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/test_responseStatus"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testResponseStatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"param"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> param<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"test_responseStatus"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token string">"main"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后我们调用接口，可以得到，跳转到了4xx.html，但是状态码和message都和我们自己定义的匹配<br> <img src="https://images2.imgbox.com/a3/0e/1mOxPxKB_o.png" alt="在这里插入图片描述"><br> 那么原理是什么呢？我们还是从<code>DispatcherServlet</code>类下的<code>processHandlerException()</code>方法开始看</p> 
<p>当我们抛出自定义异常时，由于前面@ControllerAdvice+@ExceptionHandler修饰的类没有指定处理这个异常，所以循环走到下一个异常处理解析器<code>ResponseStatusExceptionResolver</code></p> 
<p>我们分析一下这里的代码</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">ModelAndView</span> <span class="token function">doResolveException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">ResponseStatusException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveResponseStatusException</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ResponseStatusException</span><span class="token punctuation">)</span>ex<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 由于我们自定义异常类使用了@ResponseStatus注解修饰，所以我们这里获取到的status信息不为空</span>
        <span class="token class-name">ResponseStatus</span> status <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ResponseStatus</span><span class="token punctuation">)</span><span class="token class-name">AnnotatedElementUtils</span><span class="token punctuation">.</span><span class="token function">findMergedAnnotation</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ResponseStatus</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveResponseStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">protected</span> <span class="token class-name">ModelAndView</span> <span class="token function">resolveResponseStatus</span><span class="token punctuation">(</span><span class="token class-name">ResponseStatus</span> responseStatus<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取@ResponseStatus注解的code和reason作为状态码和message</span>
	<span class="token keyword">int</span> statusCode <span class="token operator">=</span> responseStatus<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> reason <span class="token operator">=</span> responseStatus<span class="token punctuation">.</span><span class="token function">reason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">applyStatusAndReason</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token class-name">ModelAndView</span> <span class="token function">applyStatusAndReason</span><span class="token punctuation">(</span><span class="token keyword">int</span> statusCode<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> reason<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        response<span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> resolvedReason <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageSource <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageSource<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>reason<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">,</span> reason<span class="token punctuation">,</span> <span class="token class-name">LocaleContextHolder</span><span class="token punctuation">.</span><span class="token function">getLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> reason<span class="token punctuation">;</span>
		<span class="token comment">// 发送/error请求，入参为@ResponseStatus注解的code和reason</span>
        response<span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">,</span> resolvedReason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 返回一个modelAndView</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>经过debug我们知道，<code>ResponseStatusExceptionResolver</code>这个异常处理解析器返回了一个空的ModelAndView对象给我们，而且还通过<code>response.sendError(statusCode, resolvedReason);</code>发送了/error请求</p> 
<p>这样就又走到了上面的第三节处理/error请求的流程中，从而带着我们@ResponseStatus注解的code和reason跳转到了4xx.html页面，这样就能解释为什么4xx.html页面中的状态码和message都是我们自定义的了</p> 
<ul><li>如果没有使用上述2种方法处理指定异常或处理我们自己自定义的异常，那么系统就会按照Spring底层的异常进行处理，如 请求方法不支持异常等，都是使用<code>DefaultHandlerExceptionResolver</code>这个异常处理解析器进行处理的<br> 我们分析这个类的<code>doResolveException()</code>方法得知，它最后也会发送<code>/error</code>请求，从而转到4xx.html或者5xx.html页面<br> <img src="https://images2.imgbox.com/01/58/YC5618ho_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1c/6b/WKNk8Q1r_o.png" alt="在这里插入图片描述"></li></ul> 
<h5><a id="3_343"></a>3、自定义异常处理解析器</h5> 
<p>使用@Component注解，并实现<code>HandlerExceptionResolver</code>接口来自定义一个异常处理解析器</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>decade<span class="token punctuation">.</span>exception</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Order</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">HandlerExceptionResolver</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ModelAndView</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">// 将优先级提到第一位，Order越小，优先级越高，所以我们这里设置int的最小值</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomExceptionHandler</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerExceptionResolver</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">resolveException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            response<span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"自己定义的异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当我们把优先级提到最高时，前面的那些异常处理解析器都会失效，这时我们的自定义异常处理解析器可以作为默认的全局异常处理规则<br> <img src="https://images2.imgbox.com/28/a5/IBz7kw5P_o.png" alt="在这里插入图片描述"></p> 
<p>值得注意的是，当代码走到<code>response.sendError</code>时，就会触发<code>/error</code>请求，当你的异常没有人能处理时，也会走tomcat底层触发<code>response.sendError</code>，发送<code>/error</code>请求</p> 
<p>如有错误，欢迎指正！！！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/07ce2d13b5998d9df9f45da85b84d661/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Vue生命周期中的重要8个阶段</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f578e0c56222c0c5a2c422f9f406d9af/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">一文带你透析zookeeper原理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>