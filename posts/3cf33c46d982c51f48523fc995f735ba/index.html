<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nginx--  port_in_redirect off配置服务器造成 很大的威胁，后端端口暴露出来 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="nginx--  port_in_redirect off配置服务器造成 很大的威胁，后端端口暴露出来" />
<meta property="og:description" content="第一篇 nginx-- port_in_redirect off配置服务器造成 很大的威胁，后端端口暴露出来 规则描述：
可以从Nginx的核心模块中得知，如果请求发生重定向，Nginx默认的情况下，是会在重定向的URL后自动添加Nginx当前站点监听的端口。这样明显会对服务器造成 很大的威胁，后端端口暴露出来，就可能会被人直接对这个端口进行诸如CC类攻击。
根据：
审计描述：
检查nginx.conf文件，是否存在以下配置：
http { ... #Nginx will not add the port in the url when the request is redirected #port_in_redirect off; ... Server { ... } ... } 修改建议：
1、在配置文件Nginx.conf中的http段、或server段或location端增加禁止指令，建议在http段添加，如下：
http { ... #Nginx will not add the port in the url when the request is redirected port_in_redirect off; ... Server { ... } ... } 检测用例信息：
检测描述
期望结果
检测结果" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/3cf33c46d982c51f48523fc995f735ba/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-11T21:48:27+08:00" />
<meta property="article:modified_time" content="2021-06-11T21:48:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nginx--  port_in_redirect off配置服务器造成 很大的威胁，后端端口暴露出来</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>第一篇   nginx--  port_in_redirect off配置服务器造成 很大的威胁，后端端口暴露出来</h2> 
<p>规则描述：</p> 
<p>可以从Nginx的核心模块中得知，如果请求发生重定向，Nginx默认的情况下，是会在重定向的URL后自动添加Nginx当前站点监听的端口。这样明显会对服务器造成 很大的威胁，后端端口暴露出来，就可能会被人直接对这个端口进行诸如CC类攻击。</p> 
<p>根据：</p> 
<p>审计描述：</p> 
<p>检查nginx.conf文件，是否存在以下配置：</p> 
<pre><code class="language-Groovy">http {

   ...

#Nginx will not add the port in the url when the request is redirected

   #port_in_redirect off;

   ...

   Server {

   ...

}

...

}</code></pre> 
<p> </p> 
<p>修改建议：</p> 
<p>1、在配置文件Nginx.conf中的http段、或server段或location端增加禁止指令，建议在http段添加，如下：</p> 
<pre><code class="language-Groovy">http {

   ...

   #Nginx will not add the port in the url when the request is redirected

   port_in_redirect off;

   ...

   Server {

      ...

  }

...

}</code></pre> 
<p>检测用例信息：</p> 
<p>检测描述</p> 
<p>期望结果</p> 
<p>检测结果</p> 
<p>检查重定向至监听端口是否被禁用</p> 
<p>--</p> 
<p>http { port_in_redirect on; }</p> 
<p> </p> 
<p> </p> 
<h2>第二篇    nginx的port_in_redirect配置</h2> 
<h3>序</h3> 
<p>本文主要讲解下port_in_redirect的实际用途。</p> 
<h3><a name="t1"></a>场景</h3> 
<p>有一个80端口的nginx，要转发一个路径到另一个8080端口的nginx，配置如下</p> 
<pre><code class="language-Groovy">server {
        listen       80  default_server;
        server_name demoapp.com.cn;
        location /public/ {
            proxy_pass http://192.168.99.100:8080/public/ ;
        }
}</code></pre> 
<pre>
<span style="color:#4d4d4d;font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif, SimHei, SimSun;font-size:16px;">另外一个nginx的配置如下</span>
</pre> 
<pre><code class="language-Groovy">server {
        listen       8080  default_server;
		location ~* /public/(share|webview) {
            root   html ;
            proxy_buffering off;
            index  index.html index.htm;
        }
}</code></pre> 
<p> </p> 
<blockquote> 
 <p>html目录里头有个public目录，public目录里头有share以及webview目录，存放各个子模块的静态资源。</p> 
</blockquote> 
<h3><a name="t2"></a>问题</h3> 
<p>这样配置了之后，通过demoapp.com.cn/public/share访问的时候，会跳转到demoapp.com.cn:8080/public/share</p> 
<blockquote> 
 <p>假设这两个nginx监听同一个ip，如果不是同一个ip，估计要配置server_name以及开启server_name_in_redirect</p> 
</blockquote> 
<p>这个时候，port_in_redirect就派上用场了。</p> 
<pre><code class="language-Groovy">server {
        listen       8080  default_server;
		location ~* /public/(share|webview) {
            root   html ;
            proxy_buffering off;
            port_in_redirect off;
            index  index.html index.htm;
        }
}</code></pre> 
<p> </p> 
<blockquote> 
 <p>通过指定port_in_redirect off;告知nginx在redirect的时候不要带上port，如果没有配置，默认该值为true</p> 
</blockquote> 
<h3><a name="t3"></a>doc</h3> 
<ul><li><a href="https://link.juejin.im/?target=http%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23port_in_redirect" rel="nofollow">port_in_redirect</a></li><li><a href="https://link.juejin.im/?target=http%3A%2F%2Fblog.csdn.net%2Fweiyuefei%2Farticle%2Fdetails%2F38556593" rel="nofollow">Nginx中的server_name_in_redirect和port_in_redirect指令</a></li></ul> 
<p>相关资源：<a href="https://download.csdn.net/download/weixin_38687928/12900020?spm=1001.2101.3001.5697"><em>Nginx</em>端口映射<em>配置</em>方法_<em>nginx</em>端口转发,<em>nginx</em><em>配置</em>接口转发-其它...</a></p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p> 
<p> </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2a5dfb25cd565ea744ec717629e5b42f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">工厂模式优缺点分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/395db2a5e87f28d37e43e95f3578496c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android 快速开发框架:推荐10个框架</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>