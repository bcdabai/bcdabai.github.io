<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux 集群化 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux 集群化" />
<meta property="og:description" content="文章目录 一、集群概述1.1 集群是什么？1.2 集群的分类1.2.1 负载均衡集群 – LBC1.2.2 高可用集群 – HAC1.2.3 高性能运算集群 – HPC 二、负载均衡集群2.1 LVS 相关原理2.2 LVS 工作方式2.2.1 LVS – DR（Direct Routing）直接路由模式2.2.2 LVS – NAT（隧道）模式2.2.3 LVS – TUN（网络地址转换）模式 2.3 LVS 实验构建环境构建2.3.1 LVS – DR 模式集群构建2.3.1.1 负载调度器 (10.10.10.11)2.3.1.2 真实服务器(10.10.10.12、13 ) 2.3.2 LVS – NAT 模式集群构建2.3.2.1 负载调度器(10.10.10.11)2.3.2.2 真实服务器(10.10.10.12、13) 2.4 负载均衡集群相关调度算法2.4.1 静态调度算法2.4.2 动态调度算法 2.5 LVS 持久连接2.5.1 持久客户端连接2.5.2 持久端口连接2.5.3 持久防火墙标记连接 三、高可用集群3.1 Keepalived 相关说明3.1.1 Keepalived 相关介绍3.1.1 Keepalived 实现原理 3.2 Keepalived &#43; LVS -DR 高可用实验构建3.2.1 LVS主节点(10." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/1b81acca53f11e15e52a7b8376fd0bab/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-20T19:36:18+08:00" />
<meta property="article:modified_time" content="2020-12-20T19:36:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux 集群化</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">一、集群概述</a></li><li><ul><li><a href="#11__2" rel="nofollow">1.1 集群是什么？</a></li><li><a href="#12__24" rel="nofollow">1.2 集群的分类</a></li><li><ul><li><a href="#121___LBC_30" rel="nofollow">1.2.1 负载均衡集群 – LBC</a></li><li><a href="#122___HAC_62" rel="nofollow">1.2.2 高可用集群 – HAC</a></li><li><a href="#123___HPC_91" rel="nofollow">1.2.3 高性能运算集群 – HPC</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_102" rel="nofollow">二、负载均衡集群</a></li><li><ul><li><a href="#21_LVS__103" rel="nofollow">2.1 LVS 相关原理</a></li><li><a href="#22_LVS__123" rel="nofollow">2.2 LVS 工作方式</a></li><li><ul><li><a href="#221_LVS__DRDirect_Routing_139" rel="nofollow">2.2.1 LVS – DR（Direct Routing）直接路由模式</a></li><li><a href="#222_LVS__NAT_159" rel="nofollow">2.2.2 LVS – NAT（隧道）模式</a></li><li><a href="#223_LVS__TUN_187" rel="nofollow">2.2.3 LVS – TUN（网络地址转换）模式</a></li></ul> 
   </li><li><a href="#23_LVS__212" rel="nofollow">2.3 LVS 实验构建</a></li><li><ul><li><a href="#_213" rel="nofollow">环境构建</a></li><li><a href="#231_LVS__DR__338" rel="nofollow">2.3.1 LVS – DR 模式集群构建</a></li><li><ul><li><a href="#2311__10101011_381" rel="nofollow">2.3.1.1 负载调度器 (10.10.10.11)</a></li><li><a href="#2312_1010101213__469" rel="nofollow">2.3.1.2 真实服务器(10.10.10.12、13 )</a></li></ul> 
    </li><li><a href="#232_LVS__NAT__547" rel="nofollow">2.3.2 LVS – NAT 模式集群构建</a></li><li><ul><li><a href="#2321_10101011_558" rel="nofollow">2.3.2.1 负载调度器(10.10.10.11)</a></li><li><a href="#2322_1010101213_687" rel="nofollow">2.3.2.2 真实服务器(10.10.10.12、13)</a></li></ul> 
   </li></ul> 
   </li><li><a href="#24__727" rel="nofollow">2.4 负载均衡集群相关调度算法</a></li><li><ul><li><a href="#241__728" rel="nofollow">2.4.1 静态调度算法</a></li><li><a href="#242__739" rel="nofollow">2.4.2 动态调度算法</a></li></ul> 
   </li><li><a href="#25_LVS__764" rel="nofollow">2.5 LVS 持久连接</a></li><li><ul><li><a href="#251__765" rel="nofollow">2.5.1 持久客户端连接</a></li><li><a href="#252__776" rel="nofollow">2.5.2 持久端口连接</a></li><li><a href="#253__787" rel="nofollow">2.5.3 持久防火墙标记连接</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_805" rel="nofollow">三、高可用集群</a></li><li><ul><li><a href="#31_Keepalived__809" rel="nofollow">3.1 Keepalived 相关说明</a></li><li><ul><li><a href="#311_Keepalived__813" rel="nofollow">3.1.1 Keepalived 相关介绍</a></li><li><a href="#311_Keepalived__846" rel="nofollow">3.1.1 Keepalived 实现原理</a></li></ul> 
   </li><li><a href="#32_Keepalived__LVS_DR__954" rel="nofollow">3.2 Keepalived + LVS -DR 高可用实验构建</a></li><li><ul><li><a href="#321_LVS10101011_975" rel="nofollow">3.2.1 LVS主节点(10.10.10.11)</a></li><li><a href="#322_1010101314__1038" rel="nofollow">3.2.2 真实服务器(10.10.10.13、14 )</a></li><li><a href="#323__Keepalived_MASTER10101011_1119" rel="nofollow">3.2.3 搭建 Keepalived的 MASTER(10.10.10.11)</a></li><li><a href="#324__Keepalived_SLAVE10101012_1227" rel="nofollow">3.2.4 搭建 Keepalived的 SLAVE(10.10.10.12)</a></li></ul> 
   </li><li><a href="#33_HeartBeat__Nginx__1419" rel="nofollow">3.3 HeartBeat + Nginx 实验构建</a></li><li><ul><li><a href="#331_HeartBeat__1421" rel="nofollow">3.3.1 HeartBeat 简介</a></li><li><a href="#332_Heartbeat_1428" rel="nofollow">3.3.2 Heartbeat工作原理</a></li><li><a href="#333_HeartBeat__Nginx__1436" rel="nofollow">3.3.3 HeartBeat + Nginx 构建</a></li><li><ul><li><a href="#3331_1010101110101012_1450" rel="nofollow">3.3.3.1 基础环境搭建(10.10.10.11、10.10.10.12)</a></li><li><a href="#3332_HeartBeat_10101011_1528" rel="nofollow">3.3.3.2 安装HeartBeat 主(10.10.10.11)</a></li><li><a href="#3333_HeartBeat_10101012_1583" rel="nofollow">3.3.3.3 安装HeartBeat 从(10.10.10.12)</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#_1636" rel="nofollow">四、多级负载(四层+七层)</a></li><li><ul><li><a href="#41__1638" rel="nofollow">4.1 实现原理</a></li><li><ul><li><a href="#411__1639" rel="nofollow">4.1.1 七层负载实现原理</a></li><li><a href="#412__1643" rel="nofollow">4.1.2 四层负载实现原理</a></li><li><a href="#413__1649" rel="nofollow">4.1.3 多级负载（四、七层）原理</a></li></ul> 
   </li><li><a href="#42__1663" rel="nofollow">4.2 多级负载构建</a></li><li><ul><li><a href="#422_apache101010141516_1679" rel="nofollow">4.2.2 搭建apache服务(10.10.10.14、15、16)</a></li><li><a href="#422_nginx1010101213_1691" rel="nofollow">4.2.2 搭建nginx服务(10.10.10.12、13)</a></li><li><a href="#423_LVSDR10101011_1788" rel="nofollow">4.2.3 搭建LVS-DR负载调度器(10.10.10.11)</a></li><li><a href="#424_LVSDR1010101213__1866" rel="nofollow">4.2.4 搭建LVS-DR真实服务器(10.10.10.12、13 )</a></li><li><a href="#425__1931" rel="nofollow">4.2.5 测试</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一、集群概述</h2> 
<h3><a id="11__2"></a>1.1 集群是什么？</h3> 
<p><strong>定义：</strong> 集群是一组<code>协同工作</code>的服务器，<code>各有分工</code>，对外表现为<code>一个整体</code>。</p> 
<p><strong>集群的意义：</strong> 更好的利用现有资源实现服务的高度可用</p> 
<p><strong>集群扩展方式</strong></p> 
<ul><li>垂直扩展：更换服务器硬件</li><li>水平扩展：添加更多的服务器节点</li></ul> 
<p><strong>集群与分布式的区别</strong></p> 
<p><strong>分布式：</strong> 多台计算机干一件事，服务是分散部署在不同的机器上，多台服务器合起来跑的才是一套完整代码，这就叫分布式。</p> 
<p><strong>集群：</strong> 多台计算机干同样的事，多台服务器跑的都是一套完整的代码，这就叫集群</p> 
<ul><li>相同点：分布式和集群都是需要有很多节点服务器通过网络协同工作完成整体的任务目标。</li><li>不同点：分布式是指将业务系统进行拆分，即分布式的每一个节点都是实现不同的功能。而集群每个节点做的是同一件事情。</li></ul> 
<p><strong>常见的集群拓扑</strong></p> 
<p><img src="https://images2.imgbox.com/d0/c0/ljUE0N1U_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="12__24"></a>1.2 集群的分类</h3> 
<p><strong>负载均衡集群 – LBC：</strong> 分担服务的总体压力<br> <strong>高可用集群 – HAC：</strong> 尽可能的保障服务状态的可用性<br> <strong>高性能运算集群 – HPC：</strong> 提供单台服务器提供不了的计算能力</p> 
<h4><a id="121___LBC_30"></a>1.2.1 负载均衡集群 – LBC</h4> 
<p><strong>使用意图：</strong> 减轻单台服务器的压力，将用户请求分担给多台主机一起处理</p> 
<p><strong>实现方法</strong></p> 
<ul><li>软件：LVS、 RAC、 Nginx</li><li>硬件：F5、 BIG-IP</li></ul> 
<p><strong>负载均衡集群架构拓扑</strong><br> <img src="https://images2.imgbox.com/25/70/D14DPIUh_o.png" alt="在这里插入图片描述"></p> 
<p><strong>调度器分类</strong></p> 
<ul><li>触发条件不同 
  <ul><li>四层：传输层 IP+PORT</li><li>七层：应用层 URL</li></ul> </li><li>实现原理不同 
  <ul><li>四层：TCP 连接只建立一次，客户端和正式服务器</li><li>七层：TCP 连接建立两次，客户端和负载调度器 负载调度器和真实服务器</li></ul> </li><li>实现场景不同 
  <ul><li>四层：TCP 应用 如：基于 C/S 机构的 ERP 系统</li><li>七层：HTTP 应用 如：根据用户访问域名的方式，判断用户语言</li></ul> </li><li>安全性不同 
  <ul><li>四层：转发 SYN 攻击</li><li>七层：可以拦截 SYN 攻击</li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/7e/e3/s8P7f8xL_o.png" alt="在这里插入图片描述"><br> 数据链路层（F5），传输层，应用层可以进行负载均衡。</p> 
<p><strong>使用范围：</strong> 业务并发较大的应用程序</p> 
<br> 
<h4><a id="122___HAC_62"></a>1.2.2 高可用集群 – HAC</h4> 
<p><strong>使用意图：</strong> 最大限度的保证用户的应用持久，不间断的提供服务</p> 
<p><strong>最大限度</strong><br> 99%            99            87.6 小时<br> 99.9%         999          8.8 小时<br> 99.99%       9999        53 分钟<br> 99.999%     99999      5 分钟</p> 
<p><strong>实现原理：</strong> 心跳检测</p> 
<p><strong>实现方法</strong></p> 
<ul><li>软件： 
  <ul><li>heartbeat linux-HA</li><li>RHCS</li><li>ROSE</li><li>keepalived</li></ul> </li><li>硬件： 
  <ul><li>F5</li></ul> </li></ul> 
<p><strong>特殊情况：</strong> 脑分裂</p> 
<ul><li>可能出现的问题：数据不完整、数据不可访问</li><li>解决方法：预防：冗余、强制隔离：电源交换机</li></ul> 
<p><strong>使用范围：</strong> 需要持续提供服务的应用程序</p> 
<br> 
<h4><a id="123___HPC_91"></a>1.2.3 高性能运算集群 – HPC</h4> 
<p><strong>使用意图：</strong> 提供单台计算机所不具备的计算能力</p> 
<p><strong>LBC 与 HAC 的原理对比：</strong></p> 
<ul><li>负载均衡集群通过<code>提高单位时间内执行的任务数</code>来提升效率</li><li>高性能运算集群通过<code>缩短单个任务的执行时间</code>来提高效率</li></ul> 
<p><strong>使用范围：</strong> 天气计算、火箭弹道演算</p> 
<br> 
<h2><a id="_102"></a>二、负载均衡集群</h2> 
<h3><a id="21_LVS__103"></a>2.1 LVS 相关原理</h3> 
<p><strong>LVS简介</strong><br>   LVS（Linux Virtual Server）即Linux虚拟服务器，是由章文嵩博士主导的开源负载均衡项目，目前LVS已经被集成到Linux内核模块中。该项目在Linux内核中实现了<code>基于IP的数据请求负载均衡调度</code>方案，<code>LVS在四层传出层</code></p> 
<p><strong>LVS 的组成</strong></p> 
<ul><li>IPVS：运行在内核空间 （ipvs称之为<code>IP虚拟服务器</code>（IP Virtual Server，简写为IPVS）。<code>是运行在LVS下的提供负载平衡功能的一种技术</code>。）<strong>主要用于使用户定义的策略生效</strong></li><li>IPVSADM：运行在用户空间，管理集群服务的命令行工具<br> <br></li></ul> 
<p><strong>LVS 的原理：</strong> 根据用户请求的套接字判断，分流至真实服务器的工作模块<br> <img src="https://images2.imgbox.com/e8/09/ht4HFIUh_o.png" alt="在这里插入图片描述"><br> <strong>LVS只做了简单的地址信息的更改，并没有涉及真实的流量转发</strong></p> 
<ol><li>当用户向负载均衡调度器（Director Server）发起请求，调度器将请求发往至内核空间</li><li>PREROUTING链首先会接收到用户请求，判断目标IP确定是本机IP，将数据包发往INPUT链</li><li>IPVS是工作在INPUT链上的，当用户请求到达INPUT时，IPVS会将用户请求和自己已定义好的集群服务进行比对，如果用户请求的就是定义的集群服务，那么此时IPVS会强行修改数据包里的目标IP地址及端口，并将新的数据包发往POSTROUTING链</li><li>POSTROUTING链接收数据包后发现目标IP地址刚好是自己的后端服务器，那么此时通过选路，将数据包最终发送给后端的服务器</li></ol> 
<br> 
<h3><a id="22_LVS__123"></a>2.2 LVS 工作方式</h3> 
<p><img src="https://images2.imgbox.com/1d/d8/SSYLOCkE_o.png" alt="在这里插入图片描述"><br> <strong>首先掌握几个术语，方便下边的理解：</strong></p> 
<p><strong>DS:</strong>（director server）负载均衡服务器</p> 
<p><strong>RS:</strong>（real server）真实服务器</p> 
<p><strong>DIR:</strong> (director server IP)地址</p> 
<p><strong>VIP:</strong> (外部网络访问的IP地址)虚拟IP地址</p> 
<p><strong>RIP:</strong>（real server IP）真实服务器IP地址</p> 
<p><strong>CIP:</strong> 客户端IP地址</p> 
<h4><a id="221_LVS__DRDirect_Routing_139"></a>2.2.1 LVS – DR（Direct Routing）直接路由模式</h4> 
<p>  DR模式是通过<code>改写请求报文的目标MAC地址，将请求发给真实服务器的，而真实服务器响应后的处理结果直接返回给客户端用户</code>。</p> 
<p><strong>工作逻辑图</strong><br> <img src="https://images2.imgbox.com/ff/75/mTEqIwon_o.png" alt="在这里插入图片描述"><br> <strong>工作原理：</strong></p> 
<p>DR模式将报文直接路由给目标真实服务器。</p> 
<ol><li>在DR模式中，调度器根据各个真实服务器的负载情况，连接数多少等，动态地选择一台服务器，不修改目标IP地址和目标端口，也不封装IP报文，而是将请求报文的数据帧的目标MAC地址改为真实服务器的MAC地址。</li><li>然后再将修改的数据帧在服务器组的局域网上发送。因为数据帧的MAC地址是真实服务器的MAC地址，并且又在同一个局域网。那么根据局域网的通讯原理，真实复位是一定能够收到由LB发出的数据包。真实服务器接收到请求数据包的时候，解开IP包头查看到的目标IP是VIP。（此时只有自己的IP符合目标IP才会接收进来，所以我们需要在本地的回环借口上面配置VIP。另：由于网络接口都会进行ARP广播响应，但集群的其他机器都有这个VIP的lo接口，都响应就会冲突。所以我们需要把真实服务器的lo接口的ARP响应关闭掉。）</li><li>然后真实服务器做成请求响应，之后根据自己的路由信息将这个响应数据包发送回给客户，并且源IP地址还是VIP。</li></ol> 
<p><strong>模式特点</strong></p> 
<ul><li>集群节点，必须在一个网络中</li><li>真实服务器网关指向路由器</li><li>RIP 既可以是私网地址，又可以是公网地址</li><li>负载调度器只负责入站请求</li><li>大大减轻负载调度器压力，支持更多的服务器节点</li></ul> 
<h4><a id="222_LVS__NAT_159"></a>2.2.2 LVS – NAT（隧道）模式</h4> 
<p><img src="https://images2.imgbox.com/50/6f/Kp7ZwjOh_o.png" alt="在这里插入图片描述"></p> 
<p>  <code>通过网络地址转换的方法来实现调度的</code>。首先调度器(LB)接收到客户的请求数据包时（请求的目的IP为VIP），根据调度算法决定将请求发送给哪个后端的真实服务器（RS）。然后调度就把客户端发送的请求数据包的目标IP地址及端口改成后端真实服务器的IP地址（RIP）,这样真实服务器（RS）就能够接收到客户的请求数据包了。真实服务器响应完请求后，查看默认路由（NAT模式下我们需要把RS的默认路由设置为LB服务器。）把响应后的数据包发送给LB,LB再接收到响应包后，把包的源地址改成虚拟地址（VIP）然后发送回给客户端。</p> 
<p><strong>工作原理：</strong></p> 
<ol><li> <p>客户端请求数据，目标IP为VIP</p> </li><li> <p>请求数据到达LB服务器，LB根据调度算法将目的地址修改为RIP地址及对应端口（此RIP地址是根据调度算法得出的。）并在连接HASH表中记录下这个连接。</p> </li><li> <p>数据包从LB服务器到达RS服务器webserver，然后webserver进行响应。Webserver的网关必须是LB，然后将数据返回给LB服务器。</p> </li><li> <p>收到RS的返回后的数据，根据连接HASH表修改源地址VIP&amp;目标地址CIP，及对应端口80.然后数据就从LB出发到达客户端。</p> </li><li> <p>客户端收到的就只能看到VIP\DIP信息。</p> </li></ol> 
<p><strong>模式特点</strong></p> 
<ul><li>集群节点，必须在一个网络中</li><li>真实服务器必须将网关指向负载调度器</li><li>RIP 通常都是私有 IP，仅用于各个集群节点通信</li><li>负载调度器必须位于客户端和真实服务器之间，充当网关</li><li>支持端口映射</li><li>负载调度器操作系统必须是 Linux ，真实服务器可以使用任意系统</li><li>进出数据报文都要经过负载调度器机器，压力较大</li></ul> 
<h4><a id="223_LVS__TUN_187"></a>2.2.3 LVS – TUN（网络地址转换）模式</h4> 
<p><img src="https://images2.imgbox.com/b4/3f/4M25ysSb_o.png" alt="在这里插入图片描述"></p> 
<p>  采用NAT模式时，由于请求和响应的报文必须通过调度器地址重写，当客户请求越来越多时，调度器处理能力将成为瓶颈。为了解决这个问题，<code>调度器把请求的报文通过IP隧道转发到真实的服务器。真实的服务器将响应处理后的数据直接返回给客户端</code>。这样调度器就只处理请求入站报文，由于一般网络服务应答数据比请求报文大很多，采用VS/TUN模式后，集群系统的最大吞吐量可以提高10倍。</p> 
<p><strong>工作原理：</strong></p> 
<ol><li> <p>客户请求数据包，目标地址VIP发送到LB上。</p> </li><li> <p>LB接收到客户请求包，进行IP Tunnel封装。即在原有的包头加上IP Tunnel的包头。然后发送出去。</p> </li><li> <p>RS节点服务器根据IP Tunnel包头信息（此时就又一种逻辑上的隐形隧道，只有LB和RS之间懂）收到请求包，然后解开IP Tunnel包头信息，得到客户的请求包并进行响应处理。</p> </li><li> <p>响应处理完毕之后，RS服务器使用自己的出公网的线路，将这个响应数据包发送给客户端。源IP地址还是VIP地址。</p> </li></ol> 
<p><strong>模式特点</strong></p> 
<ul><li>集群节点不必位于同一个物理网络但必须都拥有公网 IP（或都可以被路由）</li><li>真实服务器不能将网管指向负载调度器</li><li>RIP 必须是公网地址</li><li>负载调度器只负责入站请求</li><li>不支持端口映射功能</li><li>发送方和接收方必须支持隧道功能</li></ul> 
<br> 
<h3><a id="23_LVS__212"></a>2.3 LVS 实验构建</h3> 
<h4><a id="_213"></a>环境构建</h4> 
<p><strong>ip地址网段</strong> <strong>10.10.10.0/24 255.255.255.0</strong><br> <code>10.10.10.11</code> <code>12</code> 依次排列 共6台</p> 
<p><strong>VMware</strong><br> <strong>网络类型：</strong> 仅主机</p> 
<p>【编辑】----【虚拟网络编辑器】----【添加网络】添加一块仅主机的网卡。关闭DHCP服务，子网改成10.10.10.0，然后将虚拟机选择此网卡，添加<code>两块网卡</code>，双网卡<code>仅主机</code>类型，安装图形界面<br> <img src="https://images2.imgbox.com/5f/86/X164JKBF_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/62/ad/TkDArrkq_o.png" alt="在这里插入图片描述"></p> 
<p><strong>操作系统</strong><br> <strong>centos6.8</strong></p> 
<p>ip地址修改</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ <span class="token function">echo</span> <span class="token string">"root"</span> <span class="token punctuation">|</span> passwd <span class="token operator">--</span>stdin root <span class="token comment">#修改密码为root</span>

<span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>network<span class="token operator">-</span>scripts<span class="token operator">/</span>ifcfg<span class="token operator">-</span>eth0 
DEVICE=eth0  
HWADDR=00:0C:29:5F:75:3B    
<span class="token function">TYPE</span>=Ethernet 
UUID=8ad7de61<span class="token operator">-</span>0b7c<span class="token operator">-</span>433c<span class="token operator">-</span>b7c0<span class="token operator">-</span>03dd42eec9ea
ONBOOT=yes  <span class="token comment">#开机自启，改为yes  </span>
NM_CONTROLLED=yes
BOOTPROTO=static <span class="token comment">#修改此处，改为static</span>
IPADDR=10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11  <span class="token comment">#ip地址，12,13,14依次排列</span>
NETMASK=255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0 <span class="token comment">#子网掩码</span>

</code></pre> 
<p><strong>调成字符页面，ctrl+alt+f3</strong>，有的还需要加个fn</p> 
<p>默认启动字符界面</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>inittab
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment"># Default runlevel. The runlevels used are:</span>
<span class="token comment">#   0 - halt (Do NOT set initdefault to this)</span>
<span class="token comment">#   1 - Single user mode</span>
<span class="token comment">#   2 - Multiuser, without NFS (The same as 3, if you do not have networking)</span>
<span class="token comment">#   3 - Full multiuser mode</span>
<span class="token comment">#   4 - unused</span>
<span class="token comment">#   5 - X11</span>
<span class="token comment">#   6 - reboot (Do NOT set initdefault to this)</span>
<span class="token comment"># </span>
id:3:initdefault:  <span class="token comment">#5改为3</span>
</code></pre> 
<p>关闭防火墙</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ iptables <span class="token operator">-</span>F  &amp;&amp;  service iptables save &amp;&amp; chkconfig iptables off
<span class="token namespace">[root@localhost ~]</span>$ iptables <span class="token operator">-</span>L
</code></pre> 
<p>关闭selinux</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ setenforce 0 &amp;&amp; sed <span class="token operator">-</span>i <span class="token string">'s/^SELINUX=.*/SELINUX=disabled/'</span> <span class="token operator">/</span>etc<span class="token operator">/</span>selinux<span class="token operator">/</span>config
<span class="token namespace">[root@localhost ~]</span>$ getenforce
</code></pre> 
<p><strong>配置yum源</strong></p> 
<p>设置yum源可以参考之前的文章<br> <a href="https://blog.csdn.net/w918589859/article/details/109191537">https://blog.csdn.net/w918589859/article/details/109191537</a></p> 
<p>右击虚拟机——进入“虚拟机设置”——点击“CD/DVD（IDE）”——点击“浏览”——选中安装时的镜像——勾选上“已连接”——确定</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ mkdir <span class="token operator">/</span>mnt<span class="token operator">/</span>cdrom
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">mount</span> <span class="token operator">-</span>t iso9660 <span class="token operator">/</span>dev<span class="token operator">/</span>cdrom <span class="token operator">/</span>mnt<span class="token operator">/</span>cdrom
<span class="token function">mount</span>: block device <span class="token operator">/</span>dev<span class="token operator">/</span>sr0 is <span class="token function">write</span><span class="token operator">-</span>protected<span class="token punctuation">,</span> mounting read<span class="token operator">-</span>only
<span class="token comment">#出现这个表示成功</span>

<span class="token namespace">[root@localhost ~]</span>$ cd <span class="token operator">/</span>etc<span class="token operator">/</span>yum<span class="token punctuation">.</span>repos<span class="token punctuation">.</span>d<span class="token operator">/</span>
<span class="token namespace">[root@localhost ~]</span>$ mkdir back &amp;&amp; <span class="token function">mv</span> <span class="token operator">*</span> back
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">cp</span> <span class="token operator">-</span>a back<span class="token operator">/</span>CentOS<span class="token operator">-</span>Media<span class="token punctuation">.</span>repo <span class="token punctuation">.</span>
<span class="token namespace">[root@localhost ~]</span>$ vim CentOS<span class="token operator">-</span>Media<span class="token punctuation">.</span>repo
<span class="token namespace">[c6-media]</span>
name=CentOS<span class="token operator">-</span><span class="token variable">$releasever</span> <span class="token operator">-</span> Media
baseurl=file:<span class="token operator">/</span>/<span class="token operator">/</span>mnt<span class="token operator">/</span>cdrom
<span class="token comment">#只保留一个即可，多余的可以删除</span>

gpgcheck=0
enabled=1
<span class="token comment">#把enabled=0改为enabled=1，让这个yum源配置文件生效</span>
gpgkey=file:<span class="token operator">/</span>/<span class="token operator">/</span>etc<span class="token operator">/</span>pki<span class="token operator">/</span>rpm<span class="token operator">-</span>gpg<span class="token operator">/</span>RPM<span class="token operator">-</span>GPG<span class="token operator">-</span>KEY<span class="token operator">-</span>CentOS<span class="token operator">-</span>6


<span class="token namespace">[root@localhost ~]</span>$ yum clean all
<span class="token namespace">[root@localhost ~]</span>$ yum update
<span class="token namespace">[root@localhost ~]</span>$ yum <span class="token operator">-</span>y install gcc<span class="token operator">*</span> lrzsz


</code></pre> 
<p>如果复制的虚拟机启动网卡报错 <code>no device found for connection 'System eth0'</code></p> 
<p><strong>解决办法</strong></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>network<span class="token operator">-</span>scripts<span class="token operator">/</span>ifcfg<span class="token operator">-</span>eth0 
DEVICE=eth0  
<span class="token comment">#HWADDR=00:0C:29:5F:75:3B    删除mac地址</span>
<span class="token function">TYPE</span>=Ethernet 
UUID=8ad7de61<span class="token operator">-</span>0b7c<span class="token operator">-</span>433c<span class="token operator">-</span>b7c0<span class="token operator">-</span>03dd42eec9ea
ONBOOT=yes  <span class="token comment">#开机自启，改为yes  </span>
NM_CONTROLLED=yes
BOOTPROTO=static <span class="token comment">#修改此处，改为static</span>
IPADDR=10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12  <span class="token comment">#ip地址，12,13,14依次排列</span>
NETMASK=255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0 <span class="token comment">#子网掩码</span>

<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">rm</span> <span class="token operator">-</span>f <span class="token operator">/</span>etc<span class="token operator">/</span>udev<span class="token operator">/</span>rules<span class="token punctuation">.</span>d<span class="token operator">/</span>70<span class="token operator">-</span>persistent<span class="token operator">-</span>net<span class="token punctuation">.</span>rules
<span class="token comment">#删除这个文件，重启即可</span>

</code></pre> 
<p><strong><code>三台机器在虚拟机都保存一个快照</code></strong></p> 
<h4><a id="231_LVS__DR__338"></a>2.3.1 LVS – DR 模式集群构建</h4> 
<p><strong>实验架构图</strong></p> 
<p><img src="https://images2.imgbox.com/85/91/KQqG6VzS_o.png" alt="在这里插入图片描述"><br> <strong>大致流程</strong></p> 
<p>c发送一个数据包，源地址是10.10.10.240，目标地址是10.10.10.100，在当前广播域中，数据包会被发送到负载调度器，负载调度器会根据算法进行修改DMAC(目的MAC)，修改完之后会被扔回广播域，回到RS1，为了使RS1能够接受数据，开启一个lo:0 10.10.10.100的接口(相当于起了个小名)，这样的话，当前广播域中会存在多个相同的ip地址，会引起ip地址冲突，为了解决这个问题，可以修改ARP(地址解析协议，根据IP地址获取物理地址的一个TCP/IP协议)的通信行为，然后 lo 配置路由规则拿到数据报文，回信给客户端<br> <br><br> <br></p> 
<br> 
<p><strong>ARP修改</strong></p> 
<p><strong>ARP响应级别</strong><br>   arp-ignore<br>     0只要本机配置有相应IP地址就响应<br>     1仅在请求的目标地址配置在请求到达的网络接口上时，才给予响应</p> 
<p><strong>ARP通告行为</strong><br>   arp-announce<br>     0将本机任何网络接口上的任何地址都向外通告<br>     1尽可能避免像目标网络通告与其网络不匹配的地址信息表2仅向目标网络通告与其网络相匹配的地址信息</p> 
<br> 
<br> 
<br> 
<p><strong>此次试验需要配置三台服务器</strong></p> 
<p><strong>10.10.10.11<br> 10.10.10.12<br> 10.10.10.13</strong></p> 
<p><strong>本机地址</strong></p> 
<p><strong>10.10.10.240</strong></p> 
<br> 
<br> 
<h5><a id="2311__10101011_381"></a>2.3.1.1 负载调度器 (10.10.10.11)</h5> 
<pre><code class="prism language-powershell"><span class="token comment">#这两条命令三台服务器都执行，最小化安装没有此服务</span>
<span class="token namespace">[root@localhost ~]</span>$ service NetworkManager stop <span class="token comment"># 关闭网卡守护进程</span>
<span class="token namespace">[root@localhost ~]</span>$ chkconfig NetworkManager off
</code></pre> 
<p>开启子接口</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ cd <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>network<span class="token operator">-</span>scripts<span class="token operator">/</span>
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">cp</span> <span class="token operator">-</span>a ifcfg<span class="token operator">-</span>eth0 ifcfg<span class="token operator">-</span>eth0:0 
<span class="token comment"># 拷贝 eth0 网卡子接口充当集群入口接口</span>

<span class="token namespace">[root@localhost ~]</span>$ vim ifcfg<span class="token operator">-</span>eth0:0  <span class="token comment">#vim !$ 上一个命令最后一条参数</span>
<span class="token comment">#修改成下面一样</span>
DEVICE=eth0:0
ONBOOT=yes
BOOTPROTO=static
IPADDR=10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100
NETMASK=255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0
<span class="token comment">#当做集群的ip，VIP，提供给web用户访问的接口</span>

<span class="token namespace">[root@localhost ~]</span>$ service network restart
正在关闭接口 eth0：                                        <span class="token punctuation">[</span>确定<span class="token punctuation">]</span>
关闭环回接口：                                             <span class="token punctuation">[</span>确定<span class="token punctuation">]</span>
弹出环回接口：                                             <span class="token punctuation">[</span>确定<span class="token punctuation">]</span>
弹出界面 eth0： Determining <span class="token keyword">if</span> ip address 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11 is already in use <span class="token keyword">for</span> device eth0<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Determining <span class="token keyword">if</span> ip address 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 is already in use <span class="token keyword">for</span> device eth0<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                                                           <span class="token punctuation">[</span>确定<span class="token punctuation">]</span>


</code></pre> 
<p>修改内核配置文件</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf <span class="token comment"># 关闭网卡重定向功能 </span>
<span class="token comment">#最后一行添加</span>
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>all<span class="token punctuation">.</span>send_redirects = 0 
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>default<span class="token punctuation">.</span>send_redirects = 0 
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>eth0<span class="token punctuation">.</span>send_redirects = 0 

<span class="token namespace">[root@localhost ~]</span>$ sysctl <span class="token operator">-</span>p <span class="token comment">#重新加载配置文件</span>
</code></pre> 
<p>安装ipvsadm</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ yum  <span class="token operator">-</span>y install ipvsadm <span class="token comment">#报错的话重新挂载镜像</span>
<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>Ln
IP Virtual Server version 1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1 <span class="token punctuation">(</span>size=4096<span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  <span class="token operator">-</span>&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</code></pre> 
<p>添加ipvs规则</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>v <span class="token comment"># 查看当前 ipvs 集群内容 </span>
 
<span class="token comment">#ipvsadm -A -t 虚拟 IP:80 -s rr </span>
<span class="token comment">#添加 ipvs TCP 集群，-A添加一个集群，-t TCP协议，-s 指定算法，rr轮询</span>
<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>A <span class="token operator">-</span>t 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80 <span class="token operator">-</span>s rr

<span class="token comment">#ipvsadm -a -t 虚拟 IP:80 -r 网站1:80 -g </span>
<span class="token comment">#添加 ipvsadm 集群子节点 ,-a 集群子节点，-r 真实服务器，-g DR模式</span>
<span class="token comment">#ipvsadm -a -t 虚拟 IP:80 -r 网站2:80 -g </span>
<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>a <span class="token operator">-</span>t 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80 <span class="token operator">-</span>r 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12:80 <span class="token operator">-</span>g
<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>a <span class="token operator">-</span>t 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80 <span class="token operator">-</span>r 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13:80 <span class="token operator">-</span>g

<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>Ln  <span class="token comment">#查看集群</span>
IP Virtual Server version 1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1 <span class="token punctuation">(</span>size=4096<span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  <span class="token operator">-</span>&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80 rr
  <span class="token operator">-</span>&gt; 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12:80               Route   1      0          0         
  <span class="token operator">-</span>&gt; 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13:80               Route   1      0          0


<span class="token namespace">[root@localhost ~]</span>$ service ipvsadm save <span class="token comment"># 保存 ipvs 集群内容至文件，进行持久化存储 </span>
<span class="token namespace">[root@localhost ~]</span>$ chkconfig ipvsadm on <span class="token comment"># 设置为开机自启</span>

<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>Ln <span class="token operator">--</span>stats <span class="token comment">#查看状态</span>
</code></pre> 
<br> 
<h5><a id="2312_1010101213__469"></a>2.3.1.2 真实服务器(10.10.10.12、13 )</h5> 
<p>两台服务器做相同的步骤，另一台的网页内容不一样，其余全部一样</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ service httpd <span class="token function">start</span>  <span class="token comment">#启动apache服务器</span>
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">echo</span> <span class="token string">"this is server 1"</span> &gt;&gt; <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>index<span class="token punctuation">.</span>html 
<span class="token comment">#另一台服务是this is server 2</span>
<span class="token namespace">[root@localhost ~]</span>$ curl localhost
this is server 1
<span class="token comment">#生产环境两台服务器的网页内容是一样的</span>
</code></pre> 
<p>开启回环网卡接口</p> 
<pre><code class="prism language-powershell"><span class="token comment"># 关闭网卡守护进程</span>
<span class="token namespace">[root@localhost ~]</span>$ service NetworkManager stop &amp;&amp; chkconfig NetworkManager off
<span class="token namespace">[root@localhost ~]</span>$ cd <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>network<span class="token operator">-</span>scripts<span class="token operator">/</span>
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">cp</span> <span class="token operator">-</span>a ifcfg<span class="token operator">-</span>lo ifcfg<span class="token operator">-</span>lo:0
<span class="token comment"># 拷贝回环网卡子接口</span>

<span class="token namespace">[root@localhost ~]</span>$ vim ifcfg<span class="token operator">-</span>lo:0  <span class="token comment">#vim !$ 上一个命令最后一条参数</span>
<span class="token comment">#修改成下面一样</span>
DEVICE=lo:0    <span class="token comment">#修改这里</span>
IPADDR=10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 <span class="token comment">#修改这里</span>
NETMASK=255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255  <span class="token comment">#修改这里</span>
NETWORK=127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
<span class="token comment"># If you're having problems with gated making 127.0.0.0/8 a martian,</span>
<span class="token comment"># you can change this to something else (255.255.255.255, for example)</span>
BROADCAST=127<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255
ONBOOT=yes
NAME=loopback


</code></pre> 
<p>修改内核配置文件</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf <span class="token comment">#关闭对应 ARP 响应及公告功能</span>
<span class="token comment">#最后一行添加</span>
<span class="token comment"># LVS - ARP</span>
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>all<span class="token punctuation">.</span>arp_ignore = 1
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>all<span class="token punctuation">.</span>arp_announce = 2
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>default<span class="token punctuation">.</span>arp_ignore = 1
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>default<span class="token punctuation">.</span>arp_announce = 2
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>lo<span class="token punctuation">.</span>arp_ignore = 1
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>lo<span class="token punctuation">.</span>arp_announce = 2


<span class="token namespace">[root@localhost ~]</span>$ sysctl <span class="token operator">-</span>p <span class="token comment">#重新加载配置文件</span>

<span class="token namespace">[root@localhost ~]</span>$ ifup lo:0  <span class="token comment">#启动回环网卡</span>

<span class="token namespace">[root@localhost ~]</span>$ ifconfig
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
lo:0      Link encap:Local Loopback  
          inet addr:10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100  Mask:255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255
          UP LOOPBACK RUNNING  MTU:65536  Metric:1

</code></pre> 
<p>添加路由记录，当访问 VIP 交给 lo:0 网卡接受</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ route add <span class="token operator">-</span>host 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 dev lo:0
<span class="token namespace">[root@localhost ~]</span>$ route <span class="token operator">-</span>n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100    0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0         255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255 UH    0      0        0 lo
10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0      0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0         255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0   U     0      0        0 eth0
169<span class="token punctuation">.</span>254<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0     0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0         255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0     U     1002   0        0 eth0

<span class="token comment">#添加到开机自启，防止失效</span>
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">echo</span> <span class="token string">"route add -host 10.10.10.100 dev lo:0"</span> &gt;&gt; <span class="token operator">/</span>etc<span class="token operator">/</span>rc<span class="token punctuation">.</span>local
</code></pre> 
<p>浏览器输入<code>10.10.10.100</code>访问<br> <img src="https://images2.imgbox.com/04/a7/IVEAWsOJ_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/a4/5d/Yp2SBAmS_o.png" alt="在这里插入图片描述"><br> <br></p> 
<h4><a id="232_LVS__NAT__547"></a>2.3.2 LVS – NAT 模式集群构建</h4> 
<p><strong>实验架构图</strong><img src="https://images2.imgbox.com/cf/46/D31ZytaD_o.png" alt="在这里插入图片描述"><br> c发送一个数据包，源地址是20.20.20.22，目标地址是20.20.20.11，负载调度器LVS组件会根据DNAT转换把ip地址修改为服务器的地址，RS1收到数据包后，回信给网关负载调度器10.10.10.11，为了保证源地址一致性，采用了SNAT转换</p> 
<p><strong>修改客户端的ip</strong></p> 
<p>【网络适配器】—找到VMnet1的网卡【属性】–【IPv4协议】—【高级】—添加一个20.20.20.22的ip地址</p> 
<p>三台虚拟机都恢复快照<br> <br></p> 
<h5><a id="2321_10101011_558"></a>2.3.2.1 负载调度器(10.10.10.11)</h5> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ service NetworkManager stop &amp;&amp; chkconfig NetworkManager off<span class="token comment"># 关闭网卡守护进程 </span>
<span class="token namespace">[root@localhost ~]</span>$ cd <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>network<span class="token operator">-</span>scripts<span class="token operator">/</span>
<span class="token namespace">[root@localhost ~]</span>$ vim ifcfg<span class="token operator">-</span>eth1
DEVICE=eth1
HWADDR=00:0C:29:0A:56:38
<span class="token function">TYPE</span>=Ethernet
UUID=ea68e93b<span class="token operator">-</span>9aff<span class="token operator">-</span>4379<span class="token operator">-</span>b5a8<span class="token operator">-</span>abac819dcd3b
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=static
IPADDR=10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11
NETMASK=255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0



<span class="token namespace">[root@localhost ~]</span>$ vim ifcfg<span class="token operator">-</span>eth0
DEVICE=eth0
HWADDR=00:0C:29:0A:56:2E
<span class="token function">TYPE</span>=Ethernet
UUID=b1f0c82e<span class="token operator">-</span>6315<span class="token operator">-</span>4827<span class="token operator">-</span>91f7<span class="token operator">-</span>8a5f8fa0b929
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=static
IPADDR=20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>11
NETMASK=255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0

<span class="token namespace">[root@localhost ~]</span>$ service network restart
<span class="token namespace">[root@localhost ~]</span>$ ifconfig
eth0      Link encap:Ethernet  HWaddr 00:0C:29:0A:56:2E  
          inet addr:20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>11  Bcast:20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>255  Mask:255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0
          inet6 addr: fe80::20c:29ff:fe0a:562e<span class="token operator">/</span>64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:987 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1109 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:84594 <span class="token punctuation">(</span>82<span class="token punctuation">.</span>6 KiB<span class="token punctuation">)</span>  TX bytes:204436 <span class="token punctuation">(</span>199<span class="token punctuation">.</span>6 KiB<span class="token punctuation">)</span>

eth1      Link encap:Ethernet  HWaddr 00:0C:29:0A:56:38  
          inet addr:10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11  Bcast:10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>255  Mask:255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0
          inet6 addr: fe80::20c:29ff:fe0a:5638<span class="token operator">/</span>64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:45 errors:0 dropped:0 overruns:0 frame:0
          TX packets:27 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:3570 <span class="token punctuation">(</span>3<span class="token punctuation">.</span>4 KiB<span class="token punctuation">)</span>  TX bytes:3512 <span class="token punctuation">(</span>3<span class="token punctuation">.</span>4 KiB<span class="token punctuation">)</span>

lo        Link encap:Local Loopback  
          inet addr:127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1  Mask:255<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
          inet6 addr: ::1<span class="token operator">/</span>128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:12 errors:0 dropped:0 overruns:0 frame:0
          TX packets:12 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:1000 <span class="token punctuation">(</span>1000<span class="token punctuation">.</span>0 b<span class="token punctuation">)</span>  TX bytes:1000 <span class="token punctuation">(</span>1000<span class="token punctuation">.</span>0 b<span class="token punctuation">)</span>


</code></pre> 
<p>安装 ipvsadm 命令行工具</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ <span class="token function">mount</span> <span class="token operator">-</span>t iso9660 <span class="token operator">/</span>dev<span class="token operator">/</span>cdrom <span class="token operator">/</span>mnt<span class="token operator">/</span>cdrom <span class="token comment">#挂载光盘</span>
<span class="token namespace">[root@localhost ~]</span>$ yum <span class="token operator">-</span>y install ipvsadm

<span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf <span class="token comment"># 开启路由转发功能 </span>
<span class="token comment"># Controls IP packet forwarding</span>
<span class="token comment">#修改此处</span>
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>ip_forward = 1


<span class="token namespace">[root@localhost ~]</span>$ sysctl <span class="token operator">-</span>p


</code></pre> 
<p>修改防火墙</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ service iptables <span class="token function">start</span> &amp;&amp; chkconfig iptables on
<span class="token namespace">[root@localhost ~]</span>$ iptables <span class="token operator">-</span>F <span class="token comment">#清空规则</span>
<span class="token namespace">[root@localhost ~]</span>$ iptables <span class="token operator">-</span>t nat <span class="token operator">-</span>A POSTROUTING <span class="token operator">-</span>s 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0<span class="token operator">/</span>24 <span class="token operator">-</span>o eth0 <span class="token operator">-</span>j SNAT <span class="token operator">--</span>to<span class="token operator">-</span>source 20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>11 
<span class="token comment"># 添加防火墙记录，当源地址是 内网网段 并且出口网卡为 eth0 的时候进行 SNAT 转换， 转换源地址为外网卡地址</span>

<span class="token namespace">[root@localhost ~]</span>$ iptables <span class="token operator">-</span>t nat <span class="token operator">-</span>L <span class="token comment"># 查看记录是否保存成功</span>
Chain PREROUTING <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt source               destination         

Chain POSTROUTING <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt source               destination         
SNAT       all  <span class="token operator">--</span>  10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0<span class="token operator">/</span>24        anywhere            to:20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>11 


Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt source               destination 

<span class="token namespace">[root@localhost ~]</span>$ service iptables save

<span class="token namespace">[root@localhost ~]</span>$ iptables <span class="token operator">-</span>t nat <span class="token operator">-</span>D POSTROUTING 1 <span class="token comment">#删除规则</span>

</code></pre> 
<p>添加ipvs规则</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>A <span class="token operator">-</span>t 20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>11:80 <span class="token operator">-</span>s rr 
<span class="token comment"># 添加 ipvsadm TCP 集群 </span>

<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>a <span class="token operator">-</span>t 20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>11:80 <span class="token operator">-</span>r 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12:80 <span class="token operator">-</span>m 
<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>a <span class="token operator">-</span>t 20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>11:80 <span class="token operator">-</span>r 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13:8080 <span class="token operator">-</span>m 
<span class="token comment"># 添加 ipvsadm 节点，-m nat模式</span>

<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>Ln 
IP Virtual Server version 1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1 <span class="token punctuation">(</span>size=4096<span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  <span class="token operator">-</span>&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>11:80 rr
  <span class="token operator">-</span>&gt; 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12:80               Masq    1      0          0         
  <span class="token operator">-</span>&gt; 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13:8080             Masq    1      0          0 


<span class="token namespace">[root@localhost ~]</span>$ service ipvsadm save <span class="token comment"># 保存 ipvs 集群设置到文件进行持久化 </span>
<span class="token namespace">[root@localhost ~]</span>$ service ipvsadm <span class="token function">start</span> &amp;&amp; chkconfig ipvsadm on
</code></pre> 
<br> 
<h5><a id="2322_1010101213_687"></a>2.3.2.2 真实服务器(10.10.10.12、13)</h5> 
<p>两台真实服务器都需要操作</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ service NetworkManager stop &amp;&amp; chkconfig NetworkManager off
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">echo</span> <span class="token string">"GATEWAY=10.10.10.11"</span> &gt;&gt; <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>network<span class="token operator">-</span>scripts<span class="token operator">/</span>ifcfg<span class="token operator">-</span>eth0


<span class="token comment">#添加网关指向负载调度器</span>

<span class="token namespace">[root@localhost ~]</span>$ service network restart
<span class="token namespace">[root@localhost ~]</span>$ route <span class="token operator">-</span>n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use 
0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0         10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11     0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0         UG    0      0        0 eth0
<span class="token comment">#去任何地址都交给10.10.10.11</span>


<span class="token namespace">[root@localhost ~]</span>$ service httpd <span class="token function">start</span>  &amp;&amp; chkconfig httpd on <span class="token comment"># 开启 Apache 服务器</span>

<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">echo</span> <span class="token string">"111111"</span> &gt;&gt; <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>index<span class="token punctuation">.</span>html
<span class="token comment"># echo "222222" &gt;&gt; /var/www/html/index.html 10.13服务的是222222</span>
</code></pre> 
<p>修改<code>10.10.10.13</code>服务器的httpd.conf文件</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>httpd<span class="token operator">/</span>conf<span class="token operator">/</span>httpd<span class="token punctuation">.</span>conf
<span class="token comment">#Listen 12.34.56.78:80</span>
Listen 8080   <span class="token comment">#修改成8080</span>
<span class="token namespace">[root@localhost ~]</span>$ service httpd restart
</code></pre> 
<p>浏览器输入<code>20.20.20.11</code>访问或者使用<code>curl 20.20.20.11</code></p> 
<p><img src="https://images2.imgbox.com/ff/7a/3PnpwgYK_o.png" alt="在这里插入图片描述"></p> 
<p>TUN 模式不常用，这里就不做实验了，构建可自行百度</p> 
<br> 
<h3><a id="24__727"></a>2.4 负载均衡集群相关调度算法</h3> 
<h4><a id="241__728"></a>2.4.1 静态调度算法</h4> 
<p><strong>特点：</strong> 只根据算法本身去调度，不考虑服务器本身(服务器压力，性能)</p> 
<p><strong>算法说明</strong></p> 
<ul><li><strong>RR 轮询：</strong> 将每次用户的请求分配给后端的服务器，从第一台服务器开始到第 N 台结束， 然后循环</li><li><strong>WRR 加权轮询：</strong> 按照权重的比例实现在多台主机之间进行调度 ，当前连接数除以权重，权重相当于分母</li><li><strong>SH（source hash）源地址散列：</strong> 将同一个 IP 的用户请求，发送给同一个服务器</li><li><strong>DH（destination hash）目标地址散列：</strong> 将同一个目标地址的用户请求发送给同一个真实服务 器（常见在缓存服务器使用，提高缓存的命中率）</li></ul> 
<br> 
<h4><a id="242__739"></a>2.4.2 动态调度算法</h4> 
<p><strong>http 连接</strong><br>   <strong>活动连接</strong><br>    正在传输数据</p> 
<p>  <strong>非活动连接</strong><br>    刚建立握手还没有传输数据<br>    传输数据完毕，还没有来的及断开</p> 
<br> 
<p><strong>特点：</strong> 除了考虑算法本身，还要考虑服务器状态</p> 
<p><strong>算法说明</strong></p> 
<ul><li><strong>LC（lest-connection）最少连接：</strong> 将新的连接请求，分配给连接数最少的服务器 <code>活动连接 × 256 + 非活动连接</code></li><li><strong>WLC 加权最少连接：</strong> 特殊的最少连接算法，权重越大承担的请求数越多 <code>（活 动连接 × 256 + 非活动连接 ） / 权重</code></li><li><strong>SED 最短期望延迟：</strong> 特殊的 WLC 算法 <code>（活动连接 + 1） * 256 / 权重</code></li><li><strong>NQ 永不排队：</strong> 特殊的 SED 算法，无需等待，如果有真实服务器的连接数等于 0 那就直接 分配不需要运算</li><li><strong>LBLC 特殊的 DH 算法：</strong> 即能提高缓存命中率，又要考虑服务器性能</li><li><strong>LBLCR LBLC+缓存：</strong> 尽可能提高负载均衡和缓存命中率的折中方案</li></ul> 
<br> 
<h3><a id="25_LVS__764"></a>2.5 LVS 持久连接</h3> 
<h4><a id="251__765"></a>2.5.1 持久客户端连接</h4> 
<p><strong>定义：</strong> 每客户端持久；将来自于同一个客户端的所有请求统统定向至此前选定的 RS；也就是只要 IP 相同，分配的服务器始终相同</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>A <span class="token operator">-</span>t 172<span class="token punctuation">.</span>16<span class="token punctuation">.</span>0<span class="token punctuation">.</span>8:0 <span class="token operator">-</span>s wlc <span class="token operator">-</span>p 120 
<span class="token comment"># 添加一个 tcp 负载集群，集群地址为 172.16.0.8 ， 算法为 wlc，持久化时间为 120s</span>
</code></pre> 
<br> 
<h4><a id="252__776"></a>2.5.2 持久端口连接</h4> 
<p><strong>定义：</strong> 每端口持久；将来自于同一个客户端对同一个服务(端口)的请求，始终定向至此前选定的 RS</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>A <span class="token operator">-</span>t 172<span class="token punctuation">.</span>16<span class="token punctuation">.</span>0<span class="token punctuation">.</span>8:80 <span class="token operator">-</span>s rr <span class="token operator">-</span>p 120 
<span class="token comment"># 添加一个 tcp 负载集群，集群地址为 172.16.0.8:80 ， 算法为 wlc，持久化时间为 120s</span>
</code></pre> 
<br> 
<h4><a id="253__787"></a>2.5.3 持久防火墙标记连接</h4> 
<p><strong>定义：</strong> 将来自于同一客户端对指定服务(端口)的请求，始终定向至此选定的 RS；不过它可以将两个毫 不相干的端口定义为一个集群服务</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ iptables <span class="token operator">-</span>t mangle <span class="token operator">-</span>A PREROUTING <span class="token operator">-</span>d 172<span class="token punctuation">.</span>16<span class="token punctuation">.</span>0<span class="token punctuation">.</span>8 <span class="token operator">-</span>p tcp <span class="token operator">--</span>dport 80 <span class="token operator">-</span>j MARK <span class="token operator">--</span><span class="token function">set</span><span class="token operator">-</span>mark 10 
<span class="token comment"># 添加 一个防火墙规则，当目标地址为 172.16.0.8 并且 目标端口为 80 时给数据包打一个标记，设置 mark 值为 10 </span>

<span class="token namespace">[root@localhost ~]</span>$ iptables <span class="token operator">-</span>t mangle <span class="token operator">-</span>A PREROUTING <span class="token operator">-</span>d 172<span class="token punctuation">.</span>16<span class="token punctuation">.</span>0<span class="token punctuation">.</span>8 <span class="token operator">-</span>p tcp <span class="token operator">--</span>dport 443 <span class="token operator">-</span>j MARK <span class="token operator">--</span><span class="token function">set</span><span class="token operator">-</span>mark 10 
<span class="token comment"># 添加 一个防火墙规则，当目标地址为 172.16.0.8 并且 目标端口为 443 时给数据包打一个标记，设置 mark 值为 10 service iptables save # 保存防火墙规则持久化生效 </span>

<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>A <span class="token operator">-</span>f 10 <span class="token operator">-</span>s wlc <span class="token operator">-</span>p 120 
<span class="token comment"># 添加一个负载调度器，当 mark 值为 10 时进行负载均衡使用 wlc 算法，持久化生效时间为 120s</span>
</code></pre> 
<br> 
<br> 
<h2><a id="_805"></a>三、高可用集群</h2> 
<p>  高可用集群是指<code>以减少服务中断时间为目的的服务器集群技术</code>。它通过保护用户的业务程序对外不间断提供的服务，把因软件/硬件/人为造成的故障对业务的影响降低到最小程度。高可用集群的应用系统有多样化发展趋势，用途也越来越多样化，同时带来了配置及可操作性方面的复杂性，因此选择好的高可用软件至关重要。</p> 
<h3><a id="31_Keepalived__809"></a>3.1 Keepalived 相关说明</h3> 
<p>官方网站：<a href="https://www.keepalived.org/" rel="nofollow">https://www.keepalived.org/</a></p> 
<h4><a id="311_Keepalived__813"></a>3.1.1 Keepalived 相关介绍</h4> 
<p><strong>Keepalived 简介</strong></p> 
<p>   Keepalived起初是为LVS设计的，专门用来监控集群系统中各个服务节点的状态，它根据TCP/IP参考模型的第三、第四层、第五层交换机制检测每个服务节点的状态，如果某个服务器节点出现异常，或者工作出现故障，Keepalived 将检测到，并将出现的故障的服务器节点从集群系统中剔除，这些工作全部是自动完成的，不需要人工干涉，需要人工完成的只是修复出现故障的服务节点。</p> 
<p>   后来 Keepalived 又加入了VRRP的功能，VRRP（VritrualRouterRedundancyProtocol,虚拟路由冗余协议)出现的目的是解决静态路由出现的单点故障问题，通过VRRP可以实现网络不间断稳定运行，因此 Keepalvied 一方面具有服务器状态检测和故障隔离功能，另外一方面也有 HAcluster 功能。</p> 
<p>  Keepalived 软件主要是通过<code>VRRP协议实现高可用功能的,</code>VRRP是Virtual Router Redundancy Protocol（虚拟路由器冗余协议）的缩写.VRRP出现的目的就是为了解决静态路由单点故障问题的</p> 
<p><strong>VRRP 简介</strong></p> 
<p>  虚拟路由器冗余协议（VRRP）是一种选择协议，它可以把一个虚拟路由器的责任动态分配到局域网上的 VRRP 路由器中的一台。控制虚拟路由器 IP 地址的 VRRP 路由器称为主路由器，它负责转发数据包到这些虚拟 IP 地址。一旦主路由器不可用，这种选择过程就提供了动态的故障转移机制，这就允许虚拟路由器的 IP 地址可以作为终端主机的默认第一跳路由器。使用 VRRP 的好处是有更高的默认路径的可用性而无需在每个终端主机上配置动态路由或路由发现协议。 VRRP 包封装在 IP 包中发送。</p> 
<p><strong>keepalived主要功能</strong></p> 
<p>  对RealServer进行健康状态检查，支持3层、4层、7层协议进行健康检查；并支持VRRP冗余协议，所以keepalived两个功能是监控检查，VRRP冗余协议；</p> 
<p><strong>keepalived的作用</strong></p> 
<p>  检查web服务器的状态，如果有一台web服务器/mysql服务器宕机或故障，keepalived将故障节点从系统中剔除，当故障恢复的时候自动加入服务器集群中，非常智能化，只需要手动修复坏的节点即可。</p> 
<p><strong>keepalived的layer3、4、7层分别是IP层、传输层、应用层的实现原理如下：</strong></p> 
<ul><li> <p><strong>layer3：</strong> keepalived定期向集群中服务器发送ICMP的包，如果发现哪台ping不通，便报告这台服务器失效，并将其剔除集群；（判断标准为IP是否有效）</p> </li><li> <p><strong>layer4：</strong> 主要以TCP端口（也可以是udp）状态来决定服务器工作是否正常，如web服务器的80端口如果没有工作，则将其剔除集群（判断标准为端口）</p> </li><li> <p><strong>layer7：</strong> 应用层，keepalived将根据用户的设定，检查服务器程序的运行是否正常，如果不是设定值，则将其剔除集群（判断标准为程序是否正常）</p> </li></ul> 
<br> 
<h4><a id="311_Keepalived__846"></a>3.1.1 Keepalived 实现原理</h4> 
<p>一主 + 多备，共用同一个 IP 地址，但优先级不同<br> <img src="https://images2.imgbox.com/f6/f1/TlpvMmX4_o.png" alt="在这里插入图片描述"></p> 
<p><strong>漂移地址：</strong> 主机地址会发生切换</p> 
<p><strong>keepalived VRRP原理</strong></p> 
<p>(1) 虚拟路由器中的路由器根据优先级选举出 Master。 Master 路由器通过发送免费 ARP 报文，将自己的虚拟 MAC 地址通知给与它连接的设备或者主机，从而承担报文转发任务；</p> 
<p>(2) Master 路由器周期性发送 VRRP 报文，以公布其配置信息（优先级等）和工作状况；</p> 
<p>(3) 如果 Master 路由器出现故障，虚拟路由器中的 Backup 路由器将根据优先级重新选举新的 Master；</p> 
<p>(4) 虚拟路由器状态切换时， Master 路由器由一台设备切换为另外一台设备，新的 Master 路由器只是简单地发送一个携带虚拟路由器的 MAC 地址和虚拟 IP地址信息的ARP 报文，这样就可以更新与它连接的主机或设备中的ARP 相关信息。网络中的主机感知不到 Master 路由器已经切换为另外一台设备。</p> 
<p>(5) Backup 路由器的优先级高于 Master 路由器时，由 Backup 路由器的工作方式（抢占方式和非抢占方式）决定是否重新选举 Master。<br> VRRP优先级的取值范围为0到255（数值越大表明优先级越高）</p> 
<br> 
<p><strong>keepalived的三个核心模块</strong></p> 
<p><code>core</code>核心模块    <code>chech</code>健康监测    <code>vrrp</code>虚拟路由冗余协议<br> <br><br> lvs健康检测shell脚本</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim check_lvs_real<span class="token punctuation">.</span>sh
<span class="token comment">#!/bin/bash</span>
<span class="token comment">#检测lvs集群节点是否正常，不正常则踢出集群</span>

VIP=20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>20<span class="token punctuation">.</span>11	<span class="token comment">#集群虚拟IP</span>
CPORT=80	<span class="token comment">#定义集群端口</span>
FAIL_BACK=127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1	<span class="token comment">#本机回环地址</span>
RS=<span class="token punctuation">(</span><span class="token string">"10.10.10.12"</span> <span class="token string">"10.10.10.13"</span><span class="token punctuation">)</span>	<span class="token comment">#编写集群地址</span>
declare <span class="token operator">-</span>a RSSTATUS  <span class="token comment">#变量RSSTATUS定义为数组态</span>
RW=<span class="token punctuation">(</span><span class="token string">"2"</span> <span class="token string">"1"</span><span class="token punctuation">)</span>
RPORT=80	<span class="token comment">#定义集群端口</span>
<span class="token function">TYPE</span>=g	  <span class="token comment">#制定LVS工作模式：g=DR m=NAT</span>
CHKLOOP=3
LOG=<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>ipvsmonitor<span class="token punctuation">.</span>log

<span class="token comment">#添加RS，添加成功返回0，否则返回1</span>
addrs<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  ipvsadm <span class="token operator">-</span>a <span class="token operator">-</span>t <span class="token variable">$VIP</span>:<span class="token variable">$CPORT</span> <span class="token operator">-</span>r <span class="token variable">$1</span>:<span class="token variable">$RPORT</span> <span class="token operator">-</span><span class="token variable">$TYPE</span> <span class="token operator">-</span>w <span class="token variable">$2</span>
  <span class="token punctuation">[</span> $? <span class="token operator">-eq</span> 0 <span class="token punctuation">]</span> &amp;&amp; <span class="token keyword">return</span> 0 <span class="token punctuation">|</span><span class="token punctuation">|</span> <span class="token keyword">return</span> 1
<span class="token punctuation">}</span>

<span class="token comment">#删除RS，删除成功返回0，否则返回1</span>
delrs<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  ipvsadm <span class="token operator">-</span>d <span class="token operator">-</span>t <span class="token variable">$VIP</span>:<span class="token variable">$CPORT</span> <span class="token operator">-</span>r <span class="token variable">$1</span>:<span class="token variable">$RPORT</span>
  <span class="token punctuation">[</span> $? <span class="token operator">-eq</span> 0 <span class="token punctuation">]</span> &amp;&amp; <span class="token keyword">return</span> 0 <span class="token punctuation">|</span><span class="token punctuation">|</span> <span class="token keyword">return</span> 1
<span class="token punctuation">}</span>

<span class="token comment">#检测RS服务是否在线，注意一下这里面指的RS的服务，如果连续三次都监测不通，则返回1，否则返回0</span>
checkrs<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  local I=1
  <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">$I</span> <span class="token operator">-le</span> <span class="token variable">$CHKLOOP</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
	<span class="token keyword">if</span> curl <span class="token operator">--</span>connect<span class="token operator">-</span>timeout 1 http:<span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$1</span> &amp;&gt; <span class="token operator">/</span>dev<span class="token operator">/</span>null<span class="token punctuation">;</span> then
	  <span class="token keyword">return</span> 0
	fi
	let I+<span class="token operator">+</span>
  done
  <span class="token keyword">return</span> 1
<span class="token punctuation">}</span>

<span class="token comment">#初始化RS在线状态，如果在线，设置节点初始化状态为1，否则为0</span>
initstatus<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  local I
  local COUNT=0<span class="token punctuation">;</span>
  <span class="token keyword">for</span> I in $<span class="token punctuation">{<!-- --></span>RS<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
	<span class="token keyword">if</span> ipvsadm <span class="token operator">-</span>L <span class="token operator">-</span>n <span class="token punctuation">|</span> grep <span class="token string">"<span class="token variable">$I</span>:<span class="token variable">$RPORT</span>"</span> &amp;&amp; &gt; <span class="token operator">/</span>dev<span class="token operator">/</span>null <span class="token punctuation">;</span> then
	  RSSTATUS<span class="token punctuation">[</span><span class="token variable">$COUNT</span><span class="token punctuation">]</span>=1
	<span class="token keyword">else</span>
	  RSSTATUS<span class="token punctuation">[</span><span class="token variable">$COUNT</span><span class="token punctuation">]</span>=0
	fi
  let COUNT+<span class="token operator">+</span>
  done
<span class="token punctuation">}</span>

<span class="token comment">#进行初始化</span>
initstatus

<span class="token comment">#监测rs是否加入到ipvs中。如果未添加并且在线则添加；如果已添加并且不在线，则删除</span>
<span class="token keyword">while</span> :<span class="token punctuation">;</span> <span class="token keyword">do</span>
  let COUNT=0
  <span class="token keyword">for</span> I in $<span class="token punctuation">{<!-- --></span>RS<span class="token punctuation">[</span><span class="token operator">*</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
	<span class="token keyword">if</span> checkrs <span class="token variable">$I</span><span class="token punctuation">;</span> then
	  <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{<!-- --></span>RSSTATUS<span class="token punctuation">[</span><span class="token variable">$COUNT</span><span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token operator">-eq</span> 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> then
		 addrs <span class="token variable">$I</span> $<span class="token punctuation">{<!-- --></span>RW<span class="token punctuation">[</span><span class="token variable">$COUNT</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
		 <span class="token punctuation">[</span> $? <span class="token operator">-eq</span> 0 <span class="token punctuation">]</span> &amp;&amp; RSSTATUS<span class="token punctuation">[</span><span class="token variable">$COUNT</span><span class="token punctuation">]</span>=1 &amp;&amp; <span class="token function">echo</span> <span class="token string">"`date +'%F %H:%M:%S'`, <span class="token variable">$I</span> is back."</span> &gt;&gt; <span class="token variable">$LOG</span>
	  fi
	<span class="token keyword">else</span>
	  <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token punctuation">{<!-- --></span>RSSTATUS<span class="token punctuation">[</span><span class="token variable">$COUNT</span><span class="token punctuation">]</span><span class="token punctuation">}</span> <span class="token operator">-eq</span> 1 <span class="token punctuation">]</span><span class="token punctuation">;</span> then
		 delrs <span class="token variable">$I</span>
		 <span class="token punctuation">[</span> $? <span class="token operator">-eq</span> 0 <span class="token punctuation">]</span> &amp;&amp; RSSTATUS<span class="token punctuation">[</span><span class="token variable">$COUNT</span><span class="token punctuation">]</span>=0 &amp;&amp; <span class="token function">echo</span> <span class="token string">"`date +'%F %H:%M:%S'`, <span class="token variable">$I</span> is gone."</span> &gt;&gt; <span class="token variable">$LOG</span>
	  fi
	fi
	let COUNT+<span class="token operator">+</span>
  done
  <span class="token function">sleep</span> 5
done

</code></pre> 
<h3><a id="32_Keepalived__LVS_DR__954"></a>3.2 Keepalived + LVS -DR 高可用实验构建</h3> 
<p><strong>四台服务器</strong></p> 
<p>10.10.10.11(lvs-m)<br> 10.10.10.12(lvs-s)<br> 10.10.10.13(rs1)<br> 10.10.10.14(rs2)</p> 
<p>先搭建 LVS-DR 模式负载均衡集群，然后在搭建 LVS 从节点</p> 
<p><img src="https://images2.imgbox.com/cb/8f/qdSVZg8B_o.png" alt="在这里插入图片描述"></p> 
<br> 
<p>四台节点全部关闭 <code>NetworkManager</code></p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ service NetworkManager stop &amp;&amp; chkconfig NetworkManager off
</code></pre> 
<h4><a id="321_LVS10101011_975"></a>3.2.1 LVS主节点(10.10.10.11)</h4> 
<pre><code class="prism language-powershell"><span class="token comment">#添加一个网卡，当做vip(虚拟服务器ip)使用</span>
<span class="token namespace">[root@localhost ~]</span>$ cd <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>network<span class="token operator">-</span>scripts<span class="token operator">/</span>
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">cp</span> <span class="token operator">-</span>a ifcfg<span class="token operator">-</span>eth0 ifcfg<span class="token operator">-</span>eth0:0
<span class="token namespace">[root@localhost ~]</span>$ vim ifcfg<span class="token operator">-</span>eth0:0
DEVICE=eth0:0
ONBOOT=yes
BOOTPROTO=static
IPADDR=10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100
NETMASK=255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0



<span class="token namespace">[root@localhost ~]</span>$ service network restart


</code></pre> 
<p>安装ipvsadm</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ <span class="token function">mount</span> <span class="token operator">-</span>t iso9660 <span class="token operator">/</span>dev<span class="token operator">/</span>cdrom <span class="token operator">/</span>mnt<span class="token operator">/</span>cdrom <span class="token comment">#挂载光盘</span>
<span class="token namespace">[root@localhost ~]</span>$ yum <span class="token operator">-</span>y install ipvsadm

</code></pre> 
<p>关闭网卡重定向功能</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf <span class="token comment">#  </span>
<span class="token comment">#最后一行添加</span>
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>all<span class="token punctuation">.</span>send_redirects = 0 
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>default<span class="token punctuation">.</span>send_redirects = 0 
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>eth0<span class="token punctuation">.</span>send_redirects = 0 

<span class="token namespace">[root@localhost ~]</span>$ sysctl <span class="token operator">-</span>p <span class="token comment">#重新加载配置文件</span>
</code></pre> 
<p>添加ipvs规则</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>v <span class="token comment"># 查看当前 ipvs 集群内容  </span>
<span class="token comment">#ipvsadm -A -t 虚拟 IP:80 -s rr </span>
<span class="token comment">#添加 ipvs TCP 集群，-A添加一个集群，-t TCP协议，-s 指定算法，rr轮询</span>
<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>A <span class="token operator">-</span>t 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80 <span class="token operator">-</span>s rr

<span class="token comment">#ipvsadm -a -t 虚拟 IP:80 -r 网站1:80 -g </span>
<span class="token comment">#添加 ipvsadm 集群子节点 ,-a 集群子节点，-r 真实服务器，-g DR模式</span>
<span class="token comment">#ipvsadm -a -t 虚拟 IP:80 -r 网站2:80 -g </span>
<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>a <span class="token operator">-</span>t 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80 <span class="token operator">-</span>r 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13:80 <span class="token operator">-</span>g
<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>a <span class="token operator">-</span>t 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80 <span class="token operator">-</span>r 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14:80 <span class="token operator">-</span>g

<span class="token namespace">[root@localhost ~]</span>$ service ipvsadm save
<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>Ln
IP Virtual Server version 1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1 <span class="token punctuation">(</span>size=4096<span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  <span class="token operator">-</span>&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80 rr
  <span class="token operator">-</span>&gt; 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13:80               Route   1      0          0         
  <span class="token operator">-</span>&gt; 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14:80               Route   1      0          0 
</code></pre> 
<h4><a id="322_1010101314__1038"></a>3.2.2 真实服务器(10.10.10.13、14 )</h4> 
<p>两台服务器做相同的步骤，另一台的网页内容不一样，其余全部一样</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ service httpd <span class="token function">start</span> &amp;&amp; chkconfig httpd on  <span class="token comment">#启动apache服务器</span>
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">echo</span> <span class="token string">"this is server 1"</span> &gt;&gt; <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>index<span class="token punctuation">.</span>html 
<span class="token comment">#另一台服务是this is server 2</span>
<span class="token namespace">[root@localhost ~]</span>$ curl localhost
this is server 1
<span class="token comment">#生产环境两台服务器的网页内容是一样的</span>
</code></pre> 
<p>开启回环网卡接口</p> 
<pre><code class="prism language-powershell"><span class="token comment"># 关闭网卡守护进程</span>
<span class="token namespace">[root@localhost ~]</span>$ service NetworkManager stop &amp;&amp; chkconfig NetworkManager off
<span class="token namespace">[root@localhost ~]</span>$ cd <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>network<span class="token operator">-</span>scripts<span class="token operator">/</span>
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">cp</span> <span class="token operator">-</span>a ifcfg<span class="token operator">-</span>lo ifcfg<span class="token operator">-</span>lo:0
<span class="token comment"># 拷贝回环网卡子接口</span>

<span class="token namespace">[root@localhost ~]</span>$ vim ifcfg<span class="token operator">-</span>lo:0  <span class="token comment">#vim !$ 上一个命令最后一条参数</span>
<span class="token comment">#修改成下面一样</span>
DEVICE=lo:0    <span class="token comment">#修改这里</span>
IPADDR=10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 <span class="token comment">#修改这里</span>
NETMASK=255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255  <span class="token comment">#修改这里</span>
NETWORK=127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
<span class="token comment"># If you're having problems with gated making 127.0.0.0/8 a martian,</span>
<span class="token comment"># you can change this to something else (255.255.255.255, for example)</span>
BROADCAST=127<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255
ONBOOT=yes
NAME=loopback
</code></pre> 
<p>修改内核配置文件</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf <span class="token comment">#关闭对应 ARP 响应及公告功能</span>
<span class="token comment">#最后一行添加</span>
<span class="token comment"># LVS - ARP</span>
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>all<span class="token punctuation">.</span>arp_ignore = 1
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>all<span class="token punctuation">.</span>arp_announce = 2
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>default<span class="token punctuation">.</span>arp_ignore = 1
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>default<span class="token punctuation">.</span>arp_announce = 2
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>lo<span class="token punctuation">.</span>arp_ignore = 1
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>lo<span class="token punctuation">.</span>arp_announce = 2


<span class="token namespace">[root@localhost ~]</span>$ sysctl <span class="token operator">-</span>p <span class="token comment">#重新加载配置文件</span>

<span class="token namespace">[root@localhost ~]</span>$ ifup lo:0  <span class="token comment">#启动回环网卡</span>

<span class="token namespace">[root@localhost ~]</span>$ ifconfig
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
lo:0      Link encap:Local Loopback  
          inet addr:10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100  Mask:255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
</code></pre> 
<p>添加路由记录，当访问 VIP 交给 lo:0 网卡接受</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ route add <span class="token operator">-</span>host 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 dev lo:0
<span class="token namespace">[root@localhost ~]</span>$ route <span class="token operator">-</span>n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100    0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0         255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255 UH    0      0        0 lo
10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0      0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0         255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0   U     0      0        0 eth0
169<span class="token punctuation">.</span>254<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0     0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0         255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0     U     1002   0        0 eth0

<span class="token comment">#添加到开机自启，防止失效</span>
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">echo</span> <span class="token string">"route add -host 10.10.10.100 dev lo:0"</span> &gt;&gt; <span class="token operator">/</span>etc<span class="token operator">/</span>rc<span class="token punctuation">.</span>local
</code></pre> 
<p>浏览器输入<code>10.10.10.100</code>访问<br> <img src="https://images2.imgbox.com/ec/74/qfASmnRH_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/16/e1/THJBcGqE_o.png" alt="在这里插入图片描述"><br> <br></p> 
<h4><a id="323__Keepalived_MASTER10101011_1119"></a>3.2.3 搭建 Keepalived的 MASTER(10.10.10.11)</h4> 
<p>所需软件百度网盘<br> 链接：<a href="https://pan.baidu.com/s/1wfgE3ISFsBddoO2JuMdRiA" rel="nofollow">https://pan.baidu.com/s/1wfgE3ISFsBddoO2JuMdRiA</a><br> 提取码：ton9</p> 
<p>上传Keepalived，然后挂载</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ yum -y <span class="token function">install</span> lrzsz <span class="token comment">#方便把软件直接拖到xshell里面</span>

<span class="token comment">#上传Keepalived.iso 镜像文件到家目录</span>

<span class="token comment">#由于 keepalived是一个镜像文件，所以创建一个目录，方便挂载</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">mkdir</span> /mnt/iso1

<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">mount</span> -o loop Keepalived.iso /mnt/iso1 <span class="token comment">#挂载</span>

<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">cp</span> -a /mnt/iso1/* <span class="token keyword">.</span>

</code></pre> 
<p>安装 Keepalived</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ yum <span class="token operator">-</span>y install kernel<span class="token operator">-</span>devel openssl<span class="token operator">-</span>devel popt<span class="token operator">-</span>devel gcc<span class="token operator">*</span> <span class="token comment"># 安装相关 keepalived 依赖</span>
<span class="token namespace">[root@localhost ~]</span>$ tar <span class="token operator">-</span>zxvf keepalived<span class="token operator">-</span>1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>2<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz &amp;&amp; cd keepalived<span class="token operator">-</span>1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>2

<span class="token namespace">[root@localhost ~]</span>$ <span class="token punctuation">.</span><span class="token operator">/</span>configure <span class="token operator">--</span>prefix=<span class="token operator">/</span> <span class="token operator">--</span>with<span class="token operator">-</span>kernel<span class="token operator">-</span><span class="token function">dir</span>=<span class="token operator">/</span>usr<span class="token operator">/</span>src<span class="token operator">/</span>kernels<span class="token operator">/</span>2<span class="token punctuation">.</span>6<span class="token punctuation">.</span>32<span class="token operator">-</span>642<span class="token punctuation">.</span>el6<span class="token punctuation">.</span>x86_64<span class="token operator">/</span>
<span class="token namespace">[root@localhost ~]</span>$ make &amp;&amp; make install <span class="token comment">#编译安装</span>

<span class="token namespace">[root@localhost ~]</span>$ chkconfig <span class="token operator">--</span>add keepalived <span class="token comment"># 设置 Keepalived 开机自启</span>
<span class="token namespace">[root@localhost ~]</span>$ chkconfig keepalived on
</code></pre> 
<p>修改 Keepalived 软件配置</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>keepalived<span class="token operator">/</span>keepalived<span class="token punctuation">.</span>conf <span class="token comment"># 修改 配置</span>
global_defs <span class="token punctuation">{<!-- --></span> 
	router_id R1 <span class="token comment">#命名主机名，同一个组名称不能一致</span>
<span class="token punctuation">}</span>

<span class="token comment">#VRRP相关设置</span>
vrrp_instance VI_1 <span class="token punctuation">{<!-- --></span> 
	state MASTER  <span class="token comment"># 设置服务类型主/从（MASTER/SLAVE） </span>
	interface eth0 <span class="token comment"># 指定那块网卡用来监听 </span>
	virtual_router_id 66 <span class="token comment"># 设置组号， 如果是一组就是相同的 ID 号， 一个主里面只能有一个主 服务器和多个从服务器 </span>
	priority 80 <span class="token comment"># 服务器优先级， 主服务器优先级高 ，主从差距最好是50</span>
	advert_int 1 <span class="token comment"># 心跳时间， 检测对方存活 </span>
	authenticetion <span class="token punctuation">{<!-- --></span> <span class="token comment"># 存活验证密码</span>
		auth_type PASS 
		auth_pass 1111 
	<span class="token punctuation">}</span>
	virtual_ipaddress <span class="token punctuation">{<!-- --></span> 
		10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 <span class="token comment">#设置集群地址，vip（虚拟ip地址）</span>
	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token comment">#虚拟服务</span>
virtual_server 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 80 <span class="token punctuation">{<!-- --></span><span class="token comment"># 设置集群地址 以及端口号 </span>
	delay_loop 6 <span class="token comment"># 健康检查间隔 </span>
	lb_algorr <span class="token comment"># 使用轮询调度算法 </span>
	lb_kind DR <span class="token comment"># DR 模式的群集 </span>
	<span class="token comment">#net_mask 255.255.255.0 #子网掩码</span>
	<span class="token comment">#persisitence_timeout 50 #持久化</span>
	protocol TCP <span class="token comment"># 使用的协议 </span>
	
	<span class="token comment">#真实服务器健康状态监测，几个真实服务器就写几个real_server</span>
	real_server 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13 80 <span class="token punctuation">{<!-- --></span> <span class="token comment"># 管理的网站节点以及使用端口 </span>
		weight 1 <span class="token comment"># 权重， 优先级 在原文件基础上删除修改 </span>
		TCP_CHECK <span class="token punctuation">{<!-- --></span> <span class="token comment"># 状态检查方式 </span>
			connect_port 80 <span class="token comment"># 检查的目标端口 </span>
			connect_timeout 3 <span class="token comment"># 连接超时（秒） </span>
			nb_get_retry 3 <span class="token comment"># 重试次数 </span>
			delay_before_retry 4 <span class="token comment"># 重试间隔（秒）</span>
	<span class="token punctuation">}</span> 
 <span class="token punctuation">}</span>
   <span class="token comment">#真实服务器健康状态监测</span>
	real_server 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14 80 <span class="token punctuation">{<!-- --></span> <span class="token comment"># 管理的第二个网站节点以及使用端口 </span>
		weight 1 <span class="token comment"># 权重， 优先级 在原文件基础上删除修改 </span>
		TCP_CHECK <span class="token punctuation">{<!-- --></span> <span class="token comment"># 状态检查方式 </span>
		connect_port 80 <span class="token comment"># 检查的目标端口 </span>
		connect_timeout 3 <span class="token comment"># 连接超时（秒） </span>
		nb_get_retry 3 <span class="token comment"># 重试次数 </span>
		delay_before_retry 4 <span class="token comment"># 重试间隔（秒） </span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token comment"># 多余删除 dG 删除光标之后的所有内容</span>



<span class="token namespace">[root@localhost ~]</span>$ service keepalived <span class="token function">start</span>

<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">cat</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>messages 
Dec 22 11:42:18 localhost Keepalived_healthcheckers: IPVS: Service already exists
Dec 22 11:42:18 localhost Keepalived_healthcheckers: <span class="token keyword">Using</span> LinkWatch kernel netlink reflector<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Dec 22 11:42:18 localhost Keepalived_healthcheckers: Activating healtchecker <span class="token keyword">for</span> service <span class="token punctuation">[</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13<span class="token punctuation">]</span>:80
Dec 22 11:42:18 localhost Keepalived_healthcheckers: Activating healtchecker <span class="token keyword">for</span> service <span class="token punctuation">[</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14<span class="token punctuation">]</span>:80
Dec 22 11:42:19 localhost Keepalived_vrrp: VRRP_Instance<span class="token punctuation">(</span>VI_1<span class="token punctuation">)</span> Transition to MASTER STATE
Dec 22 11:42:20 localhost Keepalived_vrrp: VRRP_Instance<span class="token punctuation">(</span>VI_1<span class="token punctuation">)</span> Entering MASTER STATE
Dec 22 11:42:20 localhost Keepalived_vrrp: VRRP_Instance<span class="token punctuation">(</span>VI_1<span class="token punctuation">)</span> setting protocol VIPs<span class="token punctuation">.</span>
Dec 22 11:42:20 localhost Keepalived_vrrp: VRRP_Instance<span class="token punctuation">(</span>VI_1<span class="token punctuation">)</span> Sending gratuitous ARPs on eth0 <span class="token keyword">for</span> 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100
Dec 22 11:42:20 localhost Keepalived_healthcheckers: Netlink reflector reports IP 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 added
Dec 22 11:42:25 localhost Keepalived_vrrp: VRRP_Instance<span class="token punctuation">(</span>VI_1<span class="token punctuation">)</span> Sending gratuitous ARPs on eth0 <span class="token keyword">for</span> 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100

</code></pre> 
<br> 
<h4><a id="324__Keepalived_SLAVE10101012_1227"></a>3.2.4 搭建 Keepalived的 SLAVE(10.10.10.12)</h4> 
<p>关闭网卡启动脚本的拒绝，就能启动这个网卡，局域网两个相同的ip，请求会平均分发，keepalived会绑定vrrp权限，如果主或者，从的不会使用，主挂了，才会使用从</p> 
<pre><code class="prism language-powershell"><span class="token comment">#添加一个网卡，当做vip(虚拟服务器ip)使用</span>
<span class="token namespace">[root@localhost ~]</span>$ cd <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>network<span class="token operator">-</span>scripts<span class="token operator">/</span>
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">cp</span> <span class="token operator">-</span>a ifcfg<span class="token operator">-</span>eth0 ifcfg<span class="token operator">-</span>eth0:0
<span class="token namespace">[root@localhost ~]</span>$ vim ifcfg<span class="token operator">-</span>eth0:0
DEVICE=eth0:0
ONBOOT=yes
BOOTPROTO=static
IPADDR=10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100
NETMASK=255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0



<span class="token namespace">[root@localhost ~]</span>$ ifup eth0:0
Determining <span class="token keyword">if</span> ip address 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 is already in use <span class="token keyword">for</span> device eth0<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Error<span class="token punctuation">,</span> some other host <span class="token punctuation">(</span>00:0C:29:0A:56:2E<span class="token punctuation">)</span> already uses address 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100<span class="token punctuation">.</span>

<span class="token comment"># 如果 报错修改文件 247行左右</span>
<span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>network<span class="token operator">-</span>scripts<span class="token operator">/</span>ifup<span class="token operator">-</span>eth
<span class="token comment">#注释这几行</span>
<span class="token comment">#if ! ARPING=$(/sbin/arping -c 2 -w ${ARPING_WAIT:-3} -D -I ${REALDEVICE} ${ipaddr[$idx]}) ; then</span>
<span class="token comment">#	ARPINGMAC=$(echo $ARPING |  sed -ne 's/.*\[\(.*\)\].*/\1/p')</span>
<span class="token comment">#	net_log $"Error, some other host ($ARPINGMAC) already uses address ${ipaddr[$idx]}."</span>
<span class="token comment">#	exit 1</span>
<span class="token comment">#fi</span>


<span class="token namespace">[root@localhost ~]</span>$ ifup eth0:0 <span class="token comment">#然后重新启动即可</span>
</code></pre> 
<p>上传Keepalived，然后挂载</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">mount</span> -t iso9660 /dev/cdrom /mnt/cdrom <span class="token comment">#挂载yum光盘</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ yum -y <span class="token function">install</span> lrzsz <span class="token comment">#方便把软件直接拖到xshell里面</span>

<span class="token comment">#上传Keepalived.iso 镜像文件到家目录</span>

<span class="token comment">#由于 keepalived是一个镜像文件，所以创建一个目录，方便挂载</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">mkdir</span> /mnt/iso1

<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">mount</span> -o loop Keepalived.iso /mnt/iso1 <span class="token comment">#挂载</span>

<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">cp</span> -a /mnt/iso1/* <span class="token keyword">.</span>

</code></pre> 
<p>安装 Keepalived</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ yum <span class="token operator">-</span>y install kernel<span class="token operator">-</span>devel openssl<span class="token operator">-</span>devel popt<span class="token operator">-</span>devel gcc<span class="token operator">*</span> <span class="token comment"># 安装相关 keepalived 依赖</span>
<span class="token namespace">[root@localhost ~]</span>$ tar <span class="token operator">-</span>zxvf keepalived<span class="token operator">-</span>1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>2<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz &amp;&amp; cd keepalived<span class="token operator">-</span>1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>2

<span class="token namespace">[root@localhost ~]</span>$ <span class="token punctuation">.</span><span class="token operator">/</span>configure <span class="token operator">--</span>prefix=<span class="token operator">/</span> <span class="token operator">--</span>with<span class="token operator">-</span>kernel<span class="token operator">-</span><span class="token function">dir</span>=<span class="token operator">/</span>usr<span class="token operator">/</span>src<span class="token operator">/</span>kernels<span class="token operator">/</span>2<span class="token punctuation">.</span>6<span class="token punctuation">.</span>32<span class="token operator">-</span>642<span class="token punctuation">.</span>el6<span class="token punctuation">.</span>x86_64<span class="token operator">/</span>
<span class="token namespace">[root@localhost ~]</span>$ make &amp;&amp; make install <span class="token comment">#编译安装</span>

<span class="token namespace">[root@localhost ~]</span>$ chkconfig <span class="token operator">--</span>add keepalived <span class="token comment"># 设置 Keepalived 开机自启</span>
<span class="token namespace">[root@localhost ~]</span>$ chkconfig keepalived on
</code></pre> 
<p>关闭网卡重定向功能</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf 
<span class="token comment">#最后一行添加</span>
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>all<span class="token punctuation">.</span>send_redirects = 0 
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>default<span class="token punctuation">.</span>send_redirects = 0 
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>eth0<span class="token punctuation">.</span>send_redirects = 0 

<span class="token namespace">[root@localhost ~]</span>$ sysctl <span class="token operator">-</span>p <span class="token comment">#重新加载配置文件</span>
</code></pre> 
<p>修改 Keepalived 软件配置</p> 
<pre><code class="prism language-powershell"> <span class="token comment">#把远程服务器的keepalived.conf 下载到本地/etc/keepalived目录下</span>
<span class="token namespace">[root@localhost ~]</span>$ scp root@10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11:<span class="token operator">/</span>etc<span class="token operator">/</span>keepalived<span class="token operator">/</span>keepalived<span class="token punctuation">.</span>conf <span class="token operator">/</span>etc<span class="token operator">/</span>keepalived<span class="token operator">/</span>

<span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>keepalived<span class="token operator">/</span>keepalived<span class="token punctuation">.</span>conf
<span class="token comment">#修改 1：router_id R1 修改为  router_id R2</span>
<span class="token comment">#修改 2：state MASTER 修改至 state SLAVE </span>
<span class="token comment">#修改 3：priority 100 修改至 priority 47 一般建议与主服务器差值为 50</span>

global_defs <span class="token punctuation">{<!-- --></span> 
	router_id R2 <span class="token comment">#命名主机名，同一个组名称不能一致</span>
<span class="token punctuation">}</span>

<span class="token comment">#VRRP相关设置</span>
vrrp_instance VI_1 <span class="token punctuation">{<!-- --></span> 
	state SLAVE  <span class="token comment"># 设置服务类型主/从（MASTER/SLAVE） </span>
	interface eth0 <span class="token comment"># 指定那块网卡用来监听 </span>
	virtual_router_id 66 <span class="token comment"># 设置组号， 如果是一组就是相同的 ID 号， 一个主里面只能有一个主 服务器和多个从服务器 </span>
	priority 20 <span class="token comment"># 服务器优先级， 主服务器优先级高 ，主从差距最好是50</span>
	advert_int 1 <span class="token comment"># 心跳时间， 检测对方存活 </span>
	authenticetion <span class="token punctuation">{<!-- --></span> <span class="token comment"># 存活验证密码</span>
		auth_type PASS 
		auth_pass 1111 
	<span class="token punctuation">}</span>
	virtual_ipaddress <span class="token punctuation">{<!-- --></span> 
		10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 <span class="token comment">#设置集群地址，vip（虚拟ip地址）</span>
	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token comment">#虚拟服务</span>
virtual_server 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 80 <span class="token punctuation">{<!-- --></span><span class="token comment"># 设置集群地址 以及端口号 </span>
	delay_loop 6 <span class="token comment"># 健康检查间隔 </span>
	lb_algorr <span class="token comment"># 使用轮询调度算法 </span>
	lb_kind DR <span class="token comment"># DR 模式的群集 </span>
	<span class="token comment">#net_mask 255.255.255.0 #子网掩码</span>
	<span class="token comment">#persisitence_timeout 50 #持久化</span>
	protocol TCP <span class="token comment"># 使用的协议 </span>
	
	<span class="token comment">#真实服务器健康状态监测，几个真实服务器就写几个real_server</span>
	real_server 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13 80 <span class="token punctuation">{<!-- --></span> <span class="token comment"># 管理的网站节点以及使用端口 </span>
		weight 1 <span class="token comment"># 权重， 优先级 在原文件基础上删除修改 </span>
		TCP_CHECK <span class="token punctuation">{<!-- --></span> <span class="token comment"># 状态检查方式 </span>
			connect_port 80 <span class="token comment"># 检查的目标端口 </span>
			connect_timeout 3 <span class="token comment"># 连接超时（秒） </span>
			nb_get_retry 3 <span class="token comment"># 重试次数 </span>
			delay_before_retry 4 <span class="token comment"># 重试间隔（秒）</span>
	<span class="token punctuation">}</span> 
 <span class="token punctuation">}</span>
   <span class="token comment">#真实服务器健康状态监测</span>
	real_server 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14 80 <span class="token punctuation">{<!-- --></span> <span class="token comment"># 管理的第二个网站节点以及使用端口 </span>
		weight 1 <span class="token comment"># 权重， 优先级 在原文件基础上删除修改 </span>
		TCP_CHECK <span class="token punctuation">{<!-- --></span> <span class="token comment"># 状态检查方式 </span>
		connect_port 80 <span class="token comment"># 检查的目标端口 </span>
		connect_timeout 3 <span class="token comment"># 连接超时（秒） </span>
		nb_get_retry 3 <span class="token comment"># 重试次数 </span>
		delay_before_retry 4 <span class="token comment"># 重试间隔（秒） </span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token namespace">[root@localhost ~]</span>$ yum <span class="token operator">-</span>y install ipvsadm <span class="token comment">#安装ipvsadm</span>
<span class="token namespace">[root@localhost ~]</span>$ service ipvsadm <span class="token function">start</span> &amp;&amp; chkconfig ipvsadm on

<span class="token namespace">[root@localhost ~]</span>$ service keepalived <span class="token function">start</span> <span class="token comment">#启动keepalived </span>

<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>Ln <span class="token operator">--</span>stats
IP Virtual Server version 1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1 <span class="token punctuation">(</span>size=4096<span class="token punctuation">)</span>
Prot LocalAddress:Port               Conns   InPkts  OutPkts  InBytes OutBytes
  <span class="token operator">-</span>&gt; RemoteAddress:Port
TCP  10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80                    17       85        0    11833        0
  <span class="token operator">-</span>&gt; 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13:80                      8       40        0     6072        0
  <span class="token operator">-</span>&gt; 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14:80                      9       45        0     5761        0

</code></pre> 
<p>至此 Keepalived + lvs 高可用集群搭建完毕</p> 
<p><strong>测试</strong></p> 
<p>把<code>10.10.10.11</code>的服务器关机，浏览器输入<code>10.10.10.100</code>依然可以访问</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>Ln <span class="token operator">--</span>stats
IP Virtual Server version 1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1 <span class="token punctuation">(</span>size=4096<span class="token punctuation">)</span>
Prot LocalAddress:Port               Conns   InPkts  OutPkts  InBytes OutBytes
  <span class="token operator">-</span>&gt; RemoteAddress:Port
TCP  10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80                    17       85        0    11833        0
  <span class="token operator">-</span>&gt; 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13:80                      8       40        0     6072        0
  <span class="token operator">-</span>&gt; 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14:80                      9       45        0     5761        0
</code></pre> 
<p>把<code>10.10.10.13</code>的httpd停了</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ service httpd stop
</code></pre> 
<p>会发现把<code>10.10.10.13</code>服务给踢出去了</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>Ln <span class="token operator">--</span>stats
IP Virtual Server version 1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1 <span class="token punctuation">(</span>size=4096<span class="token punctuation">)</span>
Prot LocalAddress:Port               Conns   InPkts  OutPkts  InBytes OutBytes
  <span class="token operator">-</span>&gt; RemoteAddress:Port
TCP  10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80                    17       85        0    11833        0
  <span class="token operator">-</span>&gt; 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14:80                      9       45        0     5761        0
</code></pre> 
<br> 
<h3><a id="33_HeartBeat__Nginx__1419"></a>3.3 HeartBeat + Nginx 实验构建</h3> 
<h4><a id="331_HeartBeat__1421"></a>3.3.1 HeartBeat 简介</h4> 
<p>   Heartbeat <code>是一款开源提供高可用（Highly-Available）服务的软件</code>，通过 heartbeat 可以将资源（IP及程序服务等资源）从一台已经故障的计算机快速转移到另一台正常运转的机器上继续提供服务，一般称之为高可用服务。</p> 
<p>  Heartbeat是Linux-HA项目中的一个组件，也是当前开源HA项目中最成功的一个例子，它提供了所有HA软件所需要的基本功能，如<code>心跳检测</code>和<code>资源接管</code>、监测群集中的系统服务、在群集中的节点间转移共享IP地址的所有者等。<code>heartbeat最核心的功能包括两个部分，心跳监测和资源接管</code>。心跳监测可以通过网络链路和串口进行，而且支持冗 余链路，它们之间相互发送报文来告诉对方自己当前的状态，如果在指定的时间内未收到对方发送的报文，那么就认为对方失效，这时需启动资源接管模块来接管运行在对方主机上的资源或者服务。</p> 
<br> 
<h4><a id="332_Heartbeat_1428"></a>3.3.2 Heartbeat工作原理</h4> 
<p>  <code>通过修改配置文件，指定哪一台Heartbeat服务器作为主服务器，则另一台将自动成为备份服务器</code>。然后在指定备份服务器上配置Heartbeat守护进程来监听来自主服务器的心跳。如果备份服务器在指定时间内未监听到来自主服务器的心跳，就会启动故障转移程序，并取得主服务器上的相关资源服务所有权，接替主服务器继续不间断的提供服务，从而达到资源服务高可用性的目的。</p> 
<p>  以上描述的是Heartbeat主备的模式，Heartbeat还支持主主模式，即<code>两台服务器互为主备，这时它们之间会相互发送报文来告诉对方自己当前的状态，如果在指定的时间内为收到对方发送的心跳报文，那么久认为对方失效或者宕机了</code>，这时就会启动自身的资源接管模块来接管运行在对方主机上的资源或者服务，继续对用户提供服务。正常情况下，可以较好的实现主机故障后，业务仍不间断的持续运行。</p> 
<p>  keepalived主要控制IP飘移，配置应用简单，而且分层，layer3，4，5，各自配置极为简单。heartbeat不但可以控制IP飘移，更擅长对资源服务的控制，配置，应用比较复杂。<code>lvs的高可用建议用keepavlived</code>；<code>业务的高可用用heartbeat</code>。</p> 
<h4><a id="333_HeartBeat__Nginx__1436"></a>3.3.3 HeartBeat + Nginx 构建</h4> 
<p>软件包：软件包版本为 Centos6 系列，如果使用其它版本可以配置 eperl 源下载安装<br>   环境准备<br>     配置时间同步服务<br>     配置主机名解析</p> 
<p>两台nginx服务器</p> 
<p><strong>10.10.10.11<br> 10.10.10.12</strong></p> 
<p><strong>实验拓扑结构</strong><br> <img src="https://images2.imgbox.com/d4/00/gwfPfSqd_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3331_1010101110101012_1450"></a>3.3.3.1 基础环境搭建(10.10.10.11、10.10.10.12)</h5> 
<p>所需软件百度网盘<br> 链接：<a href="https://pan.baidu.com/s/1wfgE3ISFsBddoO2JuMdRiA" rel="nofollow">https://pan.baidu.com/s/1wfgE3ISFsBddoO2JuMdRiA</a><br> 提取码：ton9</p> 
<p><strong>两台服务器都要安装</strong></p> 
<p>上传nginx源码包</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">mount</span> -t iso9660 /dev/cdrom /mnt/cdrom <span class="token comment">#挂载yum光盘</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ yum -y <span class="token function">install</span> lrzsz <span class="token comment">#方便把软件直接拖到xshell里面</span>

<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">tar</span> -zxvf nginx-1.2.6.tar.gz <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> nginx-1.2.6
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ yum -y <span class="token function">install</span> pcre pcre-devel zlib zlib-devel  <span class="token comment">#安装依赖</span>
</code></pre> 
<p>安装nginx</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">useradd</span> -s /sbin/nologin -M nginx
<span class="token comment">#不允许远程登陆，-M 不创建家目录</span>

<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ ./configure --prefix<span class="token operator">=</span>/usr/local/nginx --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx

<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span> <span class="token comment">#编译安装</span>

<span class="token comment">#生产环境网页内容是一致的</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token keyword">echo</span> <span class="token string">"aaaaaaaa"</span> <span class="token operator">&gt;</span> /usr/local/nginx/html/index.html <span class="token comment">#10.10.10.11服务器</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token keyword">echo</span> <span class="token string">"bbbbbbbb"</span> <span class="token operator">&gt;</span> /usr/local/nginx/html/index.html <span class="token comment">#10.10.10.12服务器</span>

<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ /usr/local/nginx/sbin/nginx <span class="token comment">#启动nginx</span>

</code></pre> 
<p>配置时间同步服务</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ yum <span class="token operator">-</span>y install ntp
<span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>ntp<span class="token punctuation">.</span>conf
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">#当前网段</span>
restrict 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0 mask 255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0 nomodify notrap
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">#server全部注释，不采用官方</span>
<span class="token comment">#server 0.centos.pool.ntp.org iburst</span>
<span class="token comment">#server 1.centos.pool.ntp.org iburst</span>
<span class="token comment">#server 2.centos.pool.ntp.org iburst</span>
<span class="token comment">#server 3.centos.pool.ntp.org iburst</span>
server 127<span class="token punctuation">.</span>127<span class="token punctuation">.</span>1<span class="token punctuation">.</span>0
fudge 127<span class="token punctuation">.</span>127<span class="token punctuation">.</span>1<span class="token punctuation">.</span>0
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token namespace">[root@localhost ~]</span>$ service ntpd <span class="token function">start</span> &amp;&amp; chkconfig ntpd on

<span class="token comment">#10.10.10.12执行同步时间</span>
<span class="token namespace">[root@localhost ~]</span>$ ntpdate <span class="token operator">-</span>u 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11
23 Dec 23:01:18 ntpdate<span class="token punctuation">[</span>29025<span class="token punctuation">]</span>: adjust time server 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11 offset <span class="token operator">-</span>0<span class="token punctuation">.</span>059989 sec


</code></pre> 
<p>配置主机名解析</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>network
NETWORKING=yes
HOSTNAME=www<span class="token punctuation">.</span>centos1<span class="token punctuation">.</span>com
<span class="token comment">#另台的HOSTNAME=www.centos1.com</span>

<span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>hosts <span class="token comment">#两台hosts一样</span>
127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1   localhost localhost<span class="token punctuation">.</span>localdomain localhost4 localhost4<span class="token punctuation">.</span>localdomain4
::1         localhost localhost<span class="token punctuation">.</span>localdomain localhost6 localhost6<span class="token punctuation">.</span>localdomain6
10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11 www<span class="token punctuation">.</span>centos1<span class="token punctuation">.</span>com
10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12 www<span class="token punctuation">.</span>centos2<span class="token punctuation">.</span>com
</code></pre> 
<h5><a id="3332_HeartBeat_10101011_1528"></a>3.3.3.2 安装HeartBeat 主(10.10.10.11)</h5> 
<ol><li>上传heartbeat源码包，centos7构建需要安装eperl 源</li></ol> 
<pre><code class="prism language-powershell">
<span class="token namespace">[root@localhost ~]</span>$ tar <span class="token operator">-</span>zxvf heartbeat<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz &amp;&amp; cd heartbeat

<span class="token namespace">[root@localhost ~]</span>$ yum <span class="token operator">-</span>y install <span class="token operator">*</span> <span class="token comment">#安装</span>

<span class="token namespace">[root@localhost ~]</span>$ cd <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>doc<span class="token operator">/</span>heartbeat<span class="token operator">-</span>3<span class="token punctuation">.</span>0<span class="token punctuation">.</span>4<span class="token operator">/</span> 
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">cp</span> <span class="token operator">-</span>a ha<span class="token punctuation">.</span>cf authkeys haresources <span class="token operator">/</span>etc<span class="token operator">/</span>ha<span class="token punctuation">.</span>d<span class="token operator">/</span> <span class="token comment">#配置文件需拷贝到默认目录下</span>
</code></pre> 
<ol start="2"><li>认证服务，节点之间的认证配置，修改 /etc/ha.d/authkeys ，在主上(10.10.10.11)修改</li></ol> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ cd <span class="token operator">/</span>etc<span class="token operator">/</span>ha<span class="token punctuation">.</span>d<span class="token operator">/</span>
<span class="token namespace">[root@localhost ~]</span>$ dd <span class="token keyword">if</span>=<span class="token operator">/</span>dev<span class="token operator">/</span>random bs=512 count=1 <span class="token punctuation">|</span> openssl md5 <span class="token comment">#生成密钥随机数 </span>
<span class="token namespace">[root@localhost ~]</span>$ vim authkeys 
auth 3
1 crc
2 sha1 HI<span class="token operator">!</span>
3 md5 a4d20b0dd3d5e35e0f87ce4266d1dd64

<span class="token namespace">[root@localhost ~]</span>$ chmod 600 authkeys
</code></pre> 
<ol start="3"><li>heartbeat 主配置文件，修改 /etc/ha.d/ ha.cf ， 在主上(10.10.10.11)修改</li></ol> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim ha<span class="token punctuation">.</span>cf
bcast   eth0            <span class="token comment"># Linux</span>
<span class="token comment">#bcast  eth1 eth2       # Linux</span>
<span class="token comment">#bcast  le0             # Solaris</span>
<span class="token comment">#bcast  le1 le2         # Solaris</span>

<span class="token comment">#一主一备节点，需注意能后被两台主机之间解析</span>
node    www<span class="token punctuation">.</span>centos1<span class="token punctuation">.</span>com
node    www<span class="token punctuation">.</span>centos2<span class="token punctuation">.</span>com
</code></pre> 
<ol start="4"><li>配置 haresources 文件，在主上修改</li></ol> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ vim haresources
<span class="token comment">#最后一行添加</span>
www.centos1.com IPaddr::10.10.10.100/24/eth0:0
<span class="token comment">#切换ip地址</span>

<span class="token comment">#传到10.10.10.12服务器</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">cd</span> /root
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span>$ <span class="token function">scp</span> heartbeat.tar.gz root@www.centos2.com:/root/

</code></pre> 
<h5><a id="3333_HeartBeat_10101012_1583"></a>3.3.3.3 安装HeartBeat 从(10.10.10.12)</h5> 
<pre><code class="prism language-powershell">
<span class="token namespace">[root@localhost ~]</span>$ tar <span class="token operator">-</span>zxvf heartbeat<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz &amp;&amp; cd heartbeat

<span class="token namespace">[root@localhost ~]</span>$ yum <span class="token operator">-</span>y install <span class="token operator">*</span> <span class="token comment">#安装</span>

<span class="token comment">#将主三个配置文件拷贝到从上</span>
<span class="token namespace">[root@localhost ~]</span>$ cd <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>doc<span class="token operator">/</span>heartbeat<span class="token operator">-</span>3<span class="token punctuation">.</span>0<span class="token punctuation">.</span>4<span class="token operator">/</span> 
<span class="token namespace">[root@localhost ~]</span>$ scp root@10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11:<span class="token operator">/</span>etc<span class="token operator">/</span>ha<span class="token punctuation">.</span>d<span class="token operator">/</span>authkeys <span class="token operator">/</span>etc<span class="token operator">/</span>ha<span class="token punctuation">.</span>d  <span class="token comment">#下载到本地</span>
<span class="token namespace">[root@localhost ~]</span>$ scp root@10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11:<span class="token operator">/</span>etc<span class="token operator">/</span>ha<span class="token punctuation">.</span>d<span class="token operator">/</span>ha<span class="token punctuation">.</span>cf <span class="token operator">/</span>etc<span class="token operator">/</span>ha<span class="token punctuation">.</span>d  <span class="token comment">#下载到本地</span>
<span class="token namespace">[root@localhost ~]</span>$ scp root@10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>11:<span class="token operator">/</span>etc<span class="token operator">/</span>ha<span class="token punctuation">.</span>d<span class="token operator">/</span>haresources <span class="token operator">/</span>etc<span class="token operator">/</span>ha<span class="token punctuation">.</span>d  <span class="token comment">#下载到本地</span>
</code></pre> 
<ol start="5"><li>启动服务进行验证</li></ol> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>sbin<span class="token operator">/</span>nginx <span class="token comment"># 主</span>
<span class="token namespace">[root@localhost ~]</span>$ service heartbeat <span class="token function">start</span> <span class="token comment"># 主</span>
<span class="token namespace">[root@localhost ~]</span>$ <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>sbin<span class="token operator">/</span>nginx <span class="token comment">#备</span>
<span class="token namespace">[root@localhost ~]</span>$ service heartbeat <span class="token function">start</span> <span class="token comment">#备</span>

</code></pre> 
<p>关闭其中一个服务器，就可以自动切换，<code>HeartBeat 检测的是网络通信，而不是服务器是否存活</code></p> 
<p>10.10.10.11</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ mkdir <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>script
<span class="token namespace">[root@localhost ~]</span>$ vim 80<span class="token punctuation">.</span>sh
<span class="token comment">#!/bin/bash</span>

<span class="token function">PWD</span>=<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>script<span class="token operator">/</span>

URL=<span class="token string">"http://10.10.10.11/index.html"</span>

HTTP_CODE=`curl <span class="token operator">-</span>o <span class="token operator">/</span>dev<span class="token operator">/</span>null <span class="token operator">-</span>s <span class="token operator">-</span>w <span class="token string">"%{http_code}"</span> <span class="token string">"${URL}"</span>` 


<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$HTTP_CODE</span> <span class="token operator">!</span>= 200 <span class="token punctuation">]</span>
    then
	service heartbeat stop
fi

<span class="token comment">#添加定时检测</span>
<span class="token namespace">[root@localhost ~]</span>$ crontab <span class="token operator">-</span>e
<span class="token operator">*</span><span class="token operator">/</span>1 <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> bash <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>script<span class="token operator">/</span>80<span class="token punctuation">.</span>sh

</code></pre> 
<h2><a id="_1636"></a>四、多级负载(四层+七层)</h2> 
<h3><a id="41__1638"></a>4.1 实现原理</h3> 
<h4><a id="411__1639"></a>4.1.1 七层负载实现原理</h4> 
<p><img src="https://images2.imgbox.com/f7/6c/njDHudPA_o.png" alt="在这里插入图片描述"><br>   首先，客户端会发起tcp的连接到nginx，nginx会把连接翻译成它想要获取的数据，然后nginx想后端apache服务器简历完整的tcp连接访问，获取完数据后，然后把数据传送给客户端，以反向代理方式实现负载均衡</p> 
<h4><a id="412__1643"></a>4.1.2 四层负载实现原理</h4> 
<p><img src="https://images2.imgbox.com/aa/9e/EfHHKyyh_o.png" alt="在这里插入图片描述"><br>   四层采用了lvs-dr模式实现的，客户端发送数据报文到LVS，LVS去判断端口和访问的VIP（虚拟服务ip），只要这两个匹配，就会按照自己的调度规则，把请求的数据包转移后台的真实服务器上，对应服务器接收请求后，反应数据给用户。四层负载只看端口和vip，不看域名<br> <br><br> <br></p> 
<h4><a id="413__1649"></a>4.1.3 多级负载（四、七层）原理</h4> 
<p><img src="https://images2.imgbox.com/b1/5a/3zeyfjsk_o.png" alt="在这里插入图片描述"></p> 
<p>  公司有两个不同域名的门户网站，业务高峰期访问量较大，经测试nginx未能满足并发压力，两个门户网站公网地址一致，这个时候就要用到多级负载</p> 
<p><strong>两个网站，不同的域名，相同的IP，所以采用以上的方法；Nginx作为反向代理服务器，LVS对nginx采用DR负载均衡</strong></p> 
<p>  客户端发送数据报文到LVS，LVS根据算法匹配到第一个nginx或者第二个nginx，nginx里面去设置虚拟主机级别的负载均衡，判断访问的主机名是谁，如果是 <strong>.com</strong> 的话，会在服务器1和2之间负载均衡，如果是 <strong>.cn</strong> 的话，会直接去第三层。</p> 
<h3><a id="42__1663"></a>4.2 多级负载构建</h3> 
<p><strong>实验拓扑结构</strong><br> <img src="https://images2.imgbox.com/8d/a0/3UkYFsge_o.png" alt="在这里插入图片描述"><br> 六台服务器</p> 
<p><strong>10.10.10.11—LVS-DR<br> 10.10.10.12—Nginx<br> 10.10.10.13—Nginx<br> 10.10.10.14—Apache1<br> 10.10.10.15—Apache2<br> 10.10.10.16—Apache3</strong></p> 
<p>全部关闭防火墙和selinux，配置本地yum源</p> 
<h4><a id="422_apache101010141516_1679"></a>4.2.2 搭建apache服务(10.10.10.14、15、16)</h4> 
<p><code>除了网页内容不一样，其余全部一样，三台服务都执行一遍</code></p> 
<pre><code class="prism language-powershell"><span class="token comment"># 关闭网卡守护进程</span>
<span class="token namespace">[root@localhost ~]</span>$ service NetworkManager stop &amp;&amp; chkconfig NetworkManager off
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">mount</span> <span class="token operator">-</span>t iso9660 <span class="token operator">/</span>dev<span class="token operator">/</span>cdrom <span class="token operator">/</span>mnt<span class="token operator">/</span>cdrom <span class="token comment">#挂载yum光盘</span>
<span class="token namespace">[root@localhost ~]</span>$ service httpd <span class="token function">start</span> &amp;&amp; chkconfig httpd on
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">echo</span> <span class="token string">"www.test.com-1"</span> &gt;&gt; <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>index<span class="token punctuation">.</span>html <span class="token comment">#14服务器</span>
<span class="token comment">#echo "www.test.com-2" &gt;&gt; /var/www/html/index.html #15服务器</span>
<span class="token comment">#echo "www.test.cn" &gt;&gt; /var/www/html/index.html #16服务器</span>
</code></pre> 
<h4><a id="422_nginx1010101213_1691"></a>4.2.2 搭建nginx服务(10.10.10.12、13)</h4> 
<p>所需软件百度网盘<br> 链接：<a href="https://pan.baidu.com/s/1wfgE3ISFsBddoO2JuMdRiA" rel="nofollow">https://pan.baidu.com/s/1wfgE3ISFsBddoO2JuMdRiA</a><br> 提取码：ton9</p> 
<p><strong>两台服务器(10.10.10.12、13)都要执行一遍</strong></p> 
<p>上传nginx源码包</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ service NetworkManager stop &amp;&amp; chkconfig NetworkManager off
<span class="token comment"># 关闭网卡守护进程</span>

<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">mount</span> <span class="token operator">-</span>t iso9660 <span class="token operator">/</span>dev<span class="token operator">/</span>cdrom <span class="token operator">/</span>mnt<span class="token operator">/</span>cdrom <span class="token comment">#挂载yum光盘</span>
<span class="token namespace">[root@localhost ~]</span>$ yum <span class="token operator">-</span>y install lrzsz <span class="token comment">#方便把软件直接拖到xshell里面</span>
<span class="token namespace">[root@localhost ~]</span>$ yum <span class="token operator">-</span>y install pcre pcre<span class="token operator">-</span>devel zlib zlib<span class="token operator">-</span>devel gcc<span class="token operator">*</span> <span class="token comment">#安装依赖</span>

<span class="token namespace">[root@localhost ~]</span>$ tar <span class="token operator">-</span>zxvf nginx<span class="token operator">-</span>1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>6<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz &amp;&amp; cd nginx<span class="token operator">-</span>1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>6

</code></pre> 
<p>安装nginx</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ useradd <span class="token operator">-</span>s <span class="token operator">/</span>sbin<span class="token operator">/</span>nologin <span class="token operator">-</span>M nginx
<span class="token comment">#不允许远程登陆，-M 不创建家目录</span>

<span class="token namespace">[root@localhost ~]</span>$ <span class="token punctuation">.</span><span class="token operator">/</span>configure <span class="token operator">--</span>prefix=<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx <span class="token operator">--</span>user=nginx <span class="token operator">--</span><span class="token function">group</span>=nginx

<span class="token namespace">[root@localhost ~]</span>$ make &amp;&amp; make install <span class="token comment">#编译安装</span>

<span class="token comment">#修改配置nginx文件，配置负载均衡</span>
<span class="token comment">#10.10.10.12不用执行此步骤，修改完直接复制即可</span>
<span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token comment">#配置.com负载均衡</span>
	upstream test<span class="token punctuation">.</span>com <span class="token punctuation">{<!-- --></span>
        server 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>14:80<span class="token punctuation">;</span>
        server 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>15:80<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">#配置.cn负载均衡</span>
    upstream test<span class="token punctuation">.</span>cn <span class="token punctuation">{<!-- --></span>
        server 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>16:80<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">#一个server就是一个网站</span>
    server <span class="token punctuation">{<!-- --></span>
        listen       80<span class="token punctuation">;</span>
        server_name  www<span class="token punctuation">.</span>test<span class="token punctuation">.</span>com<span class="token punctuation">;</span>

        location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">#反向代理服务器</span>
                proxy_pass http:<span class="token operator">/</span><span class="token operator">/</span>test<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

     <span class="token punctuation">}</span>

    server <span class="token punctuation">{<!-- --></span>
        listen       80<span class="token punctuation">;</span>
        server_name  www<span class="token punctuation">.</span>test<span class="token punctuation">.</span>cn<span class="token punctuation">;</span>

        location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">#反向代理服务器</span>
                proxy_pass http:<span class="token operator">/</span><span class="token operator">/</span>test<span class="token punctuation">.</span>cn<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

     <span class="token punctuation">}</span>




<span class="token namespace">[root@localhost ~]</span>$ <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>sbin<span class="token operator">/</span>nginx <span class="token operator">-</span>t <span class="token comment">#检查配置文件</span>
nginx: the configuration file <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf syntax is ok
nginx: configuration file <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf test is successful


<span class="token namespace">[root@localhost ~]</span>$ <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>sbin<span class="token operator">/</span>nginx <span class="token comment">#启动ngin</span>
</code></pre> 
<p>把10.10.10.13的nginx配置文件复制到10.10.10.12</p> 
<pre><code class="prism language-powershell"><span class="token comment">#10.10.10.13服务器执行这个命令</span>
<span class="token namespace">[root@localhost ~]</span>$ scp <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf root@10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12:<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf
</code></pre> 
<p>打开<code>C:\Windows\System32\drivers\etc</code>，修改hosts文件，生产环境搭建dns服务</p> 
<pre><code class="prism language-powershell"><span class="token comment">#添加如下内容</span>
<span class="token comment">#10.10.10.13 www.test.com</span>
<span class="token comment">#10.10.10.13 www.test.cn</span>
10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12 www<span class="token punctuation">.</span>test<span class="token punctuation">.</span>com
10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12 www<span class="token punctuation">.</span>test<span class="token punctuation">.</span>cn

</code></pre> 
<p>浏览器输入www.test.com会出现apache服务器的内容</p> 
<h4><a id="423_LVSDR10101011_1788"></a>4.2.3 搭建LVS-DR负载调度器(10.10.10.11)</h4> 
<p>开启子接口</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ service NetworkManager stop &amp;&amp; chkconfig NetworkManager off
<span class="token comment"># 关闭网卡守护进程</span>

<span class="token namespace">[root@localhost ~]</span>$ cd <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>network<span class="token operator">-</span>scripts<span class="token operator">/</span>
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">cp</span> <span class="token operator">-</span>a ifcfg<span class="token operator">-</span>eth0 ifcfg<span class="token operator">-</span>eth0:0 
<span class="token comment"># 拷贝 eth0 网卡子接口充当集群入口接口</span>

<span class="token namespace">[root@localhost ~]</span>$ vim ifcfg<span class="token operator">-</span>eth0:0  <span class="token comment">#vim !$ 上一个命令最后一条参数</span>
<span class="token comment">#修改成下面一样</span>
DEVICE=eth0:0
ONBOOT=yes
BOOTPROTO=static
IPADDR=10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100
NETMASK=255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0
<span class="token comment">#当做集群的ip，VIP，提供给web用户访问的接口</span>

<span class="token namespace">[root@localhost ~]</span>$ ifup eth0:0 <span class="token comment">#启动网卡子接口</span>
Determining <span class="token keyword">if</span> ip address 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 is already in use <span class="token keyword">for</span> device eth0<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre> 
<p>修改内核配置文件</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf <span class="token comment"># 关闭网卡重定向功能 </span>
<span class="token comment">#最后一行添加</span>
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>all<span class="token punctuation">.</span>send_redirects = 0 
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>default<span class="token punctuation">.</span>send_redirects = 0 
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>eth0<span class="token punctuation">.</span>send_redirects = 0 

<span class="token namespace">[root@localhost ~]</span>$ sysctl <span class="token operator">-</span>p <span class="token comment">#重新加载配置文件</span>
</code></pre> 
<p>安装ipvsadm命令行管理工具</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ yum  <span class="token operator">-</span>y install ipvsadm 
<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>Ln
IP Virtual Server version 1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1 <span class="token punctuation">(</span>size=4096<span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  <span class="token operator">-</span>&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</code></pre> 
<p>添加ipvs规则</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>v <span class="token comment"># 查看当前 ipvs 集群内容 </span>
 
<span class="token comment">#ipvsadm -A -t 虚拟 IP:80 -s rr </span>
<span class="token comment">#添加 ipvs TCP 集群，-A添加一个集群，-t TCP协议，-s 指定算法，rr轮询</span>
<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>A <span class="token operator">-</span>t 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80 <span class="token operator">-</span>s rr

<span class="token comment">#ipvsadm -a -t 虚拟 IP:80 -r 网站1:80 -g </span>
<span class="token comment">#添加 ipvsadm 集群子节点 ,-a 集群子节点，-r 真实服务器，-g DR模式</span>
<span class="token comment">#ipvsadm -a -t 虚拟 IP:80 -r 网站2:80 -g </span>
<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>a <span class="token operator">-</span>t 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80 <span class="token operator">-</span>r 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12:80 <span class="token operator">-</span>g
<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>a <span class="token operator">-</span>t 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80 <span class="token operator">-</span>r 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13:80 <span class="token operator">-</span>g


<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>Ln  <span class="token comment">#查看集群</span>
IP Virtual Server version 1<span class="token punctuation">.</span>2<span class="token punctuation">.</span>1 <span class="token punctuation">(</span>size=4096<span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  <span class="token operator">-</span>&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100:80 rr
  <span class="token operator">-</span>&gt; 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>12:80               Route   1      0          0         
  <span class="token operator">-</span>&gt; 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>13:80               Route   1      0          0


<span class="token namespace">[root@localhost ~]</span>$ service ipvsadm save <span class="token comment"># 保存 ipvs 集群内容至文件，进行持久化存储 </span>
<span class="token namespace">[root@localhost ~]</span>$ chkconfig ipvsadm on <span class="token comment"># 设置为开机自启</span>

<span class="token namespace">[root@localhost ~]</span>$ ipvsadm <span class="token operator">-</span>Ln <span class="token operator">--</span>stats <span class="token comment">#查看状态</span>
</code></pre> 
<h4><a id="424_LVSDR1010101213__1866"></a>4.2.4 搭建LVS-DR真实服务器(10.10.10.12、13 )</h4> 
<p><strong>两台服务器做相同的步骤</strong></p> 
<p>开启回环网卡接口</p> 
<pre><code class="prism language-powershell"><span class="token comment"># 关闭网卡守护进程</span>
<span class="token namespace">[root@localhost ~]</span>$ cd <span class="token operator">/</span>etc<span class="token operator">/</span>sysconfig<span class="token operator">/</span>network<span class="token operator">-</span>scripts<span class="token operator">/</span>
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">cp</span> <span class="token operator">-</span>a ifcfg<span class="token operator">-</span>lo ifcfg<span class="token operator">-</span>lo:0
<span class="token comment"># 拷贝回环网卡子接口</span>

<span class="token namespace">[root@localhost ~]</span>$ vim ifcfg<span class="token operator">-</span>lo:0  <span class="token comment">#vim !$ 上一个命令最后一条参数</span>
<span class="token comment">#修改成下面一样</span>
DEVICE=lo:0    <span class="token comment">#修改这里</span>
IPADDR=10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 <span class="token comment">#修改这里</span>
NETMASK=255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255  <span class="token comment">#修改这里</span>
NETWORK=127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0
<span class="token comment"># If you're having problems with gated making 127.0.0.0/8 a martian,</span>
<span class="token comment"># you can change this to something else (255.255.255.255, for example)</span>
BROADCAST=127<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255
ONBOOT=yes
NAME=loopback
</code></pre> 
<p>修改内核配置文件</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ vim <span class="token operator">/</span>etc<span class="token operator">/</span>sysctl<span class="token punctuation">.</span>conf <span class="token comment">#关闭对应 ARP 响应及公告功能</span>
<span class="token comment">#最后一行添加</span>
<span class="token comment"># LVS - ARP</span>
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>all<span class="token punctuation">.</span>arp_ignore = 1
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>all<span class="token punctuation">.</span>arp_announce = 2
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>default<span class="token punctuation">.</span>arp_ignore = 1
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>default<span class="token punctuation">.</span>arp_announce = 2
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>lo<span class="token punctuation">.</span>arp_ignore = 1
net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>lo<span class="token punctuation">.</span>arp_announce = 2


<span class="token namespace">[root@localhost ~]</span>$ sysctl <span class="token operator">-</span>p <span class="token comment">#重新加载配置文件</span>

<span class="token namespace">[root@localhost ~]</span>$ ifup lo:0  <span class="token comment">#启动回环网卡</span>

<span class="token namespace">[root@localhost ~]</span>$ ifconfig
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
lo:0      Link encap:Local Loopback  
          inet addr:10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100  Mask:255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
</code></pre> 
<p>添加路由记录，当访问 VIP 交给 lo:0 网卡接受</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span>$ route add <span class="token operator">-</span>host 10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 dev lo:0
<span class="token namespace">[root@localhost ~]</span>$ route <span class="token operator">-</span>n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100    0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0         255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255 UH    0      0        0 lo
10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0      0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0         255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0   U     0      0        0 eth0
169<span class="token punctuation">.</span>254<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0     0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0         255<span class="token punctuation">.</span>255<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0     U     1002   0        0 eth0

<span class="token comment">#添加到开机自启，防止失效</span>
<span class="token namespace">[root@localhost ~]</span>$ <span class="token function">echo</span> <span class="token string">"route add -host 10.10.10.100 dev lo:0"</span> &gt;&gt; <span class="token operator">/</span>etc<span class="token operator">/</span>rc<span class="token punctuation">.</span>local
</code></pre> 
<p>至此多级负载搭建完毕！</p> 
<h4><a id="425__1931"></a>4.2.5 测试</h4> 
<p>打开<code>C:\Windows\System32\drivers\etc</code>，修改hosts文件，生产环境搭建dns服务</p> 
<pre><code class="prism language-powershell"><span class="token comment">#添加如下内容</span>
10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 www<span class="token punctuation">.</span>test<span class="token punctuation">.</span>com
10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100 www<span class="token punctuation">.</span>test<span class="token punctuation">.</span>cn

</code></pre> 
<p>这样既能识别不同的域名，又能进行负载量的增加</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/98ccb864a35d7c24652a7c1e8b3f24e8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">error validating data: [ValidationError(Ingress.spec.rules[0].http.paths[0])</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/72e58c46beae1131fdae67c12bc26d4f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">石头扫地机器人离线了怎么办_关于激光头故障，石头扫地机器人无限次复活记！...</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>