<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ubuntu server 22.04 安装kvm - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Ubuntu server 22.04 安装kvm" />
<meta property="og:description" content="本人有一台工控机， 5500u cpu， 8g 内存，本来是打算用来跑docker的， 但是因为要装
k8s, 虚拟机会更加合适方便，
宿主机的系统是ubuntu server 22.04.1 LTS, 没有安装GUI。 所以vmware virtualbox就不考虑了。 纯命令行估计kvm 会更加合适。 一台机当两三台机用了。
Step 1 检查cpu是否开启虚拟化 国际惯例， 首先检查cpu有没开启虚拟化。
现在市面上估计都买不到不支持虚拟化的cpu了， 问题是我们也要检查下bios上有没enable虚拟化特性。
gateman@homeserver2:~$ kvm-ok INFO: /dev/kvm exists KVM acceleration can be used Step 2 安装kvm sudo apt update sudo apt install qemu qemu-kvm libvirt-bin bridge-utils virt-manager 问题是 这个 libvirt-bin, 提供了virsh等命令工具帮助我们更好地管理kvm 实例。
而且比我以前用kvm时多了个系统服务libvirtd.service， 简单来讲，这个服务会用1个common的账号 libvirt 去启动kvm 实例进程。
所以我们的iso文件， 虚拟硬盘文件都必须放在能让libvirt 账号可以访问的地方。
如果是ubuntu 20.04 则有可能找不到libvirt-bin的包， 要分开安装
libvirt-daemon-system libvirt-clients 安装上面的东西后， 检查libvirtd服务有没有启动." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/79a828da0cd307d8f0d40eb2e01a1c5f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-24T21:56:19+08:00" />
<meta property="article:modified_time" content="2022-11-24T21:56:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ubuntu server 22.04 安装kvm</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>本人有一台工控机， 5500u cpu， 8g 内存，本来是打算用来跑docker的， 但是因为要装<br> k8s, 虚拟机会更加合适方便，</p> 
<p>宿主机的系统是ubuntu server 22.04.1 LTS, 没有安装GUI。 所以vmware virtualbox就不考虑了。 纯命令行估计kvm 会更加合适。 一台机当两三台机用了。</p> 
<p><br><br></p> 
<h3><a id="Step_1__cpu_7"></a>Step 1 检查cpu是否开启虚拟化</h3> 
<p>国际惯例， 首先检查cpu有没开启虚拟化。<br> 现在市面上估计都买不到不支持虚拟化的cpu了， 问题是我们也要检查下bios上有没enable虚拟化特性。</p> 
<pre><code class="prism language-shell">gateman@homeserver2:~$ kvm-ok
INFO: /dev/kvm exists
KVM acceleration can be used
</code></pre> 
<p><br><br></p> 
<h3><a id="Step_2_kvm_17"></a>Step 2 安装kvm</h3> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> qemu qemu-kvm libvirt-bin  bridge-utils  virt-manager
</code></pre> 
<p>问题是 这个 libvirt-bin, 提供了virsh等命令工具帮助我们更好地管理kvm 实例。</p> 
<p>而且比我以前用kvm时多了个系统服务libvirtd.service， 简单来讲，这个服务会用1个common的账号 libvirt 去启动kvm 实例进程。</p> 
<p>所以我们的iso文件， 虚拟硬盘文件都必须放在能让libvirt 账号可以访问的地方。</p> 
<p>如果是ubuntu 20.04 则有可能找不到libvirt-bin的包， 要分开安装</p> 
<pre><code class="prism language-shell">libvirt-daemon-system libvirt-clients
</code></pre> 
<p>安装上面的东西后， 检查libvirtd服务有没有启动.</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> systemctl status libvirtd.service

<span class="token comment">## if not started</span>
<span class="token function">sudo</span> systemctl start libvirtd.service
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> libvirtd.service
</code></pre> 
<p><br><br></p> 
<h3><a id="Step_3__45"></a>Step 3 设置桥接网卡</h3> 
<p>kvm 支持多种网络模式</p> 
<p>桥接模式 (bridge)<br> NAT模式<br> 路由模式<br> 直接分配设备模式<br> …</p> 
<p>第4种太奢侈， 而其他3种只有桥接模式能令虚拟机和局域网其他主机相互通信(ip 在同1个网段）</p> 
<p>所以我们会选择桥接模式。</p> 
<p>当我们用vmware virtualbox时， 桥接网卡都会自动配置好， 而kvm需要我们事先手动配置。</p> 
<p>每个linux发型版的网络管理方式都不同， 而ubuntu 22.04.1 用的是自家的netplan 来管理的。 当然，如果我们启动用GUI， 则很可能会用NetworkManager.</p> 
<p>既然我的机器是没有GUI的， 那就是netplan了<br> 检查 /etc/netplan 文件夹， 是否存在yaml文件， 如果不存在， 而你台机器还能上网的话， 则肯定不是用netplan 方式。</p> 
<p><br><br></p> 
<h5><a id="31_netplan_67"></a>3.1 检查netplan配置</h5> 
<pre><code class="prism language-shell">gateman@homeserver2:/etc/netplan$ <span class="token builtin class-name">pwd</span>
/etc/netplan
gateman@homeserver2:/etc/netplan$ <span class="token function">ls</span> *yaml
00-installer-config.yaml
</code></pre> 
<pre><code class="prism language-yaml"><span class="token comment"># This is the network config written by 'subiquity'</span>
<span class="token key atrule">network</span><span class="token punctuation">:</span>
  <span class="token key atrule">ethernets</span><span class="token punctuation">:</span>
    <span class="token key atrule">enp1s0</span><span class="token punctuation">:</span>
      <span class="token key atrule">dhcp4</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">enp2s0</span><span class="token punctuation">:</span>
      <span class="token key atrule">dhcp4</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre> 
<p>先备份和查看原来的配置文件， 可以看到， 我台机器只有两个有线端口， 其中只有1个插了网线启用的dhcp， 这里的4指的是 ip4</p> 
<h5><a id="32__89"></a>3.2 检查虚拟桥接设备</h5> 
<p>输入ifconfig 回车<br> 会见到输出除了上面两个有线网卡外， 多了1个设备virbr0，这是安装完kvm后系统自动创建的</p> 
<pre><code class="prism language-shell">	    virbr0: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">409</span><span class="token operator"><span class="token file-descriptor important">9</span>&lt;</span>UP,BROADCAST,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1500</span>
        inet <span class="token number">192.168</span>.122.1  netmask <span class="token number">255.255</span>.255.0  broadcast <span class="token number">192.168</span>.122.255
        ether <span class="token number">52</span>:54:00:89:a9:72  txqueuelen <span class="token number">1000</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets <span class="token number">0</span>  bytes <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>
        RX errors <span class="token number">0</span>  dropped <span class="token number">0</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
        TX packets <span class="token number">0</span>  bytes <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0.0</span> B<span class="token punctuation">)</span>
        TX errors <span class="token number">0</span>  dropped <span class="token number">0</span> overruns <span class="token number">0</span>  carrier <span class="token number">0</span>  collisions <span class="token number">0</span>
</code></pre> 
<p>其实这个virbr0 并不是一块虚拟网卡， 而是1个块虚拟桥接设备(bridge)， 我们还必须基于它再创建1个虚拟桥接网卡。</p> 
<h5><a id="33_etcnetplan00xxxyaml__105"></a>3.3 编辑/etc/netplan/00-xxx.yaml 添加一个桥接网卡</h5> 
<p>before that,<br> 我手绘了1个kvm 桥接的大概原理图， 不会是百分百准确， 将就看就行</p> 
<p>我们需要做的是创建1个关键的虚拟桥接网卡 br0 ， 如下图， 它桥接 宿主机的真正物理卡， 而且， 我们之后创建的虚拟机都会通过这个br0 桥接网卡与外部沟通。</p> 
<p>也就是讲即使我们后面会创建多台虚拟机， 对于宿主机来讲， 1个虚拟桥接网卡就足够了。<br> <img src="https://images2.imgbox.com/ec/fc/IlvpxP6k_o.png" alt="在这里插入图片描述"></p> 
<p>编辑 /etc/netplan/00-xxxx.yaml</p> 
<pre><code class="prism language-yaml"><span class="token comment"># This is the network config written by 'subiquity'</span>
<span class="token key atrule">network</span><span class="token punctuation">:</span>
  <span class="token key atrule">ethernets</span><span class="token punctuation">:</span>
    <span class="token key atrule">enp1s0</span><span class="token punctuation">:</span>
      <span class="token key atrule">dhcp4</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">enp2s0</span><span class="token punctuation">:</span>
      <span class="token key atrule">dhcp4</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 真正的物理显卡要关闭dhcp</span>
  <span class="token key atrule">bridges</span><span class="token punctuation">:</span>
    <span class="token key atrule">br0</span><span class="token punctuation">:</span>
      <span class="token key atrule">interfaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>enp2s0<span class="token punctuation">]</span>
      <span class="token key atrule">dhcp4</span><span class="token punctuation">:</span> no
      <span class="token key atrule">addresses</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.0.1.107/24<span class="token punctuation">]</span> <span class="token comment"># ip地址</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>            
        <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> default
          <span class="token key atrule">via</span><span class="token punctuation">:</span> 10.0.1.1           <span class="token comment"># 路由其地址</span>
      <span class="token key atrule">nameservers</span><span class="token punctuation">:</span>
        <span class="token key atrule">addresses</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>119.29.29.29<span class="token punctuation">,</span> 8.8.8.8<span class="token punctuation">]</span>   <span class="token comment"># DNS 119.29.29.29 是疼讯的DNS</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre> 
<p>保存后<br> 执行</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> netplan apply
</code></pre> 
<p>注意这里我们不在从路由器动态申请ip， 而是设置静态ip， 如国修改前后的ip不同，我们的ssh connection会断开， 需要重新连接。</p> 
<p>修改后我们再查看ifconfig<br> 我们会发现</p> 
<ol><li>多了个网卡br0， 地址就是我们设置的静态ip地址</li><li>物理网卡没有地址， 这是正常的， 如上图， 连物理网卡也会通过这个虚拟网桥连接外部。。</li></ol> 
<pre><code class="prism language-shell">br0: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1500</span>
        inet <span class="token number">10.0</span>.1.107  netmask <span class="token number">255.255</span>.255.0  broadcast <span class="token number">10.0</span>.1.255
        inet6 fe80::b4a2:82ff:fe35:d8d8  prefixlen <span class="token number">64</span>  scopeid 0x2<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>link<span class="token operator">&gt;</span>
        ether b6:a2:82:35:d8:d8  txqueuelen <span class="token number">1000</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets <span class="token number">61997</span>  bytes <span class="token number">8192346</span> <span class="token punctuation">(</span><span class="token number">8.1</span> MB<span class="token punctuation">)</span>
        RX errors <span class="token number">0</span>  dropped <span class="token number">0</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
        TX packets <span class="token number">82925</span>  bytes <span class="token number">21320864</span> <span class="token punctuation">(</span><span class="token number">21.3</span> MB<span class="token punctuation">)</span>
        TX errors <span class="token number">0</span>  dropped <span class="token number">0</span> overruns <span class="token number">0</span>  carrier <span class="token number">0</span>  collisions <span class="token number">0</span>

enp2s0: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1500</span>
        ether 00:e0:0a:f2:12:26  txqueuelen <span class="token number">1000</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets <span class="token number">338034</span>  bytes <span class="token number">418401126</span> <span class="token punctuation">(</span><span class="token number">418.4</span> MB<span class="token punctuation">)</span>
        RX errors <span class="token number">0</span>  dropped <span class="token number">0</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
        TX packets <span class="token number">115940</span>  bytes <span class="token number">24050924</span> <span class="token punctuation">(</span><span class="token number">24.0</span> MB<span class="token punctuation">)</span>
        TX errors <span class="token number">0</span>  dropped <span class="token number">0</span> overruns <span class="token number">0</span>  carrier <span class="token number">0</span>  collisions <span class="token number">0</span>

</code></pre> 
<p><br><br></p> 
<h3><a id="Step_4__169"></a>Step 4 新建虚拟硬盘</h3> 
<p>上面说了，虚拟硬盘为了要让libvirt 访问， 最好创建再公共的地方.<br> 我在根目录创建了1个folder /kvmdisks …</p> 
<p>命令：</p> 
<pre><code>qemu-img create ./kvm0.img 20G
</code></pre> 
<p><br><br></p> 
<h3><a id="Step_5_iso_179"></a>Step 5 准备系统安装文件iso</h3> 
<p>我为了省事， 直接套娃安装ubuntu server 22.04 本身<br> 同样地， iso 最好放在公共地方</p> 
<pre><code class="prism language-shell">gateman@homeserver2:/isos$ <span class="token function">ls</span>
ubuntu-22.04.1-live-server-amd64.iso
</code></pre> 
<p><br><br></p> 
<h3><a id="Step_6__188"></a>Step 6 编写虚拟机配置文件</h3> 
<p>对于新增加一台虚拟机， 无非修改下面几个地方<br> 1， cpu 数量和内存大小<br> 2. uuid 用uuid-rumtime 包下的 uuidgen命令生成<br> 3. 修改新的随机mac地址， 自己google怎么生成 echo $RANDOM | md5sum | sed ‘s/…/&amp;:/g’ | cut -c1-17<br> 4. 修改虚拟机名称。<br> 5. 修改虚拟硬盘路径<br> 6. 反注释光驱启动那行<br> 7. 没了</p> 
<pre><code class="prism language-xml">gateman@homeserver2:~/kvmxmls/vm1$ cat vm1.xml 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>domain</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>kvm<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>  //如果是Xen，则type=‘xen’
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>vm1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span> //虚拟机名称，同一物理机唯一
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uuid</span><span class="token punctuation">&gt;</span></span>4b942306-76b0-4174-9371-a0485fdc8093<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>uuid</span><span class="token punctuation">&gt;</span></span>  //同一物理机唯一，可用uuidgen生成
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>memory</span><span class="token punctuation">&gt;</span></span>4096000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>memory</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>currentMemory</span><span class="token punctuation">&gt;</span></span>2048000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>currentMemory</span><span class="token punctuation">&gt;</span></span>  //memory这两个值最好设成一样
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>vcpu</span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>vcpu</span><span class="token punctuation">&gt;</span></span>            //虚拟机可使用的cpu个数，查看物理机可用CPU个数：cat /proc/cpuinfo |grep processor | wc -l
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>os</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span> <span class="token attr-name">arch</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>x86_64<span class="token punctuation">'</span></span> <span class="token attr-name">machine</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>ubuntu<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>hvm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span> //arch指出系统架构类型，machine 则是机器类型，查看机器类型：qemu-system-x86_64 -M ?
   <span class="token comment">&lt;!-- 第一次运行要 反注释这行
   &lt;boot dev='cdrom'/&gt;  //启动介质，第一次需要装系统可以选择cdrom光盘启动
   --&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bootmenu</span> <span class="token attr-name">enable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>yes<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>  //表示启动按F12进入启动菜单
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>os</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>features</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>acpi</span><span class="token punctuation">/&gt;</span></span>  //Advanced Configuration and Power Interface,高级配置与电源接口
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>apic</span><span class="token punctuation">/&gt;</span></span>  //Advanced Programmable Interrupt Controller,高级可编程中断控制器
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pae</span><span class="token punctuation">/&gt;</span></span>   //Physical Address Extension,物理地址扩展
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>features</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clock</span> <span class="token attr-name">offset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>localtime<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>  //虚拟机时钟设置，这里表示本地本机时间
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>on_poweroff</span><span class="token punctuation">&gt;</span></span>destroy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>on_poweroff</span><span class="token punctuation">&gt;</span></span>  //突发事件动作
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>on_reboot</span><span class="token punctuation">&gt;</span></span>restart<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>on_reboot</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>on_crash</span><span class="token punctuation">&gt;</span></span>restart<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>on_crash</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>devices</span><span class="token punctuation">&gt;</span></span>   //设备配置/
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>emulator</span><span class="token punctuation">&gt;</span></span>/usr/bin/kvm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>emulator</span><span class="token punctuation">&gt;</span></span> //如果是Xen则是/usr/lib/xen/binqemu-dm
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disk</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>file<span class="token punctuation">'</span></span> <span class="token attr-name">device</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>disk<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span> //硬盘
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>driver</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>qemu<span class="token punctuation">'</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>raw<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/kvmdisks/kvm1.img<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span> <span class="token attr-name">dev</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>vda<span class="token punctuation">'</span></span> <span class="token attr-name">bus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>virtio<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>  // if windows must ide   else virtio
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disk</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disk</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>file<span class="token punctuation">'</span></span> <span class="token attr-name">device</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>cdrom<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>//光盘
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>driver</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>qemu<span class="token punctuation">'</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>raw<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/isos/ubuntu-22.04.1-live-server-amd64.iso<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span> <span class="token attr-name">dev</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>hdc<span class="token punctuation">'</span></span> <span class="token attr-name">bus</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>ide<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>readonly</span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disk</span><span class="token punctuation">&gt;</span></span>
   /* 利用Linux网桥连接网络 */
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>interface</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>bridge<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mac</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>40:00:02:04:19:ef<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">bridge</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>br0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>  //配置的网桥网卡名称
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span> <span class="token attr-name">dev</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>vnet0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>     //同一网桥下相同
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>alias</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>net0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>      //别名，同一网桥下相同
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>interface</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>graphics</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>vnc<span class="token punctuation">'</span></span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>5901<span class="token punctuation">'</span></span> <span class="token attr-name">autoport</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>yes<span class="token punctuation">'</span></span> <span class="token attr-name">listen</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0.0.0.0<span class="token punctuation">'</span></span> <span class="token attr-name">keymap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>en-us<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>  //配置vnc，windows下可以使用vncviewer登录，获取vnc端口号：virsh vncdisplay vm0
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listen</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>address<span class="token punctuation">'</span></span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>0.0.0.0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>graphics</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>devices</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>domain</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<p><br><br></p> 
<h3><a id="Step_7__254"></a>Step 7 启动虚拟机</h3> 
<p>保存后. 有两种方式启动</p> 
<ol><li>virsh create vm0.xml</li><li>virsh define vm0.xml<br> virsh start vm0 # 主机名</li></ol> 
<p>第一种一旦关闭虚拟机就会消失， 建议用于测试<br> 第二种除非 执行virsh undefine 主机名， 否则一直存在与虚拟机列表。</p> 
<p>如果遇到错误：XML error: expected unicast mac address, found multicast ‘23:F6:7F:2B:67:5D’<br> 那是因为所造的mac地址是组播地址，要非组播的mac地址才行，开头大于24即可</p> 
<p><br><br></p> 
<h3><a id="Step_8___269"></a>Step 8， 连接启动后的虚拟机， 安装系统</h3> 
<p>两种方式，</p> 
<ol><li>用vnc viewer(linux /win 通用)</li><li>在另一台linux机上安装virt-manager</li></ol> 
<p>不得不说virt-manager 真是个神奇， 可以在一台有GUI的linux 主机去管理另1台没有GUI的KVM 宿主机的kvm 子系统。<br> <img src="https://images2.imgbox.com/24/7f/ADWDjVaG_o.png" alt="在这里插入图片描述"><br> 缺点：<br> 3. 需要GUI<br> 4. 没有windows 版， 硬气！<br> 接着就可以安装系统了<br> <img src="https://images2.imgbox.com/44/11/MuSABKJ3_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<h3><a id="Step_9_cdrom__283"></a>Step 9， 移除cdrom启动方式， 重启</h3> 
<p>如果用virsh create vm0.xml 方式启动安装的， 安装后可以修改vm0.xml(或者另建一份copy), 把cdrom 启动注销掉</p> 
<p>然后 再重新 virsh define …</p> 
<p><br><br></p> 
<h3><a id="Step_10kvm__290"></a>Step 10，检查kvm虚拟机 网卡地址</h3> 
<p>如果一切顺利， 虚拟机dhcp生成的网卡会与物理机同一个网段</p> 
<pre><code class="prism language-shell">gateman@vm:~$ <span class="token function">ifconfig</span>
ens3: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1500</span>
        inet <span class="token number">10.0</span>.1.151  netmask <span class="token number">255.255</span>.255.0  broadcast <span class="token number">10.0</span>.1.255
        inet6 fe80::f892:1ff:fe33:d4fa  prefixlen <span class="token number">64</span>  scopeid 0x2<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>link<span class="token operator">&gt;</span>
        ether fa:92:01:33:d4:fa  txqueuelen <span class="token number">1000</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets <span class="token number">2540</span>  bytes <span class="token number">145750</span> <span class="token punctuation">(</span><span class="token number">145.7</span> KB<span class="token punctuation">)</span>
        RX errors <span class="token number">0</span>  dropped <span class="token number">477</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
        TX packets <span class="token number">423</span>  bytes <span class="token number">30596</span> <span class="token punctuation">(</span><span class="token number">30.5</span> KB<span class="token punctuation">)</span>
        TX errors <span class="token number">0</span>  dropped <span class="token number">0</span> overruns <span class="token number">0</span>  carrier <span class="token number">0</span>  collisions <span class="token number">324</span>

lo: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">7</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class="token operator">&gt;</span>  mtu <span class="token number">65536</span>
        inet <span class="token number">127.0</span>.0.1  netmask <span class="token number">255.0</span>.0.0
        inet6 ::1  prefixlen <span class="token number">128</span>  scopeid 0x1<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>host<span class="token operator">&gt;</span>
        loop  txqueuelen <span class="token number">1000</span>  <span class="token punctuation">(</span>Local Loopback<span class="token punctuation">)</span>
        RX packets <span class="token number">164</span>  bytes <span class="token number">14048</span> <span class="token punctuation">(</span><span class="token number">14.0</span> KB<span class="token punctuation">)</span>
        RX errors <span class="token number">0</span>  dropped <span class="token number">0</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
        TX packets <span class="token number">164</span>  bytes <span class="token number">14048</span> <span class="token punctuation">(</span><span class="token number">14.0</span> KB<span class="token punctuation">)</span>
        TX errors <span class="token number">0</span>  dropped <span class="token number">0</span> overruns <span class="token number">0</span>  carrier <span class="token number">0</span>  collisions <span class="token number">0</span>

</code></pre> 
<p>其实这时就可以通过局域网物理机ssh过去了</p> 
<p>为了方便管理， 还是建议修改虚拟机网卡设置， 设置成静态ip</p> 
<pre><code class="prism language-shell">gateman@vm:~$ <span class="token function">cat</span> /etc/netplan/00-installer-config.yaml
<span class="token comment"># This is the network config written by 'subiquity'</span>
network:
  ethernets:
    ens3:
      dhcp4: no
      addresses: <span class="token punctuation">[</span><span class="token number">10.0</span>.1.151/24<span class="token punctuation">]</span>
      gateway4: <span class="token number">10.0</span>.1.1
      nameservers:
        addresses: <span class="token punctuation">[</span><span class="token number">119.29</span>.29.29, <span class="token number">8.8</span>.8.8<span class="token punctuation">]</span>

</code></pre> 
<p><br><br></p> 
<h3><a id="_332"></a>虚拟机网卡地址不与物理机同一网段的原因</h3> 
<p>如果发现虚拟机ip地址是192.168.122.xxx</p> 
<p>则这时 其他局域网的主机是访问不了这些虚拟机的。</p> 
<p>原因是vm0.xml 的网络设置错误</p> 
<pre><code class="prism language-xml"> /* 利用Linux网桥连接网络 */
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>interface</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>bridge<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mac</span> <span class="token attr-name">address</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>40:00:02:04:19:ef<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">bridge</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>br0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>  //配置的网桥网卡名称
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span> <span class="token attr-name">dev</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>vnet0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>     //同一网桥下相同
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>alias</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>net0<span class="token punctuation">'</span></span><span class="token punctuation">/&gt;</span></span>      //别名，同一网桥下相同
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>interface</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>把上面的 source briidge = ‘virbr0’ 改回来 br0 就ok！<br> 我把自己踩过的坑都写出来了。</p> 
<h3><a id="virtmanager_353"></a>virt-manager</h3> 
<p>最后再推荐一下这个神器， 它可以很方便的完成本文的step4 to step9<br> 跟virtbox的gui 界面用起来差距不大了！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ff0e48035e7541e5cb61ea608d69f30b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">WSL 可视化桌面</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/41ec5e1cb6de6c94279063a588b2af5c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">nginx(四十六)log阶段log模块学习</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>