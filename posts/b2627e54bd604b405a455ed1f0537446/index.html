<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>大模型镜像打包实战:CodeGeeX2为例 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="大模型镜像打包实战:CodeGeeX2为例" />
<meta property="og:description" content="资源地址 docker torch镜像地址
CodeGeeX2 github
构建思路 查看CodeGeeX2项目，官方已经提供好启动脚本，配置好各种依赖应该就可以运行。
python ./demo/run_demo.py usage: run_demo.py [-h] [--model-path MODEL_PATH] [--example-path EXAMPLE_PATH] [--quantize QUANTIZE] [--chatglm-cpp] [--fastllm] [--n-gpus N_GPUS] [--gpu GPU] [--cpu] [--auth] [--username yourname] [--password yourpassword] [--port PORT] [--listen ADDRESS] # 若要启用身份验证，请先启用--auth，然后定义--username与--password，如： python run_demo.py --auth --username user --password password # 若要监听所有地址请指定 --listen 0.0.0.0 镜像Dockerfile 写一个启动脚本bin/start.sh，判断是否启用身份验证，也可以在Dockerfile最后的CMD直接执行python脚本，sh bin/start.sh这样写更标准。
#!/usr/bin/env bash if [[ $USERNAME != &#34;&#34; ]] &amp;&amp; [[ $PASSWORD != &#34;&#34; ]] then python /workspace/CodeGeeX2/demo/run_demo.py \ --listen $LISTEN --port $PORT \ --model-path $MODEL_PATH \ --gpu $GPU \ --n-gpus $N_GPUS \ $CHATGLM \ --auth \ --username $USERNAME \ --password $PASSWORD else python /workspace/CodeGeeX2/demo/run_demo." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/b2627e54bd604b405a455ed1f0537446/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-21T17:08:33+08:00" />
<meta property="article:modified_time" content="2024-01-21T17:08:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">大模型镜像打包实战:CodeGeeX2为例</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>资源地址</h3> 
<p><a href="https://hub.docker.com/r/pytorch/pytorch/tags" rel="nofollow">docker torch镜像地址</a><br> <a href="https://github.com/THUDM/CodeGeeX2.git">CodeGeeX2 github</a></p> 
<h3><a id="_3"></a>构建思路</h3> 
<p>查看CodeGeeX2项目，官方已经提供好启动脚本，配置好各种依赖应该就可以运行。</p> 
<pre><code class="prism language-sh">python ./demo/run_demo.py

usage: run_demo.py <span class="token punctuation">[</span>-h<span class="token punctuation">]</span> <span class="token punctuation">[</span>--model-path MODEL_PATH<span class="token punctuation">]</span> <span class="token punctuation">[</span>--example-path EXAMPLE_PATH<span class="token punctuation">]</span> <span class="token punctuation">[</span>--quantize QUANTIZE<span class="token punctuation">]</span>
                   <span class="token punctuation">[</span>--chatglm-cpp<span class="token punctuation">]</span> <span class="token punctuation">[</span>--fastllm<span class="token punctuation">]</span> <span class="token punctuation">[</span>--n-gpus N_GPUS<span class="token punctuation">]</span> <span class="token punctuation">[</span>--gpu GPU<span class="token punctuation">]</span> <span class="token punctuation">[</span>--cpu<span class="token punctuation">]</span> <span class="token punctuation">[</span>--auth<span class="token punctuation">]</span> <span class="token punctuation">[</span>--username yourname<span class="token punctuation">]</span>
                   <span class="token punctuation">[</span>--password yourpassword<span class="token punctuation">]</span>
                   <span class="token punctuation">[</span>--port PORT<span class="token punctuation">]</span> <span class="token punctuation">[</span>--listen ADDRESS<span class="token punctuation">]</span>

<span class="token comment"># 若要启用身份验证，请先启用--auth，然后定义--username与--password，如：</span>
python run_demo.py <span class="token parameter variable">--auth</span> <span class="token parameter variable">--username</span> user <span class="token parameter variable">--password</span> password  <span class="token comment"># 若要监听所有地址请指定 --listen 0.0.0.0</span>
</code></pre> 
<h3><a id="Dockerfile_17"></a>镜像Dockerfile</h3> 
<p>写一个启动脚本bin/start.sh，判断是否启用身份验证，也可以在Dockerfile最后的CMD直接执行python脚本，<code>sh bin/start.sh</code>这样写更标准。</p> 
<pre><code class="prism language-sh"><span class="token shebang important">#!/usr/bin/env bash</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$USERNAME</span> <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$PASSWORD</span> <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token keyword">then</span>
    python /workspace/CodeGeeX2/demo/run_demo.py <span class="token punctuation">\</span>
        <span class="token parameter variable">--listen</span> <span class="token variable">$LISTEN</span> <span class="token parameter variable">--port</span> <span class="token variable">$PORT</span> <span class="token punctuation">\</span>
        --model-path <span class="token variable">$MODEL_PATH</span>  <span class="token punctuation">\</span>
        <span class="token parameter variable">--gpu</span> <span class="token variable">$GPU</span> <span class="token punctuation">\</span>
        --n-gpus <span class="token variable">$N_GPUS</span> <span class="token punctuation">\</span>
        <span class="token variable">$CHATGLM</span> <span class="token punctuation">\</span>
        <span class="token parameter variable">--auth</span> <span class="token punctuation">\</span>
        <span class="token parameter variable">--username</span> <span class="token variable">$USERNAME</span> <span class="token punctuation">\</span>
        <span class="token parameter variable">--password</span> <span class="token variable">$PASSWORD</span>
<span class="token keyword">else</span>
    python /workspace/CodeGeeX2/demo/run_demo.py <span class="token punctuation">\</span>
        <span class="token parameter variable">--listen</span> <span class="token variable">$LISTEN</span> <span class="token parameter variable">--port</span> <span class="token variable">$PORT</span> <span class="token punctuation">\</span>
        --model-path <span class="token variable">$MODEL_PATH</span>  <span class="token punctuation">\</span>
        <span class="token parameter variable">--gpu</span> <span class="token variable">$GPU</span> <span class="token punctuation">\</span>
        --n-gpus <span class="token variable">$N_GPUS</span> <span class="token punctuation">\</span>
        <span class="token variable">$CHATGLM</span>
<span class="token keyword">fi</span>
</code></pre> 
<pre><code class="prism language-Dockerfile">FROM pytorch/pytorch:2.1.2-cuda11.8-cudnn8-runtime

RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple \
    &amp;&amp; pip install fire zmq sentencepiece gradio accelerate transformers==4.33.2 modelscope chatglm-cpp cpm_kernels tabulate \
    &amp;&amp; mkdir /workspace \
    &amp;&amp; cd /workspace

# 网好的同学直接拉远程的项目
# RUN git clone https://github.com/THUDM/CodeGeeX2.git

# 网不好可以先拉倒本地，然后用下面目录copy到指定路径
COPY CodeGeeX2 /workspace/CodeGeeX2/
# 原项目使用huggingface模型，此处使用的是国内modelscope仓库，代码中transformers的导包都需要改为modelscope，也可以上huggingface上拉倒本地，改成本地路径
COPY modelscope /root/.cache/modelscope/

ENV LISTEN=0.0.0.0
ENV PORT=7860
ENV MODEL_PATH=ZhipuAI/codegeex2-6b
ENV GPU=0
ENV N_GPUS=1
ENV CHATGLM=--chatglm-cpp
CMD sh /workspace/CodeGeeX2/bin/start.sh
</code></pre> 
<p>执行命令构建镜像：<code>docker build -t codegeex:v1 .</code><br> 命令执行通过后查看此镜像ID，执行下面命令：<br> <code>docker run -d --runtime=nvidia -p 7860:7860 --name pytorch2.0 -v /tmp:/tmp 镜像ID</code><br> 访问localhost:7860查看是否成功</p> 
<h3><a id="bug_70"></a>bug解决方案</h3> 
<p>如果有我未遇到的bug欢迎提问，一起解决问题总结在此处</p> 
<ul><li><code>NameError: name 'round_up' is not defined</code><br> 当指定 <code>--quantize 4</code> 时出现，<code>File "/root/.cache/huggingface/modules/transformers_modules/codegeex2-6b/quantization.py", line 78, in compress_int4_weight</code>可以看到这个python是在拉模型权重中的一个文件，名字就知道是做量化的代码，<code>from cpm_kernels.kernels.base import LazyKernelCModule, KernelFunction, round_up</code>,进入文件后找到导入的语句，显然应该是缺少cpm_kernels包或者包版本不一致没有<code>round_up</code>函数，<code>pip install cpm_kernels</code>适合的版本即可。或者直接使用官方已经提供好的量化模型，就可以不做<code>--quantize 4</code>指定。</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/176f9616e0b128c5f2bb342923b4e8b0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于ssm&#43;jsp的java植物园管理系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3c12fb61ffa3cfb7e85a7897ca39bacf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CUDA基础教程文档记录</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>