<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>弧形ProgressBar、SeekBar - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="弧形ProgressBar、SeekBar" />
<meta property="og:description" content="github上有很多弧形或者圆形的ProgressBar和SeekBar。前几天无意中发现一个弧形的ProgressBar觉得挺不错的，就下载来看看源码。ColorArcProgressBar 地址是这个：https://github.com/Shinelw/ColorArcProgressBar 运行他的Demo的时候发现几个问题，并且有些问题在issue里面也有人提出了，但是作者一直没有回复，我把问题修复之后加上了Seek的功能，让它能当做SeekBar用。
原作者的Demo效果图 存在的问题： 不能通过XML配置控件的大小，源码里面写死了，写成占屏幕的百分比。有几个属性的颜色值设置无效。比如默认的弧形背景色放大缩小控件之后对应的字体没有相应的调整大小 需要考虑的问题点： 我们从最下面带刻度带提示的效果图入手
####我们呢先分析原作者的代码：
package com.shinelw.colorarcprogressbar; import android.animation.ValueAnimator; import android.content.Context; import android.graphics.Canvas; import android.graphics.Color; import android.graphics.Matrix; import android.graphics.Paint; import android.graphics.PaintFlagsDrawFilter; import android.graphics.RectF; import android.graphics.SweepGradient; import android.util.AttributeSet; import android.util.DisplayMetrics; import android.view.View; import android.view.WindowManager; /** * colorful arc progress bar * Created by shinelw on 12/4/15. */ public class ColorArcProgressBar extends View{ private int mWidth; private int mHeight; //直径 private int diameter = 500; private RectF bgRect; //圆心 private float centerX; private float centerY; private Paint allArcPaint; private Paint progressPaint; private Paint vTextPaint; private Paint hintPaint; private Paint degreePaint; private Paint curSpeedPaint; private float startAngle = 135; private float sweepAngle = 270; private float currentAngle = 0; private float lastAngle; private int[] colors = {Color." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/eddb5bcddf74f38e876f9aeff900813c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-11-05T14:49:12+08:00" />
<meta property="article:modified_time" content="2016-11-05T14:49:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">弧形ProgressBar、SeekBar</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>github上有很多弧形或者圆形的ProgressBar和SeekBar。前几天无意中发现一个弧形的ProgressBar觉得挺不错的，就下载来看看源码。<a href="https://github.com/Shinelw/ColorArcProgressBar">ColorArcProgressBar </a> <br> 地址是这个：<a href="https://github.com/Shinelw/ColorArcProgressBar">https://github.com/Shinelw/ColorArcProgressBar </a></p> 
<p>运行他的Demo的时候发现几个问题，并且有些问题在issue里面也有人提出了，但是作者一直没有回复，我把问题修复之后加上了Seek的功能，让它能当做SeekBar用。</p> 
<h5 id="原作者的demo效果图">原作者的Demo效果图</h5> 
<p><img src="https://images2.imgbox.com/46/e3/DY49MBD7_o.gif" alt="这里写图片描述" title=""></p> 
<hr> 
<h5 id="存在的问题">存在的问题：</h5> 
<ol><li>不能通过XML配置控件的大小，源码里面写死了，写成占屏幕的百分比。</li><li>有几个属性的颜色值设置无效。比如默认的弧形背景色</li><li>放大缩小控件之后对应的字体没有相应的调整大小</li></ol> 
<h5 id="需要考虑的问题点">需要考虑的问题点：</h5> 
<p>我们从最下面带刻度带提示的效果图入手</p> 
<p>####我们呢先分析原作者的代码：</p> 
<pre class="prettyprint"><code class=" hljs java"><span class="hljs-keyword">package</span> com.shinelw.colorarcprogressbar;

<span class="hljs-keyword">import</span> android.animation.ValueAnimator;
<span class="hljs-keyword">import</span> android.content.Context;
<span class="hljs-keyword">import</span> android.graphics.Canvas;
<span class="hljs-keyword">import</span> android.graphics.Color;
<span class="hljs-keyword">import</span> android.graphics.Matrix;
<span class="hljs-keyword">import</span> android.graphics.Paint;
<span class="hljs-keyword">import</span> android.graphics.PaintFlagsDrawFilter;
<span class="hljs-keyword">import</span> android.graphics.RectF;
<span class="hljs-keyword">import</span> android.graphics.SweepGradient;
<span class="hljs-keyword">import</span> android.util.AttributeSet;
<span class="hljs-keyword">import</span> android.util.DisplayMetrics;
<span class="hljs-keyword">import</span> android.view.View;
<span class="hljs-keyword">import</span> android.view.WindowManager;

<span class="hljs-javadoc">/**
 * colorful arc progress bar
 * Created by shinelw on 12/4/15.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ColorArcProgressBar</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">View</span>{<!-- --></span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> mWidth;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> mHeight;
    <span class="hljs-comment">//直径</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> diameter = <span class="hljs-number">500</span>;
    <span class="hljs-keyword">private</span> RectF bgRect;
    <span class="hljs-comment">//圆心</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> centerX;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> centerY;
    <span class="hljs-keyword">private</span> Paint allArcPaint;
    <span class="hljs-keyword">private</span> Paint progressPaint;
    <span class="hljs-keyword">private</span> Paint vTextPaint;
    <span class="hljs-keyword">private</span> Paint hintPaint;
    <span class="hljs-keyword">private</span> Paint degreePaint;
    <span class="hljs-keyword">private</span> Paint curSpeedPaint;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> startAngle = <span class="hljs-number">135</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> sweepAngle = <span class="hljs-number">270</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> currentAngle = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> lastAngle;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span>[] colors = {Color.GREEN, Color.YELLOW, Color.RED, Color.RED};
    <span class="hljs-keyword">private</span> ValueAnimator progressAnimator;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> maxValues = <span class="hljs-number">60</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> curValues = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> bgArcWidth = dipToPx(<span class="hljs-number">2</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> progressWidth = dipToPx(<span class="hljs-number">10</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> textSize = dipToPx(<span class="hljs-number">80</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> hintSize = dipToPx(<span class="hljs-number">22</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> curSpeedSize = dipToPx(<span class="hljs-number">13</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> aniSpeed = <span class="hljs-number">1000</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> longdegree = dipToPx(<span class="hljs-number">13</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> shortdegree = dipToPx(<span class="hljs-number">5</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> DEGREE_PROGRESS_DISTANCE = dipToPx(<span class="hljs-number">8</span>);
    <span class="hljs-keyword">private</span> String hintColor = <span class="hljs-string">"#676767"</span>;
    <span class="hljs-keyword">private</span> String longDegreeColor = <span class="hljs-string">"#d2d2d2"</span>;
    <span class="hljs-keyword">private</span> String shortDegreeColor = <span class="hljs-string">"#adadad"</span>;
    <span class="hljs-keyword">private</span> String bgArcColor = <span class="hljs-string">"#111111"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> isShowCurrentSpeed = <span class="hljs-keyword">true</span>;
    <span class="hljs-keyword">private</span> String hintString = <span class="hljs-string">"Km/h"</span>;


    <span class="hljs-comment">// sweepAngle / maxValues 的值</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> k;

    <span class="hljs-keyword">public</span> <span class="hljs-title">ColorArcProgressBar</span>(Context context) {
        <span class="hljs-keyword">super</span>(context);
        initView();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title">ColorArcProgressBar</span>(Context context, AttributeSet attrs) {
        <span class="hljs-keyword">super</span>(context, attrs);
        initView();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title">ColorArcProgressBar</span>(Context context, AttributeSet attrs, <span class="hljs-keyword">int</span> defStyleAttr) {
        <span class="hljs-keyword">super</span>(context, attrs, defStyleAttr);
        initView();
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMeasure</span>(<span class="hljs-keyword">int</span> widthMeasureSpec, <span class="hljs-keyword">int</span> heightMeasureSpec) {
        <span class="hljs-keyword">int</span> width = <span class="hljs-number">2</span> * longdegree + progressWidth + diameter + <span class="hljs-number">2</span> * DEGREE_PROGRESS_DISTANCE;
        <span class="hljs-keyword">int</span> height= <span class="hljs-number">2</span> * longdegree + progressWidth + diameter + <span class="hljs-number">2</span> * DEGREE_PROGRESS_DISTANCE;
        setMeasuredDimension(width, height);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initView</span>() {

        diameter = <span class="hljs-number">3</span> * getScreenWidth() / <span class="hljs-number">5</span>;
        <span class="hljs-comment">//弧形的矩阵区域</span>
        bgRect = <span class="hljs-keyword">new</span> RectF();
        bgRect.top = longdegree + progressWidth/<span class="hljs-number">2</span> + DEGREE_PROGRESS_DISTANCE;
        bgRect.left = longdegree + progressWidth/<span class="hljs-number">2</span> + DEGREE_PROGRESS_DISTANCE;
        bgRect.right = diameter + (longdegree + progressWidth/<span class="hljs-number">2</span> + DEGREE_PROGRESS_DISTANCE);
        bgRect.bottom = diameter + (longdegree + progressWidth/<span class="hljs-number">2</span> + DEGREE_PROGRESS_DISTANCE);

        <span class="hljs-comment">//圆心</span>
        centerX = (<span class="hljs-number">2</span> * longdegree + progressWidth + diameter + <span class="hljs-number">2</span> * DEGREE_PROGRESS_DISTANCE)/<span class="hljs-number">2</span>;
        centerY = (<span class="hljs-number">2</span> * longdegree + progressWidth + diameter + <span class="hljs-number">2</span> * DEGREE_PROGRESS_DISTANCE)/<span class="hljs-number">2</span>;

        <span class="hljs-comment">//外部刻度线</span>
        degreePaint = <span class="hljs-keyword">new</span> Paint();
        degreePaint.setColor(Color.parseColor(longDegreeColor));

        <span class="hljs-comment">//整个弧形</span>
        allArcPaint = <span class="hljs-keyword">new</span> Paint();
        allArcPaint.setAntiAlias(<span class="hljs-keyword">true</span>);
        allArcPaint.setStyle(Paint.Style.STROKE);
        allArcPaint.setStrokeWidth(bgArcWidth);
        allArcPaint.setColor(Color.parseColor(bgArcColor));
        allArcPaint.setStrokeCap(Paint.Cap.ROUND);

        <span class="hljs-comment">//当前进度的弧形</span>
        progressPaint = <span class="hljs-keyword">new</span> Paint();
        progressPaint.setAntiAlias(<span class="hljs-keyword">true</span>);
        progressPaint.setStyle(Paint.Style.STROKE);
        progressPaint.setStrokeCap(Paint.Cap.ROUND);
        progressPaint.setStrokeWidth(progressWidth);
        progressPaint.setColor(Color.GREEN);

        <span class="hljs-comment">//当前速度显示文字</span>
        vTextPaint = <span class="hljs-keyword">new</span> Paint();
        vTextPaint.setTextSize(textSize);
        vTextPaint.setColor(Color.WHITE);
        vTextPaint.setTextAlign(Paint.Align.CENTER);

        <span class="hljs-comment">//显示“km/h”文字</span>
        hintPaint = <span class="hljs-keyword">new</span> Paint();
        hintPaint.setTextSize(hintSize);
        hintPaint.setColor(Color.parseColor(hintColor));
        hintPaint.setTextAlign(Paint.Align.CENTER);

        <span class="hljs-comment">//显示“km/h”文字</span>
        curSpeedPaint = <span class="hljs-keyword">new</span> Paint();
        curSpeedPaint.setTextSize(curSpeedSize);
        curSpeedPaint.setColor(Color.parseColor(hintColor));
        curSpeedPaint.setTextAlign(Paint.Align.CENTER);



    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onDraw</span>(Canvas canvas) {

        <span class="hljs-comment">//抗锯齿</span>
        canvas.setDrawFilter(<span class="hljs-keyword">new</span> PaintFlagsDrawFilter(<span class="hljs-number">0</span>, Paint.ANTI_ALIAS_FLAG|Paint.FILTER_BITMAP_FLAG));

        <span class="hljs-comment">//画刻度线</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">40</span>; i++) {
            <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">15</span> &amp;&amp; i &lt; <span class="hljs-number">25</span>) {
                canvas.rotate(<span class="hljs-number">9</span>, centerX, centerY);
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-keyword">if</span> (i%<span class="hljs-number">5</span> == <span class="hljs-number">0</span>) {
                degreePaint.setStrokeWidth(dipToPx(<span class="hljs-number">2</span>));
                degreePaint.setColor(Color.parseColor(longDegreeColor));
                canvas.drawLine(centerX, centerY - diameter/<span class="hljs-number">2</span> - progressWidth/<span class="hljs-number">2</span> - DEGREE_PROGRESS_DISTANCE, centerX, centerY - diameter/<span class="hljs-number">2</span> - progressWidth/<span class="hljs-number">2</span> - DEGREE_PROGRESS_DISTANCE - longdegree, degreePaint);
            }<span class="hljs-keyword">else</span> {
                degreePaint.setStrokeWidth(dipToPx(<span class="hljs-number">1.4</span>f));
                degreePaint.setColor(Color.parseColor(shortDegreeColor));
                canvas.drawLine(centerX, centerY - diameter/<span class="hljs-number">2</span> - progressWidth/<span class="hljs-number">2</span> - DEGREE_PROGRESS_DISTANCE - (longdegree - shortdegree)/<span class="hljs-number">2</span>, centerX, centerY - diameter/<span class="hljs-number">2</span> - progressWidth/<span class="hljs-number">2</span> - DEGREE_PROGRESS_DISTANCE - (longdegree - shortdegree)/<span class="hljs-number">2</span> - shortdegree, degreePaint);
            }

            canvas.rotate(<span class="hljs-number">9</span>, centerX, centerY);
        }

        <span class="hljs-comment">//整个弧</span>
        canvas.drawArc(bgRect,startAngle, sweepAngle, <span class="hljs-keyword">false</span>, allArcPaint);

        <span class="hljs-comment">//设置渐变色</span>
        SweepGradient sweepGradient = <span class="hljs-keyword">new</span> SweepGradient(centerX, centerY, colors, <span class="hljs-keyword">null</span>);
        Matrix matrix = <span class="hljs-keyword">new</span> Matrix();
        matrix.setRotate(<span class="hljs-number">130</span>, centerX, centerY);
        sweepGradient.setLocalMatrix(matrix);
        progressPaint.setShader(sweepGradient);

        <span class="hljs-comment">//当前进度</span>
        canvas.drawArc(bgRect, startAngle, currentAngle, <span class="hljs-keyword">false</span>, progressPaint);
        <span class="hljs-keyword">if</span> (isShowCurrentSpeed) {
            canvas.drawText(String.format(<span class="hljs-string">"%.1f"</span>,curValues) , centerX, centerY + textSize / <span class="hljs-number">3</span>, vTextPaint);
        }
        canvas.drawText(hintString,centerX, centerY + <span class="hljs-number">2</span>*textSize/<span class="hljs-number">3</span>, hintPaint);
        canvas.drawText(<span class="hljs-string">"CURRENT SPEED"</span>,centerX, centerY - <span class="hljs-number">2</span>*textSize/<span class="hljs-number">3</span>, curSpeedPaint);
        invalidate();

    }

    <span class="hljs-javadoc">/**
     * 设置最大值
     *<span class="hljs-javadoctag"> @param</span> maxValues
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMaxValues</span>(<span class="hljs-keyword">float</span> maxValues) {
        <span class="hljs-keyword">this</span>.maxValues = maxValues;
        k = sweepAngle/maxValues;
    }

    <span class="hljs-javadoc">/**
     * 设置当前值
     *<span class="hljs-javadoctag"> @param</span> currentValues
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCurrentValues</span>(<span class="hljs-keyword">float</span> currentValues) {
        <span class="hljs-keyword">if</span> (currentValues &gt; maxValues) {
            currentValues = maxValues;
        }
        <span class="hljs-keyword">if</span> (currentValues &lt; <span class="hljs-number">0</span>) {
            currentValues = <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">this</span>.curValues = currentValues;
        lastAngle = currentAngle;
        setAnimation(lastAngle, currentValues * k, aniSpeed);
    }

    <span class="hljs-javadoc">/**
     * 设置整个圆弧宽度
     *<span class="hljs-javadoctag"> @param</span> bgArcWidth
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBgArcWidth</span>(<span class="hljs-keyword">int</span> bgArcWidth) {
        <span class="hljs-keyword">this</span>.bgArcWidth = bgArcWidth;
    }

    <span class="hljs-javadoc">/**
     * 设置进度宽度
     *<span class="hljs-javadoctag"> @param</span> progressWidth
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setProgressWidth</span>(<span class="hljs-keyword">int</span> progressWidth) {
        <span class="hljs-keyword">this</span>.progressWidth = progressWidth;
    }

    <span class="hljs-javadoc">/**
     * 设置速度文字大小
     *<span class="hljs-javadoctag"> @param</span> textSize
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTextSize</span>(<span class="hljs-keyword">int</span> textSize) {
        <span class="hljs-keyword">this</span>.textSize = textSize;
    }

    <span class="hljs-javadoc">/**
     * 设置单位文字大小
     *<span class="hljs-javadoctag"> @param</span> hintSize
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setHintSize</span>(<span class="hljs-keyword">int</span> hintSize) {
        <span class="hljs-keyword">this</span>.hintSize = hintSize;
    }

    <span class="hljs-javadoc">/**
     * 设置单位文字
     *<span class="hljs-javadoctag"> @param</span> hintString
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUnit</span>(String hintString) {
        <span class="hljs-keyword">this</span>.hintString = hintString;
        invalidate();
    }

    <span class="hljs-javadoc">/**
     * 设置直径大小
     *<span class="hljs-javadoctag"> @param</span> diameter
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setDiameter</span>(<span class="hljs-keyword">int</span> diameter) {
        <span class="hljs-keyword">this</span>.diameter = dipToPx(diameter);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAniSpeed</span>() {

    }
    <span class="hljs-javadoc">/**
     * 为进度设置动画
     *<span class="hljs-javadoctag"> @param</span> last
     *<span class="hljs-javadoctag"> @param</span> current
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAnimation</span>(<span class="hljs-keyword">float</span> last, <span class="hljs-keyword">float</span> current, <span class="hljs-keyword">int</span> length) {
        progressAnimator = ValueAnimator.ofFloat(last, current);
        progressAnimator.setDuration(length);
        progressAnimator.setTarget(currentAngle);
        progressAnimator.addUpdateListener(<span class="hljs-keyword">new</span> ValueAnimator.AnimatorUpdateListener() {

            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAnimationUpdate</span>(ValueAnimator animation) {
                currentAngle= (<span class="hljs-keyword">float</span>) animation.getAnimatedValue();
            }
        });
        progressAnimator.start();
    }


    <span class="hljs-javadoc">/**
     * dip 转换成px
     *<span class="hljs-javadoctag"> @param</span> dip
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">dipToPx</span>(<span class="hljs-keyword">float</span> dip) {
        <span class="hljs-keyword">float</span> density = getContext().getResources().getDisplayMetrics().density;
        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">int</span>)(dip * density + <span class="hljs-number">0.5</span>f * (dip &gt;= <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>));
    }

    <span class="hljs-javadoc">/**
     * 得到屏幕宽度
     *<span class="hljs-javadoctag"> @return</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getScreenWidth</span>() {
        WindowManager windowManager = (WindowManager) getContext().getSystemService(Context.WINDOW_SERVICE);
        DisplayMetrics displayMetrics = <span class="hljs-keyword">new</span> DisplayMetrics();
        windowManager.getDefaultDisplay().getMetrics(displayMetrics);
        <span class="hljs-keyword">return</span> displayMetrics.widthPixels;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setIsShowCurrentSpeed</span>(<span class="hljs-keyword">boolean</span> isShowCurrentSpeed) {
        <span class="hljs-keyword">this</span>.isShowCurrentSpeed = isShowCurrentSpeed;
    }

    <span class="hljs-javadoc">/**
     * 初始加载页面时设置加载动画
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setDefaultWithAnimator</span>() {
        setAnimation(sweepAngle, currentAngle, <span class="hljs-number">2000</span>);
    }



}
</code></pre> 
<p>从以上代码可以看出：</p> 
<ul><li><p>在initView 的时候设置了弧形的直径diameter = 3 * getScreenWidth() / 5;也就是弧形的直径是根据屏幕的大小定的。 <br> 我们再看OnMeasure方法</p> <pre class="prettyprint"><code class=" hljs java"> <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMeasure</span>(<span class="hljs-keyword">int</span> widthMeasureSpec, <span class="hljs-keyword">int</span> heightMeasureSpec) {
        <span class="hljs-keyword">int</span> width = <span class="hljs-number">2</span> * longdegree + progressWidth + diameter + <span class="hljs-number">2</span> * DEGREE_PROGRESS_DISTANCE;
        <span class="hljs-keyword">int</span> height= <span class="hljs-number">2</span> * longdegree + progressWidth + diameter + <span class="hljs-number">2</span> * DEGREE_PROGRESS_DISTANCE;
        setMeasuredDimension(width, height);
    }
</code></pre></li></ul> 
<p>所以我们知道：不管你怎么设置控件的宽高，都没有效果。这是第一个问题</p> 
<ul><li><p>设置某些颜色值无效的问题： <br> 颜色值的设置是通常作用于画笔上，我们先看看几个画笔：</p> <pre class="prettyprint"><code class=" hljs cs">    <span class="hljs-keyword">private</span> Paint allArcPaint;<span class="hljs-comment">//背景弧形的画笔（圆弧）</span>
    <span class="hljs-keyword">private</span> Paint progressPaint;<span class="hljs-comment">//进度画笔(当前速度)</span>
    <span class="hljs-keyword">private</span> Paint vTextPaint;<span class="hljs-comment">//内容文字画笔(80)</span>
    <span class="hljs-keyword">private</span> Paint hintPaint;<span class="hljs-comment">//单位文字画笔（km/h）</span>
    <span class="hljs-keyword">private</span> Paint degreePaint;<span class="hljs-comment">//刻度画笔（刻度条）</span>
    <span class="hljs-keyword">private</span> Paint curSpeedPaint;<span class="hljs-comment">//标题文字画笔（当前速度）</span></code></pre></li></ul> 
<p>这些画笔的颜色值在initView的时候初始化，但是颜色值并没有在initConfig的时候取出属性值并且配置，所以这是导致设置颜色无效的原因</p> 
<p><strong><em>注意：给画笔设置的颜色值必须带有透明度，不然会自动带上全透明效果。看不到任何信息</em></strong></p> 
<ul><li>调整控件大小的时候圆弧内的文字没有做出大小和位置的调整 <br> 在源代码中，initView的时候就已经设置TextSize了，而initView是在实例化的时候调用的，这时候控件的大小都还没有确定，所以需要把和大小相关的值都放到OnSizeChange中，或者在OnMeasure中获取控件的实际大小之后再初始化这些值</li></ul> 
<pre class="prettyprint"><code class=" hljs java">    <span class="hljs-annotation">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onSizeChanged</span>(<span class="hljs-keyword">int</span> w, <span class="hljs-keyword">int</span> h, <span class="hljs-keyword">int</span> oldw, <span class="hljs-keyword">int</span> oldh)
        {
            <span class="hljs-keyword">super</span>.onSizeChanged(w, h, oldw, oldh);
            mWidth = w;
            mHeight = h;
            Log.v(<span class="hljs-string">"ColorArcProgressBar"</span>, <span class="hljs-string">"onSizeChanged: mWidth:"</span> + mWidth + <span class="hljs-string">" mHeight:"</span> + mHeight);

            diameter = (<span class="hljs-keyword">int</span>) (Math.min(mWidth, mHeight) - <span class="hljs-number">2</span> * (longDegree + DEGREE_PROGRESS_DISTANCE + progressWidth / <span class="hljs-number">2</span>));

            Log.v(<span class="hljs-string">"ColorArcProgressBar"</span>, <span class="hljs-string">"onSizeChanged: diameter:"</span> + diameter);

            <span class="hljs-comment">//弧形的矩阵区域</span>
            bgRect = <span class="hljs-keyword">new</span> RectF();
            bgRect.top = longDegree + DEGREE_PROGRESS_DISTANCE + progressWidth / <span class="hljs-number">2</span>;
            bgRect.left = longDegree + DEGREE_PROGRESS_DISTANCE + progressWidth / <span class="hljs-number">2</span>;
            bgRect.right = diameter + (longDegree + progressWidth / <span class="hljs-number">2</span> + DEGREE_PROGRESS_DISTANCE);
            bgRect.bottom = diameter + (longDegree + progressWidth / <span class="hljs-number">2</span> + DEGREE_PROGRESS_DISTANCE);

            Log.v(<span class="hljs-string">"ColorArcProgressBar"</span>, <span class="hljs-string">"initView: "</span> + diameter);

            <span class="hljs-comment">//圆心</span>
            centerX = (<span class="hljs-number">2</span> * (longDegree + DEGREE_PROGRESS_DISTANCE + progressWidth / <span class="hljs-number">2</span>) + diameter) / <span class="hljs-number">2</span>;
            centerY = (<span class="hljs-number">2</span> * (longDegree + DEGREE_PROGRESS_DISTANCE + progressWidth / <span class="hljs-number">2</span>) + diameter) / <span class="hljs-number">2</span>;

            sweepGradient = <span class="hljs-keyword">new</span> SweepGradient(centerX, centerY, colors, <span class="hljs-keyword">null</span>);

            mTouchInvalidateRadius = Math.max(mWidth, mHeight) / <span class="hljs-number">2</span> - longDegree - DEGREE_PROGRESS_DISTANCE - progressWidth * <span class="hljs-number">2</span>;

            <span class="hljs-keyword">if</span>(isAutoTextSize)
            {
                textSize = (<span class="hljs-keyword">float</span>) (diameter * <span class="hljs-number">0.3</span>);
                hintSize = (<span class="hljs-keyword">float</span>) (diameter * <span class="hljs-number">0.1</span>);
                curSpeedSize = (<span class="hljs-keyword">float</span>) (diameter * <span class="hljs-number">0.1</span>);

                vTextPaint.setTextSize(textSize);
                hintPaint.setTextSize(hintSize);
                curSpeedPaint.setTextSize(curSpeedSize);
            }

        }</code></pre> 
<p>通过在OnSizeChange中初始化这些动态的尺寸，就解决了文字缩放的问题。</p> 
<hr> 
<h4 id="增加拖动功能">增加拖动功能</h4> 
<p><strong>1. 定义Seek接口</strong></p> 
<pre class="prettyprint"><code class=" hljs cs">
     <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> OnSeekArcChangeListener
        {


            <span class="hljs-keyword">void</span> onProgressChanged(ColorArcProgressBar seekArc, <span class="hljs-keyword">int</span> progress, boolean fromUser);


            <span class="hljs-keyword">void</span> onStartTrackingTouch(ColorArcProgressBar seekArc);


            <span class="hljs-keyword">void</span> onStopTrackingTouch(ColorArcProgressBar seekArc);
        }
</code></pre> 
<p><strong>2.重写onTouchEvent方法</strong></p> 
<pre class="prettyprint"><code class=" hljs cs">
     @Override
        <span class="hljs-keyword">public</span> boolean <span class="hljs-title">onTouchEvent</span>(MotionEvent <span class="hljs-keyword">event</span>)
        {
            <span class="hljs-keyword">if</span>(seekEnable)
            {
                <span class="hljs-keyword">this</span>.getParent().requestDisallowInterceptTouchEvent(<span class="hljs-keyword">true</span>);<span class="hljs-comment">//一旦底层View收到touch的action后调用这个方法那么父层View就不会再调用onInterceptTouchEvent了，也无法截获以后的action</span>

                <span class="hljs-keyword">switch</span>(<span class="hljs-keyword">event</span>.getAction())
                {
                    <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                        onStartTrackingTouch();
                        updateOnTouch(<span class="hljs-keyword">event</span>);
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
                        updateOnTouch(<span class="hljs-keyword">event</span>);
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
                        onStopTrackingTouch();
                        setPressed(<span class="hljs-keyword">false</span>);
                        <span class="hljs-keyword">this</span>.getParent().requestDisallowInterceptTouchEvent(<span class="hljs-keyword">false</span>);
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> MotionEvent.ACTION_CANCEL:
                        onStopTrackingTouch();
                        setPressed(<span class="hljs-keyword">false</span>);
                        <span class="hljs-keyword">this</span>.getParent().requestDisallowInterceptTouchEvent(<span class="hljs-keyword">false</span>);
                        <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        }</code></pre> 
<p><strong>3.处理触摸事件</strong></p> 
<pre class="prettyprint"><code class=" hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateOnTouch</span>(MotionEvent event)
    {
        <span class="hljs-keyword">boolean</span> validateTouch = validateTouch(event.getX(), event.getY());<span class="hljs-comment">//滑动的位置是否合法</span>
        <span class="hljs-keyword">if</span>(!validateTouch)
        {
            <span class="hljs-keyword">return</span>;
        }
        setPressed(<span class="hljs-keyword">true</span>);
        <span class="hljs-keyword">double</span> mTouchAngle = getTouchDegrees(event.getX(), event.getY());

        <span class="hljs-keyword">int</span> progress = angleToProgress(mTouchAngle);
        Log.v(<span class="hljs-string">"ColorArcProgressBar"</span>, <span class="hljs-string">"updateOnTouch: "</span> + progress);
        onProgressRefresh(progress, <span class="hljs-keyword">true</span>);
    }

    <span class="hljs-javadoc">/**
     * 判断触摸是否有效
     *
     *<span class="hljs-javadoctag"> @param</span> xPos 触摸点x坐标
     *<span class="hljs-javadoctag"> @param</span> yPos 触摸点y坐标
     *<span class="hljs-javadoctag"> @return</span> is validate touch
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">validateTouch</span>(<span class="hljs-keyword">float</span> xPos, <span class="hljs-keyword">float</span> yPos)
    {
        <span class="hljs-keyword">boolean</span> validate = <span class="hljs-keyword">false</span>;

        <span class="hljs-keyword">float</span> x = xPos - centerX;<span class="hljs-comment">//触摸点X坐标与圆心X坐标的距离</span>
        <span class="hljs-keyword">float</span> y = yPos - centerY;<span class="hljs-comment">//触摸点Y坐标与圆心Y坐标的距离</span>

        <span class="hljs-keyword">float</span> touchRadius = (<span class="hljs-keyword">float</span>) Math.sqrt(((x * x) + (y * y)));<span class="hljs-comment">//触摸半径</span>
        <span class="hljs-comment">//toDegrees是弧度转换成角度</span>
        <span class="hljs-keyword">double</span> angle = Math.toDegrees(Math.atan2(y, x) + (Math.PI / <span class="hljs-number">2</span>) - Math.toRadians(<span class="hljs-number">225</span>));

        <span class="hljs-keyword">if</span>(angle &lt; <span class="hljs-number">0</span>)
        {
            angle = <span class="hljs-number">360</span> + angle;
        }

<span class="hljs-comment">//        mTouchInvalidateRadius = Math.max(mWidth, mHeight) / 2 - longDegree - DEGREE_PROGRESS_DISTANCE - progressWidth * 2;这个有效触摸半径在OnSizeChange方法计算，我们让可以触摸的范围是从控件的最边缘到弧形的再往内靠一个弧形宽度的距离，有效增大触摸的范围</span>

<span class="hljs-comment">//我们的弧形的弧度是270°，适当增加了最大值的触摸角度，增加触摸的灵敏度</span>
        <span class="hljs-keyword">if</span>(touchRadius &gt; mTouchInvalidateRadius &amp;&amp; (angle &gt;= <span class="hljs-number">0</span> &amp;&amp; angle &lt;= <span class="hljs-number">280</span>))<span class="hljs-comment">//其实角度小于270就够了,但是弧度换成角度是不精确的,所以需要适当放大范围,不然有时候滑动不到最大值</span>
        {
            validate = <span class="hljs-keyword">true</span>;
        }

        Log.v(<span class="hljs-string">"ColorArcProgressBar"</span>, <span class="hljs-string">"validateTouch: "</span> + angle);
        <span class="hljs-keyword">return</span> validate;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getTouchDegrees</span>(<span class="hljs-keyword">float</span> xPos, <span class="hljs-keyword">float</span> yPos)
    {
        <span class="hljs-keyword">float</span> x = xPos - centerX;
        <span class="hljs-keyword">float</span> y = yPos - centerY;
        <span class="hljs-comment">// Math.toDegrees convert to arc Angle</span>

        <span class="hljs-comment">//Math.atan2(y, x)以弧度为单位计算并返回点 y /x 的角度，该角度从圆的 x 轴（0 点在其上，0 表示圆心）沿逆时针方向测量。返回值介于正 pi 和负 pi 之间。</span>
        <span class="hljs-comment">//触摸点与圆心的夹角- Math.toRadians(225)是因为我们希望0°从圆弧的起点开始,默认角度从穿过圆心的X轴开始</span>
        <span class="hljs-keyword">double</span> angle = Math.toDegrees(Math.atan2(y, x) + (Math.PI / <span class="hljs-number">2</span>) - Math.toRadians(<span class="hljs-number">225</span>));

        <span class="hljs-keyword">if</span>(angle &lt; <span class="hljs-number">0</span>)
        {
            angle = <span class="hljs-number">360</span> + angle;
        }
        Log.v(<span class="hljs-string">"ColorArcProgressBar"</span>, <span class="hljs-string">"getTouchDegrees: "</span> + angle);
<span class="hljs-comment">//        angle -= mStartAngle;</span>
        <span class="hljs-keyword">return</span> angle;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">angleToProgress</span>(<span class="hljs-keyword">double</span> angle)
    {

        <span class="hljs-keyword">int</span> progress = (<span class="hljs-keyword">int</span>) Math.round(valuePerDegree() * angle);

        progress = (progress &lt; <span class="hljs-number">0</span>) ? <span class="hljs-number">0</span> : progress;
        progress = (progress &gt; maxValues) ? (<span class="hljs-keyword">int</span>) maxValues : progress;
        <span class="hljs-keyword">return</span> progress;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">float</span> <span class="hljs-title">valuePerDegree</span>()
    {
        <span class="hljs-keyword">return</span> maxValues / sweepAngle;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onProgressRefresh</span>(<span class="hljs-keyword">int</span> progress, <span class="hljs-keyword">boolean</span> fromUser)
    {
        updateProgress(progress, fromUser);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateProgress</span>(<span class="hljs-keyword">int</span> progress, <span class="hljs-keyword">boolean</span> fromUser)
    {

        currentValues = progress;

        <span class="hljs-keyword">if</span>(listener != <span class="hljs-keyword">null</span>)
        {
            listener.onProgressChanged(<span class="hljs-keyword">this</span>, progress, fromUser);
        }

        currentAngle = (<span class="hljs-keyword">float</span>) progress / maxValues * sweepAngle;<span class="hljs-comment">//计算划过当前的角度</span>

        lastAngle = currentAngle;

        invalidate();
    }</code></pre> 
<p>最终效果图： <br> <img src="https://images2.imgbox.com/51/dc/zj6VpSgc_o.gif" alt="这里写图片描述" title=""></p> 
<h4 id="demo下载"><a href="https://github.com/FelixLee0527/ColorArcProgressBar">Demo下载</a></h4>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/677ff5ffa46670cc72b820c248db8704/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Arduino 驱动OLED屏幕IIC接线方式简单入门</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e3138f53da220d7f71a291b00e27d9f9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">程序改错</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>