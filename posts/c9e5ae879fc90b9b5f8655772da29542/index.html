<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STMf407vet6开发板的使用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STMf407vet6开发板的使用" />
<meta property="og:description" content="了解的知识 需要什么就添加什么，都在对应的文件里，比如gpio就再gpio.c里面，在.c文件里右键跳到头文件查找自己需要的函数。xx.s是汇编的启动文件，里面有中断的向量表。misc.c里面是中断函数。在system_stm32f4xx.c 和stm32f4xx.h里面修改对应的时钟频率。
LED灯使用 1.首先查看开发板对应的原理图引脚，和芯片连接的网络标号，看它在哪一根时钟总线上。 /**************************************** 函数名:void LED_Init(void) 功能:初始化LED灯 参数:无 返回值:无 说明: 1.通过原理图查询到 LED1 ---- PE8 LED2 ---- PE9 LED3 ---- PE10 *****************************************/ void LED_Init(void) { //1.RCC 使能 AHB1 总线上的 GPIOE 总线时钟 RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOE, ENABLE); //2.初始化GPIO GPIO_InitTypeDef GPIO_InitStruct; GPIO_InitStruct.GPIO_Pin = GPIO_Pin_8 | GPIO_Pin_9 | GPIO_Pin_10;	//引脚:8|9|10 GPIO_InitStruct.GPIO_Mode = GPIO_Mode_OUT;	//模式:通用输出 GPIO_InitStruct.GPIO_OType = GPIO_OType_PP;	//类型:推挽输出 GPIO_InitStruct.GPIO_Speed = GPIO_Fast_Speed;	//速度:快速 50MHz GPIO_InitStruct.GPIO_PuPd = GPIO_PuPd_NOPULL;	//状态:无上下拉 GPIO_Init(GPIOE, &amp;GPIO_InitStruct);	//初始化GPIO //3.控制寄存器输出数据 ---- 让LED不亮 //GPIO_SetBits(GPIOE,GPIO_Pin_8|GPIO_Pin_9|GPIO_Pin_10);	//将LED引脚置位高电平 -- 不亮 LED1 = LED2 = LED3 = 1;	//将LED引脚置位高电平 -- 不亮 } 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c9e5ae879fc90b9b5f8655772da29542/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-20T15:22:07+08:00" />
<meta property="article:modified_time" content="2023-07-20T15:22:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STMf407vet6开发板的使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>了解的知识</h2> 
<p>需要什么就添加什么，都在对应的文件里，比如gpio就再gpio.c里面，在.c文件里右键跳到头文件查找自己需要的函数。xx.s是汇编的启动文件，里面有中断的向量表。misc.c里面是中断函数。在system_stm32f4xx.c 和stm32f4xx.h里面修改对应的时钟频率。<br> <img src="https://images2.imgbox.com/b8/cf/JzQI53kR_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="LED_6"></a>LED灯使用</h2> 
<h5><a id="1_7"></a>1.首先查看开发板对应的原理图引脚，和芯片连接的网络标号，看它在哪一根时钟总线上。</h5> 
<p><img src="https://images2.imgbox.com/19/d2/5TBLuQeg_o.png" alt=""><br> <img src="https://images2.imgbox.com/d5/b0/8trLpVA2_o.png" alt="![在这里插入图片描述](https://img-blog.csdnimg.cn/76b962df199b47649315cb55245e8e52.png"><br> <img src="https://images2.imgbox.com/6a/3c/WsnGduTJ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token comment">/****************************************
函数名:void LED_Init(void)
功能:初始化LED灯
参数:无
返回值:无
说明:
	1.通过原理图查询到 
		LED1 ---- PE8
		LED2 ---- PE9
		LED3 ---- PE10
*****************************************/</span>
<span class="token keyword">void</span> <span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.RCC 使能 AHB1 总线上的 GPIOE 总线时钟 </span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.初始化GPIO</span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_8 <span class="token operator">|</span> GPIO_Pin_9 <span class="token operator">|</span> GPIO_Pin_10<span class="token punctuation">;</span>	<span class="token comment">//引脚:8|9|10</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_OUT<span class="token punctuation">;</span>		<span class="token comment">//模式:通用输出</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>		<span class="token comment">//类型:推挽输出</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Fast_Speed<span class="token punctuation">;</span>	<span class="token comment">//速度:快速 50MHz </span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd  <span class="token operator">=</span> GPIO_PuPd_NOPULL<span class="token punctuation">;</span>	<span class="token comment">//状态:无上下拉</span>
	
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//初始化GPIO</span>
	<span class="token comment">//3.控制寄存器输出数据 ---- 让LED不亮</span>
	<span class="token comment">//GPIO_SetBits(GPIOE,GPIO_Pin_8|GPIO_Pin_9|GPIO_Pin_10);	//将LED引脚置位高电平 -- 不亮</span>
	LED1 <span class="token operator">=</span> LED2 <span class="token operator">=</span> LED3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//将LED引脚置位高电平 -- 不亮</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="2_45"></a>2.蜂鸣器，方法同上</h2> 
<p><img src="https://images2.imgbox.com/e2/f8/i0U5bT98_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7f/91/x1bkfNZD_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/0e/40/yiBzsEhB_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token comment">/****************************************
函数名:void BEEP_Init(void)
功能:BEEP蜂鸣器初始化
参数:无
返回值:无
说明:
	1.通过原理图查询到 
		BEEP --- PB10
*****************************************/</span>
<span class="token keyword">void</span> <span class="token function">BEEP_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>	
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.RCC 使能 AHB1 总线上的 GPIOB 总线时钟 </span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOB<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.初始化GPIO</span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_10<span class="token punctuation">;</span>			<span class="token comment">//引脚:10</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_OUT<span class="token punctuation">;</span>		<span class="token comment">//模式:通用输出</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>		<span class="token comment">//类型:推挽输出</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Fast_Speed<span class="token punctuation">;</span>	<span class="token comment">//速度:快速 50MHz </span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd  <span class="token operator">=</span> GPIO_PuPd_NOPULL<span class="token punctuation">;</span>	<span class="token comment">//状态:无上下拉</span>
	
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//初始化GPIO</span>
	<span class="token comment">//3.控制寄存器输出数据 ---- 让BEEP响</span>
	<span class="token comment">//GPIO_SetBits(GPIOB,GPIO_Pin_10);	//将BEEP引脚置位高电平 -- 响</span>
	<span class="token comment">//GPIO_ResetBits(GPIOB,GPIO_Pin_10);	//将BEEP引脚置位高电平 -- 不响</span>
	
	BEEP <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2><a id="3_85"></a>3.按键</h2> 
<p><img src="https://images2.imgbox.com/01/9d/Hb1Ofgfw_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/95/87/SWIROjqT_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/8f/b1/H0HYUzhc_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/81/4b/QH3tfBrX_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c">
<span class="token comment">/****************************************
函数名:void KEY_Init(void)
功能:KEY按键初始化
参数:无
返回值:无
说明:
	1.通过原理图查询到 
		KEY1 --- PE4
		KEY2 --- PE5
		KEY3 --- PE6
		KEY4 --- PC13
*****************************************/</span>
<span class="token keyword">void</span> <span class="token function">KEY_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	<span class="token comment">//1.RCC使能时钟 AHB1总线上的 GPIOE 和 GPIOC 总线</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOE<span class="token operator">|</span>RCC_AHB1Periph_GPIOC<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.1 初始化GPIOE</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_4<span class="token operator">|</span>GPIO_Pin_5<span class="token operator">|</span>GPIO_Pin_6<span class="token punctuation">;</span>	<span class="token comment">//引脚:4|5|6</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN<span class="token punctuation">;</span>						<span class="token comment">//模式:输入模式</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>						<span class="token comment">//状态:拉高</span>
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.2 初始化GPIOC</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_13<span class="token punctuation">;</span>
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/********************************************************************************
函数名:u8 KEY_Scan(void)
功能:读取KEY按键值
参数:无
返回值:
	KEY1 按下返回 1
	KEY1 按下返回 2
	KEY1 按下返回 3
	KEY1 按下返回 4	
	没有按键按下则返回0
说明:当按键按下时,引脚会被拉低,变为0低电平.
uint8_t GPIO_ReadInputDataBit(GPIO_TypeDef* GPIOx, uint16_t GPIO_Pin);
1.出现按键抖动问题,使用延时消抖。
2.出现连续出现多次触发，使用不连续按下，定义一个静态变量保存上次按下记录
*********************************************************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1</span> <span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span>GPIO_Pin_4<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2</span> <span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span>GPIO_Pin_5<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY3</span> <span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span>GPIO_Pin_6<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY4</span> <span class="token expression"><span class="token function">GPIO_ReadInputDataBit</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span>GPIO_Pin_13<span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
u8 <span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> u8 up <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//记录上次按键状态, 1 上次没有任何按键按下，0表示有按键按下</span>
	<span class="token comment">//检查按键第一次</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>up <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>KEY1 <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> KEY2 <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> KEY3 <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> KEY4 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		up <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//记录按键按下了</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//延时5毫秒进行消抖</span>
		<span class="token comment">//再次检查按键是否按下</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>KEY1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>KEY2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>KEY3 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>KEY4 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">4</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>KEY1 <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> KEY2 <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> KEY3 <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> KEY4 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		up <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//记录没有任何按键按下，可以触发下次检测</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2><a id="4_169"></a>4.中断</h2> 
<p><img src="https://images2.imgbox.com/7b/1d/2W5lpT4M_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"nvic_key_exit.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f4xx.h"</span>                  <span class="token comment">// Device header</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"key.h"</span></span>
<span class="token comment">/****************************************
函数名:void KEY_EXIT_Init(void)
功能:按键外部中断初始化
参数:无
返回值:无
说明:
	1.通过原理图查询到 
		KEY1 --- PE4		---- E4
		KEY2 --- PE5		---- E5
		KEY3 --- PE6		---- E6
		KEY4 --- PC13		---- C13
*****************************************/</span>
<span class="token keyword">void</span> <span class="token function">KEY_EXIT_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	EXTI_InitTypeDef EXTI_InitStruct<span class="token punctuation">;</span>	<span class="token comment">//外部中断结构体</span>
	NVIC_InitTypeDef NVIC_InitStruct<span class="token punctuation">;</span>	<span class="token comment">//中断结构体</span>
	<span class="token comment">//1.外部中断属于外设,也需要时钟使能</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_SYSCFG<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.初始化GPIO</span>
	<span class="token function">KEY_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//3.配置中断引脚 SYSCFG_EXTILineConfig(uint8_t EXTI_PortSourceGPIOx, uint8_t EXTI_PinSourcex);</span>
	<span class="token function">SYSCFG_EXTILineConfig</span><span class="token punctuation">(</span>EXTI_PortSourceGPIOE<span class="token punctuation">,</span>EXTI_PinSource4<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SYSCFG_EXTILineConfig</span><span class="token punctuation">(</span>EXTI_PortSourceGPIOE<span class="token punctuation">,</span>EXTI_PinSource5<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SYSCFG_EXTILineConfig</span><span class="token punctuation">(</span>EXTI_PortSourceGPIOE<span class="token punctuation">,</span>EXTI_PinSource6<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">SYSCFG_EXTILineConfig</span><span class="token punctuation">(</span>EXTI_PortSourceGPIOC<span class="token punctuation">,</span>EXTI_PinSource13<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//4.外部中断配置 GPIOE 4|5|6</span>
	EXTI_InitStruct<span class="token punctuation">.</span>EXTI_Line <span class="token operator">=</span> EXTI_Line4 <span class="token operator">|</span> EXTI_Line5 <span class="token operator">|</span> EXTI_Line6 <span class="token operator">|</span> EXTI_Line13<span class="token punctuation">;</span>	<span class="token comment">//指定中断线</span>
	EXTI_InitStruct<span class="token punctuation">.</span>EXTI_LineCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>					<span class="token comment">//使能</span>
	EXTI_InitStruct<span class="token punctuation">.</span>EXTI_Mode <span class="token operator">=</span> EXTI_Mode_Interrupt<span class="token punctuation">;</span>		<span class="token comment">//模式:中断</span>
	EXTI_InitStruct<span class="token punctuation">.</span>EXTI_Trigger <span class="token operator">=</span> EXTI_Trigger_Falling<span class="token punctuation">;</span>	<span class="token comment">//触发方式:下降沿</span>
	
	<span class="token function">EXTI_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>EXTI_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//5.配置中断 EXTI4_IRQn</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> EXTI4_IRQn<span class="token punctuation">;</span>	<span class="token comment">//使能中断通道:外部中断4</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>	<span class="token comment">//抢占优先级2</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>			<span class="token comment">//响应优先级2</span>
	
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	
	<span class="token comment">//5.配置中断 EXTI9_5_IRQn</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> EXTI9_5_IRQn<span class="token punctuation">;</span>	<span class="token comment">//使能中断通道:外部中断5~9</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//5.配置中断 EXTI15_10_IRQn</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> EXTI15_10_IRQn<span class="token punctuation">;</span>	<span class="token comment">//使能中断通道:外部中断10~15</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*************** 中断服务函数 --------- 需要依赖中断向量表 ***************
1.中断短小精干
2.无参无返回值
3.不能有太多耗时操作,例如延时过高
4.尽量不允许有浮点运算
************************************************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"beep.h"</span></span>
<span class="token keyword">void</span> <span class="token function">EXTI4_IRQHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	BEEP <span class="token operator">=</span> <span class="token operator">!</span>BEEP<span class="token punctuation">;</span><span class="token comment">//让BEEP蜂鸣器反转</span>
	
	<span class="token comment">/*------ 清空中断标志位,给下一次做准备 -------*/</span>
	<span class="token function">EXTI_ClearITPendingBit</span><span class="token punctuation">(</span>EXTI_Line4<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token keyword">void</span> <span class="token function">EXTI9_5_IRQHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//到底是那个中断线</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">EXTI_GetITStatus</span><span class="token punctuation">(</span>EXTI_Line5<span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span>	<span class="token comment">//如果返回SET就是中断线五</span>
	<span class="token punctuation">{<!-- --></span>
		LED1 <span class="token operator">=</span> LED2 <span class="token operator">=</span> LED3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//亮</span>
		<span class="token function">EXTI_ClearITPendingBit</span><span class="token punctuation">(</span>EXTI_Line5<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">EXTI_GetITStatus</span><span class="token punctuation">(</span>EXTI_Line6<span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span>	<span class="token comment">//如果返回SET就是中断线六</span>
	<span class="token punctuation">{<!-- --></span>
		LED1 <span class="token operator">=</span> LED2 <span class="token operator">=</span> LED3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//亮</span>
		<span class="token function">EXTI_ClearITPendingBit</span><span class="token punctuation">(</span>EXTI_Line6<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="5_264"></a>5.串口</h2> 
<p>看对应的时钟总线。<br> <img src="https://images2.imgbox.com/ba/e4/vDipX3RQ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token comment">/****************************************************
函数名:void USART1_Init(u32 bound)
功能:串口1初始化
参数:
	@bound : 波特率 
返回值：无
说明:
	通过原理图查看串口引脚  
		USART1_TX --- PA9		
		USART1_RX --- PA10
*****************************************************/</span>
<span class="token keyword">void</span> <span class="token function">USART1_Init</span><span class="token punctuation">(</span>u32 bound<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.时钟使能  GPIOA -- AHB1 和 USART1 --- APB2</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOA<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_USART1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.GPIO初始化</span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>			<span class="token comment">//模式:复用</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_9<span class="token operator">|</span>GPIO_Pin_10<span class="token punctuation">;</span>	<span class="token comment">//引脚:9|10</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>			<span class="token comment">//类型:推挽</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Fast_Speed<span class="token punctuation">;</span>		<span class="token comment">//速度:50MHz</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd  <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>			<span class="token comment">//状态:上拉</span>
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//3.设置复用功能选择</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> GPIO_PinSource9<span class="token punctuation">,</span> GPIO_AF_USART1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> GPIO_PinSource10<span class="token punctuation">,</span> GPIO_AF_USART1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//4.配置UASRT1 串口</span>
	USART_InitTypeDef USART_InitStruct<span class="token punctuation">;</span>
	
	USART_InitStruct<span class="token punctuation">.</span>USART_BaudRate <span class="token operator">=</span> bound<span class="token punctuation">;</span>		<span class="token comment">//波特率:一般115200</span>
	USART_InitStruct<span class="token punctuation">.</span>USART_HardwareFlowControl <span class="token operator">=</span> USART_HardwareFlowControl_None<span class="token punctuation">;</span>	<span class="token comment">//无流控制</span>
	USART_InitStruct<span class="token punctuation">.</span>USART_Mode <span class="token operator">=</span> USART_Mode_Rx <span class="token operator">|</span> USART_Mode_Tx<span class="token punctuation">;</span>	<span class="token comment">//模式:收|发</span>
	USART_InitStruct<span class="token punctuation">.</span>USART_Parity <span class="token operator">=</span> USART_Parity_No<span class="token punctuation">;</span>				<span class="token comment">//校验位:无校验</span>
	USART_InitStruct<span class="token punctuation">.</span>USART_StopBits <span class="token operator">=</span> USART_StopBits_1<span class="token punctuation">;</span>				<span class="token comment">//停止位:1个</span>
	USART_InitStruct<span class="token punctuation">.</span>USART_WordLength <span class="token operator">=</span> USART_WordLength_8b<span class="token punctuation">;</span>		<span class="token comment">//数据位:8位</span>
	
	<span class="token function">USART_Init</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>USART_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//5.使能定时器</span>
	<span class="token function">USART_Cmd</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//6.开启中断</span>
	<span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//7.配置中断参数</span>
	NVIC_InitTypeDef NVIC_InitStruct<span class="token punctuation">;</span>
	
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> USART1_IRQn<span class="token punctuation">;</span>	<span class="token comment">//通道:USART1 串口</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>	<span class="token comment">//使能</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">//抢占优先级:3</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>			<span class="token comment">//响应优先级:3</span>
	
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//8.编写中断服务函数 ---- 启动文件(中断向量表)</span>
<span class="token comment">/**************************************************************
void USART_SendData(USART_TypeDef* USARTx, uint16_t Data);
uint16_t USART_ReceiveData(USART_TypeDef* USARTx);
***************************************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"beep.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span></span>

u8 buff<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">//缓冲区</span>
u8 buff_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//点前使用到多少个</span>
u8 buff_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//查看数据是否结尾</span>

<span class="token comment">/******* 这个部分是中断直接操作部分 ------ 中断直接操作部分有问题(效率,延时,浮点) *****/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 ret<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span>	<span class="token comment">//如果接收被置1表示有数据可读</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//读取数据</span>
		ret <span class="token operator">=</span> <span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>USART1<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//从RDR读取数据</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>buff_index <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			buff<span class="token punctuation">[</span>buff_index<span class="token punctuation">]</span> <span class="token operator">=</span> ret<span class="token punctuation">;</span>
			
			<span class="token keyword">if</span><span class="token punctuation">(</span>buff<span class="token punctuation">[</span>buff_index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x0d</span> <span class="token operator">&amp;&amp;</span> buff<span class="token punctuation">[</span>buff_index<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0x0a</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				buff<span class="token punctuation">[</span>buff_index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
				buff_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//数据已经结尾</span>
			<span class="token punctuation">}</span>
			buff_index<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			buff_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/********************************************
函数名:int USART1_Read(char *buf,int len,int wait)
功能:提供读取缓存区函数
参数:
	@buf : 保存数据的地址
	@len : 要读取的字节数
	@wait :是否等待数据完成后再读
返回值: 成功读取的字节数
********************************************/</span>
<span class="token keyword">int</span> <span class="token function">USART1_Read</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">,</span><span class="token keyword">int</span> wait<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>buff_flag <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> wait <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">/***** 已经数据结尾 buff_flag == 1  *****/</span>
	len <span class="token operator">=</span> len <span class="token operator">&gt;</span> buff_index <span class="token operator">?</span> buff_index <span class="token operator">:</span>  len<span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>buff<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	buff_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//读取了缓存区数据,则缓存区清空</span>
	<span class="token keyword">return</span> len<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> </span>
<span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 ret<span class="token punctuation">;</span>
	<span class="token comment">//8.1 获取中断状态:有数据可读中断</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span>	<span class="token comment">//如果接收被置1表示有数据可读</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//读取数据</span>
		ret <span class="token operator">=</span> <span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>USART1<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//从RDR读取数据</span>
		<span class="token function">USART_SendData</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>			
	<span class="token punctuation">}</span>
	<span class="token function">USART_ClearITPendingBit</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span>USART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清除中断标志,便于下次中断检测。</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/*********************************************
头文件:#include &lt;stdio.h&gt;  
函数名:int fputc(int ch,FILE *fp)
功能:重定向实现printf调用的打印输出功能
参数:
	@ch : 传入的单字符
	@fp : 流对象
返回值:
	返回:输出的内容
说明:在使用的时候一定要将微库加载打开
*********************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span>FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>		<span class="token comment">//重定向 printf 默认调用 fputc 发送单字符</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> <span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">;</span>	<span class="token comment">//进入循环等待</span>
	<span class="token punctuation">}</span>
	USART1<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> ch<span class="token punctuation">;</span>
	<span class="token keyword">return</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*********************************************
函数名:u8 USART1_Send_Data(u8 *data,u32 len)
功能:发送指定长度数据
参数:
	@data : 数据首地址
	@len  : 数据长度
返回值:
	返回:成功写入的数据长度
*********************************************/</span>
u8 <span class="token function">USART1_Send_Data</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>data<span class="token punctuation">,</span>u32 len<span class="token punctuation">)</span>	<span class="token comment">//相当与系统编程的 write</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>len<span class="token operator">--</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> <span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//进入循环等待</span>
		USART1<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
		data<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> len<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/****************************************************
函数名:void USART2_Init(u32 bound)
功能:串口1初始化
参数:
	@bound : 波特率 
返回值：无
说明:
	通过原理图查看串口引脚  
		USART2_TX --- PD5		
		USART2_RX --- PD6
*****************************************************/</span>
<span class="token keyword">void</span> <span class="token function">USART2_Init</span><span class="token punctuation">(</span>u32 bound<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.时钟使能  GPIOD -- AHB1 和 USART2 --- APB1</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOD<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_USART2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.GPIO初始化</span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>			<span class="token comment">//模式:复用</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_5<span class="token operator">|</span>GPIO_Pin_6<span class="token punctuation">;</span>	<span class="token comment">//引脚:9|10</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>			<span class="token comment">//类型:推挽</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Fast_Speed<span class="token punctuation">;</span>		<span class="token comment">//速度:50MHz</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd  <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>			<span class="token comment">//状态:上拉</span>
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//3.设置复用功能选择</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PinSource5<span class="token punctuation">,</span> GPIO_AF_USART2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PinSource6<span class="token punctuation">,</span> GPIO_AF_USART2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//4.配置UASRT1 串口</span>
	USART_InitTypeDef USART_InitStruct<span class="token punctuation">;</span>
	
	USART_InitStruct<span class="token punctuation">.</span>USART_BaudRate <span class="token operator">=</span> bound<span class="token punctuation">;</span>		<span class="token comment">//波特率:一般115200</span>
	USART_InitStruct<span class="token punctuation">.</span>USART_HardwareFlowControl <span class="token operator">=</span> USART_HardwareFlowControl_None<span class="token punctuation">;</span>	<span class="token comment">//无流控制</span>
	USART_InitStruct<span class="token punctuation">.</span>USART_Mode <span class="token operator">=</span> USART_Mode_Rx <span class="token operator">|</span> USART_Mode_Tx<span class="token punctuation">;</span>	<span class="token comment">//模式:收|发</span>
	USART_InitStruct<span class="token punctuation">.</span>USART_Parity <span class="token operator">=</span> USART_Parity_No<span class="token punctuation">;</span>				<span class="token comment">//校验位:无校验</span>
	USART_InitStruct<span class="token punctuation">.</span>USART_StopBits <span class="token operator">=</span> USART_StopBits_1<span class="token punctuation">;</span>				<span class="token comment">//停止位:1个</span>
	USART_InitStruct<span class="token punctuation">.</span>USART_WordLength <span class="token operator">=</span> USART_WordLength_8b<span class="token punctuation">;</span>		<span class="token comment">//数据位:8位</span>
	
	<span class="token function">USART_Init</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>USART_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//5.使能定时器</span>
	<span class="token function">USART_Cmd</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//6.开启中断</span>
	<span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//7.配置中断参数</span>
	NVIC_InitTypeDef NVIC_InitStruct<span class="token punctuation">;</span>
	
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> USART2_IRQn<span class="token punctuation">;</span>	<span class="token comment">//通道:USART1 串口</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>	<span class="token comment">//使能</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">//抢占优先级:3</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>			<span class="token comment">//响应优先级:3</span>
	
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



u8 USART2_BUFF<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">//缓冲区</span>
u8 USART2_Index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"wifi.h"</span></span>
<span class="token keyword">void</span> <span class="token function">USART2_IRQHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> u8 flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	u8 ret<span class="token punctuation">;</span>
	<span class="token comment">//8.1 获取中断状态:有数据可读中断</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span> USART_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span>	<span class="token comment">//如果接收被置1表示有数据可读</span>
	<span class="token punctuation">{<!-- --></span>
		ret <span class="token operator">=</span> <span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>USART2<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//从RDR读取数据</span>
		<span class="token function">USART_SendData</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0xaa</span><span class="token punctuation">)</span>	<span class="token comment">//接收到开始消息 0xaa</span>
		<span class="token punctuation">{<!-- --></span>
			flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			USART2_Index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//数据下标又从 0 开始</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>	<span class="token comment">//正常接收</span>
		<span class="token punctuation">{<!-- --></span>
			USART2_BUFF<span class="token punctuation">[</span>USART2_Index<span class="token punctuation">]</span> <span class="token operator">=</span> ret<span class="token punctuation">;</span>	<span class="token comment">//写入到缓存区</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0xbb</span><span class="token punctuation">)</span>						<span class="token comment">//接收到结尾消息 0xbb</span>
			<span class="token punctuation">{<!-- --></span>
				WIFI_t wifi<span class="token punctuation">;</span>
				<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wifi<span class="token punctuation">,</span>USART2_BUFF<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>WIFI_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">switch</span><span class="token punctuation">(</span>wifi<span class="token punctuation">.</span>cmd<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">case</span> <span class="token number">0x10</span><span class="token operator">:</span>	BEEP <span class="token operator">=</span> <span class="token operator">!</span>BEEP<span class="token punctuation">;</span>	<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				
				<span class="token comment">/***** 数据处理完之后,清空缓存区 ****/</span>
				<span class="token function">memset</span><span class="token punctuation">(</span>USART2_BUFF<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
			USART2_Index<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//下标增加</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">USART_ClearITPendingBit</span><span class="token punctuation">(</span>USART2<span class="token punctuation">,</span>USART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清除中断标志,便于下次中断检测。</span>
<span class="token punctuation">}</span>

<span class="token comment">/*********************************************
函数名:u8 USART2_Send_Data(u8 *data,u32 len)
功能:发送指定长度数据
参数:
	@data : 数据首地址
	@len  : 数据长度
返回值:
	返回:成功写入的数据长度
*********************************************/</span>
u8 <span class="token function">USART2_Send_Data</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>data<span class="token punctuation">,</span>u32 len<span class="token punctuation">)</span>	<span class="token comment">//相当与系统编程的 write</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>len<span class="token operator">--</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>USART2<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> <span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//进入循环等待</span>
		USART2<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
		data<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> len<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2><a id="6_571"></a>6.独立看门狗</h2> 
<p>注意：独立看门狗的时钟是不精确的，是一个范围值。一定要记得喂狗，不然系统就会一直重启重启重启。<br> 看对应的时钟总线。</p> 
<pre><code class="prism language-c"><span class="token comment">//独立看门狗初始化</span>
<span class="token keyword">void</span> <span class="token function">IWDG_Init</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> Prer<span class="token punctuation">,</span><span class="token class-name">uint16_t</span> rlr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.解除写保护</span>
	<span class="token function">IWDG_WriteAccessCmd</span><span class="token punctuation">(</span>IWDG_WriteAccess_Enable<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.设置预分频系数</span>
	<span class="token function">IWDG_SetPrescaler</span><span class="token punctuation">(</span>Prer<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	
	<span class="token comment">//3.自动重装载值</span>
	<span class="token function">IWDG_SetReload</span><span class="token punctuation">(</span>rlr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//4.重装载计数器</span>
	<span class="token function">IWDG_ReloadCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//5.启动看门狗</span>
	<span class="token function">IWDG_Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//这个一般写在主函数的循环里</span>
	<span class="token function">IWDG_Init</span><span class="token punctuation">(</span> IWDG_Prescaler_128<span class="token punctuation">,</span> <span class="token number">3750</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//记得喂狗，15s左右</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="7_596"></a>7.通用定时器、基本定时器、高级定时器。</h2> 
<p>看对应的时钟总线。</p> 
<pre><code class="prism language-c"><span class="token comment">/********************************************************************************************************************
*函数名:void TIM3_Init(u16 arr,u16 psc)
*功能:TIM3初始化
*参数:
	@arr：自动重装载值
	@psc：分频因子
*其他说明:
	超时时间计算规则:Tout= ((arr+1)*(psc+1))/Tclk
		Tclk：TIM3 的输入时钟频率（单位为 Mhz）。
		Tout：TIM3 溢出时间（单位为 us）。
	案例:
		1.设置超时时间为500毫秒,这里我们一般喜欢设置分频因子为,我们知道TIM3在APB1,默认时钟为42MHz,
		  但是会进行2倍频,则是84MHz,由于计数器无法计数这么高,则分频 8400,则分频因子 psc+1 = 8400
			Tout = ((arr+1)*(psc+1))/Tclk  ， 可以通过反推 arr+1 = Tout / (psc+1) *Tclk
			结果: arr+1 = 500 / 8400 * 84000 , 则 arr = 4999
********************************************************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">TIM3_Init</span><span class="token punctuation">(</span>u16 arr<span class="token punctuation">,</span>u16 psc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.使能定时器时钟</span>
	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_TIM3<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.初始化时钟</span>
	TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStruct<span class="token punctuation">;</span>
	
	TIM_TimeBaseInitStruct<span class="token punctuation">.</span>TIM_ClockDivision <span class="token operator">=</span> TIM_CKD_DIV1<span class="token punctuation">;</span>	<span class="token comment">//分频:1分频	84M</span>
	TIM_TimeBaseInitStruct<span class="token punctuation">.</span>TIM_Prescaler <span class="token operator">=</span> psc<span class="token punctuation">;</span>					<span class="token comment">//分频因子		//例如:8400</span>
	TIM_TimeBaseInitStruct<span class="token punctuation">.</span>TIM_CounterMode <span class="token operator">=</span> TIM_CounterMode_Up<span class="token punctuation">;</span><span class="token comment">//模式:向上</span>
	TIM_TimeBaseInitStruct<span class="token punctuation">.</span>TIM_Period <span class="token operator">=</span> arr<span class="token punctuation">;</span>					<span class="token comment">//重装载</span>
	
	<span class="token function">TIM_TimeBaseInit</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_TimeBaseInitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//3.使能中断：更新中断</span>
	<span class="token function">TIM_ITConfig</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> TIM_IT_Update<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	
	<span class="token comment">//4.配置中断</span>
	NVIC_InitTypeDef NVIC_InitStruct<span class="token punctuation">;</span>
	
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> TIM3_IRQn<span class="token punctuation">;</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	NVIC_InitStruct<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	
	 <span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//5.使能 TIM</span>
	<span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"beep.h"</span></span>
<span class="token keyword">void</span> <span class="token function">TIM3_IRQHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">TIM_GetITStatus</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span>TIM_IT_Update<span class="token punctuation">)</span> <span class="token operator">==</span> SET<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		BEEP <span class="token operator">=</span> <span class="token operator">!</span>BEEP<span class="token punctuation">;</span>	<span class="token comment">//反转</span>
		<span class="token function">TIM_ClearITPendingBit</span><span class="token punctuation">(</span>TIM3<span class="token punctuation">,</span>TIM_IT_Update<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清除更新中断标志</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/********************************************************************************************************************
*函数名:void TIM2_CH3_Init(u16 arr,u16 psc)
*功能:TIM2_CH3通道做PWM
*参数:
	@arr：自动重装载值
	@psc：分频因子
*其他说明:
	超时时间计算规则:Tout= ((arr+1)*(psc+1))/Tclk
		Tclk：TIM2 的输入时钟频率（单位为 Mhz）。
		Tout：TIM2 溢出时间（单位为 us）。
	案例:
		1.设置超时时间为500毫秒,这里我们一般喜欢设置分频因子为,我们知道TIM2在APB1,默认时钟为42MHz,
		  但是会进行2倍频,则是84MHz,由于计数器无法计数这么高,则分频 8400,则分频因子 psc+1 = 8400
			Tout = ((arr+1)*(psc+1))/Tclk  ， 可以通过反推 arr+1 = Tout / (psc+1) *Tclk
			结果: arr+1 = 500 / 8400 * 84000 , 则 arr = 4999
********************************************************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">TIM2_CH3_Init</span><span class="token punctuation">(</span>u16 arr<span class="token punctuation">,</span>u16 psc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.使能时钟总线 TIM2 和 GPIOB</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOB<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB1Periph_TIM2<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.初始化GPIO变为复用模式</span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_10<span class="token punctuation">;</span>			<span class="token comment">//引脚:10</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>		<span class="token comment">//模式复用</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>		<span class="token comment">//类型:推挽</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>		<span class="token comment">//状态:上拉</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_High_Speed<span class="token punctuation">;</span>	<span class="token comment">//速度:100MHz</span>
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//3.将其引脚复用为TIM定时器功能</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PinSource10<span class="token punctuation">,</span> GPIO_AF_TIM2<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//4.初始化定时器基本功能</span>
	TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStruct<span class="token punctuation">;</span>
	
	TIM_TimeBaseInitStruct<span class="token punctuation">.</span>TIM_ClockDivision <span class="token operator">=</span> TIM_CKD_DIV1<span class="token punctuation">;</span>			<span class="token comment">//分频:不分频:1</span>
	TIM_TimeBaseInitStruct<span class="token punctuation">.</span>TIM_CounterMode <span class="token operator">=</span> TIM_CounterMode_Up<span class="token punctuation">;</span>		<span class="token comment">//模式:向上计数</span>
	TIM_TimeBaseInitStruct<span class="token punctuation">.</span>TIM_Period <span class="token operator">=</span> arr<span class="token punctuation">;</span>							<span class="token comment">//重装载计数器</span>
	TIM_TimeBaseInitStruct<span class="token punctuation">.</span>TIM_Prescaler <span class="token operator">=</span> psc<span class="token punctuation">;</span>							<span class="token comment">//分频因子:psc</span>
	
	<span class="token function">TIM_TimeBaseInit</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_TimeBaseInitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//5.设定通道</span>
	TIM_OCInitTypeDef TIM_OCInitStruct<span class="token punctuation">;</span>
	
	TIM_OCInitStruct<span class="token punctuation">.</span>TIM_OCMode <span class="token operator">=</span> TIM_OCMode_PWM1<span class="token punctuation">;</span>				<span class="token comment">//PWM模式:PWM1</span>
	TIM_OCInitStruct<span class="token punctuation">.</span>TIM_OutputState <span class="token operator">=</span> TIM_OutputState_Enable<span class="token punctuation">;</span>	<span class="token comment">//输出状态使能</span>
	TIM_OCInitStruct<span class="token punctuation">.</span>TIM_OCPolarity <span class="token operator">=</span> TIM_OCPolarity_High<span class="token punctuation">;</span>		<span class="token comment">//极性:高电平</span>
	
	<span class="token function">TIM_OC3Init</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_OCInitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//6.使能重装载寄存器,并将影子寄存器值移动</span>
	<span class="token function">TIM_ARRPreloadConfig</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//7.使能定时器</span>
	<span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//8.如果是高级定时器需要设定为主要输出 TIM_CtrlPWMOutputs() 让高级定时器主动输出</span>
<span class="token punctuation">}</span>

<span class="token comment">/********************************************************************************************************************
*函数名:void TIM1_CH1N_Init(u16 arr,u16 psc)
*功能:TIM1_CH1N通道做PWM
*参数:
	@arr：自动重装载值
	@psc：分频因子
*其他说明:
	超时时间计算规则:Tout= ((arr+1)*(psc+1))/Tclk
		Tclk：TIM1 的输入时钟频率（单位为 Mhz）。
		Tout：TIM1 溢出时间（单位为 us）。
	案例:
		1.设置超时时间为500毫秒,这里我们一般喜欢设置分频因子为,我们知道TIM2在APB1,默认时钟为42MHz,
		  但是会进行2倍频,则是84MHz,由于计数器无法计数这么高,则分频 8400,则分频因子 psc+1 = 8400
			Tout = ((arr+1)*(psc+1))/Tclk  ， 可以通过反推 arr+1 = Tout / (psc+1) *Tclk
			结果: arr+1 = 500 / 8400 * 84000 , 则 arr = 4999
通过原理图发现
	LED1 ---- PE8 ----&gt; TIM1_CH1N 互补
********************************************************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">TIM1_CH1N_Init</span><span class="token punctuation">(</span>u16 arr<span class="token punctuation">,</span>u16 psc<span class="token punctuation">)</span>	
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.定时器总线使能 和 GPIOE 总线使能</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOE<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_TIM1<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.初始化GPIOE 8变为复用模式</span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_8 <span class="token operator">|</span> GPIO_Pin_9<span class="token punctuation">;</span>			<span class="token comment">//引脚:8</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>		<span class="token comment">//模式复用</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>		<span class="token comment">//类型:推挽</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>		<span class="token comment">//状态:上拉</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_High_Speed<span class="token punctuation">;</span>	<span class="token comment">//速度:100MHz</span>
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//3.将其引脚复用为TIM定时器功能</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span> GPIO_PinSource8<span class="token punctuation">,</span> GPIO_AF_TIM1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOE<span class="token punctuation">,</span> GPIO_PinSource9<span class="token punctuation">,</span> GPIO_AF_TIM1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//4.初始化定时器基本功能</span>
	TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStruct<span class="token punctuation">;</span>
	
	TIM_TimeBaseInitStruct<span class="token punctuation">.</span>TIM_ClockDivision <span class="token operator">=</span> TIM_CKD_DIV1<span class="token punctuation">;</span>			<span class="token comment">//分频:不分频:1</span>
	TIM_TimeBaseInitStruct<span class="token punctuation">.</span>TIM_CounterMode <span class="token operator">=</span> TIM_CounterMode_Up<span class="token punctuation">;</span>		<span class="token comment">//模式:向上计数</span>
	TIM_TimeBaseInitStruct<span class="token punctuation">.</span>TIM_Period <span class="token operator">=</span> arr<span class="token punctuation">;</span>							<span class="token comment">//重装载计数器</span>
	TIM_TimeBaseInitStruct<span class="token punctuation">.</span>TIM_Prescaler <span class="token operator">=</span> psc<span class="token punctuation">;</span>							<span class="token comment">//分频因子:psc</span>
	TIM_TimeBaseInitStruct<span class="token punctuation">.</span>TIM_RepetitionCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token function">TIM_TimeBaseInit</span><span class="token punctuation">(</span>TIM1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_TimeBaseInitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//5.设定通道</span>
	TIM_OCInitTypeDef TIM_OCInitStruct<span class="token punctuation">;</span>
	
	TIM_OCInitStruct<span class="token punctuation">.</span>TIM_OCMode <span class="token operator">=</span> TIM_OCMode_PWM1<span class="token punctuation">;</span>				<span class="token comment">//PWM模式:PWM1</span>
	TIM_OCInitStruct<span class="token punctuation">.</span>TIM_OutputNState <span class="token operator">=</span> TIM_OutputNState_Enable<span class="token punctuation">;</span>	<span class="token comment">//输出状态使能</span>
	TIM_OCInitStruct<span class="token punctuation">.</span>TIM_OCNPolarity <span class="token operator">=</span> TIM_OCNPolarity_Low<span class="token punctuation">;</span>		<span class="token comment">//互补极性:低电平</span>
	TIM_OCInitStruct<span class="token punctuation">.</span>TIM_OCNIdleState <span class="token operator">=</span> TIM_OCNIdleState_Set<span class="token punctuation">;</span>	
	
	TIM_OCInitStruct<span class="token punctuation">.</span>TIM_OutputState <span class="token operator">=</span> TIM_OutputState_Enable<span class="token punctuation">;</span>	<span class="token comment">//输出状态使能</span>
	TIM_OCInitStruct<span class="token punctuation">.</span>TIM_OCIdleState <span class="token operator">=</span> TIM_OCPolarity_High<span class="token punctuation">;</span>		<span class="token comment">//互补极性:高电平</span>
	TIM_OCInitStruct<span class="token punctuation">.</span>TIM_OCNPolarity <span class="token operator">=</span> TIM_OCIdleState_Set<span class="token punctuation">;</span>

	
	<span class="token function">TIM_OC1Init</span><span class="token punctuation">(</span>TIM1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TIM_OCInitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">TIM_OC1PreloadConfig</span><span class="token punctuation">(</span>TIM1<span class="token punctuation">,</span>TIM_OCPreload_Enable<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能外设</span>
	<span class="token comment">//6.使能重装载寄存器,并将影子寄存器值移动</span>
	<span class="token function">TIM_ARRPreloadConfig</span><span class="token punctuation">(</span>TIM1<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//7.使能定时器</span>
	<span class="token function">TIM_Cmd</span><span class="token punctuation">(</span>TIM1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//8.如果是高级定时器需要设定为主要输出 TIM_CtrlPWMOutputs() 让高级定时器主动输出</span>
	<span class="token function">TIM_CtrlPWMOutputs</span><span class="token punctuation">(</span>TIM1<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>  <span class="token comment">//高级定时器一定要注意互补输出的参数是否带N，否则会产生其他问题</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint16_t</span> TIM_OCMode<span class="token punctuation">;</span>        <span class="token comment">/*!&lt; 指定 TIM 模式。
                                   This parameter can be a value of @ref TIM_Output_Compare_and_PWM_modes */</span>

  <span class="token class-name">uint16_t</span> TIM_OutputState<span class="token punctuation">;</span>   <span class="token comment">/*!&lt; 指定 TIM 输出比较状态。
                                   This parameter can be a value of @ref TIM_Output_Compare_State */</span>

  <span class="token class-name">uint16_t</span> TIM_OutputNState<span class="token punctuation">;</span>  <span class="token comment">/*!&lt; 指定 TIM 互补输出比较状态。
                                   This parameter can be a value of @ref TIM_Output_Compare_N_State
                                   @note This parameter is valid only for TIM1 and TIM8. */</span>

  <span class="token class-name">uint32_t</span> TIM_Pulse<span class="token punctuation">;</span>         <span class="token comment">/*!&lt; 指定要加载到捕获/比较寄存器的脉冲值。
                                   This parameter can be a number between 0x0000 and 0xFFFF */</span>

  <span class="token class-name">uint16_t</span> TIM_OCPolarity<span class="token punctuation">;</span>    <span class="token comment">/*!&lt; 指定输出极性。
                                   This parameter can be a value of @ref TIM_Output_Compare_Polarity */</span>

  <span class="token class-name">uint16_t</span> TIM_OCNPolarity<span class="token punctuation">;</span>   <span class="token comment">/*!&lt; 指定互补输出极性。
                                   This parameter can be a value of @ref TIM_Output_Compare_N_Polarity
                                   @note This parameter is valid only for TIM1 and TIM8. */</span>

  <span class="token class-name">uint16_t</span> TIM_OCIdleState<span class="token punctuation">;</span>   <span class="token comment">/*!&lt; 指定空闲状态下的 TIM 输出比较引脚状态。
                                   This parameter can be a value of @ref TIM_Output_Compare_Idle_State
                                   @note This parameter is valid only for TIM1 and TIM8. */</span>

  <span class="token class-name">uint16_t</span> TIM_OCNIdleState<span class="token punctuation">;</span>  <span class="token comment">/*!&lt; 指定空闲状态下的 TIM 输出比较引脚状态。
                                   This parameter can be a value of @ref TIM_Output_Compare_N_Idle_State
                                   @note This parameter is valid only for TIM1 and TIM8. */</span>
<span class="token punctuation">}</span> TIM_OCInitTypeDef1<span class="token punctuation">;</span>
</code></pre> 
<h2><a id="8DHT11_828"></a>8.DHT11温湿度传感器</h2> 
<p><img src="https://images2.imgbox.com/db/25/R8Oz7Uhx_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1f/ac/yXLvRDYR_o.png" alt="在这里插入图片描述"><br> 一定要按照时序图来看，不然读取到的数据就是错误的。</p> 
<pre><code class="prism language-c"><span class="token comment">/***************************************
函数名:void DHT11_Init(void)
功能:DHT11初始化
参数:无
***************************************/</span>
<span class="token keyword">void</span> <span class="token function">DHT11_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.使能 GPIOA 时钟总线</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOA<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.初始化GPIOA 3</span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_OUT<span class="token punctuation">;</span>	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_3<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_High_Speed<span class="token punctuation">;</span>
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/***************************************
由于是单总线协议,我们既需要发送 | 接收
所以,我们制作两个宏,用于设置 输出 | 输入模式
****************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DHT11_Init_IN</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>  GPIOA<span class="token operator">-&gt;</span>MODER <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span>		</span><span class="token comment">//设置为输入模式</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DHT11_Init_OUT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> GPIOA<span class="token operator">-&gt;</span>MODER <span class="token operator">|=</span> <span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span>			</span><span class="token comment">//设置为输出模式</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DHT11_OUT</span> <span class="token expression"><span class="token function">PAout</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>	</span><span class="token comment">//用于电平输出</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DHT11_IN</span>  <span class="token expression"><span class="token function">PAin</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>	</span><span class="token comment">//用于电平读取</span></span>

<span class="token comment">/***************************************
函数名:void DHT11_Reset(void)
功能:DHT11 复位信号
参数:无
***************************************/</span>
<span class="token keyword">void</span> <span class="token function">DHT11_Reset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">DHT11_Init_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置引脚为输出模式</span>
	DHT11_OUT <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//将电平拉低</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//拉低至少18ms秒,我们选择 20毫秒</span>
	
	DHT11_OUT <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">//将电平拉高</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//拉高范围 20us 到 40us 秒,我们选择折中方式 30us</span>
<span class="token punctuation">}</span>

<span class="token comment">/***************************************
函数名:
功能:DHT11 响应信号检测
参数:无
返回值:
	响应:0   ---- 存在
	不响应:-1  ---- 不存在
***************************************/</span>
<span class="token keyword">int</span> <span class="token function">DHT11_Check</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> timer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//用于计时</span>
	
	<span class="token function">DHT11_Init_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将引脚设置为输入模式</span>
	
	timer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>DHT11_IN <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>			<span class="token comment">//检测DHT11设备电平由高拉低</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//用于计时延时</span>
		timer<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>timer <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//用于异常检测</span>
	<span class="token punctuation">}</span>
	
	timer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>DHT11_IN <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>			<span class="token comment">//检测DHT11设备电平由低拉高</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//用于计时延时</span>
		timer<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>timer <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//用于异常检测</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//存在</span>
<span class="token punctuation">}</span>


<span class="token comment">/***************************************
函数名:u8 DHT11_Read_Bit(void)
功能:DHT11 读取1bit数据
参数:无
返回值: 比特值
	1 : 高电平
	0 : 低电平
***************************************/</span>
u8 <span class="token function">DHT11_Read_Bit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> timer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//用于计时</span>
	
	<span class="token keyword">while</span><span class="token punctuation">(</span>DHT11_IN <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		timer<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>timer <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//延时80微秒</span>
	<span class="token keyword">return</span> DHT11_IN<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/***************************************
函数名:u8 DHT11_Read_Byte(void)
功能:DHT11 读取1字节数据
参数:无
返回值: 数值
说明:高位先出,先存储到高位
例如:10101000
接收:
	每次读取则左移
***************************************/</span>
u8 <span class="token function">DHT11_Read_Byte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>			<span class="token comment">//先左移</span>
		data <span class="token operator">|=</span> <span class="token function">DHT11_Read_Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">return</span> data<span class="token punctuation">;</span>	<span class="token comment">//返回数据</span>
<span class="token punctuation">}</span>



<span class="token comment">/******************************************************************************
函数名:u8 DHT11_Read_Data(u8 *HumiH,u8 *HumiL,u8 *TempH,u8 *TempL)
参数:
	@HumiH:湿度高位
	@HumiL:湿度低位
	@TempH:温度高位
	@TempL:温度低位
返回值:
	成功:0
	失败:1
*******************************************************************************/</span>
u8 <span class="token function">DHT11_Read_Data</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>HumiH<span class="token punctuation">,</span>u8 <span class="token operator">*</span>HumiL<span class="token punctuation">,</span>u8 <span class="token operator">*</span>TempH<span class="token punctuation">,</span>u8 <span class="token operator">*</span>TempL<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">DHT11_Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//复位</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DHT11_Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>	<span class="token comment">//检查DHT11设备存在,则开始读取数据</span>
	<span class="token punctuation">{<!-- --></span>
		u8 Data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			Data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">DHT11_Read_Byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//知道 Data[0] == 湿度高位 , Data[1] == 湿度低位 .... Data[4]  == 校验和</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>Data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> Data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> Data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> Data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> Data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>	<span class="token comment">//进行校验和</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token operator">*</span>HumiH <span class="token operator">=</span> Data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token operator">*</span>HumiL <span class="token operator">=</span> Data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token operator">*</span>TempH <span class="token operator">=</span> Data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token operator">*</span>TempL <span class="token operator">=</span> Data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="9IIC_996"></a>9.IIC时序</h2> 
<p>一定要按照时序图来看</p> 
<pre><code class="prism language-c"><span class="token comment">/*************************************
定义一些比较好用的宏
*************************************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_SCL</span> <span class="token expression"><span class="token function">PBout</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>	</span><span class="token comment">//时钟线输出</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_SDA</span> <span class="token expression"><span class="token function">PBout</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>	</span><span class="token comment">//数据线输出</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">READ_SDA</span> <span class="token expression"><span class="token function">PBin</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>	</span><span class="token comment">//数据线输入</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">I2C_IN</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>	GPIOB<span class="token operator">-&gt;</span>MODER <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span>		</span><span class="token comment">//设置数据线为输入模式</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">I2C_OUT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>	GPIOB<span class="token operator">-&gt;</span>MODER <span class="token operator">|=</span>  <span class="token punctuation">(</span><span class="token number">0x1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span>		</span><span class="token comment">//设置数据线为输出模式</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">I2C_DELAY</span> <span class="token expression"><span class="token number">2</span>		</span><span class="token comment">//延时值,进行错误微调,如果错误,请修改他的取值即可。</span></span>
<span class="token comment">/**************************************
函数名:void IIC_Init(void)
功能:IIC总线初始化
参数:无
返回值:无
说明:
	.通过原理图 发现 
			I2C_SCL1 使用的是 PB6
			I2C_SDA1 使用的是 PB7
***************************************/</span>
<span class="token keyword">void</span> <span class="token function">IIC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.是能 GPIOB 时钟总线</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOB<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.初始化GPIOE6 和 7</span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_6 <span class="token operator">|</span> GPIO_Pin_7<span class="token punctuation">;</span>	<span class="token comment">//引脚:6|7</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_OUT<span class="token punctuation">;</span>			<span class="token comment">//模式:输出模式</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>			<span class="token comment">//状态:上拉</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_OD<span class="token punctuation">;</span>			<span class="token comment">//类型:开漏</span>
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//3.设置电平状态</span>
	I2C_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	I2C_SDA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*************************************
函数名:void IIC_Start(void)
功能:IIC 起始信号
参数:无
返回值:无
*************************************/</span>
<span class="token keyword">void</span> <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">I2C_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将数据线变为输出模式</span>
	<span class="token comment">/*--------- 开始:都是高电平 ----------------*/</span>
	I2C_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	I2C_SDA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">/*--------- 维持 4.7 us 时间 ---------------*/</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/*--------- 后数据线拉低 --------*/</span>
	I2C_SDA <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">/*--------- 维持 4 us 时间 ---------------*/</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/*--------- 时钟线随后也被拉低 ------------*/</span>
	I2C_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*************************************
函数名:void IIC_Stop(void)
功能:IIC 停止信号
参数:无
返回值:无
*************************************/</span>
<span class="token keyword">void</span> <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">I2C_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将数据线变为输出模式</span>
	<span class="token comment">/*--------- 开始:都是低电平 -------*/</span>
	I2C_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	I2C_SDA <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token comment">/*--------- 低电平延时 跳变------------*/</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	I2C_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	
	<span class="token comment">/*--------- 低电平延时------------*/</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	I2C_SDA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">/*--------- 高电平延时------------*/</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/******* 进入总线空闲状态 *********/</span>
<span class="token punctuation">}</span>

<span class="token comment">/*************************************
函数名:void IIC_Ack(void)
功能:IIC 主机产生应答信号
参数:无
返回值:无
*************************************/</span>
<span class="token keyword">void</span> <span class="token function">IIC_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	I2C_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//时钟线低电平</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">I2C_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将数据线变为输出模式</span>
	<span class="token comment">/*------- 输出 低电平 0 -------- */</span>
	I2C_SDA <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//数据线</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*------- 准备好数据,将时钟线电平拉高发送 ------*/</span>
	I2C_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">/*--------- 高电平延时------------*/</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*-------- 数据已经发完,将时钟线拉低 ---------*/</span>
	I2C_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">/*************************************
函数名:void IIC_NAck(void)
功能:IIC 主机产生非应答信号
参数:无
返回值:无
*************************************/</span>
<span class="token keyword">void</span> <span class="token function">IIC_NAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">I2C_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将数据线变为输出模式</span>
	
	I2C_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//时钟线低电平</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*------- 输出 高电平 1 -------- */</span>
	I2C_SDA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//数据线</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*------- 准备好数据,将时钟线电平拉高发送 ------*/</span>
	I2C_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">/*--------- 高电平延时------------*/</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*-------- 数据已经发完,将时钟线拉低 ---------*/</span>
	I2C_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**************************************
函数名:void IIC_Wait_Ack(void)
功能:IIC 主机等待从机应答
参数:无
返回值:
	成功:0
	失败: -1
**************************************/</span>
<span class="token keyword">int</span> <span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> timer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">/*----- 先将我的数据线和时钟线都拉高,用于等待应答 ------*/</span>
	I2C_SDA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//数据线拉高</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	I2C_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//时钟线拉高</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*----- 等待数据线是否拉低 -------*/</span>
	<span class="token function">I2C_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将模式变为输入模式</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>READ_SDA <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>	<span class="token comment">//如果还是高电平,我就一直等</span>
	<span class="token punctuation">{<!-- --></span>
		timer<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>timer <span class="token operator">&gt;</span> <span class="token number">250</span><span class="token punctuation">)</span>	<span class="token comment">//超时了,我要将我变为空闲状态,不占用总线</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发出停止信号</span>
			<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">//没有应答</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
	I2C_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">/*---- 同学们,在这里加入一个延时就可以了 -----*/</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//应答了</span>
<span class="token punctuation">}</span>


<span class="token comment">/**************************************
函数名:void IIC_Send_Byte(u8 data)
功能:IIC 发送1字节 8Bit 数据
参数:无
返回值:无
**************************************/</span>
<span class="token keyword">void</span> <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>u8 data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">I2C_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将数据线变为输出模式</span>
	<span class="token comment">/***** 将时钟线拉低,准备开始写 *****/</span>
	I2C_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token comment">/***** 循环将 8为数据给发送出去:先传送最高位  ****/</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		I2C_SDA <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">7</span><span class="token punctuation">;</span>
		data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token comment">/**** 等待将数据写入到引脚 ****/</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/**** 将时钟线拉高,表示数据稳定，正在发送数据 ***/</span>
		I2C_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		
		<span class="token comment">/**** 需要等待 从机读取(读取需要一定时间) ****/</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">/***** 从机取走数据之后,将始终线拉低,继续向从机写入数据 *****/</span>
		I2C_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token comment">/**************************************
函数名:u8 IIC_Read_Byte(void)
功能:IIC 读取1字节 8Bit 数据
参数:无
返回值:数据
**************************************/</span>
u8 <span class="token function">IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//用于存数据</span>
	
	<span class="token function">I2C_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置数据线为输入模式</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		I2C_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		
		I2C_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//准备接收数据</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span>I2C_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		data <span class="token operator">+=</span> READ_SDA<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="10EEPROMAT24C02_1229"></a>10.用EEPROM（AT24C02）存储数据，防止数据掉电丢失</h2> 
<p>一定要按照时序图来看<br> <img src="https://images2.imgbox.com/cc/1d/DsK3CbuJ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">AT24C02C_Write_Byte</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> wr_addr<span class="token punctuation">,</span><span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//起始信号</span>
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>AT24C02C<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送器件地址,0写入数据</span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//等待应答</span>
	
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>wr_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//等待应答</span>
	
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//写入数据</span>
	<span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//停止信号</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">AT24C02C_Write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> wr_addr<span class="token punctuation">,</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token class-name">uint8_t</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//起始信号</span>
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>AT24C02C<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送器件地址,0写入数据</span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//等待应答</span>
	
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>wr_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//等待应答</span>
	
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span>  i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>	<span class="token comment">//循环发送数据</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//写入数据</span>
		<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//等待应答</span>
    <span class="token punctuation">}</span>
	<span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//停止信号</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">AT24C02C_Read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> wr_addr<span class="token punctuation">,</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token class-name">uint8_t</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//起始信号</span>
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>AT24C02C<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送器件地址,0写入数据</span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//等待应答</span>
	
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>wr_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发送器件地址,0写入数据</span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//等待应答</span>

	<span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//起始信号</span>
	<span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>AT24C02C<span class="token operator">+</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送器件地址,1读入数据</span>
	<span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//等待应答</span>
	
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">!=</span> len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token function">IIC_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//应答</span>
		wr_addr<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="11OLED_1287"></a>11.OLED显示屏</h2> 
<p>本次使用的OLED是8行*128列的点阵<br> <img src="https://images2.imgbox.com/dd/7a/FXXPwYu7_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="12WiFiESP8266AT_1291"></a>12.WiFi（ESP8266），AT指令操作</h2> 
<pre><code class="prism language-c"><span class="token comment">/***************************************
函数名:void WIFI_Set_Mode(int mode)
功能:配置 WIFI 模式
参数:
	@mode : 配置WIFI模式
		1:STA 模式可开热点
		2:AP  可连路由
		3.STA + AP模式
返回值:
说明:参数一般默认填写3
****************************************/</span>
<span class="token keyword">void</span> <span class="token function">WIFI_Set_Mode</span><span class="token punctuation">(</span><span class="token keyword">int</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"AT+CWMODE=%d\r\n"</span><span class="token punctuation">,</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">USART2_Send_Data</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**********************************************************
函数名:void WIFI_Connect(char *user,char *pass)
功能:配置 WIFI 连接路由
参数:
	@user : WIFI名称
	@pass : WIFI密码
返回值:
说明:
	后期验证,可以使用 "WIFI CONNECTED" 返回值作为判断条件
***********************************************************/</span>
<span class="token keyword">void</span> <span class="token function">WIFI_Connect</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>user<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>pass<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"AT+CWJAP=\"%s\",\"%s\"\r\n"</span><span class="token punctuation">,</span>user<span class="token punctuation">,</span>pass<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">USART2_Send_Data</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">12000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//基础功能跑一波 ---- 后续再优化</span>
<span class="token punctuation">}</span>

<span class="token comment">/**********************************************************
函数名:void WIFI_Connect_TCP(char *IP,int port)
功能:配置 WIFI 连接路由
参数:
	@IP   : TCP服务器IP地址
	@port : TCP服务器端口号
返回值:
说明:
	后期验证,可以使用 "WIFI CONNECTED" 返回值作为判断条件
***********************************************************/</span>
<span class="token keyword">void</span> <span class="token function">WIFI_Connect_TCP</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>IP<span class="token punctuation">,</span><span class="token keyword">int</span> port<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"AT+CIPSTART=\"TCP\",\"%s\",%d\r\n"</span><span class="token punctuation">,</span>IP<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">USART2_Send_Data</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//基础功能跑一波 ---- 后续再优化</span>
<span class="token punctuation">}</span>

<span class="token comment">/**********************************************************
函数名:void WIFI_Connect_TCP(char *IP,int port)
功能:配置 WIFI 连接路由
参数:
	@IP   : TCP服务器IP地址
	@port : TCP服务器端口号
返回值:
说明:
	后期验证,可以使用 "WIFI CONNECTED" 返回值作为判断条件
***********************************************************/</span>
<span class="token keyword">void</span> <span class="token function">WIFI_Send_Data</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span><span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
	<span class="token function">sprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"AT+CIPSEND=%d\r\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">USART2_Send_Data</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//基础功能跑一波 ---- 后续再优化</span>
	
	<span class="token function">USART2_Send_Data</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//基础功能跑一波 ---- 后续再优化</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2><a id="13SPI_1372"></a>13.SPI</h2> 
<pre><code class="prism language-c"><span class="token comment">/*******************************************************************
函数名:void SPI1_Init(void)
功能:SPI1总线初始化
参数:无
返回值:无
说明：
	.通过原理图 发现 
	SCK 时钟线 ----- PB3
	MISO接收线 ----- PB4
	MOSI发送线 ----- PB5
	编写初始化(时钟总线,设置IO复用SPI,配置SPI,使能SPI)
*******************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">SPI1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.时钟总线 GPIOB 和 SPI1 </span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOB<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_SPI1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.配置GPIO为复用模式</span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_3 <span class="token operator">|</span> GPIO_Pin_4 <span class="token operator">|</span> GPIO_Pin_5<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Fast_Speed<span class="token punctuation">;</span>
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//3.将其GPIO复用为 SPI 功能</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PinSource3<span class="token punctuation">,</span> GPIO_AF_SPI1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PinSource4<span class="token punctuation">,</span> GPIO_AF_SPI1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">GPIO_PinAFConfig</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PinSource5<span class="token punctuation">,</span> GPIO_AF_SPI1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//4.配置 SPI 参数</span>
	SPI_InitTypeDef SPI_InitStruct<span class="token punctuation">;</span>
	
	SPI_InitStruct<span class="token punctuation">.</span>SPI_BaudRatePrescaler <span class="token operator">=</span> SPI_BaudRatePrescaler_32<span class="token punctuation">;</span>	<span class="token comment">//时钟分频:32分频一般设备都在 20MHz以内</span>
	SPI_InitStruct<span class="token punctuation">.</span>SPI_CPHA <span class="token operator">=</span> SPI_CPHA_1Edge<span class="token punctuation">;</span>							<span class="token comment">//极性:0,第一个时钟边沿采集</span>
	SPI_InitStruct<span class="token punctuation">.</span>SPI_CPOL <span class="token operator">=</span> SPI_CPOL_Low<span class="token punctuation">;</span>								<span class="token comment">//相位:0,低电平时钟</span>
	SPI_InitStruct<span class="token punctuation">.</span>SPI_DataSize <span class="token operator">=</span> SPI_DataSize_8b<span class="token punctuation">;</span>						<span class="token comment">//数据位:8位</span>
	SPI_InitStruct<span class="token punctuation">.</span>SPI_Mode <span class="token operator">=</span> SPI_Mode_Master<span class="token punctuation">;</span>							<span class="token comment">//模式:主机模式</span>
	SPI_InitStruct<span class="token punctuation">.</span>SPI_Direction <span class="token operator">=</span> SPI_Direction_2Lines_FullDuplex<span class="token punctuation">;</span>		<span class="token comment">//模式:全双工</span>
	SPI_InitStruct<span class="token punctuation">.</span>SPI_FirstBit <span class="token operator">=</span> SPI_FirstBit_MSB<span class="token punctuation">;</span>						<span class="token comment">//先发:高位先发</span>
	SPI_InitStruct<span class="token punctuation">.</span>SPI_NSS <span class="token operator">=</span> SPI_NSS_Soft<span class="token punctuation">;</span>								<span class="token comment">//片选信号:软件触发</span>
	SPI_InitStruct<span class="token punctuation">.</span>SPI_CRCPolynomial <span class="token operator">=</span> <span class="token number">0x02</span><span class="token punctuation">;</span>							<span class="token comment">//CRC校验码:多项式计算</span>
	
	<span class="token function">SPI_Init</span><span class="token punctuation">(</span>SPI1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SPI_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//5.使能 SPI1 </span>
	<span class="token function">SPI_Cmd</span><span class="token punctuation">(</span>SPI1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*******************************************************************
函数名:u8 SPI1_Write_Read(u8 data)
功能:SPI1总线收发函数
参数:	
	@data:数据
返回值:
	u8 类型结果
说明：
	外设读写操作时同步完成.
	1. 只发送数据则忽略返回值
	2. 只接主机发送空字节 0x00 即可
*******************************************************************/</span>
u8 <span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span>u8 data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.判断 SPI1 是否为发送空闲</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">SPI_I2S_GetFlagStatus</span><span class="token punctuation">(</span>SPI1<span class="token punctuation">,</span> SPI_I2S_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">;</span>	<span class="token comment">//RESET 非空闲,则循环等待</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//2.发送数据</span>
	<span class="token function">SPI_I2S_SendData</span><span class="token punctuation">(</span>SPI1<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//3.判断 SPI1 是否为有数据接收</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">SPI_I2S_GetFlagStatus</span><span class="token punctuation">(</span>SPI1<span class="token punctuation">,</span> SPI_I2S_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">;</span>	<span class="token comment">//RESET 数据为空,则循环等待</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//4.接收数据</span>
	<span class="token keyword">return</span> <span class="token function">SPI_I2S_ReceiveData</span><span class="token punctuation">(</span>SPI1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="14W25Q64flash_1461"></a>14.W25Q64（flash）</h2> 
<p>这里我们用的是W25Q64，其实都差不多。<br> <img src="https://images2.imgbox.com/0c/4f/ChWb8uwE_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token comment">/****************************************
说明:
	.通过原理图 发现  w25q64 片选 CS 
	SCK 时钟线 ----- PB3
	MISO接收线 ----- PB4
	MOSI发送线 ----- PB5
	CS  片选线 ----- PB2 ---- 该引脚操作
****************************************/</span>
<span class="token keyword">void</span> <span class="token function">W25Q64_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.时钟总线使能 GPIOB</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOB<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//2.配置GPIO</span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_OUT<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span> GPIO_OType_PP<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_2<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_UP<span class="token punctuation">;</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Fast_Speed<span class="token punctuation">;</span>
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//3.将引脚设置为高电平,非片选</span>
	W25Q64 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/****************************************
功能: 写使能 = 0x06
****************************************/</span>
<span class="token keyword">void</span> <span class="token function">W25Q64_Write_Ebale</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	W25Q64 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//片选拉低 </span>
	
	<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span><span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	W25Q64 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//片选拉高</span>
<span class="token punctuation">}</span>

<span class="token comment">/***************************************
功能:检测W25Q64是否忙碌
***************************************/</span>
<span class="token keyword">void</span> <span class="token function">W25Q64_Check_Busy</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">do</span>
	<span class="token punctuation">{<!-- --></span>
		W25Q64 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//片选拉低 </span>
		<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span><span class="token number">0x05</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		flag <span class="token operator">=</span> <span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//读取w25q64度状态寄存器</span>
		
		W25Q64 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//片选拉高</span>
	<span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/***************************************
功能:扇区擦除(4k) = 0x20
***************************************/</span>
<span class="token keyword">void</span> <span class="token function">W25Q64_Erasr</span><span class="token punctuation">(</span>u32 addr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">W25Q64_Write_Ebale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使能</span>
	W25Q64 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//片选拉低 </span>
	
	<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//扇区擦除</span>
	
	<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送高位 23 - 16 位</span>
	<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送高位 16 - 8 位</span>
	<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送低8位</span>
	
	W25Q64 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 			<span class="token comment">//片选拉高</span>
	<span class="token function">W25Q64_Check_Busy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/***************************************
函数:int W25Q64_Write_Data(u32 addr,u8 *data,u8 len)
功能:发送数据 = 0x02
参数：
	@addr：要写入到的地址
	@data：数据
	@len：数据长度
返回值:
	成功写入的长度
****************************************/</span>
<span class="token keyword">int</span> <span class="token function">W25Q64_Write_Data</span><span class="token punctuation">(</span>u32 addr<span class="token punctuation">,</span>u8 <span class="token operator">*</span>data<span class="token punctuation">,</span>u8 len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">W25Q64_Write_Ebale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//1.写使能</span>
	W25Q64 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//片选拉低 </span>
	
	<span class="token comment">/***** 1.发送命令 *****/</span>
	<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span><span class="token number">0x02</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/***** 2.发送地址 *****/</span>
	<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送高位 23 - 16 位</span>
	<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发送高位 16 - 8 位</span>
	<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发送低8位</span>
	
	<span class="token comment">/***** 3.发送数据 *****/</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送数据</span>
	<span class="token punctuation">}</span>
	
	W25Q64 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//片选拉高</span>
	<span class="token function">W25Q64_Check_Busy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> len<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/***************************************
函数:int W25Q64_Read_Data(u32 addr,u8 *data,u8 len)
功能:接收数据 = 0x03
参数：
	@addr：要读取内存地址
	@data：数据
	@len：数据长度
返回值:
	成功读取的长度
****************************************/</span>
<span class="token keyword">int</span> <span class="token function">W25Q64_Read_Data</span><span class="token punctuation">(</span>u32 addr<span class="token punctuation">,</span>u8 <span class="token operator">*</span>data<span class="token punctuation">,</span>u8 len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">W25Q64_Write_Ebale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//1.写使能</span>
	W25Q64 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//片选拉低</span>
	
	<span class="token comment">/***** 1.发送命令 *****/</span>
	<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*****2.发送地址 ****/</span>
	<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//发送高位 23 - 16 位</span>
	<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发送高位 16 - 8 位</span>
	<span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span>addr <span class="token operator">&gt;&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//发送低8位</span>
	
	<span class="token comment">/*****3.读取数据 0x00 发送空数据 ****/</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">SPI1_Write_Read</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//空指令</span>
	<span class="token punctuation">}</span>
	
	W25Q64 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//片选拉高</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="15ADC_1608"></a>15.ADC初始化</h2> 
<p><img src="https://images2.imgbox.com/92/e0/ekoXftyD_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/21/91/Yqa3u9R1_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token comment">/***************************************
函数名：void ADC1_Init(void)
功能:ADC1初始化
参数：无
返回值:无
****************************************/</span>
<span class="token keyword">void</span> <span class="token function">ADC1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1.使能时钟 ADC1 时钟总线</span>
    <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_ADC1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//2.配置ADC公共设置</span>
    ADC_CommonInitTypeDef ADC_CommonInitStruct<span class="token punctuation">;</span>		<span class="token comment">//ADC 公共配置结构体</span>

    <span class="token function">ADC_CommonStructInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC_CommonInitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使用ADC默认配置   </span>
    <span class="token comment">//ADC_CommonInitStruct-&gt;ADC_Mode = ADC_Mode_Independent;				      //独立模式</span>
    <span class="token comment">//ADC_CommonInitStruct-&gt;ADC_Prescaler = ADC_Prescaler_Div2;	 //分频模式 2 分频:84 / 2 = 42MHz &gt; 36MHz</span>
    <span class="token comment">//ADC_CommonInitStruct-&gt;ADC_DMAAccessMode = ADC_DMAAccessMode_Disabled;		  //DMA模式:失能</span>
    <span class="token comment">//ADC_CommonInitStruct-&gt;ADC_TwoSamplingDelay = ADC_TwoSamplingDelay_5Cycles;  //采样时间:5时钟周期</span>
    <span class="token comment">//ADC_CommonInitStruct.ADC_Prescaler = ADC_Prescaler_Div4;	//由于默认是 2 分频,太高,我们自己设置为4分频即可 21MHz</span>

    <span class="token function">ADC_CommonInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC_CommonInitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//ADC 公共配置初始化</span>

    <span class="token comment">//3.配置ADC参数</span>
    ADC_InitTypeDef ADC_InitStruct<span class="token punctuation">;</span>

    <span class="token function">ADC_StructInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ADC_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//ADC_InitStruct-&gt;ADC_Resolution = ADC_Resolution_12b;	//分辨率:12位</span>
	<span class="token comment">//ADC_InitStruct-&gt;ADC_ScanConvMode = DISABLE;			//扫描模式:失能</span>
	<span class="token comment">//ADC_InitStruct-&gt;ADC_ContinuousConvMode = DISABLE;		//连续转换:失能</span>
	<span class="token comment">//ADC_InitStruct-&gt;ADC_ExternalTrigConvEdge = ADC_ExternalTrigConvEdge_None;	//禁止触发检查,使用软件触发</span>
	<span class="token comment">//ADC_InitStruct-&gt;ADC_DataAlign = ADC_DataAlign_Right;	//对其方式:右对齐</span>
	<span class="token comment">// ADC_InitStruct-&gt;ADC_NbrOfConversion = 1;				//转换序列次数:单次</span>

    <span class="token function">ADC_Init</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ADC_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//4.使能ADC</span>
	<span class="token function">ADC_Cmd</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/********************************************
函数名：u16 Get_Adc1(u8 ch)
功能:采集ADC通过值
参数:
	@ch：通道
返回值:数值结果
*******************************************/</span>
u16 <span class="token function">Get_Adc1</span><span class="token punctuation">(</span>u8 ch<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.指定ADC通道的规则: 规则组通道,一个序列采样时间</span>
	<span class="token function">ADC_RegularChannelConfig</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span>ch<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>ADC_SampleTime_480Cycles<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.指定ADC1软件转换器开启使能</span>
	<span class="token function">ADC_SoftwareStartConv</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//3.获取结果</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">ADC_GetFlagStatus</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">,</span>ADC_FLAG_EOC<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待转换结果</span>
	
	<span class="token keyword">return</span> <span class="token function">ADC_GetConversionValue</span><span class="token punctuation">(</span>ADC1<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//读取转换结果</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="16_1675"></a>16.光敏电阻的使用</h2> 
<pre><code class="prism language-c"><span class="token comment">/*******************************************************
函数:void Light_Init(void)
功能:光敏电阻传感器初始化
说明:
	我们的光敏电阻使用的引脚是 PA0 通道 ADC123_IN0
*********************************************************/</span>
<span class="token keyword">void</span> <span class="token function">Light_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//1.使能GPIOA总线</span>
	<span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOA<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//2.初始化GPIO为模拟输入</span>
	GPIO_InitTypeDef GPIO_InitStruct<span class="token punctuation">;</span>
	
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_0<span class="token punctuation">;</span>			<span class="token comment">//引脚</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AN<span class="token punctuation">;</span>		<span class="token comment">//模式</span>
	GPIO_InitStruct<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span> GPIO_PuPd_NOPULL<span class="token punctuation">;</span>	<span class="token comment">//状态:无上下拉</span>
	
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">//3.调用ADC1初始化</span>
	<span class="token function">ADC1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/********************************************************
函数:u16 Get_Light(void)
功能:获取光敏值
参数:无
返回值:光敏值
说明:我们ADC默认是单次采集,有可能异常
	可以类似跳水运动员,取平均值

制作一个粗劣范围: 
范围:0 - 100
数值:0   = 最暗
数值:100 = 最亮
********************************************************/</span>
u16 <span class="token function">Get_Light</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 temp_val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		temp_val <span class="token operator">+=</span> <span class="token function">Get_Adc1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//通道0</span>
	<span class="token punctuation">}</span>
	
	temp_val <span class="token operator">=</span> temp_val <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">;</span>		<span class="token comment">//求平均值</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>temp_val <span class="token operator">&gt;</span> <span class="token number">4000</span><span class="token punctuation">)</span> temp_val <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> <span class="token number">100</span><span class="token operator">-</span><span class="token punctuation">(</span>temp_val<span class="token operator">/</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1731"></a>实现的功能：</h4> 
<p>下位机(STM32):<br> 1.执行器:LED，蜂鸣器，风扇。<br> 2.交互区: KEY按键，OLED显示屏<br> 3.定时数据上传: 定时器7<br> 4.PWM档位: BEEP 和 风扇<br> 5.掉电保护执环境状态eeprom 和 独立看门狗异常监测<br> 6.无线交互:WIFI esp 12s<br> 7.传感器:温湿度,光照</p> 
<p>上位机(Qt界面):<br> 1.制作TCP服务器<br> 2.监控下位机环境<br> 3.控制下位机设备</p> 
<p>本来用Qt写了一个温湿度曲线图，把数据存到数据库，再读出来显示。时间轴做x轴，但是格式转换出问题了，是负值，显示不了数据，各位有没有其他办法呢。<br> 出现了点bug，数据显示不出来。</p> 
<p>后续打算用MQTT和云服务器实现远程控制。<br> <img src="https://images2.imgbox.com/74/e7/N0WyWdZc_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7e/a0/uHqPknQh_o.jpg" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/b6/d0/TKYEIkOt_o.jpg" alt="在这里插入图片描述"></p> 
<p>资源已上传，需要的自提。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/669a0a5cc6c15d207a6a65796cbacd65/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何实现跳板机高速传输文件到远程服务器(本地是windows/本地是ubuntu)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a5956d1d375ac71e0207023c263dcf99/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">接口报错-JSON parse error: Cannot deserialize value of type `java.lang.Integer` from Boolean value</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>