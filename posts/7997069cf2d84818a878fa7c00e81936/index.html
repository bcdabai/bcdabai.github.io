<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>服务器session配置文件,tomcat-session共享服务器,msn介绍与安装 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="服务器session配置文件,tomcat-session共享服务器,msn介绍与安装" />
<meta property="og:description" content="session共享服务器
msm
msm(memcached session manager)提供将Tomcat的session保持到memcached或redis的程序，可以实现高可用。
支持Tomcat的6.x、7.x、8.x、9.x
Tomcat的Session管理类，Tomcat版本不同
memcached-session-manager-2.3.2.jar
memcached-session-manager-tc8-2.3.2.jar
Session数据的序列化、反序列化类
官方推荐kyro
在webapp中WEB-INF/lib/下
驱动类
memcached(spymemcached.jar)
Redis(jedis.jar)
安装
将spymemcached.jar、memcached-session-manage、kyro相关的jar文件都放到Tomcat的lib目录中去，这个目录是$CATALINA_HOME/lib/，对应本次安装就是/usr/local/tomcat/lib。
asm-5.2.jar
kryo-3.0.3.jar
kryo-serializers-0.45.jar
memcached-session-manager-2.3.2.jar
memcached-session-manager-tc8-2.3.2.jar
minlog-1.3.1.jar
msm-kryo-serializer-2.3.2.jar
objenesis-2.6.jar
reflectasm-1.11.9.jar
spymemcached-2.12.3.jar
sticky模式
原理
当请求结束时Tomcat的session会送给memcached备份。即Tomcat session为主session，memcached session为备session，使用memcached相当于备份了一份Session。
如果查询Session时Tomcat会优先使用自己内存的Session，Tomcat通过jvmRoute发现不是自己的Session，便从memcached中找到该Session
如果是更新本机Session，请求完成后更新memcached。
部署
. \ / .
. X .
. / \ .
t1和m1部署可以在一台主机上，t2和m2部署也可以在同一台。
配置
放到 $CATALINA_HOME/conf/context.xml中
特别注意，t1配置中为failoverNodes=&#34;n1&#34;， t2配置为failoverNodes=&#34;n2&#34;
以下是sticky的配置
...
memcachedNodes=&#34;n1:10.0.0.101:11211,n2:10.0.0.102:11211&#34;
failoverNodes=&#34;n1&#34;
requestUriIgnorePattern=&#34;.*\.(ico|png|gif|jpg|css|js)$&#34;
transcoderFactoryClass=&#34;de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory&#34;
/&gt;
memcachedNodes=&#34;n1:host1.yourdomain.com:11211,n2:host2.yourdomain.com:11211&#34;
memcached的节点们；n1、n2只是别名，可以重新命名。
failoverNodes故障转移节点，n1是备用节点，n2是主存储节点。另一台Tomcat将n1改为n2，其主节点是n1，备用节点是n2。
如果配置成功，可以在logs/catalina.out中看到下面的内容
信息 [t1.magedu.com-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.startInternal --------
- finished initialization:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/7997069cf2d84818a878fa7c00e81936/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-11T17:34:58+08:00" />
<meta property="article:modified_time" content="2021-08-11T17:34:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">服务器session配置文件,tomcat-session共享服务器,msn介绍与安装</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>session共享服务器</p> 
 <p>msm</p> 
 <p>msm(memcached session manager)提供将Tomcat的session保持到memcached或redis的程序，可以实现高可用。</p> 
 <p>支持Tomcat的6.x、7.x、8.x、9.x</p> 
 <p>Tomcat的Session管理类，Tomcat版本不同</p> 
 <p>memcached-session-manager-2.3.2.jar</p> 
 <p>memcached-session-manager-tc8-2.3.2.jar</p> 
 <p>Session数据的序列化、反序列化类</p> 
 <p>官方推荐kyro</p> 
 <p>在webapp中WEB-INF/lib/下</p> 
 <p>驱动类</p> 
 <p>memcached(spymemcached.jar)</p> 
 <p>Redis(jedis.jar)</p> 
 <p>安装</p> 
 <p>将spymemcached.jar、memcached-session-manage、kyro相关的jar文件都放到Tomcat的lib目录中去，这个目录是$CATALINA_HOME/lib/，对应本次安装就是/usr/local/tomcat/lib。</p> 
 <p>asm-5.2.jar</p> 
 <p>kryo-3.0.3.jar</p> 
 <p>kryo-serializers-0.45.jar</p> 
 <p>memcached-session-manager-2.3.2.jar</p> 
 <p>memcached-session-manager-tc8-2.3.2.jar</p> 
 <p>minlog-1.3.1.jar</p> 
 <p>msm-kryo-serializer-2.3.2.jar</p> 
 <p>objenesis-2.6.jar</p> 
 <p>reflectasm-1.11.9.jar</p> 
 <p>spymemcached-2.12.3.jar</p> 
 <p>sticky模式</p> 
 <p>原理</p> 
 <p>当请求结束时Tomcat的session会送给memcached备份。即Tomcat session为主session，memcached session为备session，使用memcached相当于备份了一份Session。</p> 
 <p>如果查询Session时Tomcat会优先使用自己内存的Session，Tomcat通过jvmRoute发现不是自己的Session，便从memcached中找到该Session</p> 
 <p>如果是更新本机Session，请求完成后更新memcached。</p> 
 <p>部署</p> 
 <p>. \ / .</p> 
 <p>. X .</p> 
 <p>. / \ .</p> 
 <p>t1和m1部署可以在一台主机上，t2和m2部署也可以在同一台。</p> 
 <p>配置</p> 
 <p>放到 $CATALINA_HOME/conf/context.xml中</p> 
 <p>特别注意，t1配置中为failoverNodes="n1"， t2配置为failoverNodes="n2"</p> 
 <p>以下是sticky的配置</p> 
 <p>...</p> 
 <p></p> 
 <p>memcachedNodes="n1:10.0.0.101:11211,n2:10.0.0.102:11211"</p> 
 <p>failoverNodes="n1"</p> 
 <p>requestUriIgnorePattern=".*\.(ico|png|gif|jpg|css|js)$"</p> 
 <p>transcoderFactoryClass="de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</p> 
 <p>/&gt;</p> 
 <p>memcachedNodes="n1:host1.yourdomain.com:11211,n2:host2.yourdomain.com:11211"</p> 
 <p>memcached的节点们；n1、n2只是别名，可以重新命名。</p> 
 <p>failoverNodes故障转移节点，n1是备用节点，n2是主存储节点。另一台Tomcat将n1改为n2，其主节点是n1，备用节点是n2。</p> 
 <p>如果配置成功，可以在logs/catalina.out中看到下面的内容</p> 
 <p>信息 [t1.magedu.com-startStop-1] de.javakaffee.web.msm.MemcachedSessionService.startInternal --------</p> 
 <p>- finished initialization:</p> 
 <p>- sticky: true</p> 
 <p>- operation timeout: 1000</p> 
 <p>- node ids: [n2]</p> 
 <p>- failover node ids: [n1]</p> 
 <p>- storage key prefix: null</p> 
 <p>- locking mode: null (expiration: 5s)</p> 
 <p>配置成功后，网页访问以下，页面中看到了Session。然后运行下面的Python程序，就可以看到是否存储到了memcached中了。</p> 
 <p>范例：安装python环境准备python程序查看memcached中的SessionID</p> 
 <p>[root@centos8 ~]#dnf install python36 -y</p> 
 <p>[root@centos8 ~]#pip3 install python-memcached</p> 
 <p>[root@centos8 ~]#cat showmemcached.py</p> 
 <p>import memcache # pip install python-memcached</p> 
 <p>mc = memcache.Client(['10.0.0.101:11211'], debug=True)</p> 
 <p>stats = mc.get_stats()[0]</p> 
 <p>print(stats)</p> 
 <p>for k,v in stats[1].items():</p> 
 <p>print(k, v)</p> 
 <p>print('-' * 30)</p> 
 <p># 查看全部key</p> 
 <p>print(mc.get_stats('items')) # stats items 返回 items:5:number 1</p> 
 <p>print('-' * 30)</p> 
 <p>print(mc.get_stats('cachedump 5 0')) # stats cachedump 5 0 # 5和上面的items返回的值有关；0表示全部</p> 
 <p>t1、t2、n1、n2依次启动成功，分别使用http://t1.magedu.org:8080/ 和http://t2.magedu.org:8080/ 观察。</p> 
 <p>看起负载均衡调度器，通过http://t0.magedu.com来访问看看效果</p> 
 <p>On tomcats</p> 
 <p>10.0.0.102:8080</p> 
 <p>SessionID = 2A19B1EB6D9649C9FED3E7277FDFD470-n2.Tomcat1</p> 
 <p>Wed Jun 26 16:32:11 CST 2019</p> 
 <p>On tomcats</p> 
 <p>10.0.0.101:8080</p> 
 <p>SessionID = 2A19B1EB6D9649C9FED3E7277FDFD470-n1.Tomcat2</p> 
 <p>Wed Jun 26 16:32:36 CST 2019</p> 
 <p>可以看到浏览器端被调度到不同Tomcat上，但是都获得了同样的SessionID。</p> 
 <p>停止t2、n2看看效果，恢复看看效果。</p> 
 <p>范例：访问tomcat，查看memcached中SessionID信息</p> 
 <p align="center"><img src="https://images2.imgbox.com/e5/ff/bEUZiRzV_o.png" alt="48b984a0effb0032a846ee18ed8ed8c8.png"></p> 
 <p>[root@centos8 ~]#python3 showmemcached.py</p> 
 <p>.....</p> 
 <p>[('10.0.0.48:11211 (1)', {'8D0B801640CA0B1EB9AD4A4C221EA81A-n2.Tomcat1': '[97 b; 1581598952 s]'})]</p> 
 <p>#以上结果表示SessionID来自于memcached的n2节点，但是最终是由tomcat1返回的SessionID</p> 
 <p>本文链接：http://www.yunweipai.com/35195.html</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e37daa249dac9d2043847dd8eab37bbb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">消防系统数据服务器,数据中心消防安全措施必须齐全完备</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/14e52f5af7faf97b907411aa3f4ba51b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python递归搜索文件再同步到服务器,Python递归查找文件并移动到一个目标目录</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>