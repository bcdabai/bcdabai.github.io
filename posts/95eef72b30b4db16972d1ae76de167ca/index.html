<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Blink SQL窗口函数 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Blink SQL窗口函数" />
<meta property="og:description" content="概述 窗口函数 窗口函数Flink SQL支持基于无限大窗口的聚合（无需在SQL Query中，显式定义任何窗口）以及对一个特定的窗口的聚合。例如，需要统计在过去的1分钟内有多少用户点击了某个的网页，可以通过定义一个窗口来收集最近1分钟内的数据，并对这个窗口内的数据进行计算。
Flink SQL支持的窗口聚合主要是两种：
Window聚合Over聚合 Window聚合支持Event Time和Processing Time两种时间属性定义窗口。
每种时间属性类型支持三种窗口类型：滚动窗口（TUMBLE）、滑动窗口（HOP）和会话窗口（SESSION）。
时间属性 Flink SQL支持以下两种时间属性。
Event Time：事件时间(通常是数据的最原始的创建时间)，Event Time一定是提供在Schema里面的数据。Processing Time：对事件进行处理的本地系统时间。 级联窗口 Rowtime列在经过窗口操作后，其Event Time属性将丢失。可以使用辅助函数TUMBLE_ROWTIME、HOP_ROWTIME或SESSION_ROWTIME获取窗口中的Rowtime列的最大值max(rowtime)作为时间窗口的Rowtime，其类型是具有Rowtime属性的TIMESTAMP，取值为window_end - 1。例如[00:00, 00:15]的窗口，返回值为00:14:59:999。
示例逻辑：基于1分钟的滚动窗口聚合结果，进行1小时的滚动窗口聚合。
CREATE TABLE user_clicks( username VARCHAR, click_url VARCHAR, ts TIMESTAMP, WATERMARK wk FOR ts AS withOffset(ts, 2000)	-- 为Rowtime定义WaterMark ) with ( type=&#39;datahub&#39;, ... ); CREATE TABLE tumble_output( window_start TIMESTAMP, window_end TIMESTAMP, username VARCHAR, clicks BIGINT )	with ( type=&#39;print&#39; ); CREATE VIEW one_minute_window_output AS SELECT // 使用TUMBLE_ROWTIME作为二级Window的聚合时间 TUMBLE_ROWTIME(ts, INTERVAL &#39;1&#39; MINUTE) AS rowtime, username, COUNT(click_url) AS cnt FROM user_clicks GROUP BY TUMBLE(ts, INTERVAL &#39;1&#39; MINUTE), username ; INSERT INTO tumble_output SELECT TUMBLE_START(rowtime, INTERVAL &#39;1&#39; HOUR), TUMBLE_END(rowtime, INTERVAL &#39;1&#39; HOUR), username, SUM(cnt) FROM one_minute_window_output GROUP BY TUMBLE(rowtime, INTERVAL &#39;1&#39; HOUR), username ; 滚动窗口 滚动窗口(TUMBLE)将每个元素分配到一个指定大小的窗口中。通常，滚动窗口是固定大小的，且不会重叠。例如：指定了一个5分钟大小的滚动窗口，无限流的数据会根据时间划分为[0:00, 0:05)、[0:05, 0:10)、[0:10, 0:15)等窗口。如下展示了一个30秒的滚动窗口。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/95eef72b30b4db16972d1ae76de167ca/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-10T15:01:12+08:00" />
<meta property="article:modified_time" content="2022-06-10T15:01:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Blink SQL窗口函数</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>概述</h3> 
<h4><a id="_2"></a>窗口函数</h4> 
<p>窗口函数Flink SQL支持基于无限大窗口的聚合（无需在SQL Query中，显式定义任何窗口）以及对一个特定的窗口的聚合。例如，需要统计在过去的1分钟内有多少用户点击了某个的网页，可以通过定义一个窗口来收集最近1分钟内的数据，并对这个窗口内的数据进行计算。</p> 
<p>Flink SQL支持的窗口聚合主要是两种：</p> 
<ul><li>Window聚合</li><li>Over聚合</li></ul> 
<p>Window聚合支持Event Time和Processing Time两种时间属性定义窗口。</p> 
<p>每种时间属性类型支持三种窗口类型：滚动窗口（TUMBLE）、滑动窗口（HOP）和会话窗口（SESSION）。</p> 
<h4><a id="_15"></a>时间属性</h4> 
<p>Flink SQL支持以下两种时间属性。</p> 
<ul><li>Event Time：事件时间(通常是数据的最原始的创建时间)，Event Time一定是提供在Schema里面的数据。</li><li>Processing Time：对事件进行处理的本地系统时间。</li></ul> 
<h4><a id="_22"></a>级联窗口</h4> 
<p>Rowtime列在经过窗口操作后，其Event Time属性将丢失。可以使用辅助函数<code>TUMBLE_ROWTIME</code>、<code>HOP_ROWTIME</code>或<code>SESSION_ROWTIME</code>获取窗口中的Rowtime列的最大值max(rowtime)作为时间窗口的Rowtime，其类型是具有Rowtime属性的TIMESTAMP，取值为<code>window_end - 1</code>。例如<code>[00:00, 00:15]</code>的窗口，返回值为<code>00:14:59:999</code>。</p> 
<p>示例逻辑：基于1分钟的滚动窗口聚合结果，进行1小时的滚动窗口聚合。</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_clicks<span class="token punctuation">(</span>
	username <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
  click_url <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
  ts <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
  WATERMARK wk <span class="token keyword">FOR</span> ts <span class="token keyword">AS</span> withOffset<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>	<span class="token comment">-- 为Rowtime定义WaterMark</span>
<span class="token punctuation">)</span> <span class="token keyword">with</span> <span class="token punctuation">(</span>
  <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">'datahub'</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tumble_output<span class="token punctuation">(</span>
	window_start <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
  window_end <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
  username <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
  clicks <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span>	<span class="token keyword">with</span> <span class="token punctuation">(</span>
  <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">'print'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> one_minute_window_output <span class="token keyword">AS</span> 
<span class="token keyword">SELECT</span>
	<span class="token comment">// 使用TUMBLE_ROWTIME作为二级Window的聚合时间</span>
	TUMBLE_ROWTIME<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> rowtime<span class="token punctuation">,</span>
	username<span class="token punctuation">,</span>
	<span class="token function">COUNT</span><span class="token punctuation">(</span>click_url<span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt
<span class="token keyword">FROM</span> user_clicks
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> TUMBLE<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> username
<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tumble_output
<span class="token keyword">SELECT</span>
	TUMBLE_START<span class="token punctuation">(</span>rowtime<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">HOUR</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	TUMBLE_END<span class="token punctuation">(</span>rowtime<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">HOUR</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	username<span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> one_minute_window_output
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> TUMBLE<span class="token punctuation">(</span>rowtime<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">HOUR</span><span class="token punctuation">)</span><span class="token punctuation">,</span> username
<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_69"></a>滚动窗口</h3> 
<p>滚动窗口(TUMBLE)将每个元素分配到一个指定大小的窗口中。通常，滚动窗口是固定大小的，且不会重叠。例如：指定了一个5分钟大小的滚动窗口，无限流的数据会根据时间划分为<code>[0:00, 0:05)</code>、<code>[0:05, 0:10)</code>、<code>[0:10, 0:15)</code>等窗口。如下展示了一个30秒的滚动窗口。</p> 
<p><img src="https://images2.imgbox.com/88/38/FX1oGPbN_o.png" alt="img"></p> 
<h4><a id="_75"></a>语法</h4> 
<p>TUMBLE函数用在GROUP BY子句中，用来定义滚动窗口。</p> 
<pre><code class="prism language-sql">TUMBLE<span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">time</span><span class="token operator">-</span>attr<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>size<span class="token operator">-</span><span class="token keyword">interval</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>size<span class="token operator">-</span><span class="token keyword">interval</span><span class="token operator">&gt;</span>: <span class="token keyword">INTERVAL</span> <span class="token string">'string'</span> timeUnit
</code></pre> 
<blockquote> 
 <p>参数必须是时间流中的一个合法的时间属性字段，指定为Processing Time或Event Time。</p> 
</blockquote> 
<h4><a id="_86"></a>标识函数</h4> 
<p>使用标识函数选出窗口的起始时间或结束时间，窗口的时间属性用于下级Window的聚合。</p> 
<table><thead><tr><th>窗口标识函数</th><th>返回类型</th><th>描述</th></tr></thead><tbody><tr><td>TUMBLE_START(time-attr, size-interval)</td><td>TIMESTAMP</td><td>返回窗口的其实时间(包含边界)。例如<code>[00:10,00:15]</code>窗口，返回<code>00:10</code>。</td></tr><tr><td>TUMBLE_END(time-attr, size-interval)</td><td>TIMESTAMP</td><td>返回窗口的结束时间（包含边界）。例如<code>[00:00, 00:15]</code>窗口，返回<code>00:15</code>。</td></tr><tr><td>TUMBLE_ROWTIME(time-attr, size-interval)</td><td>TIMESTAMP(rowtime-attr)</td><td>返回窗口的结束时间（不包含边界）。例如<code>(00:00, 00:15)</code>窗口，返回<code>00:14:59.999</code>。返回值是一个rowtime attribute，即可以基于该字段做时间属性的操作。</td></tr><tr><td>TUMBLE_PROCTIME(time-attr, size-interval)</td><td>TIMESTAMP(rowtime-attr)</td><td>返回窗口的结束时间（不包含边界）。例如<code>(00:00, 00:15)</code>窗口，返回<code>00:14:59.999</code>。返回值是一个Proctime Attribute，即可以基于该字段做时间属性的操作。</td></tr></tbody></table> 
<h4><a id="Event_Time_97"></a>使用Event Time统计每个用户每分钟在指定网站的单击数示例</h4> 
<h5><a id="_99"></a>测试数据</h5> 
<table><thead><tr><th align="left">username（VARCHAR）</th><th align="left">click_url（VARCHAR）</th><th align="left">ts（TIMESTAMP）</th></tr></thead><tbody><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:00:00.0</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:00:10.0</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:00:49.0</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:01:05.0</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:01:58.0</code></td></tr><tr><td align="left">Timo</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:02:10.0</code></td></tr></tbody></table> 
<h5><a id="_110"></a>测试语句</h5> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_clicks<span class="token punctuation">(</span>
  username <span class="token keyword">varchar</span><span class="token punctuation">,</span>
  click_url <span class="token keyword">varchar</span><span class="token punctuation">,</span>
  ts <span class="token keyword">timeStamp</span><span class="token punctuation">,</span>
  WATERMARK wk <span class="token keyword">FOR</span> ts <span class="token keyword">as</span> withOffset<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token comment">--为rowtime定义Watermark。</span>
<span class="token punctuation">)</span> <span class="token keyword">with</span> <span class="token punctuation">(</span>
  <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">'datahub'</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tumble_output<span class="token punctuation">(</span>
  window_start <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
  window_end <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
  username <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
  clicks <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span> <span class="token keyword">with</span> <span class="token punctuation">(</span>
  <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">'RDS'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tumble_output
<span class="token keyword">SELECT</span>
TUMBLE_START<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span> <span class="token keyword">as</span> window_start<span class="token punctuation">,</span>
TUMBLE_END<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span> <span class="token keyword">as</span> window_end<span class="token punctuation">,</span>
username<span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span>click_url<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> user_clicks
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> TUMBLE<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> username<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_142"></a>测试结果</h5> 
<table><thead><tr><th align="left">window_start （TIMESTAMP）</th><th align="left">window_end （TIMESTAMP）</th><th align="left">username（VARCHAR）</th><th align="left">clicks（BIGINT）</th></tr></thead><tbody><tr><td align="left"><code>2017-10-10 10:00:00.0</code></td><td align="left"><code>2017-10-10 10:01:00.0</code></td><td align="left">Jark</td><td align="left">3</td></tr><tr><td align="left"><code>2017-10-10 10:01:00.0</code></td><td align="left"><code>2017-10-10 10:02:00.0</code></td><td align="left">Jark</td><td align="left">2</td></tr><tr><td align="left"><code>2017-10-10 10:02:00.0</code></td><td align="left"><code>2017-10-10 10:03:00.0</code></td><td align="left">Timo</td><td align="left">1</td></tr></tbody></table> 
<h4><a id="Processing_Time_150"></a>使用Processing Time统计每个用户每分钟在指定网站的单击数示例</h4> 
<h5><a id="_152"></a>测试数据</h5> 
<table><thead><tr><th align="left">username （VARCHAR）</th><th align="left">click_url（VARCHAR）</th></tr></thead><tbody><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td></tr><tr><td align="left">Timo</td><td align="left"><code>http://taobao.com/xxx</code></td></tr></tbody></table> 
<h5><a id="_163"></a>测试语句</h5> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> window_test <span class="token punctuation">(</span>
  username   <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
  click_url  <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
  ts <span class="token keyword">as</span> PROCTIME<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">'datahub'</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tumble_output<span class="token punctuation">(</span>
  window_start <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
  window_end <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
  username <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
  clicks <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span> <span class="token keyword">with</span> <span class="token punctuation">(</span>
  <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">'print'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> tumble_output
<span class="token keyword">SELECT</span>
TUMBLE_START<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
TUMBLE_END<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
username<span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span>click_url<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> window_test
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> TUMBLE<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> username<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_194"></a>测试结果</h5> 
<table><thead><tr><th align="left">window_start （TIMESTAMP）</th><th align="left">window_end （TIMESTAMP）</th><th align="left">username （VARCHAR）</th><th align="left">clicks（BIGINT）</th></tr></thead><tbody><tr><td align="left"><code>2019-04-11 14:43:00.000</code></td><td align="left"><code>2019-04-11 14:44:00.000</code></td><td align="left">Jark</td><td align="left">5</td></tr><tr><td align="left"><code>2019-04-11 14:43:00.000 </code></td><td align="left"><code>2019-04-11 14:44:00.000</code></td><td align="left">Timo</td><td align="left">1</td></tr></tbody></table> 
<p>因为本地调试是瞬时的，处理时间可能小于1秒，所以使用Processing Time时间属性对数据进行窗口聚合，可能会出现本地调试没有结果的情况。</p> 
<h3><a id="_203"></a>滑动窗口</h3> 
<p>实时计算滑动窗口（HOP）暂不支持与LAST_VALUE、FIRST_VALUE或TopN函数共同使用。</p> 
<h4><a id="_207"></a>什么是滑动窗口</h4> 
<p>滑动窗口（HOP），也被称作Sliding Window。不同于滚动窗口，滑动窗口的窗口可以重叠。</p> 
<p>滑动窗口有两个参数：<strong>slide</strong>和<strong>size</strong>。<strong>slide</strong>为每次滑动的步长，<strong>size</strong>为窗口的大小。</p> 
<ul><li><strong>slide &lt; size</strong>，则窗口会重叠，每个元素会被分配到多个窗口。</li><li><strong>slide = size</strong>，则等同于滚动窗口（TUMBLE）。</li><li><strong>slide &gt; size</strong>，则为跳跃窗口，窗口之间不重叠且有间隙。</li></ul> 
<p>通常，大部分元素符合多个窗口情景，窗口是重叠的。因此，滑动窗口在计算移动平均数（moving averages）时很实用。例如，计算过去5分钟数据的平均值，每10秒钟更新一次，可以设置<strong>slide</strong>为10秒，<strong>size</strong>为5分钟。下图为您展示间隔为30秒，窗口大小为1分钟的滑动窗口。</p> 
<p><img src="https://images2.imgbox.com/2d/ee/RA30AkgW_o.png" alt="滑动窗口"></p> 
<h4><a id="_221"></a>滑动窗口函数语法</h4> 
<p>HOP函数用在group by子句中，用来定义滑动窗口。</p> 
<pre><code class="prism language-sql">HOP<span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">time</span><span class="token operator">-</span>attr<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>slide<span class="token operator">-</span><span class="token keyword">interval</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token operator">&lt;</span>size<span class="token operator">-</span><span class="token keyword">interval</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>slide<span class="token operator">-</span><span class="token keyword">interval</span><span class="token operator">&gt;</span>: <span class="token keyword">INTERVAL</span> <span class="token string">'string'</span> timeUnit
<span class="token operator">&lt;</span>size<span class="token operator">-</span><span class="token keyword">interval</span><span class="token operator">&gt;</span>: <span class="token keyword">INTERVAL</span> <span class="token string">'string'</span> timeUnit            
</code></pre> 
<p><code>&lt;time-attr&gt;</code>参数必须是流中的一个合法的时间属性字段，指定为Processing Time或Event Time。</p> 
<h4><a id="_233"></a>滑动窗口标识函数</h4> 
<p>使用滑动窗口标识函数选出窗口的起始时间或者结束时间，窗口的时间属性用于下级Window的聚合。</p> 
<table><thead><tr><th align="left">窗口标识函数</th><th align="left">返回类型</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>HOP_START（&lt;time-attr&gt;, &lt;slide-interval&gt;, &lt;size-interval&gt;）</code></td><td align="left">TIMESTAMP</td><td align="left">返回窗口的起始时间（包含边界）。例如<code>[00:10, 00:15) </code>窗口，返回<code>00:10 </code>。</td></tr><tr><td align="left"><code>HOP_END（&lt;time-attr&gt;, &lt;slide-interval&gt;, &lt;size-interval&gt;）</code></td><td align="left">TIMESTAMP</td><td align="left">返回窗口的结束时间（包含边界）。例如<code>[00:00, 00:15) </code>窗口，返回<code>00:15</code>。</td></tr><tr><td align="left"><code>HOP_ROWTIME（&lt;time-attr&gt;, &lt;slide-interval&gt;, &lt;size-interval&gt;）</code></td><td align="left">TIMESTAMP（rowtime-attr）</td><td align="left">返回窗口的结束时间（不包含边界）。例如<code>(00:00, 00:15) </code>窗口，返回<code>00:14:59.999</code>。返回值是一个rowtime attribute，即可以基于该字段做时间类型的操作。</td></tr><tr><td align="left"><code>HOP_PROCTIME（&lt;time-attr&gt;, &lt;slide-interval&gt;, &lt;size-interval&gt;）</code></td><td align="left">TIMESTAMP（rowtime-attr）</td><td align="left">返回窗口的结束时间（不包含边界）。例如<code>(00:00, 00:15) </code>窗口，返回<code>00:14:59.999 </code>。返回值是一个proctime attribute，即可以基于该字段做时间类型的操作。</td></tr></tbody></table> 
<h4><a id="_244"></a>示例</h4> 
<p>统计每个用户过去1分钟的单击次数，每30秒更新1次，即1分钟的窗口，30秒滑动1次。</p> 
<h5><a id="_248"></a>测试数据</h5> 
<table><thead><tr><th align="left">username（VARCHAR）</th><th align="left">click_url（VARCHAR）</th><th align="left">ts（TIMESTAMP）</th></tr></thead><tbody><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:00:00.0</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:00:10.0</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:00:49.0</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:01:05.0</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:01:58.0</code></td></tr><tr><td align="left">Timo</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:02:10.0</code></td></tr></tbody></table> 
<h5><a id="_259"></a>测试语句</h5> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_clicks <span class="token punctuation">(</span>
    username <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
    click_url <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
    ts <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
    WATERMARK wk <span class="token keyword">FOR</span> ts <span class="token keyword">AS</span> WITHOFFSET <span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token comment">--为rowtime定义Watermark。</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span> <span class="token keyword">TYPE</span> <span class="token operator">=</span> <span class="token string">'datahub'</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> hop_output <span class="token punctuation">(</span>
    window_start <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
    window_end <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
    username <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
    clicks <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span><span class="token keyword">TYPE</span> <span class="token operator">=</span> <span class="token string">'rds'</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span>
    hop_output
<span class="token keyword">SELECT</span>
    HOP_START <span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'30'</span> <span class="token keyword">SECOND</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    HOP_END <span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'30'</span> <span class="token keyword">SECOND</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    username<span class="token punctuation">,</span>
    <span class="token function">COUNT</span> <span class="token punctuation">(</span>click_url<span class="token punctuation">)</span>
<span class="token keyword">FROM</span>
    user_clicks
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
    HOP <span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'30'</span> <span class="token keyword">SECOND</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">MINUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    username                   
</code></pre> 
<h5><a id="_292"></a>测试结果</h5> 
<table><thead><tr><th align="left">window_start （TIMESTAMP）</th><th align="left">window_end （TIMESTAMP）</th><th align="left">username （VARCHAR）</th><th align="left">clicks （BIGINT）</th></tr></thead><tbody><tr><td align="left"><code>2017-10-10 09:59:30.0</code></td><td align="left"><code>2017-10-10 10:00:30.0</code></td><td align="left">Jark</td><td align="left">2</td></tr><tr><td align="left"><code>2017-10-10 10:00:00.0</code></td><td align="left"><code>2017-10-10 10:01:00.0</code></td><td align="left">Jark</td><td align="left">3</td></tr><tr><td align="left"><code>2017-10-10 10:00:30.0</code></td><td align="left"><code>2017-10-10 10:01:30.0</code></td><td align="left">Jark</td><td align="left">2</td></tr><tr><td align="left"><code>2017-10-10 10:01:00.0</code></td><td align="left"><code>2017-10-10 10:02:00.0</code></td><td align="left">Jark</td><td align="left">2</td></tr><tr><td align="left"><code>2017-10-10 10:01:30.0</code></td><td align="left"><code>2017-10-10 10:02:30.0</code></td><td align="left">Jark</td><td align="left">1</td></tr><tr><td align="left"><code>2017-10-10 10:02:00.0</code></td><td align="left"><code>2017-10-10 10:03:00.0</code></td><td align="left">Timo</td><td align="left">1</td></tr><tr><td align="left"><code>2017-10-10 10:02:30.0</code></td><td align="left"><code>2017-10-10 10:03:30.0</code></td><td align="left">Timo</td><td align="left">1</td></tr></tbody></table> 
<p>HOP窗口无法读取数据进入的时间，第一个窗口的开启时间会前移。<strong>前移时长=窗口时长-滑动步长</strong>，示例如下表。</p> 
<table><thead><tr><th align="left">窗口时长（秒）</th><th align="left">滑动步长（秒）</th><th align="left">Event Time</th><th align="left">第一个窗口StartTime</th><th align="left">第一个窗口EndTime</th></tr></thead><tbody><tr><td align="left">120</td><td align="left">30</td><td align="left"><code>2019-07-31 10:00:00.0</code></td><td align="left"><code>2019-07-31 09:58:30.0</code></td><td align="left"><code>2019-07-31 10:00:30.0</code></td></tr><tr><td align="left">60</td><td align="left">10</td><td align="left"><code>2019-07-31 10:00:00.0</code></td><td align="left"><code>2019-07-31 09:59:10.0</code></td><td align="left"><code>2019-07-31 10:00:10.0</code></td></tr></tbody></table> 
<h3><a id="_311"></a>会话窗口</h3> 
<h4><a id="_313"></a>什么是会话窗口</h4> 
<p>会话窗口（SESSION）通过SESSION活动来对元素进行分组。会话窗口与滚动窗口和滑动窗口相比，没有窗口重叠，没有固定窗口大小。相反，当它在一个固定的时间周期内不再收到元素，即会话断开时，该窗口就会关闭。</p> 
<p>会话窗口通过一个间隔时间（Gap）来配置，这个间隔定义了非活跃周期的长度。例如，一个表示鼠标单击活动的数据流可能具有长时间的空闲时间，并在两段空闲之间散布着高浓度的单击。如果数据在指定的间隔（Gap）之后到达，则会开始一个新的窗口。</p> 
<p>会话窗口示例如下图，每个Key由于不同的数据分布，形成了不同的Window。</p> 
<p><img src="https://images2.imgbox.com/d6/1d/KJsnIAEq_o.png" alt="img"></p> 
<h4><a id="_323"></a>会话窗口函数语法</h4> 
<p>SESSION函数用于在GROUP BY子句中定义会话窗口。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SESSION</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token keyword">time</span><span class="token operator">-</span>attr<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>gap<span class="token operator">-</span><span class="token keyword">interval</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>gap<span class="token operator">-</span><span class="token keyword">interval</span><span class="token operator">&gt;</span>: <span class="token keyword">INTERVAL</span> <span class="token string">'string'</span> timeUnit
</code></pre> 
<p><code>&lt;time-attr&gt;</code> 参数必须是数据流中的一个合法的时间属性字段，指定为Processing Time或Event Time。</p> 
<h4><a id="_334"></a>会话窗口标识函数</h4> 
<p>使用标识函数选出窗口的起始时间或者结束时间，窗口的时间属性用于下级Window的聚合。</p> 
<table><thead><tr><th align="left">窗口标识函数</th><th align="left">返回类型</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>SESSION_START（&lt;time-attr&gt;, &lt;gap-interval&gt;）</code></td><td align="left">Timestamp</td><td align="left">返回窗口的起始时间（包含边界）。例如<code>[00:10,00:15]</code>的窗口，返回<code>00:10</code>，即为此会话窗口内第一条记录的时间。</td></tr><tr><td align="left"><code>SESSION_END（&lt;time-attr&gt;, &lt;gap-interval&gt;）</code></td><td align="left">Timestamp</td><td align="left">返回窗口的结束时间（包含边界）。例如<code>[00:00,00:15]</code>的窗口，返回 <code>00:15</code>，即为此会话窗口内最后一条记录的时间+<code>&lt;gap-interval&gt;</code>。</td></tr><tr><td align="left"><code>SESSION_ROWTIME（&lt;time-attr&gt;, &lt;gap-interval&gt;）</code></td><td align="left">Timestamp（rowtime-attr）</td><td align="left">返回窗口的结束时间（不包含边界）。例如<code>(00:00,00:15)</code>的窗口，返回<code>00:14:59.999 </code>。返回值是一个rowtime attribute，也就是可以基于该字段进行时间类型的操作。该参数只能用于基于Event Time的Window。</td></tr><tr><td align="left"><code>SESSION_PROCTIME（&lt;time-attr&gt;, &lt;gap-interval&gt;）</code></td><td align="left">Timestamp（rowtime-attr）</td><td align="left">返回窗口的结束时间（不包含边界）。例如<code>(00:00,00:15)</code>的窗口，返回 <code>00:14:59.999</code> 。返回值是一个Proctime Attribute，也就是可以基于该字段进行时间类型的操作。该参数只能用于基于Processing Time的Window。</td></tr></tbody></table> 
<h4><a id="_345"></a>示例</h4> 
<p>统计每个用户在每个活跃会话期间的单击次数，会话超时时长为30秒。</p> 
<h5><a id="_349"></a>测试数据</h5> 
<table><thead><tr><th align="left">username （VARCHAR）</th><th align="left">click_url （VARCHAR）</th><th align="left">ts （TIMESTAMP）</th></tr></thead><tbody><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:00:00.0</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:00:10.0</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:00:49.0</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:01:05.0</code></td></tr><tr><td align="left">Jark</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:01:58.0</code></td></tr><tr><td align="left">Timo</td><td align="left"><code>http://taobao.com/xxx</code></td><td align="left"><code>2017-10-10 10:02:10.0</code></td></tr></tbody></table> 
<h5><a id="_360"></a>测试语句</h5> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_clicks<span class="token punctuation">(</span>
username <span class="token keyword">varchar</span><span class="token punctuation">,</span>
click_url <span class="token keyword">varchar</span><span class="token punctuation">,</span>
ts <span class="token keyword">timeStamp</span><span class="token punctuation">,</span>
WATERMARK wk <span class="token keyword">FOR</span> ts <span class="token keyword">as</span> withOffset<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token comment">-- 为rowtime定义watermark</span>
<span class="token punctuation">)</span> <span class="token keyword">with</span> <span class="token punctuation">(</span>
<span class="token keyword">type</span><span class="token operator">=</span><span class="token string">'datahub'</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> session_output<span class="token punctuation">(</span>
window_start <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
window_end <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
username <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
clicks <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span> <span class="token keyword">with</span> <span class="token punctuation">(</span>
<span class="token keyword">type</span><span class="token operator">=</span><span class="token string">'rds'</span>，
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> session_output
<span class="token keyword">SELECT</span>
SESSION_START<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'30'</span> <span class="token keyword">SECOND</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
SESSION_END<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'30'</span> <span class="token keyword">SECOND</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
username<span class="token punctuation">,</span>
<span class="token function">COUNT</span><span class="token punctuation">(</span>click_url<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> user_clicks
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">SESSION</span><span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'30'</span> <span class="token keyword">SECOND</span><span class="token punctuation">)</span><span class="token punctuation">,</span> username<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_393"></a>测试结果</h5> 
<table><thead><tr><th align="left">window_start （TIMESTAMP）</th><th align="left">window_end （TIMESTAMP）</th><th align="left">username （VARCHAR）</th><th align="left">clicks （BIGINT）</th></tr></thead><tbody><tr><td align="left"><code>2017-10-10 10:00:00.0</code></td><td align="left"><code>2017-10-10 10:00:40.0</code></td><td align="left">Jark</td><td align="left">2</td></tr><tr><td align="left"><code>2017-10-10 10:00:49.0</code></td><td align="left"><code>2017-10-10 10:01:35.0</code></td><td align="left">Jark</td><td align="left">2</td></tr><tr><td align="left"><code>2017-10-10 10:01:58.0</code></td><td align="left"><code>2017-10-10 10:02:28.0</code></td><td align="left">Jark</td><td align="left">1</td></tr><tr><td align="left"><code>2017-10-10 10:02:10.0</code></td><td align="left"><code>2017-10-10 10:02:40.0</code></td><td align="left">Timo</td><td align="left">1</td></tr></tbody></table> 
<h3><a id="OVER_402"></a>OVER窗口</h3> 
<p>OVER窗口（OVER Window）是传统数据库的标准开窗，不同于Group By Window，OVER窗口中每1个元素都对应1个窗口。OVER窗口可以按照实际元素的行或实际的元素值（时间戳值）确定窗口，因此流数据元素可能分布在多个窗口中。</p> 
<p>在应用OVER窗口的流式数据中，每1个元素都对应1个OVER窗口。每1个元素都触发1次数据计算，每个触发计算的元素所确定的行，都是该元素所在窗口的最后1行。在实时计算的底层实现中，OVER窗口的数据进行全局统一管理（数据只存储1份），逻辑上为每1个元素维护1个OVER窗口，为每1个元素进行窗口计算，完成计算后会清除过期的数据。</p> 
<h4><a id="_408"></a>语法</h4> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    agg1<span class="token punctuation">(</span>col1<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>definition1<span class="token punctuation">)</span> <span class="token keyword">AS</span> colName<span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    aggN<span class="token punctuation">(</span>colN<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>definition1<span class="token punctuation">)</span> <span class="token keyword">AS</span> colNameN
<span class="token keyword">FROM</span> Tab1<span class="token punctuation">;</span>
</code></pre> 
<ul><li>agg1(col1)：按照GROUP BY指定col1列对输入数据进行聚合计算。</li><li>OVER (definition1)：OVER窗口定义。</li><li>AS colName：别名。</li></ul> 
<blockquote> 
 <ul><li>agg1到aggN所对应的OVER definition1必须相同。</li><li>外层SQL可以通过AS的别名查询数据。</li></ul> 
</blockquote> 
<h4><a id="_425"></a>类型</h4> 
<p>Flink SQL中对OVER窗口的定义遵循标准SQL的定义语法，传统OVER窗口没有对其进行更细粒度的窗口类型命名划分。按照计算行的定义方式，OVER Window可以分为以下两类：</p> 
<ul><li>ROWS OVER Window：每1行元素都被视为新的计算行，即每1行都是一个新的窗口。</li><li>RANGE OVER Window：具有相同时间值的所有元素行视为同一计算行，即具有相同时间值的所有行都是同一个窗口。</li></ul> 
<h4><a id="_432"></a>属性</h4> 
<table><thead><tr><th align="left">正交属性</th><th align="left">说明</th><th align="left">proctime</th><th align="left">eventtime</th></tr></thead><tbody><tr><td align="left">ROWS OVER Window</td><td align="left">按照实际元素的行确定窗口。</td><td align="left">支持</td><td align="left">支持</td></tr><tr><td align="left">RANGE OVER Window</td><td align="left">按照实际的元素值（时间戳值）确定窗口。</td><td align="left">支持</td><td align="left">支持</td></tr></tbody></table> 
<h4><a id="Rows_OVER_Window_439"></a>Rows OVER Window语义</h4> 
<h5><a id="_441"></a>窗口数据</h5> 
<p>ROWS OVER Window的每个元素都确定一个窗口。ROWS OVER Window分为Unbounded（无界流）和Bounded（有界流）两种情况。</p> 
<p><strong>Unbounded ROWS OVER Window数据示例如下图所示。</strong></p> 
<p><img src="https://images2.imgbox.com/ed/77/mATO4Nw4_o.png" alt="img"></p> 
<blockquote> 
 <p>虽然上图所示窗口user1的w7、w8及user2的窗口w3、w4都是同一时刻到达，但它们仍然在不同的窗口，这一点与RANGE OVER Window不同。</p> 
</blockquote> 
<p><strong>Bounded ROWS OVER Window数据以3个元素（往前2个元素）的窗口为例，如下图所示。</strong></p> 
<p><img src="https://images2.imgbox.com/30/59/LPcocBCT_o.png" alt="img"></p> 
<blockquote> 
 <p>虽然上图所示窗口user1的w5、w6及user2的窗口w1、w2都是同一时刻到达，但它们仍然在不同的窗口，这一点与RANGE OVER Window不同。</p> 
</blockquote> 
<h5><a id="_457"></a>窗口语法</h5> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    agg1<span class="token punctuation">(</span>col1<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span>
     <span class="token punctuation">[</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>value_expression1<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> value_expressionN<span class="token punctuation">)</span><span class="token punctuation">]</span>
     <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> timeCol
     <span class="token keyword">ROWS</span> 
     <span class="token operator">BETWEEN</span> <span class="token punctuation">(</span><span class="token keyword">UNBOUNDED</span> <span class="token operator">|</span> <span class="token keyword">rowCount</span><span class="token punctuation">)</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> colName<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">FROM</span> Tab1<span class="token punctuation">;</span>       
</code></pre> 
<ul><li>value_expression：分区值表达式。</li><li>timeCol：元素排序的时间字段。</li><li>rowCount：定义根据当前行开始向前追溯几行元素。</li></ul> 
<h5><a id="_473"></a>案例</h5> 
<p>以Bounded ROWS OVER Window场景为例。假设，一张商品上架表，包含有商品ID、商品类型、商品上架时间、商品价格数据。要求输出在当前商品上架之前同类的3个商品中的最高价格。</p> 
<h6><a id="_477"></a>测试数据</h6> 
<table><thead><tr><th align="left">商品ID</th><th align="left">商品类型</th><th align="left">上架时间</th><th align="left">销售价格</th></tr></thead><tbody><tr><td align="left">ITEM001</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:01:00</code></td><td align="left">20</td></tr><tr><td align="left">ITEM002</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:02:00</code></td><td align="left">50</td></tr><tr><td align="left">ITEM003</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:03:00</code></td><td align="left">30</td></tr><tr><td align="left">ITEM004</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:03:00</code></td><td align="left">60</td></tr><tr><td align="left">ITEM005</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:05:00</code></td><td align="left">40</td></tr><tr><td align="left">ITEM006</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:06:00</code></td><td align="left">20</td></tr><tr><td align="left">ITEM007</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:07:00</code></td><td align="left">70</td></tr><tr><td align="left">ITEM008</td><td align="left">Clothes</td><td align="left"><code>2017-11-11 10:08:00</code></td><td align="left">20</td></tr></tbody></table> 
<h6><a id="_490"></a>测试代码</h6> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tmall_item<span class="token punctuation">(</span>
   itemID <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
   itemType <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
   onSellTime <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
   price <span class="token keyword">DOUBLE</span><span class="token punctuation">,</span>
   WATERMARK onSellTime <span class="token keyword">FOR</span> onSellTime <span class="token keyword">as</span> withOffset<span class="token punctuation">(</span>onSellTime<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> 
<span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'sls'</span><span class="token punctuation">,</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span>
    itemID<span class="token punctuation">,</span>
    itemType<span class="token punctuation">,</span>
    onSellTime<span class="token punctuation">,</span>
    price<span class="token punctuation">,</span>  
    <span class="token function">MAX</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
        <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> itemType 
        <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> onSellTime 
        <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token number">2</span> <span class="token keyword">preceding</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> maxPrice
  <span class="token keyword">FROM</span> tmall_item<span class="token punctuation">;</span>
</code></pre> 
<h6><a id="_517"></a>测试结果</h6> 
<table><thead><tr><th align="left">temID</th><th align="left">itemType</th><th align="left">onSellTime</th><th align="left">price</th><th align="left">maxPrice</th></tr></thead><tbody><tr><td align="left">ITEM001</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:01:00</code></td><td align="left">20</td><td align="left">20</td></tr><tr><td align="left">ITEM002</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:02:00</code></td><td align="left">50</td><td align="left">50</td></tr><tr><td align="left">ITEM003</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:03:00</code></td><td align="left">30</td><td align="left">50</td></tr><tr><td align="left">ITEM004</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:03:00</code></td><td align="left">60</td><td align="left">60</td></tr><tr><td align="left">ITEM005</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:05:00</code></td><td align="left">40</td><td align="left">60</td></tr><tr><td align="left">ITEM006</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:06:00</code></td><td align="left">20</td><td align="left">60</td></tr><tr><td align="left">ITEM007</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:07:00</code></td><td align="left">70</td><td align="left">70</td></tr><tr><td align="left">ITEM008</td><td align="left">Clothes</td><td align="left"><code>2017-11-11 10:08:00</code></td><td align="left">20</td><td align="left">20</td></tr></tbody></table> 
<h4><a id="RANGE_OVER_Window_530"></a>RANGE OVER Window语义</h4> 
<h5><a id="_532"></a>窗口数据</h5> 
<p>RANGE OVER Window所有具有共同元素值（元素时间戳）的元素行确定一个窗口，RANGE OVER Window分为Unbounded和Bounded的两种情况。</p> 
<p>Unbounded RANGE OVER Window数据示例如下图所示。</p> 
<p><img src="https://images2.imgbox.com/80/41/6eWtylIh_o.png" alt="img"></p> 
<blockquote> 
 <p>上图所示窗口user1的w7、user2的窗口w3，两个元素同一时刻到达，属于相同的window，这一点与ROWS OVER Window不同。</p> 
</blockquote> 
<p>Bounded RANGE OVER Window数据，以3秒中数据<code>(INTERVAL '2' SECOND)</code>的窗口为例，如下图所示。</p> 
<p><img src="https://images2.imgbox.com/b7/87/C2tG0oyD_o.png" alt="img"></p> 
<blockquote> 
 <p>上图所示窗口user1的w6、user2的窗口w3，元素都是同一时刻到达，属于相同的window，这一点与ROWS OVER Window不同。</p> 
</blockquote> 
<h5><a id="_548"></a>窗口语法</h5> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    agg1<span class="token punctuation">(</span>col1<span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span>
     <span class="token punctuation">[</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>value_expression1<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> value_expressionN<span class="token punctuation">)</span><span class="token punctuation">]</span>
     <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> timeCol
     RANGE 
     <span class="token operator">BETWEEN</span> <span class="token punctuation">(</span><span class="token keyword">UNBOUNDED</span> <span class="token operator">|</span> timeInterval<span class="token punctuation">)</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> colName<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">FROM</span> Tab1<span class="token punctuation">;</span>
</code></pre> 
<ul><li>value_expression：进行分区的字表达式。</li><li>timeCol：元素排序的时间字段。</li><li>timeInterval：定义根据当前行开始向前追溯指定时间的元素行。</li></ul> 
<h5><a id="_565"></a>案例</h5> 
<p>Bounded RANGE OVER Window场景示例：假设一张商品上架表，包含有商品ID、商品类型、商品上架时间、商品价格数据。需要求比当前商品上架时间早2分钟的同类商品中的最高价格。</p> 
<h6><a id="_569"></a>测试数据</h6> 
<table><thead><tr><th align="left">商品ID</th><th align="left">商品类型</th><th align="left">上架时间</th><th align="left">销售价格</th></tr></thead><tbody><tr><td align="left">ITEM001</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:01:00</code></td><td align="left">20</td></tr><tr><td align="left">ITEM002</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:02:00</code></td><td align="left">50</td></tr><tr><td align="left">ITEM003</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:03:00</code></td><td align="left">30</td></tr><tr><td align="left">ITEM004</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:03:00</code></td><td align="left">60</td></tr><tr><td align="left">ITEM005</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:05:00</code></td><td align="left">40</td></tr><tr><td align="left">ITEM006</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:06:00</code></td><td align="left">20</td></tr><tr><td align="left">ITEM007</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:07:00</code></td><td align="left">70</td></tr><tr><td align="left">ITEM008</td><td align="left">Clothes</td><td align="left"><code>2017-11-11 10:08:00</code></td><td align="left">20</td></tr></tbody></table> 
<h6><a id="_582"></a>测试代码</h6> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tmall_item<span class="token punctuation">(</span>
   itemID <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
   itemType <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>
   onSellTime <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>
   price <span class="token keyword">DOUBLE</span><span class="token punctuation">,</span>
   WATERMARK onSellTime <span class="token keyword">FOR</span> onSellTime <span class="token keyword">as</span> withOffset<span class="token punctuation">(</span>onSellTime<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> 
<span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'sls'</span><span class="token punctuation">,</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span>  
    itemID<span class="token punctuation">,</span>
    itemType<span class="token punctuation">,</span> 
    onSellTime<span class="token punctuation">,</span> 
    price<span class="token punctuation">,</span>  
    <span class="token function">MAX</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
        <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> itemType 
        <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> onSellTime 
        RANGE <span class="token operator">BETWEEN</span> <span class="token keyword">INTERVAL</span> <span class="token string">'2'</span> <span class="token keyword">MINUTE</span> <span class="token keyword">preceding</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> maxPrice
  <span class="token keyword">FROM</span> tmall_item<span class="token punctuation">;</span>          
</code></pre> 
<h6><a id="_609"></a>测试结果</h6> 
<table><thead><tr><th align="left">itemID</th><th align="left">itemType</th><th align="left">onSellTime</th><th align="left">price</th><th align="left">maxPrice</th></tr></thead><tbody><tr><td align="left">ITEM001</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:01:00</code></td><td align="left">20</td><td align="left">20</td></tr><tr><td align="left">ITEM002</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:02:00</code></td><td align="left">50</td><td align="left">50</td></tr><tr><td align="left">ITEM003</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:03:00</code></td><td align="left">30</td><td align="left">50</td></tr><tr><td align="left">ITEM004</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:03:00</code></td><td align="left">60</td><td align="left">60</td></tr><tr><td align="left">ITEM005</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:05:00</code></td><td align="left">40</td><td align="left">60</td></tr><tr><td align="left">ITEM006</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:06:00</code></td><td align="left">20</td><td align="left">40</td></tr><tr><td align="left">ITEM007</td><td align="left">Electronic</td><td align="left"><code>2017-11-11 10:07:00</code></td><td align="left">70</td><td align="left">70</td></tr><tr><td align="left">ITEM008</td><td align="left">Clothes</td><td align="left"><code>2017-11-11 10:08:00</code></td><td align="left">20</td><td align="left">20</td></tr></tbody></table> 
<p>参考文献：https://help.aliyun.com/document_detail/62492.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/af72b7a35d88f5f52afdf15ce48a38e6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决git pull/push每次都需要输入密码问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a972296f6ffaa727b5ba060dd0101f95/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【OpenCV 】Ubuntu系统下配置安装OpenCV开发环境</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>