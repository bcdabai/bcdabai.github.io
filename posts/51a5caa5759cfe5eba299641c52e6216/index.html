<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>人大金仓KingbaseES 中truncate和oracle中truncate区别 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="人大金仓KingbaseES 中truncate和oracle中truncate区别" />
<meta property="og:description" content="truncate命令在KingbaseES中本质上区别于oracle。因为oracle中，数据文件datafile可以被表所共享，每张表被分配各自的连续的extents。而在KingbaseES中，数据文件是独立的，不同表不存在共享数据文件的说法。
下面我们看一下KingbaseES数据库在内部怎么实现的truncate命令。
createtable t4 asselect*from t3; insertinto t4 select*from t4; insertinto t4 select*from t4; insertinto t4 select*from t4; insertinto t4 select*from t4; insertinto t4 select*from t4; selectcount(*) from t4; vacuum t4; select relfilenode from sys_class where relname=&#39;t4&#39;; select pg_relation_filepath(&#39;t4&#39;); [kingbase@localhost16052]$ ll 252980*-rw------- 1 kingbase kingbase 8192 Oct 19 10:47 252980-rw------- 1 kingbase kingbase 24576 Oct 19 10:47 252980_fsm-rw------- 1 kingbase kingbase 8192 Oct 19 10:47 252980_vm 下面开启事务执行
begin; truncatetable t4; selectcount(*) from t4; select relfilenode from sys_class where relname=&#39;t4&#39;; 这时候 relfilenode变成了252983,大小是0的对象，而原来的relfilenode 250980 还在，大小不变。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/51a5caa5759cfe5eba299641c52e6216/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-11T17:06:49+08:00" />
<meta property="article:modified_time" content="2023-01-11T17:06:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">人大金仓KingbaseES 中truncate和oracle中truncate区别</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="kdocs-document"> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">truncate命令在KingbaseES中本质上区别于oracle。因为oracle中，数据文件datafile可以被表所共享，每张表被分配各自的连续的extents。而在KingbaseES中，数据文件是独立的，不同表不存在共享数据文件的说法。</span></p> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">下面我们看一下KingbaseES数据库在内部怎么实现的truncate命令。</span></p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">createtable t4 asselect*from t3;
insertinto t4 select*from t4;
insertinto t4 select*from t4;
insertinto t4 select*from t4;
insertinto t4 select*from t4;
insertinto t4 select*from t4;
selectcount(*) from t4;

vacuum t4;
select relfilenode from sys_class where relname='t4';
select pg_relation_filepath('t4');

[kingbase@localhost16052]$ ll 252980*-rw------- 1 kingbase kingbase 8192 Oct 19 10:47 252980-rw------- 1 kingbase kingbase 24576 Oct 19 10:47 252980_fsm-rw------- 1 kingbase kingbase 8192 Oct 19 10:47 252980_vm</code></pre> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">下面开启事务执行</span></p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">begin;
truncatetable t4;
selectcount(*) from t4;
select relfilenode from sys_class where relname='t4';</code></pre> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">这时候 relfilenode变成了252983,大小是0的对象，而原来的relfilenode 250980 还在，大小不变。</span></p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">[kingbase@localhost16052]$ ll 252980*-rw------- 1 kingbase kingbase 8192 Oct 19 10:47 252980-rw------- 1 kingbase kingbase 24576 Oct 19 10:47 252980_fsm-rw------- 1 kingbase kingbase 8192 Oct 19 10:47 252980_vm
You have mail in/var/spool/mail/kingbase
[kingbase@localhost16052]$ ll 252983*-rw------- 1 kingbase kingbase 0 Oct 19 10:48 252983</code></pre> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">看看回滚会发生什么</span></p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">test=# rollback;
ROLLBACK
test=# selectcount(*) from t4;
count
\-------160
(1row)

test=# select relfilenode from sys_class where relname='t4';
relfilenode
\-------------252980
(1row)
[kingbase@localhost16052]$ ll 252980*252983*
ls: cannot access 252983*: No such file or directory
-rw------- 1 kingbase kingbase 8192 Oct 19 10:49 252980-rw------- 1 kingbase kingbase 24576 Oct 19 10:49 252980_fsm-rw------- 1 kingbase kingbase 8192 Oct 19 10:49 252980_vm</code></pre> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">可以看到</span></p> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">1，数据恢复成原来的，并且relfilenode变成了原来的252980.KingbaseES数据库的truncate可以回滚。而oracle中的truncate不能回滚。</span></p> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">2，因为回滚继续使用对象252980，那么252983就被删除了，因为事务已经结束了，252983也就用不到了。</span></p> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">下面不开启事务，truncate不运行在事务块里测试一下</span></p> 
 <pre class="kdocs-plaintext"><code class="language-plaintext">truncatetable t4;
select relfilenode from sys_class where relname='t4';
relfilenode
\-------------252984

[kingbase@localhost16052]$ ll 252980*252983*252984*
ls: cannot access 252983*: No such file or directory
-rw------- 1 kingbase kingbase 0 Oct 19 10:58 252980-rw------- 1 kingbase kingbase 0 Oct 19 10:58 252984

[kingbase@localhost16052]$ ll 252980*252984*
ls: cannot access 252980*: No such file or directory
-rw------- 1 kingbase kingbase 0 Oct 19 10:58 252984</code></pre> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">1，我先后查看两次relfilenode，可以看到最开始能查到truncate前的252980，但是无论怎样它的大小已经变成0，这时候可以判断已经没办法回滚了，当再次查询发现252980被删除了，只剩下252984</span></p> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">因为没法利用252980回滚了，所以可以被数据库删除掉了。最后只能查到最新的对象号252984</span></p> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">2，经过多次测试发现有时候老的对象号252980并不是立即被删除，我想应该和数据库有自己的删除机制有关。总之，这个老的对象号已经没有用了。</span></p> 
 <h3 style="text-align:left;"><span class="kdocs-bold" style="font-weight:bold;">总结：</span></h3> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">当truncate命令在事务块里可回滚。而truncate可回滚无疑对业务有一些帮助。根据KingbaseES和oracle对于truncate的内存原理不同，我们可以理解KingbaseES中truncate的代价很小，因为KingbaseES中的truncate不会存在存储空间重用的问题，也没有触发对象级检查点的操作，当进行truncate时候不会对业务产生太大影响，在业务运行期间我们可以使用truncate及时恢复一些存储空间。</span></p> 
 <p style="text-align:null;"><span class="kdocs-fontSize" style="font-size:9pt;">需要注意的是如果truncate命令和另外的session对于正在truncate的表有操作（包括Select），那么很可能会有锁冲突，虽然这种可能性很小，但还是要注意。</span></p> 
 <p style=""></p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f70a42c931b6ea00c264453eadfe9bcd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">less命令详解-最好用的文档查看命令</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dc5233379b25e55e2fcfc305f0918370/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【高级人工智能】国科大《高级人工智能》联结主义 笔记 &#43; 考试回忆</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>