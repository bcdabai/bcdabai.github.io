<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>oracle recs,Oracle SQL精妙SQL语句讲解（转） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="oracle recs,Oracle SQL精妙SQL语句讲解（转）" />
<meta property="og:description" content="Oracle SQL精妙SQL语句讲解[@more@]好东西，大家赶紧收藏吧~~~
--行列转换 行转列
DROP TABLE t_change_lc;
CREATE TABLE t_change_lc (card_code VARCHAR2(3), q NUMBER, bal NUMBER);
INSERT INTO t_change_lc
SELECT &#39;001&#39; card_code, ROWNUM q, trunc(dbms_random.VALUE * 100) bal FROM dual CONNECT BY ROWNUM &lt;= 4
UNION
SELECT &#39;002&#39; card_code, ROWNUM q, trunc(dbms_random.VALUE * 100) bal FROM dual CONNECT BY ROWNUM &lt;= 4;
SELECT * FROM t_change_lc;
SELECT a.card_code,
SUM(decode(a.q, 1, a.bal, 0)) q1,
SUM(decode(a.q, 2, a.bal, 0)) q2,
SUM(decode(a.q, 3, a." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/4bf9f8719fb99558e1658ecec5b87e45/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-06T15:59:34+08:00" />
<meta property="article:modified_time" content="2021-04-06T15:59:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">oracle recs,Oracle SQL精妙SQL语句讲解（转）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>Oracle SQL精妙SQL语句讲解[@more@]好东西，大家赶紧收藏吧~~~</p> 
 <p>--行列转换 行转列</p> 
 <p>DROP TABLE t_change_lc;</p> 
 <p>CREATE TABLE t_change_lc (card_code VARCHAR2(3), q NUMBER, bal NUMBER);</p> 
 <p>INSERT INTO t_change_lc</p> 
 <p>SELECT '001' card_code, ROWNUM q, trunc(dbms_random.VALUE * 100) bal FROM dual CONNECT BY ROWNUM &lt;= 4</p> 
 <p>UNION</p> 
 <p>SELECT '002' card_code, ROWNUM q, trunc(dbms_random.VALUE * 100) bal FROM dual CONNECT BY ROWNUM &lt;= 4;</p> 
 <p>SELECT * FROM t_change_lc;</p> 
 <p>SELECT a.card_code,</p> 
 <p>SUM(decode(a.q, 1, a.bal, 0)) q1,</p> 
 <p>SUM(decode(a.q, 2, a.bal, 0)) q2,</p> 
 <p>SUM(decode(a.q, 3, a.bal, 0)) q3,</p> 
 <p>SUM(decode(a.q, 4, a.bal, 0)) q4</p> 
 <p>FROM t_change_lc a</p> 
 <p>GROUP BY a.card_code</p> 
 <p>ORDER BY 1;</p> 
 <p>--行列转换 列转行</p> 
 <p>DROP TABLE t_change_cl;</p> 
 <p>CREATE TABLE t_change_cl AS</p> 
 <p>SELECT a.card_code,</p> 
 <p>SUM(decode(a.q, 1, a.bal, 0)) q1,</p> 
 <p>SUM(decode(a.q, 2, a.bal, 0)) q2,</p> 
 <p>SUM(decode(a.q, 3, a.bal, 0)) q3,</p> 
 <p>SUM(decode(a.q, 4, a.bal, 0)) q4</p> 
 <p>FROM t_change_lc a</p> 
 <p>GROUP BY a.card_code</p> 
 <p>ORDER BY 1;</p> 
 <p>SELECT * FROM t_change_cl;</p> 
 <p>SELECT t.card_code,</p> 
 <p>t.rn q,</p> 
 <p>decode(t.rn, 1, t.q1, 2, t.q2, 3, t.q3, 4, t.q4) bal</p> 
 <p>FROM (SELECT a.*, b.rn</p> 
 <p>FROM t_change_cl a,</p> 
 <p>(SELECT ROWNUM rn FROM dual CONNECT BY ROWNUM &lt;= 4) b) t</p> 
 <p>ORDER BY 1, 2;</p> 
 <p>--行列转换 行转列 合并</p> 
 <p>DROP TABLE t_change_lc_comma;</p> 
 <p>CREATE TABLE t_change_lc_comma AS SELECT card_code,'quarter_'||q AS q FROM t_change_lc;</p> 
 <p>SELECT * FROM t_change_lc_comma;</p> 
 <p>SELECT t1.card_code, substr(MAX(sys_connect_by_path(t1.q, ';')), 2) q</p> 
 <p>FROM (SELECT a.card_code,</p> 
 <p>a.q,</p> 
 <p>row_number() over(PARTITION BY a.card_code ORDER BY a.q) rn</p> 
 <p>FROM t_change_lc_comma a) t1</p> 
 <p>START WITH t1.rn = 1</p> 
 <p>CONNECT BY t1.card_code = PRIOR t1.card_code</p> 
 <p>AND t1.rn - 1 = PRIOR t1.rn</p> 
 <p>GROUP BY t1.card_code;</p> 
 <p>--行列转换 列转行 分割</p> 
 <p>DROP TABLE t_change_cl_comma;</p> 
 <p>CREATE TABLE t_change_cl_comma AS</p> 
 <p>SELECT t1.card_code, substr(MAX(sys_connect_by_path(t1.q, ';')), 2) q</p> 
 <p>FROM (SELECT a.card_code,</p> 
 <p>a.q,</p> 
 <p>row_number() over(PARTITION BY a.card_code ORDER BY a.q) rn</p> 
 <p>FROM t_change_lc_comma a) t1</p> 
 <p>START WITH t1.rn = 1</p> 
 <p>CONNECT BY t1.card_code = PRIOR t1.card_code</p> 
 <p>AND t1.rn - 1 = PRIOR t1.rn</p> 
 <p>GROUP BY t1.card_code;</p> 
 <p>SELECT * FROM t_change_cl_comma;</p> 
 <p>SELECT t.card_code,</p> 
 <p>substr(t.q,</p> 
 <p>instr(';' || t.q, ';', 1, rn),</p> 
 <p>instr(t.q || ';', ';', 1, rn) - instr(';' || t.q, ';', 1, rn)) q</p> 
 <p>FROM (SELECT a.card_code, a.q, b.rn</p> 
 <p>FROM t_change_cl_comma a,</p> 
 <p>(SELECT ROWNUM rn FROM dual CONNECT BY ROWNUM &lt;= 100) b</p> 
 <p>WHERE instr(';' || a.q, ';', 1, rn) &gt; 0) t</p> 
 <p>ORDER BY 1, 2;</p> 
 <p>-- 实现一条记录根据条件多表插入</p> 
 <p>DROP TABLE t_ia_src;</p> 
 <p>CREATE TABLE t_ia_src AS SELECT 'a'||ROWNUM c1, 'b'||ROWNUM c2 FROM dual CONNECT BY ROWNUM&lt;=5;</p> 
 <p>DROP TABLE t_ia_dest_1;</p> 
 <p>CREATE TABLE t_ia_dest_1(flag VARCHAR2(10) , c VARCHAR2(10));</p> 
 <p>DROP TABLE t_ia_dest_2;</p> 
 <p>CREATE TABLE t_ia_dest_2(flag VARCHAR2(10) , c VARCHAR2(10));</p> 
 <p>DROP TABLE t_ia_dest_3;</p> 
 <p>CREATE TABLE t_ia_dest_3(flag VARCHAR2(10) , c VARCHAR2(10));</p> 
 <p>SELECT * FROM t_ia_src;</p> 
 <p>SELECT * FROM t_ia_dest_1;</p> 
 <p>SELECT * FROM t_ia_dest_2;</p> 
 <p>SELECT * FROM t_ia_dest_3;</p> 
 <p>INSERT ALL</p> 
 <p>WHEN (c1 IN ('a1','a3')) THEN</p> 
 <p>INTO t_ia_dest_1(flag,c) VALUES(flag1,c2)</p> 
 <p>WHEN (c1 IN ('a2','a4')) THEN</p> 
 <p>INTO t_ia_dest_2(flag,c) VALUES(flag2,c2)</p> 
 <p>ELSE</p> 
 <p>INTO t_ia_dest_3(flag,c) VALUES(flag1||flag2,c1||c2)</p> 
 <p>SELECT c1,c2, 'f1' flag1, 'f2' flag2 FROM t_ia_src;</p> 
 <p>-- 如果存在就更新，不存在就插入用一个语句实现</p> 
 <p>DROP TABLE t_mg;</p> 
 <p>CREATE TABLE t_mg(code VARCHAR2(10), NAME VARCHAR2(10));</p> 
 <p>SELECT * FROM t_mg;</p> 
 <p>MERGE INTO t_mg a</p> 
 <p>USING (SELECT 'the code' code, 'the name' NAME FROM dual) b</p> 
 <p>ON (a.code = b.code)</p> 
 <p>WHEN MATCHED THEN</p> 
 <p>UPDATE SET a.NAME = b.NAME</p> 
 <p>WHEN NOT MATCHED THEN</p> 
 <p>INSERT (code, NAME) VALUES (b.code, b.NAME);</p> 
 <p>-- 抽取/删除重复记录</p> 
 <p>DROP TABLE t_dup;</p> 
 <p>CREATE TABLE t_dup AS SELECT 'code_'||ROWNUM code, dbms_random.string('z',5) NAME FROM dual CONNECT BY ROWNUM&lt;=10;</p> 
 <p>INSERT INTO t_dup SELECT 'code_'||ROWNUM code, dbms_random.string('z',5) NAME FROM dual CONNECT BY ROWNUM&lt;=2;</p> 
 <p>SELECT * FROM t_dup;</p> 
 <p>SELECT * FROM t_dup a WHERE a.ROWID &lt;&gt; (SELECT MIN(b.ROWID) FROM t_dup b WHERE a.code=b.code);</p> 
 <p>SELECT b.code, b.NAME</p> 
 <p>FROM (SELECT a.code,</p> 
 <p>a.NAME,</p> 
 <p>row_number() over(PARTITION BY a.code ORDER BY a.ROWID) rn</p> 
 <p>FROM t_dup a) b</p> 
 <p>WHERE b.rn &gt; 1;</p> 
 <p>-- IN/EXISTS的不同适用环境</p> 
 <p>-- t_orders.customer_id有索引</p> 
 <p>SELECT a.*</p> 
 <p>FROM t_employees a</p> 
 <p>WHERE a.employee_id IN</p> 
 <p>(SELECT b.sales_rep_id FROM t_orders b WHERE b.customer_id = 12);</p> 
 <p>SELECT a.*</p> 
 <p>FROM t_employees a</p> 
 <p>WHERE EXISTS (SELECT 1</p> 
 <p>FROM t_orders b</p> 
 <p>WHERE b.customer_id = 12</p> 
 <p>AND a.employee_id = b.sales_rep_id);</p> 
 <p>-- t_employees.department_id有索引</p> 
 <p>SELECT a.*</p> 
 <p>FROM t_employees a</p> 
 <p>WHERE a.department_id = 10</p> 
 <p>AND EXISTS</p> 
 <p>(SELECT 1 FROM t_orders b WHERE a.employee_id = b.sales_rep_id);</p> 
 <p>SELECT a.*</p> 
 <p>FROM t_employees a</p> 
 <p>WHERE a.department_id = 10</p> 
 <p>AND a.employee_id IN (SELECT b.sales_rep_id FROM t_orders b);</p> 
 <p>-- FBI</p> 
 <p>DROP TABLE t_fbi;</p> 
 <p>CREATE TABLE t_fbi AS</p> 
 <p>SELECT ROWNUM rn, dbms_random.STRING('z',10) NAME , SYSDATE + dbms_random.VALUE * 10 dt FROM dual</p> 
 <p>CONNECT BY ROWNUM &lt;=10;</p> 
 <p>CREATE INDEX idx_nonfbi ON t_fbi(dt);</p> 
 <p>DROP INDEX idx_fbi_1;</p> 
 <p>CREATE INDEX idx_fbi_1 ON t_fbi(trunc(dt));</p> 
 <p>SELECT * FROM t_fbi WHERE trunc(dt) = to_date('2006-09-21','yyyy-mm-dd') ;</p> 
 <p>-- 不建议使用</p> 
 <p>SELECT * FROM t_fbi WHERE to_char(dt, 'yyyy-mm-dd') = '2006-09-21';</p> 
 <p>-- LOOP中的COMMIT/ROLLBACK</p> 
 <p>DROP TABLE t_loop PURGE;</p> 
 <p>create TABLE t_loop AS SELECT * FROM user_objects WHERE 1=2;</p> 
 <p>SELECT * FROM t_loop;</p> 
 <p>-- 逐行提交</p> 
 <p>DECLARE</p> 
 <p>BEGIN</p> 
 <p>FOR cur IN (SELECT * FROM user_objects) LOOP</p> 
 <p>INSERT INTO t_loop VALUES cur;</p> 
 <p>COMMIT;</p> 
 <p>END LOOP;</p> 
 <p>END;</p> 
 <p>-- 模拟批量提交</p> 
 <p>DECLARE</p> 
 <p>v_count NUMBER;</p> 
 <p>BEGIN</p> 
 <p>FOR cur IN (SELECT * FROM user_objects) LOOP</p> 
 <p>INSERT INTO t_loop VALUES cur;</p> 
 <p>v_count := v_count + 1;</p> 
 <p>IF v_count &gt;= 100 THEN</p> 
 <p>COMMIT;</p> 
 <p>END IF;</p> 
 <p>END LOOP;</p> 
 <p>COMMIT;</p> 
 <p>END;</p> 
 <p>-- 真正的批量提交</p> 
 <p>DECLARE</p> 
 <p>CURSOR cur IS</p> 
 <p>SELECT * FROM user_objects;</p> 
 <p>TYPE rec IS TABLE OF user_objects%ROWTYPE;</p> 
 <p>recs rec;</p> 
 <p>BEGIN</p> 
 <p>OPEN cur;</p> 
 <p>WHILE (TRUE) LOOP</p> 
 <p>FETCH cur BULK COLLECT</p> 
 <p>INTO recs LIMIT 100;</p> 
 <p>-- forall 实现批量</p> 
 <p>FORALL i IN 1 .. recs.COUNT</p> 
 <p>INSERT INTO t_loop VALUES recs (i);</p> 
 <p>COMMIT;</p> 
 <p>EXIT WHEN cur%NOTFOUND;</p> 
 <p>END LOOP;</p> 
 <p>CLOSE cur;</p> 
 <p>END;</p> 
 <p>-- 悲观锁定/乐观锁定</p> 
 <p>DROP TABLE t_lock PURGE;</p> 
 <p>CREATE TABLE t_lock AS SELECT 1 ID FROM dual;</p> 
 <p>SELECT * FROM t_lock;</p> 
 <p>-- 常见的实现逻辑，隐含bug</p> 
 <p>DECLARE</p> 
 <p>v_cnt NUMBER;</p> 
 <p>BEGIN</p> 
 <p>-- 这里有并发性的bug</p> 
 <p>SELECT MAX(ID) INTO v_cnt FROM t_lock;</p> 
 <p>-- here for other operation</p> 
 <p>v_cnt := v_cnt + 1;</p> 
 <p>INSERT INTO t_lock (ID) VALUES (v_cnt);</p> 
 <p>COMMIT;</p> 
 <p>END;</p> 
 <p>-- 高并发环境下，安全的实现逻辑</p> 
 <p>DECLARE</p> 
 <p>v_cnt NUMBER;</p> 
 <p>BEGIN</p> 
 <p>-- 对指定的行取得lock</p> 
 <p>SELECT ID INTO v_cnt FROM t_lock WHERE ID=1 FOR UPDATE;</p> 
 <p>-- 在有lock的情况下继续下面的操作</p> 
 <p>SELECT MAX(ID) INTO v_cnt FROM t_lock;</p> 
 <p>-- here for other operation</p> 
 <p>v_cnt := v_cnt + 1;</p> 
 <p>INSERT INTO t_lock (ID) VALUES (v_cnt);</p> 
 <p>COMMIT; --提交并且释放lock</p> 
 <p>END;</p> 
 <p>-- 硬解析/软解析</p> 
 <p>DROP TABLE t_hard PURGE;</p> 
 <p>CREATE TABLE t_hard (ID INT);</p> 
 <p>SELECT * FROM t_hard;</p> 
 <p>DECLARE</p> 
 <p>sql_1 VARCHAR2(200);</p> 
 <p>BEGIN</p> 
 <p>-- hard parse</p> 
 <p>-- java中的同等语句是 Statement.execute()</p> 
 <p>FOR i IN 1 .. 1000 LOOP</p> 
 <p>sql_1 := 'insert into t_hard(id) values(' || i || ')';</p> 
 <p>EXECUTE IMMEDIATE sql_1;</p> 
 <p>END LOOP;</p> 
 <p>COMMIT;</p> 
 <p>-- soft parse</p> 
 <p>--java中的同等语句是 PreparedStatement.execute()</p> 
 <p>sql_1 := 'insert into t_hard(id) values(:id)';</p> 
 <p>FOR i IN 1 .. 1000 LOOP</p> 
 <p>EXECUTE IMMEDIATE sql_1</p> 
 <p>USING i;</p> 
 <p>END LOOP;</p> 
 <p>COMMIT;</p> 
 <p>END;</p> 
 <p>-- 正确的分页算法</p> 
 <p>SELECT *</p> 
 <p>FROM (SELECT a.*, ROWNUM rn</p> 
 <p>FROM (SELECT * FROM t_employees ORDER BY first_name) a</p> 
 <p>WHERE ROWNUM &lt;= 500)</p> 
 <p>WHERE rn &gt; 480 ;</p> 
 <p>-- 分页算法(why not this one)</p> 
 <p>SELECT a.*, ROWNUM rn</p> 
 <p>FROM (SELECT * FROM t_employees ORDER BY first_name) a</p> 
 <p>WHERE ROWNUM &lt;= 500 AND ROWNUM &gt; 480;</p> 
 <p>-- 分页算法(why not this one)</p> 
 <p>SELECT b.*</p> 
 <p>FROM (SELECT a.*, ROWNUM rn</p> 
 <p>FROM t_employees a</p> 
 <p>WHERE ROWNUM &lt; = 500</p> 
 <p>ORDER BY first_name) b</p> 
 <p>WHERE b.rn &gt; 480;</p> 
 <p>-- OLAP</p> 
 <p>-- 小计合计</p> 
 <p>SELECT CASE</p> 
 <p>WHEN a.deptno IS NULL THEN</p> 
 <p>'合计'</p> 
 <p>WHEN a.deptno IS NOT NULL AND a.empno IS NULL THEN</p> 
 <p>'小计'</p> 
 <p>ELSE</p> 
 <p>'' || a.deptno</p> 
 <p>END deptno,</p> 
 <p>a.empno,</p> 
 <p>a.ename,</p> 
 <p>SUM(a.sal) total_sal</p> 
 <p>FROM scott.emp a</p> 
 <p>GROUP BY GROUPING SETS((a.deptno),(a.deptno, a.empno, a.ename),());</p> 
 <p>-- 分组排序</p> 
 <p>SELECT a.deptno,</p> 
 <p>a.empno,</p> 
 <p>a.ename,</p> 
 <p>a.sal,</p> 
 <p>-- 可跳跃的rank</p> 
 <p>rank() over(PARTITION BY a.deptno ORDER BY a.sal DESC) r1,</p> 
 <p>-- 密集型rank</p> 
 <p>dense_rank() over(PARTITION BY a.deptno ORDER BY a.sal DESC) r2,</p> 
 <p>-- 不分组排序</p> 
 <p>rank() over(ORDER BY sal DESC) r3</p> 
 <p>FROM scott.emp a</p> 
 <p>ORDER BY a.deptno,a.sal DESC;</p> 
 <p>-- 当前行数据和前/后n行的数据比较</p> 
 <p>SELECT a.empno,</p> 
 <p>a.ename,</p> 
 <p>a.sal,</p> 
 <p>-- 上面一行</p> 
 <p>lag(a.sal) over(ORDER BY a.sal DESC) lag_1,</p> 
 <p>-- 下面三行</p> 
 <p>lead(a.sal, 3) over(ORDER BY a.sal DESC) lead_3</p> 
 <p>FROM scott.emp a</p> 
 <p>ORDER BY a.sal DESC;</p> 
 <p>来自 “ ITPUB博客 ” ，链接：http://blog.itpub.net/10172717/viewspace-920997/，如需转载，请注明出处，否则将追究法律责任。</p> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dc6c18895f7a9669a88ed5ac4c5d4431/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">黑马RabbitMQ初级学习笔记</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/286b2322dc6c88e03841b1942206aa5b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">达梦数据库用户和表空间常用SQL语句</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>