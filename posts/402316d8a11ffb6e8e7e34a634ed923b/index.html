<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>H264编解码实战 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="H264编解码实战" />
<meta property="og:description" content="一、H264中的profile和level H264 Profile：对视频压缩特性的描述，Profile越高，就说明采用了越高级的压缩特性；H264 Level：Level是对视频的描述，Level越高，视频的码率、分辨率、fps越高。
二、H264 SPS中的重要参数 分辨率：
帧相关：
log2_max_frame_num_minus4：用于计算MaxFrameNum的值。计算公式为MaxFrameNum = 2^(log2_max_frame_num_minus4 &#43; 4)。MaxFrameNum是frame_num的上限值，frame_num是图像序号的一种表示方法，在帧间编码中常用作一种参考帧标记的手段。值得注意的是 frame_num 是循环计数的，即当它到达 MaxFrameNum 后又从 0 重新开始新一轮的计数。 解码器必须要有机制检测这种循环， 不然会引起类似千年虫的问题，在图像的顺序上造成混乱。pic_order_cnt_type：指明了 poc (picture order count) 的编码方法， poc 标识图像的播放顺序。由于H.264 使用了 B 帧预测，使得图像的解码顺序并不一定等于播放顺序，但它们之间存在一定的映射关系。 poc 可以由 frame-num 通过映射关系计算得来，也可以索性由编码器显式地传送。 H.264 中一共定义了三种 poc 的编码方法，这个句法元素就是用来通知解码器该用哪种方法来计算 poc。max_num_ref_frames：指定参考帧队列可能达到的最大长度，解码器依照这个句法元素的值开辟存储区，这个存储区用于存放已解码的参考帧， H.264 规定最多可用 16 个参考帧，本句法元素的值最大为 16。值得注意的是这个长度以帧为单位，如果在场模式下，应该相应地扩展一倍。 帧率的计算：
framerate = (float)(sps-&gt;vui.vui_time_scale) / (float)(sps-&gt;vui.vui_num_units_in_tick) / 2; 三、H264 PPS与Slice-Header PPS：
Slice Header：
帧类型GOP中解码帧序号预测权重滤波 四、H264分析工具 Electra Stream Eye（付费）CodecVisa（付费）雷神开发的工具（免费） elecard下载地址：
https://www.elecard.com/products/video-analysis
雷神：
https://sourceforge.net/projects/videoeye/files
工具详细的使用说明可以参考雷神写的博客：
https://blog.csdn.net/leixiaohua1020/article/details/34553607" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/402316d8a11ffb6e8e7e34a634ed923b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-20T11:42:18+08:00" />
<meta property="article:modified_time" content="2022-04-20T11:42:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">H264编解码实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="H264profilelevel_0"></a>一、H264中的profile和level</h2> 
<ul><li>H264 Profile：对视频压缩特性的描述，Profile越高，就说明采用了越高级的压缩特性；</li><li>H264 Level：Level是对视频的描述，Level越高，视频的码率、分辨率、fps越高。<br> <img src="https://images2.imgbox.com/8d/80/Cy6eQXkr_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f6/f2/vOrvJgNv_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dd/6a/Eils3WdH_o.png" alt="在这里插入图片描述"></li></ul> 
<h2><a id="H264_SPS_7"></a>二、H264 SPS中的重要参数</h2> 
<p><strong>分辨率：</strong><br> <img src="https://images2.imgbox.com/6c/5a/ysdaKwby_o.png" alt="在这里插入图片描述"><br> <strong>帧相关：</strong></p> 
<ul><li>log2_max_frame_num_minus4：用于计算MaxFrameNum的值。计算公式为MaxFrameNum = 2^(log2_max_frame_num_minus4 + 4)。MaxFrameNum是frame_num的上限值，frame_num是图像序号的一种表示方法，在帧间编码中常用作一种参考帧标记的手段。值得注意的是 frame_num 是循环计数的，即当它到达 MaxFrameNum 后又从 0 重新开始新一轮的计数。 解码器必须要有机制检测这种循环， 不然会引起类似千年虫的问题，在图像的顺序上造成混乱。</li><li>pic_order_cnt_type：指明了 poc (picture order count) 的编码方法， poc 标识图像的播放顺序。由于H.264 使用了 B 帧预测，使得图像的解码顺序并不一定等于播放顺序，但它们之间存在一定的映射关系。 poc 可以由 frame-num 通过映射关系计算得来，也可以索性由编码器显式地传送。 H.264 中一共定义了三种 poc 的编码方法，这个句法元素就是用来通知解码器该用哪种方法来计算 poc。</li><li>max_num_ref_frames：指定参考帧队列可能达到的最大长度，解码器依照这个句法元素的值开辟存储区，这个存储区用于存放已解码的参考帧， H.264 规定最多可用 16 个参考帧，本句法元素的值最大为 16。值得注意的是这个长度以帧为单位，如果在场模式下，应该相应地扩展一倍。</li></ul> 
<p><strong>帧率的计算：</strong></p> 
<pre><code class="prism language-c">framerate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sps<span class="token operator">-&gt;</span>vui<span class="token punctuation">.</span>vui_time_scale<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sps<span class="token operator">-&gt;</span>vui<span class="token punctuation">.</span>vui_num_units_in_tick<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="H264_PPSSliceHeader_20"></a>三、H264 PPS与Slice-Header</h2> 
<p><strong>PPS：</strong><br> <img src="https://images2.imgbox.com/fb/48/dkQbJ5fM_o.png" alt="在这里插入图片描述"><br> <strong>Slice Header：</strong></p> 
<ul><li>帧类型</li><li>GOP中解码帧序号</li><li>预测权重</li><li>滤波</li></ul> 
<h2><a id="H264_28"></a>四、H264分析工具</h2> 
<ul><li>Electra Stream Eye（付费）</li><li>CodecVisa（付费）</li><li>雷神开发的工具（免费）</li></ul> 
<p><strong>elecard下载地址：</strong><br> <a href="https://www.elecard.com/products/video-analysis" rel="nofollow">https://www.elecard.com/products/video-analysis</a><br> <strong>雷神：</strong><br> <a href="https://sourceforge.net/projects/videoeye/files" rel="nofollow">https://sourceforge.net/projects/videoeye/files</a><br> 工具详细的使用说明可以参考雷神写的博客：<br> <a href="https://blog.csdn.net/leixiaohua1020/article/details/34553607">https://blog.csdn.net/leixiaohua1020/article/details/34553607</a></p> 
<h2><a id="_39"></a>五、视频编码步骤</h2> 
<ul><li>打开编码器</li><li>将采集的数据转换成YUV420P</li><li>准备编码数据AVFrame</li><li>H264编码</li></ul> 
<h2><a id="x264_44"></a>六、x264参数分类</h2> 
<ul><li>预设值</li><li>帧相关参数</li><li>码流的控制</li><li>编码分析</li><li>输出</li></ul> 
<h3><a id="1__51"></a>1. 预设值</h3> 
<ul><li>Preset<br> 默认：medium，在压缩率和运算时间中平衡的预设值。</li><li>Tune<br> 默认：无，在上一个选项基础上进一步优化输入。如果定义了一个tune值，它将在preset之后，其它选项之前生效。</li></ul> 
<h3><a id="2__56"></a>2. 帧相关参数</h3> 
<ul><li>Keyint<br> 默认：250，设置x264输出中最大的IDR帧（也称为关键帧）间距。<br> IDR帧是视频流的“分隔符”，所有帧都不可以使用越过关键帧的帧作为参考帧。IDR帧是I帧的一种，所以它们也不参照其它帧。这意味着它们可以作为视频的搜索（seek）点。<br> 通过这个设置可以设置IDR帧的最大间隔帧数（亦称最大图像组长度）。较大的值将导致IDR帧减少（会用占用空间更少的P帧和B帧取代），也就同时减弱了参照帧选择的限制。较小的值导致减少搜索一个随机帧所需的平均时间。<br> 建议：默认值（fps的10倍）对大多数视频都很好。如果在为蓝光、广播、直播流或者其它什么专业流编码，也许会需要更小的图像组长度（一般等于fps）。</li><li>min-keyint<br> 默认：auto（keyint/10），过小的keyint范围会导致产生“错误的”IDR帧（比如说，一个闪屏场景）。此选项限制了IDR帧之间的最小距离。</li><li>scenecut<br> 默认：40，设置决策使用I帧、IDR帧的阈值（场景变换检测）。x264会计算每一帧与前一帧的不同程度并得出一个值。如果这个值低于scenecut，那么就算检测到一个“场景变换”。如果此时距离上一帧的距离小于 min-keyint则插入一个I帧，反之则插入一个IDR帧。</li><li>bframes<br> 默认：3，设置x264可使用的B帧的最大连续数量。没有B帧时，一个典型的x264流帧类型是这样的：IPPPPP…PI。如果设置了-bframes 2，那么两个连续的P帧就可以用B帧替换，然后就像这样：IBPBBPBPPPB…PI。<br> B帧和P帧的区别在于它可以参照它之后的帧，这个特点让它可以显著地提升压缩率。他们的平均品质受 –pbratio选项的控制。</li><li>ref<br> 默认：3，控制DPB (Decoded Picture Buffer)的大小。可以在0-16之间选择。简单地说，就是设置P帧可以选择它之前的多少帧作为参照帧（B帧的值要小1-2，取决于那个B帧能不能作为参照）。最小可以选择值1，只参照自己前面的那帧。<br> 注意H.264标准限制了每个level可以参照的帧的数量。如果选择level4.1，1080p最大选4，720p最大选9。</li><li>no-deblock<br> 默认：无，完全关闭内置去块滤镜。不推荐使用。</li><li>deblock<br> 默认：0:0，调节H.264标准中的内置去块滤镜。这是个性价比很高的选择。</li><li>no-cabac<br> 默认值：无，停用弹性内容的二进制算数编码（CABAC：Context Adaptive Binary Arithmetic Coder）资料流压缩，切换到效率较低的弹性内容的可变长度编码（CAVLC：Context Adaptive Variable Length Coder）系统。大幅降低压缩效率（通常10~20%）和解码的硬件需求。</li></ul> 
<h3><a id="3__78"></a>3. 流控</h3> 
<ul><li>QP<br> 默认：无，三种速率控制方法之一。QP关注量化器，比crf码流大且与bitrate/crf互斥。</li><li>Bitrate<br> 默认：无，关注码流，无法控制质量</li><li>Crf<br> 默认值：23.0，关注质量，数越低越好。</li><li>Qmin<br> 默认值：10，定义x264可以使用的最小量化值。量化值越小，输出就越接近输入。到了一定的值，x264的输出看起来会跟输入一样，即使它并不完全相同。</li><li>Qmax<br> 默认值：51，定义x264可以使用的最大量化值。默认值51是H.264规格可供使用的最大量化值，而且品质极低。此默认值有效地停用了qpmax。如果想要限制x264可以输出的最低品质，可以将此值设小一点（通常30~40），但通常并不建议调整此值。</li><li>Qpstep<br> 默认值：4，设定两帧之间量化值的最大变更幅度。</li></ul> 
<h3><a id="4__91"></a>4. 编码分析</h3> 
<ul><li>Partitions<br> 默认值：p8x8,b8x8,i8x8,i4x4，H.264视讯在压缩过程中划分为16x16的宏区块。这些区块可以进一步划分为更小的分割，这就是此选项要控制的部分。</li><li>me<br> 默认值：hex，设定全像素（full-pixel）动态估算（motion estimation）的方法。有五个选项：dia（diamond）、hex（hexagon）、umh（uneven multi-hex）、esa（exhaustive）、tesa（transformed exhaustive）。</li></ul> 
<h3><a id="5__96"></a>5. 输出</h3> 
<ul><li>SAR 设置输出的宽高比</li><li>FPS 帧率</li><li>leve</li></ul> 
<p>详细的参数说明可以参考：<br> <a href="https://blog.csdn.net/dxpqxb/article/details/50755485">https://blog.csdn.net/dxpqxb/article/details/50755485</a><br> <a href="http://www.chaneru.com/Roku/HLS/X264_Settings.htm" rel="nofollow">http://www.chaneru.com/Roku/HLS/X264_Settings.htm</a><br> <a href="https://sites.google.com/site/linuxencoding/x264-ffmpeg-mapping" rel="nofollow">https://sites.google.com/site/linuxencoding/x264-ffmpeg-mapping</a></p> 
<h2><a id="_105"></a>七、测试代码示例</h2> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

using namespace std<span class="token punctuation">;</span>

<span class="token comment">//包含ffmpeg头文件</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavutil/avutil.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavdevice/avdevice.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavformat/avformat.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavcodec/avcodec.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libswresample/swresample.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavutil/audio_fifo.h"</span></span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

using std<span class="token operator">::</span>vector<span class="token punctuation">;</span>
using std<span class="token operator">::</span>string<span class="token punctuation">;</span>
using std<span class="token operator">::</span>shared_ptr<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">V_WIDTH</span>  <span class="token expression"><span class="token number">1280</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">V_HEIGHT</span> <span class="token expression"><span class="token number">720</span></span></span>


<span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span>AVCodecContext <span class="token operator">*</span>ctx<span class="token punctuation">,</span>
            AVFrame <span class="token operator">*</span>frame<span class="token punctuation">,</span>
            AVPacket <span class="token operator">*</span>pkt<span class="token punctuation">,</span>
            FILE <span class="token operator">*</span>output<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"send frame to encoder, pts=%lld"</span><span class="token punctuation">,</span> frame<span class="token operator">-&gt;</span>pts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//将数据送到编码器</span>
    ret <span class="token operator">=</span> <span class="token function">avcodec_send_frame</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//如果ret&gt;=0说明数据设置成功</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取编码后的音频数据，如果成功（ret &gt;= 0）需要重复获取，直到失败为止</span>
        ret <span class="token operator">=</span> <span class="token function">avcodec_receive_packet</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span> <span class="token operator">||</span> ret <span class="token operator">==</span> AVERROR_EOF<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Error, encoding audio frame"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//write file</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> static_cast<span class="token operator">&lt;</span><span class="token class-name">size_t</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//刷新缓冲区，使数据写入磁盘</span>
        <span class="token function">fflush</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @brief open audio device
 * @param audio device name
 * @return succ: AVFormatContext*, fail: nullptr
 */</span>
AVFormatContext <span class="token operator">*</span><span class="token function">open_dev</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> errors<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    AVFormatContext <span class="token operator">*</span>fmt_ctx <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    AVDictionary <span class="token operator">*</span>options <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

    <span class="token comment">//get format</span>
    <span class="token comment">//录制摄像头</span>
    string sDeviceName <span class="token operator">=</span> <span class="token string">"video=HD Camera"</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> AVInputFormat <span class="token operator">*</span>iformat <span class="token operator">=</span> <span class="token function">av_find_input_format</span><span class="token punctuation">(</span><span class="token string">"dshow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//录制桌面</span>
    <span class="token comment">//string sDeviceName = "desktop";</span>
    <span class="token comment">//const AVInputFormat *iformat = av_find_input_format("gdigrab");</span>

    <span class="token comment">//录制摄像头</span>
    <span class="token comment">//string sDeviceName = "0";</span>
    <span class="token comment">//const AVInputFormat *iformat = av_find_input_format("vfwcap");</span>

    <span class="token function">av_dict_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>options<span class="token punctuation">,</span> <span class="token string">"video_size"</span><span class="token punctuation">,</span> <span class="token string">"1280x720"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_dict_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>options<span class="token punctuation">,</span> <span class="token string">"framerate"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_dict_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>options<span class="token punctuation">,</span> <span class="token string">"pixel_format"</span><span class="token punctuation">,</span> <span class="token string">"yuyv422"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_dict_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>options<span class="token punctuation">,</span> <span class="token string">"rtbufsize"</span><span class="token punctuation">,</span> <span class="token string">"30412800"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//open device</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmt_ctx<span class="token punctuation">,</span> sDeviceName<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        iformat<span class="token punctuation">,</span> <span class="token operator">&amp;</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">av_strerror</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> errors<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Failed to open video device, [%d]%s\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> fmt_ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @brief creat_frame
 * @return succ: AVFrame*, fail: nullptr
 */</span>
AVFrame <span class="token operator">*</span><span class="token function">creat_frame</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AVFrame <span class="token operator">*</span>frame <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">//音频输入数据(未编码的数据)</span>
    frame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Error, Failed to alloc frame!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> __ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//set parameters</span>
    frame<span class="token operator">-&gt;</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
    frame<span class="token operator">-&gt;</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    frame<span class="token operator">-&gt;</span>format <span class="token operator">=</span> AV_PIX_FMT_YUV420P<span class="token punctuation">;</span>

    <span class="token comment">//alloc inner memory</span>
    ret <span class="token operator">=</span> <span class="token function">av_frame_get_buffer</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//按 32 位对齐</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error, Failed to alloc buffer for frame!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> __ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> frame<span class="token punctuation">;</span>

__ERROR<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>frame<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">open_encoder</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> AVCodecContext <span class="token operator">*</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>codec <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    codec <span class="token operator">=</span> <span class="token function">avcodec_find_encoder_by_name</span><span class="token punctuation">(</span><span class="token string">"libx264"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> codec<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Codec libx264 not found\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>enc_ctx <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span>codec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Could not allocate video codec context!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span><span class="token operator">-&gt;</span>profile <span class="token operator">=</span> FF_PROFILE_H264_HIGH_444<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span><span class="token operator">-&gt;</span>level <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> <span class="token comment">//表示LEVEL是5.0</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span><span class="token operator">-&gt;</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span><span class="token operator">-&gt;</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>

    <span class="token comment">//GOP</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span><span class="token operator">-&gt;</span>gop_size <span class="token operator">=</span> <span class="token number">250</span><span class="token punctuation">;</span>
    <span class="token comment">//最小插入I帧的间隔</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span><span class="token operator">-&gt;</span>keyint_min <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>    <span class="token comment">//option</span>

    <span class="token comment">//设置B帧的数量</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span><span class="token operator">-&gt;</span>max_b_frames <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>   <span class="token comment">//option</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span><span class="token operator">-&gt;</span>has_b_frames <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token comment">//option</span>

    <span class="token comment">//设置参考帧的数量</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span><span class="token operator">-&gt;</span>refs <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>           <span class="token comment">//option</span>

    <span class="token comment">//设置输入YUV格式</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span><span class="token operator">-&gt;</span>pix_fmt <span class="token operator">=</span> AV_PIX_FMT_YUV420P<span class="token punctuation">;</span>

    <span class="token comment">//设置码率</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span><span class="token operator">-&gt;</span>bit_rate <span class="token operator">=</span> <span class="token number">600000</span><span class="token punctuation">;</span>  <span class="token comment">//600kbps</span>

    <span class="token comment">//设置帧率</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span><span class="token operator">-&gt;</span>time_base <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">//帧与帧之间的间隔是time_base</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">)</span><span class="token operator">-&gt;</span>framerate <span class="token operator">=</span> <span class="token punctuation">(</span>AVRational<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">//帧率，每秒 25 帧</span>

    ret <span class="token operator">=</span> <span class="token function">avcodec_open2</span><span class="token punctuation">(</span><span class="token operator">*</span>enc_ctx<span class="token punctuation">,</span> codec<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Could not open codec :%d!\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">rec_video</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AVFormatContext <span class="token operator">*</span>fmt_ctx <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    AVPacket <span class="token operator">*</span>pkt <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    AVCodecContext <span class="token operator">*</span>enc_ctx <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    AVFrame <span class="token operator">*</span>frame <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>y <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>u <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>v <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

    <span class="token comment">//set log level</span>
    <span class="token function">av_log_set_level</span><span class="token punctuation">(</span>AV_LOG_DEBUG<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//create file</span>
    FILE <span class="token operator">*</span>outfile <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"D:/Study/ffmpeg/av_base/video.yuv"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> outfile<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error, Failed to open file!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> __ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//register audio device</span>
    <span class="token function">avdevice_register_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//打开设备</span>
    fmt_ctx <span class="token operator">=</span> <span class="token function">open_dev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> fmt_ctx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error, Failed to open device!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> __ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">open_encoder</span><span class="token punctuation">(</span>V_WIDTH<span class="token punctuation">,</span> V_HEIGHT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>enc_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//创建 AVFrame</span>
    frame <span class="token operator">=</span> <span class="token function">creat_frame</span><span class="token punctuation">(</span>V_WIDTH<span class="token punctuation">,</span> V_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//创建编码后输出的packet</span>
    pkt <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> pkt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error, Failed to alloc avpacket!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> __ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//read data from device</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">av_read_frame</span><span class="token punctuation">(</span>fmt_ctx<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">av_log</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">,</span> AV_LOG_INFO<span class="token punctuation">,</span>
               <span class="token string">"packet size is %d\n"</span><span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        fwrite(pkt-&gt;data, 1, static_cast&lt;size_t&gt;(pkt-&gt;size), outfile);</span>
<span class="token comment">//        fflush(outfile);</span>

        <span class="token comment">//YUYVYUYVYUYV windows录屏采用的是YUYV422</span>
        <span class="token comment">//YYYYYYYYUUVV YUV420P</span>
        y <span class="token operator">=</span> <span class="token operator">&amp;</span>frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        u <span class="token operator">=</span> <span class="token operator">&amp;</span>frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        v <span class="token operator">=</span> <span class="token operator">&amp;</span>frame<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>y<span class="token operator">++</span> <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>y<span class="token operator">++</span> <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token punctuation">(</span>V_WIDTH <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>u<span class="token operator">++</span> <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>v<span class="token operator">++</span> <span class="token operator">=</span> pkt<span class="token operator">-&gt;</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

<span class="token comment">//        fwrite(frame-&gt;data[0], 1, V_WIDTH * V_HEIGHT, outfile);</span>
<span class="token comment">//        fwrite(frame-&gt;data[1], 1, V_WIDTH * V_HEIGHT / 4, outfile);</span>
<span class="token comment">//        fwrite(frame-&gt;data[2], 1, V_WIDTH * V_HEIGHT / 4, outfile);</span>
<span class="token comment">//        fflush(outfile);</span>

<span class="token comment">//        av_packet_unref(pkt);</span>

        frame<span class="token operator">-&gt;</span>pts <span class="token operator">=</span> base<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">encode</span><span class="token punctuation">(</span>enc_ctx<span class="token punctuation">,</span> frame<span class="token punctuation">,</span> pkt<span class="token punctuation">,</span> outfile<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> count<span class="token operator">++</span> <span class="token operator">&gt;=</span> <span class="token number">50</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">encode</span><span class="token punctuation">(</span>enc_ctx<span class="token punctuation">,</span> nullptr<span class="token punctuation">,</span> pkt<span class="token punctuation">,</span> outfile<span class="token punctuation">)</span><span class="token punctuation">;</span>

__ERROR<span class="token operator">:</span>
    <span class="token comment">//close device and release ctx</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fmt_ctx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmt_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">av_packet_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//close file</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outfile<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>outfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">av_log</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">,</span> AV_LOG_DEBUG<span class="token punctuation">,</span> <span class="token string">"finish!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">rec_video</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/de147515b0197ef54c7e931c1d7f8d99/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vsocde空格太小解决办法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/51062481901d07708cee8685b8dd7079/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">匿名内部类</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>