<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Elasticsearch基础篇(八)：常用查询以及使用Java Api Client进行检索 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Elasticsearch基础篇(八)：常用查询以及使用Java Api Client进行检索" />
<meta property="og:description" content="ES常用查询以及使用Java Api Client进行检索 1. 检索需求 参照豆瓣阅读的列表页面
需求：
检索词需要在数据库中的题名、作者和摘要字段进行检索并进行高亮标红返回的检索结果需要根据综合、热度最高、最近更新、销量最高、好评最多进行排序分页数量为10，并且返回检索到的总数量 2. 建立测试环境 2.1 根据需求建立es字段 mapping.json
{ &#34;mappings&#34;: { &#34;properties&#34;: { &#34;title&#34;: { &#34;analyzer&#34;: &#34;standard&#34;, &#34;type&#34;: &#34;text&#34; }, &#34;author&#34;: { &#34;analyzer&#34;: &#34;standard&#34;, &#34;type&#34;: &#34;text&#34;, &#34;fields&#34;: { &#34;keyword&#34;: { &#34;type&#34;: &#34;keyword&#34; } } }, &#34;contentDesc&#34;: { &#34;analyzer&#34;: &#34;standard&#34;, &#34;type&#34;: &#34;text&#34; }, &#34;wordCount&#34;: { &#34;type&#34;: &#34;double&#34; }, &#34;price&#34;: { &#34;type&#34;: &#34;double&#34; }, &#34;cover&#34;: { &#34;type&#34;: &#34;keyword&#34; }, &#34;heatCount&#34;: { &#34;type&#34;: &#34;integer&#34; }, &#34;updateTime&#34;: { &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/21ab086f0089216ae802e7d4eb1d0fb6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-22T14:38:04+08:00" />
<meta property="article:modified_time" content="2024-01-22T14:38:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Elasticsearch基础篇(八)：常用查询以及使用Java Api Client进行检索</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="ESJava_Api_Client_1"></a>ES常用查询以及使用Java Api Client进行检索</h2> 
<h2><a id="1__3"></a>1. 检索需求</h2> 
<p>参照豆瓣阅读的列表页面</p> 
<p>需求：</p> 
<ul><li>检索词需要在数据库中的题名、作者和摘要字段进行检索并进行高亮标红</li><li>返回的检索结果需要根据综合、热度最高、最近更新、销量最高、好评最多进行排序</li><li>分页数量为10，并且返回检索到的总数量</li></ul> 
<p><img src="https://images2.imgbox.com/8c/1a/NtAaspUE_o.png" alt="image-20231220150501858"></p> 
<h2><a id="2__17"></a>2. 建立测试环境</h2> 
<h3><a id="21_es_19"></a>2.1 根据需求建立es字段</h3> 
<p>mapping.json</p> 
<pre><code class="prism language-json"> <span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"standard"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"author"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"standard"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"keyword"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"contentDesc"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"standard"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"wordCount"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"double"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"double"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"cover"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"heatCount"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"updateTime"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"date"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>映射字段说明：</p> 
<ol><li><strong>id（长整型）:</strong> 表示唯一标识的字段，类型为<code>long</code></li><li><strong>title（文本类型）:</strong> 用于存储文档标题的字段，类型为<code>text</code>。指定默认的标准分析器（analyzer）为<code>standard</code></li><li><strong>author（文本类型）:</strong> 存储文档作者的字段，同样是<code>text</code>类型。除了使用标准分析器外，还定义额外的关键字（keyword）字段，该关键字字段通常用于==<strong>精确匹配和聚合</strong>==操作。</li><li><strong>contentDesc（文本类型）:</strong> 存储文档内容描述的字段，同样是<code>text</code>类型，使用标准分析器。</li><li><strong>wordCount（双精度浮点型）:</strong> 存储文档字数的字段，类型为<code>double</code>。通常用于存储浮点数值。</li><li><strong>price（双精度浮点型）:</strong> 存储文档价格的字段，同样是<code>double</code>类型。用于存储浮点数值，例如书籍的价格。</li><li><strong>cover（关键字类型）:</strong> 存储文档封面的字段，类型为<code>keyword</code>。关键字字段通常用于精确匹配。</li><li><strong>heatCount（整型）:</strong> 存储热度计数的字段，类型为<code>integer</code>。通常用于热度排序</li><li><strong>updateTime（日期类型）:</strong> 存储文档更新时间的字段，类型为<code>date</code>。用于最近更新排序</li></ol> 
<h3><a id="22__76"></a>2.2 <strong>创建索引和映射</strong></h3> 
<p><img src="https://images2.imgbox.com/ba/55/fPeEKVm2_o.png" alt="image-20231220154508492"></p> 
<h3><a id="23__80"></a>2.3 增加测试数据</h3> 
<pre><code> POST /douban/_doc/1001
 {
    "title":"诗云",
    "author":"刘慈欣",
    "contentDesc":"伊依一行三人乘坐一艘游艇在南太平洋上做吟诗航行，平时难得一见的美洲大陆清晰地显示在天空中，在东半球构成的覆盖世界的巨大穹顶上，大陆好像是墙皮脱落的区域…",
    "wordCount":18707,
    "price":6.99,
    "cover":"https://pic.arkread.com/cover/ebook/f/19534800.1653698501.jpg!cover_default.jpg",
    "heatCount":201,
    "updateTime":"2023-12-20"
 }
 
  POST /douban/_doc/1002
 {
    "title":"三体2·黑暗森林",
    "author":"刘慈欣",
    "contentDesc":"征服世界的中国科幻神作！包揽九项世界顶级科幻大奖！《三体》获得第73届“雨果奖”最佳长篇奖！",
    "wordCount":318901,
    "price":32.00,
    "cover":"https://pic.arkread.com/cover/ebook/f/110344476.1653700299.jpg!cover_default.jpg",
    "heatCount":545,
    "updateTime":"2023-12-25"
 }
 
  POST /douban/_doc/1003
 {
    "title":"三体前传：球状闪电",
    "author":"刘慈欣",
    "contentDesc":"征服世界的中国科幻神作！包揽九项世界顶级科幻大奖！《三体》获得第73届“雨果奖”最佳长篇奖！",
    "wordCount":181119,
    "price":35.00,
    "cover":"https://pic.arkread.com/cover/ebook/f/116984494.1653699856.jpg!cover_default.jpg",
    "heatCount":765,
    "updateTime":"2022-11-12"
 }
 
  POST /douban/_doc/1004
 {
    "title":"全频带阻塞干扰",
    "author":"刘慈欣",
    "contentDesc":"这是一个场面浩大而惨烈的故事。21世纪的某年，以美国为首的北约发起了对俄罗斯的全面攻击。在残酷的保卫战中，俄国的电子战设备无力抵挡美国的进攻",
    "wordCount":28382,
    "price":6.99,
    "cover":"https://pic.arkread.com/cover/ebook/f/19532617.1653698557.jpg!cover_default.jpg",
    "heatCount":153,
    "updateTime":"2021-03-23"
 }
</code></pre> 
<h2><a id="3__132"></a>3. 执行查询</h2> 
<h3><a id="31__134"></a>3.1 主键查询</h3> 
<pre><code class="prism language-json"># 此种方式已过时，不推荐
<span class="token constant">GET</span> <span class="token operator">/</span>douban<span class="token operator">/</span>_doc<span class="token operator">/</span><span class="token number">1001</span>

# 推荐此种方式
<span class="token constant">POST</span> <span class="token operator">/</span>douban<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token number">1001</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="32__151"></a>3.2 全量查询</h3> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>douban<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="33__163"></a>3.3 分页查询</h3> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>douban<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"from"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string-property property">"size"</span><span class="token operator">:</span><span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="34__177"></a>3.4 排序查询</h3> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>douban<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token string-property property">"order"</span><span class="token operator">:</span> <span class="token string">"desc"</span> 
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="35__196"></a>3.5 全文检索</h3> 
<pre><code class="prism language-java"><span class="token constant">POST</span> <span class="token operator">/</span>douban<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"title"</span><span class="token operator">:</span><span class="token string">"三体球闪"</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>检索结果：</p> 
<p><img src="https://images2.imgbox.com/ca/5f/7QeIAVyC_o.png" alt="image-20231220170628892"></p> 
<h3><a id="36__213"></a>3.6 高亮检索</h3> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>douban<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token string">"三体球闪"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"pre_tags"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token string">"&lt;font style='red'&gt;"</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string-property property">"post_tags"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token string">"&lt;/font&gt;"</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/15/69/UsyBJ69l_o.png" alt="image-20231220172424036"></p> 
<h3><a id="37__bool_240"></a>3.7 bool查询</h3> 
<p>题名进行全文检索包含‘三体球闪’，并且价格为‘35’的数据</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>douban<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token string">"三体球闪"</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"price"</span><span class="token operator">:</span> <span class="token number">35</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="37___266"></a>3.7 多字段全文检索</h3> 
<p>对题名、作者、摘要进行全文匹配，同时根据三个字段进行高亮标红</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>douban<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"multi_match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"三体球闪"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"title"</span><span class="token punctuation">,</span>
                <span class="token string">"author"</span><span class="token punctuation">,</span>
                <span class="token string">"contentDesc"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"author"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"contentDesc"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c3/2d/7FYjC1J5_o.png" alt="image-20231220173414933"></p> 
<h3><a id="38__295"></a>3.8 综合检索</h3> 
<p>对题名、作者、摘要进行全文匹配，同时根据三个字段进行高亮标红</p> 
<p>增加分页条件查询、增加更新日期降序排序、同时返回需要的必备字段</p> 
<pre><code class="prism language-json"><span class="token constant">POST</span> <span class="token operator">/</span>douban<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"multi_match"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"query"</span><span class="token operator">:</span> <span class="token string">"三体球闪"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">"title"</span><span class="token punctuation">,</span>
                <span class="token string">"author"</span><span class="token punctuation">,</span>
                <span class="token string">"contentDesc"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"from"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string-property property">"size"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token string-property property">"_source"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"title"</span><span class="token punctuation">,</span>
        <span class="token string">"author"</span><span class="token punctuation">,</span>
        <span class="token string">"price"</span><span class="token punctuation">,</span>
        <span class="token string">"wordCount"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"updateTime"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"order"</span><span class="token operator">:</span> <span class="token string">"desc"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"author"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string-property property">"contentDesc"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c0/c8/Xl8SzfeR_o.png" alt="image-20231221092538555"></p> 
<h2><a id="4_Springelasticsearch_346"></a>4. Spring项目集成elasticsearch</h2> 
<p>参考文档：[Installation | Elasticsearch Java API Client <a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/installation.html" rel="nofollow">7.17] | Elastic</a></p> 
<h3><a id="41_Springes_350"></a>4.1 创建Spring项目并引入es依赖</h3> 
<img src="https://images2.imgbox.com/31/81/8wrgjcYH_o.png" alt="image-20231222145917463"> 
<img src="https://images2.imgbox.com/a9/4c/rSgTrDPY_o.png" alt="image-20231222150055190"> 
<p>如果希望使用java8,就打开pom.xml修改parent版本和java.version的值，然后点击刷新maven</p> 
<p><img src="https://images2.imgbox.com/26/e8/i7yzVtBA_o.png" alt="image-20231222152132304"></p> 
<p><mark>在Elasticsearch7.15版本之后，Elasticsearch官方将它的高级客户端RestHighLevelClient标记为弃用状态。同时推出了全新的Java API客户端Elasticsearch Java API Client，该客户端也将在Elasticsearch8.0及以后版本中成为官方推荐使用的客户端。</mark></p> 
<table><thead><tr><th>Api名称</th><th>介绍</th></tr></thead><tbody><tr><td><a href="https://gitee.com/link?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Felasticsearch%2Fclient%2Fjava-api%2Fcurrent%2Findex.html" rel="nofollow"><s>TransportClient</s></a><s>-废弃，8.x删除</s></td><td>基于TCP方式访问，只支持JAVA,7.x开始弃用，8.x删除.</td></tr><tr><td><a href="https://gitee.com/link?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Felasticsearch%2Fclient%2Fjava-api-client%2Fcurrent%2Fjava-rest-low.html" rel="nofollow">Rest Lower Level Rest Client</a></td><td>低等级RestApi,最小依赖。</td></tr><tr><td><a href="https://gitee.com/link?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Felasticsearch%2Fclient%2Fjava-rest%2Fcurrent%2Fjava-rest-high.html" rel="nofollow"><s>Rest High Level Rest Client</s></a><s>废弃，未说明删除时间</s></td><td>高等级的RestApi,<strong>基于低等级Api</strong>,7.15开始弃用，但没有说明会删除。用低等级Api替换。</td></tr><tr><td><a href="https://gitee.com/link?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Felasticsearch%2Fclient%2Fjava-api-client%2Fcurrent%2Findex.html" rel="nofollow"><strong>RestClient</strong></a></td><td>基于Http的Api形式，跨语言，推荐使用，<strong>底层基于低等级Api</strong>，7.15才开始提供</td></tr></tbody></table> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>co.elastic.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>7.17.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.12.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 此依赖的作用是解决：lassNotFoundException: jakarta.json.spi.JsonProvider
     参考:https://github.com/elastic/elasticsearch-java/issues/311 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>jakarta.json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jakarta.json-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>完整依赖如下：注意 properties中一定要加 <mark>&lt;elasticsearch.version&gt;7.17.11&lt;/elasticsearch.version&gt;</mark>,否则会导致无法覆盖父引用中依赖</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.5.15<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.zhouquan<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Demo project for Spring Boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lombok.version</span><span class="token punctuation">&gt;</span></span>1.18.22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lombok.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>7.17.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>elasticsearch.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jakarta.version</span><span class="token punctuation">&gt;</span></span>2.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jakarta.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>co.elastic.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>7.17.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.12.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- 此依赖的作用是解决：lassNotFoundException: jakarta.json.spi.JsonProvider
         参考:https://github.com/elastic/elasticsearch-java/issues/311 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.glassfish<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jakarta.json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${jakarta.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${lombok.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- Apache Commons IO --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-io<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-io<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.11.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<h3><a id="42_es_475"></a>4.2 增加es客户端配置类</h3> 
<p>交给spring进行管理，使用时通过@Resource private ElasticsearchClient client; 注入即可使用</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EsClient</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">EsConfig</span> esConfig<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Bean 定义，用于创建 ElasticsearchClient 实例。
     *
     * @return 配置有 RestClient 和传输设置的 ElasticsearchClient 实例。
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ElasticsearchClient</span> <span class="token function">elasticsearchClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 使用 Elasticsearch 集群的主机和端口配置 RestClient</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> clusterNodes <span class="token operator">=</span> esConfig<span class="token punctuation">.</span><span class="token function">getClusterNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpHost</span><span class="token punctuation">[</span><span class="token punctuation">]</span> httpHosts <span class="token operator">=</span> clusterNodes<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">HttpHost</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token class-name">HttpHost</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Create the low-level client</span>
        <span class="token class-name">RestClient</span> restClient <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>httpHosts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// JSON 序列化</span>
        <span class="token class-name">ElasticsearchTransport</span> transport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestClientTransport</span><span class="token punctuation">(</span>restClient<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">JacksonJsonpMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ElasticsearchClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ElasticsearchClient</span><span class="token punctuation">(</span>transport<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 打印连接信息</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Elasticsearch Client 连接节点信息：{}"</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>httpHosts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="43__Java_API_Client__515"></a>4.3 使用 Java API Client 创建索引</h3> 
<p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/7.17/usage.html" rel="nofollow">Using the Java API Client</a></p> 
<p><img src="https://images2.imgbox.com/c5/78/UJCoFdIZ_o.png" alt="image-20240109152629604"></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 创建索引
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token class-name">ResourceLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InputStream</span> input <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"mapping/douban.json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">CreateIndexRequest</span> req <span class="token operator">=</span> <span class="token class-name">CreateIndexRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>b <span class="token operator">-&gt;</span> b
            <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"douban_v1"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withJson</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> created <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"是否创建成功："</span> <span class="token operator">+</span> created<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="44__540"></a>4.4 保存文档</h3> 
<p>实体类 DouBan.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zhouquan<span class="token punctuation">.</span>client<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author ZhouQuan
 * @description todo
 * @date 2024-01-09 15:54
 **/</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DouBan</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> author<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> contentDesc<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> wordCount<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Double</span> price<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> cover<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> heatCount<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="441__583"></a>4.4.1 索引单个文档</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">indexSingleDoc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">IndexResponse</span> indexResponse<span class="token punctuation">;</span>
        <span class="token class-name">DouBan</span> douBan <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DouBan</span><span class="token punctuation">(</span><span class="token string">"1211"</span><span class="token punctuation">,</span> <span class="token string">"河边的错误"</span><span class="token punctuation">,</span> <span class="token string">"余华"</span><span class="token punctuation">,</span> <span class="token string">"内容简介"</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">,</span> <span class="token number">52.5</span><span class="token punctuation">,</span> <span class="token string">"封面1"</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 使用流式dsl保存</span>
            indexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i
                    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>douBan<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>douBan<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 使用 Java API Client的静态of()方法</span>
            <span class="token class-name">IndexRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> objectIndexRequest <span class="token operator">=</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i
                    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>douBan<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>douBan<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">IndexResponse</span> ofIndexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>objectIndexRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 使用经典版本</span>
            <span class="token class-name">IndexRequest<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> objectBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            objectBuilder<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            objectBuilder<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>douBan<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            objectBuilder<span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>douBan<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">IndexResponse</span> classicIndexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>objectBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 异步保存</span>
            asyncClient<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i
                    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"douban"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>douBan<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>douBan<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> exception<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to index"</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Indexed with version "</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 索引原始json数据</span>
            <span class="token class-name">IndexResponse</span> response <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">String</span> jsonData <span class="token operator">=</span> <span class="token string">" {\"id\":\"1741\",\"title\":\"三体\",\"author\":\"刘慈欣\",\"contentDesc\":\"内容简介\",\"wordCount\":50000,\"price\":52.5}"</span><span class="token punctuation">;</span>
                <span class="token class-name">Reader</span> input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>jsonData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">IndexRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JsonData</span><span class="token punctuation">&gt;</span></span> request <span class="token operator">=</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i
                        <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"douban_v1"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">withJson</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>

                response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Indexed with version "</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Result<span class="token punctuation">.</span>Created</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>indexResponse<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="442___646"></a>4.4.2 批量索引文档</h4> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 批量保存
 *
 * @throws IOException
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">bulkSave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">DouBan</span> douBan1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DouBan</span><span class="token punctuation">(</span><span class="token string">"1002"</span><span class="token punctuation">,</span> <span class="token string">"题名1"</span><span class="token punctuation">,</span> <span class="token string">"余华"</span><span class="token punctuation">,</span> <span class="token string">"内容简介"</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">,</span> <span class="token number">52.5</span><span class="token punctuation">,</span> <span class="token string">"封面1"</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DouBan</span> douBan2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DouBan</span><span class="token punctuation">(</span><span class="token string">"1003"</span><span class="token punctuation">,</span> <span class="token string">"题名2"</span><span class="token punctuation">,</span> <span class="token string">"余华"</span><span class="token punctuation">,</span> <span class="token string">"内容简介"</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">,</span> <span class="token number">52.5</span><span class="token punctuation">,</span> <span class="token string">"封面1"</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DouBan</span> douBan3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DouBan</span><span class="token punctuation">(</span><span class="token string">"1004"</span><span class="token punctuation">,</span> <span class="token string">"题名3"</span><span class="token punctuation">,</span> <span class="token string">"余华"</span><span class="token punctuation">,</span> <span class="token string">"内容简介"</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">,</span> <span class="token number">52.5</span><span class="token punctuation">,</span> <span class="token string">"封面1"</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> douBanList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    douBanList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>douBan1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    douBanList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>douBan2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    douBanList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>douBan3<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">BulkRequest<span class="token punctuation">.</span>Builder</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DouBan</span> douBan <span class="token operator">:</span> douBanList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        br<span class="token punctuation">.</span><span class="token function">operations</span><span class="token punctuation">(</span>op <span class="token operator">-&gt;</span> op
                <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>idx <span class="token operator">-&gt;</span> idx
                        <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"products"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>douBan<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>douBan<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">BulkResponse</span> result <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>br<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Bulk had errors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BulkResponseItem</span> item <span class="token operator">:</span> result<span class="token punctuation">.</span><span class="token function">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="443___688"></a>4.4.3 原始数据批量索引文档</h4> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 原始json数据批量保存
 *
 * @throws IOException
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">rawDataBulkSave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">File</span> logDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"D:\\IdeaProjects\\client\\src\\main\\resources\\data"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> logFiles <span class="token operator">=</span> logDir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span>
            file <span class="token operator">-&gt;</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">"bulk*.*\\.json"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">BulkRequest<span class="token punctuation">.</span>Builder</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> logFiles<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">FileInputStream</span> input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BinaryData</span> data <span class="token operator">=</span> <span class="token class-name">BinaryData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ContentType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        br<span class="token punctuation">.</span><span class="token function">operations</span><span class="token punctuation">(</span>op <span class="token operator">-&gt;</span> op
                <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>idx <span class="token operator">-&gt;</span> idx
                        <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"douban_v1"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">BulkResponse</span> result <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>br<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BulkResponseItem</span><span class="token punctuation">&gt;</span></span> items <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        items<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>x <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"是否成功批量保存："</span> <span class="token operator">+</span> <span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="45__728"></a>4.5 获取单个文档</h3> 
<pre><code class="prism language-java"><span class="token comment">// 根据id获取数据并装载为java对象</span>
<span class="token class-name">GetRequest</span> getRequest <span class="token operator">=</span> <span class="token class-name">GetRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>x <span class="token operator">-&gt;</span> x<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"douban_v1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"1002"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">GetResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> douBanGetResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>getRequest<span class="token punctuation">,</span> <span class="token class-name">DouBan</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DouBan</span> source <span class="token operator">=</span> douBanGetResponse<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">GetResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>g <span class="token operator">-&gt;</span> g
                <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">DouBan</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span><span class="token function">found</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">"未获取到指定id的数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">DouBan</span> douBan <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"资料title: "</span> <span class="token operator">+</span> douBan<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> douBan<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// 根据id获取原始JSON数据</span>
<span class="token class-name">GetResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ObjectNode</span><span class="token punctuation">&gt;</span></span> response1 <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>g <span class="token operator">-&gt;</span> g
                <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">ObjectNode</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>response1<span class="token punctuation">.</span><span class="token function">found</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ObjectNode</span> json <span class="token operator">=</span> response1<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> name <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">" title "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"data not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="46__769"></a>4.6 文档检索</h3> 
<h4><a id="461__771"></a>4.6.1 普通的搜索查询</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">String</span> searchText<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s
                        <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>q <span class="token operator">-&gt;</span> q
                                <span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> t
                                        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>searchText<span class="token punctuation">)</span>
                                <span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">DouBan</span><span class="token punctuation">.</span><span class="token keyword">class</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">TotalHits</span> total <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">total</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isExactResult <span class="token operator">=</span> total<span class="token punctuation">.</span><span class="token function">relation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TotalHitsRelation<span class="token punctuation">.</span>Eq</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isExactResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"There are "</span> <span class="token operator">+</span> total<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" results"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"There are more than "</span> <span class="token operator">+</span> total<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" results"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hit</span><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> hits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Hit</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">DouBan</span> <span class="token class-name">DouBan</span> <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">DouBan</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Found DouBan "</span> <span class="token operator">+</span> <span class="token class-name">DouBan</span><span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", score "</span> <span class="token operator">+</span> hit<span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="462__812"></a>4.6.2 嵌套搜索查询</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> <span class="token function">search2</span><span class="token punctuation">(</span><span class="token class-name">String</span> searchText<span class="token punctuation">,</span> <span class="token class-name">Double</span> price<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">Query</span> titleQuery <span class="token operator">=</span> <span class="token class-name">MatchQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> m
            <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>searchText<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Query</span> rangeQuery <span class="token operator">=</span> <span class="token class-name">RangeQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r
            <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s
                        <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>q <span class="token operator">-&gt;</span> q
                                <span class="token punctuation">.</span><span class="token function">bool</span><span class="token punctuation">(</span>b <span class="token operator">-&gt;</span> b
                                        <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>titleQuery<span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span>rangeQuery<span class="token punctuation">)</span>
                                <span class="token punctuation">)</span>
                        <span class="token punctuation">)</span>
                <span class="token punctuation">,</span>
                <span class="token class-name">DouBan</span><span class="token punctuation">.</span><span class="token keyword">class</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 解析检索结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> douBanList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hit</span><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Hit</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">DouBan</span> douBan <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            douBanList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>douBan<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> douBanList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="463__854"></a>4.6.3 模板搜索</h4> 
<pre><code class="prism language-java"><span class="token comment">// 创建模板,返回搜索请求正文的存储脚本</span>
client<span class="token punctuation">.</span><span class="token function">putScript</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r
        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"query-script"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">script</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s
                <span class="token punctuation">.</span><span class="token function">lang</span><span class="token punctuation">(</span><span class="token string">"mustache"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token string">"{\"query\":{\"match\":{\"{<!-- -->{field}}\":\"{<!-- -->{value}}\"}}}"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 执行请求</span>
<span class="token class-name">SearchTemplateResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">searchTemplate</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r
                <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"douban_v1"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"query-script"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">params</span><span class="token punctuation">(</span><span class="token string">"field"</span><span class="token punctuation">,</span> <span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">params</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token class-name">JsonData</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"题名"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">DouBan</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 结果解析</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Hit</span><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> hits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Hit</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> hit<span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">DouBan</span> <span class="token class-name">DouBan</span> <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Found DouBan "</span> <span class="token operator">+</span> <span class="token class-name">DouBan</span><span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", score "</span> <span class="token operator">+</span> hit<span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="47__882"></a>4.7 文档聚合</h3> 
<pre><code class="prism language-java"><span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token class-name">MatchQuery</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> t
        <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>searchText<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Aggregation</span> authorAgg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">_toAggregation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DouBan</span><span class="token punctuation">&gt;</span></span> response <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s
                <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">aggregations</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span> authorAgg<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">DouBan</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d2ef585b3f370128184bbb98b9067561/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python抽奖小程序</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3b8835e5401770d22cf089602b0a4799/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">家政小程序：重新定义家政服务</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>