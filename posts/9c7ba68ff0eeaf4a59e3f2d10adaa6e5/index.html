<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32F103 实例应用（13）——串口接收中断&#43;串口空闲中断接收不定长字符串 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32F103 实例应用（13）——串口接收中断&#43;串口空闲中断接收不定长字符串" />
<meta property="og:description" content="一、应用简介 本文介绍串口中断接收不定长字符串的方法。将串口1配置接收中断使能、空闲中断使能来接收不定长数据。
也就是在配置串口中断的时候使能接收中断和空闲中断。如下：
... USART_ITConfig(USART1, USART_IT_RXNE, ENABLE); USART_ITConfig(USART1, USART_IT_IDLE, ENABLE);	... USART_IT_RXNE：接收中断，串口每收到一个字节就会产生一个此中断。
USART_IT_IDLE：空闲中断，总线上在一个字节的时间内没有再接收到数据的时候发生的。
之后在串口中断处理函数中分别判断处理2种中断就好了，如下：
// 接收数组大小 #define RECEIVE_BUF_SIZE 255 uint8_t g_usart1RxFlag = 0;	// 串口1接收标志0-未接受1-接收 uint8_t g_uart1ReceiveBuff[RECEIVE_BUF_SIZE]; // 串口1接收缓冲 uint16_t g_uart1Len = 0;	// 串口1接收长度 /** @brief USART1中断 @param 无 @retval 无 */ void USART1_IRQHandler(void) { // 接收中断的时候收集数据包 if(USART_GetITStatus(USART1, USART_IT_RXNE) != RESET) { USART_ClearITPendingBit(USART1, USART_IT_RXNE); //只USART_ReceiveData也可以 g_uart1ReceiveBuff[g_uart1Len] = USART_ReceiveData(USART1); g_uart1Len&#43;&#43;; } // 空闲中断的时候说明串口没数据了，收集完成 else if(USART_GetFlagStatus(USART1, USART_FLAG_IDLE) != RESET) { USART1-&gt;SR; USART1-&gt;DR; // 标志位，代表有数据，此数据放到main处理去，不要放中断处理。我只打印一下 g_usart1RxFlag = 1; printf(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/9c7ba68ff0eeaf4a59e3f2d10adaa6e5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-26T17:07:51+08:00" />
<meta property="article:modified_time" content="2021-04-26T17:07:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32F103 实例应用（13）——串口接收中断&#43;串口空闲中断接收不定长字符串</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <hr> 
<h2><a id="_2"></a>一、应用简介</h2> 
<p>本文介绍串口中断接收不定长字符串的方法。将串口1配置接收中断使能、空闲中断使能来接收不定长数据。<br> 也就是在配置串口中断的时候使能接收中断和空闲中断。如下：</p> 
<pre><code class="prism language-c"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_IDLE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p><code>USART_IT_RXNE</code>：接收中断，串口每收到一个字节就会产生一个此中断。<br> <code>USART_IT_IDLE</code>：空闲中断，总线上在一个字节的时间内没有再接收到数据的时候发生的。<br> 之后在串口中断处理函数中分别判断处理2种中断就好了，如下：</p> 
<pre><code class="prism language-c"><span class="token comment">// 接收数组大小</span>
<span class="token macro property">#<span class="token directive keyword">define</span>  RECEIVE_BUF_SIZE           255</span>

uint8_t g_usart1RxFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>							<span class="token comment">// 串口1接收标志0-未接受1-接收</span>
uint8_t  g_uart1ReceiveBuff<span class="token punctuation">[</span>RECEIVE_BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>   	<span class="token comment">// 串口1接收缓冲  </span>
uint16_t g_uart1Len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>							<span class="token comment">// 串口1接收长度  </span>
<span class="token comment">/**
 @brief USART1中断
 @param 无
 @retval 无
*/</span>
<span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
	<span class="token comment">// 接收中断的时候收集数据包</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetITStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">USART_ClearITPendingBit</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//只USART_ReceiveData也可以</span>

        g_uart1ReceiveBuff<span class="token punctuation">[</span>g_uart1Len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>USART1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        g_uart1Len<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 空闲中断的时候说明串口没数据了，收集完成</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_FLAG_IDLE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        USART1<span class="token operator">-&gt;</span>SR<span class="token punctuation">;</span>
        USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>
		<span class="token comment">// 标志位，代表有数据，此数据放到main处理去，不要放中断处理。我只打印一下</span>
        g_usart1RxFlag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"shoudao1:%s"</span><span class="token punctuation">,</span> g_uart1ReceiveBuff<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre> 
<p>最后，main函数，如下</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 数据处理</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>g_usart1RxFlag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 数据处理，这里添加用户自定义处理，处理g_uart1ReceiveBuff后清空</span>
			

			g_usart1RxFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			g_uart1Len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>g_uart1ReceiveBuff<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>g_uart1ReceiveBuff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>	
		<span class="token function">vTaskDelay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* 1ms启动读一次 */</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_75"></a>二、实例</h2> 
<p>bsp_usart.h</p> 
<pre><code class="prism language-c"><span class="token comment">/**===========================================================================
  @file     bsp_usart.h
  @brief    本文件是用于串口驱动
  @author   青梅煮久
  @version  r0.1
  @date     2021/04/26
----------------------------------------------------------------------------
  Remark: (备注描述)
	串口1的驱动。
	串口1：用于日志打印、指令配置
----------------------------------------------------------------------------
                                History
----------------------------------------------------------------------------
  &lt;Date&gt;     | &lt;Version&gt; | &lt;Author&gt;       | &lt;Description&gt;
-------------|-----------|----------------|---------------------------------
  2021/04/26 | r0.1      | 青梅煮久        | 创建
-------------|-----------|----------------|---------------------------------
             |           |                |
-------------|-----------|----------------|---------------------------------
             |           |                |
-------------|-----------|----------------|---------------------------------
             |           |                |
============================================================================*/</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> __BSP_USART_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span>	__BSP_USART_H</span>

<span class="token comment">/*********************************************************************
 * INCLUDES
 */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token comment">/*********************************************************************
 * DEFINITIONS
 */</span>	
<span class="token comment">// 接收数组大小</span>
<span class="token macro property">#<span class="token directive keyword">define</span>  RECEIVE_BUF_SIZE           255</span>

<span class="token comment">/** 
* 串口宏定义，不同的串口挂载的总线和IO不一样，移植时需要修改这几个宏
* 1-修改总线时钟的宏，uart1挂载到apb2总线，其他uart挂载到apb1总线
* 2-修改GPIO的宏
*/</span>
<span class="token comment">/********************************串口1**********************************/</span>
<span class="token macro property">#<span class="token directive keyword">define</span>  DEBUG_USARTx                   USART1</span>
<span class="token macro property">#<span class="token directive keyword">define</span>  DEBUG_USART_CLK                RCC_APB2Periph_USART1</span>
<span class="token macro property">#<span class="token directive keyword">define</span>  DEBUG_USART_APBxClkCmd         RCC_APB2PeriphClockCmd</span>
<span class="token macro property">#<span class="token directive keyword">define</span>  DEBUG_USART_BAUDRATE           115200</span>

<span class="token macro property">#<span class="token directive keyword">define</span>  DEBUG_USART_GPIO_CLK           (RCC_APB2Periph_GPIOA)</span>
<span class="token macro property">#<span class="token directive keyword">define</span>  DEBUG_USART_GPIO_APBxClkCmd    RCC_APB2PeriphClockCmd</span>
    
<span class="token macro property">#<span class="token directive keyword">define</span>  DEBUG_USART_TX_GPIO_PORT       GPIOA   </span>
<span class="token macro property">#<span class="token directive keyword">define</span>  DEBUG_USART_TX_GPIO_PIN        GPIO_Pin_9</span>
<span class="token macro property">#<span class="token directive keyword">define</span>  DEBUG_USART_RX_GPIO_PORT       GPIOA</span>
<span class="token macro property">#<span class="token directive keyword">define</span>  DEBUG_USART_RX_GPIO_PIN        GPIO_Pin_10</span>

<span class="token macro property">#<span class="token directive keyword">define</span>  DEBUG_USART_IRQ                USART1_IRQn</span>
<span class="token macro property">#<span class="token directive keyword">define</span>  DEBUG_USART_IRQHandler         USART1_IRQHandler</span>


<span class="token comment">/*********************************************************************
 * GLOBAL VARIABLES
 */</span>
<span class="token keyword">extern</span> uint8_t g_usart1RxFlag<span class="token punctuation">;</span>							<span class="token comment">// 串口1接收标志0-未接受1-接收</span>
<span class="token keyword">extern</span> uint8_t  g_uart1ReceiveBuff<span class="token punctuation">[</span>RECEIVE_BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 串口1接收缓冲  </span>
<span class="token keyword">extern</span> uint16_t g_uart1Len<span class="token punctuation">;</span>								<span class="token comment">// 串口1接收长度  </span>
<span class="token comment">/*********************************************************************
* API FUNCTIONS
*/</span>
<span class="token keyword">void</span> <span class="token function">USART1_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* __BSP_USART_H */</span>

</code></pre> 
<p>bsp_usart.c</p> 
<pre><code class="prism language-c"><span class="token comment">/**===========================================================================
  @file     bsp_usart.h
  @brief    本文件是用于串口驱动
  @author   青梅煮久
  @version  r0.1
  @date     2021/04/26
----------------------------------------------------------------------------
  Remark: (备注描述)
	串口1的驱动。
	串口1：用于日志打印、指令配置
----------------------------------------------------------------------------
                                History
----------------------------------------------------------------------------
  &lt;Date&gt;     | &lt;Version&gt; | &lt;Author&gt;       | &lt;Description&gt;
-------------|-----------|----------------|---------------------------------
  2021/04/26 | r0.1      | 青梅煮久        | 创建
-------------|-----------|----------------|---------------------------------
             |           |                |
-------------|-----------|----------------|---------------------------------
             |           |                |
-------------|-----------|----------------|---------------------------------
             |           |                |
============================================================================*/</span>

<span class="token comment">/*********************************************************************
 * INCLUDES
 */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"bsp_usart.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"string.h"</span> </span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">NVIC_Configuration</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*********************************************************************
 * GLOBAL VARIABLES
 */</span>
uint8_t g_usart1RxFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>							<span class="token comment">// 串口1接收标志0-未接受1-接收</span>
uint8_t  g_uart1ReceiveBuff<span class="token punctuation">[</span>RECEIVE_BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>   	<span class="token comment">// 串口1接收缓冲  </span>
uint16_t g_uart1Len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>							<span class="token comment">// 串口1接收长度  </span>

<span class="token comment">/*********************************************************************
 * PUBLIC FUNCTIONS
 */</span>
<span class="token comment">/**
 @brief  USART1 GPIO 配置,工作参数配置
 @param  无
 @retval 无
*/</span>
<span class="token keyword">void</span> <span class="token function">USART1_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
	USART_InitTypeDef USART_InitStructure<span class="token punctuation">;</span>

	<span class="token comment">// 打开串口GPIO的时钟</span>
	<span class="token function">DEBUG_USART_GPIO_APBxClkCmd</span><span class="token punctuation">(</span>DEBUG_USART_GPIO_CLK<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 打开串口外设的时钟</span>
	<span class="token function">DEBUG_USART_APBxClkCmd</span><span class="token punctuation">(</span>DEBUG_USART_CLK<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/*
	*  配置串口
	*  USART1_TX -&gt; PA9 , USART1_RX -&gt;	PA10
	*/</span>	
	<span class="token comment">// 将USART Tx的GPIO配置为推挽复用模式</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> DEBUG_USART_TX_GPIO_PIN<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_AF_PP<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>DEBUG_USART_TX_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 将USART Rx的GPIO配置为浮空输入模式</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> DEBUG_USART_RX_GPIO_PIN<span class="token punctuation">;</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN_FLOATING<span class="token punctuation">;</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>DEBUG_USART_RX_GPIO_PORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	USART_InitStructure<span class="token punctuation">.</span>USART_BaudRate <span class="token operator">=</span> DEBUG_USART_BAUDRATE<span class="token punctuation">;</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_WordLength <span class="token operator">=</span> USART_WordLength_8b<span class="token punctuation">;</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_StopBits <span class="token operator">=</span> USART_StopBits_1<span class="token punctuation">;</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_Parity <span class="token operator">=</span> USART_Parity_No <span class="token punctuation">;</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_HardwareFlowControl <span class="token operator">=</span> USART_HardwareFlowControl_None<span class="token punctuation">;</span>
	USART_InitStructure<span class="token punctuation">.</span>USART_Mode <span class="token operator">=</span> USART_Mode_Rx <span class="token operator">|</span> USART_Mode_Tx<span class="token punctuation">;</span>
	<span class="token function">USART_Init</span><span class="token punctuation">(</span>DEBUG_USARTx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>USART_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// 串口中断优先级配置</span>
	<span class="token function">NVIC_Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 使能串口中断</span>
	<span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>DEBUG_USARTx<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">USART_ITConfig</span><span class="token punctuation">(</span>DEBUG_USARTx<span class="token punctuation">,</span> USART_IT_IDLE<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	
	<span class="token comment">// 使能串口</span>
	<span class="token function">USART_Cmd</span><span class="token punctuation">(</span>DEBUG_USARTx<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>	   

<span class="token punctuation">}</span>

<span class="token comment">/**
 @brief 发送一个字节
 @param pUSARTx -[in] 串口
 @param ch -[in] 发送数据
 @retval 无
*/</span>
<span class="token keyword">void</span> <span class="token function">Usart_SendByte</span><span class="token punctuation">(</span> USART_TypeDef <span class="token operator">*</span> pUSARTx<span class="token punctuation">,</span> uint8_t ch<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* 发送一个字节数据到USART */</span>
	<span class="token function">USART_SendData</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token comment">/* 等待发送数据寄存器为空 */</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span> USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token comment">/**
 @brief 发送8位的数组
 @param pUSARTx -[in] 串口
 @param array -[in] 发送数据
 @param num -[in] 发送长度
 @retval 无
*/</span>
<span class="token keyword">void</span> <span class="token function">Usart_SendArray</span><span class="token punctuation">(</span> USART_TypeDef <span class="token operator">*</span> pUSARTx<span class="token punctuation">,</span> uint8_t <span class="token operator">*</span>array<span class="token punctuation">,</span> uint16_t num<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  uint8_t i<span class="token punctuation">;</span>
	
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
	    <span class="token comment">/* 发送一个字节数据到USART */</span>
	    <span class="token function">Usart_SendByte</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span>array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
  
  <span class="token punctuation">}</span>
	<span class="token comment">/* 等待发送完成 */</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span>USART_FLAG_TC<span class="token punctuation">)</span><span class="token operator">==</span>RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 @brief 发送字符串
 @param pUSARTx -[in] 串口
 @param str -[in] 发送数据
 @retval 无
*/</span>
<span class="token keyword">void</span> <span class="token function">Usart_SendString</span><span class="token punctuation">(</span> USART_TypeDef <span class="token operator">*</span> pUSARTx<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span> 
  <span class="token punctuation">{<!-- --></span>
      <span class="token function">Usart_SendByte</span><span class="token punctuation">(</span> pUSARTx<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>str <span class="token operator">+</span> k<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      k<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>str <span class="token operator">+</span> k<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">/* 等待发送完成 */</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span>USART_FLAG_TC<span class="token punctuation">)</span><span class="token operator">==</span>RESET<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 @brief 发送一个16位数
 @param pUSARTx -[in] 串口
 @param ch -[in] 发送数据
 @retval 无
*/</span>
<span class="token keyword">void</span> <span class="token function">Usart_SendHalfWord</span><span class="token punctuation">(</span> USART_TypeDef <span class="token operator">*</span> pUSARTx<span class="token punctuation">,</span> uint16_t ch<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	uint8_t temp_h<span class="token punctuation">,</span> temp_l<span class="token punctuation">;</span>
	
	<span class="token comment">/* 取出高八位 */</span>
	temp_h <span class="token operator">=</span> <span class="token punctuation">(</span>ch<span class="token operator">&amp;</span><span class="token number">0XFF00</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">8</span><span class="token punctuation">;</span>
	<span class="token comment">/* 取出低八位 */</span>
	temp_l <span class="token operator">=</span> ch<span class="token operator">&amp;</span><span class="token number">0XFF</span><span class="token punctuation">;</span>
	
	<span class="token comment">/* 发送高八位 */</span>
	<span class="token function">USART_SendData</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span>temp_h<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span> USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/* 发送低八位 */</span>
	<span class="token function">USART_SendData</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span>temp_l<span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>pUSARTx<span class="token punctuation">,</span> USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token comment">/**
 @brief 重定向c库函数printf到串口，重定向后可使用printf函数
*/</span>
<span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span> FILE <span class="token operator">*</span>f<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
		<span class="token comment">/* 发送一个字节数据到串口 */</span>
		<span class="token function">USART_SendData</span><span class="token punctuation">(</span>DEBUG_USARTx<span class="token punctuation">,</span> <span class="token punctuation">(</span>uint8_t<span class="token punctuation">)</span> ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">/* 等待发送完毕 */</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>DEBUG_USARTx<span class="token punctuation">,</span> USART_FLAG_TXE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>		
	
		<span class="token keyword">return</span> <span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 @brief 重定向c库函数scanf到串口，重写向后可使用scanf、getchar等函数
*/</span>
<span class="token keyword">int</span> <span class="token function">fgetc</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>f<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
		<span class="token comment">/* 等待串口输入数据 */</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>DEBUG_USARTx<span class="token punctuation">,</span> USART_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">==</span> RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>DEBUG_USARTx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 @brief USART1中断
 @param 无
 @retval 无
*/</span>
<span class="token keyword">void</span> <span class="token function">USART1_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetITStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">USART_ClearITPendingBit</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//只USART_ReceiveData也可以</span>

        g_uart1ReceiveBuff<span class="token punctuation">[</span>g_uart1Len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">USART_ReceiveData</span><span class="token punctuation">(</span>USART1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        g_uart1Len<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">USART_GetFlagStatus</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span> USART_FLAG_IDLE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        USART1<span class="token operator">-&gt;</span>SR<span class="token punctuation">;</span>
        USART1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>

        g_usart1RxFlag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"shoudao1:%s"</span><span class="token punctuation">,</span> g_uart1ReceiveBuff<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 

<span class="token comment">/*********************************************************************
 * LOCAL FUNCTIONS
 */</span>
<span class="token comment">/**
 @brief  配置嵌套向量中断控制器NVIC
 @param  无
 @retval 无
*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">NVIC_Configuration</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	NVIC_InitTypeDef NVIC_InitStructure<span class="token punctuation">;</span>
  
	<span class="token comment">/* 嵌套向量中断控制器组选择 */</span>
	<span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* 配置串口的 NVIC设置*/</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> DEBUG_USART_IRQ<span class="token punctuation">;</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>
	<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>


</code></pre> 
<p>main.c</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"bsp_usart.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token function">USART1_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 数据处理</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>g_usart1RxFlag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 数据处理，这里添加用户自定义处理，处理g_uart1ReceiveBuff后清空</span>
			

			g_usart1RxFlag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			g_uart1Len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token function">memset</span><span class="token punctuation">(</span>g_uart1ReceiveBuff<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>g_uart1ReceiveBuff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>	
		<span class="token function">vTaskDelay</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* 1ms启动读一次 */</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<p>• 由 <a href="https://blog.csdn.net/qq_34118600?spm=1011.2124.3001.5113">青梅煮久</a> 写于 2021 年 04 月 26 日</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bb0311ee43dda560b9919bf1945e3d60/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Kali ❀ Nmap史上最详细参数解析梳理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b582f386dc9386aad5e29ee579de072a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">线性表（链表）——单链表、双链表、循环单链表、循环双链表</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>