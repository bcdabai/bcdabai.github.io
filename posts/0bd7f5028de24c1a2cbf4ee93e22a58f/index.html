<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RocketMQ发送接收项目实战&#43;对cos或者oss服务上的pdf文件和图片加水印 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="RocketMQ发送接收项目实战&#43;对cos或者oss服务上的pdf文件和图片加水印" />
<meta property="og:description" content="使用mq的原因：因为项目中文件上传比较多，需要使用mq分担当前系统线程压力，所以单独使用一个服务来处理文件上传，加快文件上传速度的同时也缓解了当前服务的处理压力
核心服务1【一个项目】
发送mq：
GeneralFileEvent【需要发送给mq处理的参数，自己业务里需要的，封装了一个类,看你们自己需要】
@Data public class GeneralFileEvent {//发送mq的参数 private ContentsAnnexReq file;//附件文件 private String companyName; //公司名 private Long orgUserId;//关联文件id /** * 发布对象类型 * 1.按照部门批量发布 * 2.按照公司发布 * 3.按照人员发布 */ private Integer levelType; } RocketTopicConstant【mq目的的名字】
public class RocketTopicConstant { public static final String GENERAL_ADD_PAUSE = &#34;hhr_general_over_dev&#34;; public static final String GENERAL_UPDATE_PAUSE = &#34;hhr_general_update_over_dev&#34;; } 业务核心代码
//发送mq处理文件上传代参数 GeneralFileEvent fileEvent = new GeneralFileEvent(); fileEvent.setFile(file); fileEvent.setCompanyName(company.getName()); fileEvent.setOrgUserId(orgUser.getId()); fileEvent.setLevelType(req.getLevelType()); Message&lt;GeneralFileEvent&gt; destroyMessage = MessageBuilder.withPayload(fileEvent).build(); rocketMQTemplate.syncSend(RocketTopicConstant.GENERAL_UPDATE_PAUSE, destroyMessage); 配置文件：配置mq" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/0bd7f5028de24c1a2cbf4ee93e22a58f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-23T16:53:35+08:00" />
<meta property="article:modified_time" content="2022-07-23T16:53:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RocketMQ发送接收项目实战&#43;对cos或者oss服务上的pdf文件和图片加水印</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>使用mq的原因：因为项目中文件上传比较多，需要使用mq分担当前系统线程压力，所以单独使用一个服务来处理文件上传，加快文件上传速度的同时也缓解了当前服务的处理压力</p> 
</blockquote> 
<p>核心服务1【一个项目】<br> <strong>发送mq：</strong></p> 
<p><em>GeneralFileEvent</em>【需要发送给mq处理的参数，自己业务里需要的，封装了一个类,看你们自己需要】</p> 
<pre><code class="prism language-csharp">@Data
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GeneralFileEvent</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//发送mq的参数</span>
    <span class="token keyword">private</span> <span class="token class-name">ContentsAnnexReq</span> file<span class="token punctuation">;</span><span class="token comment">//附件文件</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> companyName<span class="token punctuation">;</span> <span class="token comment">//公司名</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> orgUserId<span class="token punctuation">;</span><span class="token comment">//关联文件id</span>
    <span class="token comment">/**
     * 发布对象类型
     * 1.按照部门批量发布
     * 2.按照公司发布
     * 3.按照人员发布
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> levelType<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre> 
<p><em>RocketTopicConstant</em>【mq目的的名字】</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RocketTopicConstant</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> final <span class="token class-name">String</span> GENERAL_ADD_PAUSE <span class="token operator">=</span> <span class="token string">"hhr_general_over_dev"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> final <span class="token class-name">String</span> GENERAL_UPDATE_PAUSE <span class="token operator">=</span> <span class="token string">"hhr_general_update_over_dev"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>业务核心代码</p> 
<pre><code class="prism language-csharp">  <span class="token comment">//发送mq处理文件上传代参数</span>
                        <span class="token class-name">GeneralFileEvent</span> fileEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GeneralFileEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        fileEvent<span class="token punctuation">.</span><span class="token function">setFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        fileEvent<span class="token punctuation">.</span><span class="token function">setCompanyName</span><span class="token punctuation">(</span>company<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        fileEvent<span class="token punctuation">.</span><span class="token function">setOrgUserId</span><span class="token punctuation">(</span>orgUser<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        fileEvent<span class="token punctuation">.</span><span class="token function">setLevelType</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getLevelType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Message<span class="token punctuation">&lt;</span>GeneralFileEvent<span class="token punctuation">&gt;</span></span> destroyMessage <span class="token operator">=</span> MessageBuilder<span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>fileEvent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span>RocketTopicConstant<span class="token punctuation">.</span>GENERAL_UPDATE_PAUSE<span class="token punctuation">,</span> destroyMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>配置文件：配置mq</p> 
<pre><code class="prism language-csharp">rocketmq<span class="token punctuation">:</span>
  name<span class="token operator">-</span>server<span class="token punctuation">:</span> mq的ip地址<span class="token punctuation">:</span>端口号
  producer<span class="token punctuation">:</span>
    <span class="token keyword">group</span><span class="token punctuation">:</span> pass<span class="token operator">-</span>test<span class="token operator">-</span><span class="token keyword">group</span>
    <span class="token preprocessor property"># 发送失败重试次数</span>
    retry<span class="token operator">-</span>times<span class="token operator">-</span><span class="token keyword">when</span><span class="token operator">-</span>send<span class="token operator">-</span>failed<span class="token punctuation">:</span> <span class="token number">2</span>
  message<span class="token punctuation">:</span>
    <span class="token preprocessor property">#消息发送mq主题文件上传</span>
    overTopic<span class="token punctuation">:</span> <span class="token class-name">hhr_general_over_dev</span>
    generalUpdateTopic<span class="token punctuation">:</span> hhr_general_update_over_dev
    <span class="token preprocessor property">#消息发送ma消息组</span>
    overGroup<span class="token punctuation">:</span> <span class="token class-name">hhr_general_over_dev_group</span>
    generalUpdateGroup<span class="token punctuation">:</span> hhr_general_update_over_dev_group

</code></pre> 
<p>一个处理服务【一个项目】<br> 接收mq<br> GeranlAddListener【配置监听器：用于处理你自己要处理的数据接收mq传来的参数做处理】</p> 
<pre><code class="prism language-csharp">
import com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>filehandling<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>GeneralConstants<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>filehandling<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>IdConstant<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>filehandling<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>RocketConsumerConstant<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>filehandling<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>RocketTopicConstant<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>filehandling<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>PartnerGeneralContentsFileAnnex<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>filehandling<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>PartnerGeneralContentsFileAnnexAble<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>filehandling<span class="token punctuation">.</span>listener<span class="token punctuation">.</span><span class="token keyword">event</span><span class="token punctuation">.</span>ContentsAnnexReq<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>filehandling<span class="token punctuation">.</span>listener<span class="token punctuation">.</span><span class="token keyword">event</span><span class="token punctuation">.</span>GeneralFileEvent<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>filehandling<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>id<span class="token punctuation">.</span>service<span class="token punctuation">.</span>IdGeneratorService<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>filehandling<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>PartnerGeneralContentsFileAnnexAbleMapper<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>filehandling<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span>PartnerGeneralContentsFileAnnexMapper<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>filehandling<span class="token punctuation">.</span>tool<span class="token punctuation">.</span>SpringBeanUtil<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>itextpdf<span class="token punctuation">.</span>text<span class="token punctuation">.</span>BaseColor<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>itextpdf<span class="token punctuation">.</span>text<span class="token punctuation">.</span>Element<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>itextpdf<span class="token punctuation">.</span>text<span class="token punctuation">.</span>pdf<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>szzz<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>oss<span class="token punctuation">.</span>OSS<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>szzz<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>oss<span class="token punctuation">.</span>cos<span class="token punctuation">.</span>CosClient<span class="token punctuation">;</span>
import lombok<span class="token punctuation">.</span>SneakyThrows<span class="token punctuation">;</span>
import lombok<span class="token punctuation">.</span><span class="token keyword">extern</span><span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>fileupload<span class="token punctuation">.</span>FileItem<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>fileupload<span class="token punctuation">.</span>disk<span class="token punctuation">.</span>DiskFileItemFactory<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span>FileUtils<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOUtils<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RocketMQMessageListener<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>core<span class="token punctuation">.</span>RocketMQListener<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>dom4j<span class="token punctuation">.</span>DocumentException<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Autowired<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Qualifier<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>MediaType<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Component<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Transactional<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span>MultipartFile<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>multipart<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>CommonsMultipartFile<span class="token punctuation">;</span>

import javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Resource<span class="token punctuation">;</span>
import javax<span class="token punctuation">.</span>imageio<span class="token punctuation">.</span>ImageIO<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>awt<span class="token punctuation">.</span>image<span class="token punctuation">.</span>BufferedImage<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>URL<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Date<span class="token punctuation">;</span>

<span class="token comment">/**
 * //接收mq
 */</span>
@<span class="token function">RocketMQMessageListener</span><span class="token punctuation">(</span>topic <span class="token operator">=</span> RocketTopicConstant<span class="token punctuation">.</span>GENERAL_PAUSE<span class="token punctuation">,</span> consumerGroup <span class="token operator">=</span> RocketConsumerConstant<span class="token punctuation">.</span>GENERAL_PAUSE<span class="token punctuation">)</span>
@Component
@Slf4j
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GeranlAddListener</span> <span class="token return-type class-name">implements</span> RocketMQListener<span class="token operator">&lt;</span>GeneralFileEvent<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//接收mq</span>

    @Resource
    <span class="token keyword">private</span> <span class="token class-name">PartnerGeneralContentsFileAnnexMapper</span> annexMapper<span class="token punctuation">;</span>
    @Resource
    <span class="token keyword">private</span> <span class="token class-name">PartnerGeneralContentsFileAnnexAbleMapper</span> ableMapper<span class="token punctuation">;</span>
    @Resource
    <span class="token keyword">private</span> <span class="token class-name">IdGeneratorService</span> idGeneratorService<span class="token punctuation">;</span>

    <span class="token return-type class-name">@Autowired</span>
    @<span class="token function">Qualifier</span><span class="token punctuation">(</span><span class="token string">"cosClient"</span><span class="token punctuation">)</span>
    <span class="token class-name">OSS</span> cosClient<span class="token punctuation">;</span>
    @<span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"${oss.settings.COS.domain}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> domain<span class="token punctuation">;</span>



    @Override
    <span class="token return-type class-name">@SneakyThrows</span>
    @<span class="token function">Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">GeneralFileEvent</span> fileEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//接收参数</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"文件上传"</span><span class="token punctuation">,</span>fileEvent<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"================="</span><span class="token operator">+</span>fileEvent<span class="token punctuation">.</span><span class="token function">getCompanyName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"==========OrgUserId="</span><span class="token operator">+</span>fileEvent<span class="token punctuation">.</span><span class="token function">getOrgUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Long</span> orgUserId <span class="token operator">=</span> fileEvent<span class="token punctuation">.</span><span class="token function">getOrgUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> companyName <span class="token operator">=</span> fileEvent<span class="token punctuation">.</span><span class="token function">getCompanyName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ContentsAnnexReq</span> file <span class="token operator">=</span> fileEvent<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> levelType <span class="token operator">=</span> fileEvent<span class="token punctuation">.</span><span class="token function">getLevelType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>levelType<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//人员</span>
            <span class="token comment">//1.全部存储不加水印表file_annex表</span>
            <span class="token class-name">PartnerGeneralContentsFileAnnex</span> annex<span class="token operator">=</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">PartnerGeneralContentsFileAnnex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            annex<span class="token punctuation">.</span><span class="token function">setOrgUserFileId</span><span class="token punctuation">(</span>orgUserId<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//org_user表id</span>
            annex<span class="token punctuation">.</span><span class="token function">setAnnexUrl</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getAnnexUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            annex<span class="token punctuation">.</span><span class="token function">setAnnexName</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getAnnexName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            annex<span class="token punctuation">.</span><span class="token function">setDownloadStatus</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getDownloadStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            annex<span class="token punctuation">.</span><span class="token function">setPreviewStatus</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPreviewStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            annex<span class="token punctuation">.</span><span class="token function">setDownloadEnableStatus</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getDownloadEnableStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            annex<span class="token punctuation">.</span><span class="token function">setFileType</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            annex<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            annex<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            annex<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idGeneratorService<span class="token punctuation">.</span><span class="token function">generatorId</span><span class="token punctuation">(</span>IdConstant<span class="token punctuation">.</span>annexId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            annexMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>annex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2.获取文件类型，添加水印表【根据附件类型，确定要不要加水印【pdf和图片】】</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>annex<span class="token punctuation">.</span><span class="token function">getDownloadStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//需要加水印的</span>
                <span class="token comment">//pdf</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>annex<span class="token punctuation">.</span><span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"pdf"</span><span class="token punctuation">)</span><span class="token operator">||</span>annex<span class="token punctuation">.</span><span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"PDF"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//这些文件类型可以加水印</span>
                    <span class="token comment">//3.添加annex_able表</span>
                    <span class="token class-name">PartnerGeneralContentsFileAnnexAble</span> annexAble<span class="token operator">=</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">PartnerGeneralContentsFileAnnexAble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//4.上传带水印的文件（用于下载的时候带水印）</span>
                    <span class="token class-name">String</span> Url<span class="token operator">=</span> <span class="token function">setPdfMark</span><span class="token punctuation">(</span>annex<span class="token punctuation">.</span><span class="token function">getAnnexUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>companyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===========【添加】人员加pdf水印，公司名称=============="</span><span class="token operator">+</span>companyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    annexAble<span class="token punctuation">.</span><span class="token function">setAnnexId</span><span class="token punctuation">(</span>annex<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    annexAble<span class="token punctuation">.</span><span class="token function">setAnnexUrl</span><span class="token punctuation">(</span>Url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    annexAble<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    annexAble<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    annexAble<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idGeneratorService<span class="token punctuation">.</span><span class="token function">generatorId</span><span class="token punctuation">(</span>IdConstant<span class="token punctuation">.</span>annexAbleId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ableMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>annexAble<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//图片</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>annex<span class="token punctuation">.</span><span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"jpg"</span><span class="token punctuation">)</span><span class="token operator">||</span>annex<span class="token punctuation">.</span><span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"png"</span><span class="token punctuation">)</span><span class="token operator">||</span>annex<span class="token punctuation">.</span><span class="token function">getFileType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"jpeg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//3.添加annex_able表</span>
                    <span class="token class-name">PartnerGeneralContentsFileAnnexAble</span> annexAble<span class="token operator">=</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">PartnerGeneralContentsFileAnnexAble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//4.上传带水印的图片（用于下载的时候带水印）</span>
                    <span class="token class-name">String</span> Url<span class="token operator">=</span>  <span class="token function">markImageByText</span><span class="token punctuation">(</span>companyName<span class="token punctuation">,</span> annex<span class="token punctuation">.</span><span class="token function">getAnnexUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"===========【添加】人员加图片水印，公司名称=============="</span><span class="token operator">+</span>companyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    annexAble<span class="token punctuation">.</span><span class="token function">setAnnexId</span><span class="token punctuation">(</span>annex<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    annexAble<span class="token punctuation">.</span><span class="token function">setAnnexUrl</span><span class="token punctuation">(</span>Url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    annexAble<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    annexAble<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    annexAble<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idGeneratorService<span class="token punctuation">.</span><span class="token function">generatorId</span><span class="token punctuation">(</span>IdConstant<span class="token punctuation">.</span>annexAbleId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ableMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>annexAble<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>




    @SneakyThrows
    <span class="token keyword">public</span> <span class="token return-type class-name">String</span> <span class="token function">setPdfMark</span><span class="token punctuation">(</span><span class="token class-name">String</span> cosOriginalUrl<span class="token punctuation">,</span><span class="token class-name">String</span> waterMarkName<span class="token punctuation">)</span> <span class="token class-name">throws</span> DocumentException<span class="token punctuation">,</span> IOException <span class="token punctuation">{<!-- --></span>

        cosClient<span class="token operator">=</span>SpringBeanUtil<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>CosClient<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果你想直接输出到某个路径，将os参数改为descFile(具体输出路径)</span>
        <span class="token comment">//BufferedOutputStream bos = new BufferedOutputStream(new FileOutputStream(new File(descFile)));</span>
        <span class="token class-name">URL</span> urlFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">URL</span><span class="token punctuation">(</span>cosOriginalUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> file1 <span class="token operator">=</span> urlFile<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//带水印的</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">"watermark_url"</span><span class="token punctuation">,</span> <span class="token string">".pdf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//不带水印</span>
        <span class="token class-name">File</span> file2 <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">"original"</span><span class="token punctuation">,</span> <span class="token string">".pdf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FileUtils<span class="token punctuation">.</span><span class="token function">copyInputStreamToFile</span><span class="token punctuation">(</span>urlFile<span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> file2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OutputStream</span> os <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//String waterMarkName = "数字众智";</span>
        <span class="token class-name">PdfReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PdfReader</span><span class="token punctuation">(</span>file2<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PdfStamper</span> stamper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PdfStamper</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> os<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">int</span></span> total <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">getNumberOfPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token class-name">PdfContentByte</span> content<span class="token punctuation">;</span>
        BaseFont <span class="token keyword">base</span> <span class="token operator">=</span> BaseFont<span class="token punctuation">.</span><span class="token function">createFont</span><span class="token punctuation">(</span><span class="token string">"STSong-Light"</span><span class="token punctuation">,</span> <span class="token string">"UniGB-UCS2-H"</span><span class="token punctuation">,</span> BaseFont<span class="token punctuation">.</span>EMBEDDED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PdfGState</span> gs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PdfGState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> total<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            content <span class="token operator">=</span> stamper<span class="token punctuation">.</span><span class="token function">getOverContent</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在内容上方加水印</span>
            <span class="token comment">// content = stamper.getUnderContent(i); //在内容下方加水印</span>
            gs<span class="token punctuation">.</span><span class="token function">setFillOpacity</span><span class="token punctuation">(</span><span class="token number">0.3f</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 透明度</span>
            content<span class="token punctuation">.</span><span class="token function">setGState</span><span class="token punctuation">(</span>gs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            content<span class="token punctuation">.</span><span class="token function">beginText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            content<span class="token punctuation">.</span><span class="token function">setColorFill</span><span class="token punctuation">(</span>BaseColor<span class="token punctuation">.</span>RED<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//BLACK</span>
            content<span class="token punctuation">.</span><span class="token function">setFontAndSize</span><span class="token punctuation">(</span><span class="token keyword">base</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            content<span class="token punctuation">.</span><span class="token function">setTextMatrix</span><span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            content<span class="token punctuation">.</span><span class="token function">showTextAligned</span><span class="token punctuation">(</span>Element<span class="token punctuation">.</span>ALIGN_CENTER<span class="token punctuation">,</span> waterMarkName<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//150控制水印的y轴位置上下</span>
            content<span class="token punctuation">.</span><span class="token function">endText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        stamper<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MultipartFile</span> multipartFile <span class="token operator">=</span> <span class="token function">getMultipartFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//上传带水印文件</span>
        <span class="token class-name">String</span> put <span class="token operator">=</span> cosClient<span class="token punctuation">.</span><span class="token function">simpleUpload</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> multipartFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取上传带水印的文件地址</span>
        <span class="token class-name">String</span> cosFileUrl<span class="token operator">=</span>domain<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        file2<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span>  cosFileUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>




    <span class="token comment">/**
     * 给图片添加水印文字、可设置水印文字的旋转角度
     *
     * @param logoText
     * @param srcImgPath
     * @param targerPath
     * @param degree
     */</span>
    @SneakyThrows
    <span class="token keyword">public</span> <span class="token return-type class-name">String</span>  <span class="token function">markImageByText</span><span class="token punctuation">(</span><span class="token class-name">String</span> logoText<span class="token punctuation">,</span> <span class="token class-name">String</span> srcImgPath<span class="token punctuation">,</span> <span class="token class-name">String</span> targerPath<span class="token punctuation">,</span> <span class="token class-name">Integer</span> degree<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cosClient<span class="token operator">=</span> SpringBeanUtil<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>CosClient<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果你想直接输出到某个路径，将os参数改为descFile(具体输出路径)</span>
        <span class="token comment">//BufferedOutputStream bos = new BufferedOutputStream(new FileOutputStream(new File(descFile)));</span>
        <span class="token class-name">URL</span> urlFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">URL</span><span class="token punctuation">(</span>srcImgPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> file1 <span class="token operator">=</span> urlFile<span class="token punctuation">.</span><span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//带水印的</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">"watermark_url"</span><span class="token punctuation">,</span> <span class="token string">".png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//不带水印</span>
        <span class="token class-name">File</span> file2 <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">createTempFile</span><span class="token punctuation">(</span><span class="token string">"original"</span><span class="token punctuation">,</span> <span class="token string">".png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FileUtils<span class="token punctuation">.</span><span class="token function">copyInputStreamToFile</span><span class="token punctuation">(</span>urlFile<span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> file2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        InputStream <span class="token keyword">is</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">OutputStream</span> os <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>


        <span class="token comment">// 1、源图片</span>
        <span class="token class-name">Image</span> srcImg <span class="token operator">=</span> ImageIO<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>file2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BufferedImage</span> buffImg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BufferedImage</span><span class="token punctuation">(</span>srcImg<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> srcImg<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> BufferedImage<span class="token punctuation">.</span>TYPE_INT_RGB<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2、得到画笔对象</span>
        <span class="token class-name">Graphics2D</span> g <span class="token operator">=</span> buffImg<span class="token punctuation">.</span><span class="token function">createGraphics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3、设置对线段的锯齿状边缘处理</span>
        g<span class="token punctuation">.</span><span class="token function">setRenderingHint</span><span class="token punctuation">(</span>RenderingHints<span class="token punctuation">.</span>KEY_INTERPOLATION<span class="token punctuation">,</span> RenderingHints<span class="token punctuation">.</span>VALUE_INTERPOLATION_BILINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        g<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>
                srcImg<span class="token punctuation">.</span><span class="token function">getScaledInstance</span><span class="token punctuation">(</span>srcImg<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        srcImg<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Image<span class="token punctuation">.</span>SCALE_SMOOTH<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4、设置水印旋转</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> degree<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            g<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">toRadians</span><span class="token punctuation">(</span>degree<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> buffImg<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> buffImg<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5、设置水印文字颜色</span>
        g<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>GeneralConstants<span class="token punctuation">.</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6、设置水印文字Font</span>
        g<span class="token punctuation">.</span><span class="token function">setFont</span><span class="token punctuation">(</span>GeneralConstants<span class="token punctuation">.</span>font<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 7、设置水印文字透明度</span>
        g<span class="token punctuation">.</span><span class="token function">setComposite</span><span class="token punctuation">(</span>AlphaComposite<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>AlphaComposite<span class="token punctuation">.</span>SRC_ATOP<span class="token punctuation">,</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 8、第一参数-&gt;设置的内容，后面两个参数-&gt;文字在图片上的坐标位置(x,y)</span>
        g<span class="token punctuation">.</span><span class="token function">drawString</span><span class="token punctuation">(</span>logoText<span class="token punctuation">,</span> GeneralConstants<span class="token punctuation">.</span>positionWidth<span class="token punctuation">,</span> GeneralConstants<span class="token punctuation">.</span>positionHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 9、释放资源</span>
        g<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 10、生成图片</span>
        os <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ImageIO<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffImg<span class="token punctuation">,</span> <span class="token string">"PNG"</span><span class="token punctuation">,</span> os<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//JPG</span>

        <span class="token class-name">MultipartFile</span> multipartFile <span class="token operator">=</span> <span class="token function">getMultipartFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//上传带水印文件</span>
        <span class="token class-name">String</span> put <span class="token operator">=</span> cosClient<span class="token punctuation">.</span><span class="token function">simpleUpload</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> multipartFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取上传带水印的文件地址</span>
        <span class="token class-name">String</span> cosFileUrl<span class="token operator">=</span>domain<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        file2<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span><span class="token keyword">out</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>cosFileUrl<span class="token operator">+</span><span class="token string">"=============路径地址========================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span>  cosFileUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>





    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">MultipartFile</span> <span class="token function">getMultipartFile</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">FileItem</span> item <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DiskFileItemFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createItem</span><span class="token punctuation">(</span><span class="token string">"file"</span>
                <span class="token punctuation">,</span> MediaType<span class="token punctuation">.</span>MULTIPART_FORM_DATA_VALUE
                <span class="token punctuation">,</span> <span class="token boolean">true</span>
                <span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> input <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token class-name">OutputStream</span> os <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 流转移</span>
            IOUtils<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> os<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Invalid file: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CommonsMultipartFile</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>GeneralFileEvent</p> 
<pre><code class="prism language-csharp">import lombok<span class="token punctuation">.</span>Data<span class="token punctuation">;</span>

@Data
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GeneralFileEvent</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//发送mq的参数</span>
    <span class="token keyword">private</span> <span class="token class-name">ContentsAnnexReq</span> file<span class="token punctuation">;</span><span class="token comment">//附件文件</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> companyName<span class="token punctuation">;</span> <span class="token comment">//公司名</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> orgUserId<span class="token punctuation">;</span><span class="token comment">//关联文件id</span>
    <span class="token comment">/**
     * 发布对象类型
     * 1.按照部门批量发布
     * 2.按照公司发布
     * 3.按照人员发布
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> levelType<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>ContentsAnnexReq</p> 
<pre><code class="prism language-csharp">
@Data
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContentsAnnexReq</span> <span class="token punctuation">{<!-- --></span>

    @<span class="token function">Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"附件名称"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> annexName<span class="token punctuation">;</span>

    @<span class="token function">Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"附件地址"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> annexUrl<span class="token punctuation">;</span>

    @<span class="token function">Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"文件类型"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>

    @<span class="token function">Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"文件大小"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> size<span class="token punctuation">;</span>

    @<span class="token function">Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"预览水印：0无水印false，1加水印true"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> previewStatus<span class="token punctuation">;</span>

    @<span class="token function">Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"下载水印：0无水印false，1加水印true"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> downloadStatus<span class="token punctuation">;</span>

    @<span class="token function">Schema</span><span class="token punctuation">(</span>description <span class="token operator">=</span> <span class="token string">"可下载：不可下载false，1可以下载true"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> downloadEnableStatus<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>RocketTopicConstant</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RocketTopicConstant</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> final <span class="token class-name">String</span> GENERAL_PAUSE <span class="token operator">=</span> <span class="token string">"hhr_general_over_dev"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> final <span class="token class-name">String</span> GENERAL_UPDATE_PAUSE <span class="token operator">=</span> <span class="token string">"hhr_general_update_over_dev"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>配置配置文件</p> 
<pre><code class="prism language-csharp">rocketmq<span class="token punctuation">:</span>
  name<span class="token operator">-</span>server<span class="token punctuation">:</span> mq的ip地址<span class="token punctuation">:</span>端口号
  producer<span class="token punctuation">:</span>
    <span class="token keyword">group</span><span class="token punctuation">:</span> pass<span class="token operator">-</span>test<span class="token operator">-</span><span class="token keyword">group</span>
    <span class="token preprocessor property"># 发送失败重试次数</span>
    retry<span class="token operator">-</span>times<span class="token operator">-</span><span class="token keyword">when</span><span class="token operator">-</span>send<span class="token operator">-</span>failed<span class="token punctuation">:</span> <span class="token number">2</span>
  message<span class="token punctuation">:</span>
    <span class="token preprocessor property">#消息发送mq主题文件上传</span>
    overTopic<span class="token punctuation">:</span> <span class="token class-name">hhr_general_over_dev</span>
    generalUpdateTopic<span class="token punctuation">:</span> hhr_general_update_over_dev
    <span class="token preprocessor property">#消息发送ma消息组</span>
    overGroup<span class="token punctuation">:</span> <span class="token class-name">hhr_general_over_dev_group</span>
    generalUpdateGroup<span class="token punctuation">:</span> hhr_general_update_over_dev_group
</code></pre> 
<p>依赖【两个项目里都需要加mq依赖】</p> 
<pre><code class="prism language-csharp">   <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> pdf添加水印 <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>mvnrepository<span class="token punctuation">.</span>com<span class="token operator">/</span>artifact<span class="token operator">/</span>com<span class="token punctuation">.</span>itextpdf<span class="token operator">/</span>itextpdf <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>itextpdf<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>itextpdf<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">5.5</span><span class="token number">.13</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>mvnrepository<span class="token punctuation">.</span>com<span class="token operator">/</span>artifact<span class="token operator">/</span>com<span class="token punctuation">.</span>itextpdf<span class="token operator">/</span>itext<span class="token operator">-</span>asian <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>itextpdf<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>itext<span class="token operator">-</span>asian<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">5.2</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>


   
       <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>图片加水印<span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>net<span class="token punctuation">.</span>coobird<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>thumbnailator<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">0.4</span><span class="token number">.8</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>


        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>rocketmq<span class="token operator">-</span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.2</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>


</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0255c28aa490e34ac24ab96bf893c624/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">获取git仓库代码并部署在linux上</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b311945a9e6280e3b6ff6366defaae6a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">idea注释模版配置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>