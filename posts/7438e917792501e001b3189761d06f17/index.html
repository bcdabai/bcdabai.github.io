<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>VINS-Mono&#43;Fusion源码解析系列（八）：IMU预积分的代码实现 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="VINS-Mono&#43;Fusion源码解析系列（八）：IMU预积分的代码实现" />
<meta property="og:description" content="1. IMU预积分的代码部分 —— integration_base.h （1）预积分的构造函数
IntegrationBase(const Eigen::Vector3d &amp;_acc_0, // 初始加速度 const Eigen::Vector3d &amp;_gyr_0, // 初始角速度 const Eigen::Vector3d &amp;_linearized_ba, // 初始加速度零偏 const Eigen::Vector3d &amp;_linearized_bg) // 初始角速度零偏 // 列表初始化 使用括号{}内的输入参数给对应的成员变量赋初值 : acc_0{_acc_0}, gyr_0{_gyr_0}, linearized_acc{_acc_0}, linearized_gyr{_gyr_0}, linearized_ba{_linearized_ba}, linearized_bg{_linearized_bg}, // 初始时只有自身与自身才有联系，因此雅可比矩阵初始化为15*15的单位阵 jacobian{Eigen::Matrix&lt;double, 15, 15&gt;::Identity()}, // 初始时没有任何IMU数据，因此协方差矩阵为15*15的全零矩阵 covariance{Eigen::Matrix&lt;double, 15, 15&gt;::Zero()}, // 初始时的位移为0 sum_dt{0.0}, delta_p{Eigen::Vector3d::Zero()}, // 初始时的姿态为单位四元数 delta_q{Eigen::Quaterniond::Identity()}, // 初始时的速度为0 delta_v{Eigen::Vector3d::Zero()} { /* noise对应的是前面的噪声协方差矩阵V 由于噪声n是18*3的，而V = n*n^T，故V是(18*1)*(1*18) = 18*18 下面根据n = [n_{ak}, n_{wk}, n_{ak&#43;1}, n_{wk&#43;1}, n_{ba}, n_{bw}]给协方差矩阵noise(V)赋初值 参数ACC_N，GYR_N，ACC_W，GYR_W是通过在parameters." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/7438e917792501e001b3189761d06f17/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-24T08:31:01+08:00" />
<meta property="article:modified_time" content="2023-10-24T08:31:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">VINS-Mono&#43;Fusion源码解析系列（八）：IMU预积分的代码实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_IMU__integration_baseh_0"></a>1. IMU预积分的代码部分 —— integration_base.h</h2> 
<p>（1）预积分的构造函数</p> 
<pre><code class="prism language-cpp"><span class="token function">IntegrationBase</span><span class="token punctuation">(</span><span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>_acc_0<span class="token punctuation">,</span>           <span class="token comment">// 初始加速度</span>
                <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>_gyr_0<span class="token punctuation">,</span>           <span class="token comment">// 初始角速度</span>
                <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>_linearized_ba<span class="token punctuation">,</span>   <span class="token comment">// 初始加速度零偏</span>
                <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>_linearized_bg<span class="token punctuation">)</span>   <span class="token comment">// 初始角速度零偏</span>
          <span class="token comment">// 列表初始化  使用括号{}内的输入参数给对应的成员变量赋初值</span>
        <span class="token operator">:</span> acc_0<span class="token punctuation">{<!-- --></span>_acc_0<span class="token punctuation">}</span><span class="token punctuation">,</span> gyr_0<span class="token punctuation">{<!-- --></span>_gyr_0<span class="token punctuation">}</span><span class="token punctuation">,</span> 
		  linearized_acc<span class="token punctuation">{<!-- --></span>_acc_0<span class="token punctuation">}</span><span class="token punctuation">,</span> linearized_gyr<span class="token punctuation">{<!-- --></span>_gyr_0<span class="token punctuation">}</span><span class="token punctuation">,</span>
          linearized_ba<span class="token punctuation">{<!-- --></span>_linearized_ba<span class="token punctuation">}</span><span class="token punctuation">,</span> linearized_bg<span class="token punctuation">{<!-- --></span>_linearized_bg<span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token comment">// 初始时只有自身与自身才有联系，因此雅可比矩阵初始化为15*15的单位阵</span>
          jacobian<span class="token punctuation">{<!-- --></span>Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Matrix</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
          <span class="token comment">// 初始时没有任何IMU数据，因此协方差矩阵为15*15的全零矩阵</span>
          covariance<span class="token punctuation">{<!-- --></span>Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Matrix</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token comment">// 初始时的位移为0</span>
          sum_dt<span class="token punctuation">{<!-- --></span><span class="token number">0.0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> delta_p<span class="token punctuation">{<!-- --></span>Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Vector3d</span><span class="token double-colon punctuation">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  
          <span class="token comment">// 初始时的姿态为单位四元数</span>
          delta_q<span class="token punctuation">{<!-- --></span>Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Quaterniond</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
          <span class="token comment">// 初始时的速度为0</span>
          delta_v<span class="token punctuation">{<!-- --></span>Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Vector3d</span><span class="token double-colon punctuation">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">{<!-- --></span>
<span class="token comment">/*
  noise对应的是前面的噪声协方差矩阵V
  由于噪声n是18*3的，而V = n*n^T，故V是(18*1)*(1*18) = 18*18
  下面根据n = [n_{ak}, n_{wk}, n_{ak+1}, n_{wk+1}, n_{ba}, n_{bw}]给协方差矩阵noise(V)赋初值
  参数ACC_N，GYR_N，ACC_W，GYR_W是通过在parameters.cpp中读取配置文件来获取的
*/</span>
        noise <span class="token operator">=</span> Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Matrix</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">// 与i时刻的加速度噪声有关</span>
        noise<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token punctuation">(</span>ACC_N <span class="token operator">*</span> ACC_N<span class="token punctuation">)</span> <span class="token operator">*</span> Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Matrix3d</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		    		
        <span class="token comment">// 与i时刻的角速度噪声有关</span>
        noise<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token punctuation">(</span>GYR_N <span class="token operator">*</span> GYR_N<span class="token punctuation">)</span> <span class="token operator">*</span> Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Matrix3d</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 与i+1时刻的加速度噪声有关</span>
        noise<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token punctuation">(</span>ACC_N <span class="token operator">*</span> ACC_N<span class="token punctuation">)</span> <span class="token operator">*</span> Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Matrix3d</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 与i+1时刻的角速度噪声有关</span>
        noise<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token punctuation">(</span>GYR_N <span class="token operator">*</span> GYR_N<span class="token punctuation">)</span> <span class="token operator">*</span> Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Matrix3d</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 与噪声的加速度偏置有关</span>
        noise<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token punctuation">(</span>ACC_W<span class="token operator">*</span>ACC_W<span class="token punctuation">)</span> <span class="token operator">*</span> Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Matrix3d</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 与噪声的角速度偏置有关</span>
        noise<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token punctuation">(</span>GYR_W<span class="token operator">*</span>GYR_W<span class="token punctuation">)</span> <span class="token operator">*</span> Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Matrix3d</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>（2）预积分调用接口</p> 
<pre><code class="prism language-cpp"><span class="token comment">// 每来一帧数据，就进行一次IMU预积分处理，而调用的接口就是push_back</span>
<span class="token comment">// 关于形参，dt：当前传入的IMU数据对应的时间戳  acc：当前时刻IMU数据中加速度计的值  </span>
<span class="token comment">// gyr：当前时刻IMU数据中陀螺仪的值</span>
<span class="token keyword">void</span> <span class="token function">push_back</span><span class="token punctuation">(</span><span class="token keyword">double</span> dt<span class="token punctuation">,</span> <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>acc<span class="token punctuation">,</span> <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>gyr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 相关时间差和传感器数据存入对应的buf中，方便后续repropagate(发生在VIO初始化过程中)</span>
    dt_buf<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 获取传入imu数据中的时间戳</span>
    acc_buf<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 获取传入imu数据中的加速度</span>
    gyr_buf<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>gyr<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 获取传入imu数据中的角速度</span>
    <span class="token comment">// 根据获取到的时间戳、加速度、角速度，在propagate中进行预积分</span>
    <span class="token function">propagate</span><span class="token punctuation">(</span>dt<span class="token punctuation">,</span> acc<span class="token punctuation">,</span> gyr<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre> 
<p>（3）propagate()</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">propagate</span><span class="token punctuation">(</span><span class="token keyword">double</span> _dt<span class="token punctuation">,</span> 
               <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>_acc_1<span class="token punctuation">,</span> 
               <span class="token keyword">const</span> Eigen<span class="token double-colon punctuation">::</span>Vector3d <span class="token operator">&amp;</span>_gyr_1<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将传入的参数赋值给对应的成员变量进行备份</span>
        <span class="token comment">// 方便下面完成中值积分后将当前时刻(i+1)传入的变量作为下一次的上一时刻值(i)</span>
        dt <span class="token operator">=</span> _dt<span class="token punctuation">;</span>
        acc_1 <span class="token operator">=</span> _acc_1<span class="token punctuation">;</span>
        gyr_1 <span class="token operator">=</span> _gyr_1<span class="token punctuation">;</span>
        <span class="token comment">// 定义要计算的p, v, q</span>
        Vector3d result_delta_p<span class="token punctuation">;</span>
        Quaterniond result_delta_q<span class="token punctuation">;</span>
        Vector3d result_delta_v<span class="token punctuation">;</span>
        Vector3d result_linearized_ba<span class="token punctuation">;</span>
        Vector3d result_linearized_bg<span class="token punctuation">;</span>

        <span class="token comment">// 中值积分</span>
        <span class="token function">midPointIntegration</span><span class="token punctuation">(</span>
            _dt<span class="token punctuation">,</span>                   <span class="token comment">// 输入的相邻帧的时间差</span>
            acc_0<span class="token punctuation">,</span>                 <span class="token comment">// 输入的i时刻的加速度    (加速度计读数)</span>
            gyr_0<span class="token punctuation">,</span>                 <span class="token comment">// 输入的i时刻的角速度    (陀螺仪读数)</span>
            _acc_1<span class="token punctuation">,</span>                <span class="token comment">// 输入的i+1时刻的加速度  (加速度计读数)</span>
            _gyr_1<span class="token punctuation">,</span>                <span class="token comment">// 输入的i+1时刻的角速度  (陀螺仪读数)</span>
            delta_p<span class="token punctuation">,</span>               <span class="token comment">// 输入的i时刻的alpha</span>
            delta_q<span class="token punctuation">,</span>               <span class="token comment">// 输入的i时刻的gamma</span>
            delta_v<span class="token punctuation">,</span>               <span class="token comment">// 输入的i时刻的beta</span>
            linearized_ba<span class="token punctuation">,</span>         <span class="token comment">// 输入的加速度零偏  (在两帧图像的预积分中保持不变)</span>
            linearized_bg<span class="token punctuation">,</span>         <span class="token comment">// 输入的角速度零偏  (在两帧图像的预积分中保持不变)</span>
            result_delta_p<span class="token punctuation">,</span>        <span class="token comment">// 输出的i+1时刻的alpha</span>
            result_delta_q<span class="token punctuation">,</span>        <span class="token comment">// 输出的i+1时刻的gamma</span>
            result_delta_v<span class="token punctuation">,</span>        <span class="token comment">// 输出的i+1时刻的beta</span>
            result_linearized_ba<span class="token punctuation">,</span>  <span class="token comment">// 输出的i+1时刻的加速度零偏 (保持不变，输入 = 输出)</span>
            result_linearized_bg<span class="token punctuation">,</span>  <span class="token comment">// 输出的i+1时刻的角速度零偏 (保持不变，输入 = 输出)</span>
            <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// 是否更新雅可比的标志位  1表示要更新</span>

        <span class="token comment">// 将中值积分结果赋值给对应的成员变量</span>
        delta_p <span class="token operator">=</span> result_delta_p<span class="token punctuation">;</span>
        delta_q <span class="token operator">=</span> result_delta_q<span class="token punctuation">;</span>
        delta_v <span class="token operator">=</span> result_delta_v<span class="token punctuation">;</span>
        linearized_ba <span class="token operator">=</span> result_linearized_ba<span class="token punctuation">;</span>
        linearized_bg <span class="token operator">=</span> result_linearized_bg<span class="token punctuation">;</span>
        delta_q<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 归一化，单位四元数才能表示旋转</span>
        <span class="token comment">// 将当前传入的值作为下一次的上一时刻值</span>
        sum_dt <span class="token operator">+=</span> dt<span class="token punctuation">;</span>
        acc_0 <span class="token operator">=</span> acc_1<span class="token punctuation">;</span>
        gyr_0 <span class="token operator">=</span> gyr_1<span class="token punctuation">;</span>  
     
    <span class="token punctuation">}</span>
</code></pre> 
<p>（4）中值积分</p> 
<p>​ <strong>注意</strong>：代码中的下标与上述理论推导公式中的不一样，这里的k表示初始的第i个图像帧，i与i+1表示初始图像帧之后的两相邻IMU时刻。</p> 
<p>​ 根据传入的相邻时刻IMU数据，使用中值积分进行预积分计算，代码中的变量与公式中的对应如下：</p> 
<pre><code class="prism language-cpp">_gyr_0<span class="token operator">:</span> 对应公式中的w_i<span class="token operator">^</span>b，表示第i个IMU时刻的角速度
_gyr_1<span class="token operator">:</span> 对应公式中的w_<span class="token punctuation">{<!-- --></span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token operator">^</span>b，表示第i<span class="token operator">+</span><span class="token number">1</span>个IMU时刻的角速度
un_gyr<span class="token operator">:</span> 对应公式中的\bar<span class="token punctuation">{<!-- --></span>w<span class="token punctuation">}</span>_i<span class="token operator">^</span>b，表示第i个IMU与第i<span class="token operator">+</span><span class="token number">1</span>个IMU的中值角速度
    
_acc_0<span class="token operator">:</span> 对应公式中的a_i<span class="token operator">^</span>b，表示第i个IMU时刻的加速度计读数 <span class="token punctuation">(</span>包含偏置<span class="token punctuation">)</span>
delta_q<span class="token operator">:</span> 对应公式中的q_<span class="token punctuation">{<!-- --></span>b_i<span class="token punctuation">}</span><span class="token operator">^</span><span class="token punctuation">{<!-- --></span>b_k<span class="token punctuation">}</span>，表示第i个IMU时刻到第k个图像帧<span class="token punctuation">(</span>公式中任意第i时刻<span class="token punctuation">)</span>的姿态
un_acc_0<span class="token operator">:</span> 表示将body坐标系下第i时刻的加速度去掉偏置后转换到第k个图像帧上得到的加速度
    
_acc_1<span class="token operator">:</span> 对应公式中的a_<span class="token punctuation">{<!-- --></span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token operator">^</span>b，表示第i<span class="token operator">+</span><span class="token number">1</span>个IMU时刻的加速度计读数 <span class="token punctuation">(</span>包含偏置<span class="token punctuation">)</span>
result_delta_q<span class="token operator">:</span> 对应公式中的q_<span class="token punctuation">{<!-- --></span>b_<span class="token punctuation">{<!-- --></span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">^</span><span class="token punctuation">{<!-- --></span>b_k<span class="token punctuation">}</span>，表示第i<span class="token operator">+</span><span class="token number">1</span>个IMU时刻到第k个图像帧的姿态
un_acc_1<span class="token operator">:</span> 表示将body坐标系下第i<span class="token operator">+</span><span class="token number">1</span>时刻的加速度去掉偏置后转换到第k个图像帧上得到的加速度
    
result_delta_p<span class="token operator">:</span> 对应公式中的\alpha_<span class="token punctuation">{<!-- --></span>b_<span class="token punctuation">{<!-- --></span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">^</span><span class="token punctuation">{<!-- --></span>b_k<span class="token punctuation">}</span>，表示第i<span class="token operator">+</span><span class="token number">1</span>个IMU时刻到 第k个图像帧的位移预积分量
result_delta_v<span class="token operator">:</span> 对应公式中的\beta_<span class="token punctuation">{<!-- --></span>b_<span class="token punctuation">{<!-- --></span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">^</span><span class="token punctuation">{<!-- --></span>b_k<span class="token punctuation">}</span>，表示第i<span class="token operator">+</span><span class="token number">1</span>个IMU时刻 到 第k个图像帧的速度预积分量

linearized_ba<span class="token punctuation">,</span> result_linearized_ba<span class="token operator">:</span> 第i与第i<span class="token operator">+</span><span class="token number">1</span>两相邻时刻的加速度偏置，二者相等
linearized_bg， result_linearized_bg<span class="token operator">:</span> 第i与第i<span class="token operator">+</span><span class="token number">1</span>两相邻时刻的角速度偏置，二者相等
</code></pre> 
<pre><code class="prism language-cpp"><span class="token comment">/*
  注意：这里的k表示的是第k个图像帧，k+1表示的是第k+1个图像帧
            i表示第i个imu数据，i+1表示第i+1个imu数据
  由于IMU频率高于相机频率，故这两个图像帧之间会存在多个时刻的IMU数据，对应关系大致如下
      k                  k+1
      1 2 3 ... i i+1 ...
  传入的是相邻时刻的imu相关量，而不是相邻关键帧之间的imu相关量
  因此，将两个相邻图像帧之间的相邻imu数据记为第i时刻与第i+1时刻的imu数据
*/</span>
<span class="token comment">// Step 1：每来一个IMU，根据中值积分更新预积分量</span>
<span class="token comment">// Step 2：计算出矩阵F和矩阵V</span>
<span class="token comment">// Step 3：使用矩阵F和V更新雅可比矩阵和协方差矩阵</span>
<span class="token keyword">void</span> <span class="token function">midPointIntegration</span><span class="token punctuation">(</span>
            _dt<span class="token punctuation">,</span>                   <span class="token comment">// 输入的相邻帧的时间差</span>
            acc_0<span class="token punctuation">,</span>                 <span class="token comment">// 输入的i时刻的加速度    (加速度计读数)</span>
            gyr_0<span class="token punctuation">,</span>                 <span class="token comment">// 输入的i时刻的角速度    (陀螺仪读数)</span>
            _acc_1<span class="token punctuation">,</span>                <span class="token comment">// 输入的i+1时刻的加速度  (加速度计读数)</span>
            _gyr_1<span class="token punctuation">,</span>                <span class="token comment">// 输入的i+1时刻的角速度  (陀螺仪读数)</span>
            delta_p<span class="token punctuation">,</span>               <span class="token comment">// 输入的i时刻的alpha</span>
            delta_q<span class="token punctuation">,</span>               <span class="token comment">// 输入的i时刻的gamma</span>
            delta_v<span class="token punctuation">,</span>               <span class="token comment">// 输入的i时刻的beta</span>
            linearized_ba<span class="token punctuation">,</span>         <span class="token comment">// 输入的加速度零偏  (在两帧图像的预积分中保持不变)</span>
            linearized_bg<span class="token punctuation">,</span>         <span class="token comment">// 输入的角速度零偏  (在两帧图像的预积分中保持不变)</span>
            result_delta_p<span class="token punctuation">,</span>        <span class="token comment">// 输出的i+1时刻的alpha</span>
            result_delta_q<span class="token punctuation">,</span>        <span class="token comment">// 输出的i+1时刻的gamma</span>
            result_delta_v<span class="token punctuation">,</span>        <span class="token comment">// 输出的i+1时刻的beta</span>
            result_linearized_ba<span class="token punctuation">,</span>  <span class="token comment">// 输出的i+1时刻的加速度零偏 (保持不变，输入 = 输出)</span>
            result_linearized_bg<span class="token punctuation">,</span>  <span class="token comment">// 输出的i+1时刻的角速度零偏 (保持不变，输入 = 输出)</span>
            <span class="token number">1</span><span class="token punctuation">)</span>                     <span class="token comment">// 是否更新雅可比的标志位  为1表示要更新</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Step 1：每来一个IMU，根据中值积分更新预积分量</span>
<span class="token comment">/*
  delta_q表示的是第i个IMU数据到初始的第k个图像帧的姿态，对应公式中的q_{b_i}^{b_k}
  _acc_0表示第i个IMU时刻的IMU加速度计读数(包含偏置)
  _acc_0 - linearized_ba表示第i个IMU时刻的IMU加速度计读数(去掉偏置)
  un_acc_0表示将body坐标系下第i个IMU数据去掉偏置后的加速度转换到body坐标系下第k个图像帧上，对应公式中的q_{b_i}^{b_k} * a_i^b
*/</span>
    Vector3d un_acc_0 <span class="token operator">=</span> delta_q <span class="token operator">*</span> <span class="token punctuation">(</span>_acc_0 <span class="token operator">-</span> linearized_ba<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// _gyr_0:第i个IMU时刻的角速度, _gyr_1:第i+1个IMU时刻的角速度</span>
    <span class="token comment">// un_gyr:第i个IMU时刻与第i+1个IMU时刻的中值角速度</span>
    Vector3d un_gyr <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>_gyr_0 <span class="token operator">+</span> _gyr_1<span class="token punctuation">)</span> <span class="token operator">-</span> linearized_bg<span class="token punctuation">;</span>
    <span class="token comment">// 代入中值角速度，根据公式R_{i+1}^k = R_i^k * R_{i+1}^i</span>
    <span class="token comment">// 即result_delta_q表示当前第i+1个IMU时刻到初始的第k个图像帧的IMU姿态(预积分量gamma)</span>
    result_delta_q <span class="token operator">=</span> delta_q <span class="token operator">*</span> <span class="token function">Quaterniond</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">un_gyr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">un_gyr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>   <span class="token function">un_gyr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
  _acc_1表示body坐标系下第i+1个IMU时刻的IMU加速度计读数(包含偏置)
  un_acc_1表示将body坐标系下去偏置后的第i+1个IMU时刻的加速度转换到初始的第k个图像帧上，对应公式中的a_{i+1}^k = q_{i+1}^k * a_{b_{i+1}}
*/</span>
    Vector3d un_acc_1 <span class="token operator">=</span> result_delta_q <span class="token operator">*</span> <span class="token punctuation">(</span>_acc_1 <span class="token operator">-</span> linearized_ba<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// un_acc: 表示将第i个IMU时刻与第i+1个IMU时刻的加速度转换到初始第k帧上的中值加速度(去掉偏置后的)</span>
    Vector3d un_acc <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>un_acc_0 <span class="token operator">+</span> un_acc_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// result_delta_p表示代入中值加速度后计算出的当前第i+1个IMU时刻到初始的第k个图像帧的预积分量alpha</span>
    result_delta_p <span class="token operator">=</span> delta_p <span class="token operator">+</span> delta_v <span class="token operator">*</span> _dt <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> un_acc <span class="token operator">*</span> _dt <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
    <span class="token comment">// result_delta_v表示代入中值加速度后计算出的当前第i+1个IMU时刻到初始的第k个图像帧的预积分量beta</span>
    result_delta_v <span class="token operator">=</span> delta_v <span class="token operator">+</span> un_acc <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
    <span class="token comment">// 加速度偏置在预积分中保持不变(第i个IMU时刻的加速度偏置与第i+1个IMU时刻的加速度偏置相等)</span>
    result_linearized_ba <span class="token operator">=</span> linearized_ba<span class="token punctuation">;</span>
    <span class="token comment">// 角速度偏置在预积分中保持不变(第i个IMU时刻的角速度偏置与第i+1个IMU时刻的角速度偏置相等)</span>
    result_linearized_bg <span class="token operator">=</span> linearized_bg<span class="token punctuation">;</span>         
    <span class="token comment">// 按照理论推导公式，更新协方差矩阵及雅克比</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>update_jacobian<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 事先计算出3个反对称矩阵</span>
        <span class="token comment">// [1/2 * (w_i + w_{i+1}) - b_{w_i}]^</span>
        Vector3d w_x <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>_gyr_0 <span class="token operator">+</span> _gyr_1<span class="token punctuation">)</span> <span class="token operator">-</span> linearized_bg<span class="token punctuation">;</span>
        <span class="token comment">// (a_i - b_{a_i})^</span>
        Vector3d a_0_x <span class="token operator">=</span> _acc_0 <span class="token operator">-</span> linearized_ba<span class="token punctuation">;</span>
        <span class="token comment">// (a_{i+1} - b_{a_i})^</span>
        Vector3d a_1_x <span class="token operator">=</span> _acc_1 <span class="token operator">-</span> linearized_ba<span class="token punctuation">;</span>
        Matrix3d R_w_x<span class="token punctuation">,</span> R_a_0_x<span class="token punctuation">,</span> R_a_1_x<span class="token punctuation">;</span>  

        R_w_x <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">w_x</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">w_x</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 <span class="token function">w_x</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">w_x</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 <span class="token operator">-</span><span class="token function">w_x</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">w_x</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">;</span>
        R_a_0_x <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">a_0_x</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">a_0_x</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token function">a_0_x</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">a_0_x</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token operator">-</span><span class="token function">a_0_x</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">a_0_x</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">;</span>
        R_a_1_x <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">a_1_x</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">a_1_x</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token function">a_1_x</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">a_1_x</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   <span class="token operator">-</span><span class="token function">a_1_x</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">a_1_x</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">;</span>

        MatrixXd F <span class="token operator">=</span> <span class="token class-name">MatrixXd</span><span class="token double-colon punctuation">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// (0, 0)开始的3*3矩阵块为单位阵</span>
        F<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">Matrix3d</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对应推导出的系数矩阵F中的f01</span>
        F<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.25</span> <span class="token operator">*</span> delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> R_a_0_x <span class="token operator">*</span> _dt 					<span class="token operator">*</span> _dt <span class="token operator">+</span> <span class="token operator">-</span><span class="token number">0.25</span> <span class="token operator">*</span> result_delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
                   <span class="token operator">*</span> R_a_1_x <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token class-name">Matrix3d</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> R_w_x <span class="token operator">*</span> _dt<span class="token punctuation">)</span> <span class="token operator">*</span> _dt <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// (0, 6)开始的3*3矩阵块为delta_t</span>
        F<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">MatrixXd</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// 对应推导出的系数矩阵F中的f03</span>
        F<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.25</span> <span class="token operator">*</span> <span class="token punctuation">(</span>delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
                              result_delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// 对应推导出的系数矩阵F中的f04</span>
        F<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.25</span> <span class="token operator">*</span> result_delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> 
            				   R_a_1_x <span class="token operator">*</span> _dt <span class="token operator">*</span> _dt <span class="token operator">*</span> <span class="token operator">-</span>_dt<span class="token punctuation">;</span>
        <span class="token comment">// 对应推导出的系数矩阵F中的f11</span>
        F<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">Matrix3d</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> R_w_x <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// (3, 12)开始的3*3矩阵块为-delta_t</span>
        F<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0</span> <span class="token operator">*</span> <span class="token class-name">MatrixXd</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// 对应推导出的系数矩阵F中的f21</span>
        F<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> R_a_0_x <span class="token operator">*</span> _dt 						<span class="token operator">+</span> <span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> result_delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> R_a_1_x  
            			<span class="token operator">*</span> <span class="token punctuation">(</span><span class="token class-name">Matrix3d</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> R_w_x <span class="token operator">*</span> _dt<span class="token punctuation">)</span> <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// (6, 6)开始的3*3矩阵块为单位阵</span>
        F<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">Matrix3d</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对应推导出的系数矩阵F中的f23</span>
        F<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
                              result_delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// 对应推导出的系数矩阵F中的f24</span>
        F<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> result_delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> 
            				   R_a_1_x <span class="token operator">*</span> _dt <span class="token operator">*</span> <span class="token operator">-</span>_dt<span class="token punctuation">;</span>
        <span class="token comment">// (9, 9)开始的3*3矩阵块为单位阵</span>
        F<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">Matrix3d</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// (12, 12)开始的3*3矩阵块为单位阵</span>
        F<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">Matrix3d</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 矩阵V中关于噪声项相对于推导出的相差一个负号，对于高斯白噪声而言相差一个符号并没有影响</span>
        MatrixXd V <span class="token operator">=</span> <span class="token class-name">MatrixXd</span><span class="token double-colon punctuation">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对应推导出的系数矩阵V中的v00</span>
        V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token number">0.25</span> <span class="token operator">*</span> delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// 对应推导出的系数矩阵V中的v01</span>
        V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token number">0.25</span> <span class="token operator">*</span> <span class="token operator">-</span>result_delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> 
            				   R_a_1_x  <span class="token operator">*</span> _dt <span class="token operator">*</span> _dt <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// 对应推导出的系数矩阵V中的v02</span>
        V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token number">0.25</span><span class="token operator">*</span>result_delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span>_dt <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// 对应推导出的系数矩阵V中的v03  v01 = v03</span>
        V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span>  V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// (3, 3)开始的3*3矩阵块为-0.5 * delta_t</span>
        V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token class-name">MatrixXd</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// (3, 9)开始的3*3矩阵块为-0.5 * delta_t</span>
        V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token class-name">MatrixXd</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// (6, 0)开始的3*3矩阵块为-0.5 * Ri * delta_t</span>
        V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token number">0.5</span> <span class="token operator">*</span> delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// 对应推导出的系数矩阵V中的v21</span>
        V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token operator">-</span>result_delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> 
            				   R_a_1_x  <span class="token operator">*</span> _dt <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// (6, 6)开始的3*3矩阵块为-0.5 * R_i+1 * delta_t</span>
        V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token number">0.5</span> <span class="token operator">*</span> result_delta_q<span class="token punctuation">.</span><span class="token function">toRotationMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// 对应推导出的系数矩阵V中的v23  v23 = v21</span>
        V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">=</span>  V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// (9, 12)开始的3*3矩阵块为delta_t</span>
        V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">MatrixXd</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt<span class="token punctuation">;</span>
        <span class="token comment">// (12, 15)开始的3*3矩阵块为delta_t</span>
        V<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">block</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">MatrixXd</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> _dt<span class="token punctuation">;</span>

        <span class="token comment">// 更新雅可比，避免后续因零偏变化导致重新计算预积分</span>
        jacobian <span class="token operator">=</span> F <span class="token operator">*</span> jacobian<span class="token punctuation">;</span>  
        <span class="token comment">// 更新协方差矩阵</span>
        covariance <span class="token operator">=</span> F <span class="token operator">*</span> covariance <span class="token operator">*</span> F<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> V <span class="token operator">*</span> noise <span class="token operator">*</span> V<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a1b89b8abc2ce10ccc20eaabc4ca03b3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux命令之网络命令ifconfig</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6ab072111c42e9ab668b8bfa9c645f08/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Spring Cloud Alibaba】seata分布式事务官方入门案例导读2（实战版）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>