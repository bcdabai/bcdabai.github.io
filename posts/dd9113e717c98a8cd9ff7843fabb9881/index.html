<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android串口编程入门 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android串口编程入门" />
<meta property="og:description" content="基本常识 串口通信：指串口按位（bit）发送和接收字节。尽管比按字节（byte）的并行通信慢，但是串口可以使用一根线发送数据的同时接收数据。在串口通信中，常用的协议包括RS232、RS-422和RS-485。
在Android开发中，对串口数据的读取和写入，实际上是是通过I/O流读取、写入文件数据。
串口用完记得关闭（文件关闭）。 串口关闭，即是文件流关闭。
一、准备so库以及相关SDK 用到开源库serialPort-api
下载其中相关so库资源导入到项目中
其中libs文件夹中的armeabi、armeabi-v7a代表不同的cpu架构，可以根据自己app运行环境自动加载，通常只需要armeabi就可以了。android_serialport_api包下的两个文件则是用来加载so库以及提供相关接口的封装SDK；
注意：这里的包名不可以修改，必须跟so库中的保持一致（这同样在以后对接其他外设SDK时，在加载so库方法经常会遇到方法名加载不到的原因）
在拷贝完相关so库之后我们仍然需要在gradle中指定我们支持的cpu架构，保持libs包中一致即可：
defaultConfig { ndk { abiFilters &#34;armeabi&#34;,&#34;armeabi-v7a&#34; // &#34;armeabi&#34;, &#34;x86&#34;, &#34;arm64-v8a&#34; } } SerialPort类：
/* * Copyright 2009 Cedric Priscal * * Licensed under the Apache License, Version 2.0 (the &#34;License&#34;); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/dd9113e717c98a8cd9ff7843fabb9881/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-23T09:09:48+08:00" />
<meta property="article:modified_time" content="2022-08-23T09:09:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android串口编程入门</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>基本常识</h3> 
<p>串口通信：指串口按位（bit）发送和接收字节。尽管比按字节（byte）的并行通信慢，但是串口可以使用一根线发送数据的同时接收数据。在串口通信中，常用的协议包括RS232、RS-422和RS-485。</p> 
<p>在Android开发中，对串口数据的读取和写入，实际上是是通过I/O流读取、写入文件数据。<br> 串口用完记得关闭（文件关闭）。 串口关闭，即是文件流关闭。</p> 
<h3><a id="soSDK_5"></a>一、准备so库以及相关SDK</h3> 
<p>用到开源库<a href="https://github.com/cepr/android-serialport-api">serialPort-api</a><br> 下载其中相关so库资源导入到项目中<br> <img src="https://images2.imgbox.com/cd/e1/SCF2tVbH_o.png" alt="在这里插入图片描述"><br> 其中<strong>libs</strong>文件夹中的armeabi、armeabi-v7a代表不同的cpu架构，可以根据自己app运行环境自动加载，通常只需要armeabi就可以了。android_serialport_api包下的两个文件则是用来加载so库以及提供相关接口的封装SDK；</p> 
<blockquote> 
 <p>注意：这里的包名不可以修改，必须跟so库中的保持一致（这同样在以后对接其他外设SDK时，在加载so库方法经常会遇到方法名加载不到的原因）</p> 
</blockquote> 
<p>在拷贝完相关so库之后我们仍然需要在gradle中指定我们支持的cpu架构，保持libs包中一致即可：</p> 
<pre><code class="prism language-java">    defaultConfig <span class="token punctuation">{<!-- --></span>
        ndk <span class="token punctuation">{<!-- --></span>
            abiFilters <span class="token string">"armeabi"</span><span class="token punctuation">,</span><span class="token string">"armeabi-v7a"</span>  <span class="token comment">// "armeabi", "x86", "arm64-v8a"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>SerialPort类：</p> 
<pre><code class="prism language-java"><span class="token comment">/*
 * Copyright 2009 Cedric Priscal
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License. 
 */</span>

<span class="token keyword">package</span> <span class="token namespace">android_serialport_api</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Log</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileDescriptor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileOutputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">OutputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Scanner</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SerialPort</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TAG <span class="token operator">=</span> <span class="token string">"SerialPort"</span><span class="token punctuation">;</span>

	<span class="token comment">/*
	 * Do not remove or rename the field mFd: it is used by native method close();
	 */</span>
	<span class="token keyword">private</span> <span class="token class-name">FileDescriptor</span> mFd<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">FileInputStream</span> mFileInputStream<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">FileOutputStream</span> mFileOutputStream<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">SerialPort</span><span class="token punctuation">(</span><span class="token class-name">File</span> device<span class="token punctuation">,</span> <span class="token keyword">int</span> baudrate<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> parity<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SecurityException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>

		<span class="token comment">/* Check access permission */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>device<span class="token punctuation">.</span><span class="token function">canRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>device<span class="token punctuation">.</span><span class="token function">canWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">/* Missing read/write permission, trying to chmod the file */</span>
				<span class="token comment">//Runtime.getRuntime().exec 会提示需要ACCESS_SUPERUSER权限</span>
				<span class="token class-name">Process</span> su<span class="token punctuation">;</span>
				su <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"/system/bin/su"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//				su = Runtime.getRuntime().exec("/system/xbin/su");</span>
				<span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">"chmod 666 "</span> <span class="token operator">+</span> device<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span> <span class="token operator">+</span> <span class="token string">"exit\n"</span><span class="token punctuation">;</span>
				su<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token class-name">WatchThread</span> wt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WatchThread</span><span class="token punctuation">(</span>su<span class="token punctuation">)</span><span class="token punctuation">;</span>
				wt<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>su<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>device<span class="token punctuation">.</span><span class="token function">canRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>device<span class="token punctuation">.</span><span class="token function">canWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> commandStream <span class="token operator">=</span> wt<span class="token punctuation">.</span><span class="token function">getStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					wt<span class="token punctuation">.</span><span class="token function">setOver</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		mFd <span class="token operator">=</span> <span class="token keyword">open</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> baudrate<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> parity<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mFd <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"native open returns null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		mFileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>mFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mFileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>mFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Getters and setters</span>
	<span class="token keyword">public</span> <span class="token class-name">InputStream</span> <span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> mFileInputStream<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">OutputStream</span> <span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> mFileOutputStream<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// JNI</span>
	<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">static</span> <span class="token class-name">FileDescriptor</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> baudrate<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> parity<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"serial_port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">class</span> <span class="token class-name">WatchThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Process</span> p<span class="token punctuation">;</span>
		<span class="token keyword">boolean</span>   over<span class="token punctuation">;</span>
		<span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> stream<span class="token punctuation">;</span>
		<span class="token keyword">public</span> <span class="token class-name">WatchThread</span><span class="token punctuation">(</span><span class="token class-name">Process</span> p<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>p <span class="token operator">=</span> p<span class="token punctuation">;</span>
			over <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			stream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>
				<span class="token class-name">Scanner</span> br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">||</span> over<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token keyword">while</span><span class="token punctuation">(</span>br<span class="token punctuation">.</span><span class="token function">hasNextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
						<span class="token class-name">String</span> tempStream <span class="token operator">=</span> br<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span><span class="token punctuation">(</span>tempStream<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">||</span>tempStream<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">;</span>
						stream<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tempStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOver</span><span class="token punctuation">(</span><span class="token keyword">boolean</span>   over<span class="token punctuation">)</span>   <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>over   <span class="token operator">=</span>   over<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">public</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> stream<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>从这个类中我们可以看到，通过System.loadLibrary来加载我们对应的so库，“serial_port”名称则对应libs文件夹下面的armeabi包中的so库名称，如果不是一致的则会抛出异常提示加载so库失败。</p> 
<pre><code class="prism language-java"><span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"serial_port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>当然我们有些也可以将so库放置在jni文件夹或者jnilib文件夹下面，如果我们so库防止的路径没有问题，但是在加载so库的时候仍然抛出异常提示找不到对应的so库，那么可能是我们程序并没有识别到相应的路径，这个时候我们就需要在gradle里面进行配置：</p> 
<pre><code class="prism language-java">    sourceSets<span class="token punctuation">.</span>main <span class="token punctuation">{<!-- --></span>
        jniLibs<span class="token punctuation">.</span>srcDir <span class="token string">"libs"</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>同时可以看到该类中封装的打开和关闭串口的方法：</p> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">static</span> <span class="token class-name">FileDescriptor</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token keyword">int</span> baudrate<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> parity<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>如果没有权限的也需要配置相关的系统权限，包括我们进行串口初始化时需要的root权限也是必须要的，如果没有root权限则无法进行串口初始化。到此为止我们串口编程的基本准备工作已经全部准备就绪。</p> 
<h3><a id="_173"></a>二、编写串口通讯工具类</h3> 
<p>首先我们需要编写的是串口通讯需要的工具类，该工具类主要解决一下几个问题：串口的打开、关闭、输入监听、输出等；同时该工具类作为全局唯一的操作类来进行串口通讯的统一管理：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">package</span> com<span class="token punctuation">.</span>xiye<span class="token punctuation">.</span>reservesamplecabinet<span class="token punctuation">.</span>manager

<span class="token keyword">import</span> android_serialport_api<span class="token punctuation">.</span>SerialPort
<span class="token keyword">import</span> com<span class="token punctuation">.</span>xiye<span class="token punctuation">.</span>reservesamplecabinet<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>L
<span class="token keyword">import</span> com<span class="token punctuation">.</span>xiye<span class="token punctuation">.</span>reservesamplecabinet<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>T
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>InputStream
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>OutputStream
<span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>InvalidParameterException

<span class="token comment">/**
 * Created by Administrator on 2018/8/3.
 */</span>
<span class="token keyword">class</span> BoxActionManager <span class="token keyword">private</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">val</span> instance <span class="token keyword">by</span> <span class="token function">lazy</span><span class="token punctuation">(</span>mode <span class="token operator">=</span> LazyThreadSafetyMode<span class="token punctuation">.</span>SYNCHRONIZED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">BoxActionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">var</span> mSerialPort<span class="token operator">:</span> SerialPort<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">private</span> <span class="token keyword">var</span> mOutputStream<span class="token operator">:</span> OutputStream<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">private</span> <span class="token keyword">var</span> mInputStream<span class="token operator">:</span> InputStream<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">private</span> <span class="token keyword">var</span> mReadDataThread<span class="token operator">:</span> Thread<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

        <span class="token comment">/**
         * 初始化锁控串口
         */</span>
        <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>IOException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">initSerialPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mSerialPort <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mSerialPort <span class="token operator">=</span> <span class="token function">getSerialPort</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"dev/ttyS0"</span></span><span class="token punctuation">,</span> <span class="token number">9600</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mSerialPort <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    T<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"串口初始化失败！"</span></span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
                mOutputStream <span class="token operator">=</span> mSerialPort<span class="token operator">?</span><span class="token punctuation">.</span>outputStream
                mInputStream <span class="token operator">=</span> mSerialPort<span class="token operator">?</span><span class="token punctuation">.</span>inputStream
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 初始化串口
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">getSerialPort</span><span class="token punctuation">(</span>parity<span class="token operator">:</span> Int<span class="token punctuation">,</span> path<span class="token operator">:</span> String<span class="token punctuation">,</span> baudrate<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> SerialPort<span class="token operator">?</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> mSerialPort<span class="token operator">:</span> SerialPort<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> baudrate <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token function">InvalidParameterException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                mSerialPort <span class="token operator">=</span> <span class="token function">SerialPort</span><span class="token punctuation">(</span><span class="token function">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> baudrate<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> SecurityException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> mSerialPort
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">init</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mSerialPort <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">initSerialPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">initThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 初始化串口读取线程
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">initThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mReadDataThread <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mReadDataThread <span class="token operator">=</span> Thread <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mInputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">val</span> count <span class="token operator">=</span> mInputStream<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token keyword">val</span> buffer <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
                            <span class="token keyword">val</span> size <span class="token operator">=</span> mInputStream<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
                            <span class="token keyword">val</span> hexStr <span class="token operator">=</span> TransUtils<span class="token punctuation">.</span><span class="token function">bytes2hex</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token function">onDataReceiver</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50L</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> InterruptedException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            mReadDataThread<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">onDataReceiver</span><span class="token punctuation">(</span>buffer<span class="token operator">:</span> ByteArray<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token punctuation">}</span>


    <span class="token annotation builtin">@Synchronized</span>
    <span class="token keyword">fun</span> <span class="token function">openDoor</span><span class="token punctuation">(</span>boardNo<span class="token operator">:</span> Int<span class="token punctuation">,</span> lockNo<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkSerialPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> cmd <span class="token operator">=</span> <span class="token function">byteArrayOf</span><span class="token punctuation">(</span>
            boardNo<span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0xF2</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">,</span> lockNo<span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            mOutputStream<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>TransUtils<span class="token punctuation">.</span><span class="token function">getSendDatas</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>
            mOutputStream<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            T<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token annotation builtin">@Synchronized</span>
    <span class="token keyword">fun</span> <span class="token function">queryDoor</span><span class="token punctuation">(</span>boardNo<span class="token operator">:</span> Int<span class="token punctuation">,</span> lockNo<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkSerialPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> cmd <span class="token operator">=</span> <span class="token function">byteArrayOf</span><span class="token punctuation">(</span>
            boardNo<span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0xF1</span><span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">,</span> lockNo<span class="token punctuation">.</span><span class="token function">toByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            mOutputStream<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>TransUtils<span class="token punctuation">.</span><span class="token function">getSendDatas</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>
            mOutputStream<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> IOException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            T<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在初始化方法中可以看到<strong>mSerialPort = getSerialPort(0, “dev/ttyS0”, 9600)</strong>，是指定了一个固定的串口进行初始化，我们也可以通过<strong>SerialPortFinder</strong>类中提供的方法进行一个动态的搜索串口并进行相关初始化，需要根据项目不同的需求来灵活使用。</p> 
<p>其中<strong>onDataReceiver</strong>方法则是监听到的输入信息，我们可以通过协议相关的约定进行一个解析来判断监听到的输入数据是否合法，同时解析出我们需要的数据帧。</p> 
<p>同样我们是通过**mOutputStream?.write()**方法来对数据输出，输出的数据帧同样是根据协议中的约定来进行组帧。</p> 
<p>感兴趣的同学可以通过<a href="https://blog.csdn.net/d38825/article/details/81240851">NDK开发中jni配置及调用GPIO</a>了解如何自己一步步编译属于自己的so库文件并运用到项目中</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0041e644a755e7d8beb1333493c57c5c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">idea下将项目添加至gitee</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a7a47c98f30d16635549ef86e8870250/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Unity Shader实现《氮气加速特效》</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>