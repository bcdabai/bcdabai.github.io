<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL 常踩的坑 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL 常踩的坑" />
<meta property="og:description" content="MySQL 常踩的坑【updating…】 1. 问题一 今天在执行一组SQL时，遇到了一个不可“逆天”的错误。导致数据库数据**“无故”**丢失！差点给公司带来无法挽回的损失！
2. SQL 过程 查看表dim_shop的数据 mysql&gt; select count(*) from dim_shop; &#43;----------&#43; | count(*) | &#43;----------&#43; | 2 | &#43;----------&#43; 1 row in set (0.00 sec) 创建一个表dim_shop_2 mysql&gt; create table dim_shop_2 -&gt; select -&gt; max(shop_key) -&gt; from dim_shop; Query OK, 1 row affected (0.23 sec) Records: 1 Duplicates: 0 Warnings: 0 注意创建临时表的SQL。可以看到dim_shop_2中只有一条数据。接着执行如下SQL：
mysql&gt; delete from dim_shop -&gt; where shop_key in (select shop_key from dim_shop_2); Query OK, 2 rows affected (0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/d59f49b8c454060243957fecaeadf49c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-12-04T18:28:26+08:00" />
<meta property="article:modified_time" content="2018-12-04T18:28:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL 常踩的坑</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="MySQL_updating_0"></a>MySQL 常踩的坑【updating…】</h4> 
<h5><a id="1__1"></a>1. 问题一</h5> 
<p>今天在执行一组SQL时，遇到了一个不可“逆天”的错误。导致数据库数据**“无故”**丢失！差点给公司带来无法挽回的损失！</p> 
<h5><a id="2_SQL__3"></a>2. SQL 过程</h5> 
<ul><li>查看表<code>dim_shop</code>的数据</li></ul> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dim_shop<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span>        <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<ul><li>创建一个表<code>dim_shop_2</code></li></ul> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">table</span> dim_shop_2
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">select</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token function">max</span><span class="token punctuation">(</span>shop_key<span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> dim_shop<span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.23</span> sec<span class="token punctuation">)</span>
Records: <span class="token number">1</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>
</code></pre> 
<p>注意创建临时表的SQL。可以看到dim_shop_2中只有一条数据。接着执行如下SQL：</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">delete</span> <span class="token keyword">from</span> dim_shop
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">where</span> shop_key <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> shop_key <span class="token keyword">from</span> dim_shop_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.11</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>最后查看dim_shop表的数据，<strong>发现为0条！</strong></p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> dim_shop<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span>        <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>到底是什么问题导致 <code>dim_shop</code> 的数据为0 条呢？主要原因如下。</p> 
<h5><a id="3__41"></a>3. 原因</h5> 
<p>我们创建表<code>dim_shop_2</code> 时的SQL如下：</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> dim_shop_2
<span class="token keyword">select</span>
<span class="token function">max</span><span class="token punctuation">(</span>shop_key<span class="token punctuation">)</span>
<span class="token keyword">from</span> dim_shop_temp<span class="token punctuation">;</span>
</code></pre> 
<p>注意这里的<code>max(shop_key)</code>，没有使用别名，导致出现的结果是下面这样：</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dim_shop_2<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+</span>
<span class="token operator">|</span> <span class="token function">max</span><span class="token punctuation">(</span>shop_key<span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+</span>
<span class="token operator">|</span>            <span class="token number">22</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>结果出来的表字段就是 <code>max(shop_key)</code> 。而不是 <code>shop_key</code> 。所以在执行删除语句时：</p> 
<pre><code class="prism language-sql"><span class="token keyword">delete</span> <span class="token keyword">from</span> dim_shop
<span class="token keyword">where</span> shop_key <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> shop_key <span class="token keyword">from</span> dim_shop_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>将<code>where</code> 之后的语句当做了<code>true</code>，所以将 <code>dim_shop</code> 中的数据全部删除了。<br> 单独执行如下SQL</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> shop_key <span class="token keyword">from</span> dim_shop_2<span class="token punctuation">;</span>
ERROR <span class="token number">1054</span> <span class="token punctuation">(</span><span class="token number">42</span>S22<span class="token punctuation">)</span>: Unknown <span class="token keyword">column</span> <span class="token string">'shop_key'</span> <span class="token operator">in</span> <span class="token string">'field list'</span>
</code></pre> 
<p>会报一个错误，但是mysql 却对这个错误置之不理。而是将其翻译成true，直接删除了整个表数据。</p> 
<h5><a id="2__72"></a>2. 问题二</h5> 
<p>常见的group by操作会带来一些问题。<br> 我们不能直接按照 <code>group by</code> 去取某一个字段对应的那一行值，这么取可能会是有问题的。如下：</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> start_date<span class="token punctuation">,</span>end_date<span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>shop_key<span class="token punctuation">)</span> <span class="token keyword">from</span> dim_shop_2 <span class="token keyword">group</span> <span class="token keyword">by</span> shop_id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------------------+---------------+</span>
<span class="token operator">|</span> start_date          <span class="token operator">|</span> end_date            <span class="token operator">|</span> <span class="token function">max</span><span class="token punctuation">(</span>shop_key<span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------------------+---------------+</span>
<span class="token operator">|</span> <span class="token number">2017</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">24</span> <span class="token number">13</span>:<span class="token number">11</span>:<span class="token number">58</span> <span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">21</span>:<span class="token number">00</span>:<span class="token number">45</span> <span class="token operator">|</span>             <span class="token number">5</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------------------+---------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>我们想取shop_key = 5这行的值，但是取出来的 <code>start_date</code> <code>end_date</code> 却是与如下的SQL 不同：</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> start_date<span class="token punctuation">,</span>end_date<span class="token punctuation">,</span> shop_key <span class="token keyword">from</span> dim_shop_2 <span class="token keyword">where</span> shop_key <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------------------+----------+</span>
<span class="token operator">|</span> start_date          <span class="token operator">|</span> end_date            <span class="token operator">|</span> shop_key <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------------------+----------+</span>
<span class="token operator">|</span> <span class="token number">2018</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">20</span>:<span class="token number">09</span>:<span class="token number">37</span> <span class="token operator">|</span> <span class="token number">9999</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>        <span class="token number">5</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+---------------------+----------+</span>
<span class="token number">1</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>即不能根据<code>group by</code> 取的 <code>max(shop_key)</code> 去获取 <code>max(shop_key)</code> 对应行的数据。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1efd04ba91e0cbbb94ee167fb06d74c5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">工具：HeidiSQL通过SSH方式连接关系型数据库</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e482f20be2e4e646f3036f9a5ee4b5b6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MySQL SQL Error: 1064, SQLState: 42000 错误</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>