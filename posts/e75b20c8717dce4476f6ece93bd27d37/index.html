<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【MySQL】死锁案例之七 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【MySQL】死锁案例之七" />
<meta property="og:description" content="一 前言 死锁，其实是一个很有意思也很有挑战的技术问题，大概每个DBA和部分开发同学都会在工作过程中遇见 。关于死锁我会持续写一个系列的案例分析，希望能够对想了解死锁的朋友有所帮助。 二 案例分析 2.1 业务场景 业务开发同学想同步数据，他们的逻辑是通过update 更新操作，如果更新记录返回的affect_rows为0，然后就调用insert语句进行插入初始化。如果插入失败则再进行更新操作，多个会话并发操作的情况下就出现死锁。 2.2 环境说明 MySQL 5.6.24 事务隔离级别为RR create table ty ( id int not null primary key auto_increment , c1 int not null default 0, c2 int not null default 0, c3 int not null default 0, unique key uc1(c1), unique key uc2(c2) ) engine=innodb ; insert into ty(c1,c2,c3) values(1,3,4),(6,6,10),(9,9,14); 2.3 测试用例 sess1 sess2 begin; begin; T1 update ty set c3=2 where c2=4; T2 update ty set c3=2 where c2=4; T3 insert into ty (c1,c2,c3) values(3,4,2); T4 insert into ty (c1,c2,c3) values(3,4,2); ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/e75b20c8717dce4476f6ece93bd27d37/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-03-27T23:07:34+08:00" />
<meta property="article:modified_time" content="2018-03-27T23:07:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【MySQL】死锁案例之七</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="preview-main"> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;"> <span style="font-family:Helvetica, arial, sans-serif;font-size:18px;font-weight:bold;">一 前言</span> </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 死锁，其实是一个很有意思也很有挑战的技术问题，大概每个DBA和部分开发同学都会在工作过程中遇见 。关于死锁我会持续写一个系列的案例分析，希望能够对想了解死锁的朋友有所帮助。 </p> 
 <h4 style="font-size:18px;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;"> 二 案例分析 </h4> 
 <h5 style="font-size:16px;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;"> 2.1 业务场景 </h5> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 业务开发同学想同步数据，他们的逻辑是<strong>通过update 更新操作，如果更新记录返回的affect_rows为0，然后就调用insert语句进行插入初始化</strong>。如果插入失败则再进行更新操作，多个会话并发操作的情况下就出现死锁。 </p> 
 <h5 style="font-size:16px;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;"> 2.2 环境说明 </h5> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> MySQL 5.6.24 事务隔离级别为RR </p> 
 <pre style="color:#3E3E3E;border-width:1px;border-style:solid;border-color:#CCCCCC;font-size:13px;line-height:19px;">create table ty (
  id int not null primary key auto_increment ,
  c1 int not null default 0,
  c2 int not null default 0,
  c3 int not null default 0,
  unique key uc1(c1),
  unique key uc2(c2)
) engine=innodb ;

insert into ty(c1,c2,c3) 
values(1,3,4),(6,6,10),(9,9,14);</pre> 
 <h5 style="font-size:16px;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;"> 2.3 测试用例 </h5> 
 <table cellspacing="0" cellpadding="0" style="width:670px;color:#3E3E3E;"><tbody><tr><td width="15" height="12" style="border:1px solid #000000;"> <br></td><td width="201" height="12" style="border:1px solid #000000;"> <p style="clear:both;min-height:1em;"> <span style="font-size:10px;line-height:normal;font-family:Helvetica;color:#000000;"><strong>sess1</strong></span> </p> </td><td width="194" height="12" style="border:1px solid #000000;"> <p style="clear:both;min-height:1em;"> <span style="font-size:10px;line-height:normal;font-family:Helvetica;color:#000000;"><strong>sess2</strong></span> </p> </td></tr><tr><td width="27" height="11" style="border:1px solid #000000;"> <br></td><td width="213" height="11" style="border:1px solid #000000;"> <p style="clear:both;min-height:1em;"> <span style="font-size:10px;line-height:normal;font-family:Helvetica;color:#000000;">begin;</span> </p> </td><td width="206" height="11" style="border:1px solid #000000;"> <p style="clear:both;min-height:1em;"> <span style="font-size:10px;line-height:normal;font-family:Helvetica;color:#000000;">begin;</span> </p> </td></tr><tr><td width="27" height="11" style="border:1px solid #000000;"> <p style="clear:both;min-height:1em;"> <span style="font-size:10px;line-height:normal;font-family:Helvetica;color:#000000;"><strong>T1</strong></span> </p> </td><td width="213" height="11" style="border:1px solid #000000;"> <p style="clear:both;min-height:1em;line-height:16px;"> <span style="font-size:10px;line-height:normal;font-family:Helvetica;color:#000000;">update ty set c3=2 where c2=4;</span> </p> </td><td width="206" height="11" style="border:1px solid #000000;"> <br></td></tr><tr><td width="27" height="11" style="border:1px solid #000000;"> <p style="clear:both;min-height:1em;"> <span style="font-size:10px;line-height:normal;font-family:Helvetica;color:#000000;"><strong>T2</strong></span> </p> </td><td width="213" height="11" style="border:1px solid #000000;"> <br></td><td width="206" height="11" style="border:1px solid #000000;"> <p style="clear:both;min-height:1em;"> <span style="font-size:10px;line-height:normal;font-family:Helvetica;color:#000000;">update ty set c3=2 where c2=4;</span> </p> </td></tr><tr><td width="27" height="12" style="border:1px solid #000000;"> <p style="clear:both;min-height:1em;"> <span style="font-size:10px;line-height:normal;font-family:Helvetica;color:#000000;"><strong>T3</strong></span> </p> </td><td width="213" height="12" style="border:1px solid #000000;"> <p style="clear:both;min-height:1em;"> <span style="font-size:10px;line-height:normal;font-family:Helvetica;color:#000000;">insert into ty (c1,c2,c3) values(3,4,2);</span> </p> </td><td width="206" height="12" style="border:1px solid #000000;"> <br></td></tr><tr><td width="27" height="47" style="border:1px solid #000000;"> <p style="clear:both;min-height:1em;"> <span style="font-size:10px;line-height:normal;font-family:Helvetica;color:#000000;"><strong>T4</strong></span> </p> </td><td width="213" height="47" style="border:1px solid #000000;"> <br></td><td width="206" height="47" style="border:1px solid #000000;"> <p style="clear:both;min-height:1em;"> <span style="font-size:10px;line-height:normal;font-family:Helvetica;color:#000000;">insert into ty (c1,c2,c3) values(3,4,2);</span> </p> <p style="clear:both;min-height:1em;"> <span style="font-size:10px;line-height:normal;font-family:Helvetica;color:#000000;">ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</span> </p> </td></tr></tbody></table> 
 <h5 style="font-size:16px;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;"> 2.4 死锁日志 </h5> 
 <pre style="color:#3E3E3E;border-width:1px;border-style:solid;border-color:#CCCCCC;font-size:13px;line-height:19px;">2018-03-27 17:59:23 0x7f75bf39d700
*** (1) TRANSACTION:
TRANSACTION 1863, ACTIVE 76 sec inserting
mysql tables in use 1, locked 1
LOCK WAIT 4 lock struct(s), heap size 1136, 3 row lock(s), undo log entries 1
MySQL thread id 382150, OS thread handle 56640, query id 28 localhost root update
insert into ty (c1,c2,c3) values(3,4,2)
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 28 page no 5 n bits 72 index uc2 of table `test`.`ty` trx id 1863 lock_mode X locks gap before rec insert intention waiting
*** (2) TRANSACTION:
TRANSACTION 1864, ACTIVE 65 sec inserting, thread declared inside InnoDB 5000
mysql tables in use 1, locked 1
3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1
MySQL thread id 382125, OS thread handle 40032, query id 62 localhost root update
insert into ty (c1,c2,c3) values(3,4,2)
*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 28 page no 5 n bits 72 index uc2 of table `test`.`ty` trx id 1864 lock_mode X locks gap before rec
*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 28 page no 4 n bits 72 index uc1 of table `test`.`ty` trx id 1864 lock mode S waiting
*** WE ROLL BACK TRANSACTION (2)</pre> 
 <h5 style="font-size:16px;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;"> 2.5 分析死锁日志 </h5> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> <strong>首先</strong>我们要再次强调insert 插入操作的加锁逻辑。 </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 第一阶段: 唯一性约束检查，先申请<strong>LOCK_S + LOCK_ORDINARY</strong> </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 第二阶段: 获取阶段一的锁并且insert成功之后,插入的位置有Gap锁:<strong>LOCK_INSERT_INTENTION</strong>,为了防止其他insert唯一键冲突。 </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 新数据插入完成之后:LOCK_X + LOCK_REC_NOT_GAP </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 对于insert操作来说，若发生唯一约束冲突，则需要对冲突的唯一索引加上S Next-key Lock。从这里会发现，即使是RC事务隔离级别，也同样会存在Next-Key Lock锁，从而阻塞并发。然而，文档没有说明的是，对于检测到冲突的唯一索引，等待线程在获得S Lock之后，还需要对下一个记录进行加锁，在源码中由函数row_ins_scan_sec_index_for_duplicate进行判断. </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> <strong>其次</strong> 我们需要了解锁的兼容性矩阵。<br><img src="https://images2.imgbox.com/ba/47/pTbBFUwy_o.jpg" width="700" height="135" alt=""></p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 从兼容性矩阵我们可以得到如下结论: </p> 
 <blockquote style="border-left:4px solid #DDDDDD;color:#777777;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 
  <p style="clear:both;min-height:1em;"> INSERT操作之间不会有冲突。 </p> 
  <p style="clear:both;min-height:1em;"> GAP,Next-Key会阻止Insert。 </p> 
  <p style="clear:both;min-height:1em;"> GAP和Record,Next-Key不会冲突 </p> 
  <p style="clear:both;min-height:1em;"> Record和Record、Next-Key之间相互冲突。 </p> 
  <p style="clear:both;min-height:1em;"> 已有的Insert锁不阻止任何准备加的锁。 </p> 
  <p style="clear:both;min-height:1em;"> 已经持有的gap 锁会阻塞插入意向锁INSERT_INTENTION  </p> 
 </blockquote> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> <strong>另外</strong> 对于通过唯一索引更新或者删除不存在的记录，会申请加上 gap锁。 </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 了解上面的基础知识，我们开始对死锁日志进行分析: </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> T1: sess1 通过唯一键更新数据，由于c2=4 不存在，返回affect row为0，MySQL会申请(3,6)之间的gap锁。 </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> T2: sess2 的情况和sess1 类似，也会申请(3,6)之间的gap锁，从上面的兼容性矩阵来看两个GAP 锁并不会冲突。 </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> T3: sess1 根据update语句返回affect row为0，执行insert操作，此时需要申请插入意向锁，sess2会话持有的gap锁和sess1 申请的插入意向锁冲突，出现等待。 </p> 
 <blockquote style="border-left:4px solid #DDDDDD;color:#777777;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 
  <p style="clear:both;min-height:1em;"> index uc2 of table test.ty trx id 1863 lock_mode X locks gap before rec insert intention waiting </p> 
 </blockquote> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> T4:sess2与sess1类似，根据update语句返回affect row为0，执行insert操作。 申请的插入意向锁与sess1 的update语句持有的GAP锁冲突。<strong>sess1(持有gap锁)，sess2(持有gap锁)，sess1(插入意向锁等待sess2的gap锁释放) sess2(插入意向锁等待sess1的gap锁释放)</strong> 构成循环等待，进而导致死锁。 </p> 
 <h5 style="font-size:16px;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;"> 2.6 解决方法 </h5> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 从业务场景的处理逻辑上看，业务需要发送两次请求 一次update，一次insert 才能完成业务逻辑，不够友好和优化。 </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 其实我们可以和开发同学沟通好，确认业务的幂等性，使用 insert on duplicate key的方式，没有就插入，存在就更新，一次调用即可完成之前2次操作的功能，提高性能。 </p> 
 <h4 style="font-size:18px;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;"> 三 小结 </h4> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 最后想说关于解决死锁问题的思路:  </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 1 具备扎实的锁相关的基础知识。 </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;font-family:Helvetica, arial, sans-serif;font-size:14px;"> 2 单单根据死锁日志其实比较难以判断具体的sql执行情况，需要和开发同学沟通好，理清业务执行sql的逻辑，然后去模拟测试。 </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;"><br></p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;"> <strong>推荐阅读</strong> </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;"><br></p> 
 <hr style="color:#3E3E3E;"> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;"> <a href="http://mp.weixin.qq.com/s?__biz=MzI4NjExMDA4NQ==&amp;mid=2648450273&amp;idx=1&amp;sn=2836db9eb1086a9fca91748dd233a234&amp;chksm=f3c97c0bc4bef51d6c92e9a79b959c7f7e41367d5429ec80b5881d165978f311a4d8f0452634&amp;scene=21#wechat_redirect" rel="nofollow" style="color:#607FA6;">如何阅读死锁日志</a> </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;"> <a href="http://mp.weixin.qq.com/s?__biz=MzI4NjExMDA4NQ==&amp;mid=2648450327&amp;idx=1&amp;sn=e5d9917bbf8f0f4db8c8b2ead02cb992&amp;chksm=f3c97dfdc4bef4eba36b43eb08c0677fb7c3cb76c7d9489cdc72b720ef5d0a64f48471c0e07f&amp;scene=21#wechat_redirect" rel="nofollow" style="color:#607FA6;">漫谈死锁</a> </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;"> <a href="http://mp.weixin.qq.com/s?__biz=MzI4NjExMDA4NQ==&amp;mid=2648450310&amp;idx=1&amp;sn=4ea2c6c77f0971efa18bae38cb74a082&amp;chksm=f3c97decc4bef4fa593987d6b25d54d918b7eb54a45a526026b5432bf9842666a25fa6163638&amp;scene=21#wechat_redirect" rel="nofollow" style="color:#607FA6;">死锁案例之一</a> </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;"> <a href="http://mp.weixin.qq.com/s?__biz=MzI4NjExMDA4NQ==&amp;mid=2648450317&amp;idx=1&amp;sn=afb5d60d17ecd59bf368b4f80b837d59&amp;chksm=f3c97de7c4bef4f18b175fcf24b696f61e25ff415bced48ffed4c07fa552b379fd6969c63708&amp;scene=21#wechat_redirect" rel="nofollow" style="color:#607FA6;">死锁案例之二</a> </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;"> <a href="http://mp.weixin.qq.com/s?__biz=MzI4NjExMDA4NQ==&amp;mid=2648450318&amp;idx=1&amp;sn=197d3185ec0a04fcb58fed313fc021e7&amp;chksm=f3c97de4c4bef4f24385bdecd24a36a38551e911755d90c1f58b66b57f12def930be8498cd93&amp;scene=21#wechat_redirect" rel="nofollow" style="color:#607FA6;">死锁案例之三</a> </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;"> <a href="http://mp.weixin.qq.com/s?__biz=MzI4NjExMDA4NQ==&amp;mid=2648450326&amp;idx=1&amp;sn=6e31fd77fc2ba25e7299422c0820957e&amp;chksm=f3c97dfcc4bef4eab6a90ec9cf30ed9de136515bbd0a6d8a2b8162396e3af95f211dfe1da1c6&amp;scene=21#wechat_redirect" rel="nofollow" style="color:#607FA6;">死锁案例之四</a> </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;"> <a href="http://mp.weixin.qq.com/s?__biz=MzI4NjExMDA4NQ==&amp;mid=2648450521&amp;idx=1&amp;sn=47e1ce5dacd9fc0df3447789a13f3e55&amp;chksm=f3c97d33c4bef425242f05677299d6f5b8b8bd25942c5293f2a4c0980b8254331b6ad85dece2&amp;scene=21#wechat_redirect" rel="nofollow" style="color:#607FA6;">死锁案例之五</a> </p> 
 <p style="clear:both;min-height:1em;color:#3E3E3E;"> <a href="http://mp.weixin.qq.com/s?__biz=MzI4NjExMDA4NQ==&amp;mid=2648450647&amp;idx=1&amp;sn=d9acf4ec0b07eaab635d88280c9094cb&amp;chksm=f3c97ebdc4bef7ab541c71f2d9cfa035ea8ca2b70aed20d5490d381198de3183eefaa63d7527&amp;scene=21#wechat_redirect" rel="nofollow" style="color:#607FA6;">死锁案例之六</a> </p> 
 <p style="clear:both;"></p> 
 <p class="translate"> 来自 “ ITPUB博客 ” ，链接：http://blog.itpub.net/22664653/viewspace-2152275/，如需转载，请注明出处，否则将追究法律责任。 </p> 
</div> 
<p>转载于:http://blog.itpub.net/22664653/viewspace-2152275/</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c4023f70aa653f8cc169ec13ecd39b03/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">航迹规划——Dubins曲线</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1937b010f1b8a7f0cef3abcc2b06288f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">scrapy入门小案例--爬取电影天堂最新电影下载地址</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>