<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【MySQL】MySQL 8.0 新特性之 - 公用表表达式（CTE） - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【MySQL】MySQL 8.0 新特性之 - 公用表表达式（CTE）" />
<meta property="og:description" content="MySQL 8.0 新特性之 - 公用表表达式（CTE） 1. 公用表表达式（CTE） - WITH 介绍1.1 公用表表表达式1.1.1 什么是公用表表达式1.1.2 CTE 语法1.1.3 CTE示例 1.3 递归 CTE1.3.1 递归 CTE 简介1.3.2 递归成员限制1.3.3 递归 CTE 示例1.3.4 使用递归 CTE 遍历分层数据 2. CTE 与 Derived Table在 5.6 版本中在 5.7 版本中在 8.0 版本中 1. 公用表表达式（CTE） - WITH 介绍 1.1 公用表表表达式 1.1.1 什么是公用表表达式 官网：https://dev.mysql.com/doc/refman/8.0/en/with.html#common-table-expressions
MySQL 从 8.0 开始支持 WITH 语法，即：Common Table Expressions - CTE，公用表表达式。
CTE 是一个命名的临时结果集合，仅在单个 SQL 语句（select、insert、update 或 delete）的执行范围内存在。
与派生表类似的是：CTE 不作为对象存储，仅在查询执行期间持续。与派生表不同的是：CTE 可以是自引用（递归CTE），也可以在同一查询中多次引用。此外，与派生表相比，CTE 提供了更好的可读性和性能。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a297a814315069487b904e9c76e4965e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-11T09:08:08+08:00" />
<meta property="article:modified_time" content="2023-02-11T09:08:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【MySQL】MySQL 8.0 新特性之 - 公用表表达式（CTE）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>MySQL 8.0 新特性之 - 公用表表达式（CTE）</h4> 
 <ul><li><a href="#1_CTE___WITH__2" rel="nofollow">1. 公用表表达式（CTE） - WITH 介绍</a></li><li><ul><li><a href="#11__3" rel="nofollow">1.1 公用表表表达式</a></li><li><ul><li><a href="#111__4" rel="nofollow">1.1.1 什么是公用表表达式</a></li><li><a href="#112_CTE__13" rel="nofollow">1.1.2 CTE 语法</a></li><li><a href="#113_CTE_24" rel="nofollow">1.1.3 CTE示例</a></li></ul> 
   </li><li><a href="#13__CTE_84" rel="nofollow">1.3 递归 CTE</a></li><li><ul><li><a href="#131__CTE__85" rel="nofollow">1.3.1 递归 CTE 简介</a></li><li><a href="#132__112" rel="nofollow">1.3.2 递归成员限制</a></li><li><a href="#133__CTE__125" rel="nofollow">1.3.3 递归 CTE 示例</a></li><li><a href="#134__CTE__176" rel="nofollow">1.3.4 使用递归 CTE 遍历分层数据</a></li></ul> 
  </li></ul> 
  </li><li><a href="#2_CTE__Derived_Table_204" rel="nofollow">2. CTE 与 Derived Table</a></li><li><ul><li><a href="#_56__207" rel="nofollow">在 5.6 版本中</a></li><li><a href="#_57__222" rel="nofollow">在 5.7 版本中</a></li><li><a href="#_80__238" rel="nofollow">在 8.0 版本中</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1_CTE___WITH__2"></a>1. 公用表表达式（CTE） - WITH 介绍</h2> 
<h3><a id="11__3"></a>1.1 公用表表表达式</h3> 
<h4><a id="111__4"></a>1.1.1 什么是公用表表达式</h4> 
<p>官网：<a href="https://dev.mysql.com/doc/refman/8.0/en/with.html#common-table-expressions" rel="nofollow">https://dev.mysql.com/doc/refman/8.0/en/with.html#common-table-expressions</a></p> 
<p>MySQL 从 8.0 开始支持 WITH 语法，即：Common Table Expressions - CTE，公用表表达式。</p> 
<p>CTE 是一个命名的临时结果集合，仅在单个 SQL 语句（select、insert、update 或 delete）的执行范围内存在。</p> 
<p>与<code>派生表</code>类似的是：CTE 不作为对象存储，仅在查询执行期间持续。与<code>派生表</code>不同的是：CTE 可以是自引用（递归CTE），也可以在同一查询中多次引用。此外，与派生表相比，CTE 提供了更好的可读性和性能。</p> 
<h4><a id="112_CTE__13"></a>1.1.2 CTE 语法</h4> 
<p>CTE 的结构包括：名称、可选列列表和定义 CTE 的查询。定义 CTE 后，可以像 <code>select、insert、update、delete 或 create view</code> 语句中的视图一样使用它。</p> 
<pre><code class="prism language-sql"><span class="token keyword">with</span> cte_name <span class="token punctuation">(</span>column_list<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>
    query
    <span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cte_name<span class="token punctuation">;</span>
</code></pre> 
<p><strong><code>查询中的列数必须与 column_list 中的列数相同。 如果省略 column_list，CTE 将使用定义 CTE 的查询的列列表。</code></strong></p> 
<h4><a id="113_CTE_24"></a>1.1.3 CTE示例</h4> 
<p><strong>初始化数据：</strong></p> 
<pre><code class="prism language-sql"><span class="token comment">-- create table</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> department
<span class="token punctuation">(</span>
    id        <span class="token keyword">bigint</span> <span class="token keyword">auto_increment</span> <span class="token keyword">comment</span> <span class="token string">'主键ID'</span>
        <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
    dept_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>      <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'部门名称'</span><span class="token punctuation">,</span>
    parent_id <span class="token keyword">bigint</span> <span class="token keyword">default</span> <span class="token number">0</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'父级id'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- insert values</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'总部'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'研发部'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'测试部'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'产品部'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'Java组'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'Python组'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'前端组'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'供应链测试组'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'商城测试组'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'供应链产品组'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'商城产品组'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'Java1组'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'Java2组'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>（1）最基本的CTE语法：</strong></p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">with</span> cte1 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span>      cte2 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> cte1
    <span class="token operator">-</span><span class="token operator">&gt;</span>          <span class="token keyword">join</span> cte2
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">where</span> cte1<span class="token punctuation">.</span>id <span class="token operator">=</span> cte2<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-----------+-----------+----+-----------+-----------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> dept_name <span class="token operator">|</span> parent_id <span class="token operator">|</span> id <span class="token operator">|</span> dept_name <span class="token operator">|</span> parent_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-----------+-----------+----+-----------+-----------+</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 研发部     <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> 研发部     <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-----------+-----------+----+-----------+-----------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

</code></pre> 
<p>（2）一个 CTE 引用另一个 CTE</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">with</span> cte1 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token identifier"><span class="token punctuation">`</span>department<span class="token punctuation">`</span></span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span>      cte2 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cte1<span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> cte2<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-----------+-----------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> dept_name <span class="token operator">|</span> parent_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-----------+-----------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> 总部       <span class="token operator">|</span>         <span class="token number">0</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-----------+-----------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="13__CTE_84"></a>1.3 递归 CTE</h3> 
<h4><a id="131__CTE__85"></a>1.3.1 递归 CTE 简介</h4> 
<p>递归 CTE 是一个具有引用 CTE 名称本身的子查询的 CTE。递归 CTE 的语法为：</p> 
<pre><code class="prism language-sql"><span class="token keyword">with</span> recursive cte_name <span class="token keyword">as</span> <span class="token punctuation">(</span>
    initial_query  <span class="token comment">-- anchor member</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
recursive_query <span class="token comment">-- recursive member that references to the cte name</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cte_name<span class="token punctuation">;</span>
</code></pre> 
<p><strong>递归 CTE 由三个主要部分组成：</strong></p> 
<ul><li> <p>形成 CTE 结构的基本结果集的初始查询（initial_query），初始查询部分被称为锚成员。</p> </li><li> <p>递归查询部分是引用 CTE 名称的查询，因此称为递归成员。递归成员由一个 union all 或 union distinct 运算符与锚成员相连。</p> </li><li> <p>终止条件是当递归成员没有返回任何行时，确保递归停止。</p> </li></ul> 
<p><strong>递归 CTE 的执行顺序如下：</strong></p> 
<ol><li>首先，将成员分为两个：锚点和递归成员。</li><li>接下来，执行锚成员形成基本结果集（<code>R0</code>），并使用该基本结果集进行下一次迭代。</li><li>然后，将 <code>Ri</code> 结果集作为输入执行递归成员，并将 <code>Ri + 1</code> 作为输出。</li><li>之后，重复第三步，直到递归成员返回一个空结果集，换句话说，满足终止条件。</li><li>最后，使用 <code>union all</code> 运算符将结果集从 <code>R0</code> 到 <code>Rn</code> 组合。</li></ol> 
<h4><a id="132__112"></a>1.3.2 递归成员限制</h4> 
<p><strong>递归成功不能包含以下结构：</strong></p> 
<ul><li>聚合函数，如 max、min、sum、avg、count 等。</li><li>group by 子句</li><li>order by 子句</li><li>limit 子句</li><li>distinct</li></ul> 
<p><strong><code>上述约束不适用于锚点成员。 另外，只有在使用 union 运算符时，要禁止 distinct 才适用。 如果使用 union distinct 运算符，则允许使用 distinct。</code></strong></p> 
<p>另外，递归成员只能在其子句中引用 CTE 名称，而不是引用任何子查询。</p> 
<h4><a id="133__CTE__125"></a>1.3.3 递归 CTE 示例</h4> 
<pre><code class="prism language-sql"><span class="token keyword">with</span> recursive cte_count <span class="token punctuation">(</span>n<span class="token punctuation">)</span>
                   <span class="token keyword">as</span> <span class="token punctuation">(</span>
        <span class="token keyword">select</span> <span class="token number">1</span>
        <span class="token keyword">union</span> <span class="token keyword">all</span>
        <span class="token keyword">select</span> n <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">from</span> cte_count
        <span class="token keyword">where</span> n <span class="token operator">&lt;</span> <span class="token number">3</span>
    <span class="token punctuation">)</span>
<span class="token keyword">select</span> n <span class="token keyword">from</span> cte_count<span class="token punctuation">;</span>
</code></pre> 
<p><strong>在此示例中，以下查询：</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token number">1</span>
</code></pre> 
<p>是作为基本结果集返回 <code>1</code> 的锚成员。</p> 
<p><strong>以下查询：</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> n <span class="token operator">+</span> <span class="token number">1</span>
<span class="token keyword">from</span> cte_count
<span class="token keyword">where</span> n <span class="token operator">&lt;</span> <span class="token number">3</span>
</code></pre> 
<p>是递归成员，因为它引用了 cte_count 的 CTE 名称。递归成员中的表达式 &lt; 3 是终止条件。当 n 等于 3，递归成员将返回一个空集合，将停止递归。</p> 
<p><strong>下图显示了上述 CTE 的元素：</strong></p> 
<p><img src="https://images2.imgbox.com/ff/b3/C1bjHI7U_o.png" alt="在这里插入图片描述"><br> 递归 CTE 返回以下输出：</p> 
<pre><code class="prism language-sql"><span class="token operator">+</span><span class="token comment">------+</span>
<span class="token operator">|</span>    n <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+</span>
</code></pre> 
<p><strong>递归 CTE 的执行步骤如下：</strong></p> 
<ol><li>首先，分离锚和递归成员。</li><li>接下来，锚定成员形成初始行 <code>select 1</code>，因此第一次迭代在 <code>n = 1</code> 时产生 <code>1 + 1 = 2</code>。</li><li>然后，第二次迭代对第一次迭代的输出 <code>2</code> 进行操作，并且在 <code>n = 2</code> 时产生 <code>2 + 1 = 3</code>。</li><li>之后，在第三次操作 <code>n = 3</code> 之前，满足终止条件 <code>n &lt;3</code> ，因此查询停止。</li><li>最后，使用 <code>union all</code> 运算符组合所有结果集 <code>1，2 和 3</code>。</li></ol> 
<h4><a id="134__CTE__176"></a>1.3.4 使用递归 CTE 遍历分层数据</h4> 
<p>查部门 id = 2 的所有下级部门和本级：</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">with</span> recursive cte_tab <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> id<span class="token punctuation">,</span> dept_name<span class="token punctuation">,</span> parent_id<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">as</span> <span class="token keyword">level</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span>                            <span class="token keyword">from</span> department
    <span class="token operator">-</span><span class="token operator">&gt;</span>                            <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span>                            <span class="token keyword">union</span> <span class="token keyword">all</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span>                            <span class="token keyword">select</span> d<span class="token punctuation">.</span>id<span class="token punctuation">,</span> d<span class="token punctuation">.</span>dept_name<span class="token punctuation">,</span> d<span class="token punctuation">.</span>parent_id<span class="token punctuation">,</span> <span class="token keyword">level</span> <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span>                            <span class="token keyword">from</span> cte_tab c
    <span class="token operator">-</span><span class="token operator">&gt;</span>                                     <span class="token keyword">inner</span> <span class="token keyword">join</span> department d <span class="token keyword">on</span> c<span class="token punctuation">.</span>id <span class="token operator">=</span> d<span class="token punctuation">.</span>parent_id
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> cte_tab<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+-----------+-----------+-------+</span>
<span class="token operator">|</span> id   <span class="token operator">|</span> dept_name <span class="token operator">|</span> parent_id <span class="token operator">|</span> <span class="token keyword">level</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-----------+-----------+-------+</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span> 研发部     <span class="token operator">|</span>         <span class="token number">1</span> <span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span> Java组    <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">6</span> <span class="token operator">|</span> Python组  <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">7</span> <span class="token operator">|</span> 前端组     <span class="token operator">|</span>         <span class="token number">2</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">12</span> <span class="token operator">|</span> Java1组   <span class="token operator">|</span>         <span class="token number">5</span> <span class="token operator">|</span>     <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">13</span> <span class="token operator">|</span> Java2组   <span class="token operator">|</span>         <span class="token number">5</span> <span class="token operator">|</span>     <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+-----------+-----------+-------+</span>
<span class="token number">6</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

</code></pre> 
<h2><a id="2_CTE__Derived_Table_204"></a>2. CTE 与 Derived Table</h2> 
<p>针对 from 子句里面的 subquery，MySQL 在不同版本中，是做过一系列的优化，接下来我们就来看看。</p> 
<h3><a id="_56__207"></a>在 5.6 版本中</h3> 
<p>MySQL 会对每一个 Derived Table 进行物化，生成一个临时表保存 Derived Table 的结果，然后利用临时表来完成父查询的操作，具体如下：</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> department <span class="token keyword">where</span> id <span class="token operator">&lt;=</span> <span class="token number">1000</span><span class="token punctuation">)</span> t1 <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> department <span class="token keyword">where</span> id <span class="token operator">&gt;=</span> <span class="token number">990</span><span class="token punctuation">)</span> t2 <span class="token keyword">on</span> t1<span class="token punctuation">.</span>id <span class="token operator">=</span> t2<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+--------+---------------+---------+---------+----------------------------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref                        <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+--------+---------------+---------+---------+----------------------------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> department <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range  <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>                       <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> department <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> pointer_mall<span class="token punctuation">.</span>department<span class="token punctuation">.</span>id <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+--------+---------------+---------+---------+----------------------------+------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_57__222"></a>在 5.7 版本中</h3> 
<p>MySQL 引入了 Derived Merge 新特性，允许符合条件的 Derived Table 中的子表与父查询的表进行合并，具体如下：</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> department <span class="token keyword">where</span> id <span class="token operator">&lt;=</span> <span class="token number">1000</span><span class="token punctuation">)</span> t1 <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> department <span class="token keyword">where</span> id <span class="token operator">&gt;=</span> <span class="token number">990</span><span class="token punctuation">)</span> t2 <span class="token keyword">on</span> t1<span class="token punctuation">.</span>id <span class="token operator">=</span> t2<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+-------+---------------+-------------+---------+-------+---------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span>    <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+-------+---------------+-------------+---------+-------+---------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span>derived2<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>   <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>    <span class="token number">1900</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span>derived3<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token operator">&lt;</span>auto_key0<span class="token operator">&gt;</span>   <span class="token operator">|</span> <span class="token operator">&lt;</span>auto_key0<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> t1<span class="token punctuation">.</span>id <span class="token operator">|</span>    <span class="token number">2563</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> DERIVED     <span class="token operator">|</span> department <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">4870486</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> DERIVED     <span class="token operator">|</span> department <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>    <span class="token number">1900</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+-------+---------------+-------------+---------+-------+---------+----------+-------------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_80__238"></a>在 8.0 版本中</h3> 
<p>我们可以使用 CTE 实现，其执行计划也是和 Derived Table 一样</p> 
<pre><code class="prism language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">with</span> t1 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> department <span class="token keyword">where</span> id <span class="token operator">&lt;=</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span>      t2 <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> department <span class="token keyword">where</span> id <span class="token operator">&gt;=</span> <span class="token number">990</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">join</span> t2 <span class="token keyword">on</span> t1<span class="token punctuation">.</span>id <span class="token operator">=</span> t2<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+--------+---------------+---------+---------+----------------------------+------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>   <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref                        <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+--------+---------------+---------+---------+----------------------------+------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> department <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range  <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>                       <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> department <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> eq_ref <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> pointer_mall<span class="token punctuation">.</span>department<span class="token punctuation">.</span>id <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+--------+---------------+---------+---------+----------------------------+------+----------+-------------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre> 
<p>从测试结果来看，CTE 似乎是 Derived Table 的一个替代品？其实不是的，虽然 CTE 内部优化流程与 Derived Table 类似，但是两者还是区别的，具体如下：</p> 
<ol><li> <p>一个 CTE 可以引用另一个 CTE</p> </li><li> <p>CTE 可以自引用</p> </li><li> <p>CTE 在语句级别生成临时表，多次调用只需要执行一次，提高性能</p> </li></ol> 
<p>从上面介绍可以知道，CTE 一方面可以非常方便进行 SQL 开发，另一方面也可以提升 SQL 执行效率。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/350aa31382dd97ada132a51c1cc343c5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">excel函数技巧：什么是模糊查找，如何操作？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/57354076965ff87bd79613cc367ff469/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Qt实战：Qt5.11.1安装与MSVC配置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>