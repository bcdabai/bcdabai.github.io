<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>（珍藏）高级：SQL Server 常用高级语法笔记 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="（珍藏）高级：SQL Server 常用高级语法笔记" />
<meta property="og:description" content="1、case…end （具体的值）
case后面有值，相当于c#中的switch case
注意：case后必须有条件，并且when后面必须是值不能为条件。
-----------------case–end—语法结构---------------------
select name , --注意逗号
case level --case后跟条件
when 1 then ‘骨灰’
when 2 then ‘大虾’
when 3 then’菜鸟’
end as’头衔’from [user]
2、case…end （范围）
case 后面无值，相当于c#中的if…else if…else…
注意：case后不根条件
------------------case—end--------------------------------
select studentId, case
when english between 80 and 90 then ‘优’
when english between 60 and 79 then ‘良’
else ‘差’
end
from Score
------------------case—end--------------------------------
select studentId, case
when english &gt;=80 then ‘优’
when english &gt;=60 then ‘良’" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a691f5188b46b53c00fafeadaa14bda9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-17T17:15:11+08:00" />
<meta property="article:modified_time" content="2022-03-17T17:15:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">（珍藏）高级：SQL Server 常用高级语法笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>1、case…end （具体的值）</p> 
<p>case后面有值，相当于c#中的switch case</p> 
<p>注意：case后必须有条件，并且when后面必须是值不能为条件。</p> 
<p>-----------------case–end—语法结构---------------------</p> 
<p>select name , --注意逗号</p> 
<p>case level --case后跟条件</p> 
<p>when 1 then ‘骨灰’</p> 
<p>when 2 then ‘大虾’</p> 
<p>when 3 then’菜鸟’</p> 
<p>end as’头衔’from [user]</p> 
<p>2、case…end （范围）</p> 
<p>case 后面无值，相当于c#中的if…else if…else…</p> 
<p>注意：case后不根条件</p> 
<p>------------------case—end--------------------------------</p> 
<p>select studentId, case</p> 
<p>when english between 80 and 90 then ‘优’</p> 
<p>when english between 60 and 79 then ‘良’</p> 
<p>else ‘差’</p> 
<p>end</p> 
<p>from Score</p> 
<p>------------------case—end--------------------------------</p> 
<p>select studentId, case</p> 
<p>when english &gt;=80 then ‘优’</p> 
<p>when english &gt;=60 then ‘良’</p> 
<p>else ‘差’</p> 
<p>end</p> 
<p>from Score</p> 
<p>-----------------------------------------------------s</p> 
<p>elect *, case</p> 
<p>when english&gt;=60 and math &gt;=60 then ‘及格’</p> 
<p>else ‘不及格’</p> 
<p>endfrom Score</p> 
<p>3、if…eles</p> 
<p>IF(条件表达式) BEGIN --相当于C#里的{ 语句1</p> 
<p>…… END --相当于C#里的}ELSE</p> 
<p>BEGIN</p> 
<p>语句1</p> 
<p>…… END–计算平均分数并输出，如果平均分数超过分输出成绩最高的三个学生的成绩，否则输出后三名的学生declare @avg int --定义变量select @avg= AVG(english) from Score --为变量赋值select ‘平均成绩’+CONVERT(varchar,@avg) --打印变量的值</p> 
<p>if @avg&lt;60</p> 
<p>begin</p> 
<p>select ‘前三名’</p> 
<p>select top 3 * from Score order by english desc</p> 
<p>end</p> 
<p>else</p> 
<p>begin</p> 
<p>select ‘后三名’</p> 
<p>select top 3 * from Score order by english</p> 
<p>end</p> 
<p>4、while循环</p> 
<p>WHILE(条件表达式) BEGIN --相当于C#里的{ 语句</p> 
<p>…… BREAK</p> 
<p>END --相当于C#里的}–如果不及格的人超过半数(考试题出难了)，则给每个人增加分select * from Scoredeclare @conut int,@failcount int,@i int=0 --定义变量select @conut =COUNT(<em>) from Score --统计总人数select @failcount =COUNT(</em>) from Score where english&lt;100 --统计未及格的人数while (@failcount&gt;@conut/2) begin</p> 
<p>update Score set english=english+1</p> 
<p>select @failcount=COUNT(*) from Score where english&lt;100</p> 
<p>set @i=@i+1</p> 
<p>endselect @iupdate Score set english=100 where english &gt;100</p> 
<p>5、索引</p> 
<p>使用索引能提高查询效率，但是索引也是占据空间的，而且添加、更新、删除数据的时候也需要同步更新索引，因此会降低Insert、Update、Delete的速度。只在经常检索的字段上(Where)创建索引。</p> 
<p>1）聚集索引：索引目录中的和目录中对应的数据都是有顺序的。</p> 
<p>2）非聚集索引：索引目录有顺序但存储的数据是没有顺序的。</p> 
<p>–创建非聚集索引CREATE NONCLUSTERED INDEX [IX_Student_sNo] ON student</p> 
<p>( [sNo] ASC)</p> 
<p>6、子查询</p> 
<p>将一个查询语句做为一个结果集供其他SQL语句使用，就像使用普通的表一样，被当作结果集的查询语句被称为子查询。所有可以使用表的地方几乎都可以使用子查询来代替。</p> 
<p>select * from (select * from student where sAge&lt;30) as t --被查询的子表必须有别名where t.sSex =‘男’ --对子表中的列筛选</p> 
<p>转换为两位小数：CONVERT(numeric(10,2), AVG(english))</p> 
<p>只有返回且仅返回一行、一列数据的子查询才能当成单值子查询。</p> 
<p>select ‘平均成绩’, (select AVG(english) from Score) --可以成功执行select ‘姓名’, (select sName from student) --错误，因为‘姓名’只有一行，而子表中姓名有多行select * from student where sClassId in(select cid from Class where cName IN(‘高一一班’,‘高二一班’)) --子查询有多值时使用in</p> 
<p>7、分页</p> 
<p>–分页1</p> 
<p>selecttop3<em>fromstudent where[sId]notin(selecttop(3</em>(4-1)) [sid]fromstudent)</p> 
<p>–4表示页数select*, row_number() over(orderby[sage]desc) fromstudent-- row_number() over (order by…)获取行号</p> 
<p>–分页2</p> 
<p>select<em>from(select</em>, row_number() over(orderby[sid]desc) asnum fromstudent)astwherenum between(Y-1)<em>T+1andY</em>Torderby[sid]desc</p> 
<p>–分页3</p> 
<p>select*from(selectROW_NUMBER() over( orderby[UnitPrice]asc) asnum,*from[Books]where[publisherid]=1)ast wheret.num between1and20–要查询的开始条数和结束条数</p> 
<p>8、连接</p> 
<p>select sName,sAge, case</p> 
<p>when english &lt;60 then ‘不及格’</p> 
<p>when english IS null then ‘缺考’</p> 
<p>else CONVERT(nvarchar, english) end as’英语成绩’from student as sleft join Score as c on s.sid =c.sid</p> 
<p>内连接 inner join…on…</p> 
<p>查询满足on后面条件的数据</p> 
<p>外连接</p> 
<p>左连接 left join…on…</p> 
<p>先查出左表中的所有数据</p> 
<p>再使用on后面的条件对数据过滤</p> 
<p>右连接 right join…on…</p> 
<p>先查出右表中的所有数据</p> 
<p>再使用on后面的条件对数据过滤</p> 
<p>全连接 full join …on…</p> 
<p>（*）交叉连接</p> 
<p>cross join 没有on</p> 
<p>第一个表的每一行和后面表的每一行进行连接</p> 
<p>没有条件。是其它连接的基础</p> 
<p>9.视图</p> 
<p>优点：</p> 
<pre><code>筛选表中的行

防止未经许可的用户访问敏感数据

降低数据库的复杂程度
</code></pre> 
<p>创建视图</p> 
<p>create view v_Demoasselect …</p> 
<p>10、局部变量</p> 
<p>---------------------------------局部变量----------------------------</p> 
<p>声明变量:使用declare关键字，并且变量名已@开头，@直接连接变量名,中间没有空格。必须指明变量的类型，同时还可以声明多个不同类型的变量。declare @name nvarchar(30) ,@age int–变量赋值：</p> 
<p>–1、使用set 给变量赋值,只能给一个变量赋值set @age=18set @name ='Tianjia’select @age,@name --输出变量的值</p> 
<p>–2、使用select 可以同时为多个变量赋值select @age=19,@name=‘Laoniu’</p> 
<p>–3、在查询语句中为变量赋值declare @sum int =18 --为变量赋初值select @sum= SUM(english) from Score --查询语句中赋值select @sum --输出变量值</p> 
<p>–4、变量作为条件使用declare @sname nvarchar(10)=‘张三’ declare @sage intselect @sage=sage from student where sName=@snameselect @sage</p> 
<p>–5、使用print输出变量值，一次只能输出一个变量的值,输出为文本形式print @sage</p> 
<p>11、全局变量</p> 
<p>--------------------------全局变量（系统变量）----------------------------</p> 
<p>select * from student0</p> 
<p>select @@error --最后一个T-SQL错误的错误号select @@max_connections</p> 
<p>–获取创建的同时连接的最大数目select @@identity</p> 
<p>–返回最近一次插入的编号</p> 
<p>12、事务</p> 
<p>事务：同生共死</p> 
<p>指访问并可能更新数据库中各种数据项的一个程序执行单元(unit)–也就是由多个sql语句组成，必须作为一个整体执行</p> 
<p>这些sql语句作为一个整体一起向系统提交，要么都执行、要么都不执行</p> 
<p>语法步骤：</p> 
<pre><code>开始事务：BEGIN TRANSACTION

事务提交：COMMIT TRANSACTION

事务回滚：ROLLBACK TRANSACTION
</code></pre> 
<p>判断某条语句执行是否出错：</p> 
<p>全局变量@@ERROR；</p> 
<p>@@ERROR只能判断当前一条T-SQL语句执行是否有错，为了判断事务中所有T-SQL语句是否有错，我们需要对错误进行累计；</p> 
<p>---------------------------模拟转账----------------------------</p> 
<p>declare @sumError int=0</p> 
<p>–声明变量begin tranupdate bank set balance=balance-1000 where cId='0001’set @sumError=@sumError+@@error update bank set balance=balance+1000 where cId='0002’set @sumError=@sumError+@@errorif (@sumError=0)commit tran</p> 
<p>–提交成功,提交事务else rollback tran --提交失败,回滚事务</p> 
<p>13、存储过程</p> 
<p>存储过程—就像数据库中运行方法(函数)</p> 
<p>和C#里的方法一样，由存储过程名/存储过程参数组成/可以有返回结果。</p> 
<p>前面学的if else/while/变量/insert/select 等，都可以在存储过程中使用</p> 
<p>优点：</p> 
<pre><code>执行速度更快 - 在数据库中保存的存储过程语句都是编译过的

允许模块化程序设计 - 类似方法的复用

提高系统安全性 - 防止SQL注入

减少网络流通量 - 只要传输 存储过程的名称
</code></pre> 
<p>系统存储过程</p> 
<p>由系统定义，存放在master数据库中</p> 
<p>名称以“sp_”开头或”xp_”开头</p> 
<p>创建存储过程：</p> 
<p>定义存储过程的语法 CREATE PROC[EDURE] 存储过程名</p> 
<p>@参数1 数据类型 = 默认值 OUTPUT, @参数n 数据类型 = 默认值 OUTPUT AS</p> 
<p>SQL语句</p> 
<p>参数说明：</p> 
<p>参数可选</p> 
<p>参数分为输入参数、输出参数</p> 
<p>输入参数允许有默认值EXEC 过程名 [参数]</p> 
<p>----------------------例------------</p> 
<p>if exists (select * from sys.objects where name=‘usp_GroupMainlist1’)drop proc usp_GroupMainlist1gocreate proc usp_GroupMainlist1 @pageIndex int, --页数</p> 
<p>@pageSize int, --条数</p> 
<p>@pageCount int output–输出共多少页as</p> 
<p>declare @count int --共多少条数据</p> 
<p>select @count =count(*) from [mainlist] --获取此表的总条数</p> 
<p>set @pageCount=ceiling(@count*1.0/@pageSize)</p> 
<p>select * from</p> 
<p>(select <em>,row_number() over(order by [date of booking] desc) as ‘num’ from [mainlist]) as t where num between(@pageSize</em>(@pageIndex-1)+1) and @pageSize*@pageIndex</p> 
<p>order by [date of booking] desc</p> 
<p>---------------------------------------------------------------------------------------------调用</p> 
<p>declare @page intexec usp_GroupMainlist1 1,100,@page outputselect @page</p> 
<p>14、常用函数</p> 
<p>1）ISNULL(expression,value) 如果expression不为null返回expression表达式的值，否则返回value的值</p> 
<p>2）聚合函数</p> 
<p>avg() – 平均值 统计时注意null不会被统计，需要加上isnull(列名，0)sum() – 求和count() – 求行数 min() – 求最小值max() – 求最大值</p> 
<p>3）字符串操作函数</p> 
<p>LEN() --计算字符串长度</p> 
<p>LOWER() --转小写</p> 
<p>UPPER () --大写</p> 
<p>LTRIM() --字符串左侧的空格去掉</p> 
<p>RTRIM () --字符串右侧的空格去掉</p> 
<p>LTRIM(RTRIM(’ bb ')) LEFT()、RIGHT()</p> 
<p>– 截取取字符串</p> 
<p>SUBSTRING(string,start_position,length)</p> 
<p>– 参数string为主字符串，start_position为子字符串在主字符串中的起始位置（从1开始），length为子字符串的最大长度。SELECT SUBSTRING(‘abcdef111’,2,3)</p> 
<p>REPLACE(string,oldstr,newstr)Convert(decimal(18,2),num)</p> 
<p>–保留两位小数</p> 
<p>4）日期相关函数</p> 
<p>GETDATE() --取得当前日期时间</p> 
<p>DATEADD (datepart , number, date )</p> 
<p>–计算增加以后的日期。参数date为待计算的日期；参数number为增量；参数datepart为计量单位，可选值见备注。DATEADD(DAY, 3,date)为计算日期date的3天后的日期，而DATEADD(MONTH ,-8,date)为计算日期date的8个月之前的日期 DATEDIFF ( datepart , startdate , enddate )</p> 
<p>–计算两个日期之间的差额。 datepart 为计量单位，可取值参考DateAdd。</p> 
<p>– 获取日期的某一部分 ：</p> 
<p>DATEPART (datepart,date)–返回一个日期的特定部分 整数</p> 
<p>DATENAME(datepart,date)–返回日期中指定部分 字符串</p> 
<p>YEAR() MONTH() DAY()</p> 
<p>15、sql语句执行顺序</p> 
<p>5&gt;…Select 5-1&gt;选择列,5-2&gt;distinct,5-3&gt;top</p> 
<p>1&gt;…From 表 2&gt;…Where 条件 3&gt;…Group by 列 4&gt;…Having 筛选条件 6&gt;…Order by 列</p> 
<p>---------------------以下是根据园友建议后续补充的，部分为项目中的实际代码（没时间写整理直接贴源码）---------------------------</p> 
<p>16、分组查询group by…having</p> 
<p>对group by分组后的数据进行过滤在分组查询中，查询的列名必须出现在group by后或者在聚合函数中</p> 
<p>–查询平均工资大于两千块钱的部门</p> 
<p>select department_id,avg(wages) from employee where department_id is not null</p> 
<p>group by department_id having avg(wages)&gt;2000</p> 
<p>17、临时表[转]</p> 
<p>方法一：</p> 
<p>create table #临时表名(字段1 约束条件,</p> 
<p>字段2 约束条件,</p> 
<p>…)</p> 
<p>create table ##临时表名(字段1 约束条件,</p> 
<p>字段2 约束条件,</p> 
<p>…)</p> 
<p>方法二：</p> 
<p>select * into #临时表名 from 你的表;</p> 
<p>select * into ##临时表名 from 你的表;</p> 
<p>注：以上的#代表局部临时表，##代表全局临时表</p> 
<p>drop table #Tmp</p> 
<p>–删除临时表#Tmpcreate table #Tmp</p> 
<p>–创建临时表#Tmp(</p> 
<p>ID int IDENTITY (1,1) not null,</p> 
<p>–创建列ID,并且每次新增一条记录就会加1</p> 
<p>WokNo varchar(50),</p> 
<p>primary key (ID)</p> 
<p>–定义ID为临时表#Tmp的主键 );</p> 
<p>Select * from #Tmp</p> 
<p>–查询临时表的数据truncate table #Tmp</p> 
<p>–清空临时表的所有数据和约束</p> 
<p>18、表值函数</p> 
<p>Create FUNCTION [dbo].[GetUPR]( @upr varchar(2) --传入函数中的参数)RETURNS @tab TABLE(</p> 
<p>UPR varchar(2) --返回表的字段，这里只有一个字段)ASBEGIN</p> 
<p>if(@upr=‘0’) begin</p> 
<p>insert @tab</p> 
<p>select ‘U’</p> 
<p>union select ‘P’</p> 
<p>union select ‘R’</p> 
<p>end</p> 
<p>else</p> 
<p>begin</p> 
<p>insert @tab</p> 
<p>select @upr</p> 
<p>end</p> 
<p>RETURN ;</p> 
<p>END</p> 
<p>19、标量值函数</p> 
<p>– =============================================-- 根据订单号获取销售员1的邮箱-- =============================================Create FUNCTION [dbo].[GetSalManAEmailByOrderNo]( @orderNo varchar(16)</p> 
<p>)RETURNS varchar(128)ASBEGIN</p> 
<p>declare @salManAEmail varchar(128)</p> 
<p>select @salManAEmail=EMailA from UserDB.dbo.EmployeeInfo where EmployeeID in</p> 
<p>( select EmployeeInfoID from SalesManInfo where SalesManCode in</p> 
<p>(</p> 
<p>select SalesManA from OrderInfo where SalesOrder=@orderNo</p> 
<p>)</p> 
<p>)</p> 
<p>RETURN ( @salManAEmail)</p> 
<p>END</p> 
<p>转载于https://www.sohu.com/a/120121746_467799</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/50ebc83593330200e2d58829cd7f66b2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">同网段的VLAN隔离</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cde1e8b8f38c5fd099143e5c9324a39c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据结构：插入排序之折半查找（二分查找）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>