<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用RNN完成IMDB电影评论情感分析 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="使用RNN完成IMDB电影评论情感分析" />
<meta property="og:description" content="使用RNN完成IMDB电影评论情感分析 任务描述一、环境设置二、数据准备2.1 参数设置2.2 用padding的方式对齐数据2.3 用Dataset与DataLoader加载三、模型配置四、模型训练五、模型评估六、模型预测 任务描述 本示例教程演示如何在IMDB数据集上使用RNN网络完成文本分类的任务。IMDB数据集包含对电影评论进行正向和负向标注的数据，共有25000条文本数据作为训练集，25000条文本数据作为测试集。数据集的官方地址为：IMDB Dataset
一、环境设置 本示例基于飞桨开源框架2.0版本。
import paddle import numpy as np import matplotlib.pyplot as plt import paddle.nn as nn print(paddle.__version__) # 查看当前版本 # cpu/gpu环境选择，在 paddle.set_device() 输入对应运行设备。 device = paddle.set_device(&#39;gpu&#39;) 2.0.1 二、数据准备 由于IMDB是NLP领域中常见的数据集，飞桨框架将其内置，路径为paddle.text.datasets.Imdb。通过mode参数可以控制训练集与测试集。
print(&#39;loading dataset...&#39;) train_dataset = paddle.text.datasets.Imdb(mode=&#39;train&#39;) test_dataset = paddle.text.datasets.Imdb(mode=&#39;test&#39;) print(&#39;loading finished&#39;) 构建了训练集与测试集后，可以通过word_idx获取数据集的词表。
word_dict = train_dataset.word_idx # 获取数据集的词表 # add a pad token to the dict for later padding the sequence word_dict[&#39;&lt;pad&gt;&#39;] = len(word_dict) for k in list(word_dict)[:5]: print(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/17dd91ba90eb500be08c8fbdcd5c3249/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-13T18:56:27+08:00" />
<meta property="article:modified_time" content="2024-01-13T18:56:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用RNN完成IMDB电影评论情感分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>使用RNN完成IMDB电影评论情感分析</h4> 
 <ul><li><ul><li><a href="#_2" rel="nofollow">任务描述</a></li><li><a href="#_8" rel="nofollow">一、环境设置</a></li><li><a href="#_26" rel="nofollow">二、数据准备</a></li><li><a href="#21__56" rel="nofollow">2.1 参数设置</a></li><li><a href="#22_padding_80" rel="nofollow">2.2 用padding的方式对齐数据</a></li><li><a href="#23_DatasetDataLoader_110" rel="nofollow">2.3 用Dataset与DataLoader加载</a></li><li><a href="#_141" rel="nofollow">三、模型配置</a></li><li><a href="#_162" rel="nofollow">四、模型训练</a></li><li><a href="#_238" rel="nofollow">五、模型评估</a></li><li><a href="#_263" rel="nofollow">六、模型预测</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_2"></a>任务描述</h3> 
<p>本示例教程演示如何在IMDB数据集上使用RNN网络完成文本分类的任务。IMDB数据集包含对电影评论进行正向和负向标注的数据，共有25000条文本数据作为训练集，25000条文本数据作为测试集。数据集的官方地址为：<a href="http://ai.stanford.edu/~amaas/data/sentiment/" rel="nofollow">IMDB Dataset</a></p> 
<p><img src="https://images2.imgbox.com/4d/1f/Q3MkExHc_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="_8"></a>一、环境设置</h3> 
<p>本示例基于飞桨开源框架2.0版本。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> paddle
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> paddle<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn

<span class="token keyword">print</span><span class="token punctuation">(</span>paddle<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>  <span class="token comment"># 查看当前版本</span>

<span class="token comment"># cpu/gpu环境选择，在 paddle.set_device() 输入对应运行设备。</span>
device <span class="token operator">=</span> paddle<span class="token punctuation">.</span>set_device<span class="token punctuation">(</span><span class="token string">'gpu'</span><span class="token punctuation">)</span>

<span class="token number">2.0</span><span class="token number">.1</span>
</code></pre> 
<h3><a id="_26"></a>二、数据准备</h3> 
<p>由于IMDB是NLP领域中常见的数据集，飞桨框架将其内置，路径为<code>paddle.text.datasets.Imdb</code>。通过<code>mode</code>参数可以控制训练集与测试集。</p> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'loading dataset...'</span><span class="token punctuation">)</span>
train_dataset <span class="token operator">=</span> paddle<span class="token punctuation">.</span>text<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>Imdb<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">)</span>
test_dataset <span class="token operator">=</span> paddle<span class="token punctuation">.</span>text<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>Imdb<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'loading finished'</span><span class="token punctuation">)</span>
</code></pre> 
<p>构建了训练集与测试集后，可以通过<code>word_idx</code>获取数据集的词表。</p> 
<pre><code class="prism language-python">word_dict <span class="token operator">=</span> train_dataset<span class="token punctuation">.</span>word_idx  <span class="token comment"># 获取数据集的词表</span>

<span class="token comment"># add a pad token to the dict for later padding the sequence</span>
word_dict<span class="token punctuation">[</span><span class="token string">'&lt;pad&gt;'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word_dict<span class="token punctuation">)</span>

<span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>word_dict<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{}:{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'ASCII'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> word_dict<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"..."</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>word_dict<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{}:{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>k <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token keyword">else</span> k<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'ASCII'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> word_dict<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"totally {} words"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>word_dict<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="21__56"></a>2.1 参数设置</h3> 
<p>在这里设置词表大小、embedding大小、batch_size等参数。</p> 
<pre><code class="prism language-python">vocab_size <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word_dict<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>vocab_size<span class="token punctuation">)</span>
emb_size <span class="token operator">=</span> <span class="token number">256</span>
seq_len <span class="token operator">=</span> <span class="token number">200</span>
batch_size <span class="token operator">=</span> <span class="token number">32</span>
epochs <span class="token operator">=</span> <span class="token number">2</span>
pad_id <span class="token operator">=</span> word_dict<span class="token punctuation">[</span><span class="token string">'&lt;pad&gt;'</span><span class="token punctuation">]</span>

classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'negative'</span><span class="token punctuation">,</span> <span class="token string">'positive'</span><span class="token punctuation">]</span>

<span class="token comment"># 生成句子列表</span>
<span class="token keyword">def</span> <span class="token function">ids_to_str</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">:</span>
    words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> k <span class="token keyword">in</span> ids<span class="token punctuation">:</span>
        w <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>word_dict<span class="token punctuation">)</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span>
        words<span class="token punctuation">.</span>append<span class="token punctuation">(</span>w <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token keyword">else</span> w<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'ASCII'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>words<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="22_padding_80"></a>2.2 用padding的方式对齐数据</h3> 
<p>文本数据中，每一句话的长度都是不一样的，为了方便后续的神经网络的计算，通常使用padding的方式对齐数据。</p> 
<pre><code class="prism language-python"><span class="token comment"># 读取数据归一化处理</span>
<span class="token keyword">def</span> <span class="token function">create_padded_dataset</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    padded_sents <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> batch_id<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sent<span class="token punctuation">,</span> label <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        padded_sent <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>sent<span class="token punctuation">[</span><span class="token punctuation">:</span>seq_len<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>pad_id<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span>seq_len <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int32'</span><span class="token punctuation">)</span>
        padded_sents<span class="token punctuation">.</span>append<span class="token punctuation">(</span>padded_sent<span class="token punctuation">)</span>
        labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>padded_sents<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>

<span class="token comment"># 对train、test数据进行实例化</span>
train_sents<span class="token punctuation">,</span> train_labels <span class="token operator">=</span> create_padded_dataset<span class="token punctuation">(</span>train_dataset<span class="token punctuation">)</span>
test_sents<span class="token punctuation">,</span> test_labels <span class="token operator">=</span> create_padded_dataset<span class="token punctuation">(</span>test_dataset<span class="token punctuation">)</span>

<span class="token comment"># 查看数据大小及举例内容</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>train_sents<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>train_labels<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>test_sents<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>test_labels<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

<span class="token keyword">for</span> sent <span class="token keyword">in</span> train_sents<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ids_to_str<span class="token punctuation">(</span>sent<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="23_DatasetDataLoader_110"></a>2.3 用Dataset与DataLoader加载</h3> 
<p>将前面准备好的训练集与测试集用<code>Dataset</code>与<code>DataLoader</code>封装后，完成数据的加载。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">IMDBDataset</span><span class="token punctuation">(</span>paddle<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    继承paddle.io.Dataset类进行封装数据
    '''</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sents<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>sents <span class="token operator">=</span> sents
        self<span class="token punctuation">.</span>labels <span class="token operator">=</span> labels
    
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>sents<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        label <span class="token operator">=</span> self<span class="token punctuation">.</span>labels<span class="token punctuation">[</span>index<span class="token punctuation">]</span>

        <span class="token keyword">return</span> data<span class="token punctuation">,</span> label

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>sents<span class="token punctuation">)</span>
    
train_dataset <span class="token operator">=</span> IMDBDataset<span class="token punctuation">(</span>train_sents<span class="token punctuation">,</span> train_labels<span class="token punctuation">)</span>
test_dataset <span class="token operator">=</span> IMDBDataset<span class="token punctuation">(</span>test_sents<span class="token punctuation">,</span> test_labels<span class="token punctuation">)</span>

train_loader <span class="token operator">=</span> paddle<span class="token punctuation">.</span>io<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span> return_list<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                    shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> drop_last<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test_loader <span class="token operator">=</span> paddle<span class="token punctuation">.</span>io<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>test_dataset<span class="token punctuation">,</span> return_list<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                    shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span> drop_last<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_141"></a>三、模型配置</h3> 
<p>本示例中使用一个序列特性的RNN网络，在查找到每个词对应的embedding后，取平均作为一个句子的表示。然后用Linear进行线性变换，同时使用Dropout防止过拟合。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MyRNN</span><span class="token punctuation">(</span>paddle<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MyRNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>embedding <span class="token operator">=</span> nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">(</span>vocab_size<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rnn <span class="token operator">=</span> nn<span class="token punctuation">.</span>SimpleRNN<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> num_layers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> direction<span class="token operator">=</span><span class="token string">'forward'</span><span class="token punctuation">,</span>dropout<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>linear <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>in_features<span class="token operator">=</span><span class="token number">256</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span> out_features<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        emb <span class="token operator">=</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>embedding<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span><span class="token punctuation">)</span>
        output<span class="token punctuation">,</span> hidden <span class="token operator">=</span> self<span class="token punctuation">.</span>rnn<span class="token punctuation">(</span>emb<span class="token punctuation">)</span>
        hidden <span class="token operator">=</span> paddle<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">(</span>hidden<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hidden<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
        hidden <span class="token operator">=</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>hidden<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>linear<span class="token punctuation">(</span>hidden<span class="token punctuation">)</span> 
</code></pre> 
<h3><a id="_162"></a>四、模型训练</h3> 
<pre><code class="prism language-python"><span class="token comment"># 可视化定义</span>
<span class="token keyword">def</span> <span class="token function">draw_process</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> color<span class="token punctuation">,</span> iters<span class="token punctuation">,</span> data<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span>title<span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">24</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"iter"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span>label<span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>iters<span class="token punctuation">,</span> data<span class="token punctuation">,</span> color<span class="token operator">=</span>color<span class="token punctuation">,</span> label<span class="token operator">=</span>label<span class="token punctuation">)</span> 
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 对模型进行封装</span>
<span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    opt <span class="token operator">=</span> paddle<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> parameters<span class="token operator">=</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    steps <span class="token operator">=</span> <span class="token number">0</span>
    Iters<span class="token punctuation">,</span> total_loss<span class="token punctuation">,</span> total_acc <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> batch_id<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            steps <span class="token operator">+=</span>

 <span class="token number">1</span>
            sent <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            label <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            
            logits <span class="token operator">=</span> model<span class="token punctuation">(</span>sent<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> paddle<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> label<span class="token punctuation">)</span>
            acc <span class="token operator">=</span> paddle<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>accuracy<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> label<span class="token punctuation">)</span>

            <span class="token keyword">if</span> batch_id <span class="token operator">%</span> <span class="token number">500</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 500个epoch输出一次结果</span>
                Iters<span class="token punctuation">.</span>append<span class="token punctuation">(</span>steps<span class="token punctuation">)</span>
                total_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                total_acc<span class="token punctuation">.</span>append<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"epoch: {}, batch_id: {}, loss is: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> batch_id<span class="token punctuation">,</span> loss<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            opt<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            opt<span class="token punctuation">.</span>clear_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># evaluate model after one epoch</span>
        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        accuracies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        
        <span class="token keyword">for</span> batch_id<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>test_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            sent <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            label <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

            logits <span class="token operator">=</span> model<span class="token punctuation">(</span>sent<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> paddle<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> label<span class="token punctuation">)</span>
            acc <span class="token operator">=</span> paddle<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>accuracy<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> label<span class="token punctuation">)</span>
            
            accuracies<span class="token punctuation">.</span>append<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        avg_acc<span class="token punctuation">,</span> avg_loss <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>accuracies<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>losses<span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[validation] accuracy: {}, loss: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>avg_acc<span class="token punctuation">,</span> avg_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 保存模型</span>
        paddle<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_model_final.pdparams"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 可视化查看</span>
    draw_process<span class="token punctuation">(</span><span class="token string">"training loss"</span><span class="token punctuation">,</span> <span class="token string">"red"</span><span class="token punctuation">,</span> Iters<span class="token punctuation">,</span> total_loss<span class="token punctuation">,</span> <span class="token string">"training loss"</span><span class="token punctuation">)</span>
    draw_process<span class="token punctuation">(</span><span class="token string">"training acc"</span><span class="token punctuation">,</span> <span class="token string">"green"</span><span class="token punctuation">,</span> Iters<span class="token punctuation">,</span> total_acc<span class="token punctuation">,</span> <span class="token string">"training acc"</span><span class="token punctuation">)</span>
        
model <span class="token operator">=</span> MyRNN<span class="token punctuation">(</span><span class="token punctuation">)</span>
train<span class="token punctuation">(</span>model<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_238"></a>五、模型评估</h3> 
<pre><code class="prism language-python">model_state_dict <span class="token operator">=</span> paddle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'1_model_final.pdparams'</span><span class="token punctuation">)</span>  <span class="token comment"># 导入模型</span>
model <span class="token operator">=</span> MyRNN<span class="token punctuation">(</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span>set_state_dict<span class="token punctuation">(</span>model_state_dict<span class="token punctuation">)</span> 
model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
accuracies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
losses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> batch_id<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>test_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sent <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    label <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

    logits <span class="token operator">=</span> model<span class="token punctuation">(</span>sent<span class="token punctuation">)</span>
    loss <span class="token operator">=</span> paddle<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> label<span class="token punctuation">)</span>
    acc <span class="token operator">=</span> paddle<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>accuracy<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> label<span class="token punctuation">)</span>
    
    accuracies<span class="token punctuation">.</span>append<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    losses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

avg_acc<span class="token punctuation">,</span> avg_loss <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>accuracies<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>losses<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[validation] accuracy: {}, loss: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>avg_acc<span class="token punctuation">,</span> avg_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_263"></a>六、模型预测</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">ids_to_str</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">:</span>
    words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> k <span class="token keyword">in</span> ids<span class="token punctuation">:</span>
        w <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>word_dict<span class="token punctuation">)</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span>
        words<span class="token punctuation">.</span>append<span class="token punctuation">(</span>w <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token keyword">else</span> w<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'UTF-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>words<span class="token punctuation">)</span>

label_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">"negative"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">"positive"</span><span class="token punctuation">}</span>

<span class="token comment"># 导入模型</span>
model_state_dict <span class="token operator">=</span> paddle<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'1_model_final.pdparams'</span><span class="token punctuation">)</span>
model <span class="token operator">=</span> MyRNN<span class="token punctuation">(</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span>set_state_dict<span class="token punctuation">(</span>model_state_dict<span class="token punctuation">)</span> 
model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> batch_id<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>test_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sent <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    results <span class="token operator">=</span> model<span class="token punctuation">(</span>sent<span class="token punctuation">)</span>

    predictions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> probs <span class="token keyword">in</span> results<span class="token punctuation">:</span>
        <span class="token comment"># 映射分类label</span>
        idx <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>probs<span class="token punctuation">)</span>
        labels <span class="token operator">=</span> label_map<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        predictions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> pre <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>predictions<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">' 数据: {} \n 情感: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ids_to_str<span class="token punctuation">(</span>sent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pre<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token keyword">break</span>
</code></pre> 
<p>以上是使用RNN完成IMDB电影评论情感分析的示例。通过搭建RNN网络，对文本数据进行预处理、模型训练和评估，最终实现了对电影评论情感的分类。在实际应用中，可以根据需求调整网络结构和超参数，提高模型性能。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/355df1a0dd81af7eca8884e297cc5a32/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ZooKeeper初探：分布式世界的守护者</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/94d77efcd41ddceffebbefb42071f6f0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Rust-trait</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>