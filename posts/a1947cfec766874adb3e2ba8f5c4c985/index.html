<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s学习-通过Service访问Pod - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s学习-通过Service访问Pod" />
<meta property="og:description" content="假设Pod中的容器很可能因为各种原因发生故障而死掉。Deployment等Controller会通过动态创建和销毁Pod来保证应用整体的健壮性。换句话说，Pod是脆弱的，但应用是健壮的。
每个Pod都有自己的IP地址。当Controller用新Pod替代发生故障的Pod时，新Pod会分配到新的IP地址。这样就产生了⼀个问题：如果⼀组Pod对外提供服务（比如HTTP），它们的IP很有可能发⽣变化，那么客户端如何找到并访问这个服务呢？Kubernetes给出的解决方案是Service。
1.1 Service是什么 由于Pod的动态性，Service解决了一个重要问题：如果一组Pod（称为“后端”）为其他Pod（称为“前端”）提供服务，前端如何找到并连接到后端的IP地址。Kubernetes中的Service为此提供了解决方案，通过提供稳定的虚拟IP和DNS，使服务发现变得简单而可靠。
1.2 Service的几种类型 （1）ClusterIP
ClusterIP 服务是 Kubernetes 的默认服务。它给你一个集群内的服务，集群内的其它应用都可以访问该服务，但是集群外部无法访问它。
（2）NodePort
除了只在内部访问的服务，我们总有很多是需要暴露出来公开访问的服务吧。在ClusterIP基础上为Service在每台机器上绑定一个端口，这样就可以通过:NodePort来访问这些服务。
（3）LoadBalancer
LoadBalancer 服务是暴露服务到 internet 的标准方式，它借助Cloud Provider创建一个外部的负载均衡器，并将请求转发到:NodePort（向节点导流）。
1.3 ClusterIP 先创建Deployment。
vi httpd.yaml
apiVersion: apps/v1 kind: Deployment metadata: name: httpd spec: replicas: 3 selector: # 添加这一行，定义标签选择器 matchLabels: run: httpd template: metadata: labels: run: httpd spec: containers: - name: httpd image: httpd ports: - containerPort: 80 我们启动了三个Pod，运行httpd镜像，label是run: httpd，Service将会用这个label来挑选Pod。
kubectl get pod -o wide Pod分配了各自的IP，这些IP只能被KubernetesCluster中的容器和节点访问，如图所示。
[root@k8s-master ~]# kubectl get pod -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES httpd-ff8d77b9b-dpp79 1/1 Running 1 43h 10." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a1947cfec766874adb3e2ba8f5c4c985/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-31T11:11:16+08:00" />
<meta property="article:modified_time" content="2024-01-31T11:11:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s学习-通过Service访问Pod</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>假设Pod中的容器很可能因为各种原因发生故障而死掉。Deployment等Controller会通过动态创建和销毁Pod来保证应用整体的健壮性。换句话说，Pod是脆弱的，但应用是健壮的。</p> 
<p>每个Pod都有自己的IP地址。当Controller用新Pod替代发生故障的Pod时，新Pod会分配到新的IP地址。这样就产生了⼀个问题：如果⼀组Pod对外提供服务（比如HTTP），它们的IP很有可能发⽣变化，那么客户端如何找到并访问这个服务呢？Kubernetes给出的解决方案是Service。</p> 
<h3><a id="11_Service_3"></a>1.1 Service是什么</h3> 
<p>由于Pod的动态性，Service解决了一个重要问题：如果一组Pod（称为“后端”）为其他Pod（称为“前端”）提供服务，前端如何找到并连接到后端的IP地址。Kubernetes中的Service为此提供了解决方案，通过提供稳定的虚拟IP和DNS，使服务发现变得简单而可靠。</p> 
<h3><a id="12_Service_5"></a>1.2 Service的几种类型</h3> 
<p>（1）ClusterIP<br> ClusterIP 服务是 Kubernetes 的默认服务。它给你一个集群内的服务，集群内的其它应用都可以访问该服务，但是集群外部无法访问它。<br> （2）NodePort<br> 除了只在内部访问的服务，我们总有很多是需要暴露出来公开访问的服务吧。在ClusterIP基础上为Service在每台机器上绑定一个端口，这样就可以通过:NodePort来访问这些服务。<br> （3）LoadBalancer<br> LoadBalancer 服务是暴露服务到 internet 的标准方式，它借助Cloud Provider创建一个外部的负载均衡器，并将请求转发到:NodePort（向节点导流）。</p> 
<h3><a id="13_ClusterIP_13"></a>1.3 ClusterIP</h3> 
<p>先创建Deployment。<br> vi httpd.yaml</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>  <span class="token comment"># 添加这一行，定义标签选择器</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">run</span><span class="token punctuation">:</span> httpd
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">run</span><span class="token punctuation">:</span> httpd
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd
        <span class="token key atrule">image</span><span class="token punctuation">:</span> httpd
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

</code></pre> 
<p>我们启动了三个Pod，运行httpd镜像，label是run: httpd，Service将会用这个label来挑选Pod。</p> 
<pre><code class="prism language-bash">kubectl get pod <span class="token parameter variable">-o</span> wide
</code></pre> 
<p>Pod分配了各自的IP，这些IP只能被KubernetesCluster中的容器和节点访问，如图所示。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -o wide</span>
NAME                                READY   STATUS      RESTARTS   AGE   IP             NODE        NOMINATED NODE   READINESS GATES
httpd-ff8d77b9b-dpp79               <span class="token number">1</span>/1     Running     <span class="token number">1</span>          43h   <span class="token number">10.244</span>.2.104   k8s-node2   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
httpd-ff8d77b9b-n5w6x               <span class="token number">1</span>/1     Running     <span class="token number">1</span>          43h   <span class="token number">10.244</span>.2.103   k8s-node2   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
httpd-ff8d77b9b-t6jhg               <span class="token number">1</span>/1     Running     <span class="token number">1</span>          43h   <span class="token number">10.244</span>.2.105   
</code></pre> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.2.103</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.2.104</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># curl 10.244.2.105</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>

</code></pre> 
<p>接下来创建Service，其配置文件如下。<br> vi httpdservice.yaml</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> httpd
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> 
<p>执⾏kubectl apply创建Service httpd-svc,查看service</p> 
<pre><code class="prism language-bash">kubectl get <span class="token function">service</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get service</span>
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
httpd-svc    ClusterIP   <span class="token number">10.1</span>.216.8   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>/TCP   43h
kubernetes   ClusterIP   <span class="token number">10.1</span>.0.1     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP    10d
</code></pre> 
<p>httpd-svc分配到⼀个CLUSTER-IP 10.1.216.8。可以通过该IP访问后端的httpd Pod，如图。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># curl 10.1.216.8:8080</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> 
<p>通过kubectl describe可以查看httpd-svc与Pod的对应关系，如图</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl describe service httpd-svc</span>
Name:              httpd-svc
Namespace:         default
Labels:            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:       Selector:  <span class="token assign-left variable">run</span><span class="token operator">=</span>httpd
Type:              ClusterIP
IP:                <span class="token number">10.1</span>.216.8
Port:              <span class="token operator">&lt;</span>unset<span class="token operator">&gt;</span>  <span class="token number">8080</span>/TCP
TargetPort:        <span class="token number">80</span>/TCP
Endpoints:         <span class="token number">10.244</span>.2.103:80,10.244.2.104:80,10.244.2.105:80
Session Affinity:  None
Events:            <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

</code></pre> 
<p>Endpoints罗列了三个Pod的IP和端口。我们知道Pod的IP是在容器中配置的，那么Service的Cluster IP又是配置在哪⾥的呢？CLUSTER-IP又是如何映射到Pod IP的呢？<br> 答案是iptables。</p> 
<h3><a id="14_Cluster_IP_117"></a>1.4 Cluster IP底层实现</h3> 
<p>ClusterIP是⼀个虚拟IP，是由Kubernetes节点上的iptables规则管理的。可以通过iptables-save命令打印出当前节点的iptables规则，因为输出较多，这里只截取与httpd-svcClusterIP10.1.216.8相关的信息，如下。</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">-A</span> KUBE-SERVICES <span class="token operator">!</span> <span class="token parameter variable">-s</span> <span class="token number">10.244</span>.0.0/16 <span class="token parameter variable">-d</span> <span class="token number">10.1</span>.216.8/32 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc: cluster IP"</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">808</span>       <span class="token number">0</span> <span class="token parameter variable">-j</span> KUBE-MARK-MASQ
<span class="token parameter variable">-A</span> KUBE-SERVICES <span class="token parameter variable">-d</span> <span class="token number">10.1</span>.216.8/32 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc: cluster IP"</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">8080</span> <span class="token parameter variable">-j</span> KUBE-SVC-RL3JAE4GN7VOGDGP

</code></pre> 
<p>这两条规则的含义是：<br> （1）如果Cluster内的Pod（源地址来⾃10.244.0.0/16）要访问<br> httpd-svc，则允许。<br> （2）其他源地址访问httpd-svc，跳转到规则KUBE-SVC-<br> RL3JAE4GN7VOGDGP。KUBE-SVC-RL3JAE4GN7VOGDGP规则如下。</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">-A</span> KUBE-SVC-RL3JAE4GN7VOGDGP <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-m</span> statistic <span class="token parameter variable">--mode</span> random <span class="token parameter variable">--probability</span> <span class="token number">0.33333333349</span> <span class="token parameter variable">-j</span> KU       BE-SEP-EQHMOIHNIUPMH73P
<span class="token parameter variable">-A</span> KUBE-SVC-RL3JAE4GN7VOGDGP <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-m</span> statistic <span class="token parameter variable">--mode</span> random <span class="token parameter variable">--probability</span> <span class="token number">0.50000000000</span> <span class="token parameter variable">-j</span> KU       BE-SEP-7VYTM2IXTFTHGXZQ
<span class="token parameter variable">-A</span> KUBE-SVC-RL3JAE4GN7VOGDGP <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-j</span> KUBE-SEP-6OZMKNJKUPLE2HZF

</code></pre> 
<p>（1）1/3的概率跳转到规则KUBE-SEP-EQHMOIHNIUPMH73P。<br> （2）1/3的概率（剩下2/3的⼀半）跳转到规则KUBE-SEP-7VYTM2IXTFTHGXZQ。<br> （3）1/3的概率跳转到规则KUBE-SEP-6OZMKNJKUPLE2HZF。</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">-A</span> KUBE-SEP-EQHMOIHNIUPMH73P <span class="token parameter variable">-s</span> <span class="token number">10.244</span>.2.106/32 <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-j</span> KUBE-MARK-MASQ
<span class="token parameter variable">-A</span> KUBE-SEP-EQHMOIHNIUPMH73P <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">-j</span> DNAT --to-destination <span class="token number">10.244</span>.2.106:80

<span class="token parameter variable">-A</span> KUBE-SEP-7VYTM2IXTFTHGXZQ <span class="token parameter variable">-s</span> <span class="token number">10.244</span>.2.107/32 <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-j</span> KUBE-MARK-MASQ
<span class="token parameter variable">-A</span> KUBE-SEP-7VYTM2IXTFTHGXZQ <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">-j</span> DNAT --to-destination <span class="token number">10.244</span>.2.107:80

<span class="token parameter variable">-A</span> KUBE-SEP-6OZMKNJKUPLE2HZF <span class="token parameter variable">-s</span> <span class="token number">10.244</span>.2.108/32 <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-j</span> KUBE-MARK-MASQ
<span class="token parameter variable">-A</span> KUBE-SEP-6OZMKNJKUPLE2HZF <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">-j</span> DNAT --to-destination <span class="token number">10.244</span>.2.108:80

</code></pre> 
<p>可以看到是将请求分别转发到后端的三个Pod。<br> 通过上面的分析，我们得到结论：iptables将访问Service的流量转发到后端Pod，而且使用类似轮询的负载均衡策略。</p> 
<h3><a id="15_DNSService_160"></a>1.5 DNS访问Service</h3> 
<p>kubeadm部署时会默认安装kube-dns组件。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment">#  kubectl get deployment --namespace=kube-system</span>
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
coredns          <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           12d
metrics-server   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           12d
</code></pre> 
<p>kube-dns是⼀个DNS服务器。每当有新的Service被创建，kube-dns会添加该Service的DNS记录。Cluster中的Pod可以通过&lt;SERVICE_NAME&gt;.&lt;NAMESPACE_NAME&gt;访问Service。比如可以用httpd-svc.default访问Servicehttpd-svc。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl run busybox --rm -ti --image=busybox /bin/sh</span>
If you don<span class="token string">'t see a command prompt, try pressing enter.
/ # curl httpd-svc.default:8080
/bin/sh: curl: not found
/ # wget httpd-svc.default:8080
Connecting to httpd-svc.default:8080 (10.1.216.8:8080)
saving to '</span>index.html<span class="token string">'
index.html           100% |******************************************************************************************|    45  0:00:00 ETA
'</span>index.html' saved

</code></pre> 
<p>如果要访问其他namespace中的Service，就必须带上namesapce了。在kube-public中部署Service httpd2-svc。<br> vi httpd2.yaml</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd2
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>public
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">run</span><span class="token punctuation">:</span> httpd2
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">run</span><span class="token punctuation">:</span> httpd2
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd2
        <span class="token key atrule">image</span><span class="token punctuation">:</span> httpd
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd2<span class="token punctuation">-</span>svc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>public
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> httpd2
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> 
<p>通过namespace:kube-public指定资源所属的namespace。多个资源可以在⼀个YAML⽂件中定义，⽤“—”分割。执⾏kubectlapply创建资源。</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment">#  kubectl apply -f httpd2.yaml</span>
deployment.apps/httpd2 created
service/httpd2-svc unchanged
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get service --namespace=kube-public</span>
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
httpd2-svc   ClusterIP   <span class="token number">10.1</span>.19.55   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>/TCP   9m15s
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl run busybox --rm -ti --image=busybox /bin/sh</span>
If you don<span class="token string">'t see a command prompt, try pressing enter.
/ # wget httpd2-svc.kube-public:8080
Connecting to httpd2-svc.kube-public:8080 (10.1.19.55:8080)
saving to '</span>index.html<span class="token string">'
index.html           100% |******************************************************************************************|    45  0:00:00 ETA
'</span>index.html' saved

</code></pre> 
<h3><a id="15__NodePort_239"></a>1.5 NodePort</h3> 
<p>Service通过Cluster节点的静态端口对外提供服务。Cluster外部可以通过:访问Service。<br> 下面我们来实践NodePort，Service httpd-svc的配置文件修改。<br> vi httpdservice.yaml</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> httpd
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

</code></pre> 
<p>添加type: NodePort，重新创建httpd-svc</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># vi httpdservice.yaml</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment">#  kubectl apply -f httpdservice.yaml</span>
service/httpd-svc configured
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get service httpd-svc</span>
NAME        TYPE       CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
httpd-svc   NodePort   <span class="token number">10.1</span>.216.8   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>:30560/TCP   2d23h
</code></pre> 
<p>Kubernetes依然会为httpd-svc分配⼀个ClusterIP，不同的是：<br> （1）EXTERNAL-IP为nodes，表示可通过Cluster每个节点自身的IP访问Service。<br> （2）PORT(S)为8080:30560。8080是ClusterIP监听的端口，30560则是节点上监听的端口。Kubernetes会从30000〜32767中分配⼀个可用的端口，每个节点都会监听此端⼝并将请求转发给Service。</p> 
<p>测试NodePort是否正常工作，通过三个节点IP+30560端口都能够访问httpd-svc。：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># curl 192.168.200.128:30560</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># curl 192.168.200.129:30560</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># curl 192.168.200.130:30560</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> 
<p>Kubernetes是如何将:映射到Pod的呢？执行<code>iptables-save</code><br> 与ClusterIP⼀样，也是借助了iptables。与ClusterIP相比，每个节点的iptables中都增加了下面两条规则。</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">-A</span> KUBE-NODEPORTS <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">30560</span> <span class="token parameter variable">-j</span> KUBE-MARK-MASQ
<span class="token parameter variable">-A</span> KUBE-NODEPORTS <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">30560</span> <span class="token parameter variable">-j</span> KUBE-SVC-RL3JAE4GN7VOGDGP
</code></pre> 
<p>规则的含义是：访问当前节点32312端口的请求会应用规则KUBE-<br> SVC-RL3JAE4GN7VOGDGP，内容如下</p> 
<pre><code class="prism language-bash"><span class="token parameter variable">-A</span> KUBE-SVC-RL3JAE4GN7VOGDGP <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-m</span> statistic <span class="token parameter variable">--mode</span> random <span class="token parameter variable">--probability</span> <span class="token number">0.33333333349</span> <span class="token parameter variable">-j</span> KUBE-SEP-EQHMOIHNIUPMH73P
<span class="token parameter variable">-A</span> KUBE-SVC-RL3JAE4GN7VOGDGP <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-m</span> statistic <span class="token parameter variable">--mode</span> random <span class="token parameter variable">--probability</span> <span class="token number">0.50000000000</span> <span class="token parameter variable">-j</span> KUBE-SEP-7VYTM2IXTFTHGXZQ
<span class="token parameter variable">-A</span> KUBE-SVC-RL3JAE4GN7VOGDGP <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">"default/httpd-svc:"</span> <span class="token parameter variable">-j</span> KUBE-SEP-6OZMKNJKUPLE2HZF
</code></pre> 
<p>其作用就是负载均衡到每⼀个Pod。</p> 
<p>NodePort默认的是随机选择，不过我们可以用nodePort指定某个特定端口。<br> vi httpdservice.yaml</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpd<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> httpd
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP 
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31000</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

</code></pre> 
<p>现在配置文件中就有三个Port了：</p> 
<ul><li>nodePort是节点上监听的端口。</li><li>port是ClusterIP上监听的端口。</li><li>targetPort是Pod监听的端口。</li></ul> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># vi httpdservice.yaml</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment">#  kubectl apply -f httpdservice.yaml</span>
service/httpd-svc configured
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># curl 192.168.200.130:31000</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># curl 192.168.200.128:31000</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># curl 192.168.200.129:31000</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>It works<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>

</code></pre> 
<p>最终，Node和ClusterIP在各自端口上接收到的请求都会通过 iptables转发到Pod的targetPort。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/35541b87f9e3a66474a91ae31bb5b9a0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">怎 么 优 化 H5 让 它 可 以 在 300ms 之 内</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/236406da7031552a6de8d2adc3fdb1d8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">毕业设计项目分享40个【源码&#43;论文】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>