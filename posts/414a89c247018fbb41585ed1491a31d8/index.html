<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>AI - FlowField(流场寻路) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="AI - FlowField(流场寻路)" />
<meta property="og:description" content="FlowField流场寻路，利用网格存储每个点对目标点的推力，网格上的单位根据对于推力进行移动。用于大量单位进行寻路对于同一目的地的寻路，常用于rts游戏等。
对应一张网格地图(图中黑块是不可行走区域)
生成热度图 计算所有网格对于目标点(图中红点)网格的路径距离。(每个格子的移动距离算作1)。
通过dijkstra算法遍历出每个格子的路径距离.(a *算法启发函数结果为0就是dijkstra算法。之前NavMesh寻路有说明过a *算法)
void FlowFieldScene::createHeadMap() { unordered_map&lt;int, float&gt; openList; unordered_map&lt;int, float&gt; closeList; _distNode-&gt;removeAllChildren(); _dist.clear(); //FlowFieldMathHelper::mapHeight 地图高度，即地图在y轴上的格子数 for (int i = 0; i &lt;= FlowFieldMathHelper::mapHeight; i&#43;&#43;) { vector&lt;float&gt; d; d.resize(FlowFieldMathHelper::mapWidth &#43; 1, 0); _dist.push_back(d); } //转换实际位置到网格坐标的位置 Vec2 gridPos = FlowFieldMathHelper::getGridPos(_touchBeganPosition); //每个网格都有个唯一id int gridId = FlowFieldMathHelper::getGridIdByGridPos(gridPos.x, gridPos.y); openList.emplace(gridId, 0); while (!openList.empty()) { pair&lt;int, float&gt; node = *openList.begin(); for (auto n : openList) { if (node.second &gt; n.second) node = n; } openList." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/414a89c247018fbb41585ed1491a31d8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-01T21:07:08+08:00" />
<meta property="article:modified_time" content="2023-12-01T21:07:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">AI - FlowField(流场寻路)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>FlowField流场寻路，利用网格存储每个点对目标点的推力，网格上的单位根据对于推力进行移动。用于大量单位进行寻路对于同一目的地的寻路，常用于rts游戏等。</p> 
<p>对应一张网格地图(图中黑块是不可行走区域)<br> <img src="https://images2.imgbox.com/96/79/F5zBMs1I_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_5"></a>生成热度图</h3> 
<p>计算所有网格对于目标点(图中红点)网格的路径距离。(每个格子的移动距离算作1)。<br> 通过dijkstra算法遍历出每个格子的路径距离.(a *算法启发函数结果为0就是dijkstra算法。之前<a href="https://blog.csdn.net/Mhypnos/article/details/134540691?spm=1001.2014.3001.5502">NavMesh寻路</a>有说明过a *算法)</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">createHeadMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    unordered_map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&gt;</span> openList<span class="token punctuation">;</span>
    unordered_map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&gt;</span> closeList<span class="token punctuation">;</span>
    _distNode<span class="token operator">-&gt;</span><span class="token function">removeAllChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _dist<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//FlowFieldMathHelper::mapHeight 地图高度，即地图在y轴上的格子数</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapHeight<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> d<span class="token punctuation">;</span>
        d<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapWidth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _dist<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//转换实际位置到网格坐标的位置</span>
    Vec2 gridPos <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridPos</span><span class="token punctuation">(</span>_touchBeganPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//每个网格都有个唯一id</span>
    <span class="token keyword">int</span> gridId <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridIdByGridPos</span><span class="token punctuation">(</span>gridPos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> gridPos<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    openList<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>gridId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>openList<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&gt;</span> node <span class="token operator">=</span> <span class="token operator">*</span>openList<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> n <span class="token operator">:</span> openList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>second <span class="token operator">&gt;</span> n<span class="token punctuation">.</span>second<span class="token punctuation">)</span> node <span class="token operator">=</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        openList<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
        closeList<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Vec2 gridPos <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridPosById</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _dist<span class="token punctuation">[</span>gridPos<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>gridPos<span class="token punctuation">.</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
        <span class="token comment">//FlowFieldMathHelper::getNeighbor获取周边的格子，计算热度图四向就够</span>
        <span class="token keyword">auto</span> neighbors <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getNeighbor</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> neighbor <span class="token operator">:</span> neighbors<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//isBlock 判断是否是阻挡格</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBlock</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closeList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">.</span>first<span class="token punctuation">)</span> <span class="token operator">!=</span> closeList<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>openList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">.</span>first<span class="token punctuation">)</span> <span class="token operator">==</span> openList<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                openList<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">.</span>first<span class="token punctuation">,</span> neighbor<span class="token punctuation">.</span>second <span class="token operator">+</span> node<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>openList<span class="token punctuation">[</span>neighbor<span class="token punctuation">.</span>first<span class="token punctuation">]</span> <span class="token operator">&gt;</span> neighbor<span class="token punctuation">.</span>second <span class="token operator">+</span> node<span class="token punctuation">.</span>second<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    openList<span class="token punctuation">[</span>neighbor<span class="token punctuation">.</span>first<span class="token punctuation">]</span> <span class="token operator">=</span> neighbor<span class="token punctuation">.</span>second <span class="token operator">+</span> node<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1f/9a/3X55mLfw_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_57"></a>生成向量图</h3> 
<p>生成热度图之后，遍历每个网格，查找他所有相邻的网格(8向)，选择到目标点路径距离最小的网格(阻挡网格的路径距离无穷大)，把当前网格的向量指向对应网格，最终生成矢量图<br> (注意，当周围有阻挡网格时，要判断不能斜向穿过阻挡格)<br> <img src="https://images2.imgbox.com/eb/17/LthvsUp0_o.png" alt="在这里插入图片描述"><br> 当矢量是左上(-1,1)左下(-1,-1)右上(1,1)右下(1,-1),判断目标格子周围的阻挡格。静止矢量斜向穿过障碍物</p> 
<pre><code class="prism language-cpp"><span class="token comment">//静止倾斜穿过障碍物</span>
<span class="token keyword">bool</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">checkObliqueAngleBlock</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridX<span class="token punctuation">,</span> <span class="token keyword">int</span> gridY<span class="token punctuation">,</span> <span class="token keyword">int</span> offsetX<span class="token punctuation">,</span> <span class="token keyword">int</span> offsetY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>offsetX <span class="token operator">*</span> offsetY <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBlock</span><span class="token punctuation">(</span>gridX <span class="token operator">+</span> offsetX<span class="token punctuation">,</span> gridY<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isBlock</span><span class="token punctuation">(</span>gridX<span class="token punctuation">,</span> gridY <span class="token operator">+</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>生成向量图</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">createVectorMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _vectorNode<span class="token operator">-&gt;</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _vectorMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapHeight<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;=</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapWidth<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_dist<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
            Vec2 direct<span class="token punctuation">;</span>
            <span class="token keyword">float</span> neighborDist <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> offsetX <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> offsetX <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> offsetX<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> offsetY <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> offsetY <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> offsetY<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> toX <span class="token operator">=</span> x <span class="token operator">+</span> offsetX<span class="token punctuation">;</span>
                    <span class="token keyword">int</span> toY <span class="token operator">=</span> y <span class="token operator">+</span> offsetY<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBlock</span><span class="token punctuation">(</span>toX<span class="token punctuation">,</span> toY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> toX <span class="token operator">&amp;&amp;</span> y <span class="token operator">==</span> toY<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>toX <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> toX <span class="token operator">&gt;</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapWidth<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>toY <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> toY <span class="token operator">&gt;</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapHeight<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span> neighborDist <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> neighborDist <span class="token operator">&gt;</span> _dist<span class="token punctuation">[</span>toY<span class="token punctuation">]</span><span class="token punctuation">[</span>toX<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkObliqueAngleBlock</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> offsetX<span class="token punctuation">,</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        neighborDist <span class="token operator">=</span> _dist<span class="token punctuation">[</span>toY<span class="token punctuation">]</span><span class="token punctuation">[</span>toX<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        direct <span class="token operator">=</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>offsetX<span class="token punctuation">,</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            _vectorMap<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridIdByGridPos</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> direct<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8c/2f/HZQPWGXO_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_102"></a>设置转向力</h3> 
<p>根据设置的流场向量获得转向力</p> 
<pre><code class="prism language-cpp"><span class="token comment">//_flowFieldDirect为设置的当前格子流场转向力方向</span>
Vec2 <span class="token class-name">MoveNode</span><span class="token double-colon punctuation">::</span><span class="token function">flowField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_flowFieldDirect <span class="token operator">==</span> Vec2<span class="token double-colon punctuation">::</span>ZERO<span class="token punctuation">)</span> <span class="token keyword">return</span> Vec2<span class="token double-colon punctuation">::</span>ZERO<span class="token punctuation">;</span>
    Vec2 desiredVelocity <span class="token operator">=</span> _flowFieldDirect <span class="token operator">*</span> _dtSpeed<span class="token punctuation">;</span>

    Vec2 steering<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>MoveSmooth<span class="token punctuation">)</span> steering <span class="token operator">=</span> desiredVelocity <span class="token operator">-</span> _velocity<span class="token punctuation">;</span>
    <span class="token keyword">else</span> steering <span class="token operator">=</span> desiredVelocity<span class="token punctuation">;</span>
    <span class="token keyword">return</span> steering<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>加入之前的steering系统，<a href="https://blog.csdn.net/Mhypnos/article/details/134656350">转向系统</a>，<a href="https://blog.csdn.net/Mhypnos/article/details/134657950">集群模拟</a></p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">MoveNode</span><span class="token double-colon punctuation">::</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">float</span> dt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">findNeighbourObjs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _dtSpeed <span class="token operator">=</span> _speed <span class="token operator">*</span> dt<span class="token punctuation">;</span>
     Vec2 steering <span class="token operator">=</span> Vec2<span class="token double-colon punctuation">::</span>ZERO<span class="token punctuation">;</span>
     steering <span class="token operator">+=</span> <span class="token function">seek</span><span class="token punctuation">(</span>_tarPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
     steering <span class="token operator">+=</span> <span class="token function">flee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     steering <span class="token operator">+=</span> <span class="token function">wander</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     steering <span class="token operator">+=</span> <span class="token function">pursuit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     steering <span class="token operator">+=</span> <span class="token function">cohesion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     steering <span class="token operator">+=</span> <span class="token function">separation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     steering <span class="token operator">+=</span> <span class="token function">alignment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     steering <span class="token operator">+=</span> <span class="token function">flowField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     steering <span class="token operator">=</span> <span class="token function">turncate</span><span class="token punctuation">(</span>steering<span class="token punctuation">,</span> _maxForce<span class="token punctuation">)</span><span class="token punctuation">;</span>
     steering <span class="token operator">*=</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>_mass <span class="token punctuation">)</span><span class="token punctuation">;</span>
     _velocity <span class="token operator">+=</span> steering<span class="token punctuation">;</span>

    _velocity <span class="token operator">+=</span> <span class="token function">wallAvoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _velocity <span class="token operator">=</span> <span class="token function">turncate</span><span class="token punctuation">(</span>_velocity<span class="token punctuation">,</span> _maxSpeed <span class="token operator">*</span> dt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">updatePos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此时如果直接取当前所在网格的向量作流场力的方向，会出现两个问题</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">float</span> dt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> node <span class="token operator">:</span> _moveNodes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> gridId <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridId</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Vec2 direct <span class="token operator">=</span> _vectorMap<span class="token punctuation">[</span>gridId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span><span class="token function">setFlowFieldDirect</span><span class="token punctuation">(</span>direct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>1.如果转向力所占的权重不够大，会导致物体转向不及时，并且可能插入阻挡格的情况<br> <img src="https://images2.imgbox.com/a9/b0/xc6OvmZs_o.gif" alt="请添加图片描述"></p> 
<p>2.如果增大转向力所占权重，又容易导致物体直接贴着网格边缘行走，而非沿着中线行走<br> <img src="https://images2.imgbox.com/b0/f7/LBqXqcAd_o.gif" alt="请添加图片描述"></p> 
<p>为了改善这种情况，根据所处当前格的不同位置，选取不同方向的三个相邻网格，加上自身网格的4个向量进行线插值<br> <img src="https://images2.imgbox.com/4d/dd/bOh7Ajwd_o.png" alt="在这里插入图片描述"><br> 进行双线性插值</p> 
<h4><a id="_160"></a>双线性插值</h4> 
<p><img src="https://images2.imgbox.com/e1/33/0YsGSG0M_o.png" alt="在这里插入图片描述"><br> 获取4个向量后，先把网格y值相同的向量，进行两两线性插值，再把求出的两个新向量进行线性插值即可</p> 
<p>注意，双线性插值的话，如果目标点再阻挡格旁边，而阻挡格又没有向量(取0)的话，目标会直接穿过阻挡格<br> <img src="https://images2.imgbox.com/d9/93/16HOZXfQ_o.gif" alt="请添加图片描述"></p> 
<p>因此如果获取的网格是阻挡格，则直接取阻挡网格指向当前格的方向做插值。<br> 这个是只有流场力的单独优化，实际项目中，不同力的权重可能不同，真正避免与阻挡物碰撞。还是要加上专门的碰撞避免处理(如阻挡物周围加力场，ORCA等)<br> <img src="https://images2.imgbox.com/42/a0/vMToK6KE_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/65/46/BGWaogO5_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-cpp">Vec2 <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">bilinearInterpolation</span><span class="token punctuation">(</span>Vec2 curPosition<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Vec2 gridPos <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridPos</span><span class="token punctuation">(</span>curPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> offsetX<span class="token punctuation">,</span> offsetY<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curPosition<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> gridPos<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> offsetX <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>curPosition<span class="token punctuation">.</span>x <span class="token operator">==</span> gridPos<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> offsetX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> offsetX <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curPosition<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> gridPos<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> offsetY <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>curPosition<span class="token punctuation">.</span>y <span class="token operator">==</span> gridPos<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> offsetY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> offsetY <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>


    Vec2 v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v4<span class="token punctuation">;</span>
    v1 <span class="token operator">=</span> <span class="token function">getVectorByGridPos</span><span class="token punctuation">(</span>gridPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> noX <span class="token operator">=</span> gridPos<span class="token punctuation">.</span>x <span class="token operator">==</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapWidth <span class="token operator">||</span> <span class="token function">isBlock</span><span class="token punctuation">(</span>gridPos<span class="token punctuation">.</span>x <span class="token operator">+</span> offsetX<span class="token punctuation">,</span> gridPos<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//if (noX) v2 = getVectorByGridPos(gridPos);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>noX<span class="token punctuation">)</span> v2 <span class="token operator">=</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>offsetX<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> v2 <span class="token operator">=</span> <span class="token function">getVectorByGridPos</span><span class="token punctuation">(</span>gridPos <span class="token operator">+</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>offsetX<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> noY <span class="token operator">=</span> gridPos<span class="token punctuation">.</span>y <span class="token operator">==</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapHeight <span class="token operator">||</span> <span class="token function">isBlock</span><span class="token punctuation">(</span>gridPos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> gridPos<span class="token punctuation">.</span>y <span class="token operator">+</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//if (noY) v3 = getVectorByGridPos(gridPos);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>noY<span class="token punctuation">)</span> v3 <span class="token operator">=</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>offsetY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> v3 <span class="token operator">=</span> <span class="token function">getVectorByGridPos</span><span class="token punctuation">(</span>gridPos <span class="token operator">+</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//if (noX || noY) v4 = getVectorByGridPos(gridPos);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>noX <span class="token operator">||</span> noY<span class="token punctuation">)</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>offsetX<span class="token punctuation">,</span> <span class="token operator">-</span>offsetY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> v4 <span class="token operator">=</span> <span class="token function">getVectorByGridPos</span><span class="token punctuation">(</span>gridPos <span class="token operator">+</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>offsetX<span class="token punctuation">,</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> xWeight <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>curPosition<span class="token punctuation">.</span>x <span class="token operator">-</span> gridPos<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">-</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">;</span>
    v1 <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> xWeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v3 <span class="token operator">=</span> v3<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> xWeight<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> yWeight <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>curPosition<span class="token punctuation">.</span>y <span class="token operator">-</span> gridPos<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">-</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">;</span>

    Vec2 direct <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> yWeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    direct<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> direct<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">float</span> dt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> node <span class="token operator">:</span> _moveNodes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> gridId <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridId</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Vec2 direct <span class="token operator">=</span> <span class="token function">bilinearInterpolation</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            Vec2 direct = _vectorMap[gridId];</span>
            node<span class="token operator">-&gt;</span><span class="token function">setFlowFieldDirect</span><span class="token punctuation">(</span>direct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过双线性插值的方式，物体的行动轨迹会更加靠近与正中路线。<br> <img src="https://images2.imgbox.com/88/92/ok4zZPwt_o.gif" alt="请添加图片描述"></p> 
<h3><a id="_221"></a>流场力和一些其他力结合的效果</h3> 
<p><img src="https://images2.imgbox.com/fd/7e/50Uzwgtk_o.gif" alt="请添加图片描述"></p> 
<h3><a id="_224"></a>源码</h3> 
<p>FlowField.h</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__FLOW_FIELD_SCENE_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__FLOW_FIELD_SCENE_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"cocos2d.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"CrowdSimulation/MoveNodeManager.h"</span></span>
USING_NS_CC<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">FlowFieldScene</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Scene</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">static</span> Scene<span class="token operator">*</span> <span class="token function">createScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">onTouchBegan</span><span class="token punctuation">(</span>Touch<span class="token operator">*</span> touch<span class="token punctuation">,</span> Event<span class="token operator">*</span> unused_event<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// implement the "static create()" method manually</span>
    <span class="token function">CREATE_FUNC</span><span class="token punctuation">(</span>FlowFieldScene<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">createHeadMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">showHeatInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">createVectorMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">checkObliqueAngleBlock</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridX<span class="token punctuation">,</span> <span class="token keyword">int</span> gridY<span class="token punctuation">,</span> <span class="token keyword">int</span> offsetX<span class="token punctuation">,</span> <span class="token keyword">int</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">isBlock</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridX<span class="token punctuation">,</span> <span class="token keyword">int</span> gridY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> <span class="token function">isBlock</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">resetMoveNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Vec2 <span class="token function">getVectorByGridPos</span><span class="token punctuation">(</span>Vec2 gridPos<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Vec2 <span class="token function">bilinearInterpolation</span><span class="token punctuation">(</span>Vec2 curPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">float</span> dt<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">protected</span><span class="token operator">:</span>
    EventListenerTouchOneByOne<span class="token operator">*</span> _touchListener<span class="token punctuation">;</span>
    Vec2 _touchBeganPosition<span class="token punctuation">;</span>
    DrawNode<span class="token operator">*</span> _mapDrawNode<span class="token punctuation">;</span>
    Node<span class="token operator">*</span> _distNode<span class="token punctuation">;</span>
    DrawNode<span class="token operator">*</span> _vectorNode<span class="token punctuation">;</span>

    DrawNode<span class="token operator">*</span> _tarDot<span class="token punctuation">;</span>

    unordered_map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">&gt;</span> _blockGridIdMap<span class="token punctuation">;</span>

    vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;&gt;</span> _dist<span class="token punctuation">;</span>
    unordered_map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> Vec2<span class="token operator">&gt;</span> _vectorMap<span class="token punctuation">;</span>
    MoveNodeManager<span class="token operator">*</span> _manager<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>MoveNode<span class="token operator">*</span><span class="token operator">&gt;</span> _moveNodes<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<p>FlowField.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"FlowFieldScene.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"FlowFieldMathHelper.h"</span></span>

Scene<span class="token operator">*</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">createScene</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

vector<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span>Vec2<span class="token punctuation">,</span> Vec2<span class="token operator">&gt;&gt;</span> blockLine <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">220</span><span class="token punctuation">,</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">220</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">260</span><span class="token punctuation">,</span><span class="token number">550</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">260</span><span class="token punctuation">,</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">280</span><span class="token punctuation">,</span><span class="token number">350</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">,</span><span class="token number">350</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">280</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">1100</span><span class="token punctuation">,</span> <span class="token number">280</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">750</span><span class="token punctuation">,</span> <span class="token number">330</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">1150</span><span class="token punctuation">,</span> <span class="token number">330</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">115</span><span class="token punctuation">,</span> <span class="token number">115</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">115</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">115</span><span class="token punctuation">,</span> <span class="token number">115</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">215</span><span class="token punctuation">,</span> <span class="token number">115</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">270</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">777</span><span class="token punctuation">,</span> <span class="token number">575</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">1233</span><span class="token punctuation">,</span> <span class="token number">575</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">466</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">370</span><span class="token punctuation">,</span> <span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">577</span><span class="token punctuation">,</span> <span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">888</span><span class="token punctuation">,</span> <span class="token number">124</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">1277</span><span class="token punctuation">,</span> <span class="token number">124</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">problemLoading</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> filename<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Error while loading: %s\n"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Depending on how you compiled you might have to add 'Resources/' in front of filenames in FlowFieldScene.cpp\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// on "init" you need to initialize your instance</span>
<span class="token keyword">bool</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//</span>
    <span class="token comment">// 1. super init first</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Scene</span><span class="token double-colon punctuation">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">auto</span> visibleSize <span class="token operator">=</span> <span class="token class-name">Director</span><span class="token double-colon punctuation">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getVisibleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Vec2 origin <span class="token operator">=</span> <span class="token class-name">Director</span><span class="token double-colon punctuation">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getVisibleOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> layer <span class="token operator">=</span> <span class="token class-name">LayerColor</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">Color4B</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    layer<span class="token operator">:</span><span class="token function">setContentSize</span><span class="token punctuation">(</span>visibleSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">addChild</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> node <span class="token operator">=</span> <span class="token class-name">DrawNode</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//    for (int i = FlowFieldMathHelper::gridLen; i &lt; visibleSize.width; i += FlowFieldMathHelper::gridLen) {<!-- --></span>
<span class="token comment">//        node-&gt;drawSegment(Vec2(i, 0), Vec2(i, 640), 1, Color4F(0, 0, 0, 0.3));</span>
<span class="token comment">//    }</span>
<span class="token comment">//    for (int i = FlowFieldMathHelper::gridLen; i &lt; visibleSize.height; i += FlowFieldMathHelper::gridLen) {<!-- --></span>
<span class="token comment">//        node-&gt;drawSegment(Vec2(0, i), Vec2(1400, i), 1, Color4F(0, 0, 0, 0.3));</span>
<span class="token comment">//    }</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> line <span class="token operator">:</span> blockLine<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span>first<span class="token punctuation">.</span>x <span class="token operator">==</span> line<span class="token punctuation">.</span>second<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> minY <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>first<span class="token punctuation">.</span>y<span class="token punctuation">,</span> line<span class="token punctuation">.</span>second<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> maxY <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>first<span class="token punctuation">.</span>y<span class="token punctuation">,</span> line<span class="token punctuation">.</span>second<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> gridMinY <span class="token operator">=</span> minY <span class="token operator">/</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">;</span>
            <span class="token keyword">int</span> gridMaxY <span class="token operator">=</span> maxY <span class="token operator">/</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> gridX <span class="token operator">=</span> line<span class="token punctuation">.</span>first<span class="token punctuation">.</span>x <span class="token operator">/</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> y <span class="token operator">=</span> gridMinY<span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> gridMaxY<span class="token punctuation">;</span> y <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridIdByGridPos</span><span class="token punctuation">(</span>gridX<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _blockGridIdMap<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Vec2 v1 <span class="token operator">=</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>gridX<span class="token punctuation">,</span> gridMinY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Vec2 v2 <span class="token operator">=</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>gridX<span class="token punctuation">,</span> gridMaxY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            vector<span class="token operator">&lt;</span>Vec2<span class="token operator">&gt;</span> v <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">Vec2</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">Vec2</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">Vec2</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">,</span> v2<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">Vec2</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">,</span> v2<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            node<span class="token operator">-&gt;</span><span class="token function">drawPolygon</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Vec2<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Color4F</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">Color4F</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span>first<span class="token punctuation">.</span>y <span class="token operator">==</span> line<span class="token punctuation">.</span>second<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> minX <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>first<span class="token punctuation">.</span>x<span class="token punctuation">,</span> line<span class="token punctuation">.</span>second<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> maxX <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>first<span class="token punctuation">.</span>x<span class="token punctuation">,</span> line<span class="token punctuation">.</span>second<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> gridMinX <span class="token operator">=</span> minX <span class="token operator">/</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">;</span>
            <span class="token keyword">int</span> gridMaxX <span class="token operator">=</span> maxX <span class="token operator">/</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> gridY <span class="token operator">=</span> line<span class="token punctuation">.</span>first<span class="token punctuation">.</span>y <span class="token operator">/</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> x <span class="token operator">=</span> gridMinX<span class="token punctuation">;</span> x <span class="token operator">&lt;=</span> gridMaxX<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridIdByGridPos</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> gridY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                _blockGridIdMap<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Vec2 v1 <span class="token operator">=</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>gridMinX<span class="token punctuation">,</span> gridY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Vec2 v2 <span class="token operator">=</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>gridMaxX<span class="token punctuation">,</span> gridY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            vector<span class="token operator">&lt;</span>Vec2<span class="token operator">&gt;</span> v <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">Vec2</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">Vec2</span><span class="token punctuation">(</span>v2<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">Vec2</span><span class="token punctuation">(</span>v2<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">Vec2</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            node<span class="token operator">-&gt;</span><span class="token function">drawPolygon</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Vec2<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Color4F</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">Color4F</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    _mapDrawNode <span class="token operator">=</span> <span class="token class-name">DrawNode</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">addChild</span><span class="token punctuation">(</span>_mapDrawNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    _distNode <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">addChild</span><span class="token punctuation">(</span>_distNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _vectorNode <span class="token operator">=</span> <span class="token class-name">DrawNode</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">addChild</span><span class="token punctuation">(</span>_vectorNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    _tarDot <span class="token operator">=</span> <span class="token class-name">DrawNode</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">addChild</span><span class="token punctuation">(</span>_tarDot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _tarDot<span class="token operator">-&gt;</span><span class="token function">drawDot</span><span class="token punctuation">(</span>Vec2<span class="token double-colon punctuation">::</span>ZERO<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token function">Color4F</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _tarDot<span class="token operator">-&gt;</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">777</span><span class="token punctuation">,</span> <span class="token number">444</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _touchListener <span class="token operator">=</span> <span class="token class-name">EventListenerTouchOneByOne</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _touchListener<span class="token operator">-&gt;</span><span class="token function">setSwallowTouches</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _touchListener<span class="token operator">-&gt;</span>onTouchBegan <span class="token operator">=</span> <span class="token function">CC_CALLBACK_2</span><span class="token punctuation">(</span>FlowFieldScene<span class="token double-colon punctuation">::</span>onTouchBegan<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">getEventDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">addEventListenerWithSceneGraphPriority</span><span class="token punctuation">(</span>_touchListener<span class="token punctuation">,</span> layer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    _manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">MoveNodeManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">scheduleUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">onTouchBegan</span><span class="token punctuation">(</span>Touch<span class="token operator">*</span> touch<span class="token punctuation">,</span> Event<span class="token operator">*</span> event<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _touchBeganPosition <span class="token operator">=</span> touch<span class="token operator">-&gt;</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CCLOG</span><span class="token punctuation">(</span><span class="token string">"==========》 %f， %f"</span><span class="token punctuation">,</span> _touchBeganPosition<span class="token punctuation">.</span>x<span class="token punctuation">,</span> _touchBeganPosition<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridId</span><span class="token punctuation">(</span>_touchBeganPosition<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">resetMoveNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

    _tarDot<span class="token operator">-&gt;</span><span class="token function">setPosition</span><span class="token punctuation">(</span>_touchBeganPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">createHeadMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">createVectorMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//    resetMoveNode();</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">float</span> dt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> node <span class="token operator">:</span> _moveNodes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> gridId <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridId</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Vec2 direct <span class="token operator">=</span> <span class="token function">bilinearInterpolation</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            Vec2 direct = _vectorMap[gridId];</span>
            node<span class="token operator">-&gt;</span><span class="token function">setFlowFieldDirect</span><span class="token punctuation">(</span>direct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Vec2 <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">getVectorByGridPos</span><span class="token punctuation">(</span>Vec2 gridPos<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _vectorMap<span class="token punctuation">[</span><span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridIdByGridPos</span><span class="token punctuation">(</span>gridPos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> gridPos<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Vec2 <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">bilinearInterpolation</span><span class="token punctuation">(</span>Vec2 curPosition<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Vec2 gridPos <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridPos</span><span class="token punctuation">(</span>curPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> offsetX<span class="token punctuation">,</span> offsetY<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curPosition<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> gridPos<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> offsetX <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>curPosition<span class="token punctuation">.</span>x <span class="token operator">==</span> gridPos<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> offsetX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> offsetX <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curPosition<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> gridPos<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> offsetY <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>curPosition<span class="token punctuation">.</span>y <span class="token operator">==</span> gridPos<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> offsetY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> offsetY <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>


    Vec2 v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v4<span class="token punctuation">;</span>
    v1 <span class="token operator">=</span> <span class="token function">getVectorByGridPos</span><span class="token punctuation">(</span>gridPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> noX <span class="token operator">=</span> gridPos<span class="token punctuation">.</span>x <span class="token operator">==</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapWidth <span class="token operator">||</span> <span class="token function">isBlock</span><span class="token punctuation">(</span>gridPos<span class="token punctuation">.</span>x <span class="token operator">+</span> offsetX<span class="token punctuation">,</span> gridPos<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//if (noX) v2 = getVectorByGridPos(gridPos);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>noX<span class="token punctuation">)</span> v2 <span class="token operator">=</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>offsetX<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> v2 <span class="token operator">=</span> <span class="token function">getVectorByGridPos</span><span class="token punctuation">(</span>gridPos <span class="token operator">+</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>offsetX<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> noY <span class="token operator">=</span> gridPos<span class="token punctuation">.</span>y <span class="token operator">==</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapHeight <span class="token operator">||</span> <span class="token function">isBlock</span><span class="token punctuation">(</span>gridPos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> gridPos<span class="token punctuation">.</span>y <span class="token operator">+</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//if (noY) v3 = getVectorByGridPos(gridPos);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>noY<span class="token punctuation">)</span> v3 <span class="token operator">=</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>offsetY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> v3 <span class="token operator">=</span> <span class="token function">getVectorByGridPos</span><span class="token punctuation">(</span>gridPos <span class="token operator">+</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//if (noX || noY) v4 = getVectorByGridPos(gridPos);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>noX <span class="token operator">||</span> noY<span class="token punctuation">)</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token operator">-</span>offsetX<span class="token punctuation">,</span> <span class="token operator">-</span>offsetY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> v4 <span class="token operator">=</span> <span class="token function">getVectorByGridPos</span><span class="token punctuation">(</span>gridPos <span class="token operator">+</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>offsetX<span class="token punctuation">,</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> xWeight <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>curPosition<span class="token punctuation">.</span>x <span class="token operator">-</span> gridPos<span class="token punctuation">.</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">-</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">;</span>
    v1 <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> xWeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v3 <span class="token operator">=</span> v3<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> xWeight<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> yWeight <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>curPosition<span class="token punctuation">.</span>y <span class="token operator">-</span> gridPos<span class="token punctuation">.</span>y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">-</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">;</span>

    Vec2 direct <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> yWeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    direct<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> direct<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">createHeadMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    unordered_map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&gt;</span> openList<span class="token punctuation">;</span>
    unordered_map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&gt;</span> closeList<span class="token punctuation">;</span>
    _distNode<span class="token operator">-&gt;</span><span class="token function">removeAllChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _dist<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapHeight<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> d<span class="token punctuation">;</span>
        d<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapWidth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _dist<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Vec2 gridPos <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridPos</span><span class="token punctuation">(</span>_touchBeganPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> gridId <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridIdByGridPos</span><span class="token punctuation">(</span>gridPos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> gridPos<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    openList<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>gridId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>openList<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&gt;</span> node <span class="token operator">=</span> <span class="token operator">*</span>openList<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> n <span class="token operator">:</span> openList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>second <span class="token operator">&gt;</span> n<span class="token punctuation">.</span>second<span class="token punctuation">)</span> node <span class="token operator">=</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        openList<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
        closeList<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Vec2 gridPos <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridPosById</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _dist<span class="token punctuation">[</span>gridPos<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>gridPos<span class="token punctuation">.</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
        <span class="token keyword">auto</span> neighbors <span class="token operator">=</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getNeighbor</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> neighbor <span class="token operator">:</span> neighbors<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBlock</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closeList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">.</span>first<span class="token punctuation">)</span> <span class="token operator">!=</span> closeList<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>openList<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">.</span>first<span class="token punctuation">)</span> <span class="token operator">==</span> openList<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                openList<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">.</span>first<span class="token punctuation">,</span> neighbor<span class="token punctuation">.</span>second <span class="token operator">+</span> node<span class="token punctuation">.</span>second<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>openList<span class="token punctuation">[</span>neighbor<span class="token punctuation">.</span>first<span class="token punctuation">]</span> <span class="token operator">&gt;</span> neighbor<span class="token punctuation">.</span>second <span class="token operator">+</span> node<span class="token punctuation">.</span>second<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    openList<span class="token punctuation">[</span>neighbor<span class="token punctuation">.</span>first<span class="token punctuation">]</span> <span class="token operator">=</span> neighbor<span class="token punctuation">.</span>second <span class="token operator">+</span> node<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//    showHeatInfo();</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">showHeatInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _distNode<span class="token operator">-&gt;</span><span class="token function">removeAllChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapHeight<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;=</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapWidth<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isBlock</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">auto</span> num <span class="token operator">=</span> <span class="token class-name">Label</span><span class="token double-colon punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                num<span class="token operator">-&gt;</span><span class="token function">setColor</span><span class="token punctuation">(</span><span class="token function">Color3B</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//num-&gt;setSystemFontSize(20);</span>
                num<span class="token operator">-&gt;</span><span class="token function">setSystemFontSize</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _distNode<span class="token operator">-&gt;</span><span class="token function">addChild</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">auto</span> s <span class="token operator">=</span> <span class="token function">to_string</span><span class="token punctuation">(</span>_dist<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//num-&gt;setString(s.substr(0, s.find(".") + 2));</span>
                num<span class="token operator">-&gt;</span><span class="token function">setString</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                num<span class="token operator">-&gt;</span><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token function">Vec2</span><span class="token punctuation">(</span>x <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> y <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">+</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">isBlock</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridX<span class="token punctuation">,</span> <span class="token keyword">int</span> gridY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">isBlock</span><span class="token punctuation">(</span><span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridIdByGridPos</span><span class="token punctuation">(</span>gridX<span class="token punctuation">,</span> gridY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">bool</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">isBlock</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _blockGridIdMap<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>gridId<span class="token punctuation">)</span> <span class="token operator">!=</span> _blockGridIdMap<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//静止倾斜穿过障碍物</span>
<span class="token keyword">bool</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">checkObliqueAngleBlock</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridX<span class="token punctuation">,</span> <span class="token keyword">int</span> gridY<span class="token punctuation">,</span> <span class="token keyword">int</span> offsetX<span class="token punctuation">,</span> <span class="token keyword">int</span> offsetY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>offsetX <span class="token operator">*</span> offsetY <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBlock</span><span class="token punctuation">(</span>gridX <span class="token operator">+</span> offsetX<span class="token punctuation">,</span> gridY<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isBlock</span><span class="token punctuation">(</span>gridX<span class="token punctuation">,</span> gridY <span class="token operator">+</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">createVectorMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _vectorNode<span class="token operator">-&gt;</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _vectorMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapHeight<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;=</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapWidth<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_dist<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
            Vec2 direct<span class="token punctuation">;</span>
            <span class="token keyword">float</span> neighborDist <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> offsetX <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> offsetX <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> offsetX<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> offsetY <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> offsetY <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> offsetY<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> toX <span class="token operator">=</span> x <span class="token operator">+</span> offsetX<span class="token punctuation">;</span>
                    <span class="token keyword">int</span> toY <span class="token operator">=</span> y <span class="token operator">+</span> offsetY<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBlock</span><span class="token punctuation">(</span>toX<span class="token punctuation">,</span> toY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> toX <span class="token operator">&amp;&amp;</span> y <span class="token operator">==</span> toY<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>toX <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> toX <span class="token operator">&gt;</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapWidth<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>toY <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> toY <span class="token operator">&gt;</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapHeight<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span> neighborDist <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> neighborDist <span class="token operator">&gt;</span> _dist<span class="token punctuation">[</span>toY<span class="token punctuation">]</span><span class="token punctuation">[</span>toX<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkObliqueAngleBlock</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> offsetX<span class="token punctuation">,</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        neighborDist <span class="token operator">=</span> _dist<span class="token punctuation">[</span>toY<span class="token punctuation">]</span><span class="token punctuation">[</span>toX<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        direct <span class="token operator">=</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>offsetX<span class="token punctuation">,</span> offsetY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
<span class="token comment">//            Vec2 v1 = Vec2(x * FlowFieldMathHelper::gridLen + FlowFieldMathHelper::gridLen / 2, y * FlowFieldMathHelper::gridLen + FlowFieldMathHelper::gridLen / 2);</span>
<span class="token comment">//            Vec2 v2 = v1 + (direct * FlowFieldMathHelper::gridLen / 2);</span>
<span class="token comment">//            _vectorNode-&gt;drawSegment(v1, v2, 1, Color4F(0, 0, 1, 1));</span>
            _vectorMap<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridIdByGridPos</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> direct<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">FlowFieldScene</span><span class="token double-colon punctuation">::</span><span class="token function">resetMoveNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_moveNodes<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> moveNode <span class="token operator">=</span> _manager<span class="token operator">-&gt;</span><span class="token function">getFlowFieldNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">addChild</span><span class="token punctuation">(</span>moveNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _moveNodes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>moveNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">float</span> width <span class="token operator">=</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapWidth <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">;</span>
    <span class="token keyword">float</span> height <span class="token operator">=</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>mapHeight <span class="token operator">*</span> FlowFieldMathHelper<span class="token double-colon punctuation">::</span>gridLen<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> node <span class="token operator">:</span> _moveNodes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Vec2 v<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
            v<span class="token punctuation">.</span>x <span class="token operator">=</span> RandomHelper<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">random_real</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> width<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            v<span class="token punctuation">.</span>y <span class="token operator">=</span> RandomHelper<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">random_real</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> height<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isBlock</span><span class="token punctuation">(</span><span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridId</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span><span class="token function">setPos</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Vec2 vg = FlowFieldMathHelper::getGridPos(v);</span>
        <span class="token comment">//node-&gt;setPos(Vec2(vg.x * FlowFieldMathHelper::gridLen + FlowFieldMathHelper::gridLen / 2, vg.y * FlowFieldMathHelper::gridLen + FlowFieldMathHelper::gridLen / 2));</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>FlowFieldMathHelper.h</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__FLOWFIELD_MATH_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__FLOWFIELD_MATH_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"cocos2d.h"</span></span>
USING_NS_CC<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">FlowFieldMathHelper</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token keyword">static</span> Vec2 <span class="token function">getGridPos</span><span class="token punctuation">(</span>Vec2 pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getGridId</span><span class="token punctuation">(</span>Vec2 pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getGridIdByGridPos</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridX<span class="token punctuation">,</span> <span class="token keyword">int</span> gridY<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">static</span> vector<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&gt;&gt;</span> <span class="token function">getNeighbor</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridId<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">static</span> Vec2 <span class="token function">getGridPosById</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridId<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> gridLen <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>
	<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> mapWidth <span class="token operator">=</span> <span class="token number">1400</span> <span class="token operator">/</span> gridLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> mapHeight <span class="token operator">=</span> <span class="token number">640</span> <span class="token operator">/</span> gridLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<p>FlowFieldMathHelper.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"FlowFieldMathHelper.h"</span></span>

Vec2 <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridPos</span><span class="token punctuation">(</span>Vec2 pos<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">Vec2</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span>pos<span class="token punctuation">.</span>x <span class="token operator">/</span> gridLen<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">(</span>pos<span class="token punctuation">.</span>y <span class="token operator">/</span> gridLen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridId</span><span class="token punctuation">(</span>Vec2 pos<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	Vec2 v <span class="token operator">=</span> <span class="token function">getGridPos</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">getGridIdByGridPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>x<span class="token punctuation">,</span> v<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridIdByGridPos</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridX<span class="token punctuation">,</span> <span class="token keyword">int</span> gridY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>gridX <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> gridX <span class="token operator">&gt;</span> mapWidth<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>gridY <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> gridY <span class="token operator">&gt;</span> mapHeight<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> gridX <span class="token operator">+</span> gridY <span class="token operator">*</span> <span class="token punctuation">(</span>mapWidth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Vec2 <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getGridPosById</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> x <span class="token operator">=</span> gridId <span class="token operator">%</span> <span class="token punctuation">(</span>mapWidth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token punctuation">(</span>gridId <span class="token operator">-</span> x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>mapWidth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">Vec2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

vector<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&gt;&gt;</span> <span class="token class-name">FlowFieldMathHelper</span><span class="token double-colon punctuation">::</span><span class="token function">getNeighbor</span><span class="token punctuation">(</span><span class="token keyword">int</span> gridId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	Vec2 pos <span class="token operator">=</span> <span class="token function">getGridPosById</span><span class="token punctuation">(</span>gridId<span class="token punctuation">)</span><span class="token punctuation">;</span>
	vector<span class="token operator">&lt;</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&gt;&gt;</span> ret<span class="token punctuation">;</span>
	<span class="token comment">/*for (int offsetX = -1; offsetX &lt;= 1; offsetX++) {
		for (int offsetY = -1; offsetY &lt;= 1; offsetY++) {
			int x = pos.x + offsetX;
			int y = pos.y + offsetY;
			if (x == pos.x &amp;&amp; y == pos.y) continue;
			else if (x &lt; 0 || x &gt; mapWidth) continue;
			else if (y &lt; 0 || y &gt; mapHeight) continue;
			else if (x == pos.x || y == pos.y) ret.push_back(make_pair(getGridIdByGridPos(x, y), 1));
			else ret.push_back(make_pair(getGridIdByGridPos(x, y), 1.5));
		}
	}*/</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> offsetX <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> offsetX <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> offsetX<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> offsetY <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> offsetY <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> offsetY<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span> x <span class="token operator">=</span> pos<span class="token punctuation">.</span>x <span class="token operator">+</span> offsetX<span class="token punctuation">;</span>
			<span class="token keyword">int</span> y <span class="token operator">=</span> pos<span class="token punctuation">.</span>y <span class="token operator">+</span> offsetY<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> pos<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> y <span class="token operator">==</span> pos<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> x <span class="token operator">&gt;</span> mapWidth<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> y <span class="token operator">&gt;</span> mapHeight<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> pos<span class="token punctuation">.</span>x <span class="token operator">||</span> y <span class="token operator">==</span> pos<span class="token punctuation">.</span>y<span class="token punctuation">)</span> ret<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">make_pair</span><span class="token punctuation">(</span><span class="token function">getGridIdByGridPos</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/216ab7cb1e6fd10c421965afa48e7d83/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">maven 的 settings.xml 文件配置，别整那些没用的东西，下面这个配置吃遍天</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3984fdc58c5c71a9e8f8a09d184c2a55/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">麒麟v10系统arm64架构openssh9.5p1安装</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>