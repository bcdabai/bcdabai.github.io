<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ES的常用查询以及其他操作 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ES的常用查询以及其他操作" />
<meta property="og:description" content="1 数据准备 1.1 创建索引和新增数据 先新增一条数据，新增数据时会自动创建索引 test_standard_analyzer。
PUT /test_standard_analyzer/_doc/1 { &#34;remark&#34;: &#34;This is a test doc&#34; } PUT /test_standard_analyzer/_doc/2 { &#34;remark&#34;: &#34;This is an apple&#34; } 然后查询一下。
GET test_standard_analyzer/_search { &#34;query&#34;: { &#34;match_all&#34;: {} } } 查询结果如下所示。
&#34;hits&#34; : [ { &#34;_index&#34; : &#34;test_standard_analyzer&#34;, &#34;_type&#34; : &#34;_doc&#34;, &#34;_id&#34; : &#34;1&#34;, &#34;_score&#34; : 1.0, &#34;_source&#34; : { &#34;remark&#34; : &#34;This is a test doc&#34; } }, { &#34;_index&#34; : &#34;test_standard_analyzer&#34;, &#34;_type&#34; : &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/5fc5d5ddf055eb50f7530670d9e1466a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-16T16:32:01+08:00" />
<meta property="article:modified_time" content="2024-01-16T16:32:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ES的常用查询以及其他操作</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>1 数据准备</h2> 
<h3>1.1 创建索引和新增数据</h3> 
<p>先新增一条数据，新增数据时会自动创建索引 test_standard_analyzer。</p> 
<pre><code class="language-bash">PUT /test_standard_analyzer/_doc/1
{
  "remark": "This is a test doc"
}

PUT /test_standard_analyzer/_doc/2
{
  "remark": "This is an apple"
}</code></pre> 
<p>然后查询一下。</p> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "match_all": {}
  }
}
</code></pre> 
<p>查询结果如下所示。</p> 
<pre><code class="language-bash">    "hits" : [
      {
        "_index" : "test_standard_analyzer",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 1.0,
        "_source" : {
          "remark" : "This is a test doc"
        }
      },
      {
        "_index" : "test_standard_analyzer",
        "_type" : "_doc",
        "_id" : "2",
        "_score" : 1.0,
        "_source" : {
          "remark" : "This is an apple"
        }
      }
    ]</code></pre> 
<h3>1.2 测试分词</h3> 
<p>没指定es分词器时，es会使用默认分词器-standard。测试下分词效果。</p> 
<pre><code class="language-bash"> POST test_standard_analyzer/_analyze
{
  "field": "remark",
  "text": "This is a test doc"
}

# 或

 POST test_standard_analyzer/_analyze
{
  "analyzer": "standard",
  "text": "This is a test doc"
}</code></pre> 
<p>分词结果如下所示。</p> 
<pre><code class="language-bash">{
  "tokens" : [
    {
      "token" : "this",
      "start_offset" : 0,
      "end_offset" : 4,
      "type" : "&lt;ALPHANUM&gt;",
      "position" : 0
    },
    {
      "token" : "is",
      "start_offset" : 5,
      "end_offset" : 7,
      "type" : "&lt;ALPHANUM&gt;",
      "position" : 1
    },
    {
      "token" : "a",
      "start_offset" : 8,
      "end_offset" : 9,
      "type" : "&lt;ALPHANUM&gt;",
      "position" : 2
    },
    {
      "token" : "test",
      "start_offset" : 10,
      "end_offset" : 14,
      "type" : "&lt;ALPHANUM&gt;",
      "position" : 3
    },
    {
      "token" : "doc",
      "start_offset" : 15,
      "end_offset" : 18,
      "type" : "&lt;ALPHANUM&gt;",
      "position" : 4
    }
  ]
}
</code></pre> 
<h2></h2> 
<h2>2 ES查询</h2> 
<h3>2.1 match</h3> 
<p>match查询会将查询条件进行分词。命中数据的条件：匹配到查询条件的其中一个分词即可。</p> 
<p>以下查询将命中数据，查询条件被分词为“b”和“doc”。</p> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "match": {
      "remark":"b doc"
    }
  }
}</code></pre> 
<h3>2.2 match_phrase</h3> 
<p>match_phrase查询会将查询条件进行分词。</p> 
<p>命中数据的条件：（1）查询条件的所有分词都需要匹配到，（2）相对顺序还要一致，（3）默认（slop=0或者未设置该值）查询条件的分词在es数据中是连续的。</p> 
<h4>2.2.1 查询条件的分词在es数据中需要是连续的</h4> 
<p><strong>（1）命中数据</strong></p> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "match_phrase": {
      "remark":"a test doc"
    }
  }
}</code></pre> 
<p><strong>（2）未命中数据</strong></p> 
<p>以下查询未命中数据，因为查询条件的分词在es数据中不连续，中间还间隔一个“test”。</p> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "match_phrase": {
      "remark":"a doc"
    }
  }
}</code></pre> 
<h4>2.2.2 查询条件的分词在es数据中可以不连续</h4> 
<p>slop 参数用于指定中间可省略几个词语。slop &gt; 0时，查询条件的分词在es数据中可以不连续。</p> 
<p>因此以下查询将命中数据。</p> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "match_phrase": {
      "remark":{
        "query": "a doc",
        "slop": 1
      }
    }
  }
}</code></pre> 
<h3>2.3 multi_match</h3> 
<p>multi_match查询会将查询条件进行分词。它会<strong>从多个字段中去寻找</strong>我们要查找的条件。</p> 
<p>案例如下所示。先新增一条数据。</p> 
<pre><code class="language-bash">PUT /test_standard_analyzer/_doc/3
{
  "remark": "This is an apple",
  "content":"this is a green apple"
}</code></pre> 
<p>然后通过下述语句进行查询，此时能查到数据，是因为它会从字段 remark 和 content 中寻找我们要查找的条件，并且在 content 字段的倒排索引中匹配到了分词green。</p> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "multi_match": {
        "query" : "green banana",
        "fields" : ["remark", "content"]
    }
  }
}</code></pre> 
<h3 style="background-color:transparent;">2.4 term</h3> 
<p>term查询不会对查询条件进行分词，而是直接拿查询条件作为一个词去和倒排索引进行匹配。匹配到了，则命中了es的数据，否则未命中es数据。下面是具体的查询案例。</p> 
<h4>2.4.1 未命中数据</h4> 
<p>因为倒排索引中没有 “This is a test doc” 这个词。</p> 
<pre><code class="language-bash"># 指定最多返回50条数据，默认返回10条数据
GET test_standard_analyzer/_search
{
  "query": {
    "term": {
      "remark":"This is a test doc"
    }
  },
  "size":50
}</code></pre> 
<h4>2.4.2 命中了数据</h4> 
<p>因为此查询匹配到了倒排索引中的词-“doc”。</p> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "term": {
      "remark":"doc"
    }
  }
}</code></pre> 
<h3 style="background-color:transparent;">2.5 terms</h3> 
<p>terms查询不会对查询条件进行分词，而是直接拿查询条件作为词去和倒排索引进行匹配。查询条件中至少一个词匹配到了，则命中了es的数据。terms查询相当于对多个term查询结果取并集，即取所有词的匹配结果的并集。下面是具体的查询案例。</p> 
<h4>2.5.1 命中多条数据</h4> 
<p>查询语句</p> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "terms": {
      "remark": ["doc", "apple"]
    }
  }
}</code></pre> 
<p>查询结果</p> 
<pre><code class="language-bash">    "hits" : [
      {
        "_index" : "test_standard_analyzer",
        "_type" : "_doc",
        "_id" : "1",
        "_score" : 1.0,
        "_source" : {
          "remark" : "This is a test doc"
        }
      },
      {
        "_index" : "test_standard_analyzer",
        "_type" : "_doc",
        "_id" : "2",
        "_score" : 1.0,
        "_source" : {
          "remark" : "This is an apple"
        }
      }
    ]</code></pre> 
<h4>2.5.2 命中一条数据</h4> 
<p>查询语句</p> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "terms": {
      "remark": ["haha", "apple"]
    }
  }
}</code></pre> 
<p>查询结果</p> 
<pre><code class="language-bash">    "hits" : [
      {
        "_index" : "test_standard_analyzer",
        "_type" : "_doc",
        "_id" : "2",
        "_score" : 1.0,
        "_source" : {
          "remark" : "This is an apple"
        }
      }
    ]</code></pre> 
<h4>2.5.3 未命中数据</h4> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "terms": {
      "remark": ["tom", "jack"]
    }
  }
}</code></pre> 
<h3>2.6 fuzzy</h3> 
<p>fuzzy查询是一种模糊查询。它不会对查询条件进行分词。</p> 
<h4>2.6.1 参数介绍</h4> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "fuzzy": {
      "fruit":{
        "value":"app",
        "fuzziness":"1",
        "max_expansions": 50,
        "prefix_length": 1,
        "transpositions": true,
        "rewrite": "constant_score"
      }
    }
  }
}</code></pre> 
<p>主要参数如下：</p> 
<ul><li>value —— 查询条件；</li><li>fuzziness —— 莱文斯坦编辑距离；</li><li>max_expansions ——<span style="color:#fe2c24;"> </span><span style="color:#0d0016;">衍生词库</span>最大大小，默认为50；</li><li>prefix_length —— 根据查询条件构建衍生词库时，固定查询条件左侧几个字符不变，默认为0；</li><li>transpositions —— 构建衍生词库时，是否允许字符交换位置（如 ab → ba），默认为true；</li><li>rewrite —— 是否进行es评分，默认进行评分。设为 constant_score 时不进行评分。</li></ul> 
<p></p> 
<h4>2.6.2 查询原理</h4> 
<p>fuzzy查询过程如下所述：</p> 
<ul><li>首先根据设定的莱文斯坦编辑距离值（ <a href="https://en.wikipedia.org/wiki/Levenshtein_distance" rel="nofollow" title="Levenshtein edit distance">Levenshtein edit distance</a>）构造一个查询条件对应的<span style="color:#fe2c24;">衍生词库</span>（<span style="color:#fe2c24;">a set of all possible variations, or expansions</span>）；</li><li>然后拿着词库中的每个衍生词去和倒排索引进行匹配；</li><li>最后返回匹配结果的并集。</li></ul> 
<p>由上可知，构造的衍生词库越大，从es中召回的数据量可能就越多。</p> 
<h4>2.6.3 查询举例</h4> 
<p>首先插入3条数据，然后查询。</p> 
<pre><code class="language-bash">PUT /test_standard_analyzer/_doc/7
{
  "fruit":"apple"
}


PUT /test_standard_analyzer/_doc/8
{
  "fruit":"appl"
}

PUT /test_standard_analyzer/_doc/9
{
  "fruit":"appla"
}</code></pre> 
<h5>2.6.3.1 查询条件为“app”，莱文斯坦编辑距离为2，衍生词库大小为3</h5> 
<p>此时召回了“appl”、“appla”和“apple”，说明该fuzzy查询的衍生词库的元素为“appl”、“appla”和“apple”。</p> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "fuzzy": {
      "fruit":{
        "value":"app",
        "fuzziness":"2",
        "max_expansions": 3
      }
    }
  }
}


# 查询结果
    "hits" : [
      {
        "_index" : "test_standard_analyzer",
        "_type" : "_doc",
        "_id" : "8",
        "_score" : 0.58364576,
        "_source" : {
          "fruit" : "appl"
        }
      },
      {
        "_index" : "test_standard_analyzer",
        "_type" : "_doc",
        "_id" : "7",
        "_score" : 0.29182288,
        "_source" : {
          "fruit" : "apple"
        }
      },
      {
        "_index" : "test_standard_analyzer",
        "_type" : "_doc",
        "_id" : "9",
        "_score" : 0.29182288,
        "_source" : {
          "fruit" : "appla"
        }
      }
    ]</code></pre> 
<h5>2.6.3.2 查询条件为“app”，莱文斯坦编辑距离为2，衍生词库大小为2</h5> 
<p>此时召回了“appl”、“appla”，说明该fuzzy查询的衍生词库的元素为“appl”和“appla”。此时衍生词库中没有“apple”，因此没有召回“apple”。</p> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "fuzzy": {
      "fruit":{
        "value":"app",
        "fuzziness":"2",
        "max_expansions": 2
      }
    }
  }
}

# 查询结果

    "hits" : [
      {
        "_index" : "test_standard_analyzer",
        "_type" : "_doc",
        "_id" : "8",
        "_score" : 0.65388614,
        "_source" : {
          "fruit" : "appl"
        }
      },
      {
        "_index" : "test_standard_analyzer",
        "_type" : "_doc",
        "_id" : "9",
        "_score" : 0.32694307,
        "_source" : {
          "fruit" : "appla"
        }
      }
    ]</code></pre> 
<h5>2.6.3.3 查询条件为“ap”，莱文斯坦编辑距离为3，衍生词库大小为50。</h5> 
<p>此时只召回了“appl”，没有召回“appla”和“apple”，说明该fuzzy查询的衍生词库的元素中有“appl”，但是没有“appla”和“apple”(<span style="color:#fe2c24;">虽然 “ap”与“appla”或“apple”的编辑距离为3</span>)。</p> 
<pre><code class="language-bash">GET test_standard_analyzer/_search
{
  "query": {
    "fuzzy": {
      "fruit":{
        "value":"ap",
        "fuzziness":"3",
        "max_expansions": 50
      }
    }
  }
}


# 查询结果
    "hits" : [
      {
        "_index" : "test_standard_analyzer",
        "_type" : "_doc",
        "_id" : "8",
        "_score" : 0.0,
        "_source" : {
          "fruit" : "appl"
        }
      }
    ]</code></pre> 
<h3>2.7 range</h3> 
<p>range查询用于数值字段的范围查询，主要的查询条件如下：</p> 
<ul><li>gte：大于等于</li><li>gt：大于</li><li>lt：小于</li><li>lte：小于等于</li></ul> 
<p>查询举例：</p> 
<pre><code class="language-bash">GET /test_standard_analyzer/_search
{ 
  "query": {
    "range": { 
      "nums": { 
          "gte":3, 
          "lt":8
      } 
    }
  } 
}</code></pre> 
<h3>2.8 bool</h3> 
<p>bool查询的条件有以下几种：</p> 
<ul><li>must：代表且的关系，指必须要满足该条件</li><li>should：代表或的关系，指符合该条件的就可以被查出来</li><li>must_not：代表非的关系，指不符合该条件的数据才能被查出来</li></ul> 
<pre><code class="language-bash">GET /test_standard_analyzer/_search
{
    "query":{
        "bool":{
             "must":[
               {"term":{"remark":"apple" }},
               { "term":{"adderss":"shanghai"}}
            ],
            "should":{
                "term":{"content":"green"}
            },
             "must_not":{
                "term":{"content":"red"}
            }
        }
    }
}</code></pre> 
<h3>2.9 排序</h3> 
<p>es中可以根据字段进行排序。举例如下：</p> 
<pre><code class="language-java">GET test/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "id": {
        "order": "asc"
      }
    }
  ]
}</code></pre> 
<p>查询结果如下所示：</p> 
<pre><code class="language-java">    "hits" : [
      {
        "_index" : "test_1216",
        "_type" : "_doc",
        "_id" : "4",
        "_score" : null,
        "_source" : {
          "address" : "Jiangsu",
          "name" : "tom",
          "id" : 4
        },
        "sort" : [
          4
        ]
      },
      {
        "_index" : "test_1216",
        "_type" : "_doc",
        "_id" : "5",
        "_score" : null,
        "_source" : {
          "address" : "Jiangsu",
          "name" : "lucy",
          "id" : 5
        },
        "sort" : [
          5
        ]
      },
      {
        "_index" : "test_1216",
        "_type" : "_doc",
        "_id" : "6",
        "_score" : null,
        "_source" : {
          "address" : "Jiangsu",
          "name" : "jack2",
          "id" : 6
        },
        "sort" : [
          6
        ]
      }
    ]</code></pre> 
<p></p> 
<h2>3 ES的其他操作</h2> 
<h3>3.1 删除某条数据</h3> 
<pre><code class="language-bash">DELETE /{index}/_doc/{id}</code></pre> 
<p></p> 
<h2>4 参考文献</h2> 
<p>（1）<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.10/index.html" rel="nofollow" title="ES权威指南：Search API | Elasticsearch Guide [7.10] | Elastic">ES权威指南：Search API | Elasticsearch Guide [7.10] | Elastic</a></p> 
<p>（2）<a href="https://zhuanlan.zhihu.com/p/587374960" rel="nofollow" title="【ES知识】ES基础查询语法一览">【ES知识】ES基础查询语法一览</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fbdfc951ff1234e5f8dee648ca6a7fe9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【加强版】小学数学出题，加减乘除混合运算，支持自定义数字，一键打印</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/68734e859439a05bfcaacef72d600e93/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Chrome】ERR_SSL_PROTOCOL_ERROR问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>