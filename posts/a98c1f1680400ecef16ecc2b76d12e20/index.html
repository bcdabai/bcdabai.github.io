<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 广播发送流程分析 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 广播发送流程分析" />
<meta property="og:description" content="在上一篇文章中Android 广播阻塞、延迟问题分析方法讲了广播阻塞的分析方法，但是分析完这个问题，自己还是有一些疑问：
广播为啥会阻塞呢？发送给接收器就行了，为啥还要等着接收器处理完才处理下一个？由普通的后台广播改为前台广播后，为啥处理的会更快？ 这篇参考文章Android 9.0系统源码_广播（三）广播的发送来学习下广播的分发过程，这样对广播阻塞这个问题会理解更深刻。
首先，复习下广播相关的概念。
一、广播相关概念 广播分类 1、标准广播：异步广播，广播发出后，所有注册了的广播接收器都会同时接收到该广播。打个比方：做地铁过程中的语音播报，当列车员(广播发出者)进行语音播报(发送广播)时，所有乘客(注册接收该广播的程序)都可以同时听到语音，不分先后顺序。
sendBroadcast(); 2、有序广播：同步发送，广播发出后，按照注册了的广播接收器的优先级顺序广播，优先级的范围是-1000~1000，数字越大，优先级越高，最先接收到该广播，接收器的优先级通过android:priority设置，并且先收到广播的可以修改或者抛弃该广播，后面优先级小的接收器就无法收到了。同级别的广播，动态优先于静态；同级别同类型的广播，静态：先扫描的优先于后扫描的，动态：先注册的优先于后注册的。
sendOrderedBroadcast(); 3、粘性广播：粘性广播的机制就是发送广播的时候如果没有找到接收器，就会先保存下来，等有广播接收器注册的时候，再把之前保存的广播发出去。因为从Android 5.0(API 21)开始，因为安全性的问题，官方已经正式废弃了粘性广播。
sendStickyBroadcast(); 广播注册方式 1、动态注册：在Context(即Service或Activity)组件中注册，通过registerReceiver()方法注册，在不使用时取消注册unregisterReceiver()。如果广播发送的时候注册Broadcast的组件没有启动的话，是收不到广播的。
2、 静态注册：在AndroidManifest.xml中注册，并在intent-filter中添加响应的action，并新建一个Broadcast组件类来处理注册广播。如果广播发送的时候Broadcast的组件类进程没有启动的话，会收到广播并启动进程。
具体实现可参考Android的有序广播和无序广播（解决安卓8.0版本之后有序广播的接收问题） 区分了Android8.0前后的实现方式。
前台广播及后台广播 前台广播：在广播发送的时候添加Intent.FLAG_RECEIVER_FOREGROUND flag。
后台广播：在广播发送的时候没有Intent.FLAG_RECEIVER_FOREGROUND flag。
默认情况下，Intent是不带Intent.FLAG_RECEIVER_FOREGROUND 的flag的，所以我们默认使用的都是后台广播。
二、广播发送流程 参考文章写得非常详细，建议大家好好看看，我是看完又按照自己的思路整理了一遍写个笔记，只是大体的逻辑思路，重点是帮助我搞清楚上面对广播的一些疑问。
1、调用ContextImpl的sendBroadcast发送广播 frameworks/base/core/java/android/app/ContextImpl.java
@Override public void sendBroadcast(Intent intent) { warnIfCallingFromSystemProcess(); String resolvedType = intent.resolveTypeIfNeeded(getContentResolver()); try { intent.prepareToLeaveProcess(this); //直接调用AMS的broadcastIntent方法 ActivityManager.getService().broadcastIntent( mMainThread.getApplicationThread(), intent, resolvedType, null, Activity.RESULT_OK, null, null, null, AppOpsManager.OP_NONE, null, false, false, getUserId()); } catch (RemoteException e) { throw e.rethrowFromSystemServer(); } } 2、调用AMS的broadcastIntent方法 frameworks/base/services/core/java/com/android/server/am/ActivityManagerService." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a98c1f1680400ecef16ecc2b76d12e20/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-15T19:38:57+08:00" />
<meta property="article:modified_time" content="2023-08-15T19:38:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 广播发送流程分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>在上一篇文章中<a href="https://blog.csdn.net/kongqwesd12/article/details/132207663?spm=1001.2014.3001.5502">Android 广播阻塞、延迟问题分析方法</a>讲了广播阻塞的分析方法，但是分析完这个问题，自己还是有一些疑问：</p> 
<ul><li>广播为啥会阻塞呢？发送给接收器就行了，为啥还要等着接收器处理完才处理下一个？</li><li>由普通的后台广播改为前台广播后，为啥处理的会更快？</li></ul> 
<p>这篇参考文章<a href="https://blog.csdn.net/abc6368765/article/details/125616114">Android 9.0系统源码_广播（三）广播的发送</a>来学习下广播的分发过程，这样对广播阻塞这个问题会理解更深刻。</p> 
<p>首先，复习下广播相关的概念。</p> 
<h3><a id="_8"></a>一、广播相关概念</h3> 
<h4><a id="_9"></a>广播分类</h4> 
<p><strong>1、标准广播</strong>：异步广播，广播发出后，所有注册了的广播接收器都会同时接收到该广播。打个比方：做地铁过程中的语音播报，当列车员(广播发出者)进行语音播报(发送广播)时，所有乘客(注册接收该广播的程序)都可以同时听到语音，不分先后顺序。</p> 
<pre><code class="prism language-java"><span class="token function">sendBroadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p><strong>2、有序广播</strong>：同步发送，广播发出后，按照注册了的广播接收器的优先级顺序广播，优先级的范围是-1000~1000，数字越大，优先级越高，最先接收到该广播，接收器的优先级通过<code>android:priority</code>设置，并且先收到广播的可以修改或者抛弃该广播，后面优先级小的接收器就无法收到了。同级别的广播，动态优先于静态；同级别同类型的广播，静态：先扫描的优先于后扫描的，动态：先注册的优先于后注册的。</p> 
<pre><code class="prism language-java"><span class="token function">sendOrderedBroadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>3、粘性广播</strong>：粘性广播的机制就是发送广播的时候如果没有找到接收器，就会先保存下来，等有广播接收器注册的时候，再把之前保存的广播发出去。因为从Android 5.0(API 21)开始，因为安全性的问题，官方已经正式废弃了粘性广播。</p> 
<pre><code class="prism language-java"><span class="token function">sendStickyBroadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_28"></a>广播注册方式</h4> 
<p><strong>1、动态注册</strong>：在Context(即Service或Activity)组件中注册，通过<code>registerReceiver()</code>方法注册，在不使用时取消注册<code>unregisterReceiver()</code>。如果广播发送的时候注册Broadcast的组件没有启动的话，是收不到广播的。</p> 
<p><strong>2、 静态注册</strong>：在AndroidManifest.xml中注册，并在<code>intent-filter</code>中添加响应的<code>action</code>，并新建一个Broadcast组件类来处理注册广播。如果广播发送的时候Broadcast的组件类进程没有启动的话，会收到广播并启动进程。</p> 
<p>具体实现可参考<a href="https://www.cnblogs.com/io1024/p/11558401.html" rel="nofollow">Android的有序广播和无序广播（解决安卓8.0版本之后有序广播的接收问题）</a> 区分了Android8.0前后的实现方式。</p> 
<h4><a id="_36"></a>前台广播及后台广播</h4> 
<p>前台广播：在广播发送的时候添加<code>Intent.FLAG_RECEIVER_FOREGROUND</code> flag。<br> 后台广播：在广播发送的时候没有<code>Intent.FLAG_RECEIVER_FOREGROUND</code> flag。</p> 
<p>默认情况下，Intent是不带<code>Intent.FLAG_RECEIVER_FOREGROUND</code> 的flag的，所以我们默认使用的都是后台广播。</p> 
<h3><a id="_43"></a>二、广播发送流程</h3> 
<p>参考文章写得非常详细，建议大家好好看看，我是看完又按照自己的思路整理了一遍写个笔记，只是大体的逻辑思路，重点是帮助我搞清楚上面对广播的一些疑问。</p> 
<h4><a id="1ContextImplsendBroadcast_45"></a>1、调用ContextImpl的sendBroadcast发送广播</h4> 
<blockquote> 
 <p>frameworks/base/core/java/android/app/ContextImpl.java</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendBroadcast</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">warnIfCallingFromSystemProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> resolvedType <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        intent<span class="token punctuation">.</span><span class="token function">prepareToLeaveProcess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//直接调用AMS的broadcastIntent方法</span>
        <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">broadcastIntent</span><span class="token punctuation">(</span>
                mMainThread<span class="token punctuation">.</span><span class="token function">getApplicationThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token constant">RESULT_OK</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">AppOpsManager</span><span class="token punctuation">.</span><span class="token constant">OP_NONE</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2AMSbroadcastIntent_65"></a>2、调用AMS的broadcastIntent方法</h4> 
<blockquote> 
 <p>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token comment">// 发送广播</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">broadcastIntent</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span>
                                 <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> <span class="token class-name">IIntentReceiver</span> resultTo<span class="token punctuation">,</span>
                                 <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> resultData<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> resultExtras<span class="token punctuation">,</span>
                                 <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> requiredPermissions<span class="token punctuation">,</span> <span class="token keyword">int</span> appOp<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> bOptions<span class="token punctuation">,</span>
                                 <span class="token keyword">boolean</span> serialized<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">enforceNotIsolatedCaller</span><span class="token punctuation">(</span><span class="token string">"broadcastIntent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//验证广播的Intent是否合法</span>
        intent <span class="token operator">=</span> <span class="token function">verifyBroadcastLocked</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据caller从缓存mLruProcesses中获取进程对象ProcessRecord</span>
        <span class="token keyword">final</span> <span class="token class-name">ProcessRecord</span> callerApp <span class="token operator">=</span> <span class="token function">getRecordForAppLocked</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> callingPid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
        <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token function">broadcastIntentLocked</span><span class="token punctuation">(</span>callerApp<span class="token punctuation">,</span>
                callerApp <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> callerApp<span class="token punctuation">.</span>info<span class="token punctuation">.</span>packageName <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span>
                requiredPermissions<span class="token punctuation">,</span> appOp<span class="token punctuation">,</span> bOptions<span class="token punctuation">,</span> serialized<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span>
                callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="3AMSbroadcastIntentLocked_95"></a>3、调用AMS的broadcastIntentLocked方法</h4> 
<blockquote> 
 <p>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p> 
</blockquote> 
<p>这个方法非常长，拆开分别来看：</p> 
<h5><a id="31_broadcastIntentLocked_99"></a>3.1 系统广播处理broadcastIntentLocked</h5> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">broadcastIntentLocked</span><span class="token punctuation">(</span><span class="token class-name">ProcessRecord</span> callerApp<span class="token punctuation">,</span>
                                    <span class="token class-name">String</span> callerPackage<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span>
                                    <span class="token class-name">IIntentReceiver</span> resultTo<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> resultData<span class="token punctuation">,</span>
                                    <span class="token class-name">Bundle</span> resultExtras<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> requiredPermissions<span class="token punctuation">,</span> <span class="token keyword">int</span> appOp<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> bOptions<span class="token punctuation">,</span>
                                    <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> callingPid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> callerInstantApp <span class="token operator">=</span> <span class="token function">isInstantApp</span><span class="token punctuation">(</span>callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Instant Apps cannot use FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callerInstantApp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            intent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// By default broadcasts do not go to stopped apps.</span>
        <span class="token comment">// 增加下面flag，默认不发送广播到已经停止的app</span>
        intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_EXCLUDE_STOPPED_PACKAGES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
		<span class="token comment">// If we have not finished booting, don't allow this to launch new processes.</span>
        <span class="token comment">// 如果该进程还没有完成启动，并且不是发送给启动升级的广播，则添只发送给已注册的广播接收者标签</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mProcessesReady <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_RECEIVER_BOOT_UPGRADE</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 只发给注册的receiver</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 获取当前发送广播应用所在用户的userId</span>
        userId <span class="token operator">=</span> mUserController<span class="token punctuation">.</span><span class="token function">handleIncomingUser</span><span class="token punctuation">(</span>callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token constant">ALLOW_NON_FULL</span><span class="token punctuation">,</span> <span class="token string">"broadcast"</span><span class="token punctuation">,</span> callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Make sure that the user who is receiving this broadcast or its parent is running.</span>
        <span class="token comment">// If not, we will just skip it. Make an exception for shutdown broadcasts, upgrade steps.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">!=</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token constant">USER_ALL</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mUserController<span class="token punctuation">.</span><span class="token function">isUserOrItsParentRunning</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>callingUid <span class="token operator">!=</span> <span class="token constant">SYSTEM_UID</span>
                    <span class="token operator">||</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_RECEIVER_BOOT_UPGRADE</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_SHUTDOWN</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">BROADCAST_FAILED_USER_STOPPED</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">final</span> <span class="token class-name">String</span> action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BroadcastOptions</span> brOptions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// 验证是不是受保护的广播（是不是系统广播）</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isProtectedBroadcast<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>           
            isProtectedBroadcast <span class="token operator">=</span> <span class="token class-name">AppGlobals</span><span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isProtectedBroadcast</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">BROADCAST_SUCCESS</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
		<span class="token comment">// 检查是不是系统调用</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isCallerSystem<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span>callingUid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token constant">ROOT_UID</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token constant">SYSTEM_UID</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token constant">PHONE_UID</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token constant">BLUETOOTH_UID</span><span class="token operator">:</span>
            <span class="token keyword">case</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token constant">NFC_UID</span><span class="token operator">:</span>
                isCallerSystem <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                isCallerSystem <span class="token operator">=</span> <span class="token punctuation">(</span>callerApp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> callerApp<span class="token punctuation">.</span>persistent<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
		<span class="token comment">// First line security check before anything else: stop non-system apps from</span>
        <span class="token comment">// sending protected broadcasts.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isCallerSystem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 不是系统发送的广播</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isProtectedBroadcast<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 非系统进程发送受保护广播抛出异常</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">AppWidgetManager</span><span class="token punctuation">.</span><span class="token constant">ACTION_APPWIDGET_CONFIGURE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token class-name">AppWidgetManager</span><span class="token punctuation">.</span><span class="token constant">ACTION_APPWIDGET_UPDATE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果是APPWIDGET的配置和升级的广播</span>
                <span class="token comment">// Special case for compatibility: we don't want apps to send this,</span>
                <span class="token comment">// but historically it has not been protected and apps may be using it</span>
                <span class="token comment">// to poke their own app widget.  So, instead of making it protected,</span>
                <span class="token comment">// just limit it to the caller.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>callerPackage <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// They are good enough to send to an explicit component...  verify</span>
                    <span class="token comment">// it is being sent to the calling app.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>
                            callerPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Limit broadcast to their own package.</span>
                    <span class="token comment">// 限制发送广播给自己包里</span>
                    intent<span class="token punctuation">.</span><span class="token function">setPackage</span><span class="token punctuation">(</span>callerPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
		<span class="token comment">// 下面主要是针对系统广播的处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>action <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_UID_REMOVED</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 移除uid
                <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGE_REMOVED</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 卸载应用
                <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGE_CHANGED</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 应用更改，比如：停用，启动等
                <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_EXTERNAL_APPLICATIONS_UNAVAILABLE</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 外部应用不可用，比如安装到sd卡的应用，卸载了sd卡
                <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_EXTERNAL_APPLICATIONS_AVAILABLE</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 外部应用可用
                <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGES_SUSPENDED</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 暂停应用
                <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGES_UNSUSPENDED</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 应用可用
                    <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_UID_REMOVED</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 移除系统userId（删除一个用户）
                            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_EXTERNAL_APPLICATIONS_UNAVAILABLE</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 外部应用不可用，一般是卸载<span class="token constant">SD</span>卡
                            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_EXTERNAL_APPLICATIONS_AVAILABLE</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 外部应用可用，一般是插入<span class="token constant">SD</span>卡
                            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGE_REMOVED</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 卸载
                        <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGE_CHANGED</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 更新
                            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGES_SUSPENDED</span><span class="token operator">:</span>
                        <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGES_UNSUSPENDED</span><span class="token operator">:</span>
                            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGE_REPLACED</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 升级应用</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGE_ADDED</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 安装应用</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGE_DATA_CLEARED</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 清理应用数据</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_TIMEZONE_CHANGED</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 时区改变
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_TIME_CHANGED</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 时间改变
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_CLEAR_DNS_CACHE</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 清理<span class="token constant">DNS</span>缓存
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token constant">PROXY_CHANGE_ACTION</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 代理改变
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span></span>Camera</span><span class="token punctuation">.</span><span class="token constant">ACTION_NEW_PICTURE</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 新照片
                <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>hardware<span class="token punctuation">.</span></span>Camera</span><span class="token punctuation">.</span><span class="token constant">ACTION_NEW_VIDEO</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span> 新视频
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token operator">:</span>
                <span class="token keyword">case</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>KeyChain</span><span class="token punctuation">.</span><span class="token constant">ACTION_TRUST_STORE_CHANGED</span><span class="token operator">:</span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token string">"com.android.launcher.action.INSTALL_SHORTCUT"</span><span class="token operator">:</span>
                    <span class="token comment">// As of O, we no longer support this broadcasts, even for pre-O apps.</span>
                    <span class="token comment">// Apps should now be using ShortcutManager.pinRequestShortcut().</span>
                    <span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">BROADCAST_SUCCESS</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面这个部分主要干了三件事：</p> 
<ul><li>一些变量值得获取，例如：<code>userId</code>、<code>action</code>等；</li><li>一些特殊情况、异常判断的处理；</li><li>对系统广播的判断和处理。</li></ul> 
<h5><a id="32__266"></a>3.2 粘性广播处理</h5> 
<pre><code class="prism language-java">       <span class="token comment">// Add to the sticky list if requested.</span>
       <span class="token comment">// 判断是否是粘性广播，如果是，AMS就需要保存这个广播，以便后面注册要接收此类型广播的接收者可以获得这个广播</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>sticky<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">// 检查粘性广播是否申请了权限</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span></span>Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">BROADCAST_STICKY</span><span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">)</span>
                   <span class="token operator">!=</span> <span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">PERMISSION_GRANTED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredPermissions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> requiredPermissions<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               <span class="token keyword">return</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">BROADCAST_STICKY_CANT_HAVE_PERMISSION</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token comment">// sticky广播不能指定目标组件</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>
                       <span class="token string">"Sticky broadcasts can't target a specific component"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token comment">// We use userId directly here, since the "all" target is maintained</span>
           <span class="token comment">// as a separate set of sticky broadcasts.</span>
           <span class="token comment">//不是发送给所有用户的广播</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">!=</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token constant">USER_ALL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               <span class="token comment">// But first, if this is not a broadcast to all users, then</span>
               <span class="token comment">// make sure it doesn't conflict with an existing broadcast to</span>
               <span class="token comment">// all users.</span>
               <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ArrayList</span><span class="token punctuation">&lt;</span><span class="token class-name">Intent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> stickies <span class="token operator">=</span> mStickyBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
                       <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token constant">USER_ALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// 检查是否和存在的发给所有用户的粘性广播一样的广播</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>stickies <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                   <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Intent</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> stickies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                       <span class="token keyword">int</span> <span class="token class-name">N</span> <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token keyword">int</span> i<span class="token punctuation">;</span>
                       <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">N</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                           <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">filterEquals</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                                       <span class="token string">"Sticky broadcast "</span> <span class="token operator">+</span> intent <span class="token operator">+</span> <span class="token string">" for user "</span>
                                               <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">" conflicts with existing global broadcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                           <span class="token punctuation">}</span>
                       <span class="token punctuation">}</span>
                   <span class="token punctuation">}</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>

           <span class="token comment">// 首先检查mStickyBroadcasts是否有该用户的粘性广播列表</span>
           <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ArrayList</span><span class="token punctuation">&lt;</span><span class="token class-name">Intent</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> stickies <span class="token operator">=</span> mStickyBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">// 该广播列表中没有该用户的stick广播列表</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>stickies <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               stickies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               mStickyBroadcasts<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> stickies<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token comment">// 获取注册广播的Action对应的粘性广播的Intent列表</span>
           <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Intent</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> stickies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token keyword">if</span> <span class="token punctuation">(</span>list <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果为空</span>
               list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建一个列表</span>
               stickies<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//以action为键保存该列表</span>
           <span class="token punctuation">}</span>
           <span class="token comment">// 获取该action对应粘性广播Intent列表的个数</span>
           <span class="token keyword">final</span> <span class="token keyword">int</span> stickiesCount <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">int</span> i<span class="token punctuation">;</span>
           <span class="token comment">// 检查在粘性广播列表中是否保存了一个与参数Intent一致的广播。如果存在直接替换，否则将参数</span>
           <span class="token comment">// Intent描述的广播添加到粘性广播列表list中</span>
           <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> stickiesCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">filterEquals</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                   <span class="token comment">// This sticky already exists, replace it.</span>
                   list<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">break</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> stickiesCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 如果该列表中不存在该粘性广播的Intent加入进去</span>
               list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
</code></pre> 
<p>上面这部分是对粘性广播的处理过程。把粘性广播放在了<code>list</code>列表中，而<code>list</code>以<code>action</code>为键放置在了<code>stickies</code>中，而<code>stickies</code>又以<code>userId</code>为键放在了<code>mStickyBroadcasts</code>中，因此<code>mStickyBroadcasts</code>保存了设备中所有用户粘性广播的Intent相关信息。</p> 
<h5><a id="33__342"></a>3.3 获取静态和动态注册的接收器</h5> 
<pre><code class="prism language-java">		<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> users<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token constant">USER_ALL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Caller wants broadcast to go to all started users.</span>
            <span class="token comment">// 获取所有已启动用户的列表</span>
            users <span class="token operator">=</span> mUserController<span class="token punctuation">.</span><span class="token function">getStartedUserArrayLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 发送广播给指定用户</span>
            <span class="token comment">// Caller wants broadcast to go to one specific user.</span>
            users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>userId<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

 		<span class="token comment">// Figure out who all will receive this broadcast.</span>
        <span class="token class-name">List</span> receivers <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//静态注册接收者</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastFilter</span><span class="token punctuation">&gt;</span></span> registeredReceivers <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//动态注册接收者</span>
        
        <span class="token comment">// Need to resolve the intent to interested receivers...</span>
        <span class="token comment">// 如果当前的广播Intent没有指定FLAG_RECEIVER_REGISTERED_ONLY标记，也就是允许静态注册   </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 允许静态注册的Intent，需要从PMS中去查询对应的广播接收者</span>
            receivers <span class="token operator">=</span> <span class="token function">collectReceiverComponents</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> users<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 如果参数intent没有指定广播接收者的组件名，说明是发送给所有已注册并且要接收该广播的接收者的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token constant">USER_ALL</span> <span class="token operator">&amp;&amp;</span> callingUid <span class="token operator">==</span> <span class="token constant">SHELL_UID</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Query one target user at a time, excluding shell-restricted users</span>
                <span class="token comment">// 查找所有用户的所有动态注册的广播接收者</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> users<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mUserController<span class="token punctuation">.</span><span class="token function">hasUserRestriction</span><span class="token punctuation">(</span>
                            <span class="token class-name">UserManager</span><span class="token punctuation">.</span><span class="token constant">DISALLOW_DEBUGGING_FEATURES</span><span class="token punctuation">,</span> users<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastFilter</span><span class="token punctuation">&gt;</span></span> registeredReceiversForUser <span class="token operator">=</span>
                            mReceiverResolver<span class="token punctuation">.</span><span class="token function">queryIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span>
                                    resolvedType<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/*defaultOnly*/</span><span class="token punctuation">,</span> users<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>registeredReceivers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        registeredReceivers <span class="token operator">=</span> registeredReceiversForUser<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>registeredReceiversForUser <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        registeredReceivers<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>registeredReceiversForUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 查找当前用户的所有动态注册的广播接收者</span>
                registeredReceivers <span class="token operator">=</span> mReceiverResolver<span class="token punctuation">.</span><span class="token function">queryIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span>
                        resolvedType<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/*defaultOnly*/</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ul><li>上面这段代码主要是获取静态和动态注册的接收器。其中<code>receivers</code> 表示静态注册接收器列表， <code>registeredReceivers</code> 表示动态注册接收器列表；</li><li><code>Intent.FLAG_RECEIVER_REGISTERED_ONLY</code>该<code>flag</code>表示仅支持动态注册，不支持静态注册，如果在<code>manifest</code>中注册是收不到该广播的；</li><li>如果发送广播不加<code>Component</code>信息会遍历获取所有的当前<code>intent</code>的接收者，因此如果定向发给某个应用的话，要把<code>Component</code>信息加上。</li></ul> 
<h5><a id="34__394"></a>3.4 将无序动态注册接收器添加到并发列表中</h5> 
<pre><code class="prism language-java">		<span class="token comment">//是否支持替换之前待发出的广播</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> replacePending <span class="token operator">=</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_RECEIVER_REPLACE_PENDING</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 动态注册的广播接收者个数</span>
        <span class="token keyword">int</span> <span class="token constant">NR</span> <span class="token operator">=</span> registeredReceivers <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> registeredReceivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// 当前发送的是无序广播，且存在动态注册的广播接收者</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ordered <span class="token operator">&amp;&amp;</span> <span class="token constant">NR</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果当前发送的广播是无序的，后续是通过并发的方式发送给对应的动态注册的广播接收者的，不需要等待</span>
            <span class="token comment">// If we are not serializing this broadcast, then send the</span>
            <span class="token comment">// registered receivers separately so they don't wait for the</span>
            <span class="token comment">// components to be launched.</span>
            <span class="token comment">//如果发送方是系统</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isCallerSystem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">checkBroadcastFromSystem</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                        isProtectedBroadcast<span class="token punctuation">,</span> registeredReceivers<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 根据intent查找对应的广播队列，前台或者后台队列</span>
            <span class="token keyword">final</span> <span class="token class-name">BroadcastQueue</span> queue <span class="token operator">=</span> <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建BroadcastRecord对象并将当前所有通过动态注册的广播接收者传进去</span>
            <span class="token class-name">BroadcastRecord</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span>
                    callerPackage<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callerInstantApp<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    requiredPermissions<span class="token punctuation">,</span> appOp<span class="token punctuation">,</span> brOptions<span class="token punctuation">,</span> registeredReceivers<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span>
                    resultCode<span class="token punctuation">,</span> resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 在BroadcastQueue中等待发送广播中搜索是否有相同的BroadcastRecord并且是否替换</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> replaced <span class="token operator">=</span> replacePending <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">replaceParallelBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Note: We assume resultTo is null for non-ordered broadcasts.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>replaced<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果不需要替换则插入到BroadcastQueue中</span>
                <span class="token comment">// 也就是说动态广播接收者都放在了BroadcastQueue的mParallelBroadcasts中</span>
                queue<span class="token punctuation">.</span><span class="token function">enqueueParallelBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//并推动一次广播发送</span>
                queue<span class="token punctuation">.</span><span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            registeredReceivers <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token constant">NR</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ul><li>上面这段代码是，如果发送的是<strong>无序广播</strong>，且存在<strong>动态注册</strong>的广播接收者，就将该广播加入<strong>并行处理队列</strong>，并进行一次广播发送。简单来说就是【动态注册且接受无序广播的广播接收者】是并行操作，广播发送速度会比较快。</li><li><code>Intent.FLAG_RECEIVER_REPLACE_PENDING</code> 该<code>flag</code>表示是否替换待发出的广播，如果flag为1会进行替换, 位置与待发广播一样。</li><li>代码中出现关于队列相关的逻辑后面讲，下面来看下【动态注册接受有序广播的广播接收者】和【静态注册的广播接收者】的广播发送。</li></ul> 
<h5><a id="35__437"></a>3.5 合并有序动态注册和静态注册接收器</h5> 
<pre><code class="prism language-java">		 <span class="token comment">// Merge into one list.</span>
        <span class="token keyword">int</span> ir <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>receivers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 对于ACTION_PACKAGE_ADDED广播而言，如果是自己被add了，那么这个广播只能别人收到，</span>
            <span class="token comment">// 自己即使注册了这个静态广播也接收不到，注释上说是担心有些应用一安装就接收自己的PACKAGE_ADDED</span>
            <span class="token comment">// 广播，然后就启动了。简言之，应用永远接收不到自己的PACKAGE_ADDED广播。</span>
            <span class="token comment">// A special case for PACKAGE_ADDED: do not allow the package</span>
            <span class="token comment">// being added to see this broadcast.  This prevents them from</span>
            <span class="token comment">// using this as a back door to get run as soon as they are</span>
            <span class="token comment">// installed.  Maybe in the future we want to have a special install</span>
            <span class="token comment">// broadcast or such for apps, but we'd like to deliberately make</span>
            <span class="token comment">// this decision.</span>
            <span class="token class-name">String</span> skipPackages<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">// 需要跳过的广播</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGE_ADDED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGE_RESTARTED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_PACKAGE_DATA_CLEARED</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Uri</span> data <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">String</span> pkgName <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getSchemeSpecificPart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkgName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        skipPackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>pkgName<span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">ACTION_EXTERNAL_APPLICATIONS_AVAILABLE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                skipPackages <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getStringArrayExtra</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">EXTRA_CHANGED_PACKAGE_LIST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>skipPackages <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>skipPackages<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> skipPackage <span class="token operator">:</span> skipPackages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>skipPackage <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">int</span> <span class="token constant">NT</span> <span class="token operator">=</span> receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> it <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> it <span class="token operator">&lt;</span> <span class="token constant">NT</span><span class="token punctuation">;</span> it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">ResolveInfo</span> curt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ResolveInfo</span><span class="token punctuation">)</span> receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>curt<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>skipPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                receivers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                it<span class="token operator">--</span><span class="token punctuation">;</span>
                                <span class="token constant">NT</span><span class="token operator">--</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 开始把动态注册的广播接收者列表registeredReceivers和静态注册的广播接收者列表receivers合并成一个列表</span>
            <span class="token keyword">int</span> <span class="token constant">NT</span> <span class="token operator">=</span> receivers <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//静态注册的广播接收者数量</span>
            <span class="token keyword">int</span> it <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name">ResolveInfo</span> curt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//静态注册的广播接收者</span>
            <span class="token class-name">BroadcastFilter</span> curr <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//动态注册的广播接收者</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>it <span class="token operator">&lt;</span> <span class="token constant">NT</span> <span class="token operator">&amp;&amp;</span> ir <span class="token operator">&lt;</span> <span class="token constant">NR</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>curt <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    curt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ResolveInfo</span><span class="token punctuation">)</span> receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取静态广播接收者列表第it个条目</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>curr <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    curr <span class="token operator">=</span> registeredReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取动态广播接收者列表第ir个条目</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>curr<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> curt<span class="token punctuation">.</span>priority<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果动态注册广播接收者的优先级大于等于静态注册的</span>
                    <span class="token comment">// Insert this broadcast record into the final list.</span>
                    <span class="token comment">//把动态注册广播者插入静态注册的广播接收者列表中对应条目的前方</span>
                    receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> curr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ir<span class="token operator">++</span><span class="token punctuation">;</span>
                    curr <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    it<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token constant">NT</span><span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Skip to the next ResolveInfo in the final list.</span>
                    it<span class="token operator">++</span><span class="token punctuation">;</span>
                    curt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将两个列表合并到一个列表中，这样静态注册广播接收者receivers列表就包含了所有的广播接收者(无序广播和有序广播)。</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>ir <span class="token operator">&lt;</span> <span class="token constant">NR</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>receivers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                receivers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            receivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registeredReceivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ir<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isCallerSystem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">checkBroadcastFromSystem</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span>
                    isProtectedBroadcast<span class="token punctuation">,</span> receivers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ul><li>上面这段代码主要是对【动态注册接受有序广播的广播接收者】和【静态注册的广播接收者】进行合并，如果是有序广播，动态接收者和静态的接收者合并到一个队列里面进行处理，也就是说order广播下，所有的接收者（静态和动态）处理方式都是一样的，都是串行处理；</li><li>对于静态注册的接收者而言，始终是和order广播的处理方式是一样的，也就是说静态的接收者只有order模式（串行化接收）；</li><li>在合并过程中，如果一个动态注册的广播接收者和一个静态注册的目标广播接收者的优先级相同，那么动态注册的目标接收者会排在静态注册的目标广播接收者前面，即动态注册的目标广播接收者会优先于静态注册的广播接收者接收到有序广播。</li></ul> 
<h5><a id="36__526"></a>3.6 合并接收器添加到有序处理列表中</h5> 
<pre><code class="prism language-java"> 		<span class="token comment">// 可以看出，是在合并入receiver后统一发送BroadcastQueue.scheduleBroadcastsLocked</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>receivers <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> resultTo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 根据intent查找对应的广播队列</span>
            <span class="token keyword">final</span> <span class="token class-name">BroadcastQueue</span> queue <span class="token operator">=</span> <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建BroadcastRecord对象并将合并过的广播接收者列表receivers传进去</span>
            <span class="token class-name">BroadcastRecord</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> callerApp<span class="token punctuation">,</span>
                    callerPackage<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> callerInstantApp<span class="token punctuation">,</span> resolvedType<span class="token punctuation">,</span>
                    requiredPermissions<span class="token punctuation">,</span> appOp<span class="token punctuation">,</span> brOptions<span class="token punctuation">,</span> receivers<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span>
                    resultData<span class="token punctuation">,</span> resultExtras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_BROADCAST</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG_BROADCAST</span><span class="token punctuation">,</span> <span class="token string">"Enqueueing ordered broadcast "</span> <span class="token operator">+</span> r
                    <span class="token operator">+</span> <span class="token string">": prev had "</span> <span class="token operator">+</span> queue<span class="token punctuation">.</span>mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_BROADCAST</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG_BROADCAST</span><span class="token punctuation">,</span>
                    <span class="token string">"Enqueueing broadcast "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token keyword">final</span> <span class="token class-name">BroadcastRecord</span> oldRecord <span class="token operator">=</span> replacePending <span class="token operator">?</span> queue<span class="token punctuation">.</span><span class="token function">replaceOrderedBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Replaced, fire the result-to receiver.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldRecord<span class="token punctuation">.</span>resultTo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">final</span> <span class="token class-name">BroadcastQueue</span> oldQueue <span class="token operator">=</span> <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span>oldRecord<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        oldQueue<span class="token punctuation">.</span><span class="token function">performReceiveLocked</span><span class="token punctuation">(</span>oldRecord<span class="token punctuation">.</span>callerApp<span class="token punctuation">,</span> oldRecord<span class="token punctuation">.</span>resultTo<span class="token punctuation">,</span>
                                oldRecord<span class="token punctuation">.</span>intent<span class="token punctuation">,</span>
                                <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token constant">RESULT_CANCELED</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                                <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> oldRecord<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Failure ["</span>
                                <span class="token operator">+</span> queue<span class="token punctuation">.</span>mQueueName <span class="token operator">+</span> <span class="token string">"] sending broadcast result of "</span>
                                <span class="token operator">+</span> intent<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//无序广播+有序广播合并之后放在了BroadcastQueue的mOrderedBroadcasts中</span>
                queue<span class="token punctuation">.</span><span class="token function">enqueueOrderedBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//并推动一次广播发送</span>
                queue<span class="token punctuation">.</span><span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// There was nobody interested in the broadcast, but we still want to record</span>
            <span class="token comment">// that it happened.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> intent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// This was an implicit broadcast... let's record it for posterity.</span>
                <span class="token function">addBroadcastStatLocked</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callerPackage<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>上面这段代码是将合并后的接收添加到有序队列中进行处理。</p> 
<p><strong>系统广播处理<code>broadcastIntentLocked</code>函数这部分代码逻辑总结：</strong></p> 
<ul><li>首先是判断是不是系统广播，也就是switch语句中的部分，这部分的广播是系统发出的，根据不同广播做出不同的处理，系统广播我们可以接收但是不能发送，只能由系统发出；</li><li>接着是粘性广播的处理；</li><li>然后是【动态注册且接受无序广播的广播接收者】的处理，把他们放入到BroadcastQueue的mParallelBroadcasts中，并调用scheduleBroadcastsLocked，BroadcastQueue对mParallelBroadcasts列表中条目的最终处理是通过<strong>并行操作</strong>来完成的；</li><li>最后是【动态注册接受有序广播的广播接收者】和【静态注册的广播接收者】的处理，把他们放入到BroadcastQueue的mOrderedBroadcasts中，并调用scheduleBroadcastsLocked，BroadcastQueue对mOrderedBroadcasts列表中条目的最终处理是通过<strong>串行操作</strong>来完成的；</li></ul> 
<h4><a id="4BroadcastQueue_587"></a>4、BroadcastQueue广播处理</h4> 
<h5><a id="41_BroadcastQueue_588"></a>4.1 BroadcastQueue队列定义及入队列方法判断</h5> 
<blockquote> 
 <p>frameworks/base/services/core/java/com/android/server/am/BroadcastQueue.java</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Lists of all active broadcasts that are to be executed immediately
 * (without waiting for another broadcast to finish).  Currently this only
 * contains broadcasts to registered receivers, to avoid spinning up
 * a bunch of processes to execute IntentReceiver components.  Background-
 * and foreground-priority broadcasts are queued separately.
 */</span>
<span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastRecord</span><span class="token punctuation">&gt;</span></span> mParallelBroadcasts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * List of all active broadcasts that are to be executed one at a time.
 * The object at the top of the list is the currently activity broadcasts;
 * those after it are waiting for the top to finish.  As with parallel
 * broadcasts, separate background- and foreground-priority queues are
 * maintained.
 */</span>
<span class="token keyword">final</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BroadcastRecord</span><span class="token punctuation">&gt;</span></span> mOrderedBroadcasts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>在广播队列中定义了两个处理列表，一个是并发处理列表<code>mParallelBroadcasts</code>，一个是有序处理列表<code>mOrderedBroadcasts</code>。</p> 
<pre><code class="prism language-java"><span class="token class-name">BroadcastQueue</span> <span class="token function">broadcastQueueForIntent</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">final</span> <span class="token keyword">boolean</span> isFg <span class="token operator">=</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_RECEIVER_FOREGROUND</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_BROADCAST_BACKGROUND</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG_BROADCAST</span><span class="token punctuation">,</span>
             <span class="token string">"Broadcast intent "</span> <span class="token operator">+</span> intent <span class="token operator">+</span> <span class="token string">" on "</span>
             <span class="token operator">+</span> <span class="token punctuation">(</span>isFg <span class="token operator">?</span> <span class="token string">"foreground"</span> <span class="token operator">:</span> <span class="token string">"background"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" queue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   	<span class="token keyword">return</span> <span class="token punctuation">(</span>isFg<span class="token punctuation">)</span> <span class="token operator">?</span> mFgBroadcastQueue <span class="token operator">:</span> mBgBroadcastQueue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enqueueParallelBroadcastLocked</span><span class="token punctuation">(</span><span class="token class-name">BroadcastRecord</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span>enqueueClockTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enqueueOrderedBroadcastLocked</span><span class="token punctuation">(</span><span class="token class-name">BroadcastRecord</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span>enqueueClockTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre> 
<p>上面的三个方法是上面源码中出现的，<code>broadcastQueueForIntent</code>根据intent是否含有<code>Intent.FLAG_RECEIVER_FOREGROUND</code>来判断是前台广播还是普通后台广播，如果是前台广播返回<strong>前台广播处队列</strong>。如果是普通后台广播返回<strong>后台广播处理队列</strong>。</p> 
<p>获取队列后，将发给【动态注册且接受无序广播的广播接收者】的广播通过<code>enqueueParallelBroadcastLocked</code>函数添加到该队列的并发处理列表中。将发给【动态注册接受有序广播的广播接收者】和【静态注册的广播接收者】的广播通过<code>enqueueOrderedBroadcastLocked</code>函数添加到该队列的有序处理列表中。</p> 
<h5><a id="42_BroadcastQueue_635"></a>4.2 BroadcastQueue队列中广播发送流程</h5> 
<p>从上面的源码分析中看到最后我们都执行了<code>scheduleBroadcastsLocked</code>对广播进行了进一步发送处理，接下来看下这个函数的逻辑。</p> 
<pre><code class="prism language-java"><span class="token comment">// 执行广播发送，所有广播都会从这里走，然后会到processNextBroadcast</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 来调度保存在无序广播调度队列mParallelBroadcasts和有序广播调度队列mOrderedBroadcasts中的广播转发任务的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mBroadcastsScheduled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 虽然这里只发送了发送广播的消息，但是这一步执行完之后就已经标记广播发送了，因此可以看出广播发送和处理</span>
    <span class="token comment">// 是异步的，即广播发送者将一个广播发送给AMS后，不会等待AMS将这个广播转发给广播接收者处理</span>
    mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span><span class="token constant">BROADCAST_INTENT_MSG</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//BroadcastQueue中的消息调度BroadcastHandler </span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">BroadcastHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">BroadcastHandler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span> looper<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token constant">BROADCAST_INTENT_MSG</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始处理下一个广播</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">BROADCAST_TIMEOUT_MSG</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>先判断<code>mBroadcastsScheduled</code>的值，如果true说明消息队列已经存在一个类型为BROADCAST_INTENT_MSG的消息了，直接返回，因为该消息在执行完毕会自动调用下一条消息；</li><li>接下来广播的处理逻辑会走到 <code>processNextBroadcast</code>函数中，下面来看下该函数的逻辑。</li></ul> 
<h5><a id="421_BroadcastQueue_676"></a>4.2.1 BroadcastQueue并发列表广播发送流程</h5> 
<pre><code class="prism language-java"><span class="token comment">//参数fromMsg是用来描述processNextBroadcast是否是被handleMessage触发的</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">processNextBroadcastLocked</span><span class="token punctuation">(</span>fromMsg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 广播发送的核心内容</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcastLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">BroadcastRecord</span> r<span class="token punctuation">;</span>
    mService<span class="token punctuation">.</span><span class="token function">updateCpuStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 否是来自handleMessage的BROADCAST_INTENT_MSG类型消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 前面说到，如果消息队列里面有BROADCAST_INTENT_MSG消息，该标记为true，阻止新的消息加入队列，</span>
        <span class="token comment">// 这里开始处理这个消息的时候，将mBroadcastsScheduled变量设置为false，开始允许新的消息加入。</span>
        mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// First, deliver any non-serialized broadcasts right away.</span>
    <span class="token comment">// 无序广播之间不存在相互等待，这里处理的是保存在无序广播调度队列mParallelBroadcasts中的广播发送任务，</span>
    <span class="token comment">// 即把保存在无序广播调度队列mParallelBroadcasts中的广播发送给它的目标广播接收者处理</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 首先获取保存无序广播调度队列mParallelBroadcasts中的每一个BroadcastRecord对象</span>
        r <span class="token operator">=</span> mParallelBroadcasts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>dispatchTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>dispatchClockTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取BroadcastRecord中的所有广播接收者的数量</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token class-name">N</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">N</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Object</span> target <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>     
            <span class="token comment">// 通过deliverToRegisteredReceiverLocked调用ActivityThread.scheduleRegisteredReceiver处理广播</span>
            <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">BroadcastFilter</span><span class="token punctuation">)</span> target<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">addBroadcastToHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面这段代码逻辑：对<strong>并行处理列表</strong>中的广播调用<code>deliverToRegisteredReceiverLocked</code>将每一个无序广播发送给每一个广播接收者，异步处理广播。注意入参<code>ordered</code>值为<code>false</code>。</p> 
<pre><code class="prism language-java"><span class="token comment">//执行动态注册的广播接收者的发送接受过程</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span><span class="token class-name">BroadcastRecord</span> r<span class="token punctuation">,</span>
                                               <span class="token class-name">BroadcastFilter</span> filter<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// order广播，所有的接收者需要依次以一种同步的方式发送广播，</span>
    <span class="token comment">// 可以看到order广播在BroadcastRecord保存了几个状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// IBinder类型，代表当前的接收者</span>
        r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>receiver<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 当前正在处理的BroadcastFilter，和上面的receiver是对应好的</span>
        r<span class="token punctuation">.</span>curFilter <span class="token operator">=</span> filter<span class="token punctuation">;</span>
        filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>curBroadcast <span class="token operator">=</span> r<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">.</span><span class="token constant">CALL_IN_RECEIVE</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>curApp <span class="token operator">=</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">;</span>
            filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">.</span>curReceiver <span class="token operator">=</span> r<span class="token punctuation">;</span>
            mService<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">.</span>inFullBackup<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Skip delivery if full backup in progress</span>
            <span class="token comment">// If it's an ordered broadcast, we need to continue to the next receiver.</span>
            <span class="token comment">// 如果正在备份或者恢复备份跳过，</span>
            <span class="token comment">// 如果是一个有序广播，则执行下一个广播</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">skipReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果不需要进行权限检查或者通过权限检查，调用performReceiveLocked发送广播</span>
            <span class="token function">performReceiveLocked</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>app<span class="token punctuation">,</span> filter<span class="token punctuation">.</span>receiverList<span class="token punctuation">.</span>receiver<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> r<span class="token punctuation">.</span>initialSticky<span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">.</span><span class="token constant">CALL_DONE_RECEIVE</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在后面【有序广播+动态注册】的处理也会走到这个函数deliverToRegisteredReceiverLocked，因此从这个函数的入参开始加ordered来进行区分，上面这段代码最终会走到<code>performReceiveLocked</code>方法中，继续往下看。</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">performReceiveLocked</span><span class="token punctuation">(</span><span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token class-name">IIntentReceiver</span> receiver<span class="token punctuation">,</span>
                          <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> extras<span class="token punctuation">,</span>
                          <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Send the intent to the receiver asynchronously using one-way binder calls.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 因为是动态注册广播，所以不为空</span>
            <span class="token comment">// If we have an app thread, do the call through that so it is</span>
            <span class="token comment">// correctly ordered with other one-way calls.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 这里scheduleRegisteredReceiver函数是一个Binder调用，注释上面说的很清楚，</span>
                <span class="token comment">// 调用ApplicationThread对象的Binder代理对象的函数来向它发送广播</span>
                app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleRegisteredReceiver</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span>
                        data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">,</span> app<span class="token punctuation">.</span>repProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Failed to call into the process. It's either dying or wedged. Kill it gently.</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    app<span class="token punctuation">.</span><span class="token function">scheduleCrash</span><span class="token punctuation">(</span><span class="token string">"can't deliver broadcast"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Application has died. Receiver doesn't exist.</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemoteException</span><span class="token punctuation">(</span><span class="token string">"app.thread must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 直接调用与它关联的一个InnerReceiver对象的Binder代理对象的成员函数performReceive来向它发送广播</span>
        receiver<span class="token punctuation">.</span><span class="token function">performReceive</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span>
                sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>app不为空，表示进程已经启动，调用<code>ActivityThread.scheduleRegisteredReceiver</code>发送当前广播；</li><li>否则直接调用<code>receiver.performReceive</code>方法发送广播。因为当前分析的是动态注册的广播接收器，所以继续看<code>scheduleRegisteredReceiver</code>这个方法。</li></ul> 
<p><strong>调用ActivityThread的scheduleRegisteredReceiver方法</strong></p> 
<blockquote> 
 <p>/frameworks/base/core/java/android/app/ActivityThread.java</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleRegisteredReceiver</span><span class="token punctuation">(</span><span class="token class-name">IIntentReceiver</span> receiver<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span>
                <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> dataStr<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span>
                <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">,</span> <span class="token keyword">int</span> processState<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
     <span class="token function">updateProcessState</span><span class="token punctuation">(</span>processState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     receiver<span class="token punctuation">.</span><span class="token function">performReceive</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> dataStr<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span>
             sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从上面的代码里看，最后走到了<code>InnerReceiver</code>中的<code>performReceive</code>方法中，继续往下看。</p> 
<p><strong>调用LoadedApk#ReceiverDispatcher#InnerReceiver的performReceive方法</strong></p> 
<blockquote> 
 <p>/frameworks/base/core/java/android/app/LoadedApk.java#ReceiverDispatcher#InnerReceiver</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InnerReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">IIntentReceiver<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span><span class="token punctuation">&gt;</span></span> mDispatcher<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span> mStrongRef<span class="token punctuation">;</span>

    <span class="token class-name">InnerReceiver</span><span class="token punctuation">(</span><span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span> rd<span class="token punctuation">,</span> <span class="token keyword">boolean</span> strong<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mDispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>rd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mStrongRef <span class="token operator">=</span> strong <span class="token operator">?</span> rd <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performReceive</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">,</span>
                               <span class="token class-name">Bundle</span> extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">LoadedApk<span class="token punctuation">.</span>ReceiverDispatcher</span> rd<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            rd <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//获取rd的实例对象</span>
            rd <span class="token operator">=</span> mDispatcher<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">//判断是否为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//存在广播，rd 不为空，调用LoadedApk.ReceiverDispatcher对象的performReceive方法</span>
            rd<span class="token punctuation">.</span><span class="token function">performReceive</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span>
                    ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">IActivityManager</span> mgr <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>extras <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    extras<span class="token punctuation">.</span><span class="token function">setAllowFds</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            	<span class="token comment">//不存在广播，rd为空，调用activityManagerService对象的finishReceiver结束广播的发送接受过程</span>
                mgr<span class="token punctuation">.</span><span class="token function">finishReceiver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>LoadedApk.ReceiverDispatcher对象封装了广播接收者，如果该广播接收者注册了，那么该对象就会存在，这里就会调用LodedApk.ReceiverDispatcher.performReceive，否则就会调用AMS.finishReceiver方法，这里我们先看存在广播的情况。</p> 
<p><strong>调用LodedApk#ReceiverDispatcher的performReceive方法</strong></p> 
<blockquote> 
 <p>/frameworks/base/core/java/android/app/LoadedApk.java#ReceiverDispatcher</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">performReceive</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">,</span>
                                   <span class="token class-name">Bundle</span> extras<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ordered<span class="token punctuation">,</span> <span class="token keyword">boolean</span> sticky<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">Args</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span> ordered<span class="token punctuation">,</span> sticky<span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将args对象post到主线程的消息队列里面，作为一个Runnable调度而不是在handleMessage中处理，</span>
    <span class="token comment">// 因此这里不久后会调用Args.run函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>intent <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mActivityThread<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">getRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegistered <span class="token operator">&amp;&amp;</span> ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">IActivityManager</span> mgr <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            args<span class="token punctuation">.</span><span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<ul><li> <p>首先将参数<code>Intent</code>所描述的一个广播封装成一个<code>Args</code>对象，然后将这个<code>Args</code>对象封装成一个消息对象，然后将这个消息对象发送到应用程序主线程的消息队列中；</p> </li><li> <p>该对象实现了<code>Runnable</code>接口，在if<code>语</code>句中调用<code>post</code>方法，最终会调用<code>Args</code>中的<code>run</code>方法。</p> </li><li> <p>如果是【有序广播+动态注册】会走到<code>sendFinished</code>函数，通知AMS，它前面转发过来的有序广播已经处理完了，这时AMS就可以继续将这个有序广播转发给下一个目标广播接收者了。这也是实现串行的原因，当前的发出了，才会通知进行下一个进行。而并发的是直接循环<code>post</code>然后完事了。</p> </li></ul> 
<p><strong>调用LodedApk#ReceiverDispatcher#Args的getRunnable方法</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver<span class="token punctuation">.</span>PendingResult</span> <span class="token punctuation">{<!-- --></span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Runnable</span> <span class="token function">getRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
             <span class="token comment">// mReceiver指向一个广播接收者</span>
             <span class="token keyword">final</span> <span class="token class-name">BroadcastReceiver</span> receiver <span class="token operator">=</span> mReceiver<span class="token punctuation">;</span>
             <span class="token keyword">final</span> <span class="token keyword">boolean</span> ordered <span class="token operator">=</span> mOrdered<span class="token punctuation">;</span>
             <span class="token keyword">final</span> <span class="token class-name">IActivityManager</span> mgr <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">final</span> <span class="token class-name">Intent</span> intent <span class="token operator">=</span> mCurIntent<span class="token punctuation">;</span>
             mCurIntent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
             mDispatched <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
             mPreviousRunStacktrace <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Throwable</span><span class="token punctuation">(</span><span class="token string">"Previous stacktrace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> intent <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> mForgotten<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegistered <span class="token operator">&amp;&amp;</span> ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                     <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
                 <span class="token keyword">return</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
             <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                 <span class="token comment">// 这里处理的是动态广播接收者，默认认为接收者BroadcastReceiver已经存在</span>
                 <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> mReceiver<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 receiver<span class="token punctuation">.</span><span class="token function">setPendingResult</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token comment">// 接收广播</span>
                 receiver<span class="token punctuation">.</span><span class="token function">onReceive</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> intent<span class="token punctuation">)</span><span class="token punctuation">;</span>                 
             <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                 <span class="token comment">// 检查当前广播是否是有序广播，并且广播接收者是否已经注册到AMS中</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>mRegistered <span class="token operator">&amp;&amp;</span> ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                     <span class="token comment">// 通知AMS，它前面转发过来的有序广播已经处理完了，这时AMS就可以继续将这个有序广播</span>
                     <span class="token comment">// 转发给下一个目标广播接收者了</span>
                     <span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>mInstrumentation <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>mReceiver<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                     <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Error receiving broadcast "</span> <span class="token operator">+</span> intent <span class="token operator">+</span> <span class="token string">" in "</span> <span class="token operator">+</span> mReceiver<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
             <span class="token comment">// 然后调用BroadcastReceiver.PendingResult.finish函数，也就是下面的finish函数</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">getPendingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                 <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
             <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>在run方法中调用<code>BroadcastReceiver.onReceive</code>方法，这样就会执行完一次无序广播的发送过程。从这里也能看出为什么并发队列中的处理是并行的，因为最后是新建了一个<code>Runnable</code>来处里，<code>post</code>到<code>Runnable</code>后就可以执行下一个了，不会堵塞。</p> 
<h5><a id="422_BroadcastQueue_932"></a>4.2.2 BroadcastQueue有序列表广播发送流程</h5> 
<p>4.2.1 讲了BroadcastQueue并发列表广播发送流程，我们把逻辑在移回去，看下有序广播发送流程。 <code>processNextBroadcastLocked</code>这个函数逻辑有点长，拆开来看下。</p> 
<pre><code class="prism language-java"><span class="token comment">//参数fromMsg是用来描述processNextBroadcast是否是被handleMessage触发的</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcast</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">processNextBroadcastLocked</span><span class="token punctuation">(</span>fromMsg<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 广播发送的核心内容</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processNextBroadcastLocked</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">BroadcastRecord</span> r<span class="token punctuation">;</span>
    mService<span class="token punctuation">.</span><span class="token function">updateCpuStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 否是来自handleMessage的BROADCAST_INTENT_MSG类型消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fromMsg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mBroadcastsScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 无序广播的处理流程</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">//开始有序广播的处理流程</span>
    <span class="token comment">// Now take care of the next serialized one...</span>
    <span class="token comment">// If we are waiting for a process to come up to handle the next</span>
    <span class="token comment">// broadcast, then do nothing at this point.  Just in case, we</span>
    <span class="token comment">// check that the process we're waiting for still exists.   </span>
    <span class="token comment">// mPendingBroadcast对象是用来描述一个正在等待静态注册的目标广播接收者启动起来的广播转发任务</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingBroadcast <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 记录目标广播接收者所在进程是否是死亡状态</span>
        <span class="token keyword">boolean</span> isDead<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mPidsSelfLocked<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">ProcessRecord</span> proc <span class="token operator">=</span> mService<span class="token punctuation">.</span>mPidsSelfLocked<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                isDead <span class="token operator">=</span> proc <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> proc<span class="token punctuation">.</span>crashing<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">ProcessRecord</span> proc <span class="token operator">=</span> mService<span class="token punctuation">.</span>mProcessNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
                    mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> mPendingBroadcast<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            isDead <span class="token operator">=</span> proc <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>proc<span class="token punctuation">.</span>pendingStart<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果应用已经启动，会调用AMS的函数来处理静态广播，这里直接return</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDead<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// It's still alive, so keep waiting</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            mPendingBroadcast<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">.</span><span class="token constant">IDLE</span><span class="token punctuation">;</span>
            mPendingBroadcast<span class="token punctuation">.</span>nextReceiver <span class="token operator">=</span> mPendingBroadcastRecvIndex<span class="token punctuation">;</span>
            mPendingBroadcast <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>上面这段代码主要是处理静态注册广播，且注册进程没有启动的广播处理逻辑。<code>mPendingBroadcast</code>对象是用来描述一个正在等待静态注册的目标广播接收者启动起来的广播转发任务。</p> 
<p>从前面可知，有序广播调度队列mOrderedBroadcast列表中的目标广播接收者有可能是静态注册的，而这些静态注册的目标广播接收者可能还没有启动起来，因此AMS将一个广播发送给它们处理时，首先将它们启动起来。</p> 
<p>如果进程已经起来，会调用AMS的函数来处理静态广播，这里直接return。</p> 
<pre><code class="prism language-java">	<span class="token keyword">boolean</span> looped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里的do-while只会从mOrderedBroadcasts中取出第一个BroadcastRecord进行后续的处理！</span>
    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 判断有序广播调度队列mOrderedBroadcasts是否还有需要处理的广播</span>
        <span class="token comment">// 如果长度为0，则说明调度队列mOrderedBroadcasts中的广播已经全部处理完成</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// No more broadcasts pending, so all done!</span>
            mService<span class="token punctuation">.</span><span class="token function">scheduleAppGcsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>looped<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// If we had finished the last ordered broadcast, then</span>
                <span class="token comment">// make sure all processes have correct oom and sched</span>
                <span class="token comment">// adjustments.</span>
                mService<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果没有处理完成，则继续取出mOrderedBroadcasts中的第一个BroadcastRecord</span>
        r <span class="token operator">=</span> mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> forceReceive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// Ensure that even if something goes awry with the timeout</span>
        <span class="token comment">// detection, we catch "hung" broadcasts here, discard them,</span>
        <span class="token comment">// and continue to make progress.</span>
        <span class="token comment">//</span>
        <span class="token comment">// This is only done if the system is ready so that PRE_BOOT_COMPLETED</span>
        <span class="token comment">// receivers don't get executed with timeouts. They're intended for</span>
        <span class="token comment">// one time heavy lifting after system upgrades and can take</span>
        <span class="token comment">// significant amounts of time.</span>
        <span class="token comment">// 获取广播转发任务的目标广播接收者的个数</span>
        <span class="token keyword">int</span> numReceivers <span class="token operator">=</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mService<span class="token punctuation">.</span>mProcessesReady <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numReceivers <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>now <span class="token operator">&gt;</span> r<span class="token punctuation">.</span>dispatchTime <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> mTimeoutPeriod <span class="token operator">*</span> numReceivers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//出现超时，强制结束</span>
                <span class="token function">broadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// forcibly finish this broadcast</span>
                <span class="token comment">// 重置参数，继续处理有序广播调度队列mOrderedBroadcasts的下一个广播转发任务</span>
                forceReceive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                r<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">.</span><span class="token constant">IDLE</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>state <span class="token operator">!=</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">.</span><span class="token constant">IDLE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 检测广播转发任务是否正在处理中，即AMS正在将一个有序广播转发给它的前一个目标广播接收处理者，</span>
        <span class="token comment">// 如果是，AMS就会等待这个目标广播接收者处理完该有序广播，然后再转发给下一个广播接收者处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receivers <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> r<span class="token punctuation">.</span>nextReceiver <span class="token operator">&gt;=</span> numReceivers
                <span class="token operator">||</span> r<span class="token punctuation">.</span>resultAbort <span class="token operator">||</span> forceReceive<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// No more receivers for this broadcast!  Send the final</span>
            <span class="token comment">// result if requested...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>resultTo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">performReceiveLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>callerApp<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultTo<span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span>
                            r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// Set this to null so that the reference</span>
                    <span class="token comment">// (local and remote) isn't kept in the mBroadcastHistory.</span>
                    r<span class="token punctuation">.</span>resultTo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    r<span class="token punctuation">.</span>resultTo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
           <span class="token comment">// 调用函数cancelBroadcastTimeoutLocked来删除前面发送到AMS所运行在的线程的</span>
           <span class="token comment">// 消息队列中的一个BROADCAST_TIMEOUT_MSG消息</span>
            <span class="token function">cancelBroadcastTimeoutLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ... and on to the next...</span>
            <span class="token function">addBroadcastToHistoryLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_RECEIVER_REGISTERED_ONLY</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// This was an implicit broadcast... let's record it for posterity.</span>
                mService<span class="token punctuation">.</span><span class="token function">addBroadcastStatLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>callerPackage<span class="token punctuation">,</span>
                        r<span class="token punctuation">.</span>manifestCount<span class="token punctuation">,</span> r<span class="token punctuation">.</span>manifestSkipCount<span class="token punctuation">,</span> r<span class="token punctuation">.</span>finishTime <span class="token operator">-</span> r<span class="token punctuation">.</span>dispatchTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// BroadcastRecord处理完移除</span>
            mOrderedBroadcasts<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            looped <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 如果第一次取出的r不为空，则退出循环</span>

</code></pre> 
<p>上面这段代码是在处理广播前对一些特殊情况进行处理，例如，处理列表为空，直接返回；当前广播正在处理中返回；下一个接收者为空或者当前接受者设置了<code>resultAbort</code> 等异常情况处理。</p> 
<h5><a id="4221__1074"></a>4.2.2.1 动态接收器的处理</h5> 
<pre><code class="prism language-java">	<span class="token comment">// Get the next receiver...</span>
    <span class="token comment">//获取下一个将要处理的广播接收者在其列表中的位置</span>
    <span class="token keyword">int</span> recIdx <span class="token operator">=</span> r<span class="token punctuation">.</span>nextReceiver<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token comment">// Keep track of when this receiver started, and make sure there</span>
    <span class="token comment">// is a timeout message pending to kill it if need be.</span>
    <span class="token comment">// 保存当前时间</span>
    r<span class="token punctuation">.</span>receiverTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recIdx <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 表示第一个开始处理的接收者，也就是BroadcastRecord对象r所描述的广播任务刚被处理</span>
        <span class="token comment">// 接收者开始处理的时间戳，也就是这个接收者开始处理了，要记录开始时间来计算是否超过超时时间</span>
        <span class="token comment">// 也就是说这是BroadcastRecord中第一个接收者开始被处理的时间戳，也就是上面BroadcastRecord</span>
        <span class="token comment">// 超时的起点，可以看到上面超时比较的时候用的就是r.dispatchTime</span>
        r<span class="token punctuation">.</span>dispatchTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>dispatchClockTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingBroadcastTimeoutMessage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">long</span> timeoutTime <span class="token operator">=</span> r<span class="token punctuation">.</span>receiverTime <span class="token operator">+</span> mTimeoutPeriod<span class="token punctuation">;</span>
        <span class="token comment">// 设置超时，传入参数是r.receiverTime + mTimeoutPeriod，也就是开始时间加上超时时间</span>
        <span class="token comment">// mTimeoutPeriod，mTimeoutPeriod初始化是在BroadcastQueue初始化的时候传入的，</span>
        <span class="token comment">// 也就是在AMS（AMS构造函数中）中初始化mFgBroadcastQueue和mBgBroadcastQueue时传入的</span>
        <span class="token comment">// BROADCAST_FG_TIMEOUT = 10 * 1000和BROADCAST_BG_TIMEOUT = 60 * 1000，</span>
        <span class="token comment">// 这里开始埋了ANR的雷</span>
        <span class="token function">setBroadcastTimeoutLocked</span><span class="token punctuation">(</span>timeoutTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token class-name">BroadcastOptions</span> brOptions <span class="token operator">=</span> r<span class="token punctuation">.</span>options<span class="token punctuation">;</span>
    <span class="token comment">// 得到下一个广播接收者</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span> nextReceiver <span class="token operator">=</span> r<span class="token punctuation">.</span>receivers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>recIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果当前nextReceiver是一个BroadcastFilter类型，说明是一个动态注册接收者，不需要启动一个进程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextReceiver <span class="token keyword">instanceof</span> <span class="token class-name">BroadcastFilter</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Simple case: this is a registered receiver who gets</span>
        <span class="token comment">// a direct call.</span>
        <span class="token class-name">BroadcastFilter</span> filter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BroadcastFilter</span><span class="token punctuation">)</span> nextReceiver<span class="token punctuation">;</span>
        <span class="token comment">// 调用deliverToRegisteredReceiverLocked向所有的receivers发送广播</span>
        <span class="token comment">// 将它所描述的每一个无序广播发送给每一个广播接收者，异步处理广播</span>
        <span class="token comment">// 通过deliverToRegisteredReceiverLocked调用ActivityThread.scheduleRegisteredReceiver处理广播</span>
        <span class="token function">deliverToRegisteredReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> recIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 检查BroadcastRecord对象r所描述的广播转发任务是否用来转发无序广播的。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>receiver <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>ordered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 设置IDLE状态，表示AMS不需要等待它的前一个目标广播接收者处理完成一个广播就可以将该广播</span>
            <span class="token comment">// 继续发送给它的下一个目标广播接收者处理</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">.</span><span class="token constant">IDLE</span><span class="token punctuation">;</span>
            <span class="token comment">// 调用下面函数就是为了将一个广播继续发送给BroadcastRecord对象r所描述的广播转发任务的</span>
            <span class="token comment">// 下一个目标广播接收者处理的</span>
            <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>brOptions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> brOptions<span class="token punctuation">.</span><span class="token function">getTemporaryAppWhitelistDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">scheduleTempWhitelistLocked</span><span class="token punctuation">(</span>filter<span class="token punctuation">.</span>owningUid<span class="token punctuation">,</span>
                        brOptions<span class="token punctuation">.</span><span class="token function">getTemporaryAppWhitelistDuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>上面代码开始对广播进行处理，先进行了计时操作，然后根据接收者不同，先对动态注册接收器进行处理（BroadcastFilter类型）。逻辑最后通过<code>deliverToRegisteredReceiverLocked</code>调用<code>ActivityThread.scheduleRegisteredReceiver</code>处理广播。上面有分析这个函数，此时入参<code>ordered</code>是<code>true</code>，用来执行动态注册的广播接收者的发送接收过程。</p> 
<h5><a id="4222__1132"></a>4.2.2.2 静态接收器的处理</h5> 
<p>接下来看下静态注册器的处理：</p> 
<pre><code class="prism language-java">    <span class="token comment">// Hard case: need to instantiate the receiver, possibly</span>
    <span class="token comment">// starting its application process to host it.</span>
    <span class="token comment">// 如果上面if没有进行拦截，说明不是广播接收者动态注册的，而应该是静态注册的</span>
    <span class="token comment">// 此时进程可能没有启动</span>
    <span class="token class-name">ResolveInfo</span> info <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ResolveInfo</span><span class="token punctuation">)</span> nextReceiver<span class="token punctuation">;</span>
    <span class="token class-name">ComponentName</span> component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>
            info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
            info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 是否跳过该广播接收者不处理</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// This is safe to do even if we are skipping the broadcast, and we need</span>
    <span class="token comment">// this information now to evaluate whether it is going to be allowed to run.</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> receiverUid <span class="token operator">=</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
    <span class="token comment">// If it's a singleton, it needs to be the same app or a special app</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>callingUid <span class="token operator">!=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token constant">SYSTEM_UID</span> <span class="token operator">&amp;&amp;</span> isSingleton
            <span class="token operator">&amp;&amp;</span> mService<span class="token punctuation">.</span><span class="token function">isValidSingletonCall</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>callingUid<span class="token punctuation">,</span> receiverUid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        info<span class="token punctuation">.</span>activityInfo <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getActivityInfoForUser</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 得到ResolveInfo对象info所描述的广播接收者的android:process属性值，</span>
    <span class="token comment">// 即它需要运行在的应用程序进程的名称，并且保存在变量targetProcess中</span>
    <span class="token class-name">String</span> targetProcess <span class="token operator">=</span> info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>processName<span class="token punctuation">;</span>
    <span class="token comment">// 获取当前广播接收者的进程记录，也就是该静态广播接收者是否已经运行</span>
    <span class="token class-name">ProcessRecord</span> app <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">getProcessRecordLocked</span><span class="token punctuation">(</span>targetProcess<span class="token punctuation">,</span>
            info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// Is this receiver's application already running?</span>
    <span class="token comment">// 如果当前进程已经运行，则直接发给该进程，然后返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>app <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>app<span class="token punctuation">.</span>killed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            app<span class="token punctuation">.</span><span class="token function">addPackage</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                    info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>versionCode<span class="token punctuation">,</span> mService<span class="token punctuation">.</span>mProcessStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// app进程存在，通过processCurBroadcastLocked -&gt; ActivityThread.scheduleReceiver -&gt; receiver.onReceive处理当前广播 </span>
            <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> app<span class="token punctuation">,</span> skipOomAdj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// order广播是一种同步处理方式，因此处理完可以直接return</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// If some unexpected exception happened, just skip</span>
            <span class="token comment">// this broadcast.  At this point we are not in the call</span>
            <span class="token comment">// from a client, so throwing an exception out from here</span>
            <span class="token comment">// will crash the entire system instead of just whoever</span>
            <span class="token comment">// sent the broadcast.</span>
            <span class="token function">logBroadcastReceiverDiscardLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                    r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// We need to reset the state if we failed to start the receiver.</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">.</span><span class="token constant">IDLE</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// If a dead object exception was thrown -- fall through to</span>
        <span class="token comment">// restart the application.</span>
    <span class="token punctuation">}</span>

 	<span class="token comment">// 如果app进程不存在，会先创建该进程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curApp <span class="token operator">=</span> mService<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>targetProcess<span class="token punctuation">,</span>
            info<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_FROM_BACKGROUND</span><span class="token punctuation">,</span>
            <span class="token string">"broadcast"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>curComponent<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_RECEIVER_BOOT_UPGRADE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 如果启动失败</span>
        <span class="token function">logBroadcastReceiverDiscardLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 结束广播发送任务</span>
        <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">.</span><span class="token constant">IDLE</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将BroadcastRecord赋值为mPendingBroadcast，等待应用启动完成后处理</span>
    <span class="token comment">// 正在启动接收者进程，将正在启动的BroadcastRecord记录存储到mPendingBroadcast中，同时将当前正在</span>
    <span class="token comment">// 启动的接收者进程在所有接收者中的索引存储到mPendingBroadcastRecvIndex，如果当前广播接收者处理</span>
    <span class="token comment">// 完，需要继续从mPendingBroadcastRecvIndex计算到下一个接收者发送当前广播</span>
    mPendingBroadcast <span class="token operator">=</span> r<span class="token punctuation">;</span>
    mPendingBroadcastRecvIndex <span class="token operator">=</span> recIdx<span class="token punctuation">;</span>
</code></pre> 
<p>上面代码是对静态广播的处理，静态广播又分为两种，静态接收者所在进程是启动状态，静态接收者所在进程是未启动状态。根据所在进程的启动状态分别来进行处理。</p> 
<p>app进程存在，通过processCurBroadcastLocked -&gt; ActivityThread.scheduleReceiver -&gt; receiver.onReceive处理当前广播。</p> 
<p>app进程不存在，会先创建该进程。</p> 
<p><strong>APP存在，调用BroadcastQueue的processCurBroadcastLocked方法处理有序广播</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span><span class="token class-name">BroadcastRecord</span> r<span class="token punctuation">,</span>
                                             <span class="token class-name">ProcessRecord</span> app<span class="token punctuation">,</span> <span class="token keyword">boolean</span> skipOomAdj<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>thread <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RemoteException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>inFullBackup<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">skipReceiverLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将进程的相关信息写入当前BroadcastRecord中相关的接收者</span>
    r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span>curApp <span class="token operator">=</span> app<span class="token punctuation">;</span>
    app<span class="token punctuation">.</span>curReceivers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">forceProcessStateUpTo</span><span class="token punctuation">(</span><span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token constant">PROCESS_STATE_RECEIVER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mService<span class="token punctuation">.</span><span class="token function">updateLruProcessLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skipOomAdj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mService<span class="token punctuation">.</span><span class="token function">updateOomAdjLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Tell the application to launch this receiver.</span>
    r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        mService<span class="token punctuation">.</span><span class="token function">notifyPackageUse</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">NOTIFY_PACKAGE_USE_BROADCAST_RECEIVER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 处理广播，等待接收进程的返回</span>
        app<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">scheduleReceiver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">,</span>
                mService<span class="token punctuation">.</span><span class="token function">compatibilityInfoForPackageLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>curReceiver<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span><span class="token punctuation">,</span>
                r<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ordered<span class="token punctuation">,</span> r<span class="token punctuation">.</span>userId<span class="token punctuation">,</span>
                app<span class="token punctuation">.</span>repProcState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>started<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            r<span class="token punctuation">.</span>receiver <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>curApp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span>curReceivers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>APP存在，调用ApplicationThread的scheduleReceiver方法</strong></p> 
<pre><code class="prism language-java"><span class="token comment">// 处理应用进程中接收到的静态广播消息，实际处理该广播的是ActivityThread.handleReceiver函数</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">scheduleReceiver</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">ActivityInfo</span> info<span class="token punctuation">,</span>
        <span class="token class-name">CompatibilityInfo</span> compatInfo<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> <span class="token class-name">String</span> data<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> extras<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> sync<span class="token punctuation">,</span> <span class="token keyword">int</span> sendingUser<span class="token punctuation">,</span> <span class="token keyword">int</span> processState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">updateProcessState</span><span class="token punctuation">(</span>processState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ReceiverData</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReceiverData</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">,</span> extras<span class="token punctuation">,</span>
            sync<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> mAppThread<span class="token punctuation">.</span><span class="token function">asBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sendingUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span>info <span class="token operator">=</span> info<span class="token punctuation">;</span>
    r<span class="token punctuation">.</span>compatInfo <span class="token operator">=</span> compatInfo<span class="token punctuation">;</span>
    <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">.</span><span class="token constant">RECEIVER</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">case</span> <span class="token constant">RECEIVER</span><span class="token operator">:</span>
            	<span class="token comment">//该消息最终会触发handleReceiver方法</span>
                <span class="token function">handleReceiver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ReceiverData</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>    
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   		
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>APP存在，调用ApplicationThread的handleReceiver方法</strong></p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleReceiver</span><span class="token punctuation">(</span><span class="token class-name">ReceiverData</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// If we are getting ready to gc after going to the background, well</span>
        <span class="token comment">// we are back active so skip it.</span>
        <span class="token function">unscheduleGcIdler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1） 创建BroadcastReceiver对象</span>
        <span class="token comment">// 这里处理的是静态广播接收者，默认认为接收者BroadcastReceiver对象不存在</span>
        <span class="token comment">// 每次接受都会创建一个新的BroadcastReceiver对象</span>
        <span class="token class-name">String</span> component <span class="token operator">=</span> data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">LoadedApk</span> packageInfo <span class="token operator">=</span> <span class="token function">getPackageInfoNoCheck</span><span class="token punctuation">(</span>
                data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> data<span class="token punctuation">.</span>compatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IActivityManager</span> mgr <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Application</span> app<span class="token punctuation">;</span>
        <span class="token class-name">BroadcastReceiver</span> receiver<span class="token punctuation">;</span>
        <span class="token class-name">ContextImpl</span> context<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 首先从AMS传递的intent中获取当前处理该广播的组件名称，然后通过反射创建一个BroadcastReceiver</span>
            <span class="token comment">// 对象，从这里可以看出来，静态广播处理的时候，每次都会创建一个新的BroadcastReceiver对象；</span>

            <span class="token comment">// 创建Application对象，如果进程已经启动，Application对象已经创建</span>
            app <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">makeApplication</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> mInstrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            context <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ContextImpl</span><span class="token punctuation">)</span> app<span class="token punctuation">.</span><span class="token function">getBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>splitName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                context <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ContextImpl</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">createContextForSplit</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>splitName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span> cl <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">prepareToEnterProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            data<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            receiver <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span><span class="token function">getAppFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">instantiateReceiver</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">,</span> data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            data<span class="token punctuation">.</span><span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">"Unable to instantiate receiver "</span> <span class="token operator">+</span> component
                <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2） 执行onReceive函数</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            sCurrentBroadcastIntent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 调用接收者的onReceive方法，这里还调用了setPendingResult方法，详细内容请看BroadcastReceiver.goAsync方法。</span>
            receiver<span class="token punctuation">.</span><span class="token function">setPendingResult</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            receiver<span class="token punctuation">.</span><span class="token function">onReceive</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getReceiverRestrictedContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    data<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            data<span class="token punctuation">.</span><span class="token function">sendFinished</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">"Unable to start receiver "</span> <span class="token operator">+</span> component
                    <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            sCurrentBroadcastIntent<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3） 向AMS发送处理结束消息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">getPendingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            data<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>上面代码主要干了三件事情：</p> 
<ul><li>创建BroadcastReceiver对象；</li><li>执行onReceive函数；</li><li>向AMS发送处理结束消息，通知将当前广播发送给下一个接收者；</li></ul> 
<p><strong>APP未启动，先创建该进程</strong><br> 如果静态广播接收者进程尚未启动，会直接调用AMS的startProcessLocked函数启动该接收者进程，并将当前正在等待进程<br> 启动的BroadcastRecord存储到mPendingBroadcast里面，这个就是静态广播拉起应用的原理。</p> 
<p>在app进程启动之后，会先调用application的<code>attach</code>和<code>onCreate</code>方法，然后才会调用ActivityManagerService的<code>sendPendingBroadcastsLocked</code>方法。</p> 
<pre><code class="prism language-java"><span class="token keyword">boolean</span> <span class="token function">sendPendingBroadcastsLocked</span><span class="token punctuation">(</span><span class="token class-name">ProcessRecord</span> app<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">boolean</span> didSomething <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BroadcastQueue</span> queue <span class="token operator">:</span> mBroadcastQueues<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//调用BroadcastQueue的sendPendingBroadcastsLocked方法</span>
        didSomething <span class="token operator">|=</span> queue<span class="token punctuation">.</span><span class="token function">sendPendingBroadcastsLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> didSomething<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>mBroadcastQueues是包含前台和后台广播队列，这里分别调用前台和后台优先级广播的BroadcastQueue.sendPendingBroadcastsLocked方法。</p> 
<p><strong>调用BroadcastQueue的sendPendingBroadcastsLocked方法</strong></p> 
<pre><code class="prism language-java">    <span class="token comment">// 未启动进程的广播接收者需要先启动进程，最后到达这个函数</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">sendPendingBroadcastsLocked</span><span class="token punctuation">(</span><span class="token class-name">ProcessRecord</span> app<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">boolean</span> didSomething <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// 前面分析mPendingBroadcast用于存储当前正在等待进程启动的BroadcastRecord</span>
        <span class="token keyword">final</span> <span class="token class-name">BroadcastRecord</span> br <span class="token operator">=</span> mPendingBroadcast<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>br <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> br<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> br<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>pid <span class="token operator">==</span> app<span class="token punctuation">.</span>pid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>br<span class="token punctuation">.</span>curApp <span class="token operator">!=</span> app<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"App mismatch when sending pending broadcast to "</span>
                        <span class="token operator">+</span> app<span class="token punctuation">.</span>processName <span class="token operator">+</span> <span class="token string">", intended target is "</span> <span class="token operator">+</span> br<span class="token punctuation">.</span>curApp<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 启动完成设置为null</span>
                mPendingBroadcast <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token comment">// 调用processCurBroadcastLocked方法进行处理</span>
                <span class="token function">processCurBroadcastLocked</span><span class="token punctuation">(</span>br<span class="token punctuation">,</span> app<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                didSomething <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Exception in new application when starting receiver "</span>
                        <span class="token operator">+</span> br<span class="token punctuation">.</span>curComponent<span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">logBroadcastReceiverDiscardLocked</span><span class="token punctuation">(</span>br<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">finishReceiverLocked</span><span class="token punctuation">(</span>br<span class="token punctuation">,</span> br<span class="token punctuation">.</span>resultCode<span class="token punctuation">,</span> br<span class="token punctuation">.</span>resultData<span class="token punctuation">,</span>
                        br<span class="token punctuation">.</span>resultExtras<span class="token punctuation">,</span> br<span class="token punctuation">.</span>resultAbort<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">scheduleBroadcastsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// We need to reset the state if we failed to start the receiver.</span>
                br<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token class-name">BroadcastRecord</span><span class="token punctuation">.</span><span class="token constant">IDLE</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> didSomething<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>这里是找到等待处理的广播并且判断是否为空，以及是否和当前进程的pid相同，也就是不是这个进程的等待广播，如果是就调用<code>processCurBroadcastLocked</code>方法进行处理，后面的处理和上面app已启动的流程一致了。</p> 
<h4><a id="5_1421"></a>5、流程总结</h4> 
<p>上面流程大体流程图：<br> <img src="https://images2.imgbox.com/48/d7/nRMtDtI2_o.png" alt="请添加图片描述"><br> 执行时序图：</p> 
<p><img src="https://images2.imgbox.com/a9/b1/7Yt7Lv6v_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_1428"></a>三、总结</h3> 
<p>看完源码再来看下一开始的问题：<br> 1、广播为啥会阻塞呢？发送给接收器就行了，为啥还要等着接收器处理完才处理下一个？</p> 
<p>从上面的源码分析可知，广播的处理分为<strong>并行和有序</strong>两个队列，出问题的无序广播静态接收器放在了有序处理列表中，而有序处理列表的执行是串行的，只有前面的执行完，才会轮到下一个处理，所以前面的广播如果在onReceive中有耗时操作，后面的广播就会堵塞。</p> 
<p>2、 由普通的后台广播改为前台广播后，为啥处理的会更快？</p> 
<p>在上面源码中有个变量的注释：<code>mTimeoutPeriod</code>。这个变量初始化是在BroadcastQueue初始化的时候传入的，也就是在AMS（AMS构造函数中）中初始化mFgBroadcastQueue和mBgBroadcastQueue时传入的，前台广播的超时时间是10s，后台的超时时间是60s。</p> 
<pre><code class="prism language-java"><span class="token constant">BROADCAST_FG_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span> 
<span class="token constant">BROADCAST_BG_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span>
</code></pre> 
<p>后台广播的设计思想就是当前应用优先，尽可能多让收到广播的应用有充足的时间把事件做完。</p> 
<p>而前台广播的目的是紧急通知，设计上就倾向于当前应用赶快处理完，尽快传给下一个。</p> 
<p>也就是说在设计上前台广播主要用于响应性能较高的场景，因为ANR时间是10s，所以开发设计的时候应该尽可能少用。因为前台广播使用的比较少，所以队列相对空闲，响应速度快。</p> 
<p>3、对照源码分析总结：</p> 
<ul><li>前后台队列都有自己并行和有序广播队列，互相不影响；</li><li>并行队列里是无序广播+动态注册接收者；</li><li>有序队列里是有序广播+动态接收者和静态接收者，静态接收者默认就是有序的；</li><li>有序广播+动态接收者执行优于静态接收者先执行，综合起来就是<strong>广播相同的情况下，动态接收器优于静态接收器</strong>；</li><li>Android版本高的，很多系统广播只支持动态注册，静态注册的话收不到广播，例如：息屏亮屏广播。因为静态注册的话，发广播的时候会把所有注册未启动的app全部拉起来，静态处理器又默认串行处理，增加了广播的处理时间。</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/38c198981db5a71fc1c9379cbec0ec23/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">搭建nacos集群</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/59e9ee8f676f50cedf436d82ebe1fb08/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Pod控制器</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>