<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32MP157 tf-a2.6移植 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32MP157 tf-a2.6移植" />
<meta property="og:description" content="STM32MP157 tf-a2.6移植 1. 初次编译2. 移植2.1 添加自己的板子2.2 修改设备树2.2.1 修改串口Uart2.2.2 修改时钟2.2.3 修改电源2.2.4 修改DDR2.2.5 修改EMMC 3. 编译下载3.1 编译3.2 下载 4. 总结 参考母板是STM32MP157D-DK1开发板，移植开发板为100ASK_STM32MP157_V11。 STM32MP157 tf-a2.6 optee3.16 u-boot2021.10 linux5.15移植STM32MP157启动流程STM32MP157 tf-a2.6移植STM32MP157 optee3.16移植STM32MP157 u-boot2021.10移植STM32MP157 linux5.15移植STM32MP157 buildroot-2022.02.5构建根文件系统 1. 初次编译 解压之前准备好的源码，并打好补丁文件。可以参考README.HOW_TO.txt文件，里面说了怎么解压和打补丁，并且还说了如何编译。
#解压源码 $ tar -xvf tf-a-stm32mp-v2.6-stm32mp1-r1-r0.tar.xz #进入源码目录 $ cd tf-a-stm32mp-v2.6-stm32mp1-r1/ #打补丁 $ for p in `ls -1 ../*.patch`; do patch -p1 &lt; $p; done 解压好源码，我们在源码目录执行以下命令完成编译。DEPLOYDIR=$FIP_DEPLOYDIR_ROOT/arm-trusted-firmware是TF-A编译结果存放的目录，如果不设置就会在上一级产生deploy目录存放编译结果，同级目录下生成的build目录存放编译中间文件。
#设置编译器 $ source ../../../../toolchain/environment-setup-cortexa7t2hf-neon-vfpv4-ostl-linux-gnueabi #设置FIP目录 $ export FIP_DEPLOYDIR_ROOT=$PWD/../../FIP_artifacts #编译 $ make -f $PWD/../Makefile.sdk DEPLOYDIR=$FIP_DEPLOYDIR_ROOT/arm-trusted-firmware -j12 all $ make -f $PWD/." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/a1b4d6d5a41e5235711bce6026c720a7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-28T21:12:21+08:00" />
<meta property="article:modified_time" content="2023-06-28T21:12:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32MP157 tf-a2.6移植</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>STM32MP157 tf-a2.6移植</h4> 
 <ul><li><a href="#1__9" rel="nofollow">1. 初次编译</a></li><li><a href="#2__30" rel="nofollow">2. 移植</a></li><li><ul><li><a href="#21__31" rel="nofollow">2.1 添加自己的板子</a></li><li><a href="#22__60" rel="nofollow">2.2 修改设备树</a></li><li><ul><li><a href="#221_Uart_62" rel="nofollow">2.2.1 修改串口Uart</a></li><li><a href="#222__96" rel="nofollow">2.2.2 修改时钟</a></li><li><a href="#223__107" rel="nofollow">2.2.3 修改电源</a></li><li><a href="#224_DDR_246" rel="nofollow">2.2.4 修改DDR</a></li><li><a href="#225_EMMC_360" rel="nofollow">2.2.5 修改EMMC</a></li></ul> 
  </li></ul> 
  </li><li><a href="#3__378" rel="nofollow">3. 编译下载</a></li><li><ul><li><a href="#31__379" rel="nofollow">3.1 编译</a></li><li><a href="#32__394" rel="nofollow">3.2 下载</a></li></ul> 
  </li><li><a href="#4__404" rel="nofollow">4. 总结</a></li></ul> 
</div> 
<br> 参考母板是STM32MP157D-DK1开发板，移植开发板为100ASK_STM32MP157_V11。 
<p></p> 
<ol><li>STM32MP157 tf-a2.6 optee3.16 u-boot2021.10 linux5.15移植</li><li>STM32MP157启动流程</li><li><strong>STM32MP157 tf-a2.6移植</strong></li><li>STM32MP157 optee3.16移植</li><li>STM32MP157 u-boot2021.10移植</li><li>STM32MP157 linux5.15移植</li><li>STM32MP157 buildroot-2022.02.5构建根文件系统</li></ol> 
<h2><a id="1__9"></a>1. 初次编译</h2> 
<p>解压之前准备好的源码，并打好补丁文件。可以参考<code>README.HOW_TO.txt</code>文件，里面说了怎么解压和打补丁，并且还说了如何编译。</p> 
<pre><code class="prism language-bash"><span class="token comment">#解压源码</span>
$ <span class="token function">tar</span> -xvf tf-a-stm32mp-v2.6-stm32mp1-r1-r0.tar.xz
<span class="token comment">#进入源码目录</span>
$ <span class="token builtin class-name">cd</span> tf-a-stm32mp-v2.6-stm32mp1-r1/
<span class="token comment">#打补丁</span>
$ <span class="token keyword">for</span> <span class="token for-or-select variable">p</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> -1 <span class="token punctuation">..</span>/*.patch<span class="token variable">`</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> patch -p1 <span class="token operator">&lt;</span> <span class="token variable">$p</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> 
<p>解压好源码，我们在源码目录执行以下命令完成编译。<code>DEPLOYDIR=$FIP_DEPLOYDIR_ROOT/arm-trusted-firmware</code>是TF-A编译结果存放的目录，如果不设置就会在上一级产生<em>deploy</em>目录存放编译结果，同级目录下生成的<em>build</em>目录存放编译中间文件。</p> 
<pre><code class="prism language-bash"><span class="token comment">#设置编译器</span>
$ <span class="token builtin class-name">source</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/toolchain/environment-setup-cortexa7t2hf-neon-vfpv4-ostl-linux-gnueabi
<span class="token comment">#设置FIP目录</span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">FIP_DEPLOYDIR_ROOT</span><span class="token operator">=</span><span class="token environment constant">$PWD</span>/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/FIP_artifacts
<span class="token comment">#编译</span>
$ <span class="token function">make</span> -f <span class="token environment constant">$PWD</span>/<span class="token punctuation">..</span>/Makefile.sdk <span class="token assign-left variable">DEPLOYDIR</span><span class="token operator">=</span><span class="token variable">$FIP_DEPLOYDIR_ROOT</span>/arm-trusted-firmware -j12 all
$ <span class="token function">make</span> -f <span class="token environment constant">$PWD</span>/<span class="token punctuation">..</span>/Makefile.sdk -j12 all
</code></pre> 
<p>由于官方源码支持很多开发板，我们只留参考母板STM32MP157D-DK1，删除其他开发板。修改<code>Makefile.sdk</code>文件，让其只编译STM32MP157D-DK1。只需删除TF_A_DEVICETREE_<em>xxxx</em>变量中非stm32mp157d-dk1的开发板即可，然后删除<code>FIP_artifacts/arm-trusted-firmware</code>目录下的所有文件从新编译。</p> 
<h2><a id="2__30"></a>2. 移植</h2> 
<h3><a id="21__31"></a>2.1 添加自己的板子</h3> 
<p>进入<code>fdts</code>拷贝<code>stm32mp157d-dk1.dts</code>和<code>stm32mp157d-dk1-fw-config.dts</code>为<code>stm32mp157d-100ask.dts</code>和<code>stm32mp157d-100ask-fw-config.dts</code>，拷贝<code>stm32mp15xx-dkx.dtsi</code>为<code>stm32mp15xx-100ask.dtsi</code>，拷贝<code>stm32mp15-ddr3-2x4Gb-1066-binG.dtsi</code>为<code>stm32mp15-ddr3-2x2Gb-1066-binG.dtsi</code>，完成移植所有的文件创建。</p> 
<pre><code class="prism language-bash">$ <span class="token builtin class-name">cd</span> fdts
$ <span class="token function">cp</span> stm32mp157d-dk1.dts stm32mp157d-100ask.dts
$ <span class="token function">cp</span> stm32mp157d-dk1-fw-config.dts stm32mp157d-100ask-fw-config.dts
$ <span class="token function">cp</span> stm32mp15xx-dkx.dtsi stm32mp15xx-100ask.dtsi
$ <span class="token function">cp</span> stm32mp15-ddr3-2x4Gb-1066-binG.dtsi stm32mp15-ddr3-2x2Gb-1066-binG.dtsi
</code></pre> 
<p>做简单的修改然后进行编译，修改<code>stm32mp157d-100ask.dts</code>文件</p> 
<pre><code class="prism language-c"><span class="token number">13</span> #include <span class="token string">"stm32mp15xx-dkx.dtsi"</span>
<span class="token comment">//改为</span>
<span class="token number">13</span> #include <span class="token string">"stm32mp15xx-100ask.dtsi"</span>

<span class="token number">17</span> model <span class="token operator">=</span> <span class="token string">"STMicroelectronics STM32MP157D-DK1 Discovery Board"</span><span class="token punctuation">;</span>
<span class="token number">18</span> compatible <span class="token operator">=</span> <span class="token string">"st,stm32mp157d-dk1"</span><span class="token punctuation">,</span> <span class="token string">"st,stm32mp157"</span><span class="token punctuation">;</span>
<span class="token comment">//改为</span>
<span class="token number">17</span> model <span class="token operator">=</span> <span class="token string">"STMicroelectronics STM32MP157D-100ASK Discovery Board"</span><span class="token punctuation">;</span>
<span class="token number">18</span> compatible <span class="token operator">=</span> <span class="token string">"st,stm32mp157d-100ask"</span><span class="token punctuation">,</span> <span class="token string">"st,stm32mp157"</span><span class="token punctuation">;</span>
</code></pre> 
<p>修改<code>stm32mp15xx-100ask.dtsi</code>文件</p> 
<pre><code class="prism language-c"><span class="token number">9</span> #include <span class="token string">"stm32mp15-ddr3-1x4Gb-1066-binG.dtsi"</span>
<span class="token comment">//改为</span>
<span class="token number">9</span> #include <span class="token string">"stm32mp15-ddr3-2x2Gb-1066-binG.dtsi"</span>
</code></pre> 
<p>在<code>Makefile.sdk</code>文件中添加自己的板子，在<code>TF_A_DEVICETREE_optee</code>、<code>TF_A_DEVICETREE_trusted</code>、<code>TF_A_DEVICETREE_emmc</code>、<code>TF_A_DEVICETREE_sdcard</code>、<code>TF_A_DEVICETREE_uart</code>和<code>TF_A_DEVICETREE_usb</code>中添加自己的板子<code>stm32mp157d-100ask</code>，然后编译。下面是因为uboot没有我们的板子，要生成FIP找不到文件，FIP已经生成了我们板子的文件。<br> <img src="https://images2.imgbox.com/36/4e/7I9PgYLC_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22__60"></a>2.2 修改设备树</h3> 
<p>移植过程设备树也不是一次性就修改好的，是需要反复修改运行解决问题。特别是TF-A的移植，因为TF-A的SP-MIN是要和U-Boot打包在一起的，需要U-Boot的移植。但是这里我们就一次性对设备树进行修改，无法重现移植过程。</p> 
<h4><a id="221_Uart_62"></a>2.2.1 修改串口Uart</h4> 
<p>100ASK_STM32MP157_V11开发板的串口和参考母板的串口都使用的是uart4，但是用的引脚不同。在<code>stm32mp157d-100ask.dts</code>文件中引用<code>pinctrl</code>节点，在其下追加<code>uart4_pins_d</code>整个节点。</p> 
<pre><code class="prism language-c"><span class="token comment">//在stm32mp157d-100ask.dts文件最后追加如下代码</span>
<span class="token operator">&amp;</span>pinctrl <span class="token punctuation">{<!-- --></span>
	uart4_pins_d<span class="token operator">:</span> uart4<span class="token operator">-</span><span class="token number">3</span> <span class="token punctuation">{<!-- --></span>
		pins1 <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token function">STM32_PINMUX</span><span class="token punctuation">(</span><span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> AF6<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token comment">/* UART4_RX */</span>
			bias<span class="token operator">-</span>disable<span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		pins2 <span class="token punctuation">{<!-- --></span>
			pinmux <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token function">STM32_PINMUX</span><span class="token punctuation">(</span><span class="token char">'A'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> AF6<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> <span class="token comment">/* UART4_TX */</span>
			bias<span class="token operator">-</span>disable<span class="token punctuation">;</span>
			drive<span class="token operator">-</span>push<span class="token operator">-</span>pull<span class="token punctuation">;</span>
			slew<span class="token operator">-</span>rate <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>修改uart4对引脚的配置，把<code>uart4_pins_a</code>改为<code>uart4_pins_d</code>。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp15xx-100ask.dtsi文件</span>
<span class="token operator">&amp;</span>uart4 <span class="token punctuation">{<!-- --></span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>uart4_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//改为</span>
<span class="token operator">&amp;</span>uart4 <span class="token punctuation">{<!-- --></span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>uart4_pins_d<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="222__96"></a>2.2.2 修改时钟</h4> 
<p>由于我们参考的官方母板采用的是有源晶振，100ASK_STM32MP157_V11开发板采用了无源晶振。上图是官方晶振原理图，下图为100ASK_STM32MP157_V11开发板原理图。<br> <img src="https://images2.imgbox.com/16/3c/MaJG82yV_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/c7/8c/l59vVZdm_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token comment">//删除stm32mp15xx-100ask.dtsi文件如下代码</span>
<span class="token operator">&amp;</span>clk_hse <span class="token punctuation">{<!-- --></span>
	st<span class="token punctuation">,</span>digbypass<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="223__107"></a>2.2.3 修改电源</h4> 
<p>由于我们参考的官方母板使用了STPMIC1电源管理芯片，但是100ASK_STM32MP157_V11开发板没有使用电源管理芯片，使用的是固定电源。我们需要删除STPMIC1相关的东西，然后添加一些固定电源域完善设备树。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改stm32mp15xx-100ask.dtsi文件</span>

<span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
	memory@c0000000 <span class="token punctuation">{<!-- --></span>
		device_type <span class="token operator">=</span> <span class="token string">"memory"</span><span class="token punctuation">;</span>
		reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0xc0000000</span> <span class="token number">0x20000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	vin<span class="token operator">:</span> vin <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"regulator-fixed"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>name <span class="token operator">=</span> <span class="token string">"vin"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>min<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">5000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>max<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">5000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>always<span class="token operator">-</span>on<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">//此处添加以下这些固定电源域</span>
	vddcore<span class="token operator">:</span> regulator<span class="token operator">-</span>vddcore <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"regulator-fixed"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>name <span class="token operator">=</span> <span class="token string">"vddcore"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>min<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1200000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>max<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1350000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>off<span class="token operator">-</span>in<span class="token operator">-</span>suspend<span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>always<span class="token operator">-</span>on<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	vdd<span class="token operator">:</span> regulator<span class="token operator">-</span>vdd <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"regulator-fixed"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>name <span class="token operator">=</span> <span class="token string">"vdd"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>min<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3300000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>max<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3300000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>off<span class="token operator">-</span>in<span class="token operator">-</span>suspend<span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>always<span class="token operator">-</span>on<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
	
	v3v3<span class="token operator">:</span> regulator<span class="token operator">-</span>v3v3 <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"regulator-fixed"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>name <span class="token operator">=</span> <span class="token string">"v3v3"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>min<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3300000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>max<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3300000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>off<span class="token operator">-</span>in<span class="token operator">-</span>suspend<span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>always<span class="token operator">-</span>on<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
		
	vdd_usb<span class="token operator">:</span> regulator<span class="token operator">-</span>vdd<span class="token operator">-</span>usb <span class="token punctuation">{<!-- --></span>
		compatible <span class="token operator">=</span> <span class="token string">"regulator-fixed"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>name <span class="token operator">=</span> <span class="token string">"vdd_usb"</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>min<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3300000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>max<span class="token operator">-</span>microvolt <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">3300000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>off<span class="token operator">-</span>in<span class="token operator">-</span>suspend<span class="token punctuation">;</span>
		regulator<span class="token operator">-</span>always<span class="token operator">-</span>on<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>i2c4 <span class="token punctuation">{<!-- --></span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>i2c4_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	i2c<span class="token operator">-</span>scl<span class="token operator">-</span>rising<span class="token operator">-</span>time<span class="token operator">-</span>ns <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">185</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	i2c<span class="token operator">-</span>scl<span class="token operator">-</span>falling<span class="token operator">-</span>time<span class="token operator">-</span>ns <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">20</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	clock<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">400000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
	status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token comment">/* 删除这部分注释代码
	pmic: stpmic@33 {
		compatible = "st,stpmic1";
		reg = &lt;0x33&gt;;
		interrupts-extended = &lt;&amp;exti_pwr 55 IRQ_TYPE_EDGE_FALLING&gt;;
		interrupt-controller;
		#interrupt-cells = &lt;2&gt;;
		status = "okay";

		regulators {
			// 此处代码已省略
		};
	};
*/</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* 删除以下这些节点
&amp;v1v2_hdmi {
	// 此处代码已省略
};

&amp;v1v8_audio {
	// 此处代码已省略
};

&amp;v3v3 {
	// 此处代码已省略
};

&amp;v3v3_hdmi {
	// 此处代码已省略
};

&amp;vdd {
	// 此处代码已省略
};

&amp;vdda {
	// 此处代码已省略
};

&amp;vddcore {
	// 此处代码已省略
};

&amp;vdd_ddr {
	// 此处代码已省略
};

&amp;vdd_usb {
	// 此处代码已省略
};

&amp;vref_ddr {
	// 此处代码已省略
};

&amp;vtt_ddr {
	// 此处代码已省略
};
*/</span>
</code></pre> 
<p>修改完电源，ST官方比较推荐使用自家的的电源管理芯片，并没有考虑到我们这种用法。他提供的源码固定电源域的个数是2，我们加上原来vin是五个固定电源域，所以需要修改源码。</p> 
<pre><code class="prism language-c"><span class="token comment">//修改plat/st/stm32mp1/stm32mp1_def.h</span>

<span class="token number">650</span> <span class="token comment">/* 2 FIXED */</span>
<span class="token number">651</span> #define PLAT_NB_FIXED_REGS		<span class="token function">U</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">//改为</span>
<span class="token number">650</span> <span class="token comment">/* 2 FIXED */</span>
<span class="token number">651</span> #define PLAT_NB_FIXED_REGS		<span class="token function">U</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="224_DDR_246"></a>2.2.4 修改DDR</h4> 
<p>内存的修改使用STM32CubeMX生成的设备树，打开STM32CubeMX，新建一个STM32MP157A-DK1开发板的一个工程，点击<strong>System view</strong>找到DDR单击，目标板是两个16位组成32位所以选择位宽32bits，选择大小4Gb，点击<strong>Project Manager</strong>选择项目存储位置，然后生成代码。复制生成代码到stm32mp15-ddr3-2x2Gb-1066-binG.dtsi中，注意最后一行包含一个头文件。这里直接附上修改好的代码。</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * Copyright (C) 2015-2018, STMicroelectronics - All Rights Reserved
 *
 * SPDX-License-Identifier:	GPL-2.0+	BSD-3-Clause
 *
 */</span>

<span class="token comment">/*
 * File generated by STMicroelectronics STM32CubeMX DDR Tool for MPUs
 * DDR type: DDR3 / DDR3L
 * DDR width: 32bits
 * DDR density: 4Gb
 * System frequency: 533000kHz
 * Relaxed Timing Mode: false
 * Address mapping type: RBC
 *
 * Save Date: 2022.08.28, save Time: 00:42:46
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MEM_NAME</span>	<span class="token string">"DDR3-DDR3L 32bits 533000kHz"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MEM_SPEED</span>	<span class="token expression"><span class="token number">533000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MEM_SIZE</span>	<span class="token expression"><span class="token number">0x20000000</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MSTR</span> <span class="token expression"><span class="token number">0x00040401</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MRCTRL0</span> <span class="token expression"><span class="token number">0x00000010</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MRCTRL1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DERATEEN</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DERATEINT</span> <span class="token expression"><span class="token number">0x00800000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PWRCTL</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PWRTMG</span> <span class="token expression"><span class="token number">0x00400010</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_HWLPCTL</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_RFSHCTL0</span> <span class="token expression"><span class="token number">0x00210000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_RFSHCTL3</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_RFSHTMG</span> <span class="token expression"><span class="token number">0x0081008B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_CRCPARCTL0</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG0</span> <span class="token expression"><span class="token number">0x121B2414</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG1</span> <span class="token expression"><span class="token number">0x000A041C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG2</span> <span class="token expression"><span class="token number">0x0608090F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG3</span> <span class="token expression"><span class="token number">0x0050400C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG4</span> <span class="token expression"><span class="token number">0x08040608</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG5</span> <span class="token expression"><span class="token number">0x06060403</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG6</span> <span class="token expression"><span class="token number">0x02020002</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG7</span> <span class="token expression"><span class="token number">0x00000202</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG8</span> <span class="token expression"><span class="token number">0x00001005</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DRAMTMG14</span> <span class="token expression"><span class="token number">0x000000A0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ZQCTL0</span> <span class="token expression"><span class="token number">0xC2000040</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFITMG0</span> <span class="token expression"><span class="token number">0x02060105</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFITMG1</span> <span class="token expression"><span class="token number">0x00000202</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFILPCFG0</span> <span class="token expression"><span class="token number">0x07000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFIUPD0</span> <span class="token expression"><span class="token number">0xC0400003</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFIUPD1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFIUPD2</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DFIPHYMSTR</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ODTCFG</span> <span class="token expression"><span class="token number">0x06000600</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ODTMAP</span> <span class="token expression"><span class="token number">0x00000001</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_SCHED</span> <span class="token expression"><span class="token number">0x00000C01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_SCHED1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PERFHPR1</span> <span class="token expression"><span class="token number">0x01000001</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PERFLPR1</span> <span class="token expression"><span class="token number">0x08000200</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PERFWR1</span> <span class="token expression"><span class="token number">0x08000400</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DBG0</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DBG1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DBGCMD</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_POISONCFG</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCCFG</span> <span class="token expression"><span class="token number">0x00000010</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGR_0</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGW_0</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGQOS0_0</span> <span class="token expression"><span class="token number">0x02100C03</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGQOS1_0</span> <span class="token expression"><span class="token number">0x00800100</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGWQOS0_0</span> <span class="token expression"><span class="token number">0x01100C03</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGWQOS1_0</span> <span class="token expression"><span class="token number">0x01000200</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGR_1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGW_1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGQOS0_1</span> <span class="token expression"><span class="token number">0x02100C03</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGQOS1_1</span> <span class="token expression"><span class="token number">0x00800040</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGWQOS0_1</span> <span class="token expression"><span class="token number">0x01100C03</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PCFGWQOS1_1</span> <span class="token expression"><span class="token number">0x01000200</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP1</span> <span class="token expression"><span class="token number">0x00080808</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP2</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP3</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP4</span> <span class="token expression"><span class="token number">0x00001F1F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP5</span> <span class="token expression"><span class="token number">0x07070707</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP6</span> <span class="token expression"><span class="token number">0x0F0F0707</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP9</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP10</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ADDRMAP11</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PGCR</span> <span class="token expression"><span class="token number">0x01442E02</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PTR0</span> <span class="token expression"><span class="token number">0x0022AA5B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PTR1</span> <span class="token expression"><span class="token number">0x04841104</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_PTR2</span> <span class="token expression"><span class="token number">0x042DA068</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ACIOCR</span> <span class="token expression"><span class="token number">0x10400812</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DXCCR</span> <span class="token expression"><span class="token number">0x00000C40</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DSGCR</span> <span class="token expression"><span class="token number">0xF200011F</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DCR</span> <span class="token expression"><span class="token number">0x0000000B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DTPR0</span> <span class="token expression"><span class="token number">0x38D488D0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DTPR1</span> <span class="token expression"><span class="token number">0x098B00D8</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DTPR2</span> <span class="token expression"><span class="token number">0x10023600</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MR0</span> <span class="token expression"><span class="token number">0x00000840</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MR1</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MR2</span> <span class="token expression"><span class="token number">0x00000208</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_MR3</span> <span class="token expression"><span class="token number">0x00000000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ODTCR</span> <span class="token expression"><span class="token number">0x00010000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_ZQ0CR1</span> <span class="token expression"><span class="token number">0x00000038</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DX0GCR</span> <span class="token expression"><span class="token number">0x0000CE81</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DX1GCR</span> <span class="token expression"><span class="token number">0x0000CE81</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DX2GCR</span> <span class="token expression"><span class="token number">0x0000CE81</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DDR_DX3GCR</span> <span class="token expression"><span class="token number">0x0000CE81</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32mp15-ddr.dtsi"</span></span>
</code></pre> 
<h4><a id="225_EMMC_360"></a>2.2.5 修改EMMC</h4> 
<p>100ASK_STM32MP157_V11开发板设计有EMMC，dk1开发板只有SD card，需要添加EMMC设备。</p> 
<pre><code class="prism language-c"><span class="token comment">//在stm32mp15xx-100ask.dtsi文件中添加如下代码</span>
<span class="token operator">&amp;</span>sdmmc2 <span class="token punctuation">{<!-- --></span>
        pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
        pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>sdmmc2_b4_pins_a <span class="token operator">&amp;</span>sdmmc2_d47_pins_a<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        non<span class="token operator">-</span>removable<span class="token punctuation">;</span>
        no<span class="token operator">-</span>sd<span class="token punctuation">;</span>
        no<span class="token operator">-</span>sdio<span class="token punctuation">;</span>
        st<span class="token punctuation">,</span>neg<span class="token operator">-</span>edge<span class="token punctuation">;</span>
        bus<span class="token operator">-</span>width <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">8</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        vmmc<span class="token operator">-</span>supply <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>v3v3<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        vqmmc<span class="token operator">-</span>supply <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>v3v3<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        mmc<span class="token operator">-</span>ddr<span class="token operator">-</span><span class="token number">3</span>_3v<span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="3__378"></a>3. 编译下载</h2> 
<h3><a id="31__379"></a>3.1 编译</h3> 
<p>由于TF-A的SP-MIN是被TF-A的BL2加载并运行的，STM32MP157使用了FIP将BL32(SP-MIN)和BL33(U-Boot)打包在一起，我们需要复制一份U-Boot改成自己的开发板。</p> 
<pre><code class="prism language-bash"><span class="token comment">#进入FIP目录下的u-boot目录</span>
$ <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/FIP_artifacts/u-boot/
<span class="token comment">#复制U-boot</span>
$ <span class="token function">cp</span> u-boot-stm32mp157d-dk1-trusted.dtb u-boot-stm32mp157d-100ask-trusted.dtb
<span class="token comment">#返回TF-A源码目录</span>
$ <span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/tf-a-stm32mp-v2.6-stm32mp1-r1-r0/tf-a-stm32mp-v2.6-stm32mp1-r1/
<span class="token comment">#编译</span>
$ <span class="token function">make</span> -f <span class="token environment constant">$PWD</span>/<span class="token punctuation">..</span>/Makefile.sdk <span class="token assign-left variable">DEPLOYDIR</span><span class="token operator">=</span><span class="token variable">$FIP_DEPLOYDIR_ROOT</span>/arm-trusted-firmware -j12 all
</code></pre> 
<p>可以看到optee还是原来的错误，但是tfa已经没有错误了，在<code>FIP_artifacts/fip</code>目录中生成了<code>fip-stm32mp157d-100ask-trusted.bin</code>。<br> <img src="https://images2.imgbox.com/54/0a/DodnhtSs_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32__394"></a>3.2 下载</h3> 
<p>参考<code>stm32mp1-openstlinux-5.15-yocto-kirkstone-mp1-v22.06.15/images/stm32mp1/flashlayout_st-image-weston</code>目录中的烧录脚本，我们串行启动TF-A进行调试。在<code>FIP_artifacts</code>目录中新建一个<code>FlashLayout</code>存放烧写脚本，烧写的时候可以复制整个<code>FIP_artifacts</code>到主机，也可以共享文件夹。新建<code>FlashLayout_emmc_stm32mp157d-100ask-trusted.tsv</code>脚本，注意烧写脚本的分割符只能用<strong>Tab</strong>符号，脚本的规则可以去官网<a href="https://wiki.stmicroelectronics.cn/stm32mpu/wiki/STM32CubeProgrammer_flashlayout" rel="nofollow">WiKi</a>详细了解。</p> 
<pre><code class="prism language-bash"><span class="token comment">#Opt	Id		Name		Type		IP		Offset		Binary</span>
-		0x01	fsbl-boot	Binary		none	0x0			arm-trusted-firmware/tf-a-stm32mp157d-100ask-usb.stm32
-		0x03	fip-boot	FIP			none	0x0			fip/fip-stm32mp157d-100ask-trusted.bin
</code></pre> 
<p>用STM32CubeProg打开烧写脚本，注意二进制文件把目录设置<code>FIP_artifacts</code>目录，设置好板子并连接OTG和串口，点击下载。板子一直重启，那是因为U-boot不对。从串口打印信息上可以看到BL2把BL32(SP-MIN)启动起来，SP-MIN正常运行，最终U-Boot启动。<br> <img src="https://images2.imgbox.com/60/ac/RWnkFqnr_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/87/90/3jdfEDkZ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="4__404"></a>4. 总结</h2> 
<p>我们只要顺着源码设计者的思路，去添加或修改，事情就会变得简单。修改我们自己代码能解决的问题，最好不行去修改源码，这样可能导致其它板子异常。这些代码只启动板子，其他功能问题并没有解决。</p> 
<p>学习笔记仅供参考，欢迎指正错误，如有侵权请及时联系。<strong>移植源码获取：</strong></p> 
<pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/Sonboy97/arm-ostl-linux-gnueabi.git
版本：9ae04fa8dbea4c984243179d1faa6e39cd18d2dd
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8cbb325652ca0dd9aef7de19750d5abf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">STM32MP157 buildroot-2022.02.5构建根文件系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/16005a3e0efe7664840238d1d529cc4b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">STM32MP157 u-boot2021.10移植</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>