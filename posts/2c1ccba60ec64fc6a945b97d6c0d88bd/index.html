<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL C API的使用 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL C API的使用" />
<meta property="og:description" content="MySQL C API的使用 介绍及使用 MySQL C API（也称为 MySQL Connector/C）是用于与 MySQL 数据库交互的 C 语言 API。它提供了一组函数和结构体，允许你在 C 程序中连接到 MySQL 数据库服务器，并执行查询、插入、更新等数据库操作。
以下是 MySQL C API 的基本使用步骤：
1. 包含头文件： 在你的 C 代码中包含 MySQL C API 的头文件：
#include &lt;mysql/mysql.h&gt; 2. 初始化和连接： 在程序开始时，需要初始化 MySQL C API 并建立与数据库服务器的连接。以下是一个简单的例子：
// 这个函数初始化MySQL，并返回一个MYSQL指针。这个指针在后续的操作中都会使用到。 MYSQL *conn; conn = mysql_init(NULL); if (conn == NULL) { fprintf(stderr, &#34;mysql_init() failed\n&#34;); exit(1); } //连接到数据库：mysql_real_connect()使用这个函数来连接到数据库。其中参数包括上一步得到的MYSQL指针，以及数据库的主机名、用户名、密码、数据库名等。 if (mysql_real_connect(conn, &#34;localhost&#34;, &#34;user&#34;, &#34;password&#34;, &#34;database&#34;, 0, NULL, 0) == NULL) { fprintf(stderr, &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2c1ccba60ec64fc6a945b97d6c0d88bd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-08T14:27:38+08:00" />
<meta property="article:modified_time" content="2024-01-08T14:27:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL C API的使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="MySQL_C_API_0"></a>MySQL C API的使用</h2> 
<h3><a id="_2"></a>介绍及使用</h3> 
<p>MySQL C API（也称为 MySQL Connector/C）是用于与 MySQL 数据库交互的 C 语言 API。它提供了一组函数和结构体，允许你在 C 程序中连接到 MySQL 数据库服务器，并执行查询、插入、更新等数据库操作。</p> 
<p>以下是 MySQL C API 的基本使用步骤：</p> 
<h4><a id="1__8"></a>1. 包含头文件：</h4> 
<p>在你的 C 代码中包含 MySQL C API 的头文件：</p> 
<pre><code>#include &lt;mysql/mysql.h&gt;
</code></pre> 
<h4><a id="2__16"></a>2. 初始化和连接：</h4> 
<p>在程序开始时，需要初始化 MySQL C API 并建立与数据库服务器的连接。以下是一个简单的例子：</p> 
<pre><code class="prism language-c"><span class="token comment">// 这个函数初始化MySQL，并返回一个MYSQL指针。这个指针在后续的操作中都会使用到。</span>
MYSQL <span class="token operator">*</span>conn<span class="token punctuation">;</span>
conn <span class="token operator">=</span> <span class="token function">mysql_init</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"mysql_init() failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//连接到数据库：mysql_real_connect()使用这个函数来连接到数据库。其中参数包括上一步得到的MYSQL指针，以及数据库的主机名、用户名、密码、数据库名等。</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_real_connect</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"database"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"mysql_real_connect() failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mysql_close</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 补充了解</span>
<span class="token comment">// 最后三个参数大部分情况下为0,NULL,0即可，三个参数详细介绍如下</span>
port：这是数据库服务端的端口号，默认是MySQL的默认端口<span class="token number">3306</span>。如果提供<span class="token number">0</span>，将使用默认端口；
unix_socket：这是Unix系统专用的，如果mysql服务器运行在本地，并使用了Unix socket，这个参数就指定了该socket的路径。对于运行在网络上的服务器，此参数通常为<span class="token constant">NULL</span>；
client_flag：这是额外标志，通常为<span class="token number">0</span>。对于特殊情况，可以设置为一些特定的值，比如<span class="token function">CLIENT_COMPRESS</span><span class="token punctuation">(</span>在客户端和服务器间进行压缩<span class="token punctuation">)</span>，<span class="token function">CLIENT_SSL</span><span class="token punctuation">(</span>使用ssl连接<span class="token punctuation">)</span>，<span class="token function">CLIENT_LOCAL_FILES</span><span class="token punctuation">(</span>允许LOAD DATA LOCAL操作<span class="token punctuation">)</span>等等。详情请查阅MySQL的官方文档。
为了兼容更多的使用场景，mysql_real_connect函数给出了很多参数，适合应对各种复杂的数据库连接情况。但是在实际使用中，大部分情况下，使用默认参数（port为<span class="token number">0</span>，unix_socket为<span class="token constant">NULL</span>，client_flag为<span class="token number">0</span>）就足够了。
</code></pre> 
<p>在这个例子中，使用 <code>mysql_init</code> 初始化 MySQL 对象，然后使用 <code>mysql_real_connect</code> 建立与 MySQL 服务器的连接。你需要提供主机名、用户名、密码和数据库名。</p> 
<h4><a id="3__45"></a>3. 执行查询：</h4> 
<p>一旦连接建立，你可以执行 SQL 查询。以下是一个简单的查询示例：</p> 
<pre><code class="prism language-c"><span class="token comment">//mysql_query()使用这个函数来执行SQL查询。查询结果可以用后续的函数来获取。</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token string">"SELECT * FROM your_table"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"SELECT query failed: %s\n"</span><span class="token punctuation">,</span> <span class="token function">mysql_error</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mysql_close</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//获取查询结果：mysql_store_result() 或 mysql_use_result()这两个函数可以获取查询结果。mysql_store_result()将所有的查询结果存储在客户端，mysql_use_result()则允许你一个接一个地获取结果行。</span>
MYSQL_RES <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token function">mysql_store_result</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 注意，返回值是指针</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"mysql_store_result() failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mysql_close</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//遍历结果集：mysql_fetch_row()这个函数可以获取结果集中的一行。你可以在循环中使用它来遍历所有的结果行。</span>
<span class="token keyword">int</span> num_fields <span class="token operator">=</span> <span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
MYSQL_ROW row<span class="token punctuation">;</span>		<span class="token comment">//typedef char **MYSQL_ROW</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>row <span class="token operator">=</span> <span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_fields<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s "</span><span class="token punctuation">,</span> row<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">?</span> row<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">"NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 补充了解</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">MYSQL_RES</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">uint64_t</span> row_count<span class="token punctuation">;</span>
  MYSQL_FIELD <span class="token operator">*</span>fields<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">MYSQL_DATA</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
  MYSQL_ROWS <span class="token operator">*</span>data_cursor<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token operator">*</span>lengths<span class="token punctuation">;</span> <span class="token comment">/* column lengths of current row */</span>
  MYSQL <span class="token operator">*</span>handle<span class="token punctuation">;</span>          <span class="token comment">/* for unbuffered reads */</span>
  <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">MYSQL_METHODS</span> <span class="token operator">*</span>methods<span class="token punctuation">;</span>
  MYSQL_ROW row<span class="token punctuation">;</span>         <span class="token comment">/* If unbuffered read */</span>
  MYSQL_ROW current_row<span class="token punctuation">;</span> <span class="token comment">/* buffer to current row */</span>
  <span class="token keyword">struct</span> <span class="token class-name">MEM_ROOT</span> <span class="token operator">*</span>field_alloc<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> field_count<span class="token punctuation">,</span> current_field<span class="token punctuation">;</span>
  bool eof<span class="token punctuation">;</span> <span class="token comment">/* Used by mysql_fetch_row */</span>
  <span class="token comment">/* mysql_stmt_close() had to cancel this result */</span>
  bool unbuffered_fetch_cancelled<span class="token punctuation">;</span>
  <span class="token keyword">enum</span> <span class="token class-name">enum_resultset_metadata</span> metadata<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>extension<span class="token punctuation">;</span>
<span class="token punctuation">}</span> MYSQL_RES<span class="token punctuation">;</span>
</code></pre> 
<p>这个例子执行一个简单的 SELECT 查询，然后使用 <code>mysql_store_result</code> 获取查询结果，并使用 <code>mysql_fetch_row</code> 逐行读取结果集中的数据。</p> 
<h4><a id="4__98"></a>4. 插入、更新和删除：</h4> 
<p>你可以使用 <code>mysql_query</code> 函数执行插入、更新和删除等修改数据库的操作。以下是一个插入数据的示例：</p> 
<pre><code class="prism language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token string">"INSERT INTO your_table (column1, column2) VALUES ('value1', 'value2')"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"INSERT query failed: %s\n"</span><span class="token punctuation">,</span> <span class="token function">mysql_error</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mysql_close</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="5__110"></a>5. 清理结果集：</h4> 
<pre><code class="prism language-c"><span class="token comment">//清理结果集：mysql_free_result()当你处理完查询结果后，需要调用这个函数来清理结果集。</span>
<span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">mysql_close</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="6_118"></a>6.关闭连接</h4> 
<p>在程序结束时，确保关闭与 MySQL 服务器的连接并释放资源：</p> 
<pre><code class="prism language-c"><span class="token function">mysql_close</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这些是 MySQL C API 的基本用法示例。请注意，为了简洁起见，没有进行错误处理的详细检查。在实际应用中，应该更加详细地处理错误以确保程序的稳定性。</p> 
<h3><a id="API_128"></a>API封装</h3> 
<p>以下为个人在使用过程中，对API的进一步封装</p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">DataBase</span> <span class="token punctuation">{<!-- --></span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token operator">~</span><span class="token function">DataBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 析构函数自动关闭数据库</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 初始化,可以指定连接的 用户名，密码，数据存储库，host,port</span>
    <span class="token keyword">void</span> <span class="token function">Init</span><span class="token punctuation">(</span>string name<span class="token punctuation">,</span> string pwd<span class="token punctuation">,</span> string database<span class="token punctuation">,</span> string host <span class="token operator">=</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token number">3306</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">mysql_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_<span class="token punctuation">)</span><span class="token punctuation">;</span>
       
        <span class="token comment">// 连接数据库</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_real_connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_<span class="token punctuation">,</span> host<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pwd<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> database<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"connect error!"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 设置字符集编码，包含了character_set_connection为utf8mb4，因为库以及表采用的是utf8mb4字符集</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mysql_set_character_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_<span class="token punctuation">,</span> <span class="token string">"utf8mb4"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"New client character set: %s\n"</span><span class="token punctuation">,</span> <span class="token function">mysql_character_set_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 设置character_set_client 客户端字符集为GBK，因为命令行窗口是GBK编码，否则mysql 1366 error</span>
        <span class="token comment">// 设置character_set_results 查询结果集为GBK,因为命令行窗口是GBK编码，要对应起来，否乱码</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"set character_set_client = gbk"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"set character_set_results = gbk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"set character_set_client or character_set_results gbk error:"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行语句</span>
    <span class="token keyword">bool</span> <span class="token function">Query</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> query<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 成功0,失败非0</span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_<span class="token punctuation">,</span> query<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 释放结果集</span>
    <span class="token keyword">void</span> <span class="token function">FreeResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>res_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回记录行数</span>
    <span class="token keyword">int</span> <span class="token function">Rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">mysql_num_rows</span><span class="token punctuation">(</span>res_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回字段数量</span>
    <span class="token keyword">int</span> <span class="token function">Cols</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>res_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 关闭数据库</span>
    <span class="token keyword">void</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">mysql_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取查询结果集</span>
    MYSQL_RES<span class="token operator">*</span> <span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> res_ <span class="token operator">=</span> <span class="token function">mysql_store_result</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取表字段</span>
    MYSQL_FIELD<span class="token operator">*</span> <span class="token function">GetFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">mysql_fetch_fields</span><span class="token punctuation">(</span>res_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取一行记录</span>
    MYSQL_ROW <span class="token function">FetchRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> row_ <span class="token operator">=</span> <span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>res_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 不区分大小写进行比较字符串，主要用于字段名比较</span>
    <span class="token keyword">bool</span> <span class="token function">InsensistiveStringCompare</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> str1<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> str2<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        string <span class="token function">str1Cpy</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        string <span class="token function">str2Cpy</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">transform</span><span class="token punctuation">(</span>str1Cpy<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> str1Cpy<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> str1Cpy<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token double-colon punctuation">::</span>tolower<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">transform</span><span class="token punctuation">(</span>str2Cpy<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> str2Cpy<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> str2Cpy<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token double-colon punctuation">::</span>tolower<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>str1Cpy <span class="token operator">==</span> str2Cpy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 输出结果集，便于调试</span>
    <span class="token keyword">void</span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> query<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">Query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"show test error:"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        MYSQL_RES<span class="token operator">*</span> res <span class="token operator">=</span> <span class="token function">GetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"GetResult error:"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">Rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m <span class="token operator">=</span> <span class="token function">Cols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"共"</span> <span class="token operator">&lt;&lt;</span> n <span class="token operator">&lt;&lt;</span> <span class="token string">"条记录,"</span> <span class="token operator">&lt;&lt;</span> m <span class="token operator">&lt;&lt;</span> <span class="token string">"个字段"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

        MYSQL_ROW row<span class="token punctuation">;</span>
        string field<span class="token punctuation">;</span>
        vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;&gt;</span> <span class="token function">records</span><span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span>string<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">max_len</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 记录每列数据的最大长度，便于格式化输出 </span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        MYSQL_FIELD<span class="token operator">*</span> fields <span class="token operator">=</span> <span class="token function">GetFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            records<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>         <span class="token comment">// 获取字段名</span>
            max_len<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">max</span><span class="token punctuation">(</span>fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name_length<span class="token punctuation">,</span> fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>max_length<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 获取字段记录最大长度以及字段长度，记录最大值</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            row <span class="token operator">=</span> <span class="token function">FetchRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>row<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> field <span class="token operator">=</span> row<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> field <span class="token operator">=</span> <span class="token string">"NULL"</span><span class="token punctuation">;</span>
                records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> field<span class="token punctuation">;</span>
                len <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> field<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> m<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token function">setiosflags</span><span class="token punctuation">(</span>ios<span class="token double-colon punctuation">::</span>left<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token function">setw</span><span class="token punctuation">(</span>max_len<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> records<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token char">' '</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            cout <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    MYSQL mysql_<span class="token punctuation">;</span>           <span class="token comment">// 数据库句柄</span>
    MYSQL_RES<span class="token operator">*</span> res_<span class="token punctuation">;</span>        <span class="token comment">// 查询结果集合</span>
    MYSQL_ROW row_<span class="token punctuation">;</span>         <span class="token comment">// 记录结构体</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2d5164667706b0102d7c2a38975363cc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">监听键盘事件vue3封装hooks</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7eeab6e8c419ea7e0a2187af48383958/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">网络安全从入门到精通（超详细）学习路线</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>