<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>YOLOv8-OBB推理详解及部署实现 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="YOLOv8-OBB推理详解及部署实现" />
<meta property="og:description" content="目录 前言一、YOLOv8-OBB推理(Python)1. YOLOv8-OBB预测2. YOLOv8-OBB预处理3. YOLOv8-OBB后处理4. YOLOv8-OBB推理 二、YOLOv8-OBB推理(C&#43;&#43;)1. ONNX导出2. YOLOv8-OBB预处理3. YOLOv8-OBB后处理4. YOLOv8-OBB推理 三、YOLOv8-OBB部署1. 源码下载2. 环境配置2.1 配置CMakeLists.txt2.2 配置Makefile 3. ONNX导出4. 源码修改5. 运行 四. 拓展-ProbIoU1. Gaussian Bounding Boxes(GBB)2. ProbIoU3. 代码 结语下载链接参考 前言 梳理下 YOLOv8-OBB 的预处理和后处理流程，顺便让 tensorRT_Pro 支持 YOLOv8
注：为了不必要的错误，下面我们以 YOLOv8 的固定版本 v8.1.0 来演示说明
参考：https://github.com/shouxieai/tensorRT_Pro
实现：https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8
一、YOLOv8-OBB推理(Python) 1. YOLOv8-OBB预测 我们先尝试利用官方预训练权重来推理一张图片并保存，看能否成功
在 YOLOv8 主目录下新建 predict-obb.py 预测文件，其内容如下：
import cv2 import torch import numpy as np from ultralytics import YOLO def xywhr2xyxyxyxy(center): # reference: https://github.com/ultralytics/ultralytics/blob/v8.1.0/ultralytics/utils/ops.py#L545 is_numpy = isinstance(center, np." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/237d49f9e80ebcf54ddd876809e63192/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-21T17:11:00+08:00" />
<meta property="article:modified_time" content="2024-01-21T17:11:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">YOLOv8-OBB推理详解及部署实现</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">前言</a></li><li><a href="#YOLOv8OBBPython_11" rel="nofollow">一、YOLOv8-OBB推理(Python)</a></li><li><ul><li><a href="#1_YOLOv8OBB_13" rel="nofollow">1. YOLOv8-OBB预测</a></li><li><a href="#2_YOLOv8OBB_112" rel="nofollow">2. YOLOv8-OBB预处理</a></li><li><a href="#3_YOLOv8OBB_195" rel="nofollow">3. YOLOv8-OBB后处理</a></li><li><a href="#4_YOLOv8OBB_347" rel="nofollow">4. YOLOv8-OBB推理</a></li></ul> 
   </li><li><a href="#YOLOv8OBBC_546" rel="nofollow">二、YOLOv8-OBB推理(C++)</a></li><li><ul><li><a href="#1_ONNX_550" rel="nofollow">1. ONNX导出</a></li><li><a href="#2_YOLOv8OBB_637" rel="nofollow">2. YOLOv8-OBB预处理</a></li><li><a href="#3_YOLOv8OBB_733" rel="nofollow">3. YOLOv8-OBB后处理</a></li><li><a href="#4_YOLOv8OBB_851" rel="nofollow">4. YOLOv8-OBB推理</a></li></ul> 
   </li><li><a href="#YOLOv8OBB_873" rel="nofollow">三、YOLOv8-OBB部署</a></li><li><ul><li><a href="#1__879" rel="nofollow">1. 源码下载</a></li><li><a href="#2__889" rel="nofollow">2. 环境配置</a></li><li><ul><li><a href="#21_CMakeListstxt_895" rel="nofollow">2.1 配置CMakeLists.txt</a></li><li><a href="#22_Makefile_929" rel="nofollow">2.2 配置Makefile</a></li></ul> 
    </li><li><a href="#3_ONNX_963" rel="nofollow">3. ONNX导出</a></li><li><a href="#4__967" rel="nofollow">4. 源码修改</a></li><li><a href="#5__982" rel="nofollow">5. 运行</a></li></ul> 
   </li><li><a href="#_ProbIoU_1004" rel="nofollow">四. 拓展-ProbIoU</a></li><li><ul><li><a href="#1_Gaussian_Bounding_BoxesGBB_1029" rel="nofollow">1. Gaussian Bounding Boxes(GBB)</a></li><li><a href="#2_ProbIoU_1064" rel="nofollow">2. ProbIoU</a></li><li><a href="#3__1108" rel="nofollow">3. 代码</a></li></ul> 
   </li><li><a href="#_1188" rel="nofollow">结语</a></li><li><a href="#_1194" rel="nofollow">下载链接</a></li><li><a href="#_1199" rel="nofollow">参考</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>前言</h3> 
<blockquote> 
 <p>梳理下 YOLOv8-OBB 的预处理和后处理流程，顺便让 tensorRT_Pro 支持 YOLOv8</p> 
 <p><strong>注</strong>：为了不必要的错误，下面我们以 YOLOv8 的固定版本 v8.1.0 来演示说明</p> 
 <p>参考：<a href="https://github.com/shouxieai/tensorRT_Pro">https://github.com/shouxieai/tensorRT_Pro</a></p> 
 <p>实现：<a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8</a></p> 
</blockquote> 
<h3><a id="YOLOv8OBBPython_11"></a>一、YOLOv8-OBB推理(Python)</h3> 
<h4><a id="1_YOLOv8OBB_13"></a>1. YOLOv8-OBB预测</h4> 
<blockquote> 
 <p>我们先尝试利用官方预训练权重来推理一张图片并保存，看能否成功</p> 
</blockquote> 
<p>在 YOLOv8 主目录下新建 <strong>predict-obb.py</strong> 预测文件，其内容如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO

<span class="token keyword">def</span> <span class="token function">xywhr2xyxyxyxy</span><span class="token punctuation">(</span>center<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># reference: https://github.com/ultralytics/ultralytics/blob/v8.1.0/ultralytics/utils/ops.py#L545</span>
    is_numpy <span class="token operator">=</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>center<span class="token punctuation">,</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">)</span>
    cos<span class="token punctuation">,</span> sin <span class="token operator">=</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>cos<span class="token punctuation">,</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">)</span> <span class="token keyword">if</span> is_numpy <span class="token keyword">else</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cos<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>sin<span class="token punctuation">)</span>

    ctr <span class="token operator">=</span> center<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> angle <span class="token operator">=</span> <span class="token punctuation">(</span>center<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> i <span class="token punctuation">:</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    cos_value<span class="token punctuation">,</span> sin_value <span class="token operator">=</span> cos<span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">,</span> sin<span class="token punctuation">(</span>angle<span class="token punctuation">)</span>
    vec1 <span class="token operator">=</span> <span class="token punctuation">[</span>w <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> cos_value<span class="token punctuation">,</span> w <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> sin_value<span class="token punctuation">]</span>
    vec2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">-</span>h <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> sin_value<span class="token punctuation">,</span> h <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> cos_value<span class="token punctuation">]</span>
    vec1 <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>vec1<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">if</span> is_numpy <span class="token keyword">else</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>vec1<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    vec2 <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>vec2<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">if</span> is_numpy <span class="token keyword">else</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>vec2<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    pt1 <span class="token operator">=</span> ctr <span class="token operator">+</span> vec1 <span class="token operator">+</span> vec2
    pt2 <span class="token operator">=</span> ctr <span class="token operator">+</span> vec1 <span class="token operator">-</span> vec2
    pt3 <span class="token operator">=</span> ctr <span class="token operator">-</span> vec1 <span class="token operator">-</span> vec2
    pt4 <span class="token operator">=</span> ctr <span class="token operator">-</span> vec1 <span class="token operator">+</span> vec2
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>pt1<span class="token punctuation">,</span> pt2<span class="token punctuation">,</span> pt3<span class="token punctuation">,</span> pt4<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">if</span> is_numpy <span class="token keyword">else</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>pt1<span class="token punctuation">,</span> pt2<span class="token punctuation">,</span> pt3<span class="token punctuation">,</span> pt4<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">hsv2bgr</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_i <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> h <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">-</span> h_i
    p <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> s<span class="token punctuation">)</span>
    q <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f <span class="token operator">*</span> s<span class="token punctuation">)</span>
    t <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f<span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">)</span>
    
    r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

    <span class="token keyword">if</span> h_i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> t<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> q<span class="token punctuation">,</span> v<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> v<span class="token punctuation">,</span> t
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> t<span class="token punctuation">,</span> p<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q

    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>b <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>g <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">random_color</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x937151</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    s_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x315793</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    <span class="token keyword">return</span> hsv2bgr<span class="token punctuation">(</span>h_plane<span class="token punctuation">,</span> s_plane<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>

    model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">"yolov8s-obb.pt"</span><span class="token punctuation">)</span>

    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"P0032.jpg"</span><span class="token punctuation">)</span>
    results <span class="token operator">=</span> model<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    names   <span class="token operator">=</span> results<span class="token punctuation">.</span>names
    boxes   <span class="token operator">=</span> results<span class="token punctuation">.</span>obb<span class="token punctuation">.</span>data<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span>
    confs   <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    classes <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> boxes<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    boxes   <span class="token operator">=</span> xywhr2xyxyxyxy<span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> box <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        confidence <span class="token operator">=</span> confs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        label <span class="token operator">=</span> classes<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        color <span class="token operator">=</span> random_color<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>polylines<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">[</span>np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>box<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        caption <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>confidence<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        w<span class="token punctuation">,</span> h <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTextSize<span class="token punctuation">(</span>caption<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        left<span class="token punctuation">,</span> top <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> w <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>img<span class="token punctuation">,</span> caption<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>

    cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">"predict-obb.jpg"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"save done"</span><span class="token punctuation">)</span>        
</code></pre> 
<p>在上述代码中我们通过 opencv 读取了一张图像，并送入模型中推理得到输出 results，results 中保存着不同任务的结果，我们这里是旋转目标检测任务，因此只需要拿到对应的旋转框 boxes 即可。</p> 
<p>拿到 boxes 后我们就可以将对应的旋转框和模型预测的类别以及置信度绘制在图像上并保存。</p> 
<p>关于可视化的代码实现参考自 tensorRT_Pro 中的实现，可以参考：<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/application/app_yolo.cpp#L95">app_yolo.cpp#L95</a></p> 
<p>关于随机颜色的代码实现参考自 tensorRT_Pro 中的实现，可以参考：<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/tensorRT/common/ilogger.cpp#L90">ilogger.cpp#L90</a></p> 
<p>模型推理保存的结果图像如下所示：</p> 
<p><img src="https://images2.imgbox.com/c7/76/rvmiV6At_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="2_YOLOv8OBB_112"></a>2. YOLOv8-OBB预处理</h4> 
<blockquote> 
 <p>模型预测成功后我们就需要自己动手来写下 YOLOv8-OBB 的预处理和后处理，方便后续在 C++ 上的实现，我们先来看看预处理的实现。</p> 
</blockquote> 
<p>经过我们的调试分析可知 YOLOv8-OBB 的预处理过程在 <strong>ultralytics/engine/predictor.py</strong> 文件中，可以参考：<a href="https://github.com/ultralytics/ultralytics/blob/v8.1.0/ultralytics/engine/predictor.py#L113">predictor.py#L113</a></p> 
<p>代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> im<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Prepares input image before inference.

    Args:
        im (torch.Tensor | List(np.ndarray)): BCHW for tensor, [(HWC) x B] for list.
    """</span>
    not_tensor <span class="token operator">=</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>im<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span>
    <span class="token keyword">if</span> not_tensor<span class="token punctuation">:</span>
        im <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_transform<span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">)</span>
        im <span class="token operator">=</span> im<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># BGR to RGB, BHWC to BCHW, (n, 3, h, w)</span>
        im <span class="token operator">=</span> np<span class="token punctuation">.</span>ascontiguousarray<span class="token punctuation">(</span>im<span class="token punctuation">)</span>  <span class="token comment"># contiguous</span>
        im <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>im<span class="token punctuation">)</span>

    im <span class="token operator">=</span> im<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
    im <span class="token operator">=</span> im<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fp16 <span class="token keyword">else</span> im<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># uint8 to fp16/32</span>
    <span class="token keyword">if</span> not_tensor<span class="token punctuation">:</span>
        im <span class="token operator">/=</span> <span class="token number">255</span>  <span class="token comment"># 0 - 255 to 0.0 - 1.0</span>
    <span class="token keyword">return</span> im
</code></pre> 
<p>它包含以下步骤：</p> 
<ul><li><strong>self.pre_transform</strong>：即 letterbox 添加灰条</li><li><strong>im[…,::-1]</strong>：BGR → RGB</li><li><strong>transpose((0, 3, 1, 2))</strong>：添加 batch 维度，HWC → CHW</li><li><strong>torch.from_numpy</strong>：to Tensor</li><li><strong>im /= 255</strong>：除以 255，归一化</li></ul> 
<p>大家如果对 YOLOv5 的预处理熟悉的话，会发现 YOLOv8-OBB 的预处理和 YOLOv5 的预处理一模一样，因此我们不难写出对应的预处理代码，如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">preprocess_warpAffine</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dst_width<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span> dst_height<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    scale <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dst_width <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dst_height <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ox <span class="token operator">=</span> <span class="token punctuation">(</span>dst_width  <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    oy <span class="token operator">=</span> <span class="token punctuation">(</span>dst_height <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    M <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">[</span>scale<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ox<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> scale<span class="token punctuation">,</span> oy<span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    
    img_pre <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>image<span class="token punctuation">,</span> M<span class="token punctuation">,</span> <span class="token punctuation">(</span>dst_width<span class="token punctuation">,</span> dst_height<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">,</span>
                             borderMode<span class="token operator">=</span>cv2<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span> borderValue<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    IM <span class="token operator">=</span> cv2<span class="token punctuation">.</span>invertAffineTransform<span class="token punctuation">(</span>M<span class="token punctuation">)</span>
    img_pre <span class="token operator">=</span> <span class="token punctuation">(</span>img_pre<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    img_pre <span class="token operator">=</span> img_pre<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>
    img_pre <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img_pre<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img_pre<span class="token punctuation">,</span> IM
</code></pre> 
<p>其中的 letterbox 添加灰条步骤我们可以通过仿射变换 warpAffine 实现，warpAffine 非常适合在 CUDA 上加速，关于 warpAffine 仿射变换的细节大家可以参考 <a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5推理详解及预处理高性能实现</a>，这边不再赘述。其它步骤倒是和官方的没有区别。</p> 
<p>值得注意的是，letterbox 的操作是先将长边缩放到 1024，再将短边按比例缩放，同时确保缩放后的短边能整除 32，如果不能则向上取整多余部分填充。warpAffine 的操作则是将图像分辨率固定在 1024x1024，多余部分添加灰条，博主对一张 <strong>1689x2425</strong> 分辨率的图像经过两种不同预处理后的结果进行了对比，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/f9/08/CxSaEcYu_o.jpg" alt="在这里插入图片描述"></p> 
<center> 
 <b>图1-1 LeeterBox预处理图像</b> 
</center> 
<p><img src="https://images2.imgbox.com/a8/a4/SJWoRbSi_o.jpg" alt="在这里插入图片描述"></p> 
<center> 
 <b>图1-2 warpAffine预处理图像</b> 
</center> 
<p>可以看到二者明显的差别，letterbox 中灰条只有小部分，因为长边缩放到 1024 后短边缩放到 713，然后短板需向上整除 32，最终缩放到 736。而 warpAffine 则是固定分辨率 1024x1024，因此短边多余部分全部将用灰条填充。</p> 
<p>warpAffine 预处理方法将图像分辨率固定在 1024x1024，主要有以下几点考虑：(<strong>from chatGPT</strong>)</p> 
<ul><li><strong>简化处理逻辑</strong>：所有预处理后的图像分辨率相同，可以简化 CUDA 中并行处理的逻辑，使得代码更易于编写和维护。</li><li><strong>优化内存访问</strong>：在 GPU 上，连续的内存访问模式通常比非连续的访问更高效。如果所有图像具有相同的大小和布局，这可以帮助优化内存访问，提高处理速度。</li><li><strong>避免动态内存分配</strong>：动态内存分配和释放是昂贵的操作，特别是在 GPU 上。固定分辨率意味着可以预先分配足够的内存，而不需要根据每个图像的大小动态调整内存大小。</li></ul> 
<p>这两种不同的预处理方法生成的图片输入到神经网络时的维度不同，letterbox 的输入是 <strong>torch.Size([1, 3, 736, 1024])</strong>，warpAffine 的输入是 <strong>torch.Size([1, 3, 1024, 1024])</strong>。由于输入维度不同将导致模型输出维度的差异，leetrbox 的输出是 <strong>torch.Size([1, 20, 15456])</strong> 只有 15456 个框，而 warpAffine 的输出是 <strong>torch.Size([1, 20, 21504])</strong> 有 21504 个框，这点大家需要清楚。</p> 
<h4><a id="3_YOLOv8OBB_195"></a>3. YOLOv8-OBB后处理</h4> 
<blockquote> 
 <p>我们再来看看后处理的实现</p> 
</blockquote> 
<p>经过我们的调试分析可知 YOLOv8-OBB 的后处理过程在 <strong>ultralytics/models/yolo/obb/predict.py</strong> 文件中，可以参考：<a href="https://github.com/ultralytics/ultralytics/blob/v8.1.0/ultralytics/models/yolo/obb/predict.py#L10">obb/predict.py#L10</a></p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">OBBPredictor</span><span class="token punctuation">(</span>DetectionPredictor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    A class extending the DetectionPredictor class for prediction based on an Oriented Bounding Box (OBB) model.

    Example:
        ```python
        from ultralytics.utils import ASSETS
        from ultralytics.models.yolo.obb import OBBPredictor

        args = dict(model='yolov8n-obb.pt', source=ASSETS)
        predictor = OBBPredictor(overrides=args)
        predictor.predict_cli()
        
    """</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token operator">=</span>DEFAULT_CFG<span class="token punctuation">,</span> overrides<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> _callbacks<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Initializes OBBPredictor with optional model and data configuration overrides."""</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> overrides<span class="token punctuation">,</span> _callbacks<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>task <span class="token operator">=</span> <span class="token string">"obb"</span>

    <span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> preds<span class="token punctuation">,</span> img<span class="token punctuation">,</span> orig_imgs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Post-processes predictions and returns a list of Results objects."""</span>
        preds <span class="token operator">=</span> ops<span class="token punctuation">.</span>non_max_suppression<span class="token punctuation">(</span>
            preds<span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>conf<span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>iou<span class="token punctuation">,</span>
            agnostic<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>agnostic_nms<span class="token punctuation">,</span>
            max_det<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>max_det<span class="token punctuation">,</span>
            nc<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>names<span class="token punctuation">)</span><span class="token punctuation">,</span>
            classes<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>classes<span class="token punctuation">,</span>
            rotated<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>orig_imgs<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># input images are a torch.Tensor, not a list</span>
            orig_imgs <span class="token operator">=</span> ops<span class="token punctuation">.</span>convert_torch2numpy_batch<span class="token punctuation">(</span>orig_imgs<span class="token punctuation">)</span>

        results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>pred<span class="token punctuation">,</span> orig_img<span class="token punctuation">,</span> img_path<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>preds<span class="token punctuation">,</span> orig_imgs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>batch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ops<span class="token punctuation">.</span>scale_boxes<span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> orig_img<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> xywh<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token comment"># xywh, r, conf, cls</span>
            obb <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Results<span class="token punctuation">(</span>orig_img<span class="token punctuation">,</span> path<span class="token operator">=</span>img_path<span class="token punctuation">,</span> names<span class="token operator">=</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>names<span class="token punctuation">,</span> obb<span class="token operator">=</span>obb<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> results
</code></pre> 
<p>它包含以下步骤：</p> 
<ul><li><strong>ops.non_max_suppression</strong>：非极大值抑制，即 NMS</li><li><strong>ops.scale_boxes</strong>：框的解码，即 decode boxes</li></ul> 
<p>大家如果对 YOLOv5 的后处理熟悉的话，会发现 YOLOv8-OBB 的后处理和 YOLOv5 的后处理基本相似，为什么说基本相似呢，是因为 YOLOv8-OBB 是基于旋转框的，在 IoU 的计算以及框的解码上有略微差异，因此我们不难写出对应的后处理代码，如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">probiou</span><span class="token punctuation">(</span>obb1<span class="token punctuation">,</span> obb2<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e-7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Calculate the prob iou between oriented bounding boxes, https://arxiv.org/pdf/2106.06072v1.pdf.</span>
    <span class="token keyword">def</span> <span class="token function">covariance_matrix</span><span class="token punctuation">(</span>obb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Extract elements</span>
        w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> r <span class="token operator">=</span> obb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
        a <span class="token operator">=</span> <span class="token punctuation">(</span>w <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">12</span>
        b <span class="token operator">=</span> <span class="token punctuation">(</span>h <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">12</span>

        cos_r <span class="token operator">=</span> torch<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sin_r <span class="token operator">=</span> torch<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># Calculate covariance matrix elements</span>
        a_val <span class="token operator">=</span> a <span class="token operator">*</span> cos_r <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> b <span class="token operator">*</span> sin_r <span class="token operator">**</span> <span class="token number">2</span>
        b_val <span class="token operator">=</span> a <span class="token operator">*</span> sin_r <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> b <span class="token operator">*</span> cos_r <span class="token operator">**</span> <span class="token number">2</span>
        c_val <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">-</span> b<span class="token punctuation">)</span> <span class="token operator">*</span> sin_r <span class="token operator">*</span> cos_r

        <span class="token keyword">return</span> a_val<span class="token punctuation">,</span> b_val<span class="token punctuation">,</span> c_val

    a1<span class="token punctuation">,</span> b1<span class="token punctuation">,</span> c1 <span class="token operator">=</span> covariance_matrix<span class="token punctuation">(</span>obb1<span class="token punctuation">)</span>
    a2<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> c2 <span class="token operator">=</span> covariance_matrix<span class="token punctuation">(</span>obb2<span class="token punctuation">)</span>

    x1<span class="token punctuation">,</span> y1 <span class="token operator">=</span> obb1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> obb2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>

    t1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y1 <span class="token operator">-</span> y2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x1 <span class="token operator">-</span> x2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y1 <span class="token operator">-</span> y2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>
    t3 <span class="token operator">=</span> torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>a1 <span class="token operator">*</span> b1 <span class="token operator">-</span> c1 <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>a2 <span class="token operator">*</span> b2 <span class="token operator">-</span> c2 <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>

    bd <span class="token operator">=</span> <span class="token number">0.25</span> <span class="token operator">*</span> t1 <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> t2 <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> t3
    hd <span class="token operator">=</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span>torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>bd<span class="token punctuation">,</span> eps<span class="token punctuation">,</span> <span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">-</span> hd

<span class="token keyword">def</span> <span class="token function">NMS</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span><span class="token punctuation">:</span>

    remove_flags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>

    keep_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> ibox <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        keep_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ibox<span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            jbox <span class="token operator">=</span> boxes<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ibox<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">!=</span> jbox<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> probiou<span class="token punctuation">(</span>ibox<span class="token punctuation">,</span> jbox<span class="token punctuation">)</span> <span class="token operator">&gt;</span> iou_thres<span class="token punctuation">:</span>
                remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> keep_boxes

<span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> IM<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> conf_thres<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> iou_thres<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 输入是模型推理的结果，即21504个预测框</span>
    <span class="token comment"># 1,21504,20 [cx,cy,w,h,class*15,rotated]</span>
    boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> pred<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
        angle <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">+</span> label<span class="token punctuation">]</span>
        <span class="token keyword">if</span> confidence <span class="token operator">&lt;</span> conf_thres<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> angle<span class="token punctuation">,</span> confidence<span class="token punctuation">,</span> label<span class="token punctuation">]</span><span class="token punctuation">)</span>

    boxes <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>
    cx <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    cy <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    wh <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> cx <span class="token operator">+</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> cy <span class="token operator">+</span> IM<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> wh
    boxes <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>boxes<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> NMS<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span>
</code></pre> 
<p>其中预测框的解码我们是通过仿射变换逆矩阵 IM 实现的，关于 IM 的细节大家可以参考 <a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5推理详解及预处理高性能实现</a>，这边不再赘述。关于 NMS 的代码参考自 tensorRT_Pro 中的实现：<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/application/app_yolo/yolo.cpp#L119">yolo.cpp#L119</a></p> 
<p>值得注意的是 IoU 的计算 YOLOv8 官方考虑的是利用 ProbIoU 来计算两个旋转框的相似性，更多细节大家可以看论文：<a href="https://arxiv.org/pdf/2106.06072v1.pdf" rel="nofollow"><em>Gaussian Bounding Boxes and Probabilistic Intersection-over-Union for Object Detection</em></a></p> 
<p>对于一张 1024x1024 的图片来说，YOLOv8-OBB 预测框的总数量是 <strong>21504</strong>，每个预测框的维度是 <strong>20</strong>（针对 DOTAv1 数据集的 15 个类别而言）<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
            
              21504 
             
            
              × 
             
            
              20 
             
            
           
          
          
           
            
             
            
              = 
             
            
              128 
             
            
              × 
             
            
              128 
             
            
              × 
             
            
              20 
             
            
              + 
             
            
              64 
             
            
              × 
             
            
              64 
             
            
              × 
             
            
              20 
             
            
              + 
             
            
              32 
             
            
              × 
             
            
              32 
             
            
              × 
             
            
              20 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              = 
             
            
              128 
             
            
              × 
             
            
              128 
             
            
              × 
             
            
              ( 
             
            
              4 
             
            
              + 
             
            
              15 
             
            
              + 
             
            
              1 
             
            
              ) 
             
            
              + 
             
            
              64 
             
            
              × 
             
            
              64 
             
            
              × 
             
            
              ( 
             
            
              4 
             
            
              + 
             
            
              15 
             
            
              + 
             
            
              1 
             
            
              ) 
             
            
              + 
             
            
              32 
             
            
              × 
             
            
              32 
             
            
              × 
             
            
              ( 
             
            
              4 
             
            
              + 
             
            
              15 
             
            
              + 
             
            
              1 
             
            
              ) 
             
            
           
          
         
        
       
         \begin{aligned} 21504\times20&amp;=128\times128\times20+64\times64\times20+32\times32\times20\\ &amp;=128\times128\times(4+15+1)+64\times64\times(4+15+1)+32\times32\times(4+15+1) \end{aligned} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 3em; vertical-align: -1.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.75em;"><span class="" style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">21504</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.75em;"><span class="" style="top: -3.91em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">128</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">128</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">64</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">64</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">20</span></span></span><span class="" style="top: -2.41em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">128</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">128</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">15</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">64</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">64</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">15</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">32</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">15</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.25em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> 其中的 4 对应的是 <strong>cx</strong>, <strong>cy</strong>, <strong>w</strong>, <strong>h</strong>，分别代表的含义是边界框中心点坐标、宽高；15 对应的是 DOTAv1 数据集中的 15 个类别置信度；1 对应的是旋转框的旋转角度 <strong>angle</strong>，其取值范围是在 <strong>[-pi/4, 3pi/4]</strong> 之间。</p> 
<h4><a id="4_YOLOv8OBB_347"></a>4. YOLOv8-OBB推理</h4> 
<blockquote> 
 <p>通过上面对 YOLOv8-OBB 的预处理和后处理分析之后，整个推理过程就显而易见了。YOLOv8-OBB 的推理包括图像预处理、模型推理、预测结果后处理三部分，其中预处理主要包括 <strong>warpAffine 仿射变换</strong>，后处理主要包括 <strong>decode 解码和 NMS</strong> 两部分。</p> 
</blockquote> 
<p>完整的推理代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>data<span class="token punctuation">.</span>augment <span class="token keyword">import</span> LetterBox
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>autobackend <span class="token keyword">import</span> AutoBackend

<span class="token keyword">def</span> <span class="token function">preprocess_letterbox</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    letterbox <span class="token operator">=</span> LetterBox<span class="token punctuation">(</span>new_shape<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> auto<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    image <span class="token operator">=</span> letterbox<span class="token punctuation">(</span>image<span class="token operator">=</span>image<span class="token punctuation">)</span>
    image <span class="token operator">=</span> <span class="token punctuation">(</span>image<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> <span class="token comment"># BGR to RGB, 0 - 255 to 0.0 - 1.0</span>
    image <span class="token operator">=</span> image<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># BHWC to BCHW (n, 3, h, w)</span>
    image <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    <span class="token keyword">return</span> image

<span class="token keyword">def</span> <span class="token function">preprocess_warpAffine</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> dst_width<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span> dst_height<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    scale <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dst_width <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dst_height <span class="token operator">/</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ox <span class="token operator">=</span> <span class="token punctuation">(</span>dst_width  <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    oy <span class="token operator">=</span> <span class="token punctuation">(</span>dst_height <span class="token operator">-</span> scale <span class="token operator">*</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
    M <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">[</span>scale<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ox<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> scale<span class="token punctuation">,</span> oy<span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    img_pre <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>image<span class="token punctuation">,</span> M<span class="token punctuation">,</span> <span class="token punctuation">(</span>dst_width<span class="token punctuation">,</span> dst_height<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token operator">=</span>cv2<span class="token punctuation">.</span>INTER_LINEAR<span class="token punctuation">,</span>
                             borderMode<span class="token operator">=</span>cv2<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span> borderValue<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    IM <span class="token operator">=</span> cv2<span class="token punctuation">.</span>invertAffineTransform<span class="token punctuation">(</span>M<span class="token punctuation">)</span>
    img_pre <span class="token operator">=</span> <span class="token punctuation">(</span>img_pre<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    img_pre <span class="token operator">=</span> img_pre<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>
    img_pre <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img_pre<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img_pre<span class="token punctuation">,</span> IM

<span class="token keyword">def</span> <span class="token function">xywhr2xyxyxyxy</span><span class="token punctuation">(</span>center<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># reference: https://github.com/ultralytics/ultralytics/blob/v8.1.0/ultralytics/utils/ops.py#L545</span>
    is_numpy <span class="token operator">=</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>center<span class="token punctuation">,</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">)</span>
    cos<span class="token punctuation">,</span> sin <span class="token operator">=</span> <span class="token punctuation">(</span>np<span class="token punctuation">.</span>cos<span class="token punctuation">,</span> np<span class="token punctuation">.</span>sin<span class="token punctuation">)</span> <span class="token keyword">if</span> is_numpy <span class="token keyword">else</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cos<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>sin<span class="token punctuation">)</span>

    ctr <span class="token operator">=</span> center<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> angle <span class="token operator">=</span> <span class="token punctuation">(</span>center<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> i <span class="token punctuation">:</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    cos_value<span class="token punctuation">,</span> sin_value <span class="token operator">=</span> cos<span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">,</span> sin<span class="token punctuation">(</span>angle<span class="token punctuation">)</span>
    vec1 <span class="token operator">=</span> <span class="token punctuation">[</span>w <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> cos_value<span class="token punctuation">,</span> w <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> sin_value<span class="token punctuation">]</span>
    vec2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">-</span>h <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> sin_value<span class="token punctuation">,</span> h <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> cos_value<span class="token punctuation">]</span>
    vec1 <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>vec1<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">if</span> is_numpy <span class="token keyword">else</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>vec1<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    vec2 <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>vec2<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">if</span> is_numpy <span class="token keyword">else</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>vec2<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    pt1 <span class="token operator">=</span> ctr <span class="token operator">+</span> vec1 <span class="token operator">+</span> vec2
    pt2 <span class="token operator">=</span> ctr <span class="token operator">+</span> vec1 <span class="token operator">-</span> vec2
    pt3 <span class="token operator">=</span> ctr <span class="token operator">-</span> vec1 <span class="token operator">-</span> vec2
    pt4 <span class="token operator">=</span> ctr <span class="token operator">-</span> vec1 <span class="token operator">+</span> vec2
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>pt1<span class="token punctuation">,</span> pt2<span class="token punctuation">,</span> pt3<span class="token punctuation">,</span> pt4<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">if</span> is_numpy <span class="token keyword">else</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>pt1<span class="token punctuation">,</span> pt2<span class="token punctuation">,</span> pt3<span class="token punctuation">,</span> pt4<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">probiou</span><span class="token punctuation">(</span>obb1<span class="token punctuation">,</span> obb2<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e-7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Calculate the prob iou between oriented bounding boxes, https://arxiv.org/pdf/2106.06072v1.pdf.</span>
    <span class="token keyword">def</span> <span class="token function">covariance_matrix</span><span class="token punctuation">(</span>obb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Extract elements</span>
        w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> r <span class="token operator">=</span> obb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
        a <span class="token operator">=</span> <span class="token punctuation">(</span>w <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">12</span>
        b <span class="token operator">=</span> <span class="token punctuation">(</span>h <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">12</span>

        cos_r <span class="token operator">=</span> torch<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sin_r <span class="token operator">=</span> torch<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># Calculate covariance matrix elements</span>
        a_val <span class="token operator">=</span> a <span class="token operator">*</span> cos_r <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> b <span class="token operator">*</span> sin_r <span class="token operator">**</span> <span class="token number">2</span>
        b_val <span class="token operator">=</span> a <span class="token operator">*</span> sin_r <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> b <span class="token operator">*</span> cos_r <span class="token operator">**</span> <span class="token number">2</span>
        c_val <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">-</span> b<span class="token punctuation">)</span> <span class="token operator">*</span> sin_r <span class="token operator">*</span> cos_r

        <span class="token keyword">return</span> a_val<span class="token punctuation">,</span> b_val<span class="token punctuation">,</span> c_val

    a1<span class="token punctuation">,</span> b1<span class="token punctuation">,</span> c1 <span class="token operator">=</span> covariance_matrix<span class="token punctuation">(</span>obb1<span class="token punctuation">)</span>
    a2<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> c2 <span class="token operator">=</span> covariance_matrix<span class="token punctuation">(</span>obb2<span class="token punctuation">)</span>

    x1<span class="token punctuation">,</span> y1 <span class="token operator">=</span> obb1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> obb2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>

    t1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y1 <span class="token operator">-</span> y2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x1 <span class="token operator">-</span> x2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y1 <span class="token operator">-</span> y2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>
    t3 <span class="token operator">=</span> torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>a1 <span class="token operator">*</span> b1 <span class="token operator">-</span> c1 <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>a2 <span class="token operator">*</span> b2 <span class="token operator">-</span> c2 <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>

    bd <span class="token operator">=</span> <span class="token number">0.25</span> <span class="token operator">*</span> t1 <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> t2 <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> t3
    hd <span class="token operator">=</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span>torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>bd<span class="token punctuation">,</span> eps<span class="token punctuation">,</span> <span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">-</span> hd

<span class="token keyword">def</span> <span class="token function">NMS</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span><span class="token punctuation">:</span>

    remove_flags <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>

    keep_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> ibox <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        keep_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ibox<span class="token punctuation">)</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            jbox <span class="token operator">=</span> boxes<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ibox<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">!=</span> jbox<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> probiou<span class="token punctuation">(</span>ibox<span class="token punctuation">,</span> jbox<span class="token punctuation">)</span> <span class="token operator">&gt;</span> iou_thres<span class="token punctuation">:</span>
                remove_flags<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">return</span> keep_boxes

<span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> IM<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> conf_thres<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span> iou_thres<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 输入是模型推理的结果，即21504个预测框</span>
    <span class="token comment"># 1,21504,20 [cx,cy,w,h,class*15,rotated]</span>
    boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> pred<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
        angle <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        label <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token punctuation">)</span>
        confidence <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">+</span> label<span class="token punctuation">]</span>
        <span class="token keyword">if</span> confidence <span class="token operator">&lt;</span> conf_thres<span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> angle<span class="token punctuation">,</span> confidence<span class="token punctuation">,</span> label<span class="token punctuation">]</span><span class="token punctuation">)</span>

    boxes <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>boxes<span class="token punctuation">)</span>
    cx <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
    cy <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    wh <span class="token operator">=</span> boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> cx <span class="token operator">+</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> cy <span class="token operator">+</span> IM<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    boxes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> IM<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> wh
    boxes <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>boxes<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> NMS<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> iou_thres<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">hsv2bgr</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_i <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> h <span class="token operator">*</span> <span class="token number">6</span> <span class="token operator">-</span> h_i
    p <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> s<span class="token punctuation">)</span>
    q <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f <span class="token operator">*</span> s<span class="token punctuation">)</span>
    t <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> f<span class="token punctuation">)</span> <span class="token operator">*</span> s<span class="token punctuation">)</span>
    
    r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

    <span class="token keyword">if</span> h_i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> t<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> q<span class="token punctuation">,</span> v<span class="token punctuation">,</span> p
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> v<span class="token punctuation">,</span> t
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> p<span class="token punctuation">,</span> q<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> t<span class="token punctuation">,</span> p<span class="token punctuation">,</span> v
    <span class="token keyword">elif</span> h_i <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b <span class="token operator">=</span> v<span class="token punctuation">,</span> p<span class="token punctuation">,</span> q

    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>b <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>g <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">random_color</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    h_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x937151</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    s_plane <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">id</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x315793</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100.0</span>
    <span class="token keyword">return</span> hsv2bgr<span class="token punctuation">(</span>h_plane<span class="token punctuation">,</span> s_plane<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>

    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">"P0032.jpg"</span><span class="token punctuation">)</span>

    <span class="token comment"># img_pre = preprocess_letterbox(img)</span>
    img_pre<span class="token punctuation">,</span> IM <span class="token operator">=</span> preprocess_warpAffine<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    model  <span class="token operator">=</span> AutoBackend<span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token string">"yolov8s-obb.pt"</span><span class="token punctuation">)</span>
    names  <span class="token operator">=</span> model<span class="token punctuation">.</span>names
    result <span class="token operator">=</span> model<span class="token punctuation">(</span>img_pre<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 1,21504,20</span>

    boxes   <span class="token operator">=</span> postprocess<span class="token punctuation">(</span>result<span class="token punctuation">,</span> IM<span class="token punctuation">)</span>
    confs   <span class="token operator">=</span> <span class="token punctuation">[</span>box<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token keyword">for</span> box <span class="token keyword">in</span> boxes<span class="token punctuation">]</span>
    classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> box <span class="token keyword">in</span> boxes<span class="token punctuation">]</span>
    boxes   <span class="token operator">=</span> xywhr2xyxyxyxy<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i<span class="token punctuation">,</span> box <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        confidence <span class="token operator">=</span> confs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        label <span class="token operator">=</span> classes<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        color <span class="token operator">=</span> random_color<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>polylines<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">[</span>np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>box<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        caption <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>names<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>confidence<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        w<span class="token punctuation">,</span> h <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getTextSize<span class="token punctuation">(</span>caption<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        left<span class="token punctuation">,</span> top <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> w <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>img<span class="token punctuation">,</span> caption<span class="token punctuation">,</span> <span class="token punctuation">(</span>left<span class="token punctuation">,</span> top <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
    
    cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">"infer-obb.jpg"</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"save done"</span><span class="token punctuation">)</span>
</code></pre> 
<p>推理效果如下图：</p> 
<p><img src="https://images2.imgbox.com/49/e2/TXzgX9Ch_o.jpg" alt="在这里插入图片描述"></p> 
<p>至此，我们在 Python 上面完成了 YOLOv8-OBB 的整个推理过程，下面我们去 C++ 上实现。</p> 
<h3><a id="YOLOv8OBBC_546"></a>二、YOLOv8-OBB推理(C++)</h3> 
<blockquote> 
 <p>C++ 上的实现我们使用的 repo 依旧是 tensorRT_Pro，现在我们就基于 tensorRT_Pro 完成 YOLOv8-OBB 在 C++ 上的推理。</p> 
</blockquote> 
<h4><a id="1_ONNX_550"></a>1. ONNX导出</h4> 
<p>首先我们需要将 YOLOv8-OBB 模型导出为 ONNX，为了适配 tensorRT_Pro 我们需要做一些修改，主要有以下几点：</p> 
<ul><li>修改输出节点名为 <strong>output</strong>，输入输出只让 batch 维度动态，宽高不动态</li><li>增加 <strong>transpose</strong> 节点交换输出的 2、3 维度</li></ul> 
<p>具体修改如下：</p> 
<p><strong>1.</strong> <strong>在 ultralytics/engine/exporter.py 文件中改动一处</strong></p> 
<ul><li><strong>353 行</strong>：输出节点名修改为 <strong>output</strong></li><li><strong>356 行</strong>：输入只让 batch 维度动态，宽高不动态</li><li><strong>361 行</strong>：输出只让 batch 维度动态，宽高不动态</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># ========== exporter.py ==========</span>

<span class="token comment"># ultralytics/engine/exporter.py第353行</span>
<span class="token comment"># output_names = ['output0', 'output1'] if isinstance(self.model, SegmentationModel) else ['output0']</span>
<span class="token comment"># dynamic = self.args.dynamic</span>
<span class="token comment"># if dynamic:</span>
<span class="token comment">#     dynamic = {'images': {0: 'batch', 2: 'height', 3: 'width'}}  # shape(1,3,640,640)</span>
<span class="token comment">#     if isinstance(self.model, SegmentationModel):</span>
<span class="token comment">#         dynamic['output0'] = {0: 'batch', 2: 'anchors'}  # shape(1, 116, 8400)</span>
<span class="token comment">#         dynamic['output1'] = {0: 'batch', 2: 'mask_height', 3: 'mask_width'}  # shape(1,32,160,160)</span>
<span class="token comment">#     elif isinstance(self.model, DetectionModel):</span>
<span class="token comment">#         dynamic['output0'] = {0: 'batch', 2: 'anchors'}  # shape(1, 84, 8400)</span>
<span class="token comment"># 修改为：</span>

output_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'output0'</span><span class="token punctuation">,</span> <span class="token string">'output1'</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> SegmentationModel<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span>
dynamic <span class="token operator">=</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>dynamic
<span class="token keyword">if</span> dynamic<span class="token punctuation">:</span>
    dynamic <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'images'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1,3,640,640)</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> SegmentationModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dynamic<span class="token punctuation">[</span><span class="token string">'output0'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'anchors'</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1, 116, 8400)</span>
        dynamic<span class="token punctuation">[</span><span class="token string">'output1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'mask_height'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">'mask_width'</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1,32,160,160)</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span> DetectionModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dynamic<span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch'</span><span class="token punctuation">}</span>  <span class="token comment"># shape(1, 84, 8400)</span>
</code></pre> 
<p><strong>2.</strong> <strong>在 ultralytics/nn/modules/head.py 文件中改动一处</strong></p> 
<ul><li><strong>141 行</strong>：添加 <strong>transpose</strong> 节点交换输出的第 2 和第 3 维度</li></ul> 
<pre><code class="prism language-python"><span class="token comment"># ========== head.py ==========</span>

<span class="token comment"># ultralytics/nn/modules/head.py第141行，forward函数</span>
<span class="token comment"># return torch.cat([x, angle], 1) if self.export else (torch.cat([x[0], angle], 1), (x[1], angle))</span>
<span class="token comment"># 修改为：</span>

<span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> angle<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>export <span class="token keyword">else</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> angle<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> angle<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>以上就是为了适配 tensorRT_Pro 而做出的代码修改，修改好以后，将预训练权重 <strong>yolov8s-obb.pt</strong> 放在 ultralytics-main 主目录下，新建导出文件 <strong>export.py</strong>，内容如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO

model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">"yolov8s-obb.pt"</span><span class="token punctuation">)</span>

success <span class="token operator">=</span> model<span class="token punctuation">.</span>export<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"onnx"</span><span class="token punctuation">,</span> dynamic<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> simplify<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<p>在终端执行如下指令即可完成 onnx 导出：</p> 
<pre><code class="prism language-shell">python export.py
</code></pre> 
<p>导出过程如下图所示：</p> 
<p><img src="https://images2.imgbox.com/a4/48/cVR06VN6_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到导出的 pytorch 模型的输入 shape 是 1x3x1024x1024，输出 shape 是 1x21504x20，符合我们的预期。</p> 
<p>导出成功后会在当前目录下生成 yolov8s-obb.onnx 模型，我们可以使用 <a href="https://netron.app/" rel="nofollow">Netron</a> 可视化工具查看，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/37/c3/6iA6wNe0_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到输入节点名是 <strong>images</strong>，维度是 batchx3x1024x1024，保证只有 batch 维度动态，输出节点名是 <strong>output</strong>，维度是 batchxTransposeoutput_dim_1xTransposeoutput_dim_2，保证只有 batch 维度动态，符合 tensorRT_Pro 的格式。</p> 
<p>大家不要看到 Transposeoutput_dim_1 和 Transposeoutput_dim_2 就认为这也是动态的，其实输出节点的维度是根据输入节点的维度和模型的结构生成的，而额外的维度 Transposeoutput_dim_1 和 Transposeoutput_dim_2 可能是由模型结构中某些操作决定的，如通道数变换（Transpose）操作的输出维度，而不是由动态维度决定的。因此，通常情况下，这些维度是静态的，不会在推理时改变。</p> 
<h4><a id="2_YOLOv8OBB_637"></a>2. YOLOv8-OBB预处理</h4> 
<blockquote> 
 <p>之前有提到过 YOLOv8-OBB 预处理部分和 YOLOv5 实现一模一样，因此我们在 tensorRT_Pro 中 YOLOv8-OBB 模型的预处理可以直接使用 YOLOv5 的预处理。</p> 
</blockquote> 
<p>tensorRT_Pro 中预处理的代码如下：</p> 
<pre><code class="prism language-cpp">__global__ <span class="token keyword">void</span> <span class="token function">warp_affine_bilinear_and_normalize_plane_kernel</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token operator">*</span> src<span class="token punctuation">,</span> <span class="token keyword">int</span> src_line_size<span class="token punctuation">,</span> <span class="token keyword">int</span> src_width<span class="token punctuation">,</span> <span class="token keyword">int</span> src_height<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> dst<span class="token punctuation">,</span> <span class="token keyword">int</span> dst_width<span class="token punctuation">,</span> <span class="token keyword">int</span> dst_height<span class="token punctuation">,</span> 
	<span class="token keyword">uint8_t</span> const_value_st<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> warp_affine_matrix_2_3<span class="token punctuation">,</span> Norm norm<span class="token punctuation">,</span> <span class="token keyword">int</span> edge<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

	<span class="token keyword">int</span> position <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">&gt;=</span> edge<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token keyword">float</span> m_x1 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_y1 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_z1 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_x2 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_y2 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> m_z2 <span class="token operator">=</span> warp_affine_matrix_2_3<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> dx      <span class="token operator">=</span> position <span class="token operator">%</span> dst_width<span class="token punctuation">;</span>
	<span class="token keyword">int</span> dy      <span class="token operator">=</span> position <span class="token operator">/</span> dst_width<span class="token punctuation">;</span>
	<span class="token keyword">float</span> src_x <span class="token operator">=</span> m_x1 <span class="token operator">*</span> dx <span class="token operator">+</span> m_y1 <span class="token operator">*</span> dy <span class="token operator">+</span> m_z1<span class="token punctuation">;</span>
	<span class="token keyword">float</span> src_y <span class="token operator">=</span> m_x2 <span class="token operator">*</span> dx <span class="token operator">+</span> m_y2 <span class="token operator">*</span> dy <span class="token operator">+</span> m_z2<span class="token punctuation">;</span>
	<span class="token keyword">float</span> c0<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>src_x <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> src_x <span class="token operator">&gt;=</span> src_width <span class="token operator">||</span> src_y <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> src_y <span class="token operator">&gt;=</span> src_height<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">// out of range</span>
		c0 <span class="token operator">=</span> const_value_st<span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> const_value_st<span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> const_value_st<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> y_low <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>src_y<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> x_low <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>src_x<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> y_high <span class="token operator">=</span> y_low <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> x_high <span class="token operator">=</span> x_low <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

		<span class="token keyword">uint8_t</span> const_value<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>const_value_st<span class="token punctuation">,</span> const_value_st<span class="token punctuation">,</span> const_value_st<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">float</span> ly    <span class="token operator">=</span> src_y <span class="token operator">-</span> y_low<span class="token punctuation">;</span>
		<span class="token keyword">float</span> lx    <span class="token operator">=</span> src_x <span class="token operator">-</span> x_low<span class="token punctuation">;</span>
		<span class="token keyword">float</span> hy    <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> ly<span class="token punctuation">;</span>
		<span class="token keyword">float</span> hx    <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> lx<span class="token punctuation">;</span>
		<span class="token keyword">float</span> w1    <span class="token operator">=</span> hy <span class="token operator">*</span> hx<span class="token punctuation">,</span> w2 <span class="token operator">=</span> hy <span class="token operator">*</span> lx<span class="token punctuation">,</span> w3 <span class="token operator">=</span> ly <span class="token operator">*</span> hx<span class="token punctuation">,</span> w4 <span class="token operator">=</span> ly <span class="token operator">*</span> lx<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v1 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v2 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v3 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">uint8_t</span><span class="token operator">*</span> v4 <span class="token operator">=</span> const_value<span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>y_low <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_low <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
				v1 <span class="token operator">=</span> src <span class="token operator">+</span> y_low <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_low <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_high <span class="token operator">&lt;</span> src_width<span class="token punctuation">)</span>
				v2 <span class="token operator">=</span> src <span class="token operator">+</span> y_low <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_high <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token keyword">if</span><span class="token punctuation">(</span>y_high <span class="token operator">&lt;</span> src_height<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_low <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
				v3 <span class="token operator">=</span> src <span class="token operator">+</span> y_high <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_low <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>x_high <span class="token operator">&lt;</span> src_width<span class="token punctuation">)</span>
				v4 <span class="token operator">=</span> src <span class="token operator">+</span> y_high <span class="token operator">*</span> src_line_size <span class="token operator">+</span> x_high <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">// same to opencv</span>
		c0 <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>w1 <span class="token operator">*</span> v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w2 <span class="token operator">*</span> v2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w3 <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w4 <span class="token operator">*</span> v4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>w1 <span class="token operator">*</span> v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> w2 <span class="token operator">*</span> v2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> w3 <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> w4 <span class="token operator">*</span> v4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> <span class="token function">floorf</span><span class="token punctuation">(</span>w1 <span class="token operator">*</span> v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> w2 <span class="token operator">*</span> v2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> w3 <span class="token operator">*</span> v3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> w4 <span class="token operator">*</span> v4<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>norm<span class="token punctuation">.</span>channel_type <span class="token operator">==</span> ChannelType<span class="token double-colon punctuation">::</span>Invert<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">float</span> t <span class="token operator">=</span> c2<span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> c0<span class="token punctuation">;</span>  c0 <span class="token operator">=</span> t<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>norm<span class="token punctuation">.</span>type <span class="token operator">==</span> NormType<span class="token double-colon punctuation">::</span>MeanStd<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		c0 <span class="token operator">=</span> <span class="token punctuation">(</span>c0 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">-</span> norm<span class="token punctuation">.</span>mean<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> norm<span class="token punctuation">.</span>std<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> <span class="token punctuation">(</span>c1 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">-</span> norm<span class="token punctuation">.</span>mean<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> norm<span class="token punctuation">.</span>std<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> <span class="token punctuation">(</span>c2 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">-</span> norm<span class="token punctuation">.</span>mean<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> norm<span class="token punctuation">.</span>std<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>norm<span class="token punctuation">.</span>type <span class="token operator">==</span> NormType<span class="token double-colon punctuation">::</span>AlphaBeta<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		c0 <span class="token operator">=</span> c0 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">+</span> norm<span class="token punctuation">.</span>beta<span class="token punctuation">;</span>
		c1 <span class="token operator">=</span> c1 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">+</span> norm<span class="token punctuation">.</span>beta<span class="token punctuation">;</span>
		c2 <span class="token operator">=</span> c2 <span class="token operator">*</span> norm<span class="token punctuation">.</span>alpha <span class="token operator">+</span> norm<span class="token punctuation">.</span>beta<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> area <span class="token operator">=</span> dst_width <span class="token operator">*</span> dst_height<span class="token punctuation">;</span>
	<span class="token keyword">float</span><span class="token operator">*</span> pdst_c0 <span class="token operator">=</span> dst <span class="token operator">+</span> dy <span class="token operator">*</span> dst_width <span class="token operator">+</span> dx<span class="token punctuation">;</span>
	<span class="token keyword">float</span><span class="token operator">*</span> pdst_c1 <span class="token operator">=</span> pdst_c0 <span class="token operator">+</span> area<span class="token punctuation">;</span>
	<span class="token keyword">float</span><span class="token operator">*</span> pdst_c2 <span class="token operator">=</span> pdst_c1 <span class="token operator">+</span> area<span class="token punctuation">;</span>
	<span class="token operator">*</span>pdst_c0 <span class="token operator">=</span> c0<span class="token punctuation">;</span>
	<span class="token operator">*</span>pdst_c1 <span class="token operator">=</span> c1<span class="token punctuation">;</span>
	<span class="token operator">*</span>pdst_c2 <span class="token operator">=</span> c2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>关于预处理部分其实就是调用了上述 CUDA 核函数来实现 warpAffine，由于在 CUDA 中我们是对每个像素进行操作，因此非常容易实现 BGR → RGB，/255.0 等操作。关于代码的具体分析可以参考 <a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5推理详解及预处理高性能实现</a>，这边不再赘述。</p> 
<h4><a id="3_YOLOv8OBB_733"></a>3. YOLOv8-OBB后处理</h4> 
<blockquote> 
 <p>之前有提到过 YOLOv8-OBB 后处理部分和 YOLOv5 基本相似，但由于 YOLOv8-OBB 多了角度信息，因此对于 decode 解码部分我们需要进行简单调整，此外 IoU 的计算也需要调整为 ProbIoU，代码可参考：<a href="https://github.com/shouxieai/infer/blob/main/src/yolo.cu#L129">yolo.cu#L129</a></p> 
</blockquote> 
<p>因此我们不难写出 YOLOv8-OBB 的 decode 解码部分的实现代码，如下所示：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> __global__ <span class="token keyword">void</span> <span class="token function">decode_kernel</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span> predict<span class="token punctuation">,</span> <span class="token keyword">int</span> num_bboxes<span class="token punctuation">,</span> <span class="token keyword">int</span> num_classes<span class="token punctuation">,</span> <span class="token keyword">float</span> confidence_threshold<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> invert_affine_matrix<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">*</span> parray<span class="token punctuation">,</span> <span class="token keyword">int</span> max_objects<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// cx, cy, w, h, cls, angle</span>
    <span class="token keyword">int</span> position <span class="token operator">=</span> blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">&gt;=</span> num_bboxes<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span><span class="token operator">*</span> pitem            <span class="token operator">=</span> predict <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">+</span> num_classes<span class="token punctuation">)</span> <span class="token operator">*</span> position<span class="token punctuation">;</span>
    <span class="token keyword">float</span><span class="token operator">*</span> class_confidence <span class="token operator">=</span> pitem <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> confidence        <span class="token operator">=</span> <span class="token operator">*</span>class_confidence<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> label               <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_classes<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">,</span> <span class="token operator">++</span>class_confidence<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>class_confidence <span class="token operator">&gt;</span> confidence<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            confidence <span class="token operator">=</span> <span class="token operator">*</span>class_confidence<span class="token punctuation">;</span>
            label      <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>confidence <span class="token operator">&lt;</span> confidence_threshold<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">atomicAdd</span><span class="token punctuation">(</span>parray<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> max_objects<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> cx         <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> cy         <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> width      <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> height     <span class="token operator">=</span> <span class="token operator">*</span>pitem<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> angle      <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>pitem <span class="token operator">+</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">affine_project</span><span class="token punctuation">(</span>invert_affine_matrix<span class="token punctuation">,</span> cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cy<span class="token punctuation">,</span> <span class="token operator">&amp;</span>width<span class="token punctuation">,</span> <span class="token operator">&amp;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span><span class="token operator">*</span> pout_item <span class="token operator">=</span> parray <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> index <span class="token operator">*</span> NUM_BOX_ELEMENT<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> cx<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> cy<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> width<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> height<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> angle<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> confidence<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> label<span class="token punctuation">;</span>
    <span class="token operator">*</span>pout_item<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 1 = keep, 0 = ignore</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>关于 decode 的具体实现其实就是启动多个线程，每个线程处理一个框的解码，我们会通过仿射变换逆矩阵 IM 将坐标映射回原图上，值得注意的是角度维度在最后一维，类别信息在中间，即一个旋转框 20 维的信息为 <strong>[cx, cy, w, h, cls*15, angle]</strong>。</p> 
<p>另外关于 NMS 部分，由于在 YOLOv8-OBB 模型中采用的是 ProbIoU 计算两个旋转框相似度，因此也需要适当调整，调整后的 NMS 代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> __device__ <span class="token keyword">void</span> <span class="token function">convariance_matrix</span><span class="token punctuation">(</span><span class="token keyword">float</span> w<span class="token punctuation">,</span> <span class="token keyword">float</span> h<span class="token punctuation">,</span> <span class="token keyword">float</span> r<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&amp;</span> a<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&amp;</span> b<span class="token punctuation">,</span> <span class="token keyword">float</span><span class="token operator">&amp;</span> c<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">float</span> a_val <span class="token operator">=</span> w <span class="token operator">*</span> w <span class="token operator">/</span> <span class="token number">12.0f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> b_val <span class="token operator">=</span> h <span class="token operator">*</span> h <span class="token operator">/</span> <span class="token number">12.0f</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> cos_r <span class="token operator">=</span> <span class="token function">cosf</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">float</span> sin_r <span class="token operator">=</span> <span class="token function">sinf</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>

    a <span class="token operator">=</span> a_val <span class="token operator">*</span> cos_r <span class="token operator">*</span> cos_r <span class="token operator">+</span> b_val <span class="token operator">*</span> sin_r <span class="token operator">*</span> sin_r<span class="token punctuation">;</span>
    b <span class="token operator">=</span> a_val <span class="token operator">*</span> sin_r <span class="token operator">*</span> sin_r <span class="token operator">+</span> b_val <span class="token operator">*</span> cos_r <span class="token operator">*</span> cos_r<span class="token punctuation">;</span>
    c <span class="token operator">=</span> <span class="token punctuation">(</span>a_val <span class="token operator">-</span> b_val<span class="token punctuation">)</span> <span class="token operator">*</span> sin_r <span class="token operator">*</span> cos_r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> __device__ <span class="token keyword">float</span> <span class="token function">box_probiou</span><span class="token punctuation">(</span>
    <span class="token keyword">float</span> cx1<span class="token punctuation">,</span> <span class="token keyword">float</span> cy1<span class="token punctuation">,</span> <span class="token keyword">float</span> w1<span class="token punctuation">,</span> <span class="token keyword">float</span> h1<span class="token punctuation">,</span> <span class="token keyword">float</span> r1<span class="token punctuation">,</span>
    <span class="token keyword">float</span> cx2<span class="token punctuation">,</span> <span class="token keyword">float</span> cy2<span class="token punctuation">,</span> <span class="token keyword">float</span> w2<span class="token punctuation">,</span> <span class="token keyword">float</span> h2<span class="token punctuation">,</span> <span class="token keyword">float</span> r2<span class="token punctuation">,</span>
    <span class="token keyword">float</span> eps <span class="token operator">=</span> <span class="token number">1e-7</span>
<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    <span class="token comment">// Calculate the prob iou between oriented bounding boxes, https://arxiv.org/pdf/2106.06072v1.pdf.</span>
    <span class="token keyword">float</span> a1<span class="token punctuation">,</span> b1<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> c2<span class="token punctuation">;</span>
    <span class="token function">convariance_matrix</span><span class="token punctuation">(</span>w1<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> r1<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> b1<span class="token punctuation">,</span> c1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">convariance_matrix</span><span class="token punctuation">(</span>w2<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> c2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> t1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">powf</span><span class="token punctuation">(</span>cy1 <span class="token operator">-</span> cy2<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">powf</span><span class="token punctuation">(</span>cx1 <span class="token operator">-</span> cx2<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">powf</span><span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> t2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>cx2 <span class="token operator">-</span> cx1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>cy1 <span class="token operator">-</span> cy2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">powf</span><span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> t3 <span class="token operator">=</span> <span class="token function">logf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">powf</span><span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> <span class="token function">sqrtf</span><span class="token punctuation">(</span><span class="token function">fmaxf</span><span class="token punctuation">(</span>a1 <span class="token operator">*</span> b1 <span class="token operator">-</span> c1 <span class="token operator">*</span> c1<span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">sqrtf</span><span class="token punctuation">(</span><span class="token function">fmaxf</span><span class="token punctuation">(</span>a2 <span class="token operator">*</span> b2 <span class="token operator">-</span> c2 <span class="token operator">*</span> c2<span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">float</span> bd <span class="token operator">=</span> <span class="token number">0.25f</span> <span class="token operator">*</span> t1 <span class="token operator">+</span> <span class="token number">0.5f</span> <span class="token operator">*</span> t2 <span class="token operator">+</span> <span class="token number">0.5f</span> <span class="token operator">*</span> t3<span class="token punctuation">;</span>
    bd <span class="token operator">=</span> <span class="token function">fmaxf</span><span class="token punctuation">(</span><span class="token function">fminf</span><span class="token punctuation">(</span>bd<span class="token punctuation">,</span> <span class="token number">100.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span> eps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> hd <span class="token operator">=</span> <span class="token function">sqrtf</span><span class="token punctuation">(</span><span class="token number">1.0f</span> <span class="token operator">-</span> <span class="token function">expf</span><span class="token punctuation">(</span><span class="token operator">-</span>bd<span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">-</span> hd<span class="token punctuation">;</span>    
<span class="token punctuation">}</span>

<span class="token keyword">static</span> __global__ <span class="token keyword">void</span> <span class="token function">nms_kernel</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token operator">*</span> bboxes<span class="token punctuation">,</span> <span class="token keyword">int</span> max_objects<span class="token punctuation">,</span> <span class="token keyword">float</span> threshold<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    <span class="token keyword">int</span> position <span class="token operator">=</span> <span class="token punctuation">(</span>blockDim<span class="token punctuation">.</span>x <span class="token operator">*</span> blockIdx<span class="token punctuation">.</span>x <span class="token operator">+</span> threadIdx<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">*</span>bboxes<span class="token punctuation">,</span> max_objects<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">&gt;=</span> count<span class="token punctuation">)</span> 
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    
    <span class="token comment">// cx, cy, w, h, angle, confidence, class_label, keepflag</span>
    <span class="token keyword">float</span><span class="token operator">*</span> pcurrent <span class="token operator">=</span> bboxes <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> position <span class="token operator">*</span> NUM_BOX_ELEMENT<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">float</span><span class="token operator">*</span> pitem <span class="token operator">=</span> bboxes <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> i <span class="token operator">*</span> NUM_BOX_ELEMENT<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> position <span class="token operator">||</span> pcurrent<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">!=</span> pitem<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>pitem<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> pcurrent<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pitem<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">==</span> pcurrent<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> position<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token keyword">float</span> iou <span class="token operator">=</span> <span class="token function">box_probiou</span><span class="token punctuation">(</span>
                pcurrent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pcurrent<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pcurrent<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pcurrent<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pcurrent<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                pitem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    pitem<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    pitem<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    pitem<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    pitem<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>iou <span class="token operator">&gt;</span> threshold<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                pcurrent<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 1=keep, 0=ignore</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre> 
<p>关于 NMS 的具体实现也是启动多个线程，每个线程处理一个框，如果剩余框中的置信度大于当前线程中处理的框，则计算两个框的 ProbIoU，通过 ProbIoU 值判断是否保留该框。相比于 CPU 版的 NMS 应该是少套了一层循环，另外一层循环是通过 CUDA 上线程的并行操作处理的，代码参考自：<a href="https://github.com/shouxieai/tensorRT_Pro/blob/main/src/application/app_yolo/yolo_decode.cu#L81">yolo_decode.cu#L81</a></p> 
<h4><a id="4_YOLOv8OBB_851"></a>4. YOLOv8-OBB推理</h4> 
<blockquote> 
 <p>通过上面对 YOLOv8-OBB 的预处理和后处理分析之后，整个推理过程就显而易见了。C++ 上 YOLOv8-OBB 的预处理部分可直接沿用 YOLOv5 的预处理，后处理中的 decode 解码部分和 NMS 部分需要简单修改。</p> 
</blockquote> 
<p>我们在终端执行如下指令即可完成推理（<strong>注意！完整流程博主会在后续内容介绍，这边只是简单演示</strong>）</p> 
<pre><code class="prism language-shell"><span class="token function">make</span> yolo_obb
</code></pre> 
<p>编译图解如下所示：</p> 
<p><img src="https://images2.imgbox.com/48/3d/OhFnKMzL_o.png" alt="在这里插入图片描述"></p> 
<p>推理结果如下图所示：</p> 
<p><img src="https://images2.imgbox.com/41/75/iTtff07O_o.jpg" alt="在这里插入图片描述"></p> 
<p>至此，我们在 C++ 上面完成了 YOLOv8-OBB 的整个推理过程，下面我们将完整的走一遍流程。</p> 
<h3><a id="YOLOv8OBB_873"></a>三、YOLOv8-OBB部署</h3> 
<blockquote> 
 <p>博主新建了一个仓库 <a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">tensorRT_Pro-YOLOv8</a>，该仓库基于 <a href="https://github.com/shouxieai/tensorRT_Pro">shouxieai/tensorRT_Pro</a>，并进行了调整以支持 YOLOv8 的各项任务，目前已支持分类、检测、分割、姿态点估计、旋转目标检测任务。</p> 
 <p>下面我们就来具体看看如何利用 tensorRT_Pro-YOLOv8 这个 repo 完成 YOLOv8-OBB 的推理。</p> 
</blockquote> 
<h4><a id="1__879"></a>1. 源码下载</h4> 
<p>tensorRT_Pro-YOLOv8 的代码可以直接从 GitHub 官网上下载，源码下载地址是 <a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8</a>，Linux 下代码克隆指令如下：</p> 
<pre><code class="prism language-shell"><span class="token function">git</span> clone https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8
</code></pre> 
<p>也可手动点击下载，点击右上角的 <code>Code</code> 按键，将代码下载下来。至此整个项目就已经准备好了。也可以点击 <a href="https://pan.baidu.com/s/1cWQbfv26XaWBf2et5vV9yQ" rel="nofollow">here【pwd:yolo】</a> 下载博主准备好的源代码（<strong>注意代码下载于 2024/1/21 日，若有改动请参考最新</strong>）</p> 
<h4><a id="2__889"></a>2. 环境配置</h4> 
<blockquote> 
 <p>需要使用的软件环境有 <strong>TensorRT、CUDA、cuDNN、OpenCV、Protobuf</strong>，所有软件环境的安装可以参考 <a href="https://blog.csdn.net/qq_40672115/article/details/130255299">Ubuntu20.04软件安装大全</a>，这里不再赘述，需要各位看官自行配置好相关环境😄，外网访问较慢，这里提供下博主安装过程中的软件安装包下载链接 <a href="https://pan.baidu.com/s/1XPe6xd6q1TLDMlVO-84KXA" rel="nofollow">Baidu Drive【pwd:yolo】</a>🚀🚀🚀</p> 
 <p>tensorRT_Pro-YOLOv8 提供 CMakeLists.txt 和 Makefile 两种方式编译，<strong>二者选一即可</strong></p> 
</blockquote> 
<h5><a id="21_CMakeListstxt_895"></a>2.1 配置CMakeLists.txt</h5> 
<p>主要修改五处</p> 
<p><strong>1.</strong> 修改第 13 行，修改 OpenCV 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>OpenCV_DIR   <span class="token string">"/usr/local/include/opencv4/"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>2.</strong> 修改第 15 行，修改 CUDA 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>CUDA_TOOLKIT_ROOT_DIR     <span class="token string">"/usr/local/cuda-11.6"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>3.</strong> 修改第 16 行，修改 cuDNN 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>CUDNN_DIR    <span class="token string">"/usr/local/cudnn8.4.0.27-cuda11.6"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>4.</strong> 修改第 17 行，修改 tensorRT 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>TENSORRT_DIR <span class="token string">"/opt/TensorRT-8.4.1.5"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>5.</strong> 修改第 20 行，修改 protobuf 路径</p> 
<pre><code class="prism language-cpp"><span class="token function">set</span><span class="token punctuation">(</span>PROTOBUF_DIR <span class="token string">"/home/jarvis/protobuf"</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="22_Makefile_929"></a>2.2 配置Makefile</h5> 
<p>主要修改五处</p> 
<p><strong>1.</strong> 修改第 4 行，修改 protobuf 路径</p> 
<pre><code class="prism language-cpp">lean_protobuf  <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>home<span class="token operator">/</span>jarvis<span class="token operator">/</span>protobuf
</code></pre> 
<p><strong>2.</strong> 修改第 5 行，修改 tensorRT 路径</p> 
<pre><code class="prism language-cpp">lean_tensor_rt <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>opt<span class="token operator">/</span>TensorRT<span class="token operator">-</span><span class="token number">8.4</span><span class="token punctuation">.</span><span class="token number">1.5</span>
</code></pre> 
<p><strong>3.</strong> 修改第 6 行，修改 cuDNN 路径</p> 
<pre><code class="prism language-cpp">lean_cudnn     <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cudnn8<span class="token punctuation">.</span><span class="token number">4.0</span><span class="token punctuation">.</span><span class="token number">27</span><span class="token operator">-</span>cuda11<span class="token punctuation">.</span><span class="token number">6</span>
</code></pre> 
<p><strong>4.</strong> 修改第 7 行，修改 OpenCV 路径</p> 
<pre><code class="prism language-cpp">lean_opencv    <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local
</code></pre> 
<p><strong>5.</strong> 修改第 8 行，修改 CUDA 路径</p> 
<pre><code class="prism language-cpp">lean_cuda      <span class="token operator">:</span><span class="token operator">=</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>cuda<span class="token operator">-</span><span class="token number">11.6</span>
</code></pre> 
<h4><a id="3_ONNX_963"></a>3. ONNX导出</h4> 
<p>导出细节可以查看之前的内容，这边不再赘述。记得将导出的 ONNX 模型放在 tensorRT_Pro-YOLOv8/workspace 文件夹下。</p> 
<h4><a id="4__967"></a>4. 源码修改</h4> 
<blockquote> 
 <p>如果你想推理自己训练的模型还需要修改下源代码，YOLOv8-OBB 模型的推理代码主要在 <strong>app_yolo_obb.cpp</strong> 文件中，我们就只需要修改这一个文件中的内容即可，源码修改较简单主要有以下几点：</p> 
</blockquote> 
<ul><li><strong>1.</strong> <strong>app_yolo_obb.cpp 249行，“yolov8s-obb” 修改为你导出的 ONNX 模型名</strong></li><li><strong>2.</strong> <strong>app_yolo_obb.cpp 10行， 将 dotalabels 数组中的类别名称修改为你训练的类别</strong></li></ul> 
<p>具体修改示例如下：</p> 
<pre><code class="prism language-cpp"><span class="token function">test</span><span class="token punctuation">(</span>TRT<span class="token double-colon punctuation">::</span>Mode<span class="token double-colon punctuation">::</span>FP32<span class="token punctuation">,</span> <span class="token string">"best"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 修改1 249行"yolov8s-obb"改成"best"</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dotalabels<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"car"</span><span class="token punctuation">,</span> <span class="token string">"aireplabe"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>	<span class="token comment">// 修改2 10行修改检测类别，为自训练模型的类别名称</span>
</code></pre> 
<h4><a id="5__982"></a>5. 运行</h4> 
<p>OK！源码修改好了，Makefile 编译文件也搞定了，ONNX 模型也准备好了，现在可以编译运行了，直接在终端执行如下指令即可：</p> 
<pre><code class="prism language-shell"><span class="token function">make</span> yolo_obb
</code></pre> 
<p>编译过程如下所示：</p> 
<p><img src="https://images2.imgbox.com/06/d1/mVORX4lE_o.png" alt="在这里插入图片描述"></p> 
<p>编译运行成功后在 workspace 文件夹下会生成 engine 文件 <strong>yolov8s-obb.FP32.trtmodel</strong> 用于模型推理，同时它还会生成 <strong>yolov8s-obb_YoloV8-OBB_FP32_result</strong> 文件夹，该文件夹下保存了推理的图片。</p> 
<p>模型推理效果如下图所示：</p> 
<p><img src="https://images2.imgbox.com/27/91/1T3GHTne_o.jpg" alt="在这里插入图片描述"></p> 
<p>OK！以上就是使用 tensorRT_Pro-YOLOv8 推理 YOLOv8-OBB 的大致流程，若有问题，欢迎各位看官批评指正。</p> 
<h3><a id="_ProbIoU_1004"></a>四. 拓展-ProbIoU</h3> 
<blockquote> 
 <p>这里简单聊聊 ProbIoU 以及论文中的公式是如何跟代码对应上的</p> 
 <p>论文地址：<a href="https://arxiv.org/abs/2106.06072" rel="nofollow">https://arxiv.org/abs/2106.06072</a></p> 
 <p>以下内容 Copy 自 <a href="https://bbs.huaweicloud.com/blogs/289592" rel="nofollow">论文解读系列十九：用于目标检测的高斯检测框与ProbIoU</a>，建议大家阅读原文</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/b5/8b/LAOTogtV_o.png" alt="在这里插入图片描述"></p> 
<p>现有目标检测的改进方向主要集中在：训练更大数据集（LVIS dataset）、处理类别不均衡、提出更好的 backbones、建立长距离相互作用模型（Transformers，LambdaNetworks）、分类和检测框的权衡分析，对于检测框的呈现形式相关研究较少。现有目标检测任务中以水平框（<strong>HBB</strong>）和旋转框（<strong>OBB</strong>）为主，呈现形式还是矩形或者类矩形。而现有目标距离及相似性计算方式包括：IoU（Intersection over Union）、GIoU（Generalized IoU）、DIoU（Distance IoU）、PIoU（Pixel IoU），Gaussian Wasserstein Distance（GWD）。</p> 
<p>现有 <strong>OBB</strong> 算法在细长及旋转物体检测问题相对于 <strong>HBB</strong> 算法有所提高，但是与目标语义分割的贴合度不高，因此，本文提出更加贴合语义分割形式的分割呈现形式及对应的目标相似度计算方法。</p> 
<p>该论文贡献如下：</p> 
<ul><li>提出一种新的<strong>椭圆形</strong>目标检测框（Gaussian Bounding Boxes，<strong>GBB</strong>） 
  <ul><li>GBB 与目标的语义分割 mask 形状更为接近，更加贴合非矩形目标，在非矩形目标检测效果优于 HBB 和 OBB</li></ul> </li><li>提出一种新的目标相似度的计算方法（Probabilistic IoU，<strong>ProbIoU</strong>） 
  <ul><li>基于 Hellinger Distance 的 ProbIoU，考虑了 2D 高斯分布的特点，满足所有距离度量标准，能够表示不同分布间的真实距离，且处处可微，能提升 OBB 和 HBB 目标检测效果。</li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/76/cd/FinXuS1x_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="1_Gaussian_Bounding_BoxesGBB_1029"></a>1. Gaussian Bounding Boxes(GBB)</h4> 
<p>为在二维区域确定一个二维高斯分布，需要计算其均值 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         μ 
        
       
      
        \mu 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">μ</span></span></span></span></span> 和协方差矩阵 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Σ 
        
       
      
        \Sigma 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord">Σ</span></span></span></span></span>，其中 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         μ 
        
       
         = 
        
       
         ( 
        
        
        
          x 
         
        
          0 
         
        
       
         , 
        
        
        
          y 
         
        
          0 
         
        
        
        
          ) 
         
        
          T 
         
        
       
      
        \mu = (x_0,y_0)^T 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">μ</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.0913em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span></span></span></span></span>，协方差矩阵 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Σ 
        
       
      
        \Sigma 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord">Σ</span></span></span></span></span> 可通过下面的公式进行计算：</p> 
<p><img src="https://images2.imgbox.com/d2/40/jB9u1ygx_o.png" alt="在这里插入图片描述"></p> 
<p>在目标检测任务中可直接设置 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
        
        
          x 
         
        
          0 
         
        
       
         , 
        
        
        
          y 
         
        
          0 
         
        
       
         , 
        
       
         a 
        
       
         , 
        
       
         b 
        
       
         , 
        
       
         c 
        
       
         ) 
        
       
      
        (x_0,y_0,a,b,c) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">c</span><span class="mclose">)</span></span></span></span></span> 作为目标检测回归任务中的参数，也可将回归任务中参数表示为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
        
        
          x 
         
        
          0 
         
        
       
         , 
        
        
        
          y 
         
        
          0 
         
        
       
         , 
        
        
        
          a 
         
        
          ′ 
         
        
       
         , 
        
        
        
          b 
         
        
          ′ 
         
        
       
         , 
        
       
         0 
        
       
         ) 
        
       
      
        (x_0,y_0,a',b',0) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0019em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span></span>，而后者的形式更加符合现有旋转检测框的输出形式</p> 
<p>水平框及旋转框向高斯框转换中遵循以下假设：目标区域为二维二元区域 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Ω 
        
       
      
        \Omega 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord">Ω</span></span></span></span></span>，且 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Ω 
        
       
      
        \Omega 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord">Ω</span></span></span></span></span> 符合均匀概率分布，则该分布的均值 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         μ 
        
       
      
        \mu 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">μ</span></span></span></span></span> 和协方差矩阵 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Σ 
        
       
      
        \Sigma 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord">Σ</span></span></span></span></span> 可通过如下公式进行计算：</p> 
<p><img src="https://images2.imgbox.com/9a/63/YvAWJ0hj_o.png" alt="在这里插入图片描述"></p> 
<p>其中 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         N 
        
       
      
        N 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">N</span></span></span></span></span> 表示区域 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Ω 
        
       
      
        \Omega 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord">Ω</span></span></span></span></span> 的面积</p> 
<p><strong>HBB</strong> 转 <strong>GBB</strong></p> 
<p>对于 <strong>HBB</strong>，其二元区域 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Ω 
        
       
      
        \Omega 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord">Ω</span></span></span></span></span> 为以 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
        
        
          x 
         
        
          0 
         
        
       
         , 
        
        
        
          y 
         
        
          0 
         
        
       
         ) 
        
       
      
        (x_0,y_0) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 为中心，高为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         H 
        
       
      
        H 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span></span></span></span></span>，宽为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         W 
        
       
      
        W 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">W</span></span></span></span></span> 的矩形区域，因此 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         μ 
        
       
         = 
        
       
         ( 
        
        
        
          x 
         
        
          0 
         
        
       
         , 
        
        
        
          y 
         
        
          0 
         
        
       
         ) 
        
       
      
        \mu = (x_0,y_0) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">μ</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，它的协方差矩阵 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         Σ 
        
       
      
        \Sigma 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord">Σ</span></span></span></span></span> 可通过下面的公式进行计算：</p> 
<p><img src="https://images2.imgbox.com/1c/91/B5VMYVcj_o.png" alt="在这里插入图片描述"></p> 
<p>因此可以得出 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         a 
        
       
         = 
        
        
         
         
           W 
          
         
           2 
          
         
        
          12 
         
        
       
      
        a = \frac{W^2}{12} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.3629em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0179em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         b 
        
       
         = 
        
        
         
         
           H 
          
         
           2 
          
         
        
          12 
         
        
       
      
        b = \frac{H^2}{12} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.3629em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0179em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0813em;">H</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         c 
        
       
         = 
        
       
         0 
        
       
      
        c = 0 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0</span></span></span></span></span>，如上述公式所示，转换后的高斯框也可以转换为水平框，该过程是可逆的</p> 
<p><strong>OBB</strong> 转 <strong>GBB</strong></p> 
<p><strong>OBB</strong> 转 <strong>GBB</strong> 需要计算 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
        
        
          a 
         
        
          ′ 
         
        
       
         , 
        
        
        
          b 
         
        
          ′ 
         
        
       
         , 
        
       
         θ 
        
       
         ) 
        
       
      
        (a',b',\theta) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0019em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">θ</span><span class="mclose">)</span></span></span></span></span>，如下图所示，其中方差 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          a 
         
        
          ′ 
         
        
       
      
        a' 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7519em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> 和 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          b 
         
        
          ′ 
         
        
       
      
        b' 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7519em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> 可以通过将旋转框转化为水平框进行计算，其协方差矩阵可通过下面的公式进行计算：</p> 
<p><img src="https://images2.imgbox.com/77/ec/W49fY88p_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/6c/f0/qBiOLB8V_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2_ProbIoU_1064"></a>2. ProbIoU</h4> 
<p><strong>Bhattacharyya Distance (BD)</strong></p> 
<p>为计算不同 GBB 间的相似度，本文首先采用了 Bhattacharyya Coefficient（BC），两个概率密度函数 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         p 
        
       
         ( 
        
       
         x 
        
       
         ) 
        
       
      
        p(x) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span> 和 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         q 
        
       
         ( 
        
       
         x 
        
       
         ) 
        
       
      
        q(x) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">q</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span> 间的 BC 按下面的公式进行计算：</p> 
<p><img src="https://images2.imgbox.com/71/99/DHz0ysYQ_o.png" alt="在这里插入图片描述"></p> 
<p>其中 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          B 
         
        
          C 
         
        
       
         ( 
        
       
         p 
        
       
         , 
        
       
         q 
        
       
         ) 
        
       
         ∈ 
        
       
         [ 
        
       
         0 
        
       
         , 
        
       
         1 
        
       
         ] 
        
       
      
        B_{C}(p,q)\in[0,1] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0502em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">C</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>，当且仅当两个分布相同时 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          B 
         
        
          C 
         
        
       
         ( 
        
       
         p 
        
       
         , 
        
       
         q 
        
       
         ) 
        
       
         = 
        
       
         1 
        
       
      
        B_{C}(p,q)=1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0502em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">C</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span></p> 
<p>基于上述 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          B 
         
        
          C 
         
        
       
         ( 
        
       
         p 
        
       
         , 
        
       
         q 
        
       
         ) 
        
       
      
        B_{C}(p,q) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0502em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">C</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">q</span><span class="mclose">)</span></span></span></span></span> 可以得到不同分布间的巴氏距离（Bhattacharyya Distance, BD），两个概率密度函数 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         p 
        
       
         ( 
        
       
         x 
        
       
         ) 
        
       
      
        p(x) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span> 和 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         q 
        
       
         ( 
        
       
         x 
        
       
         ) 
        
       
      
        q(x) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">q</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span> 间的 BD 按下面的公式进行计算：</p> 
<p><img src="https://images2.imgbox.com/94/83/eYQ1roRc_o.png" alt="在这里插入图片描述"></p> 
<p>当 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         p 
        
       
         ∼ 
        
       
         N 
        
       
         ( 
        
        
        
          μ 
         
        
          1 
         
        
       
         , 
        
        
        
          Σ 
         
        
          1 
         
        
       
         ) 
        
       
      
        p\sim\mathcal{N}(\boldsymbol{\mu}_{1},\Sigma_{1}) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathcal" style="margin-right: 0.1474em;">N</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.207em;"><span class="" style="top: -2.4559em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2441em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         q 
        
       
         ∼ 
        
       
         N 
        
       
         ( 
        
        
        
          μ 
         
        
          2 
         
        
       
         , 
        
        
        
          Σ 
         
        
          2 
         
        
       
         ) 
        
       
      
        q\sim\mathcal{N}(\boldsymbol{\mu}_{2},\Sigma_{2}) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">q</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathcal" style="margin-right: 0.1474em;">N</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">μ</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.207em;"><span class="" style="top: -2.4559em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2441em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 且目标检测中实际问题为二维向量及矩阵，巴氏距离 BD 可通过如下公式进行计算：</p> 
<p><img src="https://images2.imgbox.com/b2/40/3xIr9tPR_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/1f/63/YtW7XqV0_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/38/37/hGzgwFCg_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/f9/c8/2kQlpP9P_o.png" alt="在这里插入图片描述"></p> 
<p><strong>Hellinger Distance (HD)</strong></p> 
<p>由于 <strong>Bhattacharyya Distance</strong> 不满足三角不等式，所以它并不是真实的距离，为此我们需要采用 <strong>Hellinger Distance（HD）</strong>，其计算公式如下：</p> 
<p><img src="https://images2.imgbox.com/8e/9b/2oHrW7QL_o.png" alt="在这里插入图片描述"></p> 
<p>其中 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          H 
         
        
          D 
         
        
       
         ( 
        
       
         p 
        
       
         , 
        
       
         q 
        
       
         ) 
        
       
         ∈ 
        
       
         [ 
        
       
         0 
        
       
         , 
        
       
         1 
        
       
         ] 
        
       
      
        H_{D}(p,q)\in[0,1] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0813em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">D</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>，当且仅当两个分布相同时 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          H 
         
        
          D 
         
        
       
         ( 
        
       
         p 
        
       
         , 
        
       
         q 
        
       
         ) 
        
       
         = 
        
       
         0 
        
       
      
        H_{D}(p,q)=0 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0813em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">D</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0</span></span></span></span></span></p> 
<p>基于上述 <strong>Hellinger Distance （HD）</strong>，本文提出高斯分布相似性计算方法 ProbIoU，其具体计算公式如下：</p> 
<p><img src="https://images2.imgbox.com/fe/19/SFvAJjve_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3__1108"></a>3. 代码</h4> 
<p>我们先来看看 ProbIoU 的计算代码，如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">probiou</span><span class="token punctuation">(</span>obb1<span class="token punctuation">,</span> obb2<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e-7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Calculate the prob iou between oriented bounding boxes, https://arxiv.org/pdf/2106.06072v1.pdf.</span>
    <span class="token keyword">def</span> <span class="token function">covariance_matrix</span><span class="token punctuation">(</span>obb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Extract elements</span>
        w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> r <span class="token operator">=</span> obb<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
        a <span class="token operator">=</span> <span class="token punctuation">(</span>w <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">12</span>
        b <span class="token operator">=</span> <span class="token punctuation">(</span>h <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">12</span>

        cos_r <span class="token operator">=</span> torch<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sin_r <span class="token operator">=</span> torch<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># Calculate covariance matrix elements</span>
        a_val <span class="token operator">=</span> a <span class="token operator">*</span> cos_r <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> b <span class="token operator">*</span> sin_r <span class="token operator">**</span> <span class="token number">2</span>
        b_val <span class="token operator">=</span> a <span class="token operator">*</span> sin_r <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> b <span class="token operator">*</span> cos_r <span class="token operator">**</span> <span class="token number">2</span>
        c_val <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">-</span> b<span class="token punctuation">)</span> <span class="token operator">*</span> sin_r <span class="token operator">*</span> cos_r

        <span class="token keyword">return</span> a_val<span class="token punctuation">,</span> b_val<span class="token punctuation">,</span> c_val

    a1<span class="token punctuation">,</span> b1<span class="token punctuation">,</span> c1 <span class="token operator">=</span> covariance_matrix<span class="token punctuation">(</span>obb1<span class="token punctuation">)</span>
    a2<span class="token punctuation">,</span> b2<span class="token punctuation">,</span> c2 <span class="token operator">=</span> covariance_matrix<span class="token punctuation">(</span>obb2<span class="token punctuation">)</span>

    x1<span class="token punctuation">,</span> y1 <span class="token operator">=</span> obb1<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> obb2<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>

    t1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y1 <span class="token operator">-</span> y2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x1 <span class="token operator">-</span> x2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> x1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>y1 <span class="token operator">-</span> y2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>
    t3 <span class="token operator">=</span> torch<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> a2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>b1 <span class="token operator">+</span> b2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>c1 <span class="token operator">+</span> c2<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>a1 <span class="token operator">*</span> b1 <span class="token operator">-</span> c1 <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>a2 <span class="token operator">*</span> b2 <span class="token operator">-</span> c2 <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>

    bd <span class="token operator">=</span> <span class="token number">0.25</span> <span class="token operator">*</span> t1 <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> t2 <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> t3
    hd <span class="token operator">=</span> torch<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span>torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>bd<span class="token punctuation">,</span> eps<span class="token punctuation">,</span> <span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">-</span> hd
</code></pre> 
<p>首先我们需要将 <strong>OBB</strong> 转换为 <strong>GBB</strong>，需要利用下面的公式：</p> 
<p><img src="https://images2.imgbox.com/8c/9d/B2s48k9D_o.png" alt="在这里插入图片描述"></p> 
<p>值得注意的是这里的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          a 
         
        
          ′ 
         
        
       
      
        a' 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7519em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> 和 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          b 
         
        
          ′ 
         
        
       
      
        b' 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7519em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> 需要按照 <strong>HBB</strong> 中的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         a 
        
       
      
        a 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span></span> 和 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         b 
        
       
      
        b 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span></span> 计算，如下所示：</p> 
<p><img src="https://images2.imgbox.com/5e/e3/2854gWz6_o.png" alt="在这里插入图片描述"></p> 
<p>即 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          a 
         
        
          ′ 
         
        
       
         = 
        
        
         
         
           W 
          
         
           2 
          
         
        
          12 
         
        
       
      
        a' = \frac{W^2}{12} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7519em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.3629em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0179em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          b 
         
        
          ′ 
         
        
       
         = 
        
        
         
         
           H 
          
         
           2 
          
         
        
          12 
         
        
       
      
        b' = \frac{H^2}{12} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7519em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.3629em; vertical-align: -0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0179em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0813em;">H</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p> 
<p>以上协方差公式的实现也就是 <strong>covariance_matrix</strong> 函数中的内容</p> 
<p>通过 <strong>covariance_matrix</strong> 我们可以得到 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          a 
         
        
          1 
         
        
       
      
        a_1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          b 
         
        
          1 
         
        
       
      
        b_1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          c 
         
        
          1 
         
        
       
      
        c_1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          a 
         
        
          2 
         
        
       
      
        a_2 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          b 
         
        
          2 
         
        
       
      
        b_2 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          c 
         
        
          2 
         
        
       
      
        c_2 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p>接着我们需要计算两个分布之间的巴式距离 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          B 
         
        
          D 
         
        
       
      
        B_D 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0502em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，其计算公式如下：</p> 
<p><img src="https://images2.imgbox.com/4e/35/ZX37d7gJ_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/0f/bf/oZlGrNUj_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/2b/f0/4tG19QoB_o.png" alt="在这里插入图片描述"></p> 
<p>对应到代码中 t1+t2 就是这里的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          B 
         
        
          1 
         
        
       
      
        B_1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0502em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，t3 就是这里的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          B 
         
        
          2 
         
        
       
      
        B_2 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0502em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，bd 就是这里的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          B 
         
        
          D 
         
        
       
      
        B_D 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0502em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></p> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          B 
         
        
          D 
         
        
       
      
        B_D 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0502em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 计算完之后最后需要计算 ProbIoU，其计算公式如下：</p> 
<p><img src="https://images2.imgbox.com/5b/30/mNiGPJoV_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/40/86/C5jlMnRl_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/94/5a/60HTUfxZ_o.png" alt="在这里插入图片描述"></p> 
<p>对应到代码中 hd 就是这里的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          H 
         
        
          D 
         
        
       
      
        H_D 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0813em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，最终返回的 1-hd 就是需要计算的 ProbIoU 值</p> 
<h3><a id="_1188"></a>结语</h3> 
<blockquote> 
 <p>博主在这里针对 YOLOv8-OBB 的预处理和后处理做了简单分析，同时与大家分享了 C++ 上的实现流程，目的是帮大家理清思路，更好的完成后续的部署工作😄。感谢各位看到最后，创作不易，读后有收获的看官请帮忙点个👍⭐️</p> 
 <p>最后大家如果觉得 <a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">tensorRT_Pro-YOLOv8</a> 这个 repo 对你有帮助的话，不妨点个 ⭐️ 支持一波，这对博主来说非常重要，感谢各位🙏。</p> 
</blockquote> 
<h3><a id="_1194"></a>下载链接</h3> 
<ul><li><a href="https://pan.baidu.com/s/1XPe6xd6q1TLDMlVO-84KXA" rel="nofollow">软件安装包下载链接【提取码:yolo】</a>🚀🚀🚀</li><li><a href="https://pan.baidu.com/s/1cWQbfv26XaWBf2et5vV9yQ" rel="nofollow">源代码、权重、数据集下载链接【提取码:yolo】</a></li></ul> 
<h3><a id="_1199"></a>参考</h3> 
<ul><li><a href="https://github.com/shouxieai/infer">https://github.com/shouxieai/infer</a></li><li><a href="https://github.com/shouxieai/tensorRT_Pro">https://github.com/shouxieai/tensorRT_Pro</a></li><li><a href="https://github.com/ultralytics/ultralytics">https://github.com/ultralytics/ultralytics</a></li><li><a href="https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8">https://github.com/Melody-Zhou/tensorRT_Pro-YOLOv8</a></li><li><a href="https://arxiv.org/pdf/2106.06072v1.pdf" rel="nofollow">Gaussian Bounding Boxes and Probabilistic Intersection-over-Union for Object Detection</a></li><li><a href="https://blog.csdn.net/qq_40672115/article/details/127012332">YOLOv5推理详解及预处理高性能实现</a></li><li><a href="https://bbs.huaweicloud.com/blogs/289592" rel="nofollow">论文解读系列十九：用于目标检测的高斯检测框与ProbIoU</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3c12fb61ffa3cfb7e85a7897ca39bacf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CUDA基础教程文档记录</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/009c69623cad9b75a764422a499a9401/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">周同学文章汇总</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>