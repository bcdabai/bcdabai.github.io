<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>GitLab-CI &#43; Harbor &#43; Kubernetes - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="GitLab-CI &#43; Harbor &#43; Kubernetes" />
<meta property="og:description" content="GitLab &#43; GitLab CI &#43; Harbor &#43; Kubernetes 项目要求 该公司决定采用GitLab &#43; GitLab CI &#43; Harbor &#43; Kubernetes架构来构建CICD环境，以缩短新功能开发上线周期，及时满足客户的需求，实现DevOps的部分流程，来减轻部署运维的负担，实现可视化容器生命周期管理、应用发布和版本迭代更新，请完成CICD环境部署。CICD应用系统架构如下：
环境准备 这里使用项目为2048游戏
项目地址： https://gitee.com/isicman/demo-2048.git
1.节点规划 使用Docker或者使用Kubernetes集群环境，这里使用的是Kubernetes集群环境。
IP地址主机名称主机资源节点名称10.11.121.111k8s-master12G/6VCPUGitLab&#43;GitLab-Runner10.11.121.112k8s-node18G/6VCPUHarbor10.11.121.113k8s-node28G/6VCPUnode 2.查看集群状态 可以通过kubectl cluster-info命令查看当前的集群信息。 通过 kubectl get node查看当前节点数量。
[root@k8s-master ~]# kubectl cluster-info Kubernetes control plane is running at https://10.11.121.111:6443 KubeDNS is running at https://10.11.121.111:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;. [root@k8s-master ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master Ready control-plane,master 25h v1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/17c233bb040690bfd7c6529e03b099c3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-31T20:18:26+08:00" />
<meta property="article:modified_time" content="2023-03-31T20:18:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">GitLab-CI &#43; Harbor &#43; Kubernetes</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="GitLab__GitLab_CI__Harbor__Kubernetes_0"></a>GitLab + GitLab CI + Harbor + Kubernetes</h2> 
<h3><a id="_3"></a>项目要求</h3> 
<p>该公司决定采用<code>GitLab + GitLab CI + Harbor + Kubernetes</code>架构来构建CICD环境，以缩短新功能开发上线周期，及时满足客户的需求，实现DevOps的部分流程，来减轻部署运维的负担，实现可视化容器生命周期管理、应用发布和版本迭代更新，请完成CICD环境部署。CICD应用系统架构如下：</p> 
<p><img src="https://images2.imgbox.com/27/02/oLbw54Mw_o.png" alt="image-20220425085103011"></p> 
<h3><a id="_9"></a>环境准备</h3> 
<p>这里使用项目为2048游戏</p> 
<p><strong>项目地址：</strong> https://gitee.com/isicman/demo-2048.git</p> 
<h4><a id="1_17"></a>1.节点规划</h4> 
<p>使用Docker或者使用Kubernetes集群环境，这里使用的是Kubernetes集群环境。</p> 
<table><thead><tr><th>IP地址</th><th>主机名称</th><th>主机资源</th><th>节点名称</th></tr></thead><tbody><tr><td>10.11.121.111</td><td>k8s-master</td><td>12G/6VCPU</td><td>GitLab+GitLab-Runner</td></tr><tr><td>10.11.121.112</td><td>k8s-node1</td><td>8G/6VCPU</td><td>Harbor</td></tr><tr><td>10.11.121.113</td><td>k8s-node2</td><td>8G/6VCPU</td><td>node</td></tr></tbody></table> 
<h4><a id="2_29"></a>2.查看集群状态</h4> 
<p>可以通过<code>kubectl cluster-info</code>命令查看当前的集群信息。 通过 <code>kubectl get node</code>查看当前节点数量。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl cluster-info </span>
Kubernetes control plane is running at https://10.11.121.111:6443
KubeDNS is running at https://10.11.121.111:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use <span class="token string">'kubectl cluster-info dump'</span><span class="token builtin class-name">.</span>

<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get node </span>
NAME         STATUS   ROLES                  AGE   VERSION
k8s-master   Ready    control-plane,master   25h   v1.20.0
k8s-node1    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 25h   v1.20.0
k8s-node2    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 25h   v1.20.0
</code></pre> 
<h3><a id="GitLab_49"></a>部署GitLab</h3> 
<h4><a id="1GitLab_51"></a>1.GitLab概述</h4> 
<p>GitLab 是利用 Ruby on Rails 一个开源的版本管理系统，实现一个自托管的 Git 项目仓库，可通过 Web 界面进行访问公开的或者私人项目。它拥有与 Github 类似的功能，能够浏览源代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库。团队成员可以利用内置的简单聊天程序 (Wall) 进行交流。它还提供一个代码片段收集功能可以轻松实现代码复用，便于日后有需要的时候进行查找。</p> 
<h4><a id="2GitLab_57"></a>2.GitLab部署方式</h4> 
<p>GitLab 可以安装在大多数 GNU/Linux 发行版中，并与多个云提供商一起安装。要从 GitLab 获得最佳体验，您必须平衡性能、可靠性、易于管理（备份、升级和故障排除）以及托管成本。</p> 
<p>目前比较常见的部署方式有如下三种：</p> 
<ul><li>直接安装在操作系统上，例如： <code>Mac/Windows/Linux</code></li><li>通过容器的方式安装，例如： <code>Docker、Kubernetes</code></li><li>使用Helm包安装： <code>Chart包的方式</code></li></ul> 
<h4><a id="3DockerGitLab_69"></a>3.Docker部署GitLab</h4> 
<p>1.使用Docker命令部署Gitlab，由于Gitlab的镜像大概有几个G，所以需要等待很久的时间，直到完全启动。</p> 
<p>参数解析：</p> 
<p><code>hostname</code> 域名 或 ip</p> 
<p><code>publish 、-p</code> 端口映射</p> 
<p><code>restart</code> 重启方式</p> 
<p><code>volume、-v</code> 目录挂载</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># docker run -d \</span>
  --hostname <span class="token number">10.11</span>.121.111 <span class="token punctuation">\</span>
  -p <span class="token number">443</span>:443 -p <span class="token number">80</span>:80 -p <span class="token number">222</span>:22 <span class="token punctuation">\</span>
  --name gitlab <span class="token punctuation">\</span>
  --restart always <span class="token punctuation">\</span>
  -v /srv/gitlab/config:/etc/gitlab <span class="token punctuation">\</span>
  -v /srv/gitlab/logs:/var/log/gitlab <span class="token punctuation">\</span>
  -v /srv/gitlab/data:/var/opt/gitlab <span class="token punctuation">\</span>
  gitlab/gitlab-ce:latest
</code></pre> 
<p>2.查看当前的Docker进程。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># docker ps | grep  gitlab </span>
686f123b649c   gitlab/gitlab-ce:latest                             <span class="token string">"/assets/wrapper"</span>        <span class="token number">25</span> hours ago   Up <span class="token number">2</span> hours <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   <span class="token number">0.0</span>.0.0:80-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp, :::80-<span class="token operator">&gt;</span><span class="token number">80</span>/tcp, <span class="token number">0.0</span>.0.0:443-<span class="token operator">&gt;</span><span class="token number">443</span>/tcp, :::443-<span class="token operator">&gt;</span><span class="token number">443</span>/tcp, <span class="token number">0.0</span>.0.0:222-<span class="token operator">&gt;</span><span class="token number">22</span>/tcp, :::222-<span class="token operator">&gt;</span><span class="token number">22</span>/tcp   gitlab
</code></pre> 
<p>3.通过浏览器访问GitLab的页面： http://10.11.121.111</p> 
<p><img src="https://images2.imgbox.com/86/7a/ru1j6YND_o.png" alt="image-20220424223532525"></p> 
<p>4.这里默认的用户是 <code>root</code> ，默认的密码只有24h有效，所以我们需要更改一下密码。</p> 
<p>先查出用户的id，例如下面用户是root id=1</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># docker exec -it gitlab /bin/bash</span>
<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"id"</span>:1,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"Administrator"</span>,<span class="token string">"username"</span><span class="token builtin class-name">:</span><span class="token string">"root"</span>,<span class="token string">"state"</span><span class="token builtin class-name">:</span><span class="token string">"active"</span>,<span class="token string">"avatar_url"</span><span class="token builtin class-name">:</span><span class="token string">"https://www.gravatar.com/avatar/e64c7d89f26bd1972efa854d13d7dd61?s=80<span class="token entity" title="\u0026">\u0026</span>d=identicon"</span>,<span class="token string">"web_url"</span><span class="token builtin class-name">:</span><span class="token string">"http://192.168.0.173/root"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>

root@10:/<span class="token comment"># gitlab-rails console -e production</span>
--------------------------------------------------------------------------------
 Ruby:         ruby <span class="token number">2.7</span>.4p191 <span class="token punctuation">(</span><span class="token number">2021</span>-07-07 revision a21a3b7d23<span class="token punctuation">)</span> <span class="token punctuation">[</span>x86_64-linux<span class="token punctuation">]</span>
 GitLab:       <span class="token number">14.4</span>.1 <span class="token punctuation">(</span>1a23d731c9f<span class="token punctuation">)</span> FOSS
 GitLab Shell: <span class="token number">13.21</span>.1
 PostgreSQL:   <span class="token number">12.7</span>
--------------------------------------------------------------------------------
Loading production environment <span class="token punctuation">(</span>Rails <span class="token number">6.1</span>.4.1<span class="token punctuation">)</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:001:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> <span class="token assign-left variable">u</span><span class="token operator">=</span>User.where<span class="token punctuation">(</span>id:1<span class="token punctuation">)</span>.first
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token comment">#&lt;User id:1 @root&gt;</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:002:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> u.password<span class="token operator">=</span><span class="token string">'00000000'</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"00000000"</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:003:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> u.password_confirmation<span class="token operator">=</span><span class="token string">'00000000'</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"00000000"</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:004:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> u.save<span class="token operator">!</span>
Enqueued ActionMailer::MailDeliveryJob <span class="token punctuation">(</span>Job ID: d7bc1e90-4941-4125-bf90-b018c92b5d73<span class="token punctuation">)</span> to Sidekiq<span class="token punctuation">(</span>mailers<span class="token punctuation">)</span> with arguments: <span class="token string">"DeviseMailer"</span>, <span class="token string">"password_change"</span>, <span class="token string">"deliver_now"</span>, <span class="token punctuation">{<!-- --></span>:args<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token comment">#&lt;GlobalID:0x00007f0b99fbc3a8 @uri=#&lt;URI::GID gid://gitlab/User/1&gt;&gt;]}</span>
<span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
irb<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:005:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> <span class="token builtin class-name">exit</span>
</code></pre> 
<h4><a id="4_141"></a>4.创建项目</h4> 
<p>2.登录Gitlab之后，需要创建一个项目名称叫做<code>demo</code>。</p> 
<p><img src="https://images2.imgbox.com/dc/7e/BU3nIxH8_o.png" alt="image-20220424223745243"></p> 
<p>2.选择<code>public</code>，也是上市的意思，不需要初始化存储库。<br> <img src="https://images2.imgbox.com/dd/dc/jcH78Q87_o.png" alt="image-20220424224043845"></p> 
<p>3.首先我们拉取gitee上的源码到本地，再推送到Gitlab源码托管demo仓库的Master分支。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># git clone https://gitee.com/isicman/demo-2048.git </span>
Cloning into <span class="token string">'demo-2048'</span><span class="token punctuation">..</span>.
Username <span class="token keyword">for</span> <span class="token string">'https://gitee.com'</span><span class="token builtin class-name">:</span> isicman
Password <span class="token keyword">for</span> <span class="token string">'https://isicman@gitee.com'</span><span class="token builtin class-name">:</span> 
remote: Enumerating objects: <span class="token number">71</span>, done.
remote: Counting objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">71</span>/71<span class="token punctuation">)</span>, done.
remote: Compressing objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">59</span>/59<span class="token punctuation">)</span>, done.
remote: Total <span class="token number">71</span> <span class="token punctuation">(</span>delta <span class="token number">21</span><span class="token punctuation">)</span>, reused <span class="token number">0</span> <span class="token punctuation">(</span>delta <span class="token number">0</span><span class="token punctuation">)</span>, pack-reused <span class="token number">0</span>
Unpacking objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">71</span>/71<span class="token punctuation">)</span>, done.
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># cd demo-2048/</span>
<span class="token punctuation">[</span>root@k8s-master demo<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">8</span>
drwxr-xr-x <span class="token number">2</span> root root   <span class="token number">24</span> Apr <span class="token number">23</span> <span class="token number">13</span>:28 Dockerfiles
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1491</span> Apr <span class="token number">23</span> <span class="token number">13</span>:28 pom.xml
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">315</span> Apr <span class="token number">23</span> <span class="token number">13</span>:28 README.md
drwxr-xr-x <span class="token number">3</span> root root   <span class="token number">18</span> Apr <span class="token number">23</span> <span class="token number">13</span>:28 src
drwxr-xr-x <span class="token number">2</span> root root   <span class="token number">28</span> Apr <span class="token number">24</span> <span class="token number">13</span>:06 template

<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git config --global user.name "Administrator"</span>
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git config --global user.email "admin@example.com"</span>
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git init</span>
Reinitialized existing Git repository <span class="token keyword">in</span> /opt/demo-2048/.git/
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git remote rename origin old-origin</span>
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git remote add origin http://10.11.121.111/root/demo.git</span>
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git add .</span>
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git commit -m "Initial commit"</span>
<span class="token comment"># On branch master</span>
nothing to commit, working directory clean
<span class="token punctuation">[</span>root@k8s-master demo-2048<span class="token punctuation">]</span><span class="token comment"># git push -u origin --all</span>
Username <span class="token keyword">for</span> <span class="token string">'http://10.11.121.111'</span><span class="token builtin class-name">:</span> root
Password <span class="token keyword">for</span> <span class="token string">'http://root@10.11.121.111'</span><span class="token builtin class-name">:</span> 
Counting objects: <span class="token number">71</span>, done.
Delta compression using up to <span class="token number">8</span> threads.
Compressing objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">59</span>/59<span class="token punctuation">)</span>, done.
Writing objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">71</span>/71<span class="token punctuation">)</span>, <span class="token number">82.04</span> KiB <span class="token operator">|</span> <span class="token number">0</span> bytes/s, done.
Total <span class="token number">71</span> <span class="token punctuation">(</span>delta <span class="token number">21</span><span class="token punctuation">)</span>, reused <span class="token number">0</span> <span class="token punctuation">(</span>delta <span class="token number">0</span><span class="token punctuation">)</span>
To http://10.11.121.111/root/demo2.git
 * <span class="token punctuation">[</span>new branch<span class="token punctuation">]</span>      master -<span class="token operator">&gt;</span> master
Branch master <span class="token builtin class-name">set</span> up to track remote branch master from origin.
</code></pre> 
<p>4.再次刷新仓库查看，源码已经推送成功。</p> 
<p><img src="https://images2.imgbox.com/1d/4c/h7E5WWUx_o.png" alt="image-20220424224925906"></p> 
<p>5.需要记住这里的Runner的<code>URL和Token</code>，因为后面的GitLab—Runner连接GitLab需要使用到。</p> 
<p>此处我的URL: <code>http://10.11.121.111/</code></p> 
<p>此处我的Token：<code>o4_NCTZvpnViRE7iGxoi</code></p> 
<p><img src="https://images2.imgbox.com/7a/2a/1i1mfgml_o.png" alt="image-20220424225358742"></p> 
<h3><a id="GitLabRunner_214"></a>部署GitLab-Runner</h3> 
<h4><a id="1GitLabCI_216"></a>1.GitLab-CI介绍</h4> 
<p><img src="https://images2.imgbox.com/d1/90/FtuvKQvA_o.png" alt="img"></p> 
<p>GitLab Runner是一个<a href="https://so.csdn.net/so/search?q=%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE&amp;spm=1001.2101.3001.7020">开源项目</a>，用于运行您的作业并将结果发送回GitLab。它与GitLab CI一起使用，GitLab CI是GitLab随附的开源持续集成服务，用于协调作业。</p> 
<p>一般来说，gitlab上已由负责人配置好了<code>gitlab-runner</code>，我们只需要编写好<code>.gitlab.yml</code>文件提交代码即可触发runner进行工作。但对于初学者来说，你可能想能不能在提交代码前在本地先执行<code>.gitlab.yml</code>文件的job，本地调试成功检查没有问题后再进行最终代码的提交，触发服务端的CI流程。答案当然也是可以的。<code>.gitlab.yml</code>文件中定义的job其实是某个服务器中的<code>gitlab-runner</code>在运行，那我们也可以在本地安装好<code>gitlab-runner</code>手动的来执行本地<code>.gitlab.yml</code>中的<code>job</code>。</p> 
<h4><a id="2GitLabRunner_228"></a>2.GitLab-Runner部署方式</h4> 
<p>你几乎可以在任何机器上安装<code>gitlab-runner</code>，安装的方式这里推荐如下几种：</p> 
<ul><li>Linux使用二进制的方式</li><li>Docker中使用容器的方式启动Gitlab—Runner</li><li>Helm包的方式安装Gitlab-Runner</li></ul> 
<p><code>如下我分别使用了两种不同的方式部署Gitlab-Runner，可以选择其中一种。</code></p> 
<h4><a id="3DockerRunner_240"></a>3.Docker部署Runner</h4> 
<p><strong>1.安装gitlab runner</strong></p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># docker run -d --name gitlab-runner --restart always \</span>
  -v /srv/gitlab-runner/config:/etc/gitlab-runner <span class="token punctuation">\</span>
  -v /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation">\</span>
  gitlab/gitlab-runner:latest
</code></pre> 
<p><strong>2.注册gitlab runner</strong></p> 
<p>参数解析：</p> 
<ol><li>gitlab-runner register 是启动register的命令</li><li>GitLab的Runner显示的URL地址： <code>--url</code></li><li>GitLab的Runner显示的Token值： <code>--registration-token</code></li><li>设置Runner的标签： <code>--tag-list</code></li><li>设置CICD构建时可以不启用Tag：<code> --run-untagged</code></li></ol> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># docker run --rm -v /srv/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner register \</span>
  --non-interactive <span class="token punctuation">\</span>
  --executor <span class="token string">"docker"</span> <span class="token punctuation">\</span>
  --docker-image alpine:latest <span class="token punctuation">\</span>
  --url <span class="token string">"http://10.11.121.111/"</span> <span class="token punctuation">\</span>
  --registration-token <span class="token string">"o4_NCTZvpnViRE7iGxoi"</span> <span class="token punctuation">\</span>
  --description <span class="token string">"first-register-runner"</span> <span class="token punctuation">\</span>
  --tag-list <span class="token string">"k8s"</span> <span class="token punctuation">\</span>
  --run-untagged<span class="token operator">=</span><span class="token string">"true"</span> <span class="token punctuation">\</span>
  --locked<span class="token operator">=</span><span class="token string">"false"</span> <span class="token punctuation">\</span>
  --access-level<span class="token operator">=</span><span class="token string">"not_protected"</span> 
  
<span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># docker ps | grep gitlab-runner </span>
3e0a02917540   gitlab/gitlab-runner:latest                         <span class="token string">"/usr/bin/dumb-init …"</span>   <span class="token number">26</span> hours ago   Up <span class="token number">3</span> hours                                                                                                                             gitlab-runner
</code></pre> 
<p><strong>2.查看Gitlab连接情况</strong></p> 
<p>1.进入Gitlab的CICD配置中，找到Runner配置，刷新此页面。</p> 
<p><img src="https://images2.imgbox.com/16/d4/kFsVC8Ec_o.png" alt="image-20220424231601423"></p> 
<p>2.或者在Menu的菜单栏中，找到 <code>Admin</code>, 然后选择 <code>Runner</code>，可以查看到当前的Runner连接情况。</p> 
<p><img src="https://images2.imgbox.com/4d/9f/GiMV36CM_o.png" alt="image-20220424231816380"></p> 
<p><img src="https://images2.imgbox.com/24/26/ubr43GV8_o.png" alt="image-20220424232117034"></p> 
<h4><a id="4HelmRunner_298"></a>4.Helm部署Runner</h4> 
<p><strong>什么是Helm？</strong></p> 
<p>就像 Java 使用 maven；node 使用 npm；python 使用 pip；Linux 使用 yum 或 Apt 一样，不管是什么样的工作，技术人员都会希望有一种资源管理器/包管理器，以此来方便得查找、下载、安装、使用和分发软件包。</p> 
<p>Helm 使用的包格式称为 <code>chart</code>，它是一个描述 Kubernetes 相关资源对象的文件集合。它的技术特点类似 jinja模版，以渲染模版的方式，生成运行一个服务实例所需的一系列资源对象文件，并以此进行服务的发布。通过这种方式，我们也可以十分简单的制作自定义的 chart。</p> 
<p>所以 Helm 即可以说是 <code>K8S的包管理器</code>，它使得我们对于 K8S 的操作不再需要细化到资源对象，而是可以作为一个实例进行管理。不再需要去写 <code>deployment</code> 、<code>service</code> 、<code>ingress</code> 的 yaml，而是可以直接通过 <code>install</code> 命令实现服务实例的安装。</p> 
<p><strong>1.拉取Gitlab-Runner的Chart包</strong></p> 
<p>项目地址：<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgitlab.com%2Fgitlab-org%2Fcharts%2Fgitlab-runner" rel="nofollow">https://gitlab.com/gitlab-org/charts/gitlab-runner</a></p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master gitlab-runner<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">12</span>
-rw-r--r-- <span class="token number">1</span> root root  <span class="token number">369</span> Feb <span class="token number">21</span> 03:39 Chart.yaml
drwxr-xr-x <span class="token number">2</span> root root  <span class="token number">236</span> Apr <span class="token number">24</span> 05:48 templates
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">6452</span> Apr <span class="token number">24</span> 05:47 values.yaml
</code></pre> 
<p><strong>2.配置Chart的模板</strong></p> 
<p>修改Chart包的values.yaml配置如下：</p> 
<ul><li><code>gitlabUrl:</code> 配置Gitlab的URL</li><li><code>runnerRegistrationToken:</code> 配置Gitlab的Runner的Token</li><li><code>namespace:</code> 配置命名空间</li><li><code>tags:</code> 配置标签</li><li><code>cachePath:</code> 配置缓存路径</li></ul> 
<pre><code class="prism language-yaml"><span class="token key atrule">image</span><span class="token punctuation">:</span> gitlab/gitlab<span class="token punctuation">-</span>runner<span class="token punctuation">:</span>alpine<span class="token punctuation">-</span>v11.7.0
<span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
<span class="token key atrule">init</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
  <span class="token key atrule">tag</span><span class="token punctuation">:</span> v1.0
<span class="token key atrule">gitlabUrl</span><span class="token punctuation">:</span> <span class="token string">"http://10.11.121.111"</span>
<span class="token key atrule">runnerRegistrationToken</span><span class="token punctuation">:</span> <span class="token string">"o4_NCTZvpnViRE7iGxoi"</span>
<span class="token key atrule">unregisterRunners</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">concurrent</span><span class="token punctuation">:</span> <span class="token number">10</span>
<span class="token key atrule">checkInterval</span><span class="token punctuation">:</span> <span class="token number">30</span>
<span class="token key atrule">rbac</span><span class="token punctuation">:</span>
  <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">clusterWideAccess</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">metrics</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">:</span><span class="token number">16.04</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"k8s"</span>
  <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
  <span class="token key atrule">cachePath</span><span class="token punctuation">:</span> <span class="token string">"/opt/cache"</span>
  <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token key atrule">builds</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token key atrule">services</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token key atrule">helpers</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> 
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> 
</code></pre> 
<p><strong>3.Helm部署Gitlab-Runner</strong></p> 
<p>使用<code>helm install</code>命令创建安装Gitlab—Runner。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master gitlab-cicd<span class="token punctuation">]</span><span class="token comment"># helm install k8s-runner gitlab-runner/ -n demo</span>
<span class="token punctuation">[</span>root@k8s-master gitlab-cicd<span class="token punctuation">]</span><span class="token comment"># helm list -n demo </span>
NAME      	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART               	APP VERSION
k8s-runner	demo     	<span class="token number">1</span>       	<span class="token number">2022</span>-04-24 <span class="token number">13</span>:13:11.742949709 +0000 UTC	deployed	gitlab-runner-0.1.37	
</code></pre> 
<p><strong>4.查看Gitlab连接情况</strong></p> 
<p>1.查看当前的资源是否创建成功。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get -n demo all</span>
NAME                                            READY   STATUS    RESTARTS   AGE
pod/k8s-runner-gitlab-runner-544f469c44-9m7zw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          155m

NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/k8s-runner-gitlab-runner   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           155m

NAME                                                  DESIRED   CURRENT   READY   AGE
replicaset.apps/k8s-runner-gitlab-runner-544f469c44   <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">1</span>       155m
</code></pre> 
<p>2.回到Gitlab刷新CICD的Runner的配置，新的Gitlab-Runner连接成功。</p> 
<p><img src="https://images2.imgbox.com/73/01/YBKekqww_o.png" alt="image-20220424235055148"></p> 
<p><strong>3.测试GitLab的CICD流水线</strong></p> 
<p>1.进入demo的项目,点击 <code>CI/CD</code>，然后找到<code>Editor</code> ，编写一个流水线脚本，运行job1，输出Hello Word。</p> 
<p><img src="https://images2.imgbox.com/79/f7/FhThmCNG_o.png" alt="image-20220425000049979"></p> 
<p>如上的.gitlab-ci.yaml文件如下：</p> 
<pre><code class="prism language-yml"><span class="token key atrule">stages</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> .pre
  <span class="token punctuation">-</span> build
  <span class="token punctuation">-</span> test
  <span class="token punctuation">-</span> deploy 

<span class="token key atrule">job1</span><span class="token punctuation">:</span> 
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> .pre
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> echo "Hello Word"

<span class="token key atrule">job2</span><span class="token punctuation">:</span> 
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> echo "This is build"

<span class="token key atrule">job3</span><span class="token punctuation">:</span> 
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> echo "This is test"

<span class="token key atrule">job4</span><span class="token punctuation">:</span> 
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> echo "This is deploy"
</code></pre> 
<p>2.点击 <code>Commit changes </code> 提交流水线脚本。</p> 
<p><img src="https://images2.imgbox.com/0b/7e/E01ajqp8_o.png" alt="image-20220425000312131"></p> 
<p>3.构建完成之后，查看当前的部署情况，可以发现四个阶段的任务都正常部署，所以说明Gitlab-CI已经可以正常运行。</p> 
<p><img src="https://images2.imgbox.com/17/71/svAV4Wtc_o.png" alt="image-20220425000806089"></p> 
<p>4.点击Job1，查看当前的Job1输出的日志，是否为Hello Word。</p> 
<p><img src="https://images2.imgbox.com/4f/44/QodXFtPB_o.png" alt="image-20220425001000417"></p> 
<p>如上图可以看到Job1任务输出的内容正常。</p> 
<h3><a id="Harbor_463"></a>部署Harbor</h3> 
<h4><a id="1Harbor_465"></a>1.Harbor介绍</h4> 
<p>Harbor 源于 2014 年 VMware中国研发中心云原生实验室的一个内部项目，旨在为容器的开发人员解决镜像管理的问题。随着 Kubernetes 和容器技术的流行，该项目于 2016 年开源，2018 年 7 月捐赠给 CNCF，在同年 11 月被正式接受为孵化项目，并在云原生技术路线与生态中演进。</p> 
<p>2020年5月 Harbor 2.0 正式发布，增加了对 OCI 制品的支持，能够存储大量云原生制品，例如容器镜像、Helm Chart、CNAB、OPA 和 Singularity 等等。开发人员可依照 OCI 规范，通过 OCI 索引和 OCI 制品功能开拓更广泛的应用场景，包括策略、远程复制和基于角色的访问控制等。</p> 
<h4><a id="2Harbor_475"></a>2.Harbor部署</h4> 
<ul><li>首选必须安装docker-compose的插件，这里我已经安装了docker-compose</li><li>禁用https策略，使用http策略</li><li>将hostname修改为10.11.121.112</li></ul> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-node1 harbor<span class="token punctuation">]</span><span class="token comment"># docker-compose version </span>
Docker Compose version v2.2.1
<span class="token punctuation">[</span>root@k8s-node1 opt<span class="token punctuation">]</span><span class="token comment"># tar zxvf harbor-offline.tar.gz </span>
<span class="token punctuation">[</span>root@k8s-node1 opt<span class="token punctuation">]</span><span class="token comment"># cd harbor/</span>
<span class="token punctuation">[</span>root@k8s-node1 opt<span class="token punctuation">]</span><span class="token comment"># vim harbor.yaml </span>
hostname: <span class="token number">10.11</span>.121.112

<span class="token comment"># http related config</span>
http:
  <span class="token comment"># port for http, default is 80. If https enabled, this port will redirect to https port</span>
  port: <span class="token number">80</span>

<span class="token comment"># https related config</span>
<span class="token comment">#https:</span>
  <span class="token comment"># https port for harbor, default is 443</span>
<span class="token comment">#  port: 443</span>
  <span class="token comment"># The path of cert and key files for nginx</span>
<span class="token comment">#  certificate: /your/certificate/path</span>
<span class="token comment">#  private_key: /your/private/key/path</span>
</code></pre> 
<p>执行命令安装Harbor，查看harbor的进程。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-node1 harbor<span class="token punctuation">]</span><span class="token comment"># ./install.sh </span>
<span class="token punctuation">[</span>Step <span class="token number">0</span><span class="token punctuation">]</span>: checking <span class="token keyword">if</span> <span class="token function">docker</span> is installed <span class="token punctuation">..</span>.
Note: <span class="token function">docker</span> version: <span class="token number">20.10</span>.14

<span class="token punctuation">[</span>Step <span class="token number">1</span><span class="token punctuation">]</span>: checking <span class="token function">docker-compose</span> is installed <span class="token punctuation">..</span>.
Note: <span class="token function">docker-compose</span> version: <span class="token number">2.2</span>.1

<span class="token punctuation">[</span>Step <span class="token number">2</span><span class="token punctuation">]</span>: loading Harbor images <span class="token punctuation">..</span>.
···
<span class="token punctuation">[</span>Step <span class="token number">5</span><span class="token punctuation">]</span>: starting Harbor <span class="token punctuation">..</span>.
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Running <span class="token number">10</span>/10
 ⠿ Network harbor_harbor        Created                                                                                                 <span class="token number">0</span>.1s
 ⠿ Container harbor-log         Started                                                                                                 <span class="token number">1</span>.6s
 ⠿ Container harbor-db          Started                                                                                                 <span class="token number">2</span>.6s
 ⠿ Container registryctl        Started                                                                                                 <span class="token number">3</span>.2s
 ⠿ Container harbor-portal      Started                                                                                                 <span class="token number">2</span>.8s
 ⠿ Container registry           Started                                                                                                 <span class="token number">3</span>.2s
 ⠿ Container redis              Started                                                                                                 <span class="token number">3</span>.2s
 ⠿ Container harbor-core        Started                                                                                                 <span class="token number">4</span>.0s
 ⠿ Container nginx              Started                                                                                                 <span class="token number">5</span>.3s
 ⠿ Container harbor-jobservice  Started                                                                                                 <span class="token number">5</span>.3s
✔ ----Harbor has been installed and started successfully.----


<span class="token punctuation">[</span>root@k8s-node1 harbor<span class="token punctuation">]</span><span class="token comment"># docker-compose  ps </span>
NAME                COMMAND                  SERVICE             STATUS              PORTS
harbor-core         <span class="token string">"/harbor/entrypoint.…"</span>   core                running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   
harbor-db           <span class="token string">"/docker-entrypoint.…"</span>   postgresql          running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   
harbor-jobservice   <span class="token string">"/harbor/entrypoint.…"</span>   jobservice          running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   
harbor-log          <span class="token string">"/bin/sh -c /usr/loc…"</span>   log                 running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   <span class="token number">127.0</span>.0.1:1514-<span class="token operator">&gt;</span><span class="token number">10514</span>/tcp
harbor-portal       <span class="token string">"nginx -g 'daemon of…"</span>   portal              running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   
nginx               <span class="token string">"nginx -g 'daemon of…"</span>   proxy               running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   <span class="token number">0.0</span>.0.0:80-<span class="token operator">&gt;</span><span class="token number">8080</span>/tcp, :::80-<span class="token operator">&gt;</span><span class="token number">8080</span>/tcp
redis               <span class="token string">"redis-server /etc/r…"</span>   redis               running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   
registry            <span class="token string">"/home/harbor/entryp…"</span>   registry            running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span>   
registryctl         <span class="token string">"/home/harbor/start.…"</span>   registryctl         running <span class="token punctuation">(</span>healthy<span class="token punctuation">)</span> 
</code></pre> 
<p>访问Harbor地址： http://10.11.121.112</p> 
<p><img src="https://images2.imgbox.com/07/4f/LZV6Vt99_o.png" alt="image-20220425001823055"></p> 
<h4><a id="3_553"></a>3.添加镜像仓库</h4> 
<p>点击 <code>新建项目</code> ，创建项目名称为 <code>demo</code>，访问级别设置为 <code>公开</code>。</p> 
<p><img src="https://images2.imgbox.com/76/1c/gsJ7Go0N_o.png" alt="image-20220425002022377"></p> 
<p><img src="https://images2.imgbox.com/e7/4a/XeeHtlbY_o.png" alt="image-20220425002121911"></p> 
<h3><a id="CICD_563"></a>配置CICD</h3> 
<h4><a id="1gitlabciyml_565"></a>1.配置.gitlab-ci.yml</h4> 
<p>配置.gitlab-ci.yaml的流水线配置文件内容如下：</p> 
<ul><li>使用<code>docker:v1.0</code>的镜像作为基础镜像</li><li>需要构建三个步骤：<code>maven-build、docker-build、deploy</code></li><li>使用<code>maven镜像</code>构建编译demo-2048项目</li><li>使用<code>docker镜像</code>build新的镜像，推送到Harbor仓库中</li><li>使用<code>kubelet镜像</code>部署demo-2048的yaml文件</li></ul> 
<pre><code class="prism language-yml"><span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>v1.0
<span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> maven<span class="token punctuation">-</span>build
  <span class="token punctuation">-</span> docker<span class="token punctuation">-</span>build
  <span class="token punctuation">-</span> deploy

<span class="token comment"># 这是定义的变量，是Harbor仓库登录的验证信息。</span>
<span class="token key atrule">variables</span><span class="token punctuation">:</span>
  <span class="token key atrule">USERNAME</span><span class="token punctuation">:</span> admin
  <span class="token key atrule">PASSWORD</span><span class="token punctuation">:</span> Harbor12345
  <span class="token key atrule">HARBORIP</span><span class="token punctuation">:</span> 10.11.121.112

<span class="token key atrule">maven-build</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> maven<span class="token punctuation">:</span>3.6<span class="token punctuation">-</span>jdk<span class="token punctuation">-</span><span class="token number">8</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> maven<span class="token punctuation">-</span>build 
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> mkdir <span class="token punctuation">-</span>p /root/.m2/repository
    <span class="token punctuation">-</span> cp <span class="token punctuation">-</span>rvf /opt/repository/*  /root/.m2/repository/
    <span class="token punctuation">-</span> mvn clean install <span class="token punctuation">-</span>Dmaven.test.sktip=true
    <span class="token punctuation">-</span> cp <span class="token punctuation">-</span>rvf /root/demo/target/demo<span class="token punctuation">-</span>2048  /opt/cache

<span class="token key atrule">docker_build</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>v1.0
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>build
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> mv /opt/cache/* /root/demo/Dockerfiles/
    <span class="token punctuation">-</span> cd /root/demo/Dockerfiles/ <span class="token important">&amp;&amp;</span> ls
    <span class="token punctuation">-</span> docker build <span class="token punctuation">-</span>t $HARBORIP/demo/demo<span class="token punctuation">-</span>2048<span class="token punctuation">:</span>v1.0 <span class="token punctuation">-</span>f /root/demo/Dockerfiles/Dockerfile . 
    <span class="token punctuation">-</span> docker login <span class="token punctuation">-</span>u $USERNAME <span class="token punctuation">-</span>p $PASSWORD $HARBORIP 
    <span class="token punctuation">-</span> docker push $HARBORIP/demo/demo<span class="token punctuation">-</span>2048<span class="token punctuation">:</span>v1.0

<span class="token comment"># 这里的kubectl是做的镜像，是在本地仓库，使用config连接Kubernetes集群</span>
<span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> kubectl<span class="token punctuation">:</span>1.16.6
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy 
  <span class="token key atrule">script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> mkdir $HOME/.kube <span class="token important">&amp;&amp;</span> cat $K8S_CONFIG <span class="token punctuation">&gt;</span> $HOME/.kube/config
    <span class="token punctuation">-</span> cd $HOME/.kube <span class="token important">&amp;&amp;</span> pwd
    <span class="token punctuation">-</span> sed <span class="token punctuation">-</span>i 's/10.24.2.3/10.11.121.112/g' /root/demo/template/demo<span class="token punctuation">-</span>2048.yaml 
    <span class="token punctuation">-</span> sed <span class="token punctuation">-</span>i 's/<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>build_tag<span class="token punctuation">}</span><span class="token punctuation">}</span>/v1.0/g' /root/demo/template/demo<span class="token punctuation">-</span>2048.yaml 
    <span class="token punctuation">-</span> sed <span class="token punctuation">-</span>i 's/8889/30003/g' /root/demo/template/demo<span class="token punctuation">-</span>2048.yaml 
    <span class="token punctuation">-</span> kubectl apply <span class="token punctuation">-</span>f /root/demo/template/demo<span class="token punctuation">-</span>2048.yaml
</code></pre> 
<h4><a id="2_622"></a>2.开始构建</h4> 
<p>点击 <code>提交完成</code> 构建CICD。</p> 
<p><img src="https://images2.imgbox.com/e6/66/QjkIoK00_o.png" alt="image-20220425003143807"></p> 
<p>等待结果：<br> <img src="https://images2.imgbox.com/53/67/ziCn6RXg_o.png" alt="image-20220425003438600"></p> 
<h4><a id="3GitlabCI_634"></a>3.查看Gitlab-CI</h4> 
<p>查看构建的输出日志内容。</p> 
<p>如下是maven-build的输出内容：</p> 
<p><img src="https://images2.imgbox.com/6d/d8/owHIDpB7_o.png" alt="image-20220425003531697"></p> 
<p>如下是docker-build的输出内容：</p> 
<p><img src="https://images2.imgbox.com/9d/01/s24qsc0N_o.png" alt="image-20220425003550405"></p> 
<p>如下是deploy的输出内容：</p> 
<p><img src="https://images2.imgbox.com/35/c0/fqmPyYwg_o.png" alt="image-20220425003605898"></p> 
<h4><a id="4_656"></a>4.访问项目</h4> 
<p>查看当前的demo命名空间下的资源，demo-2048应用程序部署完成。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get  pods -n demo</span>
NAME                                        READY   STATUS    RESTARTS   AGE
demo-2048-6858bb9f8d-522rn                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m19s
k8s-runner-gitlab-runner-544f469c44-9m7zw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h23m
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n demo </span>
NAME        TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
demo30003   NodePort   <span class="token number">10.96</span>.113.92   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>:30003/TCP   3m24s
</code></pre> 
<p>访问页面： http://10.11.121.112:30003</p> 
<p>存中…(img-kIcqLhwn-1680264915426)]</p> 
<p>如下是deploy的输出内容：</p> 
<p>[外链图片转存中…(img-kXR0rkwO-1680264915427)]</p> 
<h4><a id="4_684"></a>4.访问项目</h4> 
<p>查看当前的demo命名空间下的资源，demo-2048应用程序部署完成。</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get  pods -n demo</span>
NAME                                        READY   STATUS    RESTARTS   AGE
demo-2048-6858bb9f8d-522rn                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m19s
k8s-runner-gitlab-runner-544f469c44-9m7zw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h23m
<span class="token punctuation">[</span>root@k8s-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n demo </span>
NAME        TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
demo30003   NodePort   <span class="token number">10.96</span>.113.92   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>:30003/TCP   3m24s
</code></pre> 
<p>访问页面： http://10.11.121.112:30003</p> 
<p><img src="https://images2.imgbox.com/8a/fb/E08YcWJ0_o.png" alt="image-20220425003906131"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e1cf61d942d90283d4b121cc8f27aaad/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">spring6</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1103705ef9510481a98d8b424a5cedbc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【在Linux中centos7上安装vscode】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>