<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot实现微信小程序登录 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringBoot实现微信小程序登录" />
<meta property="og:description" content="文章目录 一、登录流程二、后端实现1、SpringBoot项目结构树2、实现auth.code2Session 接口的封装3、建立用户信息表及用户增删改查的管理4、实现登录认证及令牌生成 三、前端实现与测试1、编写登录公共函数2、搭建登录页面3、登录测试 一、登录流程 首先参考小程序官方文档中的流程图：
根据流程图描述，主要步骤有以下几步
1、小程序端调用 wx.login()向微信接口服务获取 临时登录凭证code ，并上传至开发者服务端。
2、开发者服务端向微信服务接口服务调用 auth.code2Session 接口，换取 用户唯一标识 OpenID 和 会话密钥 session_key。
3、开发者服务端根据session_key等信息,基于JWT标准，生成自定义的网络令牌token，返回至小程序端存储。
关于SpringBoot实现JWT的具体细节，请参考本人博文：
SpringBoot整合SpringSecurity实现JWT认证
本文将具体对微信小程序的前端与后端实现进行详细描述：
二、后端实现 1、SpringBoot项目结构树 2、实现auth.code2Session 接口的封装 WxMiniApi.java
/** * 微信小程序统一服务端API接口 * @author zhuhuix * @date 2020-04-03 */ public interface WxMiniApi { /** * auth.code2Session * https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html * 请求参数 属性	类型	默认值	必填	说明 * @param appId	string	是	小程序 appId * @param secret	string	是	小程序 appSecret * @param jsCode	string	是	登录时获取的 code * grantType	string	是	授权类型，此处只需填写 authorization_code * 返回值 * @return JSON 数据包 * 属性	类型	说明 * openid	string	用户唯一标识 * session_key	string	会话密钥 * unionid	string	用户在开放平台的唯一标识符，在满足 UnionID 下发条件的情况下会返回，详见 UnionID 机制说明。 * errcode	number	错误码 * errmsg	string	错误信息 * * errcode 的合法值 * * 值	说明	最低版本 * -1	系统繁忙，此时请开发者稍候再试 * 0	请求成功 * 40029	code 无效 * 45011	频率限制，每个用户每分钟100次 */ JSONObject authCode2Session(String appId,String secret,String jsCode); } WxMiniApiImpl." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/91d7625ef92f253e03824542ff19ee1a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-08T15:51:50+08:00" />
<meta property="article:modified_time" content="2020-04-08T15:51:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot实现微信小程序登录</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><ul><li><a href="#_1" rel="nofollow">一、登录流程</a></li><li><a href="#_13" rel="nofollow">二、后端实现</a></li><li><ul><li><a href="#1SpringBoot_14" rel="nofollow">1、SpringBoot项目结构树</a></li><li><a href="#2authcode2Session__18" rel="nofollow">2、实现auth.code2Session 接口的封装</a></li><li><a href="#3_248" rel="nofollow">3、建立用户信息表及用户增删改查的管理</a></li><li><a href="#4_504" rel="nofollow">4、实现登录认证及令牌生成</a></li></ul> 
     </li><li><a href="#_742" rel="nofollow">三、前端实现与测试</a></li><li><ul><li><a href="#1_743" rel="nofollow">1、编写登录公共函数</a></li><li><a href="#2_834" rel="nofollow">2、搭建登录页面</a></li><li><a href="#3_883" rel="nofollow">3、登录测试</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h5><a id="_1"></a>一、登录流程</h5> 
<blockquote> 
 <p><strong>首先参考小程序官方文档中的流程图：</strong><br> <img src="https://images2.imgbox.com/a6/5c/w10lUM6f_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p>根据流程图描述，主要步骤有以下几步<br> 1、小程序端调用 wx.login()向微信接口服务获取 临时登录凭证code ，并上传至开发者服务端。<br> 2、开发者服务端向微信服务接口服务调用 auth.code2Session 接口，换取 用户唯一标识 OpenID 和 会话密钥 session_key。<br> 3、开发者服务端根据session_key等信息,基于JWT标准，生成自定义的网络令牌token，返回至小程序端存储。</p> 
<p><em><strong>关于SpringBoot实现JWT的具体细节，请参考本人博文：</strong></em><br> <a href="https://blog.csdn.net/jpgzhu/article/details/105200598">SpringBoot整合SpringSecurity实现JWT认证</a><br> 本文将具体对微信小程序的前端与后端实现进行详细描述：</p> 
<h5><a id="_13"></a>二、后端实现</h5> 
<h6><a id="1SpringBoot_14"></a>1、SpringBoot项目结构树</h6> 
<p><img src="https://images2.imgbox.com/41/f0/TCl5eSU2_o.png" alt="微信接口包"><br> <img src="https://images2.imgbox.com/f4/13/3IEb6Tvc_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="2authcode2Session__18"></a>2、实现auth.code2Session 接口的封装</h6> 
<p>WxMiniApi.java</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 微信小程序统一服务端API接口
 * @author zhuhuix
 * @date 2020-04-03
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">WxMiniApi</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * auth.code2Session
     * https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html
     * 请求参数   属性	     类型	   默认值	必填	 说明
     * @param   appId	     string		         是	   小程序 appId
     * @param   secret	     string		         是	   小程序 appSecret
     * @param   jsCode	     string		         是	   登录时获取的 code
     *          grantType	 string		         是	   授权类型，此处只需填写 authorization_code
     * 返回值
     * @return  JSON 数据包
     *           属性	     类型	   说明
     *          openid	     string	  用户唯一标识
     *          session_key	 string	  会话密钥
     *          unionid	     string	  用户在开放平台的唯一标识符，在满足 UnionID 下发条件的情况下会返回，详见 UnionID 机制说明。
     *          errcode	     number	  错误码
     *          errmsg	     string	  错误信息
     *
     *          errcode 的合法值
     *
     *          值	         说明	                     最低版本
     *          -1	         系统繁忙，此时请开发者稍候再试
     *          0	         请求成功
     *          40029	     code 无效
     *          45011	     频率限制，每个用户每分钟100次
     */</span>
    JSONObject <span class="token function">authCode2Session</span><span class="token punctuation">(</span>String appId<span class="token punctuation">,</span>String secret<span class="token punctuation">,</span>String jsCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>WxMiniApiImpl.java</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 微信小程序Api接口实现类
 *
 * @author zhuhuix
 * @date 2020-04-03
 */</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxMiniApiImpl</span> <span class="token keyword">implements</span> <span class="token class-name">WxMiniApi</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> JSONObject <span class="token function">authCode2Session</span><span class="token punctuation">(</span>String appId<span class="token punctuation">,</span> String secret<span class="token punctuation">,</span> String jsCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        String url <span class="token operator">=</span> <span class="token string">"https://api.weixin.qq.com/sns/jscode2session?appid="</span> <span class="token operator">+</span> appId <span class="token operator">+</span> <span class="token string">"&amp;secret="</span> <span class="token operator">+</span> secret <span class="token operator">+</span> <span class="token string">"&amp;js_code="</span> <span class="token operator">+</span> jsCode <span class="token operator">+</span> <span class="token string">"&amp;grant_type=authorization_code"</span><span class="token punctuation">;</span>
        String str <span class="token operator">=</span> WeChatUtil<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"api/wx-mini/getSessionKey:"</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> JSONObject<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>WeChatUtil.java</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 微信小程序工具类
 *
 * @author zhuhuix
 * @date 2019-12-25
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeChatUtil</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">httpRequest</span><span class="token punctuation">(</span>String requestUrl<span class="token punctuation">,</span> String requestMethod<span class="token punctuation">,</span> String output<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            URL url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>requestUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            HttpsURLConnection connection <span class="token operator">=</span> <span class="token punctuation">(</span>HttpsURLConnection<span class="token punctuation">)</span> url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connection<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connection<span class="token punctuation">.</span><span class="token function">setDoInput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connection<span class="token punctuation">.</span><span class="token function">setUseCaches</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connection<span class="token punctuation">.</span><span class="token function">setRequestMethod</span><span class="token punctuation">(</span>requestMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> output<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                OutputStream outputStream <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                outputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>StandardCharsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 从输入流读取返回内容</span>
            InputStream inputStream <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            InputStreamReader inputStreamReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> StandardCharsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            BufferedReader bufferedReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>inputStreamReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            String str<span class="token punctuation">;</span>
            StringBuilder buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>str <span class="token operator">=</span> bufferedReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                buffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            bufferedReader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            inputStreamReader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connection<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">decryptData</span><span class="token punctuation">(</span>String encryptDataB64<span class="token punctuation">,</span> String sessionKeyB64<span class="token punctuation">,</span> String ivB64<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"encryptDataB64:"</span> <span class="token operator">+</span> encryptDataB64<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"sessionKeyB64:"</span> <span class="token operator">+</span> sessionKeyB64<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"ivB64:"</span> <span class="token operator">+</span> ivB64<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>
                <span class="token function">decryptOfDiyIv</span><span class="token punctuation">(</span>
                        Base64<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>encryptDataB64<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        Base64<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>sessionKeyB64<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        Base64<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>ivB64<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String KEY_ALGORITHM <span class="token operator">=</span> <span class="token string">"AES"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String ALGORITHM_STR <span class="token operator">=</span> <span class="token string">"AES/CBC/PKCS7Padding"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Key key<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Cipher cipher<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果密钥不足16位，那么就补足.  这个if 中的内容很重要</span>
        <span class="token keyword">int</span> base <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keyBytes<span class="token punctuation">.</span>length <span class="token operator">%</span> base <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> groups <span class="token operator">=</span> keyBytes<span class="token punctuation">.</span>length <span class="token operator">/</span> base <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>groups <span class="token operator">*</span> base<span class="token punctuation">]</span><span class="token punctuation">;</span>
            Arrays<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> temp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> keyBytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyBytes <span class="token operator">=</span> temp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 初始化</span>
        Security<span class="token punctuation">.</span><span class="token function">addProvider</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BouncyCastleProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 转化成JAVA的密钥格式</span>
        key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">,</span> KEY_ALGORITHM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 初始化cipher</span>
            cipher <span class="token operator">=</span> Cipher<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>ALGORITHM_STR<span class="token punctuation">,</span> <span class="token string">"BC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 解密方法
     *
     * @param encryptedData 要解密的字符串
     * @param keyBytes      解密密钥
     * @param ivs           自定义对称解密算法初始向量 iv
     * @return 解密后的字节数组
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">decryptOfDiyIv</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encryptedData<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ivs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encryptedText <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token function">init</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>Cipher<span class="token punctuation">.</span>DECRYPT_MODE<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IvParameterSpec</span><span class="token punctuation">(</span>ivs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            encryptedText <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>encryptedData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> encryptedText<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 向指定 URL 发送POST方法的请求
     *
     * @param url  发送请求的 URL
     * @param json 请求参数，请求参数应该是 json 的形式。
     * @return 所代表远程资源的响应结果
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">httpPost</span><span class="token punctuation">(</span>String url<span class="token punctuation">,</span> JSONObject json<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        PrintWriter out <span class="token operator">=</span> null<span class="token punctuation">;</span>
        BufferedReader in <span class="token operator">=</span> null<span class="token punctuation">;</span>
        String result <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            URL realUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 打开和URL之间的连接</span>
            URLConnection conn <span class="token operator">=</span> realUrl<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置通用的请求属性</span>
            conn<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">,</span> <span class="token string">"*/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            conn<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"connection"</span><span class="token punctuation">,</span> <span class="token string">"Keep-Alive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            conn<span class="token punctuation">.</span><span class="token function">setRequestProperty</span><span class="token punctuation">(</span><span class="token string">"user-agent"</span><span class="token punctuation">,</span>
                    <span class="token string">"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1;SV1)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发送POST请求必须设置如下两行</span>
            conn<span class="token punctuation">.</span><span class="token function">setDoOutput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            conn<span class="token punctuation">.</span><span class="token function">setDoInput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">/</span><span class="token operator">/</span> 获取URLConnection对象对应的输出流
            out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">/</span><span class="token operator">/</span> 发送请求参数

            out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">/</span><span class="token operator">/</span> flush输出流的缓冲
            out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">/</span><span class="token operator">/</span> 定义BufferedReader输入流来读取URL的响应
            in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>conn<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String line<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                result<span class="token operator">=</span>result<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送 POST 请求出现异常！"</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">/</span>使用<span class="token keyword">finally</span>块来关闭输出流、输入流
        <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>out <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="3_248"></a>3、建立用户信息表及用户增删改查的管理</h6> 
<p>User.java</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 用户表
 *
 * @author zhuhuix
 * @date 2020-04-03
 */</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> GenerationType<span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NotNull</span><span class="token punctuation">(</span>groups <span class="token operator">=</span> Update<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> Long id<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"user_name"</span><span class="token punctuation">,</span> unique <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String userName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 微信openId
     */</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>unique <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"open_id"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String openId<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 用户昵称
     */</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"nick_name"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String nickName<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 性别 0-未知 1-male,2-female
     */</span>
    <span class="token keyword">private</span> Integer gender<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 头像地址
     */</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"avatar_url"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String avatarUrl<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"union_id"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String unionId<span class="token punctuation">;</span>

    <span class="token keyword">private</span> String country<span class="token punctuation">;</span>

    <span class="token keyword">private</span> String province<span class="token punctuation">;</span>

    <span class="token keyword">private</span> String city<span class="token punctuation">;</span>

    <span class="token keyword">private</span> String language<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Email</span>
    <span class="token keyword">private</span> String email<span class="token punctuation">;</span>

    <span class="token keyword">private</span> String phone<span class="token punctuation">;</span>

    <span class="token keyword">private</span> String remarks<span class="token punctuation">;</span>

    <span class="token keyword">private</span> Boolean enabled<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"last_password_reset_time"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> Timestamp lastPasswordResetTime<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"create_time"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@CreationTimestamp</span>
    <span class="token keyword">private</span> Timestamp createTime<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"update_time"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@UpdateTimestamp</span>
    <span class="token keyword">private</span> Timestamp updateTime<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>UserService.java</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 用户信息接口
 *
 * @author zhuhuix
 * @date 2020-04-03
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 增加用户
     *
     * @param user 待新增的用户
     * @return 增加成功的用户
     */</span>
    Result<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">create</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 删除用户
     *
     * @param user 待删除的用户
     */</span>
    <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 修改用户
     *
     * @param user 待修改的用户
     * @return 修改成功的用户
     */</span>
    Result<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">update</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 根据id查找用户
     *
     * @param id 用户id
     * @return id对应的用户
     */</span>
    Result<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">findById</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 用于微信注册用户查找：根据openId查找用户
     *
     * @param openId 微信openId
     * @return openId对应的用户
     */</span>
    Result<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">findByOpenId</span><span class="token punctuation">(</span>String openId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>UserServiceImpl.java</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 用户接口实现类
 *
 * @author zhuhuix
 * @date 2020-04-03
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>SUPPORTS<span class="token punctuation">,</span> readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> rollbackFor <span class="token operator">=</span> Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> UserRepository userRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">UserServiceImpl</span><span class="token punctuation">(</span>UserRepository userRepository<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userRepository <span class="token operator">=</span> userRepository<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">create</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        userRepository<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">update</span><span class="token punctuation">(</span>User user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>userRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Result<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">findById</span><span class="token punctuation">(</span>Long id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Optional<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> optional <span class="token operator">=</span> userRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> optional<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>user <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Result<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">findByOpenId</span><span class="token punctuation">(</span>String openId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>userRepository<span class="token punctuation">.</span><span class="token function">findByOpenId</span><span class="token punctuation">(</span>openId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Result.java</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * API统一返回基类
 * @author zhuhuix
 * @date 2020-04-03
 */</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Result</span><span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 是否成功
     */</span>
    <span class="token keyword">private</span> Boolean success<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 错误码
     */</span>
    <span class="token keyword">private</span> String errCode<span class="token punctuation">;</span>

    <span class="token comment">/**
     *  错误信息
     */</span>
    <span class="token keyword">private</span> String errMsg<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 返回数据
     */</span>
    <span class="token keyword">private</span> T module<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"Result{"</span> <span class="token operator">+</span>
                <span class="token string">"success="</span> <span class="token operator">+</span> success <span class="token operator">+</span>
                <span class="token string">", errCode='"</span> <span class="token operator">+</span> errCode <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", errMsg='"</span> <span class="token operator">+</span> errMsg <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", module="</span> <span class="token operator">+</span> module <span class="token operator">+</span>
                <span class="token string">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Result<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token function">ok</span><span class="token punctuation">(</span>T module<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setErrCode</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setErrCode</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setModule</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Result<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token function">error</span><span class="token punctuation">(</span>String errCode<span class="token punctuation">,</span>String errMsg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setErrCode</span><span class="token punctuation">(</span>errCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setErrMsg</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Result<span class="token generics function"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token function">error</span><span class="token punctuation">(</span>String errMsg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setErrCode</span><span class="token punctuation">(</span><span class="token string">"-1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setErrMsg</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="4_504"></a>4、实现登录认证及令牌生成</h6> 
<p>AuthService.java</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 登录授权服务接口
 *
 * @author zhuhuix
 * @date 2020-04-07
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 登录授权
     *
     * @param authUserDto 认证用户请求信息
     * @param request Http请求
     * @return 认证用户返回信息
     */</span>
    Result<span class="token generics function"><span class="token punctuation">&lt;</span>AuthUserDto<span class="token punctuation">&gt;</span></span> <span class="token function">login</span><span class="token punctuation">(</span>AuthUserDto authUserDto<span class="token punctuation">,</span> HttpServletRequest request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>AuthServiceImpl.java</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 授权登录接口实现类
 *
 * @author zhuhuix
 * @date 2020-04-07
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> Propagation<span class="token punctuation">.</span>SUPPORTS<span class="token punctuation">,</span> readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> rollbackFor <span class="token operator">=</span> Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AuthService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${wxMini.appId}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String appId<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${wxMini.secret}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> String secret<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> JwtTokenUtils jwtTokenUtils<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> WxMiniApi wxMiniApi<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> UserService userService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">AuthServiceImpl</span><span class="token punctuation">(</span>JwtTokenUtils jwtTokenUtils<span class="token punctuation">,</span> WxMiniApi wxMiniApi<span class="token punctuation">,</span> UserService userService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jwtTokenUtils <span class="token operator">=</span> jwtTokenUtils<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>wxMiniApi <span class="token operator">=</span> wxMiniApi<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userService <span class="token operator">=</span> userService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> Exception<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Result<span class="token generics function"><span class="token punctuation">&lt;</span>AuthUserDto<span class="token punctuation">&gt;</span></span> <span class="token function">login</span><span class="token punctuation">(</span>AuthUserDto authUserDto<span class="token punctuation">,</span> HttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Result<span class="token generics function"><span class="token punctuation">&lt;</span>AuthUserDto<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//authType=1代表是微信登录</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>authUserDto<span class="token punctuation">.</span><span class="token function">getAuthType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> authUserDto<span class="token punctuation">.</span><span class="token function">getAuthType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            JSONObject jsonObject <span class="token operator">=</span> wxMiniApi<span class="token punctuation">.</span><span class="token function">authCode2Session</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> authUserDto<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jsonObject <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"调用微信端授权认证接口错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            String openId <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>OPEN_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            String sessionKey <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>SESSION_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            String unionId <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>UNION_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>openId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>ERR_CODE<span class="token punctuation">)</span><span class="token punctuation">,</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>ERR_MSG<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            authUserDto<span class="token punctuation">.</span><span class="token function">setOpenId</span><span class="token punctuation">(</span>openId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//判断用户表中是否存在该用户，不存在则进行解密得到用户信息，并进行新增用户</span>
            Result<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> resultUser <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findByOpenId</span><span class="token punctuation">(</span>openId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resultUser<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String userInfo <span class="token operator">=</span> WeChatUtil<span class="token punctuation">.</span><span class="token function">decryptData</span><span class="token punctuation">(</span>authUserDto<span class="token punctuation">.</span><span class="token function">getEncryptedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sessionKey<span class="token punctuation">,</span> authUserDto<span class="token punctuation">.</span><span class="token function">getIv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"解密用户信息错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                User user <span class="token operator">=</span> JSONObject<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">,</span> User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"填充用户对象错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                user<span class="token punctuation">.</span><span class="token function">setUnionId</span><span class="token punctuation">(</span>unionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                userService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                authUserDto<span class="token punctuation">.</span><span class="token function">setUserInfo</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                authUserDto<span class="token punctuation">.</span><span class="token function">setUserInfo</span><span class="token punctuation">(</span>resultUser<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//创建token</span>
            String token <span class="token operator">=</span> jwtTokenUtils<span class="token punctuation">.</span><span class="token function">createToken</span><span class="token punctuation">(</span>openId<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"生成token错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            authUserDto<span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>authUserDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>AuthUserDto.java</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 认证用户
 *
 * @author zhuhuix
 * @date 2020-04-03
 */</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthUserDto</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 授权类型：0--WEB端 1--微信端
     */</span>
    <span class="token keyword">private</span> Integer authType<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 用户名
     */</span>
    <span class="token keyword">private</span> String userName<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 密码
     */</span>
    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 传入参数：临时登录凭证
     */</span>
    <span class="token keyword">private</span> String code<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 用户登录id
     */</span>
    <span class="token keyword">private</span> String uuid <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

    <span class="token comment">//**********************************</span>
    <span class="token comment">//以下为微信类传输字段</span>

    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> 微信openId
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">private</span> String openId<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 传入参数: 用户非敏感信息
     */</span>
    <span class="token keyword">private</span> String rawData<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 传入参数: 签名
     */</span>
    <span class="token keyword">private</span> String signature<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 传入参数: 用户敏感信息
     */</span>
    <span class="token keyword">private</span> String encryptedData<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 传入参数: 解密算法的向量
     */</span>
    <span class="token keyword">private</span> String iv<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 会话密钥
     */</span>
    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token keyword">private</span> String sessionKey<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 用户在开放平台的唯一标识符
     */</span>
    <span class="token annotation punctuation">@JsonIgnore</span>
    <span class="token keyword">private</span> String unionId<span class="token punctuation">;</span>

    <span class="token comment">//以上为微信类传输字段</span>
    <span class="token comment">//**********************************</span>

    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> 返回<span class="token operator">:</span>服务器jwt token
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">private</span> String token<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 返回：userName或openId对应的用户
     */</span>
    <span class="token keyword">private</span> User userInfo<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"AuthUser{"</span> <span class="token operator">+</span>
                <span class="token string">"userName='"</span> <span class="token operator">+</span> userName <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", password='"</span> <span class="token operator">+</span> <span class="token string">"*********"</span> <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", code='"</span> <span class="token operator">+</span> code <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", uuid='"</span> <span class="token operator">+</span> uuid <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", openId='"</span> <span class="token operator">+</span> openId <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", token='"</span> <span class="token operator">+</span> token <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
                <span class="token string">", userInfo="</span> <span class="token operator">+</span> userInfo <span class="token operator">+</span>
                <span class="token string">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>AuthController.java</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * api登录授权
 *
 * @author zhuhuix
 * @date 2020-03-30
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/auth"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">"系统授权接口"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> AuthService authService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">AuthController</span><span class="token punctuation">(</span>AuthService authService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>authService <span class="token operator">=</span> authService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">"登录授权"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/login"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> ResponseEntity <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> AuthUserDto authUserDto<span class="token punctuation">,</span> HttpServletRequest request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> ResponseEntity<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>authService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>authUserDto<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_742"></a>三、前端实现与测试</h5> 
<h6><a id="1_743"></a>1、编写登录公共函数</h6> 
<pre><code class="prism language-javascript"> <span class="token comment">// 公共登录动作</span>
  doLogin<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    wx<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      success<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>loginRes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//console.log(loginRes, "loginRes");</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginRes<span class="token punctuation">.</span>code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">/*
           * @desc: 获取用户信息 期望数据如下
           *
           * @param: userInfo       [Object]
           * @param: rawData        [String]
           * @param: signature      [String]
           * @param: encryptedData  [String]
           * @param: iv             [String]
           **/</span>
          wx<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            withCredentials<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 非必填, 默认为true</span>

            success<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>infoRes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"infoRes:"</span><span class="token punctuation">,</span> infoRes<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 请求服务端的登录接口</span>
              wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                url<span class="token punctuation">:</span> api<span class="token punctuation">.</span>loginUrl<span class="token punctuation">,</span>
                method<span class="token punctuation">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
                data<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                  authType<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//1代表微信端登录</span>
                  code<span class="token punctuation">:</span> loginRes<span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token comment">// 临时登录凭证</span>
                  rawData<span class="token punctuation">:</span> infoRes<span class="token punctuation">.</span>rawData<span class="token punctuation">,</span> <span class="token comment">// 用户非敏感信息</span>
                  signature<span class="token punctuation">:</span> infoRes<span class="token punctuation">.</span>signature<span class="token punctuation">,</span> <span class="token comment">// 签名</span>
                  encryptedData<span class="token punctuation">:</span> infoRes<span class="token punctuation">.</span>encryptedData<span class="token punctuation">,</span> <span class="token comment">// 用户敏感信息</span>
                  iv<span class="token punctuation">:</span> infoRes<span class="token punctuation">.</span>iv<span class="token punctuation">,</span> <span class="token comment">// 解密算法的向量</span>
                  token<span class="token punctuation">:</span> wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">"loginFlag"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>

                success<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"login success:"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  res <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>success<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    that<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> res<span class="token punctuation">.</span>module<span class="token punctuation">.</span>userInfo<span class="token punctuation">;</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
                      <span class="token string">"globalData.userInfo"</span><span class="token punctuation">,</span>
                      that<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userInfo
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">"userInfo"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>module<span class="token punctuation">.</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    wx<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token string">"loginFlag"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>module<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    that<span class="token punctuation">.</span><span class="token function">showInfo</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>

                fail<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token comment">// 调用服务端登录接口失败</span>
                  that<span class="token punctuation">.</span><span class="token function">showInfo</span><span class="token punctuation">(</span><span class="token string">"调用接口失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>

            fail<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 获取 userInfo 失败，去检查是否未开启权限</span>
              wx<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              that<span class="token punctuation">.</span><span class="token function">showInfo</span><span class="token punctuation">(</span><span class="token string">"调用request接口失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
              wwx<span class="token punctuation">.</span><span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                url<span class="token punctuation">:</span> <span class="token string">"/pages/index/index"</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 获取 code 失败</span>
          that<span class="token punctuation">.</span><span class="token function">showInfo</span><span class="token punctuation">(</span><span class="token string">"登录失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"调用wx.login获取code失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      fail<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 调用 wx.login 接口失败</span>
        that<span class="token punctuation">.</span><span class="token function">showInfo</span><span class="token punctuation">(</span><span class="token string">"接口调用失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

</code></pre> 
<h6><a id="2_834"></a>2、搭建登录页面</h6> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span>view <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"index-home"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>view <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"userinfo"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>open<span class="token operator">-</span>data <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"userinfo-avatar"</span> background<span class="token operator">-</span>size<span class="token operator">=</span><span class="token string">"cover"</span> type<span class="token operator">=</span><span class="token string">"userAvatarUrl"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>open<span class="token operator">-</span>data<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>open<span class="token operator">-</span>data <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"userinfo-nickname"</span> type<span class="token operator">=</span><span class="token string">"userNickName"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>open<span class="token operator">-</span>data<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 需要使用 button 来授权登录 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>view <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"index-button_container"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>van<span class="token operator">-</span>button wx<span class="token punctuation">:</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">"{<!-- -->{canIUse}}"</span>  type<span class="token operator">=</span><span class="token string">"primary"</span> size<span class="token operator">=</span><span class="token string">"large"</span> open<span class="token operator">-</span>type<span class="token operator">=</span><span class="token string">"getUserInfo"</span> bindgetuserinfo<span class="token operator">=</span><span class="token string">"bindGetUserInfo"</span><span class="token operator">&gt;</span>
            授权登录
        <span class="token operator">&lt;</span><span class="token operator">/</span>van<span class="token operator">-</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>view <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"index-home__desc"</span> wx<span class="token punctuation">:</span><span class="token keyword">else</span><span class="token operator">&gt;</span>请升级微信版本<span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
</code></pre> 
<pre><code class="prism language-javascript"><span class="token comment">/** index.js **/</span>

<span class="token comment">//获取app实例</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    token<span class="token punctuation">:</span> wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">"loginFlag"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    userInfo<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//判断小程序的API，回调，参数，组件等是否在当前版本可用。</span>
    canIUse<span class="token punctuation">:</span> wx<span class="token punctuation">.</span><span class="token function">canIUse</span><span class="token punctuation">(</span><span class="token string">"button.open-type.getUserInfo"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 是否登录，根据后台返回的token判断</span>
    hasLogin<span class="token punctuation">:</span> wx<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token string">"loginFlag"</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  onLoad<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>

  bindGetUserInfo<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"用户按了允许授权按钮"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>userInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//用户按了允许授权按钮</span>
      app<span class="token punctuation">.</span><span class="token function">doLogin</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>switchTheTab<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//用户按了拒绝按钮</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  onShow<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="3_883"></a>3、登录测试</h6> 
<p>登录页面<br> <img src="https://images2.imgbox.com/22/a2/7BBirfzY_o.png" alt="登录界面"><br> 服务端返回数据：<br> <img src="https://images2.imgbox.com/39/8c/2g9hhysh_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d6d74f85173ec4900a6fae91a0b54f35/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python 去除所有的中文 英文标点符号</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6f04b9c833bc34ba756c896a1d68aafb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Dubbo支持哪些协议，每种协议的应用场景，优缺点</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>