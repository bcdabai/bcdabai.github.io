<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>对接企业微信机器人报错：{\“errcode\“:60020,\“errmsg\“:\“not allow to access from your ip, hint: [169917845713115 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="对接企业微信机器人报错：{\“errcode\“:60020,\“errmsg\“:\“not allow to access from your ip, hint: [169917845713115" />
<meta property="og:description" content="Prometheus&#43;altermanager对接企业微信机器人报错内容：
level=debug ts=2023-11-05T10:00:57.435Z caller=wechat.go:190 integration=wechat response=&#34;{\&#34;errcode\&#34;:60020,\&#34;errmsg\&#34;:\&#34;not allow to access from your ip, hint: [1699178457562583222455115], from ip: 36.112.180.226, more info at https://open.work.weixin.qq.com/devtool/query?e=60020\&#34;}&#34; incident=&#34;{}:{alertname=\&#34;kubernetes-etcd\&#34;}&#34; 解决方案：企业微信机器人添加企业可信IP 即可！
但是但是，第一次配置可信IP地址，需要先配置设置接收消息服务器URL，步骤如下：
打开一台有公网IP的服务器，进行下面操作：
wget https://github.com/sbzhu/weworkapi_python/archive/refs/heads/master.zip unzip master.zip mv weworkapi_python-master weworkapi_python vim wechat.py #-*- encoding:utf-8 -*- from flask import abort, request from flask import Flask from xml.dom.minidom import parseString import _thread import time import os import sys sys.path.append(&#34;weworkapi_python/callback&#34;) # 正确的模块导入路径 from WXBizMsgCrypt3 import WXBizMsgCrypt # https://github.com/sbzhu/weworkapi_python 项目地址 app = Flask(__name__) # 对应步骤4中接受消息回调模式中的URL，如域名是&#39;www." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/66c673edfec23875b8525521a602ff73/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-05T18:32:09+08:00" />
<meta property="article:modified_time" content="2023-11-05T18:32:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">对接企业微信机器人报错：{\“errcode\“:60020,\“errmsg\“:\“not allow to access from your ip, hint: [169917845713115</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>Prometheus+altermanager对接企业微信机器人报错内容：</p> 
<pre><code class="prism language-bash"><span class="token assign-left variable">level</span><span class="token operator">=</span>debug <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2023</span>-11-05T10:00:57.435Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>wechat.go:190 <span class="token assign-left variable">integration</span><span class="token operator">=</span>wechat <span class="token assign-left variable">response</span><span class="token operator">=</span><span class="token string">"{<!-- --><span class="token entity" title='\"'>\"</span>errcode<span class="token entity" title='\"'>\"</span>:60020,<span class="token entity" title='\"'>\"</span>errmsg<span class="token entity" title='\"'>\"</span>:<span class="token entity" title='\"'>\"</span>not allow to access from your ip, hint: [1699178457562583222455115], from ip: 36.112.180.226, more info at https://open.work.weixin.qq.com/devtool/query?e=60020<span class="token entity" title='\"'>\"</span>}"</span> <span class="token assign-left variable">incident</span><span class="token operator">=</span><span class="token string">"{}:{alertname=<span class="token entity" title='\"'>\"</span>kubernetes-etcd<span class="token entity" title='\"'>\"</span>}"</span>
</code></pre> 
<p>解决方案：企业微信机器人添加<code>企业可信IP</code> 即可！<br> <img src="https://images2.imgbox.com/34/68/05S5Bo3o_o.png" alt=""><br> <img src="https://images2.imgbox.com/8b/aa/yEuXQDqR_o.png" alt="在这里插入图片描述"><br> 但是但是，第一次配置可信IP地址，需要先配置<code>设置接收消息服务器URL</code>，步骤如下：<br> <img src="https://images2.imgbox.com/5c/c9/1cXv2MjI_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a0/54/WAGbdbwp_o.png" alt="在这里插入图片描述"><br> 打开一台有公网IP的服务器，进行下面操作：</p> 
<pre><code class="prism language-bash"><span class="token function">wget</span> https://github.com/sbzhu/weworkapi_python/archive/refs/heads/master.zip
<span class="token function">unzip</span> master.zip
<span class="token function">mv</span> weworkapi_python-master weworkapi_python
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">vim</span> wechat.py 
<span class="token comment">#-*- encoding:utf-8 -*-</span>
from flask <span class="token function">import</span> abort, request
from flask <span class="token function">import</span> Flask
from xml.dom.minidom <span class="token function">import</span> parseString
<span class="token function">import</span> _thread
<span class="token function">import</span> <span class="token function">time</span>
<span class="token function">import</span> os
<span class="token function">import</span> sys
sys.path.append<span class="token punctuation">(</span><span class="token string">"weworkapi_python/callback"</span><span class="token punctuation">)</span>  <span class="token comment"># 正确的模块导入路径</span>
from WXBizMsgCrypt3 <span class="token function">import</span> WXBizMsgCrypt   <span class="token comment"># https://github.com/sbzhu/weworkapi_python 项目地址</span>
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
 
<span class="token comment"># 对应步骤4中接受消息回调模式中的URL，如域名是'www.example.com' 那么在步骤4中填入的url就为"http://www.example.com/hook_path"</span>
@app.route<span class="token punctuation">(</span><span class="token string">'/hook_path'</span>, <span class="token assign-left variable">methods</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span>,<span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
def douban<span class="token punctuation">(</span><span class="token punctuation">)</span>:
    <span class="token keyword">if</span> request.method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token builtin class-name">:</span>
        echo_str <span class="token operator">=</span> signature<span class="token punctuation">(</span>request, <span class="token number">0</span><span class="token punctuation">)</span>
        return<span class="token punctuation">(</span>echo_str<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> request.method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token builtin class-name">:</span>
        echo_str <span class="token operator">=</span> signature2<span class="token punctuation">(</span>request, <span class="token number">0</span><span class="token punctuation">)</span>
        return<span class="token punctuation">(</span>echo_str<span class="token punctuation">)</span>
 
qy_api <span class="token operator">=</span> <span class="token punctuation">[</span>
    WXBizMsgCrypt<span class="token punctuation">(</span><span class="token string">"XXXXXXX"</span>, <span class="token string">"XXXXXXX"</span>, <span class="token string">"XXXXXXX"</span><span class="token punctuation">)</span>, 
<span class="token punctuation">]</span> <span class="token comment">#对应接受消息回调模式中的token，EncodingAESKey 和 企业信息中的企业id</span>
 
<span class="token comment"># 开启消息接受模式时验证接口连通性</span>
def signature<span class="token punctuation">(</span>request, i<span class="token punctuation">)</span>: 
    msg_signature <span class="token operator">=</span> request.args.get<span class="token punctuation">(</span><span class="token string">'msg_signature'</span>, <span class="token string">''</span><span class="token punctuation">)</span>
    timestamp <span class="token operator">=</span> request.args.get<span class="token punctuation">(</span><span class="token string">'timestamp'</span>, <span class="token string">''</span><span class="token punctuation">)</span>
    nonce <span class="token operator">=</span> request.args.get<span class="token punctuation">(</span><span class="token string">'nonce'</span>, <span class="token string">''</span><span class="token punctuation">)</span>
    echo_str <span class="token operator">=</span> request.args.get<span class="token punctuation">(</span><span class="token string">'echostr'</span>, <span class="token string">''</span><span class="token punctuation">)</span>
    ret,sEchoStr<span class="token operator">=</span>qy_api<span class="token punctuation">[</span>i<span class="token punctuation">]</span>.VerifyURL<span class="token punctuation">(</span>msg_signature, timestamp,nonce,echo_str<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>:
        print<span class="token punctuation">(</span><span class="token string">"ERR: VerifyURL ret: "</span> + str<span class="token punctuation">(</span>ret<span class="token punctuation">))</span>
        return<span class="token punctuation">(</span><span class="token string">"failed"</span><span class="token punctuation">)</span>
    else:
        return<span class="token punctuation">(</span>sEchoStr<span class="token punctuation">)</span>
 
<span class="token comment"># 实际接受消息</span>
def signature2<span class="token punctuation">(</span>request, i<span class="token punctuation">)</span>:
    msg_signature <span class="token operator">=</span> request.args.get<span class="token punctuation">(</span><span class="token string">'msg_signature'</span>, <span class="token string">''</span><span class="token punctuation">)</span>
    timestamp <span class="token operator">=</span> request.args.get<span class="token punctuation">(</span><span class="token string">'timestamp'</span>, <span class="token string">''</span><span class="token punctuation">)</span>
    nonce <span class="token operator">=</span> request.args.get<span class="token punctuation">(</span><span class="token string">'nonce'</span>, <span class="token string">''</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> request.data.decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    ret,sMsg<span class="token operator">=</span>qy_api<span class="token punctuation">[</span>i<span class="token punctuation">]</span>.DecryptMsg<span class="token punctuation">(</span>data,msg_signature, timestamp,nonce<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>:
        print<span class="token punctuation">(</span><span class="token string">"ERR: DecryptMsg ret: "</span> + str<span class="token punctuation">(</span>ret<span class="token punctuation">))</span>
        return<span class="token punctuation">(</span><span class="token string">"failed"</span><span class="token punctuation">)</span>
    else:
        with <span class="token function">open</span> <span class="token punctuation">(</span><span class="token string">"/var/log/qywx.log"</span>, <span class="token string">'a+'</span><span class="token punctuation">)</span> as f: <span class="token comment"># 消息接收日志</span>
            doc <span class="token operator">=</span> parseString<span class="token punctuation">(</span>sMsg<span class="token punctuation">)</span>
            collection <span class="token operator">=</span> doc.documentElement
            name_xml <span class="token operator">=</span> collection.getElementsByTagName<span class="token punctuation">(</span><span class="token string">"FromUserName"</span><span class="token punctuation">)</span>
            msg_xml <span class="token operator">=</span> collection.getElementsByTagName<span class="token punctuation">(</span><span class="token string">"Content"</span><span class="token punctuation">)</span>
            type_xml <span class="token operator">=</span> collection.getElementsByTagName<span class="token punctuation">(</span><span class="token string">"MsgType"</span><span class="token punctuation">)</span>
            pic_xml <span class="token operator">=</span> collection.getElementsByTagName<span class="token punctuation">(</span><span class="token string">"PicUrl"</span><span class="token punctuation">)</span>
            msg <span class="token operator">=</span> <span class="token string">""</span>
            name <span class="token operator">=</span> <span class="token string">""</span>
            msg_type <span class="token operator">=</span> type_xml<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.childNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.data
            <span class="token keyword">if</span> msg_type <span class="token operator">==</span> <span class="token string">"text"</span><span class="token builtin class-name">:</span> <span class="token comment">#文本消息</span>
                name <span class="token operator">=</span> name_xml<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.childNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.data        <span class="token comment">#发送者id</span>
                msg <span class="token operator">=</span> msg_xml<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.childNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.data          <span class="token comment">#发送的消息内容</span>
                f.write<span class="token punctuation">(</span>time.strftime<span class="token punctuation">(</span><span class="token string">'[%Y-%m-%d %H:%M:%S]'</span><span class="token punctuation">)</span> + <span class="token string">"[ch%d] %s:%s<span class="token entity" title="\n">\n</span>"</span> % <span class="token punctuation">(</span>i, name, msg<span class="token punctuation">))</span>
                _thread.start_new_thread<span class="token punctuation">(</span>os.system, <span class="token punctuation">(</span><span class="token string">"python3 command.py '%s' '%s' '%d' '%d'"</span> % <span class="token punctuation">(</span>name, msg, i, <span class="token number">0</span><span class="token punctuation">)</span>, <span class="token punctuation">))</span> <span class="token comment">#此处将消息进行外部业务处理</span>
                
            <span class="token keyword">elif</span> msg_type <span class="token operator">==</span> <span class="token string">"image"</span><span class="token builtin class-name">:</span> <span class="token comment">#图片消息</span>
                name <span class="token operator">=</span> name_xml<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.childNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.data
                pic_url <span class="token operator">=</span> pic_xml<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.childNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.data
                f.write<span class="token punctuation">(</span>time.strftime<span class="token punctuation">(</span><span class="token string">'[%Y-%m-%d %H:%M:%S]'</span><span class="token punctuation">)</span> + <span class="token string">"[ch%d] %s:图片消息<span class="token entity" title="\n">\n</span>"</span> % <span class="token punctuation">(</span>i, name<span class="token punctuation">))</span>
                _thread.start_new_thread<span class="token punctuation">(</span>os.system, <span class="token punctuation">(</span><span class="token string">"python3 command.py '%s' '%s' '%d' '%d'"</span> % <span class="token punctuation">(</span>name, pic_url, i, <span class="token number">1</span><span class="token punctuation">)</span>, <span class="token punctuation">))</span>  <span class="token comment">#此处将消息进行外部业务处理</span>
 
            f.close<span class="token punctuation">(</span><span class="token punctuation">)</span>
 
        return<span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span>
 
<span class="token keyword">if</span> <span class="token assign-left variable">__name__</span><span class="token operator">==</span><span class="token string">'__main__'</span><span class="token builtin class-name">:</span>
    app.run<span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span>, <span class="token number">888</span><span class="token punctuation">)</span>  <span class="token comment">#本地监听端口,可自定义</span>
</code></pre> 
<p>共修改三处配置，如下</p> 
<pre><code class="prism language-python">qy_api <span class="token operator">=</span> <span class="token punctuation">[</span>
    WXBizMsgCrypt<span class="token punctuation">(</span><span class="token string">"XXXXXXX"</span><span class="token punctuation">,</span> <span class="token string">"XXXXXXX"</span><span class="token punctuation">,</span> <span class="token string">"XXXXXXX"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">]</span> <span class="token comment">#对应接受消息回调模式中的token，EncodingAESKey 和 企业信息中的企业id</span>
</code></pre> 
<p>执行 <code>wechat.py</code> 脚本，如果缺py依赖就pip3 install 安装一下，此处不在赘述！！</p> 
<pre><code class="prism language-bash">python3 wechat.py
</code></pre> 
<p>如下图表示启动成功：<br> <img src="https://images2.imgbox.com/45/08/3zBqOIsH_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>http://公网IP地址:888/hook_path</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/56/d8/njkcECQ8_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/a3/05/jCuXmYFz_o.png" alt="在这里插入图片描述"><br> OK，设置完成！，接下来可以添加<code>企业可信IP</code>了。<br> <img src="https://images2.imgbox.com/a5/b5/RNTAwYTf_o.png" alt="在这里插入图片描述"><br> 最后最后，告警也是成功发送到了企业微信，如下图：<br> <img src="https://images2.imgbox.com/ce/b4/5Qg33Cq4_o.png" alt=""><br> 至此结束！！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9b61e5c8843584328ae8d5df2b18d639/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CRUD增删改查，MySql Druid简化代码封装增删改查</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/03133ba91422b665e25d41661127b00c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【问题描述】编写一个程序，用户输入日期，计算该日期是这一年的第几天</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>