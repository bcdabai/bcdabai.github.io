<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>接口自动化测试中的数据处理 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="接口自动化测试中的数据处理" />
<meta property="og:description" content="接口自动化测试中的数据处理 配置文件数据的准备和记录与数据库交互进行数据替换Context环境管理方式正则 日志处理 配置文件 采用 yaml 作为配置文件，将一些重要的配置数据，如 数据库配置、host配置、相应权限的账号数据 放到 yaml文件中
conf.yaml
db_info: dbname: swiper host: 192.168.0.103 port: 3306 user: bobo pwd: hh123456 ApiHost: mockhost: http://127.0.0.1:4523/mock/894992 testhost: http://10.1.134.98:8787 prehost: http://10.1.100.10:8080 user: phonemun: 15911112223 pwd: bobo123456 封装读取配置文件
YamlHandler.py
import yaml # 读取yaml文件 class ReadYaml: def __init__(self, path, param=None): self.path = path # 文件路径 self.param = param # 不传默认获取所有数据 # 获取yaml文件中的数据 def get_data(self, encoding=&#39;utf-8&#39;): with open(self.path, encoding=encoding) as f: data = yaml.load(f.read(), Loader=yaml." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/49bc06aab425dd2a8e869ba248e5aa53/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-06T00:11:20+08:00" />
<meta property="article:modified_time" content="2022-05-06T00:11:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">接口自动化测试中的数据处理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>接口自动化测试中的数据处理</h4> 
 <ul><li><ul><li><ul><li><a href="#_4" rel="nofollow">配置文件</a></li><li><a href="#_57" rel="nofollow">数据的准备和记录</a></li><li><ul><li><a href="#_59" rel="nofollow">与数据库交互进行数据替换</a></li><li><a href="#Context_234" rel="nofollow">Context环境管理方式</a></li><li><a href="#_430" rel="nofollow">正则</a></li></ul> 
    </li><li><a href="#_532" rel="nofollow">日志处理</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h4><a id="_4"></a>配置文件</h4> 
<p>采用 yaml 作为配置文件，将一些重要的配置数据，如 <code>数据库配置、host配置、相应权限的账号数据</code> 放到 yaml文件中</p> 
<p><strong>conf.yaml</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">db_info</span><span class="token punctuation">:</span>
  <span class="token key atrule">dbname</span><span class="token punctuation">:</span> swiper
  <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.0.103
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
  <span class="token key atrule">user</span><span class="token punctuation">:</span> bobo
  <span class="token key atrule">pwd</span><span class="token punctuation">:</span> hh123456


<span class="token key atrule">ApiHost</span><span class="token punctuation">:</span>
  <span class="token key atrule">mockhost</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>4523/mock/894992
  <span class="token key atrule">testhost</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//10.1.134.98<span class="token punctuation">:</span><span class="token number">8787</span>
  <span class="token key atrule">prehost</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//10.1.100.10<span class="token punctuation">:</span><span class="token number">8080</span>
  
<span class="token key atrule">user</span><span class="token punctuation">:</span>
  <span class="token key atrule">phonemun</span><span class="token punctuation">:</span> <span class="token number">15911112223</span>
  <span class="token key atrule">pwd</span><span class="token punctuation">:</span> bobo123456
	
</code></pre> 
<p>封装读取配置文件</p> 
<p><strong>YamlHandler.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> yaml

<span class="token comment"># 读取yaml文件</span>
<span class="token keyword">class</span> <span class="token class-name">ReadYaml</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">,</span> param<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>path <span class="token operator">=</span> path  <span class="token comment"># 文件路径</span>
        self<span class="token punctuation">.</span>param <span class="token operator">=</span> param  <span class="token comment"># 不传默认获取所有数据</span>

    <span class="token comment"># 获取yaml文件中的数据</span>
    <span class="token keyword">def</span> <span class="token function">get_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">,</span> encoding<span class="token operator">=</span>encoding<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Loader<span class="token operator">=</span>yaml<span class="token punctuation">.</span>FullLoader<span class="token punctuation">)</span>

            <span class="token keyword">if</span> self<span class="token punctuation">.</span>param <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> data  <span class="token comment"># 返回所有数据</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span>self<span class="token punctuation">.</span>param<span class="token punctuation">)</span>  <span class="token comment"># 获取键为param的值</span>

</code></pre> 
<h4><a id="_57"></a>数据的准备和记录</h4> 
<h5><a id="_59"></a>与数据库交互进行数据替换</h5> 
<p>接口自动化测试项目中，有些数据需要从数据库中获取</p> 
<p><img src="https://images2.imgbox.com/ae/a1/lSO1vbVQ_o.png" alt="请添加图片描述"></p> 
<p>以最简单的注册接口为例，手机号不能在系统数据库中已存在，那么在excel文档中，可以用一些特殊字符先标注出来，然后再用代码进行替换</p> 
<p>与数据库进行交互，需要用到PyMySQL模块，详细介绍可查看该篇文章：<a href="https://blog.csdn.net/qq_44614026/article/details/123387913?spm=1001.2014.3001.5501">PyMySQL</a></p> 
<p><strong>DBHandler.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pymysql
<span class="token keyword">from</span> pymysql<span class="token punctuation">.</span>cursors <span class="token keyword">import</span> DictCursor



<span class="token keyword">class</span> <span class="token class-name">MysqlUtil</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>dbconf<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>dbconf <span class="token operator">=</span> dbconf
        self<span class="token punctuation">.</span>conn <span class="token operator">=</span> self<span class="token punctuation">.</span>get_conn<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 连接对象</span>
        self<span class="token punctuation">.</span>cursor <span class="token operator">=</span> self<span class="token punctuation">.</span>get_cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 游标对象</span>

    <span class="token keyword">def</span> <span class="token function">get_conn</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 获取连接对象 """</span>
        conn <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span>self<span class="token punctuation">.</span>dbconf<span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                               port<span class="token operator">=</span>self<span class="token punctuation">.</span>dbconf<span class="token punctuation">[</span><span class="token string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                               user<span class="token operator">=</span>self<span class="token punctuation">.</span>dbconf<span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                               passwd<span class="token operator">=</span>self<span class="token punctuation">.</span>dbconf<span class="token punctuation">[</span><span class="token string">'pwd'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                               db<span class="token operator">=</span>self<span class="token punctuation">.</span>dbconf<span class="token punctuation">[</span><span class="token string">'dbname'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                               charset<span class="token operator">=</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> conn

    <span class="token keyword">def</span> <span class="token function">get_cursor</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""获取游标对象"""</span>
        <span class="token comment"># cursor = None</span>
        cursor <span class="token operator">=</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span>cursor<span class="token operator">=</span>pymysql<span class="token punctuation">.</span>cursors<span class="token punctuation">.</span>DictCursor<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cursor

    <span class="token keyword">def</span> <span class="token function">query</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sql<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> one<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''查询语句，默认只查询一条'''</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 执行sql语句</span>
            self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
            <span class="token comment"># 提交事务（使得每次游标都在初始位置）</span>
            self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># 获取结果</span>
            <span class="token keyword">if</span> one<span class="token punctuation">:</span>
                <span class="token keyword">return</span> self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>fetchone<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token comment"># 若出现错误，则回滚</span>
            self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">commit_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        提交数据(更新、插入、删除操作)
        """</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 执行sql语句</span>
            self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
            <span class="token comment"># 提交事务</span>
            self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token comment"># 若出现错误，则回滚</span>
            self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>编写一个生成手机号码的函数</p> 
<p><strong>helper.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> random


<span class="token keyword">def</span> <span class="token function">gen_phonenun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''自动生成手机号码'''</span>
    phone <span class="token operator">=</span> <span class="token string">'1'</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">,</span><span class="token string">'5,'</span><span class="token punctuation">,</span><span class="token string">'7'</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span><span class="token string">'9'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        num <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span>
        phone <span class="token operator">+=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token keyword">return</span> phone
</code></pre> 
<p>测试用例文件</p> 
<p><strong>test_register.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">import</span> unittest
<span class="token keyword">import</span> os
<span class="token keyword">from</span> common <span class="token keyword">import</span> helper
<span class="token keyword">from</span> common <span class="token keyword">import</span> ddt
<span class="token keyword">from</span> common<span class="token punctuation">.</span>RequestHandler <span class="token keyword">import</span> HTTPHandler
<span class="token keyword">from</span> common<span class="token punctuation">.</span>excel_handler <span class="token keyword">import</span> ExcelHandler
<span class="token keyword">from</span> common <span class="token keyword">import</span> dir_config
<span class="token keyword">from</span> common<span class="token punctuation">.</span>DBhandler <span class="token keyword">import</span> MysqlUtil
<span class="token keyword">from</span> common<span class="token punctuation">.</span>YamlHandler <span class="token keyword">import</span> ReadYaml


<span class="token decorator annotation punctuation">@ddt<span class="token punctuation">.</span>ddt</span>
<span class="token keyword">class</span> <span class="token class-name">Test_Register</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 读取测试数据</span>
    excel_handle <span class="token operator">=</span> ExcelHandler<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dir_config<span class="token punctuation">.</span>testdatas_dir<span class="token punctuation">,</span> <span class="token string">"data.xlsx"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    test_data <span class="token operator">=</span> excel_handle<span class="token punctuation">.</span>read_key_value<span class="token punctuation">(</span><span class="token string">"register"</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">setUp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>req <span class="token operator">=</span> HTTPHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>db_info <span class="token operator">=</span> ReadYaml<span class="token punctuation">(</span>dir_config<span class="token punctuation">.</span>yaml_dir<span class="token punctuation">,</span><span class="token string">'db_info'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> MysqlUtil<span class="token punctuation">(</span>self<span class="token punctuation">.</span>db_info<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>host <span class="token operator">=</span> ReadYaml<span class="token punctuation">(</span>dir_config<span class="token punctuation">.</span>yaml_dir<span class="token punctuation">,</span><span class="token string">'ApiHost'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'mockhost'</span><span class="token punctuation">]</span>


    <span class="token keyword">def</span> <span class="token function">tearDown</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>req<span class="token punctuation">.</span>close_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>



    <span class="token decorator annotation punctuation">@ddt<span class="token punctuation">.</span>data</span><span class="token punctuation">(</span><span class="token operator">*</span>test_data<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">test_register</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>test_data<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token comment"># 判断excel中是否 出现了 #new_phone# ，如果出现，随机生成一个，进行替换</span>
        <span class="token keyword">if</span> <span class="token string">'#new_phone#'</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                mobilephone <span class="token operator">=</span> helper<span class="token punctuation">.</span>gen_phonenun<span class="token punctuation">(</span><span class="token punctuation">)</span>
                sql1 <span class="token operator">=</span> <span class="token triple-quoted-string string">'''SELECT *  FROM users WHERE phonenum = %s ;'''</span>
                dbphone <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>sql<span class="token operator">=</span>sql1<span class="token punctuation">,</span>args<span class="token operator">=</span>mobilephone<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> dbphone<span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
            test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'$new_phone$'</span><span class="token punctuation">,</span> mobilephone<span class="token punctuation">)</span>

        <span class="token comment"># 判断excel中是否 出现了 $exist_phone$ ，如果出现，随机生成一个，进行替换</span>
        <span class="token keyword">if</span> <span class="token string">'#exist_phone#'</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            sql2 <span class="token operator">=</span> <span class="token triple-quoted-string string">'''select phonenum from users limit 1;'''</span>
            mobilephone <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>sql<span class="token operator">=</span>sql2<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"phonenum"</span><span class="token punctuation">]</span>
            test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'$exist_phone$'</span><span class="token punctuation">,</span> mobilephone<span class="token punctuation">)</span>

        

        res <span class="token operator">=</span>  self<span class="token punctuation">.</span>req<span class="token punctuation">.</span>visit<span class="token punctuation">(</span>
                              url<span class="token operator">=</span> self<span class="token punctuation">.</span>host<span class="token operator">+</span>test_data<span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                              method<span class="token operator">=</span>test_data<span class="token punctuation">[</span><span class="token string">"method"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                              headers<span class="token operator">=</span><span class="token builtin">eval</span><span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"headers"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              json<span class="token operator">=</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>test_data<span class="token punctuation">[</span><span class="token string">"excepted"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>如果excel中出现了<code>#new_phone#</code>，则通过<code>gen_phonenun</code>方法生成一个手机号<code>mobilephone</code>，在数据库中查询手机号<code>mobilephone</code>是否存在。若不存在，则使用该号码，通过<code>replace</code>函数，将代码读取的<code>test_data["json"]</code>数据中的<code>#new_phone#</code>替换为手机号；若存在，则继续 <code>while True</code> 循环，直到生成的手机号在数据库中不出存在，跳出循环</p> 
<p>如果excel中出现了<code>#exist_phone#</code>，则在数据库中查询一条已注册成功的手机号，通过<code>replace</code>函数，将代码读取的<code>test_data["json"]</code>数据中的<code>#exist_phone#</code>替换为手机号</p> 
<h5><a id="Context_234"></a>Context环境管理方式</h5> 
<p>在接口测试中，大多数接口，需要获取登录成功后的一些权限校验或信息校验的内容，比如 <code>token</code>，或者一些接口需要用到<code>key</code>，而这些内容，在多个接口中会经常用到。这些内容，称为<code>用例关联</code>或<code>用例依赖</code>，在面试中，有时会问到，这种类型的数据怎么处理</p> 
<p>例如，登录接口响应成功，返回一些用户信息</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"code"</span><span class="token operator">:</span> <span class="token string">"0000"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"msg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"result"</span><span class="token operator">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"info"</span><span class="token operator">:</span> <span class="token string">"登录成功"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"errorinfo"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string-property property">"userinfo"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"memberid"</span><span class="token operator">:</span> <span class="token string">"20012345644"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"nickname"</span><span class="token operator">:</span> <span class="token string">"沉觞"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string-property property">"permission"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string-property property">"tokeninfo"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"tokenType"</span><span class="token operator">:</span> <span class="token string">"VIP"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"tokenmsg"</span><span class="token operator">:</span> <span class="token string">"21232f297a57a5a743894a0e4a801fc3"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在其他接口的测试中，需要封装一个方法对登录接口返回内容的 <code>memberid</code> 和 <code>token</code>信息进行处理，这些内容，同样放到<code>helper.py</code>文件中</p> 
<p><strong>helper.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> ReadYaml<span class="token punctuation">(</span>dir_config<span class="token punctuation">.</span>yaml_dir<span class="token punctuation">,</span> <span class="token string">'ApiHost'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'mockhost'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'/user/login'</span>
    json <span class="token operator">=</span> ReadYaml<span class="token punctuation">(</span>dir_config<span class="token punctuation">.</span>yaml_dir<span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"Content-Type"</span><span class="token punctuation">:</span><span class="token string">"application/json"</span><span class="token punctuation">,</span><span class="token string">"apikey"</span><span class="token punctuation">:</span><span class="token string">"21232f297a57a5a743894a0e4a801fc3"</span><span class="token punctuation">}</span>

    res <span class="token operator">=</span> HTTPHandler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visit<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">'post'</span><span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>json<span class="token operator">=</span>json<span class="token punctuation">)</span>
    <span class="token keyword">return</span> res


<span class="token keyword">def</span> <span class="token function">save_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> login<span class="token punctuation">(</span><span class="token punctuation">)</span>

    tokenType <span class="token operator">=</span> jsonpath<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'$...tokenType'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    tokenmsg <span class="token operator">=</span> jsonpath<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'$...tokenmsg'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    memberid <span class="token operator">=</span> jsonpath<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'$...memberid'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    token <span class="token operator">=</span> tokenType <span class="token operator">+</span> tokenmsg

</code></pre> 
<p>如果用到<code>memberid</code> 和 <code>token</code> 信息的测试用例文件数量比较少，那么只需要测试用例文件的前置条件 <code>Setup</code>中调用<code>save_token</code>函数，即可获取<code>memberid</code> 和 <code>token</code> 信息；</p> 
<p>但如果测试用例文件很多，那这些内容可以放到类变量里。新增一个<code>Context</code>类，<code>Context</code>中文意思叫<code>上下文</code>，在自动化测试中，对于一些临时数据处理、数据的准备和记录，经常用这种方式</p> 
<p>上述测试用例py文件里， <code>Setup</code>中的<code>db_info</code>、<code>host</code>等内容，这些在其他测试用例文件中，也会经常用到，可以放到<code>Context</code>类使其变为类变量</p> 
<p>与<code>db_info</code>、<code>host</code>等内容不同的是，<code>memberid</code> 和 <code>token</code> 信息，在<code>Context</code>类中定义<code>memberid</code> 和 <code>token</code> 函数，通过添加 <code>@property</code>装饰器方式将其变为实例属性，这样，就可以通过 <code>Context().memberid</code>的方式获取<code>memberid</code> 、<code>Context().token</code>的方式获取<code>token</code></p> 
<p><strong>helper.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> random
<span class="token keyword">from</span> jsonpath <span class="token keyword">import</span> jsonpath
<span class="token keyword">from</span> common <span class="token keyword">import</span> dir_config
<span class="token keyword">from</span> common<span class="token punctuation">.</span>YamlHandler <span class="token keyword">import</span> ReadYaml
<span class="token keyword">from</span> common<span class="token punctuation">.</span>RequestHandler <span class="token keyword">import</span> HTTPHandler

<span class="token keyword">class</span> <span class="token class-name">Context</span><span class="token punctuation">:</span>
    
    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">token</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        token属性，且会动态变化
        通过Context().token可以获取token，自动调用这个方法
        '''</span>
        data <span class="token operator">=</span> login<span class="token punctuation">(</span><span class="token punctuation">)</span>
        tokenType <span class="token operator">=</span> jsonpath<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'$...tokenType'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        tokenmsg <span class="token operator">=</span> jsonpath<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'$...tokenmsg'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        t <span class="token operator">=</span> tokenType <span class="token operator">+</span> tokenmsg
        <span class="token keyword">return</span> t

    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">memberid</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> login<span class="token punctuation">(</span><span class="token punctuation">)</span>
        m_id <span class="token operator">=</span> jsonpath<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'$...memberid'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> m_id
    
    
    host <span class="token operator">=</span> ReadYaml<span class="token punctuation">(</span>dir_config<span class="token punctuation">.</span>yaml_dir<span class="token punctuation">,</span><span class="token string">'ApiHost'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'mockhost'</span><span class="token punctuation">]</span>
    db_info <span class="token operator">=</span> ReadYaml<span class="token punctuation">(</span>dir_config<span class="token punctuation">.</span>yaml_dir<span class="token punctuation">,</span><span class="token string">'db_info'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
    user_info <span class="token operator">=</span> ReadYaml<span class="token punctuation">(</span>dir_config<span class="token punctuation">.</span>yaml_dir<span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
    

        
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> Context<span class="token punctuation">.</span>host<span class="token operator">+</span><span class="token string">'/user/login'</span>
    json <span class="token operator">=</span> ReadYaml<span class="token punctuation">(</span>dir_config<span class="token punctuation">.</span>yaml_dir<span class="token punctuation">,</span> <span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"Content-Type"</span><span class="token punctuation">:</span><span class="token string">"application/json"</span><span class="token punctuation">,</span><span class="token string">"apikey"</span><span class="token punctuation">:</span><span class="token string">"21232f297a57a5a743894a0e4a801fc3"</span><span class="token punctuation">}</span>

    res <span class="token operator">=</span> HTTPHandler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visit<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>method<span class="token operator">=</span><span class="token string">'post'</span><span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>json<span class="token operator">=</span>json<span class="token punctuation">)</span>
    <span class="token keyword">return</span> res

<span class="token comment"># if __name__ == '__main__':</span>
    <span class="token comment"># print(Context().memberid)</span>
    <span class="token comment"># 输出结果 20012345644</span>
    <span class="token comment"># print(Context().token)</span>
    <span class="token comment"># 输出结果 VIP263A68169E5CCCEAE5A9739E28109AC1</span>
</code></pre> 
<p><strong>注意：</strong> 这里<code>login</code>函数并不是 <code>Context</code>类里的函数</p> 
<p><img src="https://images2.imgbox.com/7e/b7/fFIA2JuE_o.png" alt="请添加图片描述"></p> 
<p><strong>test_charge.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">import</span> time
<span class="token keyword">import</span> unittest
<span class="token keyword">import</span> os
<span class="token keyword">from</span> middleware <span class="token keyword">import</span> helper
<span class="token keyword">from</span> common <span class="token keyword">import</span> ddt
<span class="token keyword">from</span> common<span class="token punctuation">.</span>RequestHandler <span class="token keyword">import</span> HTTPHandler
<span class="token keyword">from</span> common<span class="token punctuation">.</span>excel_handler <span class="token keyword">import</span> ExcelHandler
<span class="token keyword">from</span> common <span class="token keyword">import</span> dir_config
<span class="token keyword">from</span> common<span class="token punctuation">.</span>logger <span class="token keyword">import</span> Logger
<span class="token keyword">from</span> common<span class="token punctuation">.</span>DBhandler <span class="token keyword">import</span> MysqlUtil
<span class="token keyword">from</span> common<span class="token punctuation">.</span>YamlHandler <span class="token keyword">import</span> ReadYaml


<span class="token decorator annotation punctuation">@ddt<span class="token punctuation">.</span>ddt</span>
<span class="token keyword">class</span> <span class="token class-name">Test_Register</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 读取测试数据</span>
    excel_handle <span class="token operator">=</span> ExcelHandler<span class="token punctuation">(</span>helper<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>excelpath<span class="token punctuation">)</span>
    test_data <span class="token operator">=</span> excel_handle<span class="token punctuation">.</span>read_key_value<span class="token punctuation">(</span><span class="token string">"charge"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">setUp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>req <span class="token operator">=</span> HTTPHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> MysqlUtil<span class="token punctuation">(</span>helper<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>db_info<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>host <span class="token operator">=</span> helper<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>host
        self<span class="token punctuation">.</span>token <span class="token operator">=</span> helper<span class="token punctuation">.</span>Context<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>token
        self<span class="token punctuation">.</span>memberid <span class="token operator">=</span> helper<span class="token punctuation">.</span>Context<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>memberid


    <span class="token keyword">def</span> <span class="token function">tearDown</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>req<span class="token punctuation">.</span>close_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>



    <span class="token decorator annotation punctuation">@ddt<span class="token punctuation">.</span>data</span><span class="token punctuation">(</span><span class="token operator">*</span>test_data<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">test_charge</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>test_data<span class="token punctuation">)</span><span class="token punctuation">:</span>

        
        sql <span class="token operator">=</span> <span class="token triple-quoted-string string">'''SELECT money from memberinfo where memberid = %s;'''</span>
        <span class="token comment"># 查询用户账户初始金额</span>
        before_money <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>sql<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>memberid<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># 判断excel中是否 出现了 #memberid# ，如果出现，进行替换</span>
        <span class="token keyword">if</span> <span class="token string">'#memberid#'</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'#memberid#'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>memberid<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 读取excel中的headers数据（字典类型）</span>
        headers <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"headers"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 添加token信息</span>
        <span class="token keyword">if</span> headers<span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'#token#'</span><span class="token punctuation">:</span>
            headers<span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>token

        res <span class="token operator">=</span>  self<span class="token punctuation">.</span>req<span class="token punctuation">.</span>visit<span class="token punctuation">(</span>
                              url<span class="token operator">=</span> self<span class="token punctuation">.</span>host<span class="token operator">+</span>test_data<span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                              method<span class="token operator">=</span>test_data<span class="token punctuation">[</span><span class="token string">"method"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                              headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>
                              json<span class="token operator">=</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        
		<span class="token comment"># 充值成功，断言 充值前金额+充值金额 是否等于 充值后金额</span>
        <span class="token keyword">if</span> res<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"0000"</span><span class="token punctuation">:</span>
            charge_money <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"chargeinfo"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"chargeMoney"</span><span class="token punctuation">]</span>
            <span class="token comment"># 查询用户账户充值后的金额</span>
            after_money <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>memberid<span class="token punctuation">]</span><span class="token punctuation">)</span>
            
            self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>before_money<span class="token operator">+</span>charge_money<span class="token punctuation">,</span>after_money<span class="token punctuation">)</span>


</code></pre> 
<h5><a id="_430"></a>正则</h5> 
<p>在excel文件中，会出现许多类似 <code>$memberid$</code> 这种需要进行替换的数据，而在代码中，需要用 <code>if</code> 进行判断，如果<code>if</code> 这种判断增加，代码就会看起来很繁重，且执行效率会变慢</p> 
<p>如果用上正则的方式进行替换，就会减少很多繁重的内容</p> 
<p><code>re.search()</code> 函数会在字符串中查找模式匹配，只要找到第一个匹配然后返回，若没有找到匹配则返回<code>None</code></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> re
data <span class="token operator">=</span> <span class="token triple-quoted-string string">'''{"memberid": "#memberid#","phonenum": "#phonenum#"}'''</span>

pattern <span class="token operator">=</span> <span class="token string">r"#(.*?)#"</span>
a <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token comment"># 输出结果 #memberid#</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token comment"># 输出结果memberid</span>
</code></pre> 
<p><code>re.sub()</code>替换<code>string</code>中子串后返回替换后的新串</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> re
data <span class="token operator">=</span> <span class="token triple-quoted-string string">'''{"memberid": "#memberid#","phonenum": "#phonenum#"}'''</span>

pattern <span class="token operator">=</span> <span class="token string">r"#(.*?)#"</span>
replace_data <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span><span class="token string">'这是替换内容'</span><span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>	<span class="token comment"># 替换一次</span>
replace_data2 <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span><span class="token string">'这是替换内容2'</span><span class="token punctuation">,</span>data<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>	<span class="token comment"># 替换两次</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>replace_data<span class="token punctuation">)</span> 
<span class="token comment"># 输出结果	{"memberid": "这是替换内容","phonenum": "#phonenum#"}</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>replace_data2<span class="token punctuation">)</span>
<span class="token comment"># 输出结果	{"memberid": "这是替换内容2","phonenum": "这是替换内容2"}</span>
</code></pre> 
<p><strong>helper.py</strong></p> 
<p>这一功能，同样可以放到<code>helper.py</code>里</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> re

<span class="token keyword">def</span> <span class="token function">replace_label</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    :param target: 需要匹配的字符串
    :return:返回替换成功的内容
    '''</span>
    <span class="token comment"># 匹配的格式</span>
    pattern <span class="token operator">=</span> <span class="token string">r"#(.*?)#"</span>

    <span class="token comment"># 如果匹配的字符串中存在匹配项</span>
    <span class="token keyword">while</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span>target<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 获取字符串中需要替换的内容</span>
        key <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 获取替换的数据</span>
        value <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">getattr</span><span class="token punctuation">(</span>Context<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 将 target 中的值进行1次替换</span>
        target <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span>value<span class="token punctuation">,</span>target<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> target

</code></pre> 
<p>这个时候，Context环境管理方式中的<code>Context类</code>，就起到作用了</p> 
<p>读取excel表格里的json数据后，若数据中包含需要替换的内容，如：<code>memberid</code>，将其赋予变量<code>key</code>；</p> 
<p>通过 <code>getattr()</code>函数获取<code>Context类</code>的<code>memberid</code>属性的值，再通过 <code>re.sub()</code>函数进行替换</p> 
<p>这块代码，可以直接使用<code>replace_label</code>函数进行简化</p> 
<pre><code class="prism language-python"><span class="token comment"># 判断excel中是否 出现了 #memberid# ，如果出现，进行替换</span>
        <span class="token keyword">if</span> <span class="token string">'#memberid#'</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'#memberid#'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>memberid<span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            
</code></pre> 
<p>变为</p> 
<pre><code class="prism language-python">test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span> <span class="token operator">=</span> helper<span class="token punctuation">.</span>replace_label<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">添加token信息
        <span class="token keyword">if</span> headers<span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'#token#'</span><span class="token punctuation">:</span>
            headers<span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>token
</code></pre> 
<p>变为</p> 
<pre><code class="prism language-python">headers <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>helper<span class="token punctuation">.</span>replace_label<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"headers"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_532"></a>日志处理</h4> 
<p>封装日志处理功能</p> 
<p><strong>logger.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> logging

<span class="token keyword">class</span> <span class="token class-name">Logger</span><span class="token punctuation">(</span>logging<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 初始化 Logger</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 name<span class="token operator">=</span><span class="token string">'root'</span><span class="token punctuation">,</span>
                 logger_level<span class="token operator">=</span> <span class="token string">'DEBUG'</span><span class="token punctuation">,</span>
                 <span class="token builtin">file</span><span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 logger_format <span class="token operator">=</span> <span class="token string">" [%(asctime)s]  %(levelname)s %(filename)s [ line:%(lineno)d ] %(message)s"</span>
                 <span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token comment"># 1、设置logger收集器，继承logging.Logger</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>


        <span class="token comment"># 2、设置日志收集器level级别</span>
        self<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logger_level<span class="token punctuation">)</span>

        <span class="token comment"># 5、设置 handler 格式</span>
        fmt <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span>logger_format<span class="token punctuation">)</span>

        <span class="token comment"># 3、设置日志处理器</span>

        <span class="token comment"># 如果传递了文件，就会输出到file文件中</span>
        <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
            file_handler <span class="token operator">=</span> logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>
            <span class="token comment"># 4、设置 file_handler 级别</span>
            file_handler<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logger_level<span class="token punctuation">)</span>
            <span class="token comment"># 6、设置handler格式</span>
            file_handler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>fmt<span class="token punctuation">)</span>
            <span class="token comment"># 7、添加handler</span>
            self<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>file_handler<span class="token punctuation">)</span>

        <span class="token comment"># 默认都输出到控制台</span>
        stream_handler <span class="token operator">=</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 4、设置 stream_handler 级别</span>
        stream_handler<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logger_level<span class="token punctuation">)</span>
        <span class="token comment"># 6、设置handler格式</span>
        stream_handler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>fmt<span class="token punctuation">)</span>
        <span class="token comment"># 7、添加handler</span>
        self<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>stream_handler<span class="token punctuation">)</span>

</code></pre> 
<p>在执行用例文件中引入日志信息</p> 
<p><strong>run.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> time
<span class="token keyword">import</span> unittest
<span class="token keyword">from</span> common <span class="token keyword">import</span> dir_config
<span class="token keyword">from</span> common<span class="token punctuation">.</span>HTMLTestRunnerNew <span class="token keyword">import</span> HTMLTestRunner
<span class="token keyword">from</span> common<span class="token punctuation">.</span>logger <span class="token keyword">import</span> Logger



testloader <span class="token operator">=</span> unittest<span class="token punctuation">.</span>TestLoader<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 全用例</span>
suit_total <span class="token operator">=</span> testloader<span class="token punctuation">.</span>discover<span class="token punctuation">(</span>dir_config<span class="token punctuation">.</span>testcases_dir<span class="token punctuation">)</span>
curTime <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H_%M"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

html_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dir_config<span class="token punctuation">.</span>htmlreport_dir<span class="token punctuation">,</span><span class="token string">'{}_test.html'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>curTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
log_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dir_config<span class="token punctuation">.</span>logs_dir<span class="token punctuation">,</span> <span class="token string">'{}_test.log'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>curTime<span class="token punctuation">)</span><span class="token punctuation">)</span>

logger <span class="token operator">=</span> Logger<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"APItest"</span><span class="token punctuation">,</span>logger_level<span class="token operator">=</span><span class="token string">'DEBUG'</span><span class="token punctuation">,</span><span class="token builtin">file</span><span class="token operator">=</span>log_path<span class="token punctuation">)</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>html_path<span class="token punctuation">,</span><span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    runner <span class="token operator">=</span> HTMLTestRunner<span class="token punctuation">(</span>f<span class="token punctuation">,</span>title<span class="token operator">=</span><span class="token string">'测试报告'</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">'测试报告内容为：'</span><span class="token punctuation">,</span>tester<span class="token operator">=</span><span class="token string">'bobo'</span><span class="token punctuation">)</span>

    runner<span class="token punctuation">.</span>run<span class="token punctuation">(</span>suit_total<span class="token punctuation">)</span>
</code></pre> 
<p>在测试用例文件中引入日志记录功能</p> 
<p><strong>test_register.py</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">import</span> unittest
<span class="token keyword">from</span> middleware <span class="token keyword">import</span> helper
<span class="token keyword">from</span> common <span class="token keyword">import</span> ddt
<span class="token keyword">from</span> common<span class="token punctuation">.</span>RequestHandler <span class="token keyword">import</span> HTTPHandler
<span class="token keyword">from</span> common<span class="token punctuation">.</span>excel_handler <span class="token keyword">import</span> ExcelHandler
<span class="token keyword">from</span> run_case <span class="token keyword">import</span> logger
<span class="token keyword">from</span> common<span class="token punctuation">.</span>DBhandler <span class="token keyword">import</span> MysqlUtil



<span class="token decorator annotation punctuation">@ddt<span class="token punctuation">.</span>ddt</span>
<span class="token keyword">class</span> <span class="token class-name">Test_Register</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 读取测试数据</span>
    excel_handle <span class="token operator">=</span> ExcelHandler<span class="token punctuation">(</span>helper<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>excelpath<span class="token punctuation">)</span>
    test_data <span class="token operator">=</span> excel_handle<span class="token punctuation">.</span>read_key_value<span class="token punctuation">(</span><span class="token string">"charge"</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">setUp</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>req <span class="token operator">=</span> HTTPHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> MysqlUtil<span class="token punctuation">(</span>helper<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>db_info<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>host <span class="token operator">=</span> helper<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>host
        self<span class="token punctuation">.</span>token <span class="token operator">=</span> helper<span class="token punctuation">.</span>Context<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>token
        self<span class="token punctuation">.</span>memberid <span class="token operator">=</span> helper<span class="token punctuation">.</span>Context<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>memberid
        self<span class="token punctuation">.</span>logger <span class="token operator">=</span> logger


    <span class="token keyword">def</span> <span class="token function">tearDown</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>req<span class="token punctuation">.</span>close_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token decorator annotation punctuation">@ddt<span class="token punctuation">.</span>data</span><span class="token punctuation">(</span><span class="token operator">*</span>test_data<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">test_charge</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>test_data<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token comment"># 查询用户账户初始金额</span>
        sql <span class="token operator">=</span> <span class="token triple-quoted-string string">'''SELECT money from Member where memberid = %s;'''</span>
        before_money <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>sql<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>memberid<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># 添加memberid信息 判断excel中是否 出现了 #memberid# ，如果出现，进行替换</span>
        test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span> <span class="token operator">=</span> helper<span class="token punctuation">.</span>replace_label<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># 添加token信息 判断excel中是否 出现了 #token# ，如果出现，进行替换</span>
        headers <span class="token operator">=</span> helper<span class="token punctuation">.</span>replace_label<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"headers"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"用例名称：{};接口信息：url={}；method={}；headers={}；json={}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"case_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                                                   self<span class="token punctuation">.</span>host<span class="token operator">+</span>test_data<span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                                                   test_data<span class="token punctuation">[</span><span class="token string">"method"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                                                                   json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                                   json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                                                                                   <span class="token punctuation">)</span>
                         <span class="token punctuation">)</span>

        res <span class="token operator">=</span>  self<span class="token punctuation">.</span>req<span class="token punctuation">.</span>visit<span class="token punctuation">(</span>
                              url<span class="token operator">=</span> self<span class="token punctuation">.</span>host<span class="token operator">+</span>test_data<span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                              method<span class="token operator">=</span>test_data<span class="token punctuation">[</span><span class="token string">"method"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                              headers<span class="token operator">=</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">,</span>
                              json<span class="token operator">=</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"接口响应内容：{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 错误处理，抛出异常</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test_data<span class="token punctuation">[</span><span class="token string">"excepted"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"接口响应code:{}，期望响应code:{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test_data<span class="token punctuation">[</span><span class="token string">"excepted"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># 写入实际结果到excel表格</span>
            self<span class="token punctuation">.</span>excel_handle<span class="token punctuation">.</span>write_change<span class="token punctuation">(</span>helper<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>excelpath<span class="token punctuation">,</span>
                                           <span class="token string">"register"</span><span class="token punctuation">,</span>
                                           test_data<span class="token punctuation">[</span><span class="token string">"caseid"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">"passed"</span><span class="token punctuation">)</span>

        <span class="token keyword">except</span> AssertionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"测试用例执行失败：{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>excel_handle<span class="token punctuation">.</span>write_change<span class="token punctuation">(</span>helper<span class="token punctuation">.</span>Context<span class="token punctuation">.</span>excelpath<span class="token punctuation">,</span>
                                           <span class="token string">"register"</span><span class="token punctuation">,</span>
                                           test_data<span class="token punctuation">[</span><span class="token string">"caseid"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">"failed"</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> e

        <span class="token keyword">if</span> res<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"0000"</span><span class="token punctuation">:</span>
            charge_money <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token string">"json"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"chargeinfo"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"chargeMoney"</span><span class="token punctuation">]</span>
            <span class="token comment"># 查询用户账户充值后的金额</span>
            after_money <span class="token operator">=</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>memberid<span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"用户账户初始金额:{}，充值金额:{}，用户账户充值后的金额:{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>before_money<span class="token punctuation">,</span>charge_money<span class="token punctuation">,</span>after_money<span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>assertEqual<span class="token punctuation">(</span>before_money<span class="token operator">+</span>charge_money<span class="token punctuation">,</span>after_money<span class="token punctuation">)</span>
       
</code></pre> 
<p>对于关键内容，加上日志功能，如接口的请求信息，接口的响应内容，对于失败用例，使用<code>try...except</code>进行错误处理，将错误内容抛出</p> 
<p>log文件示例内容：</p> 
<pre><code class="prism language-log"> [2022-05-06 00:05:01,157]  INFO test_charge.py [ line:50 ] 用例名称：充值成功;接口信息：url=http://127.0.0.1:4523/mock/894992/user/charge；method=post；headers={'Content-Type': 'application/json', 'apikey': '21232f297a57a5a743894a0e4a801fc3', 'token': 'VIP263A68169E5CCCEAE5A9739E28109AC1'}；json={'userinfo': {'memberid': '20012345644', 'type': 88, 'permission': True}, 'chargeinfo': {'chargeType': 'WX', 'chargeMoney': 43}}
 [2022-05-06 00:05:01,160]  INFO test_charge.py [ line:60 ] 接口响应内容：{'code': '0000', 'msg': {'result': 'success', 'info': '充值成功'}, 'errorinfo': None, 'chargeinfo': {'money': 10550, 'memberlevel': 'SVIP', 'integraladd': 43}}
 [2022-05-06 00:05:01,161]  INFO test_charge.py [ line:65 ] 接口响应code:0000，期望响应code:0000
 [2022-05-06 00:05:01,199]  INFO test_charge.py [ line:82 ] 用户账户初始金额:10507，充值金额:43，用户账户充值后的金额:10550
 [2022-05-06 00:05:01,222]  INFO test_charge.py [ line:50 ] 用例名称：鉴权失败;接口信息：url=http://127.0.0.1:4523/mock/894992/user/charge；method=post；headers={'Content-Type': 'application/json', 'apikey': '21232f297a57a5a743894a0e4a801fc3', 'token': ''}；json={'userinfo': {'memberid': '20012345644', 'type': 88, 'permission': True}, 'chargeinfo': {'chargeType': 'WX', 'chargeMoney': 43}}
 [2022-05-06 00:05:01,226]  INFO test_charge.py [ line:60 ] 接口响应内容：{'code': '0001', 'msg': {'result': 'false', 'errorinfo': '权限校验失败'}}
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e56cdaccf01f0ead11b17bbd415dd2a4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">有关于/,*/,**/的区别</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/23066c874e624a53bd24642d000bdb1e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">廖雪峰Python教程学习笔记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>