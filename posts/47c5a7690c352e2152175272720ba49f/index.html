<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>python微信PC端自动化-获取消息发送时间 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="python微信PC端自动化-获取消息发送时间" />
<meta property="og:description" content="背景 之前我们讲了如何利用python自动获取微信聊天记录，感兴趣的小伙伴可查看我之前的文章。不过，之前的方法都只获取了微信的聊天内容，有些场景或项目中可能需要我们记录各条消息的发送时间。这一节我们来看一下如何获取微信聊天消息的发送时间。
项目准备 1. 微信PC客户端
（注：这里最好把微信客户端升级至较新版本）
2. python3.x
3. wxauto
pip install wxauto -i https://pypi.tuna.tsinghua.edu.cn/simple
具体方法 在wxauto.py中，有这么一段代码，用于解析微信聊天窗口中的一些系统消息，如：消息发送时间、撤回信息、“某某邀请某某入群”等等。
def SplitMessage(MsgItem): uia.SetGlobalSearchTimeout(0) MsgItemName = MsgItem.Name if MsgItem.BoundingRectangle.height() == WxParam.SYS_TEXT_HEIGHT: Msg = (&#39;SYS&#39;, MsgItemName, &#39;&#39;.join([str(i) for i in MsgItem.GetRuntimeId()])) elif MsgItem.BoundingRectangle.height() == WxParam.TIME_TEXT_HEIGHT: Msg = (&#39;Time&#39;, MsgItemName, &#39;&#39;.join([str(i) for i in MsgItem.GetRuntimeId()])) elif MsgItem.BoundingRectangle.height() == WxParam.RECALL_TEXT_HEIGHT: if &#39;撤回&#39; in MsgItemName: Msg = (&#39;Recall&#39;, MsgItemName, &#39;&#39;.join([str(i) for i in MsgItem.GetRuntimeId()])) else: Msg = (&#39;SYS&#39;, MsgItemName, &#39;&#39;." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/47c5a7690c352e2152175272720ba49f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-19T11:57:26+08:00" />
<meta property="article:modified_time" content="2023-08-19T11:57:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">python微信PC端自动化-获取消息发送时间</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>背景</h2> 
<p>之前我们讲了如何利用python自动获取微信聊天记录，感兴趣的小伙伴可查看我之前的文章。不过，之前的方法都只获取了微信的聊天内容，有些场景或项目中可能需要我们记录各条消息的发送时间。这一节我们来看一下如何获取微信聊天消息的发送时间。<br> <br></p> 
<h2><a id="_4"></a>项目准备</h2> 
<p><code> 1. 微信PC客户端</code><br> （注：这里最好把微信客户端升级至较新版本）</p> 
<p><code>2. python3.x</code><br> <br></p> 
<p><code>3. wxauto</code><br> pip install wxauto -i https://pypi.tuna.tsinghua.edu.cn/simple<br> <br></p> 
<h2><a id="_16"></a>具体方法</h2> 
<p>在wxauto.py中，有这么一段代码，用于解析微信聊天窗口中的一些系统消息，如：消息发送时间、撤回信息、“某某邀请某某入群”等等。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">SplitMessage</span><span class="token punctuation">(</span>MsgItem<span class="token punctuation">)</span><span class="token punctuation">:</span>
        uia<span class="token punctuation">.</span>SetGlobalSearchTimeout<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        MsgItemName <span class="token operator">=</span> MsgItem<span class="token punctuation">.</span>Name
        <span class="token keyword">if</span> MsgItem<span class="token punctuation">.</span>BoundingRectangle<span class="token punctuation">.</span>height<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WxParam<span class="token punctuation">.</span>SYS_TEXT_HEIGHT<span class="token punctuation">:</span>
            Msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'SYS'</span><span class="token punctuation">,</span> MsgItemName<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> MsgItem<span class="token punctuation">.</span>GetRuntimeId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> MsgItem<span class="token punctuation">.</span>BoundingRectangle<span class="token punctuation">.</span>height<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WxParam<span class="token punctuation">.</span>TIME_TEXT_HEIGHT<span class="token punctuation">:</span>
            Msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'Time'</span><span class="token punctuation">,</span> MsgItemName<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> MsgItem<span class="token punctuation">.</span>GetRuntimeId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> MsgItem<span class="token punctuation">.</span>BoundingRectangle<span class="token punctuation">.</span>height<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WxParam<span class="token punctuation">.</span>RECALL_TEXT_HEIGHT<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token string">'撤回'</span> <span class="token keyword">in</span> MsgItemName<span class="token punctuation">:</span>
                Msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'Recall'</span><span class="token punctuation">,</span> MsgItemName<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> MsgItem<span class="token punctuation">.</span>GetRuntimeId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                Msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'SYS'</span><span class="token punctuation">,</span> MsgItemName<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> MsgItem<span class="token punctuation">.</span>GetRuntimeId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            Index <span class="token operator">=</span> <span class="token number">1</span>
            User <span class="token operator">=</span> MsgItem<span class="token punctuation">.</span>ButtonControl<span class="token punctuation">(</span>foundIndex<span class="token operator">=</span>Index<span class="token punctuation">)</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> User<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
                        Index <span class="token operator">+=</span> <span class="token number">1</span>
                        User <span class="token operator">=</span> MsgItem<span class="token punctuation">.</span>ButtonControl<span class="token punctuation">(</span>foundIndex<span class="token operator">=</span>Index<span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        <span class="token keyword">break</span>
                Msg <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> MsgItemName<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> MsgItem<span class="token punctuation">.</span>GetRuntimeId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                Msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'SYS'</span><span class="token punctuation">,</span> MsgItemName<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> MsgItem<span class="token punctuation">.</span>GetRuntimeId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        uia<span class="token punctuation">.</span>SetGlobalSearchTimeout<span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> Msg
</code></pre> 
<p>不过这里的方法只是将这些消息提取出来，没有对时间做进一步解析。我以这个方法为基础，加入了时间转换等代码，使其能够更好地解析时间，满足我们的需求：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">SplitMessageWithTime</span><span class="token punctuation">(</span>MsgItem<span class="token punctuation">,</span> step<span class="token punctuation">)</span><span class="token punctuation">:</span>
    uia<span class="token punctuation">.</span>SetGlobalSearchTimeout<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    MessageInfos <span class="token operator">=</span> WxUtils<span class="token punctuation">.</span>GetMessageInfos<span class="token punctuation">(</span>MsgItem<span class="token punctuation">)</span>
    MsgItemName <span class="token operator">=</span> MsgItem<span class="token punctuation">.</span>Name
    time_pattern1 <span class="token operator">=</span> <span class="token string">r'([01]?[0-9]|2[0-3]):[0-5][0-9]'</span>
    time_pattern2 <span class="token operator">=</span> <span class="token string">r'新消息'</span>  <span class="token comment"># 用于后面的正则表达式匹配时间</span>
    <span class="token triple-quoted-string string">"""
    这是我自己设计的一个逻辑。因为不同的电脑分辨率不同，我们不能以一个固定的像素值来判断获取到的消息是系统消息、还是聊天正文消息。因此我以第一次
    获取的系统消息为基准，按比例来区分系统消息和聊天正文。一般来说，聊天正文的控件高度要略大于系统消息的控件高度。（这里可能设计得不太好，大家有
    更好的方法可以指出）
    """</span>
    <span class="token comment"># 以第一条内容的尺寸为标准，设定其他控件的尺寸</span>
    <span class="token keyword">if</span> step <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        WxParam<span class="token punctuation">.</span>SYS_TEXT_HEIGHT <span class="token operator">=</span> MsgItem<span class="token punctuation">.</span>BoundingRectangle<span class="token punctuation">.</span>height<span class="token punctuation">(</span><span class="token punctuation">)</span>
        WxParam<span class="token punctuation">.</span>TIME_TEXT_HEIGHT <span class="token operator">=</span> MsgItem<span class="token punctuation">.</span>BoundingRectangle<span class="token punctuation">.</span>height<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.2</span>
        WxParam<span class="token punctuation">.</span>CHAT_TEXT_HEIGHT <span class="token operator">=</span> MsgItem<span class="token punctuation">.</span>BoundingRectangle<span class="token punctuation">.</span>height<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.4</span>

    Msg <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token comment"># 记录'查看更多消息'的标签宽度</span>
    <span class="token keyword">if</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">'查看更多消息'</span><span class="token punctuation">,</span> MsgItemName<span class="token punctuation">)</span><span class="token punctuation">:</span>
        Msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'SYS'</span><span class="token punctuation">,</span> MsgItemName<span class="token punctuation">,</span> MessageInfos<span class="token punctuation">)</span>

    <span class="token comment"># 获取时间</span>
    <span class="token keyword">elif</span> MsgItem<span class="token punctuation">.</span>BoundingRectangle<span class="token punctuation">.</span>height<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> WxParam<span class="token punctuation">.</span>TIME_TEXT_HEIGHT <span class="token keyword">and</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>time_pattern1<span class="token punctuation">,</span> MsgItemName<span class="token punctuation">)</span><span class="token punctuation">:</span>
    	WxUtils<span class="token punctuation">.</span>publish_time <span class="token operator">=</span> MsgItemName
        Msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'Time'</span><span class="token punctuation">,</span> MsgItemName<span class="token punctuation">,</span> MessageInfos<span class="token punctuation">)</span>

	<span class="token comment"># 获取特殊时间</span>
    <span class="token keyword">elif</span> MsgItem<span class="token punctuation">.</span>BoundingRectangle<span class="token punctuation">.</span>height<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> WxParam<span class="token punctuation">.</span>TIME_TEXT_HEIGHT <span class="token keyword">and</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>time_pattern2<span class="token punctuation">,</span> MsgItemName<span class="token punctuation">)</span><span class="token punctuation">:</span>
    	WxUtils<span class="token punctuation">.</span>publish_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d %H:%M'</span><span class="token punctuation">)</span>
        Msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'Time'</span><span class="token punctuation">,</span> WxUtils<span class="token punctuation">.</span>publish_time<span class="token punctuation">,</span> <span class="token punctuation">[</span>WxUtils<span class="token punctuation">.</span>publish_time<span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># 聊天消息</span>
    <span class="token keyword">elif</span> MsgItem<span class="token punctuation">.</span>BoundingRectangle<span class="token punctuation">.</span>height<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> WxParam<span class="token punctuation">.</span>CHAT_TEXT_HEIGHT<span class="token punctuation">:</span>
        Index <span class="token operator">=</span> <span class="token number">1</span>
        User <span class="token operator">=</span> MsgItem<span class="token punctuation">.</span>ButtonControl<span class="token punctuation">(</span>foundIndex<span class="token operator">=</span>Index<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> User<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
                    Index <span class="token operator">+=</span> <span class="token number">1</span>
                    User <span class="token operator">=</span> MsgItem<span class="token punctuation">.</span>ButtonControl<span class="token punctuation">(</span>foundIndex<span class="token operator">=</span>Index<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
            <span class="token keyword">if</span> WxUtils<span class="token punctuation">.</span>publish_time <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">:</span>
                Msg <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> MsgItemName<span class="token punctuation">,</span> MessageInfos<span class="token punctuation">,</span> WxUtils<span class="token punctuation">.</span>publish_time<span class="token punctuation">)</span>  <span class="token comment"># 已经有时间则为消息设置时间</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                Msg <span class="token operator">=</span> <span class="token punctuation">(</span>User<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> MsgItemName<span class="token punctuation">,</span> MessageInfos<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>  <span class="token comment"># 没有时间则先设置为''，后续会继续向前滚动鼠标</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            Msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'SYS'</span><span class="token punctuation">,</span> MsgItemName<span class="token punctuation">,</span> MessageInfos<span class="token punctuation">)</span>

    <span class="token comment"># 系统标签</span>
    <span class="token keyword">elif</span> MsgItem<span class="token punctuation">.</span>BoundingRectangle<span class="token punctuation">.</span>height<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WxParam<span class="token punctuation">.</span>SYS_TEXT_HEIGHT<span class="token punctuation">:</span>
        Msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'SYS'</span><span class="token punctuation">,</span> MsgItemName<span class="token punctuation">,</span> MessageInfos<span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        Msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'Other'</span><span class="token punctuation">,</span> MsgItemName<span class="token punctuation">,</span> MessageInfos<span class="token punctuation">)</span>
    uia<span class="token punctuation">.</span>SetGlobalSearchTimeout<span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> Msg
</code></pre> 
<p>原理就是分别读取微信聊天窗口的时间和聊天内容，并将聊天内容和对应的时间放到同一个元组中。由于微信的消息发送时间可能会含有“昨天 14:00”、“星期一 14:00”等这种时间格式，这显然是不可用的。因此我们在解析这些元组时，转换里面的时间YYYY-MM-DD HH:MM的格式。<br> 可能有人会问，你怎么知道哪条消息对应哪个时间？大家可在debug模式下查看获取的所有消息，这里的消息获取是从上往下，时间自然也是从早期到现在。我在代码里面设置了一个变量记录最新时间，如果获取的时间晚于变量，则将变量的值更新为更晚的时间。每次的聊天消息的时间都用这个最晚时间。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fd68828b23eaa768d4a6ae01fa26b30d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决pycocotools的安装问题：No module named pycocotools</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/465d86a848afa4cca14a2b8ce065f50a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">架构师必备--高可用高性能分布式数据库Tidb安装部署实践</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>