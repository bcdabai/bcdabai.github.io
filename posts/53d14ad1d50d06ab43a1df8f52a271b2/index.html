<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python中多进程 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Python中多进程" />
<meta property="og:description" content="来自东哥IT笔记
现在很多CPU都支持多核，甚至是手机都已经开始支持多核了。而Python的GIL（Global Interpreter Locko）则使得其没法使用这些多核带来的优势。还好从Python2.6开始，引入了multiprocessing模块，我们终于可以使用多核带来的便利了。
使用多进程的优点使用多进程的缺点使用multiprocessing来创建多进程Process的子类化创建进程池 本文并不是一个multiprocessing的全面的介绍，假如你想全面的了解它，可以参见官方的文档：
https://docs.python.org/2/library/mul
使用多进程的优点 使用多进程有很多优点：
多进程使用独立的内存空间相比于线程，代码更加直观能够使用多个CPU/多核避免GIL子进程可以被kill（和thread不同）multiprocessing有和threading.Thread类似的接口对CPU绑定的进程比较好（加密，二进制搜索，矩阵乘法等） 使用多进程的缺点 使用多进程也有一些缺点：
进程间通信更加复杂内存的占用大于线程 使用multiprocessing来创建进程 multiprocessing是用来模拟threading.Thread类工作的。下面就是一个使用它的例子：
import multiprocessing import random import time def worker(name: str) -&gt; None: print(f&#39;Started worker {name}&#39;) worker_time = random.choice(range(1, 5)) time.sleep(worker_time) print(f&#39;{name} worker finished in {worker_time} seconds&#39;) if __name__ == &#39;__main__&#39;: processes = [] for i in range(5): process = multiprocessing.Process(target=worker, args=(f&#39;computer_{i}&#39;,)) processes.append(process) process.start() for proc in processes: proc.join() 首先第一步需要import multiprocessing模块，另外两个import分别是为random和time服务的。
worker函数就是用来假装做一些事情，传入一个name的参数，没有什么返回，他首先打印name的值，然后随机sleep一段时间用来模拟做一段很长时间的工作，最后打印work finish。
紧接着，你使用multiprocessing.Process创建了5个进程，他的使用和threading.Tread()比较类似，你告诉Process哪个目标函数需要调用，以及会传入什么参数给他们，然后你调用了start函数来启动进程。另外你会把这些进程加入到一个list中。
最后，你遍历这个list，调用join方法，这个方法其实就是告诉Python等到进程结束。
Process的子类化 multiporcessing模块中的Process类是可以子类化的，他和threading." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/53d14ad1d50d06ab43a1df8f52a271b2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-01T11:15:38+08:00" />
<meta property="article:modified_time" content="2022-04-01T11:15:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python中多进程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><a href="https://donggeitnote.com/" rel="nofollow">来自东哥IT笔记</a><br> 现在很多CPU都支持多核，甚至是手机都已经开始支持多核了。而Python的GIL（Global Interpreter Locko）则使得其没法使用这些多核带来的优势。还好从Python2.6开始，引入了multiprocessing模块，我们终于可以使用多核带来的便利了。</p> 
<ul><li>使用多进程的优点</li><li>使用多进程的缺点</li><li>使用multiprocessing来创建多进程</li><li>Process的子类化</li><li>创建进程池</li></ul> 
<p>本文并不是一个multiprocessing的全面的介绍，假如你想全面的了解它，可以参见官方的文档：<br> <a href="https://docs.python.org/2/library/multiprocessing.html" rel="nofollow">https://docs.python.org/2/library/mul</a></p> 
<h4><a id="_12"></a>使用多进程的优点</h4> 
<p>使用多进程有很多优点：</p> 
<ul><li>多进程使用独立的内存空间</li><li>相比于线程，代码更加直观</li><li>能够使用多个CPU/多核</li><li>避免GIL</li><li>子进程可以被kill（和thread不同）</li><li>multiprocessing有和threading.Thread类似的接口</li><li>对CPU绑定的进程比较好（加密，二进制搜索，矩阵乘法等）</li></ul> 
<h3><a id="_22"></a>使用多进程的缺点</h3> 
<p>使用多进程也有一些缺点：</p> 
<ul><li>进程间通信更加复杂</li><li>内存的占用大于线程</li></ul> 
<h3><a id="multiprocessing_28"></a>使用multiprocessing来创建进程</h3> 
<p>multiprocessing是用来模拟threading.Thread类工作的。下面就是一个使用它的例子：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> multiprocessing
<span class="token keyword">import</span> random
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Started worker </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    worker_time <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>worker_time<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span></span><span class="token string"> worker finished in </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>worker_time<span class="token punctuation">}</span></span><span class="token string"> seconds'</span></span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    processes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        process <span class="token operator">=</span> multiprocessing<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span>worker<span class="token punctuation">,</span>
                                          args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'computer_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        processes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>process<span class="token punctuation">)</span>
        process<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
    <span class="token keyword">for</span> proc <span class="token keyword">in</span> processes<span class="token punctuation">:</span>
        proc<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>首先第一步需要import multiprocessing模块，另外两个import分别是为random和time服务的。</p> 
<p>worker函数就是用来假装做一些事情，传入一个name的参数，没有什么返回，他首先打印name的值，然后随机sleep一段时间用来模拟做一段很长时间的工作，最后打印work finish。</p> 
<p>紧接着，你使用multiprocessing.Process创建了5个进程，他的使用和threading.Tread()比较类似，你告诉Process哪个目标函数需要调用，以及会传入什么参数给他们，然后你调用了start函数来启动进程。另外你会把这些进程加入到一个list中。</p> 
<p>最后，你遍历这个list，调用join方法，这个方法其实就是告诉Python等到进程结束。</p> 
<h3><a id="Process_62"></a>Process的子类化</h3> 
<p>multiporcessing模块中的Process类是可以子类化的，他和threading.thread的类差不多。我们来看下面代码：</p> 
<pre><code class="prism language-python"><span class="token comment"># worker_thread_subclass.py</span>
<span class="token keyword">import</span> random
<span class="token keyword">import</span> multiprocessing
<span class="token keyword">import</span> time
<span class="token keyword">class</span> <span class="token class-name">WorkerProcess</span><span class="token punctuation">(</span>multiprocessing<span class="token punctuation">.</span>Process<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        multiprocessing<span class="token punctuation">.</span>Process<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Run the thread
        """</span>
        worker<span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Started worker </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    worker_time <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>worker_time<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span></span><span class="token string"> worker finished in </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>worker_time<span class="token punctuation">}</span></span><span class="token string"> seconds'</span></span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    processes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        process <span class="token operator">=</span> WorkerProcess<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f'computer_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        processes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>process<span class="token punctuation">)</span>
        process<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> process <span class="token keyword">in</span> processes<span class="token punctuation">:</span>
        process<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里，我们写了一个multiprocess.Process()的子类，并且重写了run()方法。</p> 
<h3><a id="_95"></a>创建一个进程池</h3> 
<p>假如你有很多进程需要运行，有时你希望能够限制进程运行的数目。比如说，你需要运行20个进程，但是你只有4个核，那么你可以使用multiprocessing模块来创建一个进程池，用它来限制每次进程运行的数目到4个。</p> 
<p>下面是示例的代码：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> random
<span class="token keyword">import</span> time
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Pool
<span class="token keyword">def</span> <span class="token function">worker</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Started worker </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    worker_time <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>worker_time<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span></span><span class="token string"> worker finished in </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>worker_time<span class="token punctuation">}</span></span><span class="token string"> seconds'</span></span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    process_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'computer_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    pool <span class="token operator">=</span> Pool<span class="token punctuation">(</span>processes<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    pool<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>worker<span class="token punctuation">,</span> process_names<span class="token punctuation">)</span>
    pool<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>这个例子中，worker函数还是一样的，主要是后面的代码， 我们创建了一个进程池，它的数目是5，也就意味着最大的运行数目是5。使用这个pool，你需要调用map()方法，然后把你需要的调用的方法和参数传递给他。</p> 
<p>这样的话，Python每次只会使用5个进程来运行直到结束。最后你需要调用terminate()函数，否则你会发现下面的错误：</p> 
<p>/Library/Frameworks/Python.framework/Versions/3.8/lib/python3.8/multiprocessing/resource_tracker.py:216:</p> 
<p>UserWarning: resource_tracker: There appear to be 6 leaked semaphore objects to clean up at shutdown</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/782e916e75eec6be3da1b0829f917727/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【精读笔记】深入解析CSS 第一部分：基础回顾</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0ad0ff96bd5a9bb249bbb5636a4426e6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在TestDB数据库中，编写一个存储过程proc_test_func</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>