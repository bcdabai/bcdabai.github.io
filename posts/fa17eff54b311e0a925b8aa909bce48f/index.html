<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>语音识别器 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="语音识别器" />
<meta property="og:description" content="语音识别器 环境主要包 环境展示写作过程1.导入相关包2.定义类来创建隐马尔科夫模型3.定义一个函数来解析其中的命令4.定义主函数5.运行，这里运行是在终端进行运行的。 注意事项参考书籍代码参考基础知识学习 完整代码 环境 这里我用的linux下kali虚拟机。 Anaconda环境，pycharm编译器。python3.6.13 主要包 # 直接就是清华源下载，清华源是真的好用，谁用谁知道 pip install --user -i https://pypi.tuna.tsinghua.edu.cn/simple numpy pip install --user -i https://pypi.tuna.tsinghua.edu.cn/simple scipy pip install --user -i https://pypi.tuna.tsinghua.edu.cn/simple hmmlearn pip install --user -i https://pypi.tuna.tsinghua.edu.cn/simple python_speech_features 环境展示 这里用到的单词音频就是我们上篇通过文字发音保存的音频。
写作过程 1.导入相关包 # 利用隐马尔科夫模型进行语音识别 # 隐马尔科夫模型（Hidden Markov Models,HMM) import os import argparse import numpy as np from scipy.io import wavfile from hmmlearn import hmm from python_speech_features import mfcc 2.定义类来创建隐马尔科夫模型 # 1.定义一个类来创建隐马尔科夫模型 class HMMTrainer(object): # 初始化类。下面用到高斯隐马尔科夫(Gaussion HMMs)来对数据建模。 # 参数n_components定义了隐藏状态的个数，参数cov_type定义了转移矩阵的协方差类型，参数n_iter定义了训练的迭代次数 def __init__(self, model_name=&#39;GaussianHMM&#39;, n_components=4, cov_type=&#39;diag&#39;, n_iter=1000): # 初始化变量 self." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/fa17eff54b311e0a925b8aa909bce48f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-25T00:12:50+08:00" />
<meta property="article:modified_time" content="2022-03-25T00:12:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">语音识别器</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>语音识别器</h4> 
 <ul><li><a href="#_1" rel="nofollow">环境</a></li><li><ul><li><a href="#_4" rel="nofollow">主要包</a></li></ul> 
  </li><li><a href="#_10" rel="nofollow">环境展示</a></li><li><a href="#_13" rel="nofollow">写作过程</a></li><li><ul><li><a href="#1_14" rel="nofollow">1.导入相关包</a></li><li><a href="#2_27" rel="nofollow">2.定义类来创建隐马尔科夫模型</a></li><li><a href="#3_59" rel="nofollow">3.定义一个函数来解析其中的命令</a></li><li><a href="#4_70" rel="nofollow">4.定义主函数</a></li><li><a href="#5_155" rel="nofollow">5.运行，这里运行是在终端进行运行的。</a></li></ul> 
  </li><li><a href="#_160" rel="nofollow">注意事项</a></li><li><a href="#_174" rel="nofollow">参考书籍</a></li><li><ul><li><a href="#_175" rel="nofollow">代码参考</a></li><li><a href="#_178" rel="nofollow">基础知识学习</a></li></ul> 
  </li><li><a href="#_181" rel="nofollow">完整代码</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>环境</h2> 
<pre><code>这里我用的linux下kali虚拟机。
Anaconda环境，pycharm编译器。python3.6.13
</code></pre> 
<h3><a id="_4"></a>主要包</h3> 
<pre><code># 直接就是清华源下载，清华源是真的好用，谁用谁知道
pip install --user -i https://pypi.tuna.tsinghua.edu.cn/simple numpy
pip install --user -i https://pypi.tuna.tsinghua.edu.cn/simple scipy
pip install --user -i https://pypi.tuna.tsinghua.edu.cn/simple hmmlearn
pip install --user -i https://pypi.tuna.tsinghua.edu.cn/simple python_speech_features
</code></pre> 
<h2><a id="_10"></a>环境展示</h2> 
<p>这里用到的单词音频就是我们上篇通过文字发音保存的音频。<br> <img src="https://images2.imgbox.com/35/96/1a6x5w5T_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_13"></a>写作过程</h2> 
<h3><a id="1_14"></a>1.导入相关包</h3> 
<pre><code class="prism language-python"><span class="token comment"># 利用隐马尔科夫模型进行语音识别</span>
<span class="token comment"># 隐马尔科夫模型（Hidden Markov Models,HMM)</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>io <span class="token keyword">import</span> wavfile
<span class="token keyword">from</span> hmmlearn <span class="token keyword">import</span> hmm
<span class="token keyword">from</span> python_speech_features <span class="token keyword">import</span> mfcc

</code></pre> 
<h3><a id="2_27"></a>2.定义类来创建隐马尔科夫模型</h3> 
<pre><code class="prism language-python"><span class="token comment"># 1.定义一个类来创建隐马尔科夫模型</span>
<span class="token keyword">class</span> <span class="token class-name">HMMTrainer</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 初始化类。下面用到高斯隐马尔科夫(Gaussion HMMs)来对数据建模。</span>
    <span class="token comment"># 参数n_components定义了隐藏状态的个数，参数cov_type定义了转移矩阵的协方差类型，参数n_iter定义了训练的迭代次数</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model_name<span class="token operator">=</span><span class="token string">'GaussianHMM'</span><span class="token punctuation">,</span> n_components<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> cov_type<span class="token operator">=</span><span class="token string">'diag'</span><span class="token punctuation">,</span> n_iter<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 初始化变量</span>
        self<span class="token punctuation">.</span>model_name <span class="token operator">=</span> model_name
        self<span class="token punctuation">.</span>n_components <span class="token operator">=</span> n_components
        self<span class="token punctuation">.</span>cov_type <span class="token operator">=</span> cov_type
        self<span class="token punctuation">.</span>n_iter <span class="token operator">=</span> n_iter
        self<span class="token punctuation">.</span>models <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 用以下参数定义模型</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>model_name <span class="token operator">==</span> <span class="token string">'GaussianHMM'</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>model <span class="token operator">=</span> hmm<span class="token punctuation">.</span>GaussianHMM<span class="token punctuation">(</span>n_components<span class="token operator">=</span>self<span class="token punctuation">.</span>n_components<span class="token punctuation">,</span>
                                         covariance_type<span class="token operator">=</span>self<span class="token punctuation">.</span>cov_type<span class="token punctuation">,</span> n_iter<span class="token operator">=</span>self<span class="token punctuation">.</span>n_iter<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">'Invalid model type'</span><span class="token punctuation">)</span>

    <span class="token comment"># 输入数据是一个numpy数组，数组的每个元素都是一个特征向量，每个特征向量都包含k个纬度</span>
    <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>
        np<span class="token punctuation">.</span>seterr<span class="token punctuation">(</span><span class="token builtin">all</span><span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>models<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 基于该模型定义一个提取分数的方法</span>
    <span class="token comment"># 对输入数据运行模型</span>
    <span class="token keyword">def</span> <span class="token function">get_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>score<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span>

</code></pre> 
<h3><a id="3_59"></a>3.定义一个函数来解析其中的命令</h3> 
<pre><code class="prism language-python"><span class="token comment"># 2.定义一个函数来解析命令行中的输入参数</span>
<span class="token keyword">def</span> <span class="token function">build_arg_parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">'Trains the HMM classifier'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--input-folder"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"input_folder"</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Input folder containing the audio files insubfolders"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> parser

</code></pre> 
<h3><a id="4_70"></a>4.定义主函数</h3> 
<pre><code class="prism language-python"><span class="token comment"># 3.定义main函数，解析输入参数</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    args <span class="token operator">=</span> build_arg_parse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    input_folder <span class="token operator">=</span> args<span class="token punctuation">.</span>input_folder
    <span class="token comment"># print(input_folder)</span>
    <span class="token comment"># 4.初始化隐马尔科夫模型的变量</span>
    hmm_models <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># 5.解析包含所有数据库音频文件的输入路径</span>
    <span class="token keyword">for</span> dirname <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>input_folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 6.提取子文件夹的名称</span>
        subfolder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>input_folder<span class="token punctuation">,</span> dirname<span class="token punctuation">)</span>
        <span class="token comment"># print(subfolder)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>subfolder<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token comment"># print(dirname)</span>
        <span class="token comment"># 7.子文件夹的名称即为该类的标记。</span>
        label <span class="token operator">=</span> subfolder<span class="token punctuation">[</span>subfolder<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token comment"># print(label)</span>
        <span class="token comment"># 8.初始化用于训练的量</span>
        X <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        y_words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 9.迭代每一个子文件夹中的音频文件：</span>
        <span class="token triple-quoted-string string">"""
        for x in os.listdir(subfolder):
            if x.endswith('.wav'):
                print(x)
        """</span>
        <span class="token keyword">for</span> filename <span class="token keyword">in</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>subfolder<span class="token punctuation">)</span> <span class="token keyword">if</span> x<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.wav'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
            <span class="token comment"># 10.读取每个音频文件</span>
            filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>subfolder<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
            <span class="token comment"># print(filepath)</span>
            sampling_freq<span class="token punctuation">,</span> audio <span class="token operator">=</span> wavfile<span class="token punctuation">.</span>read<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>sampling_freq<span class="token punctuation">)</span>
            <span class="token comment"># 11.提取MFCC特征</span>
            mfcc_features <span class="token operator">=</span> mfcc<span class="token punctuation">(</span>audio<span class="token punctuation">,</span> sampling_freq<span class="token punctuation">)</span>
            <span class="token comment"># 12.将MFCC特征添加到X变量</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                X <span class="token operator">=</span> mfcc_features
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                X <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>X<span class="token punctuation">,</span> mfcc_features<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment"># 13.同时添加标记信息</span>
            y_words<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        <span class="token comment"># print(y_words)</span>
        <span class="token comment"># 14.一旦提取完当前类所有文件的特征，就可以训练并保存隐马尔科夫模型了。</span>
        <span class="token comment"># 因为隐马尔科夫模型是一个无监督学习的生成模型，所以并不需要利用标记针对每一类构建隐马尔科夫模型</span>
        <span class="token comment"># 假设每个类都将构建一个隐马尔科夫模型</span>
        <span class="token comment"># 训练并保存HMM模型</span>
        hmm_trainer <span class="token operator">=</span> HMMTrainer<span class="token punctuation">(</span><span class="token punctuation">)</span>
        hmm_trainer<span class="token punctuation">.</span>train<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
        hmm_models<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>hmm_trainer<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">)</span>
        hmm_trainer <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token comment"># 15.获取一个未被用于训练的测试文件列表</span>
    input_files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'audio_files/hello/hello.wav'</span><span class="token punctuation">,</span>
                   <span class="token string">'audio_files/linux/linux.wav'</span><span class="token punctuation">,</span>
                   <span class="token string">'audio_files/python/python.wav'</span><span class="token punctuation">,</span>
                   <span class="token string">'audio_files/windows/windows.wav'</span><span class="token punctuation">,</span>
                   <span class="token string">'audio_files/你好/你好.wav'</span><span class="token punctuation">,</span>
                   <span class="token string">'audio_files/place/place.wav'</span><span class="token punctuation">,</span>
                   <span class="token string">'audio_files/variables/variables.wav'</span><span class="token punctuation">]</span>
    <span class="token comment"># 16.解析输入文件：</span>
    <span class="token keyword">for</span> input_file <span class="token keyword">in</span> input_files<span class="token punctuation">:</span>
        <span class="token comment"># 17.读取每个音频文件</span>
        sampling_freq<span class="token punctuation">,</span> audio <span class="token operator">=</span> wavfile<span class="token punctuation">.</span>read<span class="token punctuation">(</span>input_file<span class="token punctuation">)</span>
        <span class="token comment"># 18.提取MFCC特征</span>
        mfcc_features <span class="token operator">=</span> mfcc<span class="token punctuation">(</span>audio<span class="token punctuation">,</span> sampling_freq<span class="token punctuation">)</span>
        <span class="token comment"># 19.定义两个变量，分别用于存放最大分数值和输出标记</span>
        max_score <span class="token operator">=</span> <span class="token number">0</span>
        output_label <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token comment"># 20.迭代所有模型，并通过所有模型运行输入文件</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> hmm_models<span class="token punctuation">:</span>
            hmm_model<span class="token punctuation">,</span> label <span class="token operator">=</span> item
            <span class="token comment"># 21.提取分数，并保存最大分数值</span>
            score <span class="token operator">=</span> hmm_model<span class="token punctuation">.</span>get_score<span class="token punctuation">(</span>mfcc_features<span class="token punctuation">)</span>
            <span class="token keyword">if</span> score <span class="token operator">&gt;</span> max_score<span class="token punctuation">:</span>
                max_score <span class="token operator">=</span> score
                output_label <span class="token operator">=</span> label
        <span class="token comment"># 21.打印结果</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nTrue:'</span><span class="token punctuation">,</span> input_file<span class="token punctuation">[</span>input_file<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span>input_file<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Predicted:'</span><span class="token punctuation">,</span> output_label<span class="token punctuation">)</span>

</code></pre> 
<h3><a id="5_155"></a>5.运行，这里运行是在终端进行运行的。</h3> 
<pre><code>python speech_recognizer.py --input-folder audio_files
</code></pre> 
<p><img src="https://images2.imgbox.com/cc/3e/8GRH2vn6_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_160"></a>注意事项</h2> 
<p>针对以上代码运行，出现了一个问题：<br> <img src="https://images2.imgbox.com/29/1c/NIY8GM6B_o.png" alt="在这里插入图片描述"><br> <strong>这个报错不影响运行，但影响语音识别的准确率。</strong><br> 解决：网上查找资料说是帧率的问题。需要<strong>把22kHz帧率改为16kHz.</strong><br> 原回答：<a href="https://github.com/mozilla/DeepSpeech/issues/1888">https://github.com/mozilla/DeepSpeech/issues/1888</a><br> <img src="https://images2.imgbox.com/41/31/cb7hEBB8_o.png" alt="在这里插入图片描述"><br> 根据提示，我尝试输出帧率，发现确实是22kHz帧率。<br> <img src="https://images2.imgbox.com/7d/9a/hb2uiFKW_o.png" alt="在这里插入图片描述"><br> 然后就是改帧率：要改的地方有两个：<br> <img src="https://images2.imgbox.com/f6/9a/tIPthPoe_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9b/32/pNjcoc1X_o.png" alt="在这里插入图片描述"><br> 改好帧率之后，语音的识别率也提高了好多。<br> <img src="https://images2.imgbox.com/cf/73/MIxLNkKg_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_174"></a>参考书籍</h2> 
<h3><a id="_175"></a>代码参考</h3> 
<pre><code>本文代码基本仿照《Python 机器学习经典实例》完成。
	英文名：《Python Machine Learning Cookbook》
</code></pre> 
<h3><a id="_178"></a>基础知识学习</h3> 
<pre><code>深度学习基础知识我参考的是：
	《Python深度学习-基于TensorFlow》
</code></pre> 
<h2><a id="_181"></a>完整代码</h2> 
<pre><code class="prism language-python"><span class="token comment"># 利用隐马尔科夫模型进行语音识别</span>
<span class="token comment"># 隐马尔科夫模型（Hidden Markov Models,HMM)</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> argparse
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>io <span class="token keyword">import</span> wavfile
<span class="token keyword">from</span> hmmlearn <span class="token keyword">import</span> hmm
<span class="token keyword">from</span> python_speech_features <span class="token keyword">import</span> mfcc


<span class="token comment"># 1.定义一个类来创建隐马尔科夫模型</span>
<span class="token keyword">class</span> <span class="token class-name">HMMTrainer</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 初始化类。下面用到高斯隐马尔科夫(Gaussion HMMs)来对数据建模。</span>
    <span class="token comment"># 参数n_components定义了隐藏状态的个数，参数cov_type定义了转移矩阵的协方差类型，参数n_iter定义了训练的迭代次数</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model_name<span class="token operator">=</span><span class="token string">'GaussianHMM'</span><span class="token punctuation">,</span> n_components<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> cov_type<span class="token operator">=</span><span class="token string">'diag'</span><span class="token punctuation">,</span> n_iter<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 初始化变量</span>
        self<span class="token punctuation">.</span>model_name <span class="token operator">=</span> model_name
        self<span class="token punctuation">.</span>n_components <span class="token operator">=</span> n_components
        self<span class="token punctuation">.</span>cov_type <span class="token operator">=</span> cov_type
        self<span class="token punctuation">.</span>n_iter <span class="token operator">=</span> n_iter
        self<span class="token punctuation">.</span>models <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 用以下参数定义模型</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>model_name <span class="token operator">==</span> <span class="token string">'GaussianHMM'</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>model <span class="token operator">=</span> hmm<span class="token punctuation">.</span>GaussianHMM<span class="token punctuation">(</span>n_components<span class="token operator">=</span>self<span class="token punctuation">.</span>n_components<span class="token punctuation">,</span>
                                         covariance_type<span class="token operator">=</span>self<span class="token punctuation">.</span>cov_type<span class="token punctuation">,</span> n_iter<span class="token operator">=</span>self<span class="token punctuation">.</span>n_iter<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string">'Invalid model type'</span><span class="token punctuation">)</span>

    <span class="token comment"># 输入数据是一个numpy数组，数组的每个元素都是一个特征向量，每个特征向量都包含k个纬度</span>
    <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">)</span><span class="token punctuation">:</span>
        np<span class="token punctuation">.</span>seterr<span class="token punctuation">(</span><span class="token builtin">all</span><span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>models<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 基于该模型定义一个提取分数的方法</span>
    <span class="token comment"># 对输入数据运行模型</span>
    <span class="token keyword">def</span> <span class="token function">get_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>score<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span>


<span class="token comment"># 2.定义一个函数来解析命令行中的输入参数</span>
<span class="token keyword">def</span> <span class="token function">build_arg_parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">'Trains the HMM classifier'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--input-folder"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"input_folder"</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Input folder containing the audio files insubfolders"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> parser


<span class="token comment"># 3.定义main函数，解析输入参数</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    args <span class="token operator">=</span> build_arg_parse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    input_folder <span class="token operator">=</span> args<span class="token punctuation">.</span>input_folder
    <span class="token comment"># print(input_folder)</span>
    <span class="token comment"># 4.初始化隐马尔科夫模型的变量</span>
    hmm_models <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># 5.解析包含所有数据库音频文件的输入路径</span>
    <span class="token keyword">for</span> dirname <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>input_folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 6.提取子文件夹的名称</span>
        subfolder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>input_folder<span class="token punctuation">,</span> dirname<span class="token punctuation">)</span>
        <span class="token comment"># print(subfolder)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>subfolder<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token comment"># print(dirname)</span>
        <span class="token comment"># 7.子文件夹的名称即为该类的标记。</span>
        label <span class="token operator">=</span> subfolder<span class="token punctuation">[</span>subfolder<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token comment"># print(label)</span>
        <span class="token comment"># 8.初始化用于训练的量</span>
        X <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        y_words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 9.迭代每一个子文件夹中的音频文件：</span>
        <span class="token triple-quoted-string string">"""
        for x in os.listdir(subfolder):
            if x.endswith('.wav'):
                print(x)
        """</span>
        <span class="token keyword">for</span> filename <span class="token keyword">in</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>subfolder<span class="token punctuation">)</span> <span class="token keyword">if</span> x<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.wav'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
            <span class="token comment"># 10.读取每个音频文件</span>
            filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>subfolder<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
            <span class="token comment"># print(filepath)</span>
            sampling_freq<span class="token punctuation">,</span> audio <span class="token operator">=</span> wavfile<span class="token punctuation">.</span>read<span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>sampling_freq<span class="token punctuation">)</span>
            <span class="token comment"># 11.提取MFCC特征</span>
            mfcc_features <span class="token operator">=</span> mfcc<span class="token punctuation">(</span>audio<span class="token punctuation">,</span> <span class="token number">16000</span><span class="token punctuation">)</span>
            <span class="token comment"># 12.将MFCC特征添加到X变量</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                X <span class="token operator">=</span> mfcc_features
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                X <span class="token operator">=</span> np<span class="token punctuation">.</span>append<span class="token punctuation">(</span>X<span class="token punctuation">,</span> mfcc_features<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment"># 13.同时添加标记信息</span>
            y_words<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        <span class="token comment"># print(y_words)</span>
        <span class="token comment"># 14.一旦提取完当前类所有文件的特征，就可以训练并保存隐马尔科夫模型了。</span>
        <span class="token comment"># 因为隐马尔科夫模型是一个无监督学习的生成模型，所以并不需要利用标记针对每一类构建隐马尔科夫模型</span>
        <span class="token comment"># 假设每个类都将构建一个隐马尔科夫模型</span>
        <span class="token comment"># 训练并保存HMM模型</span>
        hmm_trainer <span class="token operator">=</span> HMMTrainer<span class="token punctuation">(</span><span class="token punctuation">)</span>
        hmm_trainer<span class="token punctuation">.</span>train<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
        hmm_models<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>hmm_trainer<span class="token punctuation">,</span> label<span class="token punctuation">)</span><span class="token punctuation">)</span>
        hmm_trainer <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token comment"># 15.获取一个未被用于训练的测试文件列表</span>
    input_files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'audio_files/hello/hello.wav'</span><span class="token punctuation">,</span>
                   <span class="token string">'audio_files/linux/linux.wav'</span><span class="token punctuation">,</span>
                   <span class="token string">'audio_files/python/python.wav'</span><span class="token punctuation">,</span>
                   <span class="token string">'audio_files/windows/windows.wav'</span><span class="token punctuation">,</span>
                   <span class="token string">'audio_files/你好/你好.wav'</span><span class="token punctuation">,</span>
                   <span class="token string">'audio_files/place/place.wav'</span><span class="token punctuation">,</span>
                   <span class="token string">'audio_files/variables/variables.wav'</span><span class="token punctuation">]</span>
    <span class="token comment"># 16.解析输入文件：</span>
    <span class="token keyword">for</span> input_file <span class="token keyword">in</span> input_files<span class="token punctuation">:</span>
        <span class="token comment"># 17.读取每个音频文件</span>
        sampling_freq<span class="token punctuation">,</span> audio <span class="token operator">=</span> wavfile<span class="token punctuation">.</span>read<span class="token punctuation">(</span>input_file<span class="token punctuation">)</span>
        <span class="token comment"># 18.提取MFCC特征</span>
        mfcc_features <span class="token operator">=</span> mfcc<span class="token punctuation">(</span>audio<span class="token punctuation">,</span> <span class="token number">16000</span><span class="token punctuation">)</span>
        <span class="token comment"># 19.定义两个变量，分别用于存放最大分数值和输出标记</span>
        max_score <span class="token operator">=</span> <span class="token number">0</span>
        output_label <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token comment"># 20.迭代所有模型，并通过所有模型运行输入文件</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> hmm_models<span class="token punctuation">:</span>
            hmm_model<span class="token punctuation">,</span> label <span class="token operator">=</span> item
            <span class="token comment"># 21.提取分数，并保存最大分数值</span>
            score <span class="token operator">=</span> hmm_model<span class="token punctuation">.</span>get_score<span class="token punctuation">(</span>mfcc_features<span class="token punctuation">)</span>
            <span class="token keyword">if</span> score <span class="token operator">&gt;</span> max_score<span class="token punctuation">:</span>
                max_score <span class="token operator">=</span> score
                output_label <span class="token operator">=</span> label
        <span class="token comment"># 21.打印结果</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nTrue:'</span><span class="token punctuation">,</span> input_file<span class="token punctuation">[</span>input_file<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span>input_file<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Predicted:'</span><span class="token punctuation">,</span> output_label<span class="token punctuation">)</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5fda65e07e28c1916922cc212a512dc2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">计算电磁吐血整理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a151f9add6c09ab6ec8bc9897cd46f42/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">“别动方块”游戏</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>