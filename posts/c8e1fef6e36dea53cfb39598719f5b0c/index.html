<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>openCV特征提取与检测（五）--  SIFT算法 - 编程大白的博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="openCV特征提取与检测（五）--  SIFT算法" />
<meta property="og:description" content="文章主要参考：
https://blog.csdn.net/lingyunxianhe/article/details/79063547
算法介绍SIFT算法步骤图像金字塔空间极值点检测关键点方向分配特征点描述符API即openCV应用 1.算法介绍 SIFT--尺度不变特征转换算法(Scale-invariant feature transform)，通常用来侦测与描述影像中的局部性特征，在空间尺度中寻找极值点，并提取出其位置，尺度，旋转不变量。 SIFT的应用范围包括物体识别，机器人感知与导航，3D模型建立，影像追踪等。 局部影像特征的描述与侦测可以帮助识别物体，**SIFT特征是基于物体上的一些局部外观的兴趣点而与影像的大小和旋转无关** **SIFT算法的实质是在不同的尺度空间上查找关键点**，并计算出关键点的方向。SIFT所查找到的关键点十分突出，不会因光照，噪音而变化 2.SIFT算法步骤 3.图像金字塔 3.1、高斯金字塔 高斯金字塔是采用高斯函数对图像进行模糊以及降采样处理得到的。
高斯模糊系数计算公式：
高斯函数与图像卷积
分离高斯卷积
3.2的图像卷积方法，速度比较慢，同时图像边缘信息也会损失严重。可以使用分离的高斯卷积（即先用1XN的模板沿着X方向对图像卷积一次，然后用NX1的模板沿着Y方向对图像再卷积一次，其中N=[(6σ&#43;1)]且向上取最邻近奇数），这样即省时，也见笑了直接卷积对图像边缘信息的算是
高斯金字塔源码
for (o = 0; o &lt; octvs; o&#43;&#43;)//金字塔组数为octvs， for (i = 0; i &lt; intvls &#43; 3; i&#43;&#43;)//每一组有intvls &#43; 3 层，intvls一般为3 { if (o == 0 &amp;&amp; i == 0)//如果是第一组第1层 gauss_pyr[o][i] = cvCloneImage(base);//base 为原始灰度图像经过升采样或降采样得到的图像 /* base of new octvave is halved image from end of previous octave */ else if (i == 0)//建立非第一组的第1层 gauss_pyr[o][i] = downsample(gauss_pyr[o - 1][intvls]);//降采样图像 /* blur the current octave&#39;s last image to create the next one */ else//建立非第一组的非第1层 { gauss_pyr[o][i] = cvCreateImage(cvGetSize(gauss_pyr[o][i - 1]),IPL_DEPTH_32F, 1); cvSmooth(gauss_pyr[o][i - 1], gauss_pyr[o][i],CV_GAUSSIAN, 0, 0, sig[i], sig[i]);// sig[i]为模糊系数 }//cvSmooth 为平滑处理函数，也即模糊处理。CV_GAUSSIAN 为选用高斯函数对图像模糊 return gauss_pyr;//返回建好的金字塔 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/c8e1fef6e36dea53cfb39598719f5b0c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-28T09:06:54+08:00" />
<meta property="article:modified_time" content="2020-08-28T09:06:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大白的博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大白的博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">openCV特征提取与检测（五）--  SIFT算法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>文章主要参考：<br> https://blog.csdn.net/lingyunxianhe/article/details/79063547</p> 
<ol><li>算法介绍</li><li>SIFT算法步骤</li><li>图像金字塔</li><li>空间极值点检测</li><li>关键点方向分配</li><li>特征点描述符</li><li>API即openCV应用</li></ol> 
<h3><a id="1_12"></a>1.算法介绍</h3> 
<pre><code>SIFT--尺度不变特征转换算法(Scale-invariant feature transform)，通常用来侦测与描述影像中的局部性特征，在空间尺度中寻找极值点，并提取出其位置，尺度，旋转不变量。
SIFT的应用范围包括物体识别，机器人感知与导航，3D模型建立，影像追踪等。
局部影像特征的描述与侦测可以帮助识别物体，**SIFT特征是基于物体上的一些局部外观的兴趣点而与影像的大小和旋转无关**
**SIFT算法的实质是在不同的尺度空间上查找关键点**，并计算出关键点的方向。SIFT所查找到的关键点十分突出，不会因光照，噪音而变化
</code></pre> 
<h3><a id="2SIFT_19"></a>2.SIFT算法步骤</h3> 
<p><img src="https://images2.imgbox.com/41/84/rexdKWNi_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b9/ba/IVVWaBm9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_23"></a>3.图像金字塔</h3> 
<h3><a id="31_25"></a><strong>3.1、高斯金字塔</strong></h3> 
<p>高斯金字塔是采用高斯函数对图像进行模糊以及降采样处理得到的。<br> <img src="https://images2.imgbox.com/83/13/h5TloZ8o_o.png" alt="在这里插入图片描述"><br> 高斯模糊系数计算公式：<br> <img src="https://images2.imgbox.com/2b/39/8ydWFZaG_o.png" alt="在这里插入图片描述"></p> 
<p><strong>高斯函数与图像卷积</strong><br> <img src="https://images2.imgbox.com/f1/91/FYIV3mpv_o.png" alt="在这里插入图片描述"><br> <strong>分离高斯卷积</strong></p> 
<p>3.2的图像卷积方法，速度比较慢，同时图像边缘信息也会损失严重。可以使用分离的高斯卷积（即先用1XN的模板沿着X方向对图像卷积一次，然后用NX1的模板沿着Y方向对图像再卷积一次，其中N=[(6σ+1)]且向上取最邻近奇数），这样即省时，也见笑了直接卷积对图像边缘信息的算是<br> <img src="https://images2.imgbox.com/90/2a/k8xBlnGN_o.png" alt="在这里插入图片描述"><br> <strong>高斯金字塔源码</strong></p> 
<pre><code class="prism language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span>o <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> o <span class="token operator">&lt;</span> octvs<span class="token punctuation">;</span> o<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//金字塔组数为octvs，</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> intvls <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//每一组有intvls + 3 层，intvls一般为3</span>
		<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//如果是第一组第1层</span>
			gauss_pyr<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cvCloneImage</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//base 为原始灰度图像经过升采样或降采样得到的图像</span>
	<span class="token comment">/* base of new octvave is halved image from end of previous octave */</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//建立非第一组的第1层</span>
			gauss_pyr<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">downsample</span><span class="token punctuation">(</span>gauss_pyr<span class="token punctuation">[</span>o <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>intvls<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//降采样图像</span>
		<span class="token comment">/* blur the current octave's last image to create the next one */</span>
		<span class="token keyword">else</span><span class="token comment">//建立非第一组的非第1层</span>
			<span class="token punctuation">{<!-- --></span>
			gauss_pyr<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cvCreateImage</span><span class="token punctuation">(</span><span class="token function">cvGetSize</span><span class="token punctuation">(</span>gauss_pyr<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>IPL_DEPTH_32F<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">cvSmooth</span><span class="token punctuation">(</span>gauss_pyr<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> gauss_pyr<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>CV_GAUSSIAN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sig<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> sig<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// sig[i]为模糊系数</span>
			<span class="token punctuation">}</span><span class="token comment">//cvSmooth 为平滑处理函数，也即模糊处理。CV_GAUSSIAN 为选用高斯函数对图像模糊</span>
	<span class="token keyword">return</span> gauss_pyr<span class="token punctuation">;</span><span class="token comment">//返回建好的金字塔</span>
</code></pre> 
<h3><a id="32__58"></a>3.2 高斯差分金字塔</h3> 
<p>高斯差分函数（DOG算子）的极大值和极小值能够产生比较稳定的图像特征，与尺度归一化的高斯拉普拉斯函数比较近似。<br> <img src="https://images2.imgbox.com/1d/da/qG1TG0Hy_o.png" alt="在这里插入图片描述"><br> 其中k-1是个常熟，不影响极值点位置的求取</p> 
<p><strong>差分金字塔的建立</strong><br> 差分金字塔实在高斯金字塔的基础上操作的，其建立过程就是：在高斯金字塔中的每组中相邻两层相减（下一层减上一层，就生成了高斯差分金字塔）<br> <img src="https://images2.imgbox.com/3d/06/tVy6cjRy_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span>o <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> o <span class="token operator">&lt;</span> octvs<span class="token punctuation">;</span> o<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//octvs为高斯金字塔组数</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> intvls <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//因为相减，故高斯金字塔中每组有（intvls + 2）层图像</span>
		<span class="token punctuation">{<!-- --></span>
		dog_pyr<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cvCreateImage</span><span class="token punctuation">(</span><span class="token function">cvGetSize</span><span class="token punctuation">(</span>gauss_pyr<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>IPL_DEPTH_32F<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">cvSub</span><span class="token punctuation">(</span>gauss_pyr<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> gauss_pyr<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dog_pyr<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//cvSub为opencv内置相减函数</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">return</span> dog_pyr<span class="token punctuation">;</span><span class="token comment">//返回高斯差分金字塔</span>
 
</code></pre> 
<h3><a id="4_78"></a>4.空间极值点（关键点）检测</h3> 
<p>关键点是由DOG空间的局部极值点组成，关键点的初步探索是通过同一组内各DOG相邻两层图像之间比较完成的。为了寻找DOG函数的极值点，每一个像素点要和它相邻点比较，看是否比它的图像域和尺度域的相邻点大或者小。如下图所示，中间检测点要与其8个相邻点和上下相邻尺度的18个点共26个点比较。<br> <img src="https://images2.imgbox.com/10/8a/feoYTruA_o.png" alt="在这里插入图片描述"><br> <strong>源码：</strong></p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//极大值检测{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&lt;</span> <span class="token function">pixval32f</span><span class="token punctuation">(</span>dog_pyr<span class="token punctuation">[</span>octv<span class="token punctuation">]</span><span class="token punctuation">[</span>intvl <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">,</span> r <span class="token operator">+</span> j<span class="token punctuation">,</span> c <span class="token operator">+</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//pixval32f为提取图像像素位置上的灰度值</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token comment">/* check for minimum */</span>
		<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;</span> <span class="token function">pixval32f</span><span class="token punctuation">(</span>dog_pyr<span class="token punctuation">[</span>octv<span class="token punctuation">]</span><span class="token punctuation">[</span>intvl <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">,</span> r <span class="token operator">+</span> j<span class="token punctuation">,</span> c <span class="token operator">+</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//r c为图像的行数和列数，dog_pyr为高斯差分图</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="42_98"></a>4.2关键点定位</h3> 
<p>以上方法检测到的极值点是离散空间的极值点，接下来通过拟合三维二次函数来精确确定关键点的位置和尺度，同时去除低对比度和不稳定的边缘相应点（DOG算子会产生较强的边缘响应），以增强匹配的稳定性。</p> 
<p><strong>关键点精确定位</strong><br> <img src="https://images2.imgbox.com/54/da/QR7rrgB0_o.png" alt="在这里插入图片描述"><br> 从上图可以看到，离散空间的极值点并不是真正的极值点。利用已知的离散空间点插值得到的连续空间极值点的方法叫做子像素插值</p> 
<p>为了提高关键点的稳定性，需要对尺度空间DOG函数进行 曲线插值。利用DOG函数在尺度空间的Taylor展开式如下：<br> <img src="https://images2.imgbox.com/52/9f/1p0ORxwc_o.png" alt="在这里插入图片描述"><br> 上式算式的矩阵表示如下：<br> <img src="https://images2.imgbox.com/5f/5a/CvjU2PhN_o.png" alt="在这里插入图片描述"><br> 其中，x求导并让方程等于零，可以得到极值点的偏移量为：<br> <img src="https://images2.imgbox.com/47/f8/JeGAwOUP_o.png" alt="在这里插入图片描述"><br> 对应极值点，方程的值为：<br> <img src="https://images2.imgbox.com/3a/a3/bFD6K1gD_o.png" alt="在这里插入图片描述"><br> 其中x^代表对应插值中心的偏移量，当它在任一维度上的偏移量大于0.5时，意味着插值中心已经偏移到它的临近点上了，所以必须改变当前关键点的位置。同时在新的位置上反复插值直到收敛；也有可能是迭代次数已超标，或超出图像边界的范围，这样的点则删除。</p> 
<p>过小的点容易受到噪声的干扰而不稳定，所以将小于某个经验值的极值点删除。</p> 
<p>同时，在此过程中获取特征点的精确位置（原位置加上拟合的偏移量）以及尺度(σ)</p> 
<p><strong>精确定位中的泰勒插值源码</strong></p> 
<pre><code class="prism language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> SIFT_MAX_INTERP_STEPS<span class="token punctuation">)</span><span class="token comment">//SIFT_MAX_INTERP_STEPS=5为最大迭代次数，避免长时迭代</span>
		<span class="token punctuation">{<!-- --></span>
		<span class="token function">interp_step</span><span class="token punctuation">(</span>dog_pyr<span class="token punctuation">,</span> octv<span class="token punctuation">,</span> intvl<span class="token punctuation">,</span> r<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>xc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 泰勒展开拟合，xi,xr,xc依次为x、y、σ方向偏移量, </span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ABS</span><span class="token punctuation">(</span>xi<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span>  <span class="token operator">&amp;&amp;</span>  <span class="token function">ABS</span><span class="token punctuation">(</span>xr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span>  <span class="token operator">&amp;&amp;</span>  <span class="token function">ABS</span><span class="token punctuation">(</span>xc<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token comment">//如果当前偏移量绝对值中的每个值均小于0.5，退出迭代</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		c <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">cvRound</span><span class="token punctuation">(</span>xc<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//计算行坐标，cvRound 为四舍五入。</span>
		r <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">cvRound</span><span class="token punctuation">(</span>xr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		intvl <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">cvRound</span><span class="token punctuation">(</span>xi<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>intvl <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span><span class="token comment">//不在计算的图像层中</span>
			intvl <span class="token operator">&gt;</span> intvls <span class="token operator">||</span><span class="token comment">//高斯差分每组的层数为intvls </span>
			c <span class="token operator">&lt;</span> SIFT_IMG_BORDER <span class="token operator">||</span><span class="token comment">//靠近图像边缘5个像素的区域不做检测，SIFT_IMG_BORDER=5,</span>
			r <span class="token operator">&lt;</span> SIFT_IMG_BORDER <span class="token operator">||</span>
			c <span class="token operator">&gt;=</span> dog_pyr<span class="token punctuation">[</span>octv<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>width <span class="token operator">-</span> SIFT_IMG_BORDER <span class="token operator">||</span><span class="token comment">//靠近图像边缘5个像素的区域不做检测</span>
			r <span class="token operator">&gt;=</span> dog_pyr<span class="token punctuation">[</span>octv<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>height <span class="token operator">-</span> SIFT_IMG_BORDER<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//迭代计数</span>
		<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">interp_step</span><span class="token punctuation">(</span>IplImage<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> dog_pyr<span class="token punctuation">,</span> <span class="token keyword">int</span> octv<span class="token punctuation">,</span> <span class="token keyword">int</span> intvl<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> c<span class="token punctuation">,</span><span class="token keyword">double</span><span class="token operator">*</span> xi<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">*</span> xr<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">*</span> xc<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
	CvMat<span class="token operator">*</span> dD<span class="token punctuation">,</span> <span class="token operator">*</span>H<span class="token punctuation">,</span> <span class="token operator">*</span>H_inv<span class="token punctuation">,</span> X<span class="token punctuation">;</span>
	<span class="token keyword">double</span> x<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	dD <span class="token operator">=</span> <span class="token function">deriv_3D</span><span class="token punctuation">(</span>dog_pyr<span class="token punctuation">,</span> octv<span class="token punctuation">,</span> intvl<span class="token punctuation">,</span> r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//一阶偏导数</span>
	H <span class="token operator">=</span> <span class="token function">hessian_3D</span><span class="token punctuation">(</span>dog_pyr<span class="token punctuation">,</span> octv<span class="token punctuation">,</span> intvl<span class="token punctuation">,</span> r<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Hessian 矩阵即二阶导数组成的矩阵</span>
	H_inv <span class="token operator">=</span> <span class="token function">cvCreateMat</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> CV_64FC1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cvInvert</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> H_inv<span class="token punctuation">,</span> CV_SVD<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//求Hessian矩阵的逆矩阵</span>
	<span class="token function">cvInitMatHeader</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>X<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> CV_64FC1<span class="token punctuation">,</span> x<span class="token punctuation">,</span> CV_AUTOSTEP<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">cvGEMM</span><span class="token punctuation">(</span>H_inv<span class="token punctuation">,</span> dD<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>X<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//cvGEMM为矩阵乘法，//第一个矩阵的系数；//H_inv、dD第一二个矩阵//-1矩阵前的常数//X结果矩阵</span>
	<span class="token function">cvReleaseMat</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dD<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">cvReleaseMat</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>H<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">cvReleaseMat</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>H_inv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">*</span>xi <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
	<span class="token operator">*</span>xr <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token operator">*</span>xc <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="5_163"></a>5.关键点方向分配</h3> 
<p>为了让描述符具有旋转不变性，需要利用图像的局部特征为每一个关键点分配一个基准方向。使用图像梯度的方法求取局部结构的稳定方向</p> 
<p><strong>5.1、特征点梯度</strong></p> 
<p>对于在DOG金字塔中检测出的关键点，采集器所在高斯金字塔图像3σ领域窗口内像素的梯度和方向分布特征<br> <img src="https://images2.imgbox.com/ae/78/QXh8Mj7D_o.png" alt="在这里插入图片描述"><br> L为关键点所在的尺度空间值，按Lowe的建议，梯度的模值m(x,y)按 σ=1.5σ_oct 的高斯分布加成，按尺度采样的3σ原则，领域窗口半径为 3x1.5σ_oct。</p> 
<p><strong>5.2 梯度直方图</strong><br> 在完成关键点的梯度计算后，使用直方图统计领域内像素的梯度和方向。梯度直方图将0-360°的方向范围分为36个柱（bins），每个柱10°。其中，直方图的峰值代表了关键点的主方向<br> <img src="https://images2.imgbox.com/98/93/ROCmDO7I_o.png" alt="在这里插入图片描述"><br> <strong>5.3 特征点主方向的确定</strong><br> <img src="https://images2.imgbox.com/2d/90/r42EN2WX_o.jpg" alt="在这里插入图片描述"></p> 
<p>方向直方图的峰值则代表了该特征点处邻域梯度的方向，以直方图中最大值作为该关键点的主方向。为了增强匹配的鲁棒性，只保留峰值大于主方向峰值80％的方向作为该关键点的辅方向。因此，对于同一梯度值的多个峰值的关键点位置，在相同位置和尺度将会有多个关键点被创建但方向不同。仅有15％的关键点被赋予多个方向，但可以明显的提高关键点匹配的稳定性。实际编程实现中，就是把该关键点复制成多份关键点，并将方向值分别赋给这些复制后的关键点，并且，离散的梯度方向直方图要进行插值拟合处理，来求得更精确的方向角度值。</p> 
<p><strong>5.4 梯度图像的平滑处理</strong></p> 
<p>为了防止某个梯度方向角度因受到噪声干扰而突变，可以对梯度方向直方图进行平滑处理<br> <img src="https://images2.imgbox.com/3c/75/YmU7Vyjr_o.png" alt="在这里插入图片描述"><br> 梯度直方图抛物线插值<br> <img src="https://images2.imgbox.com/1b/cb/vaYTNgus_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> interp_hist_peak( l, c, r ) ( 0.5 * ((l)-(r)) / ((l) - 2.0*(c) + (r)) )</span><span class="token comment">//插值计算式，l为左侧柱子值，r为左侧柱子值</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add_good_ori_features</span><span class="token punctuation">(</span>CvSeq<span class="token operator">*</span> features<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token operator">*</span> hist<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span>
								  <span class="token keyword">double</span> mag_thr<span class="token punctuation">,</span> <span class="token keyword">struct</span> feature<span class="token operator">*</span> feat<span class="token punctuation">)</span><span class="token comment">//精确主方向及辅方向</span>
	<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> feature<span class="token operator">*</span> new_feat<span class="token punctuation">;</span>
	<span class="token keyword">double</span> bin<span class="token punctuation">,</span> PI2 <span class="token operator">=</span> CV_PI <span class="token operator">*</span> <span class="token number">2.0</span><span class="token punctuation">;</span><span class="token comment">//CV_PI=pi</span>
	<span class="token keyword">int</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">// 直方图有n=36个小柱子</span>
		<span class="token punctuation">{<!-- --></span>
		l <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> n <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">:</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//把小柱子看成是循环的，角度的取值为0-360即一个圆周</span>
		r <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> n<span class="token punctuation">;</span>
		<span class="token comment">//只对小柱子的值大于等于主峰80%且此小柱子比左右两边小柱子都高的柱子进行抛物线插值</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>hist<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> hist<span class="token punctuation">[</span>l<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> hist<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> hist<span class="token punctuation">[</span>r<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> hist<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> mag_thr<span class="token punctuation">)</span><span class="token comment">// mag_thr为&gt;=80%的最高峰值</span>
			<span class="token punctuation">{<!-- --></span>
			bin <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token function">interp_hist_peak</span><span class="token punctuation">(</span>hist<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">,</span> hist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> hist<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//interp_hist_peak 插值函数</span>
			bin <span class="token operator">=</span> <span class="token punctuation">(</span>bin <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> n <span class="token operator">+</span> bin <span class="token operator">:</span> <span class="token punctuation">(</span>bin <span class="token operator">&gt;=</span> n<span class="token punctuation">)</span> <span class="token operator">?</span> bin <span class="token operator">-</span> n <span class="token operator">:</span> bin<span class="token punctuation">;</span><span class="token comment">//角度取值约束在0-360之间，且是连续循环的</span>
			new_feat <span class="token operator">=</span> <span class="token function">clone_feature</span><span class="token punctuation">(</span>feat<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//幅值特征点</span>
			new_feat<span class="token operator">-</span><span class="token operator">&gt;</span>ori <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>PI2 <span class="token operator">*</span> bin<span class="token punctuation">)</span> <span class="token operator">/</span> n<span class="token punctuation">)</span> <span class="token operator">-</span> CV_PI<span class="token punctuation">;</span><span class="token comment">//？</span>
			<span class="token function">cvSeqPush</span><span class="token punctuation">(</span>features<span class="token punctuation">,</span> new_feat<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">free</span><span class="token punctuation">(</span>new_feat<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>	
</code></pre> 
<h3><a id="6_213"></a>6.特征点描述符</h3> 
<p>通过以上步骤，对于每一个关键点，拥有三个信息：位置，尺度以及方向。接下来为每个关键点建立一个描述符，使其不随各种变化而变化，提高特征点正确匹配的概率。</p> 
<p>将关键点附近的区域划分为d*d(Lowe建议d=4)个子区域，每个子区域作为一个种子点，每个种子点有8个方向。考虑到实际计算时，需要采用三线性插值，所需图像窗口边长为3x3xσ_oct x(d+1) 。在考虑到旋转因素(方便下一步将坐标轴旋转到关键点的方向)，如下图6.1所示，实际计算所需的图像区域半径为：</p> 
<p><img src="https://images2.imgbox.com/1a/89/QrkbDSZC_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ea/2d/SJvA8x8q_o.png" alt="在这里插入图片描述"><br> <strong>坐标轴旋转至主方向</strong></p> 
<p>将坐标轴旋转为关键点的方向，以确保旋转不变性<br> <img src="https://images2.imgbox.com/15/ef/dgBmcEPP_o.png" alt="在这里插入图片描述"><br> <strong>生成梯度直方图</strong></p> 
<p>将邻域内的采样点分配到对应的子区域内，将子区域的梯度值分配到8个方向上，计算其权值<br> <img src="https://images2.imgbox.com/eb/2b/eUMXXn4T_o.png" alt="在这里插入图片描述"></p> 
<p><strong>6.2、三线性插值</strong><br> 插值计算每个种子点八个方向的梯度<br> <img src="https://images2.imgbox.com/58/64/QKyMQrFh_o.png" alt="在这里插入图片描述"><br> 采样点在子区域中的下标(x’’,y’’) (图中蓝色窗口内红色点)线性插值，计算其对每个种子点的贡献。如图中的红色点，落在第0行和第1行之间，对这两行都有贡献。对第0行第3列种子点的贡献因子为dr，对第1行第3列的贡献因子为1-dr，同理，对邻近两列的贡献因子为dc和1-dc，对邻近两个方向的贡献因子为do和1-do。则最终累加在每个方向上的梯度大小为：<br> <img src="https://images2.imgbox.com/db/59/ZY4YRU11_o.png" alt="在这里插入图片描述"><br> 其中k，m，n为0（像素点超出了对要插值区间的四个邻近子区间所在范围）或为1（像素点处在对要插值区间的四个邻近子区间之一所在范围）。</p> 
<p><strong>6.3、特征描述子</strong></p> 
<p>如上统计的4X4X8=128个梯度信息即为关键点的特征向量</p> 
<p>特征向量形成后，为了去除光照变化的影响，需要对它们进行归一化处理，对于图像灰度值整体漂移，图像各点的梯度是邻域像素相减得到，所以也能去除。得到的描述子向量为H=(h1,h2,…,h128)，归一化后的特征向量为L=(L1,L2,…,L128)，则<br> <img src="https://images2.imgbox.com/39/01/Vf67dsFn_o.png" alt="在这里插入图片描述"><br> <strong>描述子生成总括</strong><br> <img src="https://images2.imgbox.com/04/9f/Mkfqu03l_o.png" alt="在这里插入图片描述"><br> <strong>三线性插值源码</strong></p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">interp_hist_entry</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> hist<span class="token punctuation">,</span> <span class="token keyword">double</span> rbin<span class="token punctuation">,</span> <span class="token keyword">double</span> cbin<span class="token punctuation">,</span>
								  <span class="token keyword">double</span> obin<span class="token punctuation">,</span> <span class="token keyword">double</span> mag<span class="token punctuation">,</span> <span class="token keyword">int</span> d<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">double</span> d_r<span class="token punctuation">,</span> d_c<span class="token punctuation">,</span> d_o<span class="token punctuation">,</span> v_r<span class="token punctuation">,</span> v_c<span class="token punctuation">,</span> v_o<span class="token punctuation">;</span>
		<span class="token keyword">double</span><span class="token operator">*</span><span class="token operator">*</span> row<span class="token punctuation">,</span> <span class="token operator">*</span>h<span class="token punctuation">;</span>
		<span class="token keyword">int</span> r0<span class="token punctuation">,</span> c0<span class="token punctuation">,</span> o0<span class="token punctuation">,</span> rb<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> ob<span class="token punctuation">,</span> r<span class="token punctuation">,</span> c<span class="token punctuation">,</span> o<span class="token punctuation">;</span>
		r0 <span class="token operator">=</span> <span class="token function">cvFloor</span><span class="token punctuation">(</span>rbin<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//向下取整</span>
		c0 <span class="token operator">=</span> <span class="token function">cvFloor</span><span class="token punctuation">(</span>cbin<span class="token punctuation">)</span><span class="token punctuation">;</span>
		o0 <span class="token operator">=</span> <span class="token function">cvFloor</span><span class="token punctuation">(</span>obin<span class="token punctuation">)</span><span class="token punctuation">;</span>
		d_r <span class="token operator">=</span> rbin <span class="token operator">-</span> r0<span class="token punctuation">;</span><span class="token comment">//小数余项</span>
		d_c <span class="token operator">=</span> cbin <span class="token operator">-</span> c0<span class="token punctuation">;</span>
		d_o <span class="token operator">=</span> obin <span class="token operator">-</span> o0<span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> r <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> r<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//沿着行方向不超过1个单位长度</span>
			<span class="token punctuation">{<!-- --></span>
			rb <span class="token operator">=</span> r0 <span class="token operator">+</span> r<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>rb <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rb <span class="token operator">&lt;</span> d<span class="token punctuation">)</span><span class="token comment">//如果此刻还在真正的描述子区间内</span>
				<span class="token punctuation">{<!-- --></span>
				v_r <span class="token operator">=</span> mag <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token operator">-</span> d_r <span class="token operator">:</span> d_r<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//d_r = rbin - r0;</span>
				row <span class="token operator">=</span> hist<span class="token punctuation">[</span>rb<span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token keyword">for</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> c<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//沿着行方向不超过1个单位长度</span>
					<span class="token punctuation">{<!-- --></span>
					cb <span class="token operator">=</span> c0 <span class="token operator">+</span> c<span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>cb <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> cb <span class="token operator">&lt;</span> d<span class="token punctuation">)</span>
						<span class="token punctuation">{<!-- --></span>
						v_c <span class="token operator">=</span> v_r <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token operator">-</span> d_c <span class="token operator">:</span> d_c<span class="token punctuation">)</span><span class="token punctuation">;</span>
						h <span class="token operator">=</span> row<span class="token punctuation">[</span>cb<span class="token punctuation">]</span><span class="token punctuation">;</span>
						<span class="token keyword">for</span> <span class="token punctuation">(</span>o <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> o <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span> o<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//沿着直方图方向不超过1个单位角度 </span>
							<span class="token punctuation">{<!-- --></span> 
							ob <span class="token operator">=</span> <span class="token punctuation">(</span>o0 <span class="token operator">+</span> o<span class="token punctuation">)</span> <span class="token operator">%</span> n；<span class="token comment">//n=8，8个小柱子</span>
							v_o <span class="token operator">=</span> v_c <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1.0</span> <span class="token operator">-</span> d_o <span class="token operator">:</span> d_o<span class="token punctuation">)</span><span class="token punctuation">;</span>
							h<span class="token punctuation">[</span>ob<span class="token punctuation">]</span> <span class="token operator">+</span><span class="token operator">=</span> v_o<span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="7APIopen_CV_284"></a>7.API及open CV应用</h3> 
<p><img src="https://images2.imgbox.com/c5/e2/POjY8RnH_o.png" alt="在这里插入图片描述"></p> 
<p>参数说明：<br> 1.nfeatures：保留的最佳特征数量，特征按 其得分排序<br> 2.高斯金字塔最小层数，由图像自动计算出<br> 3.constrastThrehold：对比度阈值，用于过滤区域中的弱特征，域值越大，检测器产生的特征越少<br> 4.edgeThreshold:用于过滤掉类似边缘特征的阈值。域值越大，产生的特征越少<br> 5.sigma:高斯输入层级，如果图像分辨率越低，数值越小</p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;opencv2/xfeatures2d&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;math.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token operator">::</span>xfeatures2d<span class="token punctuation">;</span>



Mat src<span class="token punctuation">,</span> gray_src<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> output_title <span class="token operator">=</span> <span class="token string">"output_win"</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> corners <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> max_corners <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Tomasi_Demo</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SubPixel_Demo</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	src <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"C:/Users/18929/Desktop/博客项目/项目图片/18.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"could not load image"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"input image"</span><span class="token punctuation">,</span> CV_WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"input_img"</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> numFeatures <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
	Ptr<span class="token operator">&lt;</span>SIFT<span class="token operator">&gt;</span> detector <span class="token operator">=</span> SIFT<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span>numFeatures<span class="token punctuation">)</span><span class="token punctuation">;</span>
	vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> keypoints<span class="token punctuation">;</span>
	detector<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">detect</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> keypoints<span class="token punctuation">,</span> <span class="token function">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Total KeyPoints:%d\n"</span><span class="token punctuation">,</span> keypoints<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	Mat keypoint_img<span class="token punctuation">;</span>
	<span class="token function">drawKeypoints</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> keypoints<span class="token punctuation">,</span> keypoint_img<span class="token punctuation">,</span> Scalar<span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> DrawMatchesFlags<span class="token operator">::</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">namedWindow</span><span class="token punctuation">(</span><span class="token string">"SIFT KeyPoints"</span><span class="token punctuation">,</span> CV_WINDOW_AUTOSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"SIFT KeyPoints"</span><span class="token punctuation">,</span> keypoint_img<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/10/8c/juJrSYVW_o.jpg" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a6c9ddb8f055c7bc656942725e15284d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">2020年“深圳杯”数学建模挑战赛D题-公交车在高峰和平峰转换期间的调度 题解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2fec392304a5c23ac138da22847f9b7c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">PHP</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大白的博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>