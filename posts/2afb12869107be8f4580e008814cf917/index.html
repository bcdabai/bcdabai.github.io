<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>å…«. å®æˆ˜ï¼šCUDA-BEVFusionéƒ¨ç½²åˆ†æ-å¯¼å‡ºå¸¦æœ‰spconvçš„SCNç½‘ç»œçš„onnx - ç¼–ç¨‹å¤§ç™½çš„åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="å…«. å®æˆ˜ï¼šCUDA-BEVFusionéƒ¨ç½²åˆ†æ-å¯¼å‡ºå¸¦æœ‰spconvçš„SCNç½‘ç»œçš„onnx" />
<meta property="og:description" content="ç›®å½• å‰è¨€0. ç®€è¿°1. ä½¿ç”¨spconvè¿›è¡ŒSCNçš„æ¨ç†æµ‹è¯•2. å¯¼å‡ºonnx3. è¡¥å……-è£…é¥°å™¨&#43;é’©å­å‡½æ•°æ€»ç»“ä¸‹è½½é“¾æ¥å‚è€ƒ å‰è¨€ è‡ªåŠ¨é©¾é©¶ä¹‹å¿ƒæ¨å‡ºçš„ ã€ŠCUDAä¸TensorRTéƒ¨ç½²å®æˆ˜è¯¾ç¨‹ã€‹ï¼Œé“¾æ¥ã€‚è®°å½•ä¸‹ä¸ªäººå­¦ä¹ ç¬”è®°ï¼Œä»…ä¾›è‡ªå·±å‚è€ƒ
æœ¬æ¬¡è¯¾ç¨‹æˆ‘ä»¬æ¥å­¦ä¹ ä¸‹è¯¾ç¨‹ç¬¬å…«ç« â€”â€”å®æˆ˜ï¼šCUDA-BEVFusionéƒ¨ç½²åˆ†æï¼Œä¸€èµ·æ¥å­¦ä¹ å¯¼å‡ºå¸¦æœ‰ spconv çš„ SCN ç½‘ç»œçš„ onnx
Noteï¼šä¹‹å‰åœ¨å­¦ä¹ æœè€å¸ˆçš„è¯¾ç¨‹ä¸­æœ‰ç®€å•è®°å½•è¿‡ Sparse Convolution çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸‹ï¼šå¤æ‚onnxè§£å†³æ–¹æ¡ˆï¼ˆä»¥sparseconvä¸ºä¾‹ï¼‰
è¯¾ç¨‹å¤§çº²å¯ä»¥çœ‹ä¸‹é¢çš„æ€ç»´å¯¼å›¾
0. ç®€è¿° æœ¬å°èŠ‚ç›®æ ‡ï¼šå­¦ä¹ åˆ©ç”¨ hook æˆªå– spconv çš„ forwardï¼Œä»è€Œè‡ªå®šä¹‰ onnx ç®—å­å¯¼å‡º onnx çš„æ–¹æ³•
ä»Šå¤©ç»™å¤§å®¶è®²è§£ç¬¬å…«ç« ç¬¬ 3 å°èŠ‚ï¼Œå­¦ä¹ å¯¼å‡ºå¸¦æœ‰ spconv çš„ SCN ç½‘ç»œçš„ onnxï¼Œè¿™ä¸ªå°èŠ‚æˆ‘ä»¬å…ˆè·Ÿç€ NVIDIA å®˜æ–¹æä¾›çš„ 3D Sparse Convolution åº“ï¼Œå­¦ä¹ æ€ä¹ˆå»è°ƒç”¨å®ƒï¼Œæ¥å£æ˜¯ä»€ä¹ˆæ ·å­
æˆ‘ä»¬å…ˆå‡è®¾ onnx å·²ç»å¯¼å‡ºå¥½äº†ï¼Œè¯»å–å¯¼å‡ºå¥½çš„ onnx ç”Ÿæˆå¯¹åº”çš„ engine å¼•æ“å®Œæˆå‰å‘æ¨ç†ï¼Œæˆ‘ä»¬å…ˆæ¥å®Œæˆè¿™ä¸ªæµç¨‹ï¼Œonnx å¯¼å‡ºæˆ‘ä»¬ç¨åå†çœ‹
è¿™éƒ¨åˆ† NVIVIDA å…¶å®å¼€æºåœ¨ https://github.com/NVIDIA-AI-IOT/Lidar_AI_Solution/tree/master/libraries/3DSparseConvolutionï¼Œä½†å€¼å¾—æ³¨æ„çš„æ˜¯å®ƒæ•´ä¸ªæ¨ç†æ¡†æ¶è™½ç„¶æ˜¯å¼€æºäº†ï¼Œä½†æ¯”è¾ƒæ ¸å¿ƒçš„åœ°æ–¹æ¯”å¦‚ spconv é‡Œé¢æ˜¯æ€ä¹ˆåŠ é€Ÿçš„å®ƒå…¶å®å¹¶æ²¡æœ‰å¼€æº
æˆ‘ä»¬ä¸»è¦æ˜¯é€šè¿‡ NVIDIA æä¾›çš„æ–¹æ¡ˆä¸€èµ·å»å­¦ä¹ ä¸€ä¸‹å®ƒçš„æ¨ç†æ¡†æ¶æ˜¯æ€ä¹ˆåšçš„ä»¥åŠ spconv çš„æ¥å£æ˜¯å¦‚ä½•å»ä½¿ç”¨çš„ï¼Œè¿™æ˜¯æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹
ç¬¬äºŒä»¶äº‹å°±æ˜¯æˆ‘ä»¬éœ€è¦å­¦ä¹  spconv çš„ onnx æ˜¯æ€ä¹ˆå¯¼å‡ºçš„ï¼Œæˆ‘ä»¬ä¸ŠèŠ‚è¯¾ä¹Ÿè®²è¿‡ spconv çš„ onnx ç¨å¾®æœ‰ç‚¹ç‰¹æ®Šï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ç”¨ hook å»æˆªå– spconv çš„ forwardï¼Œä¹‹åé‡å®šä½ spconv çš„forwardï¼Œæ¥ç€å»åˆ›å»ºä¸€ä¸ª onnx è‡ªå®šä¹‰èŠ‚ç‚¹ï¼Œé€šè¿‡è¿™ä¸€ç³»åˆ—çš„æ“ä½œå®Œæˆ spconv çš„å¯¼å‡º" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bcdabai.github.io/posts/2afb12869107be8f4580e008814cf917/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-14T15:48:45+08:00" />
<meta property="article:modified_time" content="2024-01-14T15:48:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§ç™½çš„åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§ç™½çš„åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">å…«. å®æˆ˜ï¼šCUDA-BEVFusionéƒ¨ç½²åˆ†æ-å¯¼å‡ºå¸¦æœ‰spconvçš„SCNç½‘ç»œçš„onnx</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>ç›®å½•</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">å‰è¨€</a></li><li><a href="#0__14" rel="nofollow">0. ç®€è¿°</a></li><li><a href="#1_spconvSCN_28" rel="nofollow">1. ä½¿ç”¨spconvè¿›è¡ŒSCNçš„æ¨ç†æµ‹è¯•</a></li><li><a href="#2_onnx_398" rel="nofollow">2. å¯¼å‡ºonnx</a></li><li><a href="#3__677" rel="nofollow">3. è¡¥å……-è£…é¥°å™¨+é’©å­å‡½æ•°</a></li><li><a href="#_816" rel="nofollow">æ€»ç»“</a></li><li><a href="#_824" rel="nofollow">ä¸‹è½½é“¾æ¥</a></li><li><a href="#_830" rel="nofollow">å‚è€ƒ</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>å‰è¨€</h3> 
<blockquote> 
 <p>è‡ªåŠ¨é©¾é©¶ä¹‹å¿ƒæ¨å‡ºçš„ ã€ŠCUDAä¸TensorRTéƒ¨ç½²å®æˆ˜è¯¾ç¨‹ã€‹ï¼Œ<a href="https://www.zdjszx.com/p/t_pc/goods_pc_detail/goods_detail/course_2Qzh2CekDJZMNuZq1Gfp3HOgIqx" rel="nofollow">é“¾æ¥</a>ã€‚è®°å½•ä¸‹ä¸ªäººå­¦ä¹ ç¬”è®°ï¼Œ<strong>ä»…ä¾›è‡ªå·±å‚è€ƒ</strong></p> 
 <p>æœ¬æ¬¡è¯¾ç¨‹æˆ‘ä»¬æ¥å­¦ä¹ ä¸‹è¯¾ç¨‹ç¬¬å…«ç« â€”â€”å®æˆ˜ï¼šCUDA-BEVFusionéƒ¨ç½²åˆ†æï¼Œä¸€èµ·æ¥å­¦ä¹ å¯¼å‡ºå¸¦æœ‰ spconv çš„ SCN ç½‘ç»œçš„ onnx</p> 
 <p><strong>Note</strong>ï¼šä¹‹å‰åœ¨å­¦ä¹ æœè€å¸ˆçš„è¯¾ç¨‹ä¸­æœ‰ç®€å•è®°å½•è¿‡ Sparse Convolution çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸‹ï¼š<a href="https://blog.csdn.net/qq_40672115/article/details/131480952">å¤æ‚onnxè§£å†³æ–¹æ¡ˆï¼ˆä»¥sparseconvä¸ºä¾‹ï¼‰</a></p> 
 <p>è¯¾ç¨‹å¤§çº²å¯ä»¥çœ‹ä¸‹é¢çš„æ€ç»´å¯¼å›¾</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/2b/4a/kjVPHSEr_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h3><a id="0__14"></a>0. ç®€è¿°</h3> 
<blockquote> 
 <p>æœ¬å°èŠ‚ç›®æ ‡ï¼š<strong>å­¦ä¹ åˆ©ç”¨ hook æˆªå– spconv çš„ forwardï¼Œä»è€Œè‡ªå®šä¹‰ onnx ç®—å­å¯¼å‡º onnx çš„æ–¹æ³•</strong></p> 
</blockquote> 
<p>ä»Šå¤©ç»™å¤§å®¶è®²è§£ç¬¬å…«ç« ç¬¬ 3 å°èŠ‚ï¼Œå­¦ä¹ å¯¼å‡ºå¸¦æœ‰ spconv çš„ SCN ç½‘ç»œçš„ onnxï¼Œè¿™ä¸ªå°èŠ‚æˆ‘ä»¬å…ˆè·Ÿç€ NVIDIA å®˜æ–¹æä¾›çš„ 3D Sparse Convolution åº“ï¼Œå­¦ä¹ æ€ä¹ˆå»è°ƒç”¨å®ƒï¼Œæ¥å£æ˜¯ä»€ä¹ˆæ ·å­</p> 
<p>æˆ‘ä»¬å…ˆå‡è®¾ onnx å·²ç»å¯¼å‡ºå¥½äº†ï¼Œè¯»å–å¯¼å‡ºå¥½çš„ onnx ç”Ÿæˆå¯¹åº”çš„ engine å¼•æ“å®Œæˆå‰å‘æ¨ç†ï¼Œæˆ‘ä»¬å…ˆæ¥å®Œæˆè¿™ä¸ªæµç¨‹ï¼Œonnx å¯¼å‡ºæˆ‘ä»¬ç¨åå†çœ‹</p> 
<p>è¿™éƒ¨åˆ† NVIVIDA å…¶å®å¼€æºåœ¨ <a href="https://github.com/NVIDIA-AI-IOT/Lidar_AI_Solution/tree/master/libraries/3DSparseConvolution">https://github.com/NVIDIA-AI-IOT/Lidar_AI_Solution/tree/master/libraries/3DSparseConvolution</a>ï¼Œä½†å€¼å¾—æ³¨æ„çš„æ˜¯å®ƒæ•´ä¸ªæ¨ç†æ¡†æ¶è™½ç„¶æ˜¯å¼€æºäº†ï¼Œä½†æ¯”è¾ƒæ ¸å¿ƒçš„åœ°æ–¹æ¯”å¦‚ spconv é‡Œé¢æ˜¯æ€ä¹ˆåŠ é€Ÿçš„å®ƒå…¶å®å¹¶æ²¡æœ‰å¼€æº</p> 
<p>æˆ‘ä»¬ä¸»è¦æ˜¯é€šè¿‡ NVIDIA æä¾›çš„æ–¹æ¡ˆä¸€èµ·å»å­¦ä¹ ä¸€ä¸‹å®ƒçš„æ¨ç†æ¡†æ¶æ˜¯æ€ä¹ˆåšçš„ä»¥åŠ spconv çš„æ¥å£æ˜¯å¦‚ä½•å»ä½¿ç”¨çš„ï¼Œè¿™æ˜¯æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹</p> 
<p>ç¬¬äºŒä»¶äº‹å°±æ˜¯æˆ‘ä»¬éœ€è¦å­¦ä¹  spconv çš„ onnx æ˜¯æ€ä¹ˆå¯¼å‡ºçš„ï¼Œæˆ‘ä»¬ä¸ŠèŠ‚è¯¾ä¹Ÿè®²è¿‡ spconv çš„ onnx ç¨å¾®æœ‰ç‚¹ç‰¹æ®Šï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ç”¨ hook å»æˆªå– spconv çš„ forwardï¼Œä¹‹åé‡å®šä½ spconv çš„forwardï¼Œæ¥ç€å»åˆ›å»ºä¸€ä¸ª onnx è‡ªå®šä¹‰èŠ‚ç‚¹ï¼Œé€šè¿‡è¿™ä¸€ç³»åˆ—çš„æ“ä½œå®Œæˆ spconv çš„å¯¼å‡º</p> 
<h3><a id="1_spconvSCN_28"></a>1. ä½¿ç”¨spconvè¿›è¡ŒSCNçš„æ¨ç†æµ‹è¯•</h3> 
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ NVIDIA å®˜æ–¹æä¾›çš„ 3D Sparse Convolution çš„ README æ–‡æ¡£ï¼Œå®ƒä½äº LiDAR_AI_Soultion é¡¹ç›®ä¸‹çš„ <strong>libraries/3DSparseConvolution</strong>ï¼ŒREADME ä¸­æåˆ° 3DSparseConvolution è¿™ä¸ªåº“æä¾›äº†ä¸€ä¸ª int8/fp16 ç²¾åº¦çš„ 3D ç¨€ç–å·ç§¯ç½‘ç»œçš„æ¨ç†å¼•æ“ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/bb/b7/0UbB19hn_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>æˆ‘ä»¬å…ˆæ¥å°†å®ƒè·‘é€šï¼ŒREADME ä¸­æåˆ°è¯¥é¡¹ç›®çš„è¿è¡Œè¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹ä¸‰éƒ¨åˆ†ï¼š</p> 
<ul><li><strong>1.</strong> ä» <a href="https://github.com/tianweiy/CenterPoint">https://github.com/tianweiy/CenterPoint</a> ä¸‹è½½å¹¶é…ç½® CenterPoint ç¯å¢ƒ</li><li><strong>2.</strong> å¯¼å‡º SCN ONNX</li><li><strong>3.</strong> ç¼–è¯‘å’Œè¿è¡Œ</li></ul> 
<p>è¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬å¯ä»¥å…ˆæš‚æ—¶è·³è¿‡ SCN ONNX çš„å¯¼å‡ºï¼Œå› ä¸ºåœ¨ä¸‹è½½ LiDAR_AI_Solution è¿™ä¸ª repo æ—¶å®˜æ–¹å…¶å®æä¾›äº†å¯¼å‡ºå¥½çš„ CenterPoint SCN çš„ ONNX ä¾›æˆ‘ä»¬æµ‹è¯•ï¼Œå…·ä½“ä½ç½®åœ¨ <strong>3DSparseConvolution/workspace/centerpoint</strong> æ–‡ä»¶å¤¹ä¸‹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è·³è¿‡ç¬¬ä¸€éƒ¨åˆ†å’Œç¬¬äºŒéƒ¨åˆ†ï¼Œç›´æ¥åˆ©ç”¨å®˜æ–¹æä¾›çš„å¯¼å‡ºå¥½çš„ SCN ONNX æ¥ç¼–è¯‘è¿è¡Œçœ‹èƒ½å¦é€šè¿‡</p> 
<p>å› æ­¤æˆ‘ä»¬å…ˆå‡è®¾è¿™ä¸ª ONNX å¯¼å‡ºå¥½äº†ï¼Œæˆ‘ä»¬æ¥ç›´æ¥è¯»å–è¿™ä¸ª ONNX çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆåšå‰å‘æ¨ç†çš„ï¼ŒæŒ‡ä»¤å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-shell">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libprotobuf-dev<span class="token operator">=</span><span class="token number">3.6</span>.1*
$ <span class="token builtin class-name">cd</span> path/to/3DSparseConvolution
$ <span class="token function">make</span> fp16 <span class="token parameter variable">-j</span>
</code></pre> 
<p>è¯¥åº“ä¾èµ–äº protobufï¼Œå› æ­¤ä½ éœ€è¦å…ˆå®‰è£… protobufï¼Œå…³äº protobuf åº“çš„å®‰è£…åšä¸»åœ¨ <a href="https://blog.csdn.net/qq_40672115/article/details/135319174?spm=1001.2014.3001.5502">å…«. å®æˆ˜ï¼šCUDA-BEVFusionéƒ¨ç½²åˆ†æ-ç¯å¢ƒæ­å»º</a> ä¸­ä¹Ÿæä¾›äº† apt å’Œæºç ä¸¤ç§å®‰è£…æ–¹å¼ï¼Œè¿™è¾¹ä¸å†èµ˜è¿°ã€‚æ¥ç€æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æ‰§è¡Œ <strong>make</strong> æŒ‡ä»¤æ¥ç¼–è¯‘äº†ï¼Œè¾“å‡ºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/1d/59/Iv4xitkV_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>æˆ‘ä»¬ç®€å•çœ‹ä¸€ä¸‹ç¼–è¯‘è¿‡ç¨‹ä¸­å®ƒéƒ½åšäº†äº›ä»€ä¹ˆï¼Œä»æ—¥å¿—ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒå…ˆåšäº†ä¸€ä¸ª Parse node conv0 [Sparseconvolution]ï¼ŒæŠŠè¿™ä¸ª Node èŠ‚ç‚¹ Parse å®Œä¹‹åå†åšä¸€ä¸ª addï¼Œä¹Ÿå°±æ˜¯æŠŠ Parse å®Œä¹‹åçš„ä¿¡æ¯è¯»å–å‡ºæ¥åŠ å…¥åˆ° conv0 é‡Œé¢</p> 
<p>é‚£ conv0 è¿™ä¸ªä¸œè¥¿æˆ‘ä»¬ä»è¿™é‡Œé¢å¯ä»¥çœ‹åˆ°å®ƒå…¶å®æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„èŠ‚ç‚¹ï¼Œå®ƒé‡Œé¢å‚æ•°æ˜¯ submanifoldï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„ 3D Sparse Convolution çš„ä¸€ç§å½¢å¼ï¼ŒåŒæ ·ä¾æ­¤ç±»æ¨åé¢è¿˜æœ‰ conv1ã€conv2 ç­‰ç­‰ï¼Œè¿™ä¸€ç³»åˆ—æ“ä½œéƒ½æ˜¯è¿™ä¹ˆåšçš„</p> 
<p>å…¶æ¬¡æˆ‘ä»¬å†æ¥å…³æ³¨ä¸‹å…¶ç²¾åº¦ï¼Œä»æ—¥å¿—ä¸­å¯ä»¥çœ‹å‡ºè¾“å…¥è¾“å‡ºéƒ¨åˆ†æ˜¯è·‘çš„ FP16 ç²¾åº¦ï¼Œè€Œä¸­é—´çš„ spconv éƒ¨åˆ†è·‘çš„æ˜¯ INT8 ç²¾åº¦ï¼Œå› æ­¤ SCN æ•´ä½“æ¨ç†æ¡†æ¶çš„ç²¾åº¦æ˜¯ FP16+INT8</p> 
<p><img src="https://images2.imgbox.com/ed/27/4ut92t4d_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹æ•´ä¸ªç½‘ç»œ forward è¿‡ç¨‹ä¸­ tensor ç»´åº¦çš„å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¾“å…¥ç»´åº¦æ˜¯ 41x1440x1440ï¼Œ1440x1440 ä»£è¡¨ç€ 3D ç‚¹äº‘ç»è¿‡ä½“ç´ åŒ–ä¹‹åå¾—åˆ°çš„ä¸€ä¸ªåæ ‡ç³»ï¼Œ41 ä»£è¡¨å®ƒçš„é€šé“æ•°</p> 
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ•´ä¸ªè¿‡ç¨‹ä¸­å…¶å®å°±æ˜¯ä¸æ–­çš„è¿›è¡Œç¨€ç–å·ç§¯ï¼Œç„¶ååš downsample å˜æˆ 720x720 ä¹‹åå†åšä¸€ä¸ªç¨€ç–å·ç§¯é™ç»´åˆ° 360x360 ä¹‹åå†é€šè¿‡ç¨€ç–å·ç§¯é™ç»´åˆ° 180x180ã€‚é™åˆ° 180x180 ä¹‹åæˆ‘ä»¬å†åšä¸€ä¸ª scatterï¼Œé‚£è¿™ä¸ªæ“ä½œå°±æ˜¯å°†ç»´åº¦æ‰©å……åˆ° 1x128x2x180x180 çš„ç»´åº¦ï¼Œä¹‹åå†åš reshapeï¼Œreshape åˆ° 1x256x180x180 çš„ tensorï¼Œè¿™ä¸ªå°±æ˜¯ SCN ç½‘ç»œæœ€ç»ˆè¾“å‡º tensor çš„ä¸€ä¸ªç»´åº¦äº†</p> 
<p>é‚£ 1x255x180x180 ä»£è¡¨çš„æ„ä¹‰æ˜¯å®ƒç”Ÿæˆçš„ BEV Grid çš„å¤§å°æ˜¯ 180x180ï¼Œæ¯ä¸€ä¸ª Grid ä¸Šæœ‰ 256 ç»´çš„ç‰¹å¾ï¼Œé‚£è¿™ 256 ç»´çš„ç‰¹å¾æ˜¯ä»ç‚¹äº‘é‚£è¾¹ç›´æ¥å­¦ä¹ å¾—åˆ°çš„ï¼Œä»¥ä¸Šå°±æ˜¯ SCN ç½‘ç»œ forward çš„æ•´ä¸ªæµç¨‹</p> 
<p>OKï¼Œä¸‹é¢æˆ‘ä»¬æ¥è¿›ä»£ç çœ‹çœ‹å†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæˆ‘ä»¬å…ˆä» <strong>main.cpp</strong> çœ‹èµ·ï¼Œä»£ç å…¥å£å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> cmd <span class="token operator">=</span> <span class="token string">"fp16"</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> cmd <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  cudaStream_t stream <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token function">checkRuntime</span><span class="token punctuation">(</span><span class="token function">cudaStreamCreate</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"memint8"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">do_memory_usage_test</span><span class="token punctuation">(</span>spconv<span class="token double-colon punctuation">::</span>Precision<span class="token double-colon punctuation">::</span>Int8<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"memfp16"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">do_memory_usage_test</span><span class="token punctuation">(</span>spconv<span class="token double-colon punctuation">::</span>Precision<span class="token double-colon punctuation">::</span>Float16<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"int8"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">do_simple_run</span><span class="token punctuation">(</span>spconv<span class="token double-colon punctuation">::</span>Precision<span class="token double-colon punctuation">::</span>Int8<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> <span class="token string">"fp16"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">do_simple_run</span><span class="token punctuation">(</span>spconv<span class="token double-colon punctuation">::</span>Precision<span class="token double-colon punctuation">::</span>Float16<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">checkRuntime</span><span class="token punctuation">(</span><span class="token function">cudaStreamDestroy</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>å½“æˆ‘ä»¬æ‰§è¡Œ <strong>make fp16 -j</strong> ç¼–è¯‘è¿è¡Œæ—¶ï¼Œä»£ç é¦–å…ˆä¼šè°ƒç”¨ <strong>do_memory_usage_test</strong> å‡½æ•°æ¥æµ‹è¯•ç¨€ç–å·ç§¯æ“ä½œçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œæ¥ç€æˆ‘ä»¬ä¼šè°ƒç”¨ <strong>do_simple_run</strong> å‡½æ•°æ¥æ‰§è¡Œç¨€ç–å·ç§¯ï¼Œæˆ‘ä»¬é‡ç‚¹æ¥çœ‹ä¸‹ <strong>do_simple_run</strong> è¿™ä¸ªå‡½æ•°çœ‹å®ƒå†…éƒ¨çš„ç¨€ç–å·ç§¯æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼Œå…¶ä»£ç å®ç°å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">do_simple_run</span><span class="token punctuation">(</span>spconv<span class="token double-colon punctuation">::</span>Precision precision<span class="token punctuation">,</span> cudaStream_t stream<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  spconv<span class="token double-colon punctuation">::</span><span class="token function">set_verbose</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> task <span class="token operator">=</span> <span class="token function">load_task</span><span class="token punctuation">(</span><span class="token string">"centerpointZYX"</span><span class="token punctuation">,</span> precision<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// auto task = load_task("bevfusionZYX", precision);</span>
  <span class="token comment">// auto task = load_task("bevfusionXYZ", precision);</span>

  task<span class="token punctuation">.</span>engine<span class="token operator">-&gt;</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">set_data</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>features<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> spconv<span class="token double-colon punctuation">::</span>DataType<span class="token double-colon punctuation">::</span>Float16<span class="token punctuation">,</span> task<span class="token punctuation">.</span>features<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        task<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> spconv<span class="token double-colon punctuation">::</span>DataType<span class="token double-colon punctuation">::</span>Int32<span class="token punctuation">,</span> task<span class="token punctuation">.</span>indices<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        task<span class="token punctuation">.</span>grid_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  task<span class="token punctuation">.</span>engine<span class="token operator">-&gt;</span><span class="token function">forward</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> out_features <span class="token operator">=</span> task<span class="token punctuation">.</span>engine<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">features</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> grid_size <span class="token operator">=</span> task<span class="token punctuation">.</span>engine<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">grid_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ğŸ™Œ Output.shape: %s\n"</span><span class="token punctuation">,</span> spconv<span class="token double-colon punctuation">::</span><span class="token function">format_shape</span><span class="token punctuation">(</span>out_features<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  out_features<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>save_dense<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  task<span class="token punctuation">.</span>engine<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">print_done</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>compare_cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>é¦–å…ˆæˆ‘ä»¬å…ˆåšäº†ä¸€ä¸ª load_task åŠ è½½äº†ä¸€ä¸ª centerpointZYX çš„ä»»åŠ¡ï¼Œload_task çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-cpp">Task <span class="token function">load_task</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> spconv<span class="token double-colon punctuation">::</span>Precision precision<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  Task task<span class="token punctuation">;</span>
  task<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">"bevfusionXYZ"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    task<span class="token punctuation">.</span>engine <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token function">load_engine_from_onnx</span><span class="token punctuation">(</span><span class="token string">"bevfusion/bevfusion.scn.xyz.onnx"</span><span class="token punctuation">,</span> precision<span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>features <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token class-name">Tensor</span><span class="token double-colon punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"bevfusion/infer.xyz.voxels"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>indices <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token class-name">Tensor</span><span class="token double-colon punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"bevfusion/infer.xyz.coors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>grid_size <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1440</span><span class="token punctuation">,</span> <span class="token number">1440</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>order <span class="token operator">=</span> IndiceOrder<span class="token double-colon punctuation">::</span>XYZ<span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>save_dense <span class="token operator">=</span> <span class="token string">"bevfusion/output.xyz.dense"</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>compare_cmd <span class="token operator">=</span>
        <span class="token string">"python tool/compare.py workspace/bevfusion/infer.xyz.dense "</span>
        <span class="token string">"workspace/bevfusion/output.xyz.dense --detail"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">"bevfusionZYX"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    task<span class="token punctuation">.</span>engine <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token function">load_engine_from_onnx</span><span class="token punctuation">(</span><span class="token string">"bevfusion/bevfusion.scn.zyx.onnx"</span><span class="token punctuation">,</span> precision<span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>features <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token class-name">Tensor</span><span class="token double-colon punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"bevfusion/infer.zyx.voxels"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>indices <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token class-name">Tensor</span><span class="token double-colon punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"bevfusion/infer.zyx.coors"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>grid_size <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">1440</span><span class="token punctuation">,</span> <span class="token number">1440</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>order <span class="token operator">=</span> IndiceOrder<span class="token double-colon punctuation">::</span>ZYX<span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>save_dense <span class="token operator">=</span> <span class="token string">"bevfusion/output.zyx.dense"</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>compare_cmd <span class="token operator">=</span>
        <span class="token string">"python tool/compare.py workspace/bevfusion/infer.zyx.dense "</span>
        <span class="token string">"workspace/bevfusion/output.zyx.dense --detail"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token string">"centerpointZYX"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    task<span class="token punctuation">.</span>engine <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token function">load_engine_from_onnx</span><span class="token punctuation">(</span><span class="token string">"centerpoint/centerpoint.scn.PTQ.onnx"</span><span class="token punctuation">,</span> precision<span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>features <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token class-name">Tensor</span><span class="token double-colon punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"centerpoint/in_features.torch.fp16.tensor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>indices <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token class-name">Tensor</span><span class="token double-colon punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"centerpoint/in_indices_zyx.torch.int32.tensor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>grid_size <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">1440</span><span class="token punctuation">,</span> <span class="token number">1440</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>order <span class="token operator">=</span> IndiceOrder<span class="token double-colon punctuation">::</span>ZYX<span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>save_dense <span class="token operator">=</span> <span class="token string">"centerpoint/output.zyx.dense"</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span>compare_cmd <span class="token operator">=</span>
        <span class="token string">"python tool/compare.py workspace/centerpoint/out_dense.torch.fp16.tensor "</span>
        <span class="token string">"workspace/centerpoint/output.zyx.dense "</span>
        <span class="token string">"--detail"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">Assertf</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"Unsupport task name: %s"</span><span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> task<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ç”±äºæˆ‘ä»¬ name ç­‰äº centerpointZYXï¼Œå› æ­¤è¿™é‡Œç”¨å®ƒåšäº†ä¸€ç³»åˆ—åˆå§‹åŒ–ï¼Œå…ˆé€šè¿‡è¯»å– onnx åˆ›å»ºäº†ä¸€ä¸ª engineï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒå…·ä½“æ˜¯æ€ä¹ˆåˆ›å»ºçš„ï¼Œä¹Ÿå°±æ˜¯ <strong>load_engine_from_onnx</strong> å…·ä½“æ˜¯æ€ä¹ˆåšçš„ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-cpp">std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Engine<span class="token operator">&gt;</span> <span class="token function">load_engine_from_onnx</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> onnx_file<span class="token punctuation">,</span> Precision precision<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> stream<span class="token punctuation">,</span> <span class="token keyword">bool</span> mark_all_output<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    onnx<span class="token double-colon punctuation">::</span>ModelProto model<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>fstream <span class="token function">fin</span><span class="token punctuation">(</span>onnx_file<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>binary <span class="token operator">|</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>model<span class="token punctuation">.</span><span class="token function">ParseFromIstream</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOGV</span><span class="token punctuation">(</span><span class="token string">"Parse onnx failed: %s"</span><span class="token punctuation">,</span> onnx_file<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> builder <span class="token operator">=</span> spconv<span class="token double-colon punctuation">::</span><span class="token function">create_engine_builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> graph <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">,</span> spconv<span class="token double-colon punctuation">::</span>ITensor<span class="token operator">*</span><span class="token operator">&gt;</span> tensor_map_by_name<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> graph<span class="token punctuation">.</span><span class="token function">input_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> name <span class="token operator">=</span> graph<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tensor_map_by_name<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_input</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>spconv<span class="token double-colon punctuation">::</span>ITensor<span class="token operator">*</span><span class="token operator">&gt;</span> collect_outputs<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> model<span class="token punctuation">.</span><span class="token function">graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">node_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span><span class="token operator">&amp;</span> node <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">graph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">node</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"SparseConvolution"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token keyword">auto</span> x <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> weight <span class="token operator">=</span> <span class="token function">get_initializer_data</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> bias   <span class="token operator">=</span> <span class="token function">get_initializer_data</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> weight_dynamic_ranges_proto <span class="token operator">=</span> <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"weight_dynamic_ranges"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> weight_dynamic_ranges <span class="token operator">=</span> 
                std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">vector</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>weight_dynamic_ranges_proto<span class="token punctuation">.</span><span class="token function">floats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> weight_dynamic_ranges_proto<span class="token punctuation">.</span><span class="token function">floats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">auto</span> n <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_sparse_conv</span><span class="token punctuation">(</span>
                node<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> 
                weight<span class="token punctuation">.</span>data<span class="token punctuation">,</span> weight<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>
                weight_dynamic_ranges<span class="token punctuation">,</span>
                bias<span class="token punctuation">.</span>data<span class="token punctuation">,</span> bias<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"activation"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute_as_intarray</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"kernel_size"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute_as_intarray</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"stride"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute_as_intarray</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"padding"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute_as_intarray</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"dilation"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"input_dynamic_range"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"subm"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"output_bound"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"rulebook"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"precision"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"int8"</span> <span class="token operator">?</span> Precision<span class="token double-colon punctuation">::</span>Int8 <span class="token operator">:</span> Precision<span class="token double-colon punctuation">::</span>Float16<span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"output_precision"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"int8"</span> <span class="token operator">?</span> Precision<span class="token double-colon punctuation">::</span>Int8 <span class="token operator">:</span> Precision<span class="token double-colon punctuation">::</span>Float16<span class="token punctuation">,</span>
                node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>mark_all_output<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                collect_outputs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Add"</span> <span class="token operator">||</span> node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"QuantAdd"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> a <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> b <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">auto</span> n <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_add</span><span class="token punctuation">(</span>
                node<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> 
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"input0_dynamic_range"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"input1_dynamic_range"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"precision"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"int8"</span> <span class="token operator">?</span> Precision<span class="token double-colon punctuation">::</span>Int8 <span class="token operator">:</span> Precision<span class="token double-colon punctuation">::</span>Float16<span class="token punctuation">,</span>
                <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"output_precision"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"int8"</span> <span class="token operator">?</span> Precision<span class="token double-colon punctuation">::</span>Int8 <span class="token operator">:</span> Precision<span class="token double-colon punctuation">::</span>Float16
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Relu"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> x <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> n <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_relu</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"ScatterDense"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> x <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> input_spatial_shape <span class="token operator">=</span> <span class="token function">get_attribute_as_intarray</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"input_spatial_shape"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> output_shape <span class="token operator">=</span> <span class="token function">get_attribute_as_intarray</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"output_shape"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> format <span class="token operator">=</span> <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"format"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> n <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_dense</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> format<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> input_spatial_shape<span class="token punctuation">,</span> output_shape<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Reshape"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> x <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> dims <span class="token operator">=</span> <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"dims"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> <span class="token function">shape</span><span class="token punctuation">(</span>dims<span class="token punctuation">.</span><span class="token function">ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dims<span class="token punctuation">.</span><span class="token function">ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> n <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_reshape</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"Transpose"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> x <span class="token operator">=</span> tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> dims <span class="token operator">=</span> <span class="token function">get_attribute</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"dims"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span> <span class="token function">shape</span><span class="token punctuation">(</span>dims<span class="token punctuation">.</span><span class="token function">ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dims<span class="token punctuation">.</span><span class="token function">ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> n <span class="token operator">=</span> builder<span class="token operator">-&gt;</span><span class="token function">push_transpose</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tensor_map_by_name<span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Unsupport operator [%s]\b"</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">op_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> graph<span class="token punctuation">.</span><span class="token function">output_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> name <span class="token operator">=</span> graph<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        collect_outputs<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>tensor_map_by_name<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> collect_outputs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        builder<span class="token operator">-&gt;</span><span class="token function">push_output</span><span class="token punctuation">(</span>collect_outputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> builder<span class="token operator">-&gt;</span><span class="token function">build</span><span class="token punctuation">(</span>precision<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>æˆ‘ä»¬ä»åå­—ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯è¯»å–ä¸€ä¸ª onnx ç”Ÿæˆä¸€ä¸ª engineï¼Œä»ä»£ç ä¸­èƒ½çœ‹å‡ºå…ˆåˆ©ç”¨ protobuf çš„æ¥å£å‡½æ•°å…ˆè§£æ onnx æ–‡ä»¶ï¼Œæ¥ç€åˆ›å»ºäº†ä¸€ä¸ª builderï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ª builder æ˜¯ä¸€ä¸ªä»€ä¹ˆç±»ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">EngineBuilder</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
  Exported <span class="token keyword">virtual</span> ITensor<span class="token operator">*</span> <span class="token function">push_input</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  Exported <span class="token keyword">virtual</span> INode<span class="token operator">*</span> <span class="token function">push_add</span><span class="token punctuation">(</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> 
      ITensor<span class="token operator">*</span> a<span class="token punctuation">,</span> 
      ITensor<span class="token operator">*</span> b<span class="token punctuation">,</span>
      <span class="token keyword">float</span> a_dynamic_range<span class="token punctuation">,</span>
      <span class="token keyword">float</span> b_dynamic_range<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> output_name<span class="token punctuation">,</span>
      Precision precision<span class="token punctuation">,</span> Precision output_precision<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  Exported <span class="token keyword">virtual</span> INode<span class="token operator">*</span> <span class="token function">push_relu</span><span class="token punctuation">(</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> 
      ITensor<span class="token operator">*</span> x<span class="token punctuation">,</span> 
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> output_name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  Exported <span class="token keyword">virtual</span> INode<span class="token operator">*</span> <span class="token function">push_dense</span><span class="token punctuation">(</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> ITensor<span class="token operator">*</span> x<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> format<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> output_name<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> input_spatial_shape<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> output_shape<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  Exported <span class="token keyword">virtual</span> INode<span class="token operator">*</span> <span class="token function">push_reshape</span><span class="token punctuation">(</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> ITensor<span class="token operator">*</span> x<span class="token punctuation">,</span> 
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> shape<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> output_name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  Exported <span class="token keyword">virtual</span> INode<span class="token operator">*</span> <span class="token function">push_transpose</span><span class="token punctuation">(</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> ITensor<span class="token operator">*</span> x<span class="token punctuation">,</span> 
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int64_t</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> dims<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> output_name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  Exported <span class="token keyword">virtual</span> INode<span class="token operator">*</span> <span class="token function">push_sparse_conv</span><span class="token punctuation">(</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> name<span class="token punctuation">,</span> 
      ITensor<span class="token operator">*</span> x<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> weight<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> weight_shape<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> weight_dynamic_ranges<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> bias<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> bias_shape<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> activation<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> kernel_size<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> stride<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> padding<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> dilation<span class="token punctuation">,</span>
      <span class="token keyword">float</span> input_dynamic_range<span class="token punctuation">,</span>
      <span class="token keyword">bool</span> submanifold<span class="token punctuation">,</span>
      <span class="token keyword">int</span> max_output_points<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> rulebook<span class="token punctuation">,</span>
      Precision precision<span class="token punctuation">,</span>
      Precision output_precision<span class="token punctuation">,</span>
      <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> output_name<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  Exported <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">push_output</span><span class="token punctuation">(</span>ITensor<span class="token operator">*</span> value<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// build engine</span>
  Exported <span class="token keyword">virtual</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Engine<span class="token operator">&gt;</span> <span class="token function">build</span><span class="token punctuation">(</span>Precision precision<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> stream <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * To build a engine.
*/</span>
Exported std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>EngineBuilder<span class="token operator">&gt;</span> <span class="token function">create_engine_builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° builder æ˜¯ä¸€ä¸ª EngineBuilder ç±»ï¼Œé‚£è¿™ä¸ªåå­—å…¶å®å’Œ TensorRT é‡Œé¢çš„ IBuilder æ¯”è¾ƒåƒï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªå¹¶ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼ŒIBuilder æ˜¯ TensorRT çš„æ¦‚å¿µï¼Œè¿™ä¸ª EngineBuilder æ˜¯ NVIDIA å®˜æ–¹è‡ªå·±é‡æ–°å†™çš„ä¸€ä¸ª builderï¼Œå®ƒæ²¡æœ‰é›†æˆä»»ä½•ä¸œè¥¿æ˜¯å®˜æ–¹è‡ªå·±æ„å»ºçš„ä¸€ä¸ª builderï¼Œé‚£æ—¢ç„¶æ˜¯ builder æˆ‘ä»¬å°±çŸ¥é“å®ƒè‚¯å®šæ˜¯ç”¨äºæ¥åˆ›å»º engine çš„</p> 
<p>OKï¼Œæˆ‘ä»¬å†å›åˆ° <strong>load_engine_from_onnx</strong> å‡½æ•°ä¸­ï¼Œåˆ›å»ºå®Œ builder ä¹‹åæˆ‘ä»¬å†æ‹¿åˆ°æ¨¡å‹çš„ graph å›¾ç»“æ„ï¼Œç„¶åæˆ‘ä»¬ä¼šéå† graph ä¸­çš„æ‰€æœ‰ nodeï¼Œé’ˆå¯¹ä¸åŒçš„ node è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œé‚£è¿™äº› node åŒ…æ‹¬ SparseConvolution ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„ç¨€ç–å·ç§¯ï¼Œè¿˜æœ‰ Addã€QuantAddã€Reluã€ScatterDense ç­‰ç­‰ï¼Œ</p> 
<p>å¦‚æœ Node èŠ‚ç‚¹æ˜¯ SparseConvolution ç¨€ç–å·ç§¯ï¼Œæˆ‘ä»¬ä¼šå…ˆé€šè¿‡ get_initializer_data å‡½æ•°æ‹¿åˆ°å®ƒçš„ weights å’Œ bias æ•°æ®ï¼Œæ¥ç€é€šè¿‡ push_sparse_conv å‡½æ•°æŠŠç¨€ç–å·ç§¯çš„æƒé‡å’Œåç½®æ•°æ®ï¼Œå¯¹åº”çš„å±æ€§ç­‰ç­‰æ·»åŠ åˆ° builder ä¸­ï¼Œé‚£å…·ä½“çš„ push_sparse_conv å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„å…¶å®æˆ‘ä»¬å¹¶ä¸çŸ¥é“ï¼Œå®˜æ–¹åªæä¾›äº†ä¸€ä¸ª engine.hpp æ¥å£æ–‡ä»¶ï¼Œé‚£æ€ä¹ˆå®ç°çš„é‡Œé¢çš„ engine.cpp æˆ–è€… engine.cu å®ƒå…¶å®å¹¶æ²¡æœ‰å¼€æº</p> 
<p>å…¶å®æˆ‘ä»¬åªè¦çŸ¥é“æ¥å£å°±çŸ¥é“æ€ä¹ˆç”¨äº†ï¼Œé‚£é€šè¿‡åå­—ä¹ŸçŸ¥é“ push_sparse_conv ä¹Ÿå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ª spconv çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¾€è¿™ä¸ªèŠ‚ç‚¹é‡Œé¢æ”¾å¾ˆå¤šä¿¡æ¯ï¼Œæ¯”å¦‚åå­—ã€æƒé‡ã€åŠ¨æ€èŒƒå›´ç­‰ç­‰å„ç§å±æ€§ï¼Œé‚£è¿™æ ·å°±æŠŠ spconv çš„ä¸€ä¸ªèŠ‚ç‚¹åˆ›å»ºäº†ï¼Œé‚£å¯¹äº onnx ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹æˆ‘ä»¬éƒ½å¯ä»¥å…ˆä» onnx ä¸­ parse ä¿¡æ¯ï¼Œä¹‹åæŠŠä¿¡æ¯ push åˆ° builder ä¸­å»ï¼Œé€šè¿‡ builder åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£å°±æ˜¯è¿™ä¹ˆä¸€ä¸ªæµç¨‹ï¼Œåé¢çš„ addã€reluã€reshape ç­‰èŠ‚ç‚¹éƒ½å¯ä»¥è¿™ä¹ˆåš</p> 
<p>æ‰€ä»¥ <strong>load_engine_from_onnx</strong> å‡½æ•°æ‰§è¡Œå®Œä¹‹åæˆ‘ä»¬å…¶å®å°±å¾—åˆ°äº†å¯¹åº” onnx çš„ engine æ¨ç†å¼•æ“äº†ï¼Œé‚£å€¼å¾—æ³¨æ„çš„æ˜¯è¿™ä¸ª engine å¼•æ“å®ƒè·Ÿ TensorRT çš„ engine è¿˜ä¸ä¸€æ ·ï¼Œè¿™æ˜¯å®ƒè‡ªå·±å†™çš„ä¸€ä¸ª engine</p> 
<p>OKï¼Œæˆ‘ä»¬å†å›åˆ° <strong>load_task</strong> å‡½æ•°ä¸­ï¼ŒåŠ è½½å®Œ engine ä¹‹åï¼Œæˆ‘ä»¬ä¼š load ä¸¤ä¸ª Tensor ä¸€ä¸ªæ˜¯ feature ä¹Ÿå°±æ˜¯è¾“å…¥åˆ°ç½‘ç»œä¸­çš„ 3D ç‚¹äº‘ç‰¹å¾ï¼Œä¸€ä¸ªæ˜¯ indices ä¹Ÿå°±æ˜¯è¾“å…¥åˆ°ç½‘ç»œä¸­çš„ 3D ç‚¹äº‘çš„ä½ç½®ç´¢å¼•ï¼Œå…¶å®ä¹Ÿå°±æ˜¯åŠ è½½äº† SCN ç½‘ç»œå‰å‘æ¨ç†éœ€è¦çš„ä¸¤ä¸ªè¾“å…¥ Tensorï¼Œæ¥ç€è®¾ç½®äº†ä¸€äº› grid_sizeã€order ç­‰å‚æ•°</p> 
<p>OKï¼Œæˆ‘ä»¬å†å›åˆ° <strong>do_simple_run</strong> å‡½æ•°ä¸­ï¼Œé€šè¿‡ load_task åŠ è½½äº† engine ä¹‹åæˆ‘ä»¬é€šè¿‡ set_data è®¾ç½®äº†è¾“å…¥çš„æ•°æ®ï¼Œæ¥ç€è°ƒç”¨ forward è¿›è¡Œäº†å‰å‘ä¼ æ’­ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<pre><code class="prism language-cpp"><span class="token comment">/**
  Engine types for sparse convolution
**/</span>
<span class="token keyword">class</span> <span class="token class-name">Engine</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token comment">/**
    Inference function for sparse convolution

    features_shape: The shape of the input feature matrix, it must be two elements.
    features_dtype: The data type of the input feature matrix, it must be Float16 now.
    features_data:  The data pointer of the input feature matrix
    indices_shape:  The shape of the input indices matrix, it must be two elements[n, 4]
    indices_dtype:  The data type of the input indices matrix, it must be Int32 now.
    indices_data:   The data pointer of the input indices matrix
    batch:          The batch size of the input, it must be 1 now.
    grid_size:      The grid size of the input data, For example: 41,1440,1440 or 1440,1440,41
    stream:         Which stream is expected to enqueue the inference.
  **/</span>
  Exported <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">forward</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> stream <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  Exported <span class="token keyword">virtual</span> size_t <span class="token function">num_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  Exported <span class="token keyword">virtual</span> SparseDTensor<span class="token operator">*</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  Exported <span class="token keyword">virtual</span> size_t <span class="token function">num_output</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  Exported <span class="token keyword">virtual</span> SparseDTensor<span class="token operator">*</span> <span class="token function">output</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>é‚£ forward éƒ¨åˆ†ä¹Ÿæ˜¯æ²¡æœ‰å¼€æºçš„ï¼Œæˆ‘ä»¬åªçŸ¥é“å®ƒæœ‰è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“ forward é‡Œé¢å…·ä½“å¹²äº†ä»€ä¹ˆï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çŒœä¸€ä¸‹ï¼Œå®ƒé‡Œé¢çš„ forward å¯èƒ½è·Ÿ TensorRT é‡Œé¢çš„ forward æ¯”è¾ƒåƒï¼Œåªæ˜¯è¿™é‡Œçš„ forward æ˜¯æ ¹æ®å®ƒè‡ªå·±åˆ›å»ºçš„èŠ‚ç‚¹ä¸€ä¸ªä¸€ä¸ªè®¡ç®—çš„ï¼Œé‡Œé¢å¯èƒ½ä¼šæ¶‰åŠåˆ°ä¸€äº› CUDA åŠ é€Ÿè®¡ç®—ï¼Œé‚£æˆ‘ä»¬è¿™é‡Œå°±è·Ÿè¸ªä¸äº†</p> 
<p>OKï¼Œforward åšå®Œä¹‹åæˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ª 1x256x180x180 çš„è¾“å‡ºæ•°æ®ï¼Œé‚£æ‹¿åˆ°å®ƒä¹‹åæ•´ä¸ªå‰å‘æ¨ç†ä¹Ÿå°±ç»“æŸäº†ï¼Œæ¥ç€æŠŠè¾“å‡ºçš„ 1x256x180x180 çš„ features ä¿æŒä¸‹æ¥ï¼Œç„¶åå†åšä¸€ä¸ª resetï¼Œæ•´ä¸ªæµç¨‹å°±æ˜¯è¿™æ ·å­</p> 
<p>é‚£æˆ‘ä»¬å’Œå¤§å®¶ä¸€èµ·ç®€å•çš„è¿‡äº†ä¸€éæ•´ä½“æµç¨‹ï¼Œé‚£å¦‚æœè¯´ä¸‹æ¬¡æˆ‘ä»¬è¦ä½¿ç”¨å®ƒæä¾›çš„è¿™äº›æ¥å£çš„æ—¶å€™ï¼Œå…¶å®è¿™ä¹ˆåˆ†æå°±å¥½äº†ï¼Œè¿™ä¸ªæ˜¯ C++ éƒ¨åˆ†çš„æ¨ç†ä»£ç çš„ä¸€ä¸ªè§£æ</p> 
<p>æˆ‘ä»¬æœ€åæ¥çœ‹ä¸€ä¸‹ç²¾åº¦æ¯”è¾ƒï¼ŒæŒ‡ä»¤å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-shell">$ python tool/compare.py workspace/centerpoint/out_dense.torch.fp16.tensor workspace/centerpoint/output.zyx.dense <span class="token parameter variable">--detail</span>
</code></pre> 
<p>è¾“å‡ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/43/16/8jGqPWTS_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>é‚£å®ƒä¼šå¯¹æ¯” C++ å’Œ Pytorch çš„æ¨ç†ç»“æœï¼Œå°†ä¸¤ä¸ª tensor è¿›è¡Œæ¯”è¾ƒè®¡ç®—äºŒè€…çš„å·®å¼‚ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤§éƒ¨åˆ†æ•°æ®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿæœ‰å°‘éƒ¨åˆ†æ•°æ®å­˜åœ¨å·®å¼‚ï¼Œä½†æ˜¯éƒ½åœ¨è¯¯å·®èŒƒå›´ä¹‹å†…ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥å¿½ç•¥çš„</p> 
<h3><a id="2_onnx_398"></a>2. å¯¼å‡ºonnx</h3> 
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸»è¦çœ‹è¿™ä¸ª onnx æ˜¯æ€ä¹ˆå¯¼å‡ºçš„ï¼ŒNVIDIA å®˜æ–¹å…¶å®å¼€æºäº†ç›¸å…³çš„å¯¼å‡ºä»£ç ï¼Œå…·ä½“æ˜¯åœ¨ <a href="https://github.com/NVIDIA-AI-IOT/Lidar_AI_Solution/tree/master/libraries/3DSparseConvolution/tool/centerpoint-export">3DSparseConvolution/tool/centerpoint-export</a> æ–‡ä»¶å¤¹ä¸‹</p> 
<p>å…¶ä¸­ <strong>export_tool.py</strong> æ˜¯æ ¸å¿ƒæ–‡ä»¶ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹å…¶å…·ä½“çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">register_node</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">:</span>

    fnnames   <span class="token operator">=</span> fn<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>
    fn_module <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>fnnames<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fn_name   <span class="token operator">=</span> fnnames<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    oldfn <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>fn_module<span class="token punctuation">,</span> fn_name<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">make_hook</span><span class="token punctuation">(</span>bind_fn<span class="token punctuation">)</span><span class="token punctuation">:</span>

        ilayer <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">def</span> <span class="token function">internal_forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">global</span> enable_trace

            <span class="token keyword">if</span> <span class="token keyword">not</span> enable_trace<span class="token punctuation">:</span>
                <span class="token keyword">return</span> oldfn<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>

            <span class="token keyword">global</span> avoid_reuse_container
            <span class="token keyword">nonlocal</span> ilayer

            <span class="token comment"># Use the enable_trace flag to avoid internal trace calls</span>
            enable_trace <span class="token operator">=</span> <span class="token boolean">False</span>
            y <span class="token operator">=</span> oldfn<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
            bind_fn<span class="token punctuation">(</span>self<span class="token punctuation">,</span> ilayer<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
            enable_trace <span class="token operator">=</span> <span class="token boolean">True</span>

            avoid_reuse_container<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span> 
            ilayer <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">return</span> y

        <span class="token builtin">setattr</span><span class="token punctuation">(</span>fn_module<span class="token punctuation">,</span> fn_name<span class="token punctuation">,</span> internal_forward<span class="token punctuation">)</span>
    <span class="token keyword">return</span> make_hook

<span class="token decorator annotation punctuation">@register_node</span><span class="token punctuation">(</span><span class="token string">"spconv.conv.SparseConvolution.forward"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">symbolic_sparse_convolution</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ilayer<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    register_tensor<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; SparseConvolution</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">'subm'</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>subm <span class="token keyword">else</span> <span class="token string">'conv'</span><span class="token punctuation">}</span></span><span class="token string">] -&gt; Input </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, Output </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>transposed<span class="token punctuation">:</span>
        output_size <span class="token operator">=</span> spconv<span class="token punctuation">.</span>ops<span class="token punctuation">.</span>get_deconv_output_size<span class="token punctuation">(</span>
            x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> self<span class="token punctuation">.</span>padding<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dilation<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_padding
        <span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        output_size <span class="token operator">=</span> spconv<span class="token punctuation">.</span>ops<span class="token punctuation">.</span>get_conv_output_size<span class="token punctuation">(</span>
            x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> self<span class="token punctuation">.</span>padding<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dilation
        <span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>subm<span class="token punctuation">:</span>
        output_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    
    output_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>out_channels
    inputs <span class="token operator">=</span> <span class="token punctuation">[</span>
        get_tensor_id<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        append_initializer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"spconv</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">.weight"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>bias <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        inputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>append_initializer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"spconv</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">.bias"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
    act_type_name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>ReLU      <span class="token punctuation">:</span> <span class="token string">"ReLU"</span><span class="token punctuation">,</span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>None_     <span class="token punctuation">:</span> <span class="token string">"None"</span><span class="token punctuation">,</span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>Sigmoid   <span class="token punctuation">:</span> <span class="token string">"Sigmoid"</span><span class="token punctuation">,</span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>LeakyReLU <span class="token punctuation">:</span> <span class="token string">"LeakyReLU"</span>
    <span class="token punctuation">}</span>

    algo_name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        ConvAlgo<span class="token punctuation">.</span>MaskImplicitGemm      <span class="token punctuation">:</span> <span class="token string">"MaskImplicitGemm"</span><span class="token punctuation">,</span>
        ConvAlgo<span class="token punctuation">.</span>MaskSplitImplicitGemm <span class="token punctuation">:</span> <span class="token string">"MaskSplitImplicitGemm"</span><span class="token punctuation">,</span>
        ConvAlgo<span class="token punctuation">.</span>Native <span class="token punctuation">:</span> <span class="token string">"Native"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    output_bound <span class="token operator">=</span> <span class="token number">200000</span>
    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"output_bound"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        output_bound <span class="token operator">=</span> self<span class="token punctuation">.</span>output_bound

    nodes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
        helper<span class="token punctuation">.</span>make_node<span class="token punctuation">(</span>
            <span class="token string">"SparseConvolution"</span><span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> <span class="token punctuation">[</span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"conv</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> 
            ndim <span class="token operator">=</span> self<span class="token punctuation">.</span>ndim<span class="token punctuation">,</span>
            input_spatial_shape <span class="token operator">=</span> x<span class="token punctuation">.</span>spatial_shape<span class="token punctuation">,</span>
            output_spatial_shape <span class="token operator">=</span> y<span class="token punctuation">.</span>spatial_shape<span class="token punctuation">,</span>
            in_channels <span class="token operator">=</span> self<span class="token punctuation">.</span>in_channels<span class="token punctuation">,</span>
            out_channels <span class="token operator">=</span> self<span class="token punctuation">.</span>out_channels<span class="token punctuation">,</span>
            kernel_size <span class="token operator">=</span> self<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span>
            output_bound <span class="token operator">=</span> output_bound<span class="token punctuation">,</span>
            stride <span class="token operator">=</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span>
            dilation <span class="token operator">=</span> self<span class="token punctuation">.</span>dilation<span class="token punctuation">,</span>
            padding <span class="token operator">=</span> self<span class="token punctuation">.</span>padding<span class="token punctuation">,</span>
            transposed <span class="token operator">=</span> self<span class="token punctuation">.</span>transposed<span class="token punctuation">,</span>
            inverse <span class="token operator">=</span> self<span class="token punctuation">.</span>inverse<span class="token punctuation">,</span>
            output_padding <span class="token operator">=</span> self<span class="token punctuation">.</span>output_padding<span class="token punctuation">,</span>
            groups <span class="token operator">=</span> self<span class="token punctuation">.</span>groups<span class="token punctuation">,</span>
            subm <span class="token operator">=</span> self<span class="token punctuation">.</span>subm<span class="token punctuation">,</span>
            rulebook <span class="token operator">=</span> self<span class="token punctuation">.</span>indice_key<span class="token punctuation">,</span>
            activation <span class="token operator">=</span> act_type_name<span class="token punctuation">[</span>self<span class="token punctuation">.</span>act_type<span class="token punctuation">]</span><span class="token punctuation">,</span>
            input_shape  <span class="token operator">=</span> x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>
            output_shape <span class="token operator">=</span> y<span class="token punctuation">.</span>features<span class="token punctuation">.</span>shape
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
</code></pre> 
<p>å®ƒè¿™é‡Œå†™äº†ä¸€ä¸ª register_node çš„ hook å‡½æ•°ï¼Œä¹‹åå†™äº†ä¸€ä¸ª symbolic_sparse_convolution å°±æ˜¯å„ç§ symbolic ç¬¦å·å‡½æ•°ï¼Œå½“æˆ‘ä»¬ç¨‹åºåœ¨ forward æ—¶å€™ä¼šè¿›è¡Œé‡å®šä½</p> 
<p>æˆ‘ä»¬éƒ½çŸ¥é“è¦å°† pytorch æ¨¡å‹å¯¼å‡º onnx çš„è¯ï¼Œæˆ‘ä»¬æ˜¯éœ€è¦è®©è¿™ä¸ª pytorch æ¨¡å‹å®Œæ•´èµ°ä¸€é forward è¿‡ç¨‹çš„ï¼Œå› ä¸º forward çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬æ‰èƒ½ trace é‡Œé¢çš„å„ä¸ªèŠ‚ç‚¹ã€‚æˆ‘ä»¬çŸ¥é“å¦‚æœåš Sparse Convolution çš„ forward çš„æ—¶å€™ï¼Œå®ƒé‡Œé¢æœ‰å¾ˆå¤šä¸œè¥¿æˆ‘ä»¬æ˜¯ trace ä¸äº†çš„ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆåŠå‘¢ï¼Œæˆ‘ä»¬å¯ä»¥æˆªå–ï¼Œå¯ä»¥åšä¸€ä¸ª hookï¼Œå½“ trace åˆ° Sparse Convolution forward çš„æ—¶å€™æˆ‘ä»¬è®©å®ƒå»æ‰§è¡Œ symbolic_sparse_convolution å‡½æ•°é‡Œé¢çš„æ“ä½œ</p> 
<p>åœ¨å‡½æ•°é‡Œé¢æˆ‘ä»¬å¾—åˆ° output_sizeï¼Œå¾—åˆ° input æ•°æ®ï¼Œå†å¾—åˆ° activation æ•°æ®ï¼Œç„¶åè®©å®ƒå»è°ƒç”¨ helper.make_node å‡½æ•°åˆ›å»ºä¸€ä¸ª node èŠ‚ç‚¹ï¼Œé‚£æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™é‡Œé¢æœ‰å¾ˆå¤šå‚æ•°ï¼Œé‚£è¿™äº›å‚æ•°å…¶å®å°±æ˜¯ SparseConvolution å®ƒåœ¨ C++ é‡Œåšå‰å‘æ¨ç†çš„æ—¶å€™æ‰€éœ€è¦çš„æ•°æ®</p> 
<p>é‚£æˆ‘ä»¬æŠŠè¿™äº›å‚æ•°é€šè¿‡ make_node å½¢å¼ä¿å­˜ä¸‹æ¥ï¼Œä»¥ node çš„å½¢å¼ç»™å®ƒæ·»åŠ åˆ° onnx é‡Œé¢å»ï¼Œé‚£è¿™ä¸ªå°±æ˜¯ spconv é‡å®šä½çš„ forward çš„ä¸€ä¸ªå®ç°ï¼Œé‚£å®ƒå¯ä»¥é€šè¿‡è¿™ä¹ˆä¸€ä¸ª hook å‡½æ•°å®Œæˆè¿™ç‚¹</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@register_node</span><span class="token punctuation">(</span><span class="token string">"torch.nn.ReLU.forward"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">symbolic_relu</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ilayer<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    register_tensor<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; ReLU</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string"> -&gt; Input </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, Output </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    nodes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
        helper<span class="token punctuation">.</span>make_node<span class="token punctuation">(</span>
            <span class="token string">"Relu"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>get_tensor_id<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"relu</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@register_node</span><span class="token punctuation">(</span><span class="token string">"torch.Tensor.__add__"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">symbolic_add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> ilayer<span class="token punctuation">,</span> y<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    register_tensor<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; Add</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string"> -&gt; Input </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> + </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, Output </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    nodes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
        helper<span class="token punctuation">.</span>make_node<span class="token punctuation">(</span>
            <span class="token string">"Add"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>get_tensor_id<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> get_tensor_id<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"add</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
</code></pre> 
<p>åŒç†ï¼Œå¦‚æœè¯´ Sparse Convolution çš„ forward æˆ‘ä»¬å¯ä»¥æˆªå–ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å…¶å®ƒçš„èŠ‚ç‚¹æˆ‘ä»¬ä¹Ÿå¯ä»¥æˆªå–å‘¢ï¼Œé‚£æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒè¿˜æŠŠ relu çš„ forwad è¿›è¡Œäº†æˆªå–è®©å®ƒé‡å®šä½åˆ° symbolic_relu é‡Œé¢å»ï¼Œæ¥ç€ä¹Ÿæ˜¯é€šè¿‡ helper å»åˆ›å»ºäº†ä¸€ä¸ª nodeï¼Œé‚£åé¢çš„éƒ½æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥åˆ›å»ºçš„ä¸€ä¸ªè‡ªå®šä¹‰çš„èŠ‚ç‚¹</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">export_onnx</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> voxels<span class="token punctuation">,</span> coors<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> spatial_shape<span class="token punctuation">,</span> save_onnx<span class="token punctuation">,</span> save_tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">global</span> avoid_reuse_container<span class="token punctuation">,</span> tensor_map<span class="token punctuation">,</span> nodes<span class="token punctuation">,</span> initializers<span class="token punctuation">,</span> enable_trace
    avoid_reuse_container <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    tensor_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    initializers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Tracing model inference..."</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&gt; Do inference..."</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        register_tensor<span class="token punctuation">(</span>voxels<span class="token punctuation">)</span>
        enable_trace <span class="token operator">=</span> <span class="token boolean">True</span>
        y <span class="token operator">=</span> model<span class="token punctuation">(</span>voxels<span class="token punctuation">,</span> coors<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> spatial_shape<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        enable_trace <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token keyword">if</span> save_tensor <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"&gt; Do save tensor, The purpose of this operation is to verify the inference result of C++"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; Save inference input voxels to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.voxels, voxels.shape = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>voxels<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        funcs<span class="token punctuation">.</span>save_tensor<span class="token punctuation">(</span>voxels<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.voxels"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; Save inference input coors to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.coors, coors.shape = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>coors<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        funcs<span class="token punctuation">.</span>save_tensor<span class="token punctuation">(</span>coors<span class="token punctuation">,</span>  <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.coors"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; Save inference output to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.output, output.shape = </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>y<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        funcs<span class="token punctuation">.</span>save_tensor<span class="token punctuation">(</span>y<span class="token punctuation">,</span>      <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.output"</span></span><span class="token punctuation">)</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; Save spatial_shape is </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>spatial_shape<span class="token punctuation">}</span></span><span class="token string">, batch size is </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>batch_size<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; Save spatial_shape and batch size to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.info"</span></span><span class="token punctuation">)</span>
        funcs<span class="token punctuation">.</span>save_tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>batch_size<span class="token punctuation">]</span> <span class="token operator">+</span> spatial_shape<span class="token punctuation">,</span>      <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_tensor<span class="token punctuation">}</span></span><span class="token string">.info"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Tracing done!"</span><span class="token punctuation">)</span>

    inputs <span class="token operator">=</span> <span class="token punctuation">[</span>
        helper<span class="token punctuation">.</span>make_value_info<span class="token punctuation">(</span>
            name<span class="token operator">=</span><span class="token string">"0"</span><span class="token punctuation">,</span>
            type_proto<span class="token operator">=</span>helper<span class="token punctuation">.</span>make_tensor_type_proto<span class="token punctuation">(</span>
                elem_type<span class="token operator">=</span>helper<span class="token punctuation">.</span>TensorProto<span class="token punctuation">.</span>DataType<span class="token punctuation">.</span>FLOAT16<span class="token punctuation">,</span>
                shape<span class="token operator">=</span>voxels<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">]</span>

    outputs <span class="token operator">=</span> <span class="token punctuation">[</span>
        helper<span class="token punctuation">.</span>make_value_info<span class="token punctuation">(</span>
            name<span class="token operator">=</span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span>
            type_proto<span class="token operator">=</span>helper<span class="token punctuation">.</span>make_tensor_type_proto<span class="token punctuation">(</span>
                elem_type<span class="token operator">=</span>helper<span class="token punctuation">.</span>TensorProto<span class="token punctuation">.</span>DataType<span class="token punctuation">.</span>FLOAT16<span class="token punctuation">,</span>
                shape<span class="token operator">=</span>y<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">]</span>

    graph <span class="token operator">=</span> helper<span class="token punctuation">.</span>make_graph<span class="token punctuation">(</span>
        name<span class="token operator">=</span><span class="token string">"scn"</span><span class="token punctuation">,</span>
        inputs<span class="token operator">=</span>inputs<span class="token punctuation">,</span>
        outputs<span class="token operator">=</span>outputs<span class="token punctuation">,</span>
        nodes<span class="token operator">=</span>nodes<span class="token punctuation">,</span>
        initializer<span class="token operator">=</span>initializers
    <span class="token punctuation">)</span>

    opset <span class="token operator">=</span> <span class="token punctuation">[</span>
        helper<span class="token punctuation">.</span>make_operatorsetid<span class="token punctuation">(</span><span class="token string">"ai.onnx"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>

    model <span class="token operator">=</span> helper<span class="token punctuation">.</span>make_model<span class="token punctuation">(</span>graph<span class="token punctuation">,</span> opset_imports<span class="token operator">=</span>opset<span class="token punctuation">,</span> producer_name<span class="token operator">=</span><span class="token string">"pytorch"</span><span class="token punctuation">,</span> producer_version<span class="token operator">=</span><span class="token string">"1.9"</span><span class="token punctuation">)</span>
    onnx<span class="token punctuation">.</span>save_model<span class="token punctuation">(</span>model<span class="token punctuation">,</span> save_onnx<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"ğŸš€ The export is completed. ONNX save as </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>save_onnx<span class="token punctuation">}</span></span><span class="token string"> ğŸ¤—, Have a nice day~"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># clean memory</span>
    avoid_reuse_container <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    tensor_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    initializers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre> 
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ€åè¿™äº›æˆªå–åˆ°çš„èŠ‚ç‚¹éƒ½ç»™æ”¾åˆ°äº† nodes åˆ—è¡¨ä¸­ï¼Œåœ¨ export_onnx å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒé€šè¿‡ helper å»åˆ›å»ºäº†ä¸€ä¸ª input ä¸€ä¸ª output è¿˜åˆ›å»ºäº†ä¸€ä¸ª graphï¼Œæˆ‘ä»¬é€šè¿‡ graph ä¹‹åæŠŠè¾“å…¥è¾“å‡ºä»¥åŠæ•´ä¸ªç½‘ç»œä¸­æ‰€æ¶‰åŠåˆ°çš„æ‰€æœ‰èŠ‚ç‚¹æ”¾åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ª graphï¼Œä¹‹åæˆ‘ä»¬å†é€šè¿‡ graph åˆ›å»ºä¸€ä¸ª modelï¼Œé‚£æœ€ç»ˆé€šè¿‡ onnx çš„ save_model å°±å¯ä»¥æŠŠè¿™ä¸ª onnx æ¨¡å‹ç»™ä¿å­˜ä¸‹æ¥äº†</p> 
<p>OKï¼Œä»¥ä¸Šå°±æ˜¯å¸¦æœ‰ spconv çš„ SCN ç½‘ç»œå¯¼å‡ºçš„ä¸€ä¸ªæ–¹å¼ï¼Œè¿™é‡Œé¢çš„é‡ç‚¹ä¸»è¦æ˜¯ register_node è£…é¥°å™¨ä»¥åŠ make_hook é’©å­å‡½æ•°ï¼Œè¿™ç§è¯­æ³•å¤§å®¶å¯èƒ½å¹³æ—¶çœ‹åˆ°çš„å¹¶ä¸æ˜¯å¾ˆå¤šï¼Œé‚£è¿™ä¸ªéœ€è¦å¤§å®¶è‡ªå·±å¤šçœ‹å¤šç†è§£äº†ï¼Œå¦å¤–å…³äº Python è£…é¥°å™¨çš„å†…å®¹å¤§å®¶æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹ï¼š<a href="https://blog.csdn.net/qq_40672115/article/details/129914076">AutoCVç¬¬å››è¯¾ï¼šPythonåŸºç¡€</a></p> 
<p>è¿™ä¸ªå°±æ˜¯ trace spconv çš„ä¸€ä¸ªæ–¹å¼ï¼Œåˆ†æå®Œä»£ç ä¹‹åæˆ‘ä»¬ç°åœ¨æƒ³è¦å¯¼å‡ºå¯¹åº” SCN çš„ onnx è¯¥æ€ä¹ˆåŠå‘¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ NVIDIA å®˜æ–¹æä¾›çš„æ­¥éª¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p> 
<p><strong>1.</strong> ä» <a href="https://github.com/tianweiy/CenterPoint">https://github.com/tianweiy/CenterPoint</a> ä¸‹è½½å¹¶é…ç½® CenterPoint çš„ç¯å¢ƒ</p> 
<p><strong>2.</strong> ä½¿ç”¨å¦‚ä¸‹æŒ‡ä»¤å¯¼å‡º SCN ONNX</p> 
<pre><code class="prism language-shell">$ <span class="token function">cp</span> <span class="token parameter variable">-r</span> tool/centerpoint-export path/to/CenterPoint
$ <span class="token builtin class-name">cd</span> path/to/CenterPoint
$ python centerpoint-export/export-scn.py <span class="token parameter variable">--ckpt</span><span class="token operator">=</span>epoch_20.pth --save-onnx<span class="token operator">=</span>scn.nuscenes.onnx
$ <span class="token function">cp</span> scn.nuscenes.onnx path/to/3DSparseConvolution/workspace/
</code></pre> 
<p>é‚£æˆ‘ä»¬é¦–å…ˆéœ€è¦å»æ­å»º CenterPoint çš„ä¸€ä¸ªç¯å¢ƒï¼Œå¯ä»¥æŒ‰ç…§å®ƒçš„ <a href="https://github.com/tianweiy/CenterPoint/blob/master/docs/INSTALL.md">INSTALL</a> æ–‡ä»¶å»è¿›è¡Œé…ç½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/f7/b0/5mgnZydy_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒCenterPoint å®˜æ–¹æä¾›çš„ç¯å¢ƒé…ç½®å…¶å®æ˜¯ç”¨æ¥åšè®­ç»ƒç”¨çš„ï¼Œæ‰€ä»¥å®ƒè¿™ä¸ªç¯å¢ƒæ­å»ºèµ·æ¥ä¼šæ¯”è¾ƒå¤§ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œä¹Ÿä¼šæœ‰å¾ˆå¤šæ²¡å¿…è¦çš„ä¸œè¥¿ã€‚å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œæˆ‘ä»¬å…¶å®ä¸éœ€è¦åšè®­ç»ƒï¼Œæˆ‘ä»¬åªéœ€è¦å¯¼å‡º ONNX å°±å¥½äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦æŠŠè·Ÿ ONNX å¯¼å‡ºæœ‰å…³çš„åŒ…å®‰è£…ä¸‹å°±å¥½äº†</p> 
<p>å¦å¤–æˆ‘ä»¬å¯ä»¥çœ‹åˆ° CenterPoint å®˜æ–¹æ¨èå®‰è£…çš„è½¯ä»¶ç‰ˆæœ¬éƒ½å¤ªä½äº†ï¼Œé‚£ pytorch ç‰ˆæœ¬æ˜¯ 1.1.0 çš„ï¼Œcudatoolkit ç‰ˆæœ¬æ˜¯ 10.0 çš„ï¼Œç°åœ¨ cuda éƒ½æ˜¯ 12.0 çš„ï¼Œé‚£è¿™ä¸ªçœ‹èµ·æ¥å°±ä¸å¤ªå¥½ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Œé‚£è¿™é‡Œå¤§å®¶ä¸è¦æŒ‰ç…§å®˜æ–¹çš„æ­¥éª¤å»é…ç½®è¿™ä¸ªç¯å¢ƒï¼Œæˆ‘ä»¬è‡ªå·±æ¥é…ç½®ï¼Œé‚£ä¸‹é¢æ˜¯éŸ©è€å¸ˆé…ç½®çš„ä¸€ä¸ªèƒ½å¤Ÿå¯¼å‡º ONNX çš„æœ€å°ç¯å¢ƒé…ç½®ï¼ŒæŒ‡ä»¤å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-shell"><span class="token function">git</span> clone https://github.com/tianweiy/CenterPoint.git
<span class="token builtin class-name">cd</span> CenterPoint
conda create <span class="token parameter variable">--name</span> centerpoint <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.7</span>
conda activate centerpoint
conda <span class="token function">install</span> <span class="token assign-left variable">pytorch</span><span class="token operator">==</span><span class="token number">1.10</span>.1 <span class="token assign-left variable">torchvision</span><span class="token operator">==</span><span class="token number">0.11</span>.2 <span class="token assign-left variable">cudatoolkit</span><span class="token operator">=</span><span class="token number">11.3</span> <span class="token parameter variable">-c</span> pytorch
<span class="token builtin class-name">cd</span> det3d/ops/iou3d_nms
python setup.py build_ext <span class="token parameter variable">--inplace</span>
pip <span class="token function">install</span> numba spconv-cu113 terminaltables addict pyyaml pycocotools onnx 
</code></pre> 
<p>é‚£æˆ‘ä»¬å¤§å®¶æŒ‰ç…§éŸ©è€å¸ˆæä¾›çš„è¿™ä¸ªæ–¹å¼å»é…ç½®ä¸€ä¸‹ç¯å¢ƒå°±å¥½äº†ï¼Œå¤§å®¶ä¸è¦å»åš pip install -r requirement.txtï¼Œè¿™é‡Œé¢æœ‰å¤ªå¤šä¸œè¥¿æ²¡æœ‰å¿…è¦å®‰è£…ï¼Œæ¯”å¦‚è¯´ opencvã€matplotlib ç­‰ç­‰ï¼Œæ¯ä¸€ä¸ªéƒ½æœ‰å¥½å‡ ä¸ª Gï¼Œæˆ‘ä»¬æ²¡æœ‰å¿…è¦å»å®‰è£…å®ƒï¼Œæ‰€ä»¥å°±ç›´æ¥è·³è¿‡å°±å¥½äº†</p> 
<p>OKï¼Œæˆ‘ä»¬æŒ‰ç…§ä¸Šè¿°æ–¹å¼å°†ç¯å¢ƒé…ç½®å¥½ä¹‹åï¼Œå†çœ‹ NVIDIA å®˜æ–¹æä¾›çš„å¯¼å‡ºæŒ‡ä»¤ï¼Œå°† centerpoint-export æ–‡ä»¶å¤¹æ‹·è´åˆ° CenterPoint ä¸­ï¼Œç„¶åæ‰§è¡Œç›¸å…³ python æŒ‡ä»¤å¯¼å‡ºå³å¯ï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/a6/7c/ApB0vT4T_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° SCN çš„ ONNX æˆåŠŸå¯¼å‡ºäº†ï¼Œé‚£å®ƒæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/04/7d/Fs9ndfKS_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>ä»æ—¥å¿—ä¿¡æ¯å¯ä»¥çœ‹å‡ºå®ƒæŠŠ SCN é‡Œé¢çš„æ‰€æœ‰èŠ‚ç‚¹å…¨éƒ½åšäº†ä¸€ä¸ªé‡å®šä½ï¼Œå¯¼å‡ºå®Œä¹‹åçš„ onnx æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Netron å¯è§†åŒ–å·¥å…·æ‰“å¼€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> 
<p><img src="https://images2.imgbox.com/81/b0/7F0jkG57_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<p>ä¸Šé¢å°±æ˜¯åˆšåˆšå¯¼å‡ºçš„ ONNXï¼Œå®ƒçš„æ¶æ„å°±æ˜¯è¿™ä¸ªæ ·å­ï¼ŒSparseConvolution å°±æ˜¯æˆ‘ä»¬è¯´çš„ spconv èŠ‚ç‚¹ï¼Œå®ƒåŒ…å«çš„æ•°æ®ä¿¡æ¯æœ‰å¾ˆå¤šï¼Œé‚£æ¨ç†çš„æ—¶å€™æˆ‘ä»¬å°±åªè¦æŠŠè¿™äº›æ•°æ®ä¼ é€’ç»™ spconv æ¨ç†å¼•æ“çš„ builder å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„èŠ‚ç‚¹</p> 
<p>é‚£è¿™é‡Œç»™å¤§å®¶è®²è§£äº†å¯¼å‡º spconv çš„ä»£ç ï¼Œè®²è§£äº†é‡Œé¢çš„ register_node å’Œ hook å‡½æ•°æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œè¿™é‡Œé¢å¤§å®¶ä¸æ¸…æ¥šçš„å¯ä»¥å»çœ‹çœ‹è§†é¢‘</p> 
<p>OKï¼Œé‚£å¯¼å‡ºå¸¦æœ‰ spconv çš„ SCN ç½‘ç»œçš„ ONNX è¿™ä¸ªéƒ¨åˆ†åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå»ºè®®å¤§å®¶è‡ªå·±åŠ¨æ‰‹æŠŠè¿™ä¸ª onnx å¯¼å‡ºæ¥ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥çœ‹ä¸€çœ‹å®ƒçš„ C++ æ¨ç†æ¡†æ¶æ˜¯æ€ä¹ˆå†™çš„</p> 
<h3><a id="3__677"></a>3. è¡¥å……-è£…é¥°å™¨+é’©å­å‡½æ•°</h3> 
<blockquote> 
 <p>åšä¸»è¿™é‡Œç»“åˆ ChatGPT çš„åˆ†ææŠŠ spconv.forward å¦‚ä½•å®ç°é‡å®šä½çš„æµç¨‹å†ç®€å•è¿‡ä¸€é</p> 
</blockquote> 
<p>æˆ‘ä»¬è¦åˆ†æçš„ä»£ç å¦‚ä¸‹ï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">register_node</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">:</span>

    fnnames   <span class="token operator">=</span> fn<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>
    fn_module <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>fnnames<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fn_name   <span class="token operator">=</span> fnnames<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
    oldfn <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>fn_module<span class="token punctuation">,</span> fn_name<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">make_hook</span><span class="token punctuation">(</span>bind_fn<span class="token punctuation">)</span><span class="token punctuation">:</span>

        ilayer <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">def</span> <span class="token function">internal_forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">global</span> enable_trace

            <span class="token keyword">if</span> <span class="token keyword">not</span> enable_trace<span class="token punctuation">:</span>
                <span class="token keyword">return</span> oldfn<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>

            <span class="token keyword">global</span> avoid_reuse_container
            <span class="token keyword">nonlocal</span> ilayer

            <span class="token comment"># Use the enable_trace flag to avoid internal trace calls</span>
            enable_trace <span class="token operator">=</span> <span class="token boolean">False</span>
            y <span class="token operator">=</span> oldfn<span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
            bind_fn<span class="token punctuation">(</span>self<span class="token punctuation">,</span> ilayer<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
            enable_trace <span class="token operator">=</span> <span class="token boolean">True</span>

            avoid_reuse_container<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span> 
            
            ilayer <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">return</span> y

        <span class="token builtin">setattr</span><span class="token punctuation">(</span>fn_module<span class="token punctuation">,</span> fn_name<span class="token punctuation">,</span> internal_forward<span class="token punctuation">)</span>
    <span class="token keyword">return</span> make_hook

<span class="token decorator annotation punctuation">@register_node</span><span class="token punctuation">(</span><span class="token string">"spconv.conv.SparseConvolution.forward"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">symbolic_sparse_convolution</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ilayer<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    register_tensor<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   --&gt; SparseConvolution</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">[</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">'subm'</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>subm <span class="token keyword">else</span> <span class="token string">'conv'</span><span class="token punctuation">}</span></span><span class="token string">] -&gt; Input </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">, Output </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>transposed<span class="token punctuation">:</span>
        output_size <span class="token operator">=</span> spconv<span class="token punctuation">.</span>ops<span class="token punctuation">.</span>get_deconv_output_size<span class="token punctuation">(</span>
            x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> self<span class="token punctuation">.</span>padding<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dilation<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_padding
        <span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        output_size <span class="token operator">=</span> spconv<span class="token punctuation">.</span>ops<span class="token punctuation">.</span>get_conv_output_size<span class="token punctuation">(</span>
            x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> self<span class="token punctuation">.</span>padding<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dilation
        <span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>subm<span class="token punctuation">:</span>
        output_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    
    output_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>out_channels
    inputs <span class="token operator">=</span> <span class="token punctuation">[</span>
        get_tensor_id<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        append_initializer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"spconv</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">.weight"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>

    <span class="token keyword">if</span> self<span class="token punctuation">.</span>bias <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        inputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>append_initializer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"spconv</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">.bias"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
    act_type_name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>ReLU      <span class="token punctuation">:</span> <span class="token string">"ReLU"</span><span class="token punctuation">,</span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>None_     <span class="token punctuation">:</span> <span class="token string">"None"</span><span class="token punctuation">,</span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>Sigmoid   <span class="token punctuation">:</span> <span class="token string">"Sigmoid"</span><span class="token punctuation">,</span>
        tv<span class="token punctuation">.</span>gemm<span class="token punctuation">.</span>Activation<span class="token punctuation">.</span>LeakyReLU <span class="token punctuation">:</span> <span class="token string">"LeakyReLU"</span>
    <span class="token punctuation">}</span>

    algo_name <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        ConvAlgo<span class="token punctuation">.</span>MaskImplicitGemm      <span class="token punctuation">:</span> <span class="token string">"MaskImplicitGemm"</span><span class="token punctuation">,</span>
        ConvAlgo<span class="token punctuation">.</span>MaskSplitImplicitGemm <span class="token punctuation">:</span> <span class="token string">"MaskSplitImplicitGemm"</span><span class="token punctuation">,</span>
        ConvAlgo<span class="token punctuation">.</span>Native <span class="token punctuation">:</span> <span class="token string">"Native"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    output_bound <span class="token operator">=</span> <span class="token number">200000</span>
    <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"output_bound"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        output_bound <span class="token operator">=</span> self<span class="token punctuation">.</span>output_bound

    nodes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
        helper<span class="token punctuation">.</span>make_node<span class="token punctuation">(</span>
            <span class="token string">"SparseConvolution"</span><span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> <span class="token punctuation">[</span>get_tensor_id<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"conv</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ilayer<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> 
            ndim <span class="token operator">=</span> self<span class="token punctuation">.</span>ndim<span class="token punctuation">,</span>
            input_spatial_shape <span class="token operator">=</span> x<span class="token punctuation">.</span>spatial_shape<span class="token punctuation">,</span>
            output_spatial_shape <span class="token operator">=</span> y<span class="token punctuation">.</span>spatial_shape<span class="token punctuation">,</span>
            in_channels <span class="token operator">=</span> self<span class="token punctuation">.</span>in_channels<span class="token punctuation">,</span>
            out_channels <span class="token operator">=</span> self<span class="token punctuation">.</span>out_channels<span class="token punctuation">,</span>
            kernel_size <span class="token operator">=</span> self<span class="token punctuation">.</span>kernel_size<span class="token punctuation">,</span>
            output_bound <span class="token operator">=</span> output_bound<span class="token punctuation">,</span>
            stride <span class="token operator">=</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span>
            dilation <span class="token operator">=</span> self<span class="token punctuation">.</span>dilation<span class="token punctuation">,</span>
            padding <span class="token operator">=</span> self<span class="token punctuation">.</span>padding<span class="token punctuation">,</span>
            transposed <span class="token operator">=</span> self<span class="token punctuation">.</span>transposed<span class="token punctuation">,</span>
            inverse <span class="token operator">=</span> self<span class="token punctuation">.</span>inverse<span class="token punctuation">,</span>
            output_padding <span class="token operator">=</span> self<span class="token punctuation">.</span>output_padding<span class="token punctuation">,</span>
            groups <span class="token operator">=</span> self<span class="token punctuation">.</span>groups<span class="token punctuation">,</span>
            subm <span class="token operator">=</span> self<span class="token punctuation">.</span>subm<span class="token punctuation">,</span>
            rulebook <span class="token operator">=</span> self<span class="token punctuation">.</span>indice_key<span class="token punctuation">,</span>
            activation <span class="token operator">=</span> act_type_name<span class="token punctuation">[</span>self<span class="token punctuation">.</span>act_type<span class="token punctuation">]</span><span class="token punctuation">,</span>
            input_shape  <span class="token operator">=</span> x<span class="token punctuation">.</span>features<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>
            output_shape <span class="token operator">=</span> y<span class="token punctuation">.</span>features<span class="token punctuation">.</span>shape
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
</code></pre> 
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ @register_node æ˜¯ä¸€ä¸ªè£…é¥°å™¨ï¼Œè£…é¥°å™¨åœ¨ Python ä¸­æ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„åŠŸèƒ½ï¼Œå®ƒå…è®¸ä½ åœ¨ä¸ä¿®æ”¹åŸå§‹ä»£ç çš„æƒ…å†µä¸‹ï¼Œç»™å‡½æ•°å¢åŠ é¢å¤–çš„åŠŸèƒ½ã€‚<strong>è£…é¥°å™¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°å¹¶è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°</strong>ã€‚å½“çœ‹åˆ° <code>@</code> ç¬¦å·ç”¨åœ¨ä¸€ä¸ªå‡½æ•°å®šä¹‰ä¹‹å‰æ—¶ï¼Œå®ƒå®é™…ä¸Šæ˜¯åœ¨åº”ç”¨ä¸€ä¸ªè£…é¥°å™¨ã€‚</p> 
<p>ä¸‹é¢æˆ‘ä»¬è¯¦ç»†åˆ†æä¸€ä¸‹åœ¨æ‰§è¡Œ <strong>spconv.conv.SparseConvolution.forward</strong> æ–¹æ³•æ—¶ï¼Œä»£ç æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä¸»è¦æ˜¯æ¶‰åŠåˆ°è£…é¥°å™¨ <strong>register_node</strong> å’Œå‡½æ•° <strong>symbolic_sparse_convolution</strong> çš„ä½¿ç”¨</p> 
<p>æˆ‘ä»¬å…ˆæ¥è¿‡ä¸€ä¸‹è£…é¥°å™¨ <strong>register_node</strong> çš„å·¥ä½œåŸç†</p> 
<ul><li><strong>1. åˆå§‹åŒ–é˜¶æ®µ</strong> 
  <ul><li>å½“ export_tool.py è„šæœ¬è¿è¡Œæ—¶ï¼Œé¦–å…ˆä¼šå»æ‰§è¡Œ <strong>register_node(â€œspconv.conv.SparseConvolution.forwardâ€)</strong> è£…é¥°å™¨</li><li>è¿™ä¸ªå‚æ•°æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œä»£è¡¨è¦ä¿®æ”¹çš„å‡½æ•°çš„åç§°</li></ul> </li><li><strong>2. register_node åŠŸèƒ½</strong> 
  <ul><li>åœ¨ <strong>register_node</strong> å†…éƒ¨ï¼Œå®ƒé¦–å…ˆä¼šæ ¹æ®ä¼ å…¥çš„å­—ç¬¦ä¸²æ‰¾åˆ°ç›¸åº”çš„å‡½æ•°å¯¹è±¡</li><li>ç„¶åï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªåä¸º <strong>make_hook</strong> çš„å‡½æ•°</li></ul> </li><li><strong>3. åˆ›å»º mask_hook</strong> 
  <ul><li><strong>make_hook</strong> æ˜¯ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼Œå®ƒçš„ç›®çš„æ˜¯æ¥æ”¶ä¸€ä¸ªå‡½æ•°ï¼ˆè¿™é‡Œæ˜¯ <strong>symbolic_sparse_convolution</strong>ï¼‰å¹¶â€œé’©ä½â€ï¼ˆhookï¼‰åŸå§‹çš„ <strong>SparseConvolution.forward</strong> æ–¹æ³•</li></ul> </li></ul> 
<p>æ¥ç€æˆ‘ä»¬å†è¿‡ä¸€ä¸‹æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹</p> 
<ul><li><strong>1. åº”ç”¨è£…é¥°å™¨</strong> 
  <ul><li>å½“ <strong>@register_node(â€œspconv.conv.SparseConvolution.forwardâ€)</strong> åº”ç”¨äº <strong>symbolic_sparse_convolution</strong> å‡½æ•°æ—¶ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼Œå…¶ä½œç”¨ç­‰åŒäº <strong>symbolic_sparse_convolution = register_node(â€œspconv.conv.SparseConvolution.forwardâ€)(symbolic_sparse_convolution)</strong></li><li><strong>make_hook</strong> æ¥æ”¶ <strong>symbolic_sparse_convolution</strong> ä½œä¸ºå‚æ•°ï¼Œç„¶ååœ¨ <strong>SparseConvolution.forward</strong> ä¸Šè°ƒç”¨ <strong>internal_forward</strong> å‡½æ•°</li></ul> </li><li><strong>2. ä¿®æ”¹ SparseConvolution.forward</strong> 
  <ul><li><strong>internal_forward</strong> å‡½æ•°æ›¿æ¢äº†åŸå§‹çš„ <strong>SparseConvolution.forward</strong> æ–¹æ³•ï¼Œè¿™æ„å‘³ç€æ¯æ¬¡è°ƒç”¨ <strong>SparseConvolution.forward</strong> æ—¶ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨ <strong>internal_forward</strong></li></ul> </li><li><strong>3. æ‰§è¡Œ internal forward</strong> 
  <ul><li>å½“ <strong>SparseConvolution.forward</strong> è¢«è°ƒç”¨æ—¶ï¼Œ<strong>internal_forward</strong> è¢«æ‰§è¡Œ</li><li>åœ¨ <strong>inernal_forward</strong> å†…éƒ¨ï¼Œé¦–å…ˆä¼šè°ƒç”¨åŸå§‹çš„ <strong>SparseConvolution.forward</strong> æ–¹æ³•ï¼ˆé€šè¿‡ <strong>oldfn(self *args)</strong>ï¼‰ï¼Œç„¶åä¼šè°ƒç”¨ <strong>symbolic_sparse_convolution</strong> å‡½æ•°</li></ul> </li><li><strong>4. æ‰§è¡Œ symbolic_sparse_convolution</strong> 
  <ul><li><strong>symbolic_sparse_convolution</strong> å‡½æ•°åœ¨æ¯æ¬¡ <strong>SparseConvolution.forward</strong> è¢«è°ƒç”¨åæ‰§è¡Œï¼Œç”¨äºæ‰§è¡Œè¿½è¸ªé€»è¾‘ï¼Œå¦‚åˆ›å»º onnx å›¾ä¸­çš„èŠ‚ç‚¹</li></ul> </li></ul> 
<p>æ€»çš„æ¥è¯´ï¼Œå½“ <strong>spconv.conv.SparseConvolution.forward</strong> æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œç”±äºè£…é¥°å™¨ <strong>register_node</strong> çš„ä½œç”¨ï¼Œå®é™…ä¸Šæ˜¯å…ˆæ‰§è¡Œäº† <strong>internal_forward</strong> å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°é¦–å…ˆæ‰§è¡ŒåŸå§‹çš„ <strong>SparseConvolution.forward</strong> æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œ <strong>symbolic_sparse_convolution</strong> å‡½æ•°æ¥è¿›è¡Œè¿½è¸ªå’Œæ”¶é›†ä¿¡æ¯ã€‚è¿™ç§æœºåˆ¶å…è®¸åœ¨ä¸æ›´æ”¹åŸå§‹å‡½æ•°ä»£ç çš„å‰æä¸‹ï¼Œå¢åŠ é¢å¤–çš„åŠŸèƒ½ï¼Œè¿™åœ¨è®¸å¤šæƒ…å†µä¸‹éå¸¸æœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦è¿½è¸ªæˆ–è®°å½•å‡½æ•°è¡Œä¸ºçš„åœºæ™¯ä¸­ã€‚</p> 
<h3><a id="_816"></a>æ€»ç»“</h3> 
<blockquote> 
 <p>æœ¬æ¬¡è¯¾ç¨‹æˆ‘ä»¬å­¦ä¹ äº†å¯¼å‡ºå¸¦æœ‰ spconv çš„ SCN ç½‘ç»œçš„ onnxï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆå»çœ‹äº† spconv çš„ C++ æ¨ç†æ¡†æ¶ï¼Œç”±äºæ ¸å¿ƒéƒ¨åˆ†æœªå¼€æºæˆ‘ä»¬ä¹Ÿåªæ˜¯çŸ¥é“å®ƒçš„åŸºæœ¬æµç¨‹ï¼Œå®ƒä¸»è¦æ˜¯é€šè¿‡ protobuf çš„å‡½æ•°è§£æè¯»å–çš„ onnxï¼Œç„¶åå°†è§£æå‡ºæ¥çš„æ•°æ®é€šè¿‡ builder çš„ push_sparse_conv å‡½æ•°åˆ›å»º spconv çš„èŠ‚ç‚¹ï¼Œä¾æ­¤ç±»æ¨ï¼ŒSCN ä¸­æ‰€æœ‰èŠ‚ç‚¹å‡å¯é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œè¿™æ ·æ•´ä¸ª engine å°±æ„å»ºå¥½äº†ã€‚</p> 
 <p>æ¥ç€æˆ‘ä»¬å­¦ä¹ äº†å¯¼å‡º spconv çš„ onnxï¼Œä¸»è¦æ˜¯åˆ©ç”¨é’©å­å‡½æ•°å¯¹ spconv.forward è¿›è¡Œé‡å®šä½ï¼Œé‡å®šä½åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„å‡½æ•°ä¸­ï¼Œé€šè¿‡ helper.make_node åˆ›å»ºè‡ªå®šä¹‰çš„èŠ‚ç‚¹ï¼Œå°†æ¨ç†æ‰€éœ€è¦çš„ä¿¡æ¯å…¨éƒ¨éƒ½å¡«å……è¿›å»ã€‚è¿™æ ·æŠŠ SCN ä¸­æ‰€æœ‰è‡ªå®šä¹‰çš„èŠ‚ç‚¹æ”¾åˆ° graph ä¸­åˆ›å»ºä¸€ä¸ª model ä¿å­˜ä¸‹æ¥å³å¯</p> 
 <p>OKï¼Œä»¥ä¸Šå°±æ˜¯ç¬¬ 3 å°èŠ‚æœ‰å…³å¯¼å‡ºå¸¦æœ‰ spconv çš„ SCN ç½‘ç»œçš„ onnxçš„å…¨éƒ¨å†…å®¹äº†ï¼Œä¸‹èŠ‚æˆ‘ä»¬å°†å»å­¦ä¹  spconv çš„ä¼˜åŒ–æ–¹æ¡ˆâ€”Explicit GEMM Convï¼Œæ•¬è¯·æœŸå¾…ğŸ˜„</p> 
</blockquote> 
<h3><a id="_824"></a>ä¸‹è½½é“¾æ¥</h3> 
<ul><li><a href="https://pan.baidu.com/s/1QmH51czKVOyVDmD_m_n2CA" rel="nofollow">è®ºæ–‡ä¸‹è½½é“¾æ¥ã€æå–ç ï¼š6463ã€‘</a></li><li><a href="https://pan.baidu.com/s/1MS_A2-YRvFj1LsL85RuQiQ" rel="nofollow">æ•°æ®é›†ä¸‹è½½é“¾æ¥ã€æå–ç ï¼šdataã€‘</a></li><li><a href="https://pan.baidu.com/s/1BjaKZh7XuzBehMvvGKnglQ" rel="nofollow">ä»£ç å’Œå®‰è£…åŒ…ä¸‹è½½é“¾æ¥ã€æå–ç ï¼šcudaã€‘</a></li></ul> 
<h3><a id="_830"></a>å‚è€ƒ</h3> 
<ul><li><a href="https://blog.csdn.net/qq_40672115/article/details/129914076">AutoCVç¬¬å››è¯¾ï¼šPythonåŸºç¡€</a></li><li><a href="https://blog.csdn.net/qq_40672115/article/details/131480952">å¤æ‚onnxè§£å†³æ–¹æ¡ˆï¼ˆä»¥sparseconvä¸ºä¾‹ï¼‰</a></li><li><a href="https://github.com/tianweiy/CenterPoint">https://github.com/tianweiy/CenterPoint</a></li><li><a href="https://github.com/NVIDIA-AI-IOT/Lidar_AI_Solution/tree/master/libraries/3DSparseConvolution">https://github.com/NVIDIA-AI-IOT/Lidar_AI_Solution/tree/master/libraries/3DSparseConvolution</a></li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/14712fe820042dc7d685be90d431fc4b/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">Cè¯­è¨€â€”â€”å‡½æ•°æ ˆå¸§çš„åˆ›å»ºå’Œé”€æ¯</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/77ea59aad86a9dff847e48978b0552e2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">å¸¸ç”¨çš„æ’åºç®—æ³•</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§ç™½çš„åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>